---
title: Filtros en ASP.NET Core
author: ardalis
description: Obtenga información sobre cómo funcionan los filtros y cómo se pueden usar en ASP.NET Core MVC.
ms.author: riande
ms.custom: mvc
ms.date: 02/08/2019
uid: mvc/controllers/filters
ms.openlocfilehash: a9081a9938d56b7612bba13937eba384ff02455b
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 03/01/2019
ms.locfileid: "57035252"
---
# <a name="filters-in-aspnet-core"></a><span data-ttu-id="d1dd0-103">Filtros en ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="d1dd0-103">Filters in ASP.NET Core</span></span>

<span data-ttu-id="d1dd0-104">Por [Rick Anderson](https://twitter.com/RickAndMSFT), [Tom Dykstra](https://github.com/tdykstra/) y [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="d1dd0-104">By [Rick Anderson](https://twitter.com/RickAndMSFT), [Tom Dykstra](https://github.com/tdykstra/), and [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="d1dd0-105">Los *filtros* en ASP.NET Core MVC permiten ejecutar código antes o después de determinadas fases de la canalización de procesamiento de la solicitud.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-105">*Filters* in ASP.NET Core MVC allow you to run code before or after specific stages in the request processing pipeline.</span></span>

 <span data-ttu-id="d1dd0-106">Los filtros integrados se encargan de tareas como las siguientes:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-106">Built-in filters handle tasks such as:</span></span>

 * <span data-ttu-id="d1dd0-107">Autorización (impedir el acceso a los recursos a un usuario que no está autorizado).</span><span class="sxs-lookup"><span data-stu-id="d1dd0-107">Authorization (preventing access to resources a user isn't authorized for).</span></span>
 * <span data-ttu-id="d1dd0-108">Procurar que se use HTTPS en todas las solicitudes.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-108">Ensuring that all requests use HTTPS.</span></span>
 * <span data-ttu-id="d1dd0-109">Almacenamiento en caché de respuestas (cortocircuitar la canalización de solicitud para devolver una respuesta almacenada en caché).</span><span class="sxs-lookup"><span data-stu-id="d1dd0-109">Response caching (short-circuiting the request pipeline to return a cached response).</span></span> 

<span data-ttu-id="d1dd0-110">Se pueden crear filtros personalizados que se encarguen de cuestiones transversales.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-110">Custom filters can be created to handle cross-cutting concerns.</span></span> <span data-ttu-id="d1dd0-111">Los filtros pueden evitar la duplicación de código en las acciones.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-111">Filters can avoid duplicating code across actions.</span></span> <span data-ttu-id="d1dd0-112">Así, por ejemplo, un filtro de excepción de control de errores puede consolidar el control de errores.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-112">For example, an error handling exception filter could consolidate error handling.</span></span>

<span data-ttu-id="d1dd0-113">[Vea o descargue el ejemplo de GitHub](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/filters/sample).</span><span class="sxs-lookup"><span data-stu-id="d1dd0-113">[View or download sample from GitHub](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/filters/sample).</span></span>

## <a name="how-filters-work"></a><span data-ttu-id="d1dd0-114">Funcionamiento de los filtros</span><span class="sxs-lookup"><span data-stu-id="d1dd0-114">How filters work</span></span>

<span data-ttu-id="d1dd0-115">Los filtros se ejecutan dentro de la *canalización de invocación de acción de MVC*, a veces denominada *canalización de filtro*.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-115">Filters run within the *MVC action invocation pipeline*, sometimes referred to as the *filter pipeline*.</span></span>  <span data-ttu-id="d1dd0-116">La canalización de filtro se ejecuta después de que MVC seleccione la acción que se va a ejecutar.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-116">The filter pipeline runs after MVC selects the action to execute.</span></span>

![La solicitud se procesa a través de las fases Otro middleware, Middleware de enrutamiento, Selección de acción y Canalización de invocación de acción de MVC.](filters/_static/filter-pipeline-1.png)

### <a name="filter-types"></a><span data-ttu-id="d1dd0-119">Tipos de filtro</span><span class="sxs-lookup"><span data-stu-id="d1dd0-119">Filter types</span></span>

<span data-ttu-id="d1dd0-120">Cada tipo de filtro se ejecuta en una fase diferente dentro de la canalización de filtro.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-120">Each filter type is executed at a different stage in the filter pipeline.</span></span>

* <span data-ttu-id="d1dd0-121">Los [filtros de autorización](#authorization-filters) se ejecutan en primer lugar y sirven para averiguar si el usuario actual está autorizado para realizar la solicitud actual.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-121">[Authorization filters](#authorization-filters) run first and are used to determine whether the current user is authorized for the current request.</span></span> <span data-ttu-id="d1dd0-122">Esos filtros pueden cortocircuitar la canalización si una solicitud no está autorizada.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-122">They can short-circuit the pipeline if a request is unauthorized.</span></span> 

* <span data-ttu-id="d1dd0-123">Los [filtros de recursos](#resource-filters) son los primeros en atender la solicitud después de que se haya autorizado.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-123">[Resource filters](#resource-filters) are the first to handle a request after authorization.</span></span>  <span data-ttu-id="d1dd0-124">Pueden ejecutar código antes de pasar al resto de la canalización de filtro y después de que esta se haya completado.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-124">They can run code before the rest of the filter pipeline, and after the rest of the pipeline has completed.</span></span> <span data-ttu-id="d1dd0-125">Son útiles para implementar el almacenamiento en caché o para cortocircuitar la canalización de filtro por motivos de rendimiento.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-125">They're useful to implement caching or otherwise short-circuit the filter pipeline for performance reasons.</span></span> <span data-ttu-id="d1dd0-126">Se ejecutan antes del enlace de modelos, de modo que pueden influir en el enlace de modelos.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-126">They run before model binding, so they can influence model binding.</span></span>

* <span data-ttu-id="d1dd0-127">Los [filtros de acciones](#action-filters) pueden ejecutar código inmediatamente antes y después de llamar a un método de acción individual.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-127">[Action filters](#action-filters) can run code immediately before and after an individual action method is called.</span></span> <span data-ttu-id="d1dd0-128">Se pueden usar para manipular los argumentos pasados a una acción y el resultado obtenido de la acción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-128">They can be used to manipulate the arguments passed into an action and the result returned from the action.</span></span> <span data-ttu-id="d1dd0-129">Los filtros de acción no se admiten en Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-129">Action filters are not supported in Razor Pages.</span></span>

* <span data-ttu-id="d1dd0-130">Los [filtros de excepciones](#exception-filters) sirven para aplicar directivas globales a las excepciones no controladas que se producen antes de que se escriba algo en el cuerpo de respuesta.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-130">[Exception filters](#exception-filters) are used to apply global policies to unhandled exceptions that occur before anything has been written to the response body.</span></span>

* <span data-ttu-id="d1dd0-131">Los [filtros de resultados](#result-filters) pueden ejecutar código inmediatamente antes y después de la ejecución de resultados de acción individuales.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-131">[Result filters](#result-filters) can run code immediately before and after the execution of individual action results.</span></span> <span data-ttu-id="d1dd0-132">Se ejecutan solo cuando el método de acción se ha ejecutado correctamente.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-132">They run only when the action method has executed successfully.</span></span> <span data-ttu-id="d1dd0-133">Son útiles para la lógica que debe regir la ejecución de la vista o el formateador.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-133">They are useful for logic that must surround view or formatter execution.</span></span>

<span data-ttu-id="d1dd0-134">En el siguiente diagrama se muestra cómo interactúan estos tipos de filtro en la canalización de filtro.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-134">The following diagram shows how these filter types interact in the filter pipeline.</span></span>

![La solicitud se procesa a través de las fases Filtros de autorización, Filtros de recursos, Enlace de modelos, Filtros de acciones, Ejecución de acciones/Conversión del resultado de acción, Filtros de excepción, Filtros de resultados y Ejecución del resultado.](filters/_static/filter-pipeline-2.png)

## <a name="implementation"></a><span data-ttu-id="d1dd0-137">Implementación</span><span class="sxs-lookup"><span data-stu-id="d1dd0-137">Implementation</span></span>

<span data-ttu-id="d1dd0-138">Los filtros admiten implementaciones tanto sincrónicas como asincrónicas a través de diferentes definiciones de interfaz.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-138">Filters support both synchronous and asynchronous implementations through different interface definitions.</span></span> 

<span data-ttu-id="d1dd0-139">Los filtros sincrónicos que pueden ejecutar código tanto antes como después de su fase de canalización definen los métodos On*Stage*Executing y On*Stage*Executed.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-139">Synchronous filters that can run code both before and after their pipeline stage define On*Stage*Executing and On*Stage*Executed methods.</span></span> <span data-ttu-id="d1dd0-140">Así, por ejemplo, se llama a `OnActionExecuting` antes de llamar al método de acción y a `OnActionExecuted`, después de que el método de acción haya vuelto.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-140">For example, `OnActionExecuting` is called before the action method is called, and `OnActionExecuted` is called after the action method returns.</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/SampleActionFilter.cs?name=snippet1)]

<span data-ttu-id="d1dd0-141">Los filtros asincrónicos definen un solo método On*Stage*ExecutionAsync.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-141">Asynchronous filters define a single On*Stage*ExecutionAsync method.</span></span> <span data-ttu-id="d1dd0-142">Este método toma un delegado *FilterType*ExecutionDelegate que ejecuta la fase de canalización del filtro.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-142">This method takes a *FilterType*ExecutionDelegate delegate which executes the filter's pipeline stage.</span></span> <span data-ttu-id="d1dd0-143">Por ejemplo, `ActionExecutionDelegate` llama al método de acción o al siguiente filtro de acción y el usuario puede ejecutar código antes y después de esta llamada.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-143">For example, `ActionExecutionDelegate` calls the action method or next action filter, and you can execute code before and after you call it.</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/SampleAsyncActionFilter.cs?highlight=6,8-10,13)]

<span data-ttu-id="d1dd0-144">Se pueden implementar interfaces que abarquen varias fases de filtro en una sola clase.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-144">You can implement interfaces for multiple filter stages in a single class.</span></span> <span data-ttu-id="d1dd0-145">Por ejemplo, la clase <xref:Microsoft.AspNetCore.Mvc.Filters.ActionFilterAttribute> implementa `IActionFilter`, `IResultFilter` y sus equivalentes asincrónicos.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-145">For example, the <xref:Microsoft.AspNetCore.Mvc.Filters.ActionFilterAttribute> class implements `IActionFilter`, `IResultFilter`, and their async equivalents.</span></span>

> [!NOTE]
> <span data-ttu-id="d1dd0-146">Implemente la versión sincrónica **o** la versión asincrónica de una interfaz de filtro, pero no ambas.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-146">Implement **either** the synchronous or the async version of a filter interface, not both.</span></span> <span data-ttu-id="d1dd0-147">El marco comprueba primero si el filtro implementa la interfaz asincrónica y, si es así, es a la interfaz que llama.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-147">The framework checks first to see if the filter implements the async interface, and if so, it calls that.</span></span> <span data-ttu-id="d1dd0-148">De lo contrario, llamará a métodos de interfaz sincrónicos.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-148">If not, it calls the synchronous interface's method(s).</span></span> <span data-ttu-id="d1dd0-149">Si se implementaran ambas interfaces en una clase, solamente se llamaría al método asincrónico.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-149">If you were to implement both interfaces on one class, only the async method would be called.</span></span> <span data-ttu-id="d1dd0-150">Cuando se usan clases abstractas como <xref:Microsoft.AspNetCore.Mvc.Filters.ActionFilterAttribute>, se invalidan solo los métodos sincrónicos o el método asincrónico de cada tipo de filtro.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-150">When using abstract classes like <xref:Microsoft.AspNetCore.Mvc.Filters.ActionFilterAttribute> you would override only the synchronous methods or the async method for each filter type.</span></span>

### <a name="ifilterfactory"></a><span data-ttu-id="d1dd0-151">IFilterFactory</span><span class="sxs-lookup"><span data-stu-id="d1dd0-151">IFilterFactory</span></span>

<span data-ttu-id="d1dd0-152">[IFilterFactory](/dotnet/api/microsoft.aspnetcore.mvc.filters.ifilterfactory) implementa <xref:Microsoft.AspNetCore.Mvc.Filters.IFilterMetadata>.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-152">[IFilterFactory](/dotnet/api/microsoft.aspnetcore.mvc.filters.ifilterfactory) implements <xref:Microsoft.AspNetCore.Mvc.Filters.IFilterMetadata>.</span></span> <span data-ttu-id="d1dd0-153">Por tanto, una instancia de `IFilterFactory` se puede usar como una instancia de `IFilterMetadata` en cualquier parte de la canalización de filtro.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-153">Therefore, an `IFilterFactory` instance can be used as an `IFilterMetadata` instance anywhere in the filter pipeline.</span></span> <span data-ttu-id="d1dd0-154">Cuando el marco se prepara para invocar el filtro, intenta convertirlo a un `IFilterFactory`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-154">When the framework prepares to invoke the filter, it attempts to cast it to an `IFilterFactory`.</span></span> <span data-ttu-id="d1dd0-155">Si esa conversión se realiza correctamente, se llama al método [CreateInstance](/dotnet/api/microsoft.aspnetcore.mvc.filters.ifilterfactory.createinstance) para crear la instancia de `IFilterMetadata` que se va a invocar.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-155">If that cast succeeds, the [CreateInstance](/dotnet/api/microsoft.aspnetcore.mvc.filters.ifilterfactory.createinstance) method is called to create the `IFilterMetadata` instance that will be invoked.</span></span> <span data-ttu-id="d1dd0-156">Esto proporciona un diseño flexible, dado que no hay que establecer la canalización de filtro exacta de forma explícita cuando la aplicación se inicia.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-156">This provides a flexible design, since the precise filter pipeline doesn't need to be set explicitly when the app starts.</span></span>

<span data-ttu-id="d1dd0-157">Puede implementar `IFilterFactory` en sus propias implementaciones de atributo como método alternativo para crear filtros:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-157">You can implement `IFilterFactory` on your own attribute implementations as another approach to creating filters:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/AddHeaderWithFactoryAttribute.cs?name=snippet_IFilterFactory&highlight=1,4,5,6,7)]

### <a name="built-in-filter-attributes"></a><span data-ttu-id="d1dd0-158">Atributos de filtros integrados</span><span class="sxs-lookup"><span data-stu-id="d1dd0-158">Built-in filter attributes</span></span>

<span data-ttu-id="d1dd0-159">El marco incluye filtros integrados basados en atributos que se pueden personalizar y a partir de los cuales crear subclases.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-159">The framework includes built-in attribute-based filters that you can subclass and customize.</span></span> <span data-ttu-id="d1dd0-160">Por ejemplo, el siguiente filtro de resultados agrega un encabezado a la respuesta.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-160">For example, the following Result filter adds a header to the response.</span></span>

<a name="add-header-attribute"></a>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/AddHeaderAttribute.cs?highlight=5,16)]

<span data-ttu-id="d1dd0-161">Los atributos permiten a los filtros aceptar argumentos, como se muestra en el ejemplo anterior.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-161">Attributes allow filters to accept arguments, as shown in the example above.</span></span> <span data-ttu-id="d1dd0-162">Podríamos agregar este atributo a un método de acción o controlador, y especificar el nombre y el valor del encabezado HTTP:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-162">You would add this attribute to a controller or action method and specify the name and value of the HTTP header:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Controllers/SampleController.cs?name=snippet_AddHeader&highlight=1)]

<span data-ttu-id="d1dd0-163">Aquí se muestra el resultado de la acción `Index`; los encabezados de respuesta aparecen en la parte inferior derecha.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-163">The result of the `Index` action is shown below - the response headers are displayed on the bottom right.</span></span>

![Pantalla de las herramientas de desarrollo de Microsoft Edge que muestra encabezados de respuesta con el autor Steve Smith @ardalis](filters/_static/add-header.png)

<span data-ttu-id="d1dd0-165">Algunas de las interfaces de filtro tienen atributos correspondientes que se pueden usar como clases base en las implementaciones personalizadas.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-165">Several of the filter interfaces have corresponding attributes that can be used as base classes for custom implementations.</span></span>

<span data-ttu-id="d1dd0-166">Atributos de filtro:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-166">Filter attributes:</span></span>

* `ActionFilterAttribute`
* `ExceptionFilterAttribute`
* `ResultFilterAttribute`
* `FormatFilterAttribute`
* `ServiceFilterAttribute`
* `TypeFilterAttribute`

<span data-ttu-id="d1dd0-167">`TypeFilterAttribute` y `ServiceFilterAttribute` se explican [más adelante en este artículo](#dependency-injection).</span><span class="sxs-lookup"><span data-stu-id="d1dd0-167">`TypeFilterAttribute` and `ServiceFilterAttribute` are explained [later in this article](#dependency-injection).</span></span>

## <a name="filter-scopes-and-order-of-execution"></a><span data-ttu-id="d1dd0-168">Ámbitos del filtro y orden de ejecución</span><span class="sxs-lookup"><span data-stu-id="d1dd0-168">Filter scopes and order of execution</span></span>

<span data-ttu-id="d1dd0-169">Un filtro se puede agregar a la canalización en uno de tres *ámbitos* posibles.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-169">A filter can be added to the pipeline at one of three *scopes*.</span></span> <span data-ttu-id="d1dd0-170">Un filtro se puede agregar a un método de acción concreto o a una clase de controlador usando un atributo.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-170">You can add a filter to a particular action method or to a controller class by using an attribute.</span></span> <span data-ttu-id="d1dd0-171">Un filtro también se puede registrar globalmente para todos los controladores y acciones.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-171">Or you can register a filter globally for all controllers and actions.</span></span> <span data-ttu-id="d1dd0-172">Para ello, solo hay que agregarlo a la colección `MvcOptions.Filters` en `ConfigureServices`:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-172">Filters are added globally by adding it to the `MvcOptions.Filters` collection in `ConfigureServices`:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Startup.cs?name=snippet_ConfigureServices&highlight=5-8)]

### <a name="default-order-of-execution"></a><span data-ttu-id="d1dd0-173">Orden de ejecución predeterminado</span><span class="sxs-lookup"><span data-stu-id="d1dd0-173">Default order of execution</span></span>

<span data-ttu-id="d1dd0-174">Cuando hay varios filtros en una determinada fase de la canalización, el ámbito determina el orden predeterminado en el que esos filtros se van a ejecutar.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-174">When there are multiple filters for a particular stage of the pipeline, scope determines the default order of filter execution.</span></span>  <span data-ttu-id="d1dd0-175">Los filtros globales abarcan a los filtros de clase, que a su vez engloban a los filtros de método.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-175">Global filters surround class filters, which in turn surround method filters.</span></span> <span data-ttu-id="d1dd0-176">Este proceso se denomina en ocasiones anidamiento tipo "matrioshka", ya que cada aumento en el ámbito está incluido en el ámbito anterior, como las muñecas rusas [matrioshka](https://wikipedia.org/wiki/Matryoshka_doll).</span><span class="sxs-lookup"><span data-stu-id="d1dd0-176">This is sometimes referred to as "Russian doll" nesting, as each increase in scope is wrapped around the previous scope, like a [nesting doll](https://wikipedia.org/wiki/Matryoshka_doll).</span></span> <span data-ttu-id="d1dd0-177">Por lo general, se puede lograr el comportamiento de invalidación deseado sin tener que especificar el orden de forma explícita.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-177">You generally get the desired overriding behavior without having to explicitly determine ordering.</span></span>

<span data-ttu-id="d1dd0-178">Como resultado de este anidamiento, el código de filtros *posterior* se ejecuta en el orden inverso al código *anterior*.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-178">As a result of this nesting, the *after* code of filters runs in the reverse order of the *before* code.</span></span> <span data-ttu-id="d1dd0-179">La secuencia sería la siguiente:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-179">The sequence looks like this:</span></span>

* <span data-ttu-id="d1dd0-180">Código de filtros *anterior* aplicado globalmente</span><span class="sxs-lookup"><span data-stu-id="d1dd0-180">The *before* code of filters applied globally</span></span>
  * <span data-ttu-id="d1dd0-181">Código de filtros *anterior* aplicado a los controladores</span><span class="sxs-lookup"><span data-stu-id="d1dd0-181">The *before* code of filters applied to controllers</span></span>
    * <span data-ttu-id="d1dd0-182">Código de filtros *anterior* aplicado a los métodos de acción</span><span class="sxs-lookup"><span data-stu-id="d1dd0-182">The *before* code of filters applied to action methods</span></span>
    * <span data-ttu-id="d1dd0-183">Código de filtros *posterior* aplicado a los métodos de acción</span><span class="sxs-lookup"><span data-stu-id="d1dd0-183">The *after* code of filters applied to action methods</span></span>
  * <span data-ttu-id="d1dd0-184">Código de filtros *posterior* aplicado a los controladores</span><span class="sxs-lookup"><span data-stu-id="d1dd0-184">The *after* code of filters applied to controllers</span></span>
* <span data-ttu-id="d1dd0-185">Código de filtros *posterior* aplicado globalmente</span><span class="sxs-lookup"><span data-stu-id="d1dd0-185">The *after* code of filters applied globally</span></span>
  
<span data-ttu-id="d1dd0-186">Este es un ejemplo que ilustra el orden en el que se llama a los métodos de filtro relativos a filtros de acciones sincrónicos.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-186">Here's an example that illustrates the order in which filter methods are called for synchronous Action filters.</span></span>

| <span data-ttu-id="d1dd0-187">Secuencia</span><span class="sxs-lookup"><span data-stu-id="d1dd0-187">Sequence</span></span> | <span data-ttu-id="d1dd0-188">Ámbito del filtro</span><span class="sxs-lookup"><span data-stu-id="d1dd0-188">Filter scope</span></span> | <span data-ttu-id="d1dd0-189">Método de filtro</span><span class="sxs-lookup"><span data-stu-id="d1dd0-189">Filter method</span></span> |
|:--------:|:------------:|:-------------:|
| <span data-ttu-id="d1dd0-190">1</span><span class="sxs-lookup"><span data-stu-id="d1dd0-190">1</span></span> | <span data-ttu-id="d1dd0-191">Global</span><span class="sxs-lookup"><span data-stu-id="d1dd0-191">Global</span></span> | `OnActionExecuting` |
| <span data-ttu-id="d1dd0-192">2</span><span class="sxs-lookup"><span data-stu-id="d1dd0-192">2</span></span> | <span data-ttu-id="d1dd0-193">Controlador</span><span class="sxs-lookup"><span data-stu-id="d1dd0-193">Controller</span></span> | `OnActionExecuting` |
| <span data-ttu-id="d1dd0-194">3</span><span class="sxs-lookup"><span data-stu-id="d1dd0-194">3</span></span> | <span data-ttu-id="d1dd0-195">Método</span><span class="sxs-lookup"><span data-stu-id="d1dd0-195">Method</span></span> | `OnActionExecuting` |
| <span data-ttu-id="d1dd0-196">4</span><span class="sxs-lookup"><span data-stu-id="d1dd0-196">4</span></span> | <span data-ttu-id="d1dd0-197">Método</span><span class="sxs-lookup"><span data-stu-id="d1dd0-197">Method</span></span> | `OnActionExecuted` |
| <span data-ttu-id="d1dd0-198">5</span><span class="sxs-lookup"><span data-stu-id="d1dd0-198">5</span></span> | <span data-ttu-id="d1dd0-199">Controlador</span><span class="sxs-lookup"><span data-stu-id="d1dd0-199">Controller</span></span> | `OnActionExecuted` |
| <span data-ttu-id="d1dd0-200">6</span><span class="sxs-lookup"><span data-stu-id="d1dd0-200">6</span></span> | <span data-ttu-id="d1dd0-201">Global</span><span class="sxs-lookup"><span data-stu-id="d1dd0-201">Global</span></span> | `OnActionExecuted` |

<span data-ttu-id="d1dd0-202">Esta secuencia pone de manifiesto lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-202">This sequence shows:</span></span>

* <span data-ttu-id="d1dd0-203">El filtro de método está anidado en el filtro de controlador.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-203">The method filter is nested within the controller filter.</span></span>
* <span data-ttu-id="d1dd0-204">El filtro de controlador está anidado en el filtro global.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-204">The controller filter is nested within the global filter.</span></span> 

<span data-ttu-id="d1dd0-205">Dicho de otro modo, si estamos en el método On*Stage*ExecutionAsync de un filtro asincrónico, todos los filtros que tengan un ámbito más restrictivo se ejecutan mientras el código está en la pila.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-205">To put it another way, if you're inside an async filter's On*Stage*ExecutionAsync method, all of the filters with a tighter scope run while your code is on the stack.</span></span>

> [!NOTE]
> <span data-ttu-id="d1dd0-206">Todos los controladores que heredan de la clase base `Controller` incluyen los métodos `OnActionExecuting` y `OnActionExecuted`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-206">Every controller that inherits from the `Controller` base class includes `OnActionExecuting` and `OnActionExecuted` methods.</span></span> <span data-ttu-id="d1dd0-207">Estos métodos incluyen los filtros que se ejecutan en relación con una acción determinada: se llama a `OnActionExecuting` antes de cualquiera de los filtros y a `OnActionExecuted`, después de todos los filtros.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-207">These methods wrap the filters that run for a given action:  `OnActionExecuting` is called before any of the filters, and `OnActionExecuted` is called after all of the filters.</span></span>

### <a name="overriding-the-default-order"></a><span data-ttu-id="d1dd0-208">Invalidación del orden predeterminado</span><span class="sxs-lookup"><span data-stu-id="d1dd0-208">Overriding the default order</span></span>

<span data-ttu-id="d1dd0-209">La secuencia de ejecución predeterminada se puede invalidar implementando `IOrderedFilter`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-209">You can override the default sequence of execution by implementing `IOrderedFilter`.</span></span> <span data-ttu-id="d1dd0-210">Esta interfaz expone una propiedad `Order` que tiene prioridad sobre el ámbito a la hora de determinar el orden de ejecución.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-210">This interface exposes an `Order` property that takes precedence over scope to determine the order of execution.</span></span> <span data-ttu-id="d1dd0-211">Así, el código *anterior* de un filtro con un valor de `Order` más bajo se ejecutará antes que el de un filtro con un valor de `Order` más alto,</span><span class="sxs-lookup"><span data-stu-id="d1dd0-211">A filter with a lower `Order` value will have its *before* code executed before that of a filter with a higher value of `Order`.</span></span> <span data-ttu-id="d1dd0-212">de igual modo que el código *posterior* de un filtro con un valor de `Order` más bajo se ejecutará después que el de un filtro con un valor de `Order` más alto.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-212">A filter with a lower `Order` value will have its *after* code executed after that of a filter with a higher `Order` value.</span></span> <span data-ttu-id="d1dd0-213">La propiedad `Order` se puede establecer por medio de un parámetro de constructor:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-213">You can set the `Order` property by using a constructor parameter:</span></span>

```csharp
[MyFilter(Name = "Controller Level Attribute", Order=1)]
```

<span data-ttu-id="d1dd0-214">Si tuviéramos estos tres mismos filtros de acciones del ejemplo anterior, pero estableciéramos la propiedad `Order` de los filtros global y del controlador en 1 y 2 respectivamente, el orden de ejecución se invertiría.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-214">If you have the same 3 Action filters shown in the preceding example but set the `Order` property of the controller and global filters to 1 and 2 respectively, the order of execution would be reversed.</span></span>

| <span data-ttu-id="d1dd0-215">Secuencia</span><span class="sxs-lookup"><span data-stu-id="d1dd0-215">Sequence</span></span> | <span data-ttu-id="d1dd0-216">Ámbito del filtro</span><span class="sxs-lookup"><span data-stu-id="d1dd0-216">Filter scope</span></span> | <span data-ttu-id="d1dd0-217">Propiedad `Order`</span><span class="sxs-lookup"><span data-stu-id="d1dd0-217">`Order` property</span></span> | <span data-ttu-id="d1dd0-218">Método de filtro</span><span class="sxs-lookup"><span data-stu-id="d1dd0-218">Filter method</span></span> |
|:--------:|:------------:|:-----------------:|:-------------:|
| <span data-ttu-id="d1dd0-219">1</span><span class="sxs-lookup"><span data-stu-id="d1dd0-219">1</span></span> | <span data-ttu-id="d1dd0-220">Método</span><span class="sxs-lookup"><span data-stu-id="d1dd0-220">Method</span></span> | <span data-ttu-id="d1dd0-221">0</span><span class="sxs-lookup"><span data-stu-id="d1dd0-221">0</span></span> | `OnActionExecuting` |
| <span data-ttu-id="d1dd0-222">2</span><span class="sxs-lookup"><span data-stu-id="d1dd0-222">2</span></span> | <span data-ttu-id="d1dd0-223">Controlador</span><span class="sxs-lookup"><span data-stu-id="d1dd0-223">Controller</span></span> | <span data-ttu-id="d1dd0-224">1</span><span class="sxs-lookup"><span data-stu-id="d1dd0-224">1</span></span>  | `OnActionExecuting` |
| <span data-ttu-id="d1dd0-225">3</span><span class="sxs-lookup"><span data-stu-id="d1dd0-225">3</span></span> | <span data-ttu-id="d1dd0-226">Global</span><span class="sxs-lookup"><span data-stu-id="d1dd0-226">Global</span></span> | <span data-ttu-id="d1dd0-227">2</span><span class="sxs-lookup"><span data-stu-id="d1dd0-227">2</span></span>  | `OnActionExecuting` |
| <span data-ttu-id="d1dd0-228">4</span><span class="sxs-lookup"><span data-stu-id="d1dd0-228">4</span></span> | <span data-ttu-id="d1dd0-229">Global</span><span class="sxs-lookup"><span data-stu-id="d1dd0-229">Global</span></span> | <span data-ttu-id="d1dd0-230">2</span><span class="sxs-lookup"><span data-stu-id="d1dd0-230">2</span></span>  | `OnActionExecuted` |
| <span data-ttu-id="d1dd0-231">5</span><span class="sxs-lookup"><span data-stu-id="d1dd0-231">5</span></span> | <span data-ttu-id="d1dd0-232">Controlador</span><span class="sxs-lookup"><span data-stu-id="d1dd0-232">Controller</span></span> | <span data-ttu-id="d1dd0-233">1</span><span class="sxs-lookup"><span data-stu-id="d1dd0-233">1</span></span>  | `OnActionExecuted` |
| <span data-ttu-id="d1dd0-234">6</span><span class="sxs-lookup"><span data-stu-id="d1dd0-234">6</span></span> | <span data-ttu-id="d1dd0-235">Método</span><span class="sxs-lookup"><span data-stu-id="d1dd0-235">Method</span></span> | <span data-ttu-id="d1dd0-236">0</span><span class="sxs-lookup"><span data-stu-id="d1dd0-236">0</span></span>  | `OnActionExecuted` |

<span data-ttu-id="d1dd0-237">La propiedad `Order` altera el ámbito al determinar el orden en el que se ejecutarán los filtros.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-237">The `Order` property trumps scope when determining the order in which filters will run.</span></span> <span data-ttu-id="d1dd0-238">Los filtros se clasifican por orden en primer lugar y, después, se usa el ámbito para priorizar en caso de igualdad.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-238">Filters are sorted first by order, then scope is used to break ties.</span></span> <span data-ttu-id="d1dd0-239">Todos los filtros integrados implementan `IOrderedFilter` y establecen el valor predeterminado de `Order` en 0.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-239">All of the built-in filters implement `IOrderedFilter` and set the default `Order` value to 0.</span></span> <span data-ttu-id="d1dd0-240">En los filtros integrados, el ámbito determinará el orden, a menos que `Order` se establezca en un valor distinto de cero.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-240">For built-in filters, scope determines order unless you set `Order` to a non-zero value.</span></span>

## <a name="cancellation-and-short-circuiting"></a><span data-ttu-id="d1dd0-241">Cancelación y cortocircuito</span><span class="sxs-lookup"><span data-stu-id="d1dd0-241">Cancellation and short circuiting</span></span>

<span data-ttu-id="d1dd0-242">La canalización de filtro se puede cortocircuitar en cualquier momento estableciendo la propiedad `Result` en el parámetro `context` que se ha proporcionado al método de filtro.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-242">You can short-circuit the filter pipeline at any point by setting the `Result` property on the `context` parameter provided to the filter method.</span></span> <span data-ttu-id="d1dd0-243">Por ejemplo, el siguiente filtro de recursos impide que el resto de la canalización se ejecute.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-243">For instance, the following Resource filter prevents the rest of the pipeline from executing.</span></span>

<a name="short-circuiting-resource-filter"></a>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/ShortCircuitingResourceFilterAttribute.cs?highlight=12,13,14,15)]

<span data-ttu-id="d1dd0-244">En el siguiente código, tanto el filtro `ShortCircuitingResourceFilter` como el filtro `AddHeader` tienen como destino el método de acción `SomeResource`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-244">In the following code, both the `ShortCircuitingResourceFilter` and the `AddHeader` filter target the `SomeResource` action method.</span></span> <span data-ttu-id="d1dd0-245">El `ShortCircuitingResourceFilter`:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-245">The `ShortCircuitingResourceFilter`:</span></span>

* <span data-ttu-id="d1dd0-246">Se ejecuta en primer lugar, porque es un filtro de recursos y `AddHeader` es un filtro de acciones.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-246">Runs first, because it's a Resource Filter and `AddHeader` is an Action Filter.</span></span>
* <span data-ttu-id="d1dd0-247">Cortocircuita el resto de la canalización.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-247">Short-circuits the rest of the pipeline.</span></span>

<span data-ttu-id="d1dd0-248">Por tanto, el filtro `AddHeader` nunca se ejecuta en relación con la acción `SomeResource`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-248">Therefore the `AddHeader` filter never runs for the `SomeResource` action.</span></span> <span data-ttu-id="d1dd0-249">Este comportamiento sería el mismo si ambos filtros se aplicaran en el nivel de método de acción, siempre y cuando `ShortCircuitingResourceFilter` se haya ejecutado primero.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-249">This behavior would be the same if both filters were applied at the action method level, provided the `ShortCircuitingResourceFilter` ran first.</span></span> <span data-ttu-id="d1dd0-250">`ShortCircuitingResourceFilter` se ejecuta primero debido a su tipo de filtro o al uso explícito de la propiedad `Order`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-250">The `ShortCircuitingResourceFilter` runs first because of its filter type, or by explicit use of `Order` property.</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Controllers/SampleController.cs?name=snippet_AddHeader&highlight=1,9)]

## <a name="dependency-injection"></a><span data-ttu-id="d1dd0-251">Inserción de dependencias</span><span class="sxs-lookup"><span data-stu-id="d1dd0-251">Dependency injection</span></span>

<span data-ttu-id="d1dd0-252">Los filtros se pueden agregar por tipo o por instancia.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-252">Filters can be added by type or by instance.</span></span> <span data-ttu-id="d1dd0-253">Si agrega una instancia, dicha instancia se usará en cada solicitud.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-253">If you add an instance, that instance will be used for every request.</span></span> <span data-ttu-id="d1dd0-254">Si se agrega un tipo, se activará por tipo, lo que significa que se creará una instancia por cada solicitud y las dependencias de constructor que haya se rellenarán por medio de la [inserción de dependencias](../../fundamentals/dependency-injection.md).</span><span class="sxs-lookup"><span data-stu-id="d1dd0-254">If you add a type, it will be type-activated, meaning an instance will be created for each request and any constructor dependencies will be populated by [dependency injection](../../fundamentals/dependency-injection.md) (DI).</span></span> <span data-ttu-id="d1dd0-255">Agregar un filtro por tipo equivale a usar `filters.Add(new TypeFilterAttribute(typeof(MyFilter)))`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-255">Adding a filter by type is equivalent to `filters.Add(new TypeFilterAttribute(typeof(MyFilter)))`.</span></span>

<span data-ttu-id="d1dd0-256">Los filtros que se implementan como atributos y se agregan directamente a las clases de controlador o a los métodos de acción no pueden tener dependencias de constructor proporcionadas por la [inserción de dependencias](../../fundamentals/dependency-injection.md).</span><span class="sxs-lookup"><span data-stu-id="d1dd0-256">Filters that are implemented as attributes and added directly to controller classes or action methods cannot have constructor dependencies provided by [dependency injection](../../fundamentals/dependency-injection.md) (DI).</span></span> <span data-ttu-id="d1dd0-257">El motivo es que los atributos deben tener los parámetros de constructor proporcionados allá donde se apliquen.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-257">This is because attributes must have their constructor parameters supplied where they're applied.</span></span> <span data-ttu-id="d1dd0-258">Se trata de una limitación de cómo funcionan los atributos.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-258">This is a limitation of how attributes work.</span></span>

<span data-ttu-id="d1dd0-259">Si los filtros tienen dependencias a las que hay que tener acceso desde la inserción de dependencias, existen varios métodos posibles para ello.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-259">If your filters have dependencies that you need to access from DI, there are several supported approaches.</span></span> <span data-ttu-id="d1dd0-260">Puede aplicar el filtro a una clase o a un método de acción usando cualquiera de los siguientes elementos:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-260">You can apply your filter to a class or action method using one of the following:</span></span>

* `ServiceFilterAttribute`
* `TypeFilterAttribute`
* <span data-ttu-id="d1dd0-261">`IFilterFactory` implementado en el atributo</span><span class="sxs-lookup"><span data-stu-id="d1dd0-261">`IFilterFactory` implemented on your attribute</span></span>

> [!NOTE]
> <span data-ttu-id="d1dd0-262">Una dependencia que probablemente convenga obtener de la inserción de dependencias es un registrador.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-262">One dependency you might want to get from DI is a logger.</span></span> <span data-ttu-id="d1dd0-263">Pese a ello, no cree ni use filtros con fines exclusivamente de registro, ya que seguro que las [características de registro del marco integradas](xref:fundamentals/logging/index) ya proporcionan lo que necesita.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-263">However, avoid creating and using filters purely for logging purposes, since the [built-in framework logging features](xref:fundamentals/logging/index) may already provide what you need.</span></span> <span data-ttu-id="d1dd0-264">Si va a agregar funciones de registro a los filtros, estas deberán ir dirigidas a cuestiones de dominio empresarial o a un comportamiento específico del filtro, y no a acciones de MVC o a otros eventos del marco.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-264">If you're going to add logging to your filters, it should focus on business domain concerns or behavior specific to your filter, rather than MVC actions or other framework events.</span></span>

### <a name="servicefilterattribute"></a><span data-ttu-id="d1dd0-265">ServiceFilterAttribute</span><span class="sxs-lookup"><span data-stu-id="d1dd0-265">ServiceFilterAttribute</span></span>

<span data-ttu-id="d1dd0-266">Los tipos de implementación de filtro de servicio se registran en la inserción de dependencias.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-266">Service filter implementation types are registered in DI.</span></span> <span data-ttu-id="d1dd0-267">`ServiceFilterAttribute` recupera una instancia del filtro de la inserción de dependencias.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-267">A `ServiceFilterAttribute` retrieves an instance of the filter from DI.</span></span> <span data-ttu-id="d1dd0-268">Agregue `ServiceFilterAttribute` al contenedor en `Startup.ConfigureServices` y haga referencia a él en un atributo `[ServiceFilter]`:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-268">Add the `ServiceFilterAttribute` to the container in `Startup.ConfigureServices`, and reference it in a `[ServiceFilter]` attribute:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Startup.cs?name=snippet_ConfigureServices&highlight=11)]

[!code-csharp[](../../mvc/controllers/filters/sample/src/FiltersSample/Controllers/HomeController.cs?name=snippet_ServiceFilter&highlight=1)]

<span data-ttu-id="d1dd0-269">Al usar `ServiceFilterAttribute`, el valor `IsReusable` es una sugerencia de que la instancia de filtro *podría* reutilizarse fuera del ámbito de la solicitud en la que se creó.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-269">When using `ServiceFilterAttribute`, setting `IsReusable` is a hint that the filter instance *may* be reused outside of the request scope it was created within.</span></span> <span data-ttu-id="d1dd0-270">El marco no ofrece ninguna garantía de que se vaya a crear una única instancia del filtro o de que el filtro no vuelva a solicitarse desde el contenedor de DI en algún momento posterior.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-270">The framework provides no guarantees that a single instance of the filter will be created or the filter will not be re-requested from the DI container at some later point.</span></span> <span data-ttu-id="d1dd0-271">Evite el uso de `IsReusable` cuando use un filtro que dependa de servicios con una duración distinta de singleton.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-271">Avoid using `IsReusable` when using a filter that depends on services with a lifetime other than singleton.</span></span>

<span data-ttu-id="d1dd0-272">Si `ServiceFilterAttribute` se usa sin registrar el tipo de filtro, se producirá una excepción:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-272">Using `ServiceFilterAttribute` without registering the filter type results in an exception:</span></span>

```
System.InvalidOperationException: No service for type
'FiltersSample.Filters.AddHeaderFilterWithDI' has been registered.
```

<span data-ttu-id="d1dd0-273">`ServiceFilterAttribute` implementa `IFilterFactory`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-273">`ServiceFilterAttribute` implements `IFilterFactory`.</span></span> <span data-ttu-id="d1dd0-274">`IFilterFactory` expone el método `CreateInstance` para crear una instancia de `IFilterMetadata`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-274">`IFilterFactory` exposes the `CreateInstance` method for creating an `IFilterMetadata` instance.</span></span> <span data-ttu-id="d1dd0-275">El método `CreateInstance` carga el tipo especificado desde el contenedor de servicios (inserción de dependencias).</span><span class="sxs-lookup"><span data-stu-id="d1dd0-275">The `CreateInstance` method loads the specified type from the services container (DI).</span></span>

### <a name="typefilterattribute"></a><span data-ttu-id="d1dd0-276">TypeFilterAttribute</span><span class="sxs-lookup"><span data-stu-id="d1dd0-276">TypeFilterAttribute</span></span>

<span data-ttu-id="d1dd0-277">`TypeFilterAttribute` es similar a `ServiceFilterAttribute`, pero su tipo no se resuelve directamente desde el contenedor de inserción de dependencias,</span><span class="sxs-lookup"><span data-stu-id="d1dd0-277">`TypeFilterAttribute` is similar to `ServiceFilterAttribute`, but its type isn't resolved directly from the DI container.</span></span> <span data-ttu-id="d1dd0-278">sino que crea una instancia del tipo usando el elemento `Microsoft.Extensions.DependencyInjection.ObjectFactory`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-278">It instantiates the type by using `Microsoft.Extensions.DependencyInjection.ObjectFactory`.</span></span>

<span data-ttu-id="d1dd0-279">Debido a esta diferencia:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-279">Because of this difference:</span></span>

* <span data-ttu-id="d1dd0-280">Los tipos a los que se hace referencia con `TypeFilterAttribute` no tienen que estar ya registrados con el contenedor.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-280">Types that are referenced using the `TypeFilterAttribute` don't need to be registered with the container first.</span></span>  <span data-ttu-id="d1dd0-281">Sus dependencias se completan a través del contenedor.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-281">They do have their dependencies fulfilled by the container.</span></span> 
* <span data-ttu-id="d1dd0-282">`TypeFilterAttribute` puede aceptar opcionalmente argumentos de constructor del tipo en cuestión.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-282">`TypeFilterAttribute` can optionally accept constructor arguments for the type.</span></span>

<span data-ttu-id="d1dd0-283">Al usar `TypeFilterAttribute`, el valor `IsReusable` es una sugerencia de que la instancia de filtro *podría* reutilizarse fuera del ámbito de la solicitud en la que se creó.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-283">When using `TypeFilterAttribute`, setting `IsReusable` is a hint that the filter instance *may* be reused outside of the request scope it was created within.</span></span> <span data-ttu-id="d1dd0-284">El marco no ofrece ninguna garantía de que se vaya a crear una única instancia del filtro.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-284">The framework provides no guarantees that a single instance of the filter will be created.</span></span> <span data-ttu-id="d1dd0-285">Evite el uso de `IsReusable` cuando use un filtro que dependa de servicios con una duración distinta de singleton.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-285">Avoid using `IsReusable` when using a filter that depends on services with a lifetime other than singleton.</span></span>

<span data-ttu-id="d1dd0-286">En el siguiente ejemplo se muestra cómo pasar argumentos a un tipo usando `TypeFilterAttribute`:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-286">The following example demonstrates how to pass arguments to a type using `TypeFilterAttribute`:</span></span>

[!code-csharp[](../../mvc/controllers/filters/sample/src/FiltersSample/Controllers/HomeController.cs?name=snippet_TypeFilter&highlight=1,2)]
[!code-csharp[](../../mvc/controllers/filters/sample/src/FiltersSample/Filters/LogConstantFilter.cs?name=snippet_TypeFilter_Implementation&highlight=6)]

### <a name="ifilterfactory-implemented-on-your-attribute"></a><span data-ttu-id="d1dd0-287">IFilterFactory implementado en el atributo</span><span class="sxs-lookup"><span data-stu-id="d1dd0-287">IFilterFactory implemented on your attribute</span></span>

<span data-ttu-id="d1dd0-288">Si tiene un filtro con las siguientes características:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-288">If you have a filter that:</span></span>

* <span data-ttu-id="d1dd0-289">No necesita argumentos.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-289">Doesn't require any arguments.</span></span>
* <span data-ttu-id="d1dd0-290">Tiene dependencias de constructor que deben completarse por medio de la inserción de dependencias.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-290">Has constructor dependencies that need to be filled by DI.</span></span>

<span data-ttu-id="d1dd0-291">Puede usar su propio atributo con nombre en las clases y métodos, en lugar de `[TypeFilter(typeof(FilterType))]`).</span><span class="sxs-lookup"><span data-stu-id="d1dd0-291">You can use your own named attribute on classes and methods instead of `[TypeFilter(typeof(FilterType))]`).</span></span> <span data-ttu-id="d1dd0-292">En el siguiente filtro se muestra cómo se puede implementar esto:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-292">The following filter shows how this can be implemented:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/SampleActionFilterAttribute.cs?name=snippet_TypeFilterAttribute&highlight=1,3,7)]

<span data-ttu-id="d1dd0-293">Este filtro se puede aplicar a clases o a métodos usando la sintaxis de `[SampleActionFilter]`, en lugar de tener que recurrir a `[TypeFilter]` o a `[ServiceFilter]`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-293">This filter can be applied to classes or methods using the `[SampleActionFilter]` syntax, instead of having to use `[TypeFilter]` or `[ServiceFilter]`.</span></span>

## <a name="authorization-filters"></a><span data-ttu-id="d1dd0-294">Filtros de autorización</span><span class="sxs-lookup"><span data-stu-id="d1dd0-294">Authorization filters</span></span>

<span data-ttu-id="d1dd0-295">*Filtros de autorización*:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-295">*Authorization filters*:</span></span>

* <span data-ttu-id="d1dd0-296">Controlan el acceso a los métodos de acción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-296">Control access to action methods.</span></span>
* <span data-ttu-id="d1dd0-297">Son los primeros filtros que se ejecutan en la canalización de filtro.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-297">Are the first filters to be executed within the filter pipeline.</span></span> 
* <span data-ttu-id="d1dd0-298">Tienen un método anterior, pero no uno posterior.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-298">Have a before method, but no after method.</span></span> 

<span data-ttu-id="d1dd0-299">Solo se deben escribir filtros de autorización personalizados si se está escribiendo un marco de autorización propio.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-299">You should only write a custom authorization filter if you are writing your own authorization framework.</span></span> <span data-ttu-id="d1dd0-300">Es preferible configurar directivas de autorización o escribir una directiva de autorización personalizada a escribir un filtro personalizado.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-300">Prefer configuring your authorization policies or writing a custom authorization policy over writing a custom filter.</span></span> <span data-ttu-id="d1dd0-301">La implementación de filtro integrada se encarga únicamente de llamar al sistema de autorización.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-301">The built-in filter implementation is just responsible for calling the authorization system.</span></span>

<span data-ttu-id="d1dd0-302">No se deberían producir excepciones dentro de los filtros de autorización, ya que no habrá nada que controle esas excepciones (los filtros de excepciones no lo harán).</span><span class="sxs-lookup"><span data-stu-id="d1dd0-302">You shouldn't throw exceptions within authorization filters, since nothing will handle the exception (exception filters won't handle them).</span></span> <span data-ttu-id="d1dd0-303">Considere la posibilidad de emitir un desafío cuando se produzca una excepción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-303">Consider issuing a challenge when an exception occurs.</span></span>

<span data-ttu-id="d1dd0-304">[Aquí](xref:security/authorization/introduction) encontrará más información sobre la autorización.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-304">Learn more about [Authorization](xref:security/authorization/introduction).</span></span>

## <a name="resource-filters"></a><span data-ttu-id="d1dd0-305">Filtros de recursos</span><span class="sxs-lookup"><span data-stu-id="d1dd0-305">Resource filters</span></span>

* <span data-ttu-id="d1dd0-306">Implementan la interfaz `IResourceFilter` o `IAsyncResourceFilter`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-306">Implement either the `IResourceFilter` or `IAsyncResourceFilter` interface,</span></span>
* <span data-ttu-id="d1dd0-307">Su ejecución abarca la mayor parte de la canalización de filtro.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-307">Their execution wraps most of the filter pipeline.</span></span> 
* <span data-ttu-id="d1dd0-308">Los [filtros de autorización](#authorization-filters) son los únicos que se ejecutan antes que los filtros de recursos.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-308">Only [Authorization filters](#authorization-filters) run before Resource filters.</span></span>

<span data-ttu-id="d1dd0-309">Los filtros de recursos son útiles para cortocircuitar la mayor parte del trabajo que está realizando una solicitud.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-309">Resource filters are useful to short-circuit most of the work a request is doing.</span></span> <span data-ttu-id="d1dd0-310">Por ejemplo, un filtro de almacenamiento en caché puede evitar que se ejecute el resto de la canalización si la respuesta está en la memoria caché.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-310">For example, a caching filter can avoid the rest of the pipeline if the response is in the cache.</span></span>

<span data-ttu-id="d1dd0-311">El [filtro de recursos de cortocircuito](#short-circuiting-resource-filter) mostrado anteriormente es un ejemplo de filtro de recursos.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-311">The [short circuiting resource filter](#short-circuiting-resource-filter) shown earlier is one example of a resource filter.</span></span> <span data-ttu-id="d1dd0-312">Otro ejemplo es [DisableFormValueModelBindingAttribute](https://github.com/aspnet/Entropy/blob/rel/1.1.1/samples/Mvc.FileUpload/Filters/DisableFormValueModelBindingAttribute.cs):</span><span class="sxs-lookup"><span data-stu-id="d1dd0-312">Another example is [DisableFormValueModelBindingAttribute](https://github.com/aspnet/Entropy/blob/rel/1.1.1/samples/Mvc.FileUpload/Filters/DisableFormValueModelBindingAttribute.cs):</span></span>

* <span data-ttu-id="d1dd0-313">Evita que el enlace de modelos tenga acceso a los datos del formulario.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-313">It prevents model binding from accessing the form data.</span></span> 
* <span data-ttu-id="d1dd0-314">Resulta práctico cuando hay cargas de archivos muy voluminosos y se quiere impedir que el formulario se lea en la memoria.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-314">It's useful for large file uploads and want to prevent the form from being read into memory.</span></span>

## <a name="action-filters"></a><span data-ttu-id="d1dd0-315">Filtros de acciones</span><span class="sxs-lookup"><span data-stu-id="d1dd0-315">Action filters</span></span>

> [!IMPORTANT]
> <span data-ttu-id="d1dd0-316">Los filtros de acción **no** se aplican a Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-316">Action filters do **not** apply to Razor Pages.</span></span> <span data-ttu-id="d1dd0-317">Razor Pages admite <xref:Microsoft.AspNetCore.Mvc.Filters.IPageFilter> y <xref:Microsoft.AspNetCore.Mvc.Filters.IAsyncPageFilter>.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-317">Razor Pages supports <xref:Microsoft.AspNetCore.Mvc.Filters.IPageFilter> and <xref:Microsoft.AspNetCore.Mvc.Filters.IAsyncPageFilter> .</span></span> <span data-ttu-id="d1dd0-318">Para más información, vea [Filter methods for Razor Pages](xref:razor-pages/filter) (Métodos de filtrado para páginas de Razor).</span><span class="sxs-lookup"><span data-stu-id="d1dd0-318">For more information, see [Filter methods for Razor Pages](xref:razor-pages/filter).</span></span>

<span data-ttu-id="d1dd0-319">Los *filtros de acciones*:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-319">*Action filters*:</span></span>

* <span data-ttu-id="d1dd0-320">Implementan la interfaz `IActionFilter` o `IAsyncActionFilter`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-320">Implement either the `IActionFilter` or `IAsyncActionFilter` interface.</span></span>
* <span data-ttu-id="d1dd0-321">Su ejecución rodea la ejecución de los métodos de acción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-321">Their execution surrounds the execution of action methods.</span></span>

<span data-ttu-id="d1dd0-322">Este es un filtro de acciones de ejemplo:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-322">Here's a sample action filter:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/SampleActionFilter.cs?name=snippet_ActionFilter)]

<span data-ttu-id="d1dd0-323"><xref:Microsoft.AspNetCore.Mvc.Filters.ActionExecutingContext> ofrece las siguientes propiedades:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-323">The <xref:Microsoft.AspNetCore.Mvc.Filters.ActionExecutingContext> provides the following properties:</span></span>

* <span data-ttu-id="d1dd0-324">`ActionArguments`: permite manipular las entradas en la acción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-324">`ActionArguments` - lets you manipulate the inputs to the action.</span></span>
* <span data-ttu-id="d1dd0-325">`Controller`: permite manipular la instancia del controlador.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-325">`Controller` - lets you manipulate the controller instance.</span></span> 
* <span data-ttu-id="d1dd0-326">`Result`: si se establece, cortocircuita la ejecución del método de acción y de los filtros de acciones posteriores.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-326">`Result` - setting this short-circuits execution of the action method and subsequent action filters.</span></span> <span data-ttu-id="d1dd0-327">Producir una excepción también impide que el método de acción y los filtros posteriores se ejecuten, pero se considera un error en vez de un resultado correcto.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-327">Throwing an exception also prevents execution of the action method and subsequent filters, but is treated as a failure instead of a successful result.</span></span>

<span data-ttu-id="d1dd0-328"><xref:Microsoft.AspNetCore.Mvc.Filters.ActionExecutedContext> proporciona `Controller` y `Result`, además de las siguientes propiedades:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-328">The <xref:Microsoft.AspNetCore.Mvc.Filters.ActionExecutedContext> provides `Controller` and `Result` plus the following properties:</span></span>

* <span data-ttu-id="d1dd0-329">`Canceled`: será true si otro filtro ha cortocircuitado la ejecución de la acción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-329">`Canceled` - will be true if the action execution was short-circuited by another filter.</span></span>
* <span data-ttu-id="d1dd0-330">`Exception`: será distinto de null si la acción o un filtro de acción posterior han producido una excepción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-330">`Exception` - will be non-null if the action or a subsequent action filter threw an exception.</span></span> <span data-ttu-id="d1dd0-331">Si esta propiedad se establece en null, se "controlará" una excepción de forma eficaz y `Result` se ejecutará como si se hubiera devuelto desde el método de acción con normalidad.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-331">Setting this property to null effectively 'handles' an exception, and `Result` will be executed as if it were returned from the action method normally.</span></span>

<span data-ttu-id="d1dd0-332">En un `IAsyncActionFilter`, una llamada a `ActionExecutionDelegate`:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-332">For an `IAsyncActionFilter`, a call to the `ActionExecutionDelegate`:</span></span>

* <span data-ttu-id="d1dd0-333">Ejecuta cualquier filtro de acciones posterior y el método de acción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-333">Executes any subsequent action filters and the action method.</span></span>
* <span data-ttu-id="d1dd0-334">Devuelve `ActionExecutedContext`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-334">returns `ActionExecutedContext`.</span></span> 

<span data-ttu-id="d1dd0-335">Para cortocircuitar esto, asigne `ActionExecutingContext.Result` a alguna instancia de resultado y no llame a `ActionExecutionDelegate`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-335">To short-circuit, assign `ActionExecutingContext.Result` to some result instance and don't call the `ActionExecutionDelegate`.</span></span>

<span data-ttu-id="d1dd0-336">El marco proporciona una clase abstracta `ActionFilterAttribute` de la que se pueden crear subclases.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-336">The framework provides an abstract `ActionFilterAttribute` that you can subclass.</span></span> 

<span data-ttu-id="d1dd0-337">Un filtro de acciones puede servir para validar el estado del modelo y devolver cualquier error que surja si el estado no es válido:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-337">You can use an action filter to validate model state and return any errors if the state is invalid:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/ValidateModelAttribute.cs)]

<span data-ttu-id="d1dd0-338">El método `OnActionExecuted` se ejecuta después del método de acción y puede ver y manipular los resultados de la acción a través de la propiedad `ActionExecutedContext.Result`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-338">The `OnActionExecuted` method runs after the action method and can see and manipulate the results of the action through the `ActionExecutedContext.Result` property.</span></span> <span data-ttu-id="d1dd0-339">`ActionExecutedContext.Canceled` se establecerá en true si otro filtro ha cortocircuitado la ejecución de la acción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-339">`ActionExecutedContext.Canceled` will be set to true if the action execution was short-circuited by another filter.</span></span> <span data-ttu-id="d1dd0-340">`ActionExecutedContext.Exception` se establecerá en un valor distinto de null si la acción o un filtro de acción posterior han producido una excepción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-340">`ActionExecutedContext.Exception` will be set to a non-null value if the action or a subsequent action filter threw an exception.</span></span> <span data-ttu-id="d1dd0-341">Si `ActionExecutedContext.Exception` se establece como nulo:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-341">Setting `ActionExecutedContext.Exception` to null:</span></span>

* <span data-ttu-id="d1dd0-342">Controla una excepción eficazmente.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-342">Effectively 'handles' an exception.</span></span>
* <span data-ttu-id="d1dd0-343">`ActionExecutedContext.Result` se ejecuta como si se devolviera con normalidad desde el método de acción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-343">`ActionExecutedContext.Result` is executed as if it were returned normally from the action method.</span></span>

## <a name="exception-filters"></a><span data-ttu-id="d1dd0-344">Filtros de excepciones</span><span class="sxs-lookup"><span data-stu-id="d1dd0-344">Exception filters</span></span>

<span data-ttu-id="d1dd0-345">Los *filtros de excepciones* implementan la interfaz `IExceptionFilter` o `IAsyncExceptionFilter`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-345">*Exception filters* implement either the `IExceptionFilter` or `IAsyncExceptionFilter` interface.</span></span> <span data-ttu-id="d1dd0-346">Se pueden usar para implementar directivas de control de errores comunes de una aplicación.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-346">They can be used to implement common error handling policies for an app.</span></span> 

<span data-ttu-id="d1dd0-347">En el siguiente filtro de excepciones de ejemplo se usa una vista de error de desarrollador personalizada para mostrar los detalles sobre las excepciones que se producen cuando la aplicación está en fase de desarrollo:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-347">The following sample exception filter uses a custom developer error view to display details about exceptions that occur when the app is in development:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/CustomExceptionFilterAttribute.cs?name=snippet_ExceptionFilter&highlight=1,14)]

<span data-ttu-id="d1dd0-348">Los filtros de excepciones:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-348">Exception filters:</span></span>

* <span data-ttu-id="d1dd0-349">No tienen eventos anteriores ni posteriores.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-349">Don't have before and after events.</span></span> 
* <span data-ttu-id="d1dd0-350">Implementan `OnException` o `OnExceptionAsync`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-350">Implement `OnException` or `OnExceptionAsync`.</span></span> 
* <span data-ttu-id="d1dd0-351">Controlan las excepciones sin controlar que se producen al crear controladores, en el [enlace de modelos](../models/model-binding.md), en los filtros de acciones o en los métodos de acción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-351">Handle unhandled exceptions that occur in controller creation, [model binding](../models/model-binding.md), action filters, or action methods.</span></span> 
* <span data-ttu-id="d1dd0-352">No detectan aquellas excepciones que se produzcan en los filtros de recursos, en los filtros de resultados o en la ejecución de resultados de MVC.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-352">Do not catch exceptions that occur in Resource filters, Result filters, or MVC Result execution.</span></span>

<span data-ttu-id="d1dd0-353">Para controlar una excepción, establezca la propiedad `ExceptionContext.ExceptionHandled` en true o escriba una respuesta.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-353">To handle an exception, set the `ExceptionContext.ExceptionHandled` property to true or write a response.</span></span> <span data-ttu-id="d1dd0-354">Esto detiene la propagación de la excepción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-354">This stops propagation of the exception.</span></span> <span data-ttu-id="d1dd0-355">Un filtro de excepciones no tiene capacidad para convertir una excepción en un proceso "correcto".</span><span class="sxs-lookup"><span data-stu-id="d1dd0-355">An Exception filter can't turn an exception into a "success".</span></span> <span data-ttu-id="d1dd0-356">Eso solo lo pueden hacer los filtros de acciones.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-356">Only an Action filter can do that.</span></span>

> [!NOTE]
> <span data-ttu-id="d1dd0-357">En ASP.NET Core 1.1, la respuesta no se envía si `ExceptionHandled` está establecido en true **y** escribe una respuesta.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-357">In ASP.NET Core 1.1, the response isn't sent if you set `ExceptionHandled` to true **and** write a response.</span></span> <span data-ttu-id="d1dd0-358">En este caso, ASP.NET Core 1.0 envía la respuesta, mientras que ASP.NET Core 1.1.2 regresará al comportamiento de la versión 1.0.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-358">In that scenario, ASP.NET Core 1.0 does send the response, and ASP.NET Core 1.1.2 will return to the 1.0 behavior.</span></span> <span data-ttu-id="d1dd0-359">Para más información, vea el [problema n.º 5594](https://github.com/aspnet/Mvc/issues/5594) del repositorio de GitHub.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-359">For more information, see [issue #5594](https://github.com/aspnet/Mvc/issues/5594) in the GitHub repository.</span></span> 

<span data-ttu-id="d1dd0-360">Los filtros de excepciones:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-360">Exception filters:</span></span>

* <span data-ttu-id="d1dd0-361">Son adecuados para interceptar las excepciones que se producen en las acciones de MVC.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-361">Are good for trapping exceptions that occur within MVC actions.</span></span>
* <span data-ttu-id="d1dd0-362">No son tan flexibles como el middleware de control de errores.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-362">Are not as flexible as error handling middleware.</span></span> 

<span data-ttu-id="d1dd0-363">Es preferible usar middleware de control de excepciones.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-363">Prefer middleware for exception handling.</span></span> <span data-ttu-id="d1dd0-364">Use filtros de excepción solo cuando deba realizar el control de errores *de manera diferente* según la acción de MVC elegida.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-364">Use exception filters only where you need to do error handling *differently* based on which MVC action was chosen.</span></span> <span data-ttu-id="d1dd0-365">Por ejemplo, puede que su aplicación tenga métodos de acción tanto para los puntos de conexión de API como para las vistas/HTML.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-365">For example, your app might have action methods for both API endpoints and for views/HTML.</span></span> <span data-ttu-id="d1dd0-366">Los puntos de conexión de API podrían devolver información sobre errores como JSON, mientras que las acciones basadas en vistas podrían devolver una página de error como HTML.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-366">The API endpoints could return error information as JSON, while the view-based actions could return an error page as HTML.</span></span>

<span data-ttu-id="d1dd0-367">`ExceptionFilterAttribute` puede tener subclases.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-367">The `ExceptionFilterAttribute` can be subclassed.</span></span> 

## <a name="result-filters"></a><span data-ttu-id="d1dd0-368">Filtros de resultados</span><span class="sxs-lookup"><span data-stu-id="d1dd0-368">Result filters</span></span>

* <span data-ttu-id="d1dd0-369">Implementar una interfaz:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-369">Implement an interface:</span></span>
  * <span data-ttu-id="d1dd0-370">`IResultFilter` o `IAsyncResultFilter`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-370">`IResultFilter` or `IAsyncResultFilter`.</span></span>
  * <span data-ttu-id="d1dd0-371">`IAlwaysRunResultFilter` o `IAsyncAlwaysRunResultFilter`</span><span class="sxs-lookup"><span data-stu-id="d1dd0-371">`IAlwaysRunResultFilter` or `IAsyncAlwaysRunResultFilter`</span></span>
* <span data-ttu-id="d1dd0-372">Su ejecución rodea la ejecución de los resultados de acción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-372">Their execution surrounds the execution of action results.</span></span> 

### <a name="iresultfilter-and-iasyncresultfilter"></a><span data-ttu-id="d1dd0-373">IResultFilter e IAsyncResultFilter</span><span class="sxs-lookup"><span data-stu-id="d1dd0-373">IResultFilter and IAsyncResultFilter</span></span>

<span data-ttu-id="d1dd0-374">Este es un ejemplo de un filtro de resultados que agrega un encabezado HTTP.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-374">Here's an example of a Result filter that adds an HTTP header.</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/LoggingAddHeaderFilter.cs?name=snippet_ResultFilter)]

<span data-ttu-id="d1dd0-375">El tipo de resultado que se ejecute dependerá de la acción en cuestión.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-375">The kind of result being executed depends on the action in question.</span></span> <span data-ttu-id="d1dd0-376">Una acción de MVC que devuelve una vista incluye todo el procesamiento de Razor como parte del elemento `ViewResult` que se está ejecutando.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-376">An MVC action returning a view would include all razor processing as part of the `ViewResult` being executed.</span></span> <span data-ttu-id="d1dd0-377">Un método API puede llevar a cabo algunas funciones de serialización como parte de la ejecución del resultado.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-377">An API method might perform some serialization as part of the execution of the result.</span></span> <span data-ttu-id="d1dd0-378">[Aquí](actions.md) encontrará más información sobre los resultados de acciones.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-378">Learn more about [action results](actions.md)</span></span>

<span data-ttu-id="d1dd0-379">Los filtros de resultados solo se ejecutan cuando los resultados son correctos; es decir, cuando la acción o los filtros de acciones generan un resultado de acción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-379">Result filters are only executed for successful results - when the action or action filters produce an action result.</span></span> <span data-ttu-id="d1dd0-380">Los filtros de resultados no se ejecutan si hay filtros de excepciones que controlan una excepción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-380">Result filters are not executed when exception filters handle an exception.</span></span>

<span data-ttu-id="d1dd0-381">El método `OnResultExecuting` puede cortocircuitar la ejecución del resultado de la acción y de los filtros de resultados posteriores estableciendo `ResultExecutingContext.Cancel` en true.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-381">The `OnResultExecuting` method can short-circuit execution of the action result and subsequent result filters by setting `ResultExecutingContext.Cancel` to true.</span></span> <span data-ttu-id="d1dd0-382">Por lo general, conviene escribir en el objeto de respuesta cuando el proceso se cortocircuite, ya que así evitará que se genere una respuesta vacía.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-382">You should generally write to the response object when short-circuiting to avoid generating an empty response.</span></span> <span data-ttu-id="d1dd0-383">Si se produce una excepción, sucederá lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-383">Throwing an exception will:</span></span>

* <span data-ttu-id="d1dd0-384">Se impedirá la ejecución del resultado de la acción y de los filtros subsiguientes.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-384">Prevent execution of the action result and subsequent filters.</span></span>
* <span data-ttu-id="d1dd0-385">Se tratará como un error en lugar de como un resultado correcto.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-385">Be treated as a failure instead of a successful result.</span></span>

<span data-ttu-id="d1dd0-386">Cuando el método `OnResultExecuted` se ejecuta, probablemente la respuesta se haya enviado al cliente y ya no se pueda cambiar (a menos que se produzca una excepción).</span><span class="sxs-lookup"><span data-stu-id="d1dd0-386">When the `OnResultExecuted` method runs, the response has likely been sent to the client and cannot be changed further (unless an exception was thrown).</span></span> <span data-ttu-id="d1dd0-387">`ResultExecutedContext.Canceled` se establecerá en true si otro filtro ha cortocircuitado la ejecución del resultado de la acción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-387">`ResultExecutedContext.Canceled` will be set to true if the action result execution was short-circuited by another filter.</span></span>

<span data-ttu-id="d1dd0-388">`ResultExecutedContext.Exception` se establecerá en un valor distinto de null si el resultado de la acción o un filtro de resultado posterior ha producido una excepción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-388">`ResultExecutedContext.Exception` will be set to a non-null value if the action result or a subsequent result filter threw an exception.</span></span> <span data-ttu-id="d1dd0-389">Establecer `Exception` en un valor null hace que una excepción se "controle" de forma eficaz y evita que MVC vuelva a producir dicha excepción más adelante en la canalización.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-389">Setting `Exception` to null effectively 'handles' an exception and prevents the exception from being rethrown by MVC later in the pipeline.</span></span> <span data-ttu-id="d1dd0-390">Cuando se controla una excepción en un filtro de resultados, no se pueden escribir datos en la respuesta.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-390">When you're handling an exception in a result filter, you might not be able to write any data to the response.</span></span> <span data-ttu-id="d1dd0-391">Si el resultado de la acción produce una excepción a mitad de su ejecución y los encabezados ya se han vaciado en el cliente, no hay ningún mecanismo confiable que permita enviar un código de error.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-391">If the action result throws partway through its execution, and the headers have already been flushed to the client, there's no reliable mechanism to send a failure code.</span></span>

<span data-ttu-id="d1dd0-392">En un elemento `IAsyncResultFilter`, una llamada a `await next` en `ResultExecutionDelegate` ejecuta cualquier filtro de resultados posterior y el resultado de la acción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-392">For an `IAsyncResultFilter` a call to `await next` on the `ResultExecutionDelegate` executes any subsequent result filters and the action result.</span></span> <span data-ttu-id="d1dd0-393">Para cortocircuitar esto, establezca `ResultExecutingContext.Cancel` en true y no llame a `ResultExectionDelegate`.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-393">To short-circuit, set `ResultExecutingContext.Cancel` to true and don't call the `ResultExectionDelegate`.</span></span>

<span data-ttu-id="d1dd0-394">El marco proporciona una clase abstracta `ResultFilterAttribute` de la que se pueden crear subclases.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-394">The framework provides an abstract `ResultFilterAttribute` that you can subclass.</span></span> <span data-ttu-id="d1dd0-395">La clase [AddHeaderAttribute](#add-header-attribute) mostrada anteriormente es un ejemplo de un atributo de filtro de resultados.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-395">The [AddHeaderAttribute](#add-header-attribute) class shown earlier is an example of a result filter attribute.</span></span>

### <a name="ialwaysrunresultfilter-and-iasyncalwaysrunresultfilter"></a><span data-ttu-id="d1dd0-396">IAlwaysRunResultFilter e IAsyncAlwaysRunResultFilter</span><span class="sxs-lookup"><span data-stu-id="d1dd0-396">IAlwaysRunResultFilter and IAsyncAlwaysRunResultFilter</span></span>

<span data-ttu-id="d1dd0-397">Las interfaces <xref:Microsoft.AspNetCore.Mvc.Filters.IAlwaysRunResultFilter> e <xref:Microsoft.AspNetCore.Mvc.Filters.IAsyncAlwaysRunResultFilter> declaran una implementación <xref:Microsoft.AspNetCore.Mvc.Filters.IResultFilter> que se ejecuta para obtener resultados de la acción.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-397">The <xref:Microsoft.AspNetCore.Mvc.Filters.IAlwaysRunResultFilter> and <xref:Microsoft.AspNetCore.Mvc.Filters.IAsyncAlwaysRunResultFilter> interfaces declare an <xref:Microsoft.AspNetCore.Mvc.Filters.IResultFilter> implementation that runs for action results.</span></span> <span data-ttu-id="d1dd0-398">El filtro se aplicará a un resultado de la acción a menos que un filtro <xref:Microsoft.AspNetCore.Mvc.Filters.IExceptionFilter> o <xref:Microsoft.AspNetCore.Mvc.Filters.IAuthorizationFilter> aplique y cortocircuite la respuesta.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-398">The filter is applied to an action result unless an <xref:Microsoft.AspNetCore.Mvc.Filters.IExceptionFilter> or <xref:Microsoft.AspNetCore.Mvc.Filters.IAuthorizationFilter> applies and short-circuits the response.</span></span>

<span data-ttu-id="d1dd0-399">En otras palabras, estos filtros de "ejecución permanente" se ejecutan siempre, excepto si un filtro de autorización o excepción los cortocircuita.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-399">In other words, these "always run" filters, always run, except when an exception or authorization filter short-circuits them.</span></span> <span data-ttu-id="d1dd0-400">Los filtros distintos de `IExceptionFilter` e `IAuthorizationFilter` no los cortocircuitan.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-400">Filters other than `IExceptionFilter` and `IAuthorizationFilter` don't short circuit them.</span></span>

<span data-ttu-id="d1dd0-401">Por ejemplo, el siguiente filtro siempre ejecuta y establece un resultado de la acción (<xref:Microsoft.AspNetCore.Mvc.ObjectResult>) con un código de estado *422 - Entidad no procesable* cuando se produce un error en la negociación de contenido:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-401">For example, the following filter always runs and sets an action result (<xref:Microsoft.AspNetCore.Mvc.ObjectResult>) with a *422 Unprocessable Entity* status code when content negotiation fails:</span></span>

```csharp
public class UnprocessableResultFilter : Attribute, IAlwaysRunResultFilter
{
    public void OnResultExecuting(ResultExecutingContext context)
    {
        if (context.Result is StatusCodeResult statusCodeResult &&
            statusCodeResult.StatusCode == 415)
        {
            context.Result = new ObjectResult("Can't process this!")
            {
                StatusCode = 422,
            };
        }
    }

    public void OnResultExecuted(ResultExecutedContext context)
    {
    }
}
```

## <a name="using-middleware-in-the-filter-pipeline"></a><span data-ttu-id="d1dd0-402">Uso de middleware en la canalización de filtro</span><span class="sxs-lookup"><span data-stu-id="d1dd0-402">Using middleware in the filter pipeline</span></span>

<span data-ttu-id="d1dd0-403">Los filtros de recursos funcionan como el [middleware](xref:fundamentals/middleware/index), en el sentido de que se encargan de la ejecución de todo lo que viene después en la canalización.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-403">Resource filters work like [middleware](xref:fundamentals/middleware/index) in that they surround the execution of everything that comes later in the pipeline.</span></span> <span data-ttu-id="d1dd0-404">Pero los filtros se diferencian del middleware en que forman parte de MVC, lo que significa que tienen acceso al contexto y las construcciones de MVC.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-404">But filters differ from middleware in that they're part of MVC, which means that they have access to MVC context and constructs.</span></span>

<span data-ttu-id="d1dd0-405">En ASP.NET Core 1.1 se puede usar middleware en la canalización de filtro.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-405">In ASP.NET Core 1.1, you can use middleware in the filter pipeline.</span></span> <span data-ttu-id="d1dd0-406">Conviene hacerlo si tiene un componente de middleware que necesita tener acceso a los datos de ruta de MVC, u otro que deba ejecutarse solo con ciertos controladores o acciones.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-406">You might want to do that if you have a middleware component that needs access to MVC route data, or one that should run only for certain controllers or actions.</span></span>

<span data-ttu-id="d1dd0-407">Para usar middleware como un filtro, cree un tipo con un método `Configure` en el que se especifique el middleware que quiera insertar en la canalización de filtro.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-407">To use middleware as a filter, create a type with a `Configure` method that specifies the middleware that you want to inject into the filter pipeline.</span></span> <span data-ttu-id="d1dd0-408">Este es un ejemplo en el que se usa middleware de localización para establecer la referencia cultural actual de una solicitud:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-408">Here's an example that uses the localization middleware to establish the current culture for a request:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/LocalizationPipeline.cs?name=snippet_MiddlewareFilter&highlight=3,21)]

<span data-ttu-id="d1dd0-409">Después, puede usar `MiddlewareFilterAttribute` para ejecutar el middleware en relación con una acción o controlador concretos, o bien de manera global:</span><span class="sxs-lookup"><span data-stu-id="d1dd0-409">You can then use the `MiddlewareFilterAttribute` to run the middleware for a selected controller or action or globally:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Controllers/HomeController.cs?name=snippet_MiddlewareFilter&highlight=2)]

<span data-ttu-id="d1dd0-410">Los filtros de middleware se ejecutan en la misma fase de la canalización de filtro que los filtros de recursos, antes del enlace de modelos y después del resto de la canalización.</span><span class="sxs-lookup"><span data-stu-id="d1dd0-410">Middleware filters run at the same stage of the filter pipeline as Resource filters, before model binding and after the rest of the pipeline.</span></span>

## <a name="next-actions"></a><span data-ttu-id="d1dd0-411">Siguientes acciones</span><span class="sxs-lookup"><span data-stu-id="d1dd0-411">Next actions</span></span>

* <span data-ttu-id="d1dd0-412">Consulte [Métodos de filtrado para páginas de Razor](xref:razor-pages/filter).</span><span class="sxs-lookup"><span data-stu-id="d1dd0-412">See [Filter methods for Razor Pages](xref:razor-pages/filter)</span></span>
* <span data-ttu-id="d1dd0-413">Para experimentar con los filtros, [descargue, pruebe y modifique el ejemplo de GitHub](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/filters/sample).</span><span class="sxs-lookup"><span data-stu-id="d1dd0-413">To experiment with filters, [download, test and modify the Github sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/filters/sample).</span></span>
