---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
title: Control de la simultaneidad con el Entity Framework 4,0 en una aplicación Web de ASP.NET 4 | Microsoft Docs
author: tdykstra
description: Esta serie de tutoriales se basa en la aplicación web contoso University que crea el Introducción con la serie de tutoriales Entity Framework 4,0. I...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: a5aa22a6-fb7f-4f41-9c7f-addda151940b
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
msc.type: authoredcontent
ms.openlocfilehash: 3df5f7d9c8fb22e1ea34fe16560bdb9a1309bb56
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 03/06/2020
ms.locfileid: "78513505"
---
# <a name="handling-concurrency-with-the-entity-framework-40-in-an-aspnet-4-web-application"></a><span data-ttu-id="e9483-104">Control de la simultaneidad con el Entity Framework 4,0 en una aplicación Web de ASP.NET 4</span><span class="sxs-lookup"><span data-stu-id="e9483-104">Handling Concurrency with the Entity Framework 4.0 in an ASP.NET 4 Web Application</span></span>

<span data-ttu-id="e9483-105">por [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="e9483-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="e9483-106">Esta serie de tutoriales se basa en la aplicación web contoso University que crea el [Introducción con la](https://asp.net/entity-framework/tutorials#Getting%20Started) serie de tutoriales Entity Framework 4,0.</span><span class="sxs-lookup"><span data-stu-id="e9483-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="e9483-107">Si no completó los tutoriales anteriores, como punto de partida para este tutorial, puede [descargar la aplicación](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) que habría creado.</span><span class="sxs-lookup"><span data-stu-id="e9483-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="e9483-108">También puede [descargar la aplicación](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) que se crea en la serie completa de tutoriales.</span><span class="sxs-lookup"><span data-stu-id="e9483-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="e9483-109">Si tiene alguna pregunta sobre los tutoriales, puede publicarlos en el [Foro de Entity Framework de ASP.net](https://forums.asp.net/1227.aspx).</span><span class="sxs-lookup"><span data-stu-id="e9483-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>

<span data-ttu-id="e9483-110">En el tutorial anterior, aprendió a ordenar y filtrar datos mediante el control `ObjectDataSource` y el Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="e9483-110">In the previous tutorial you learned how to sort and filter data using the `ObjectDataSource` control and the Entity Framework.</span></span> <span data-ttu-id="e9483-111">En este tutorial se muestran las opciones para administrar la simultaneidad en una aplicación Web ASP.NET que usa el Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="e9483-111">This tutorial shows options for handling concurrency in an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="e9483-112">Creará una nueva página web dedicada a actualizar las asignaciones de oficina del instructor.</span><span class="sxs-lookup"><span data-stu-id="e9483-112">You will create a new web page that's dedicated to updating instructor office assignments.</span></span> <span data-ttu-id="e9483-113">Podrá controlar los problemas de simultaneidad en esa página y en la página departamentos que creó anteriormente.</span><span class="sxs-lookup"><span data-stu-id="e9483-113">You'll handle concurrency issues in that page and in the Departments page that you created earlier.</span></span>

<span data-ttu-id="e9483-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span></span>

<span data-ttu-id="e9483-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span></span>

## <a name="concurrency-conflicts"></a><span data-ttu-id="e9483-116">Conflictos de simultaneidad</span><span class="sxs-lookup"><span data-stu-id="e9483-116">Concurrency Conflicts</span></span>

<span data-ttu-id="e9483-117">Un conflicto de simultaneidad se produce cuando un usuario edita un registro y otro usuario edita el mismo registro antes de que el primer cambio del usuario se escriba en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="e9483-117">A concurrency conflict occurs when one user edits a record and another user edits the same record before the first user's change is written to the database.</span></span> <span data-ttu-id="e9483-118">Si no configura la Entity Framework para detectar estos conflictos, quienquiera que actualice la base de datos sobrescribe los cambios del otro usuario.</span><span class="sxs-lookup"><span data-stu-id="e9483-118">If you don't set up the Entity Framework to detect such conflicts, whoever updates the database last overwrites the other user's changes.</span></span> <span data-ttu-id="e9483-119">En muchas aplicaciones, este riesgo es aceptable y no es necesario configurar la aplicación para controlar posibles conflictos de simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="e9483-119">In many applications, this risk is acceptable, and you don't have to configure the application to handle possible concurrency conflicts.</span></span> <span data-ttu-id="e9483-120">(Si hay pocos usuarios, o pocas actualizaciones, o si no es realmente crítico si se sobrescriben algunos cambios, el costo de la programación para la simultaneidad puede superar la ventaja). Si no necesita preocuparse por los conflictos de simultaneidad, puede omitir este tutorial; los dos tutoriales restantes de la serie no dependen de nada que cree en este.</span><span class="sxs-lookup"><span data-stu-id="e9483-120">(If there are few users, or few updates, or if isn't really critical if some changes are overwritten, the cost of programming for concurrency might outweigh the benefit.) If you don't need to worry about concurrency conflicts, you can skip this tutorial; the remaining two tutorials in the series don't depend on anything you build in this one.</span></span>

### <a name="pessimistic-concurrency-locking"></a><span data-ttu-id="e9483-121">Simultaneidad pesimista (bloqueo)</span><span class="sxs-lookup"><span data-stu-id="e9483-121">Pessimistic Concurrency (Locking)</span></span>

<span data-ttu-id="e9483-122">Si la aplicación necesita evitar la pérdida accidental de datos en casos de simultaneidad, una manera de hacerlo es usar los bloqueos de base de datos.</span><span class="sxs-lookup"><span data-stu-id="e9483-122">If your application does need to prevent accidental data loss in concurrency scenarios, one way to do that is to use database locks.</span></span> <span data-ttu-id="e9483-123">Esto se denomina *simultaneidad pesimista*.</span><span class="sxs-lookup"><span data-stu-id="e9483-123">This is called *pessimistic concurrency*.</span></span> <span data-ttu-id="e9483-124">Por ejemplo, antes de leer una fila de una base de datos, solicita un bloqueo de solo lectura o para acceso de actualización.</span><span class="sxs-lookup"><span data-stu-id="e9483-124">For example, before you read a row from a database, you request a lock for read-only or for update access.</span></span> <span data-ttu-id="e9483-125">Si bloquea una fila para acceso de actualización, no se permite que ningún otro usuario bloquee la fila como solo lectura o para acceso de actualización, porque recibirían una copia de los datos que se están modificando.</span><span class="sxs-lookup"><span data-stu-id="e9483-125">If you lock a row for update access, no other users are allowed to lock the row either for read-only or update access, because they would get a copy of data that's in the process of being changed.</span></span> <span data-ttu-id="e9483-126">Si bloquea una fila para acceso de solo lectura, otras personas también pueden bloquearla para acceso de solo lectura pero no para actualización.</span><span class="sxs-lookup"><span data-stu-id="e9483-126">If you lock a row for read-only access, others can also lock it for read-only access but not for update.</span></span>

<span data-ttu-id="e9483-127">La administración de bloqueos tiene algunas desventajas.</span><span class="sxs-lookup"><span data-stu-id="e9483-127">Managing locks has some disadvantages.</span></span> <span data-ttu-id="e9483-128">Puede ser bastante complicado de programar.</span><span class="sxs-lookup"><span data-stu-id="e9483-128">It can be complex to program.</span></span> <span data-ttu-id="e9483-129">Requiere importantes recursos de administración de bases de datos y puede provocar problemas de rendimiento a medida que aumenta el número de usuarios de una aplicación (es decir, no se escala bien).</span><span class="sxs-lookup"><span data-stu-id="e9483-129">It requires significant database management resources, and it can cause performance problems as the number of users of an application increases (that is, it doesn't scale well).</span></span> <span data-ttu-id="e9483-130">Por estos motivos, no todos los sistemas de administración de bases de datos admiten la simultaneidad pesimista.</span><span class="sxs-lookup"><span data-stu-id="e9483-130">For these reasons, not all database management systems support pessimistic concurrency.</span></span> <span data-ttu-id="e9483-131">El Entity Framework no proporciona compatibilidad integrada para ello, y en este tutorial no se muestra cómo implementarlo.</span><span class="sxs-lookup"><span data-stu-id="e9483-131">The Entity Framework provides no built-in support for it, and this tutorial doesn't show you how to implement it.</span></span>

### <a name="optimistic-concurrency"></a><span data-ttu-id="e9483-132">Simultaneidad optimista</span><span class="sxs-lookup"><span data-stu-id="e9483-132">Optimistic Concurrency</span></span>

<span data-ttu-id="e9483-133">La alternativa a la simultaneidad pesimista es la *simultaneidad optimista*.</span><span class="sxs-lookup"><span data-stu-id="e9483-133">The alternative to pessimistic concurrency is *optimistic concurrency*.</span></span> <span data-ttu-id="e9483-134">La simultaneidad optimista implica permitir que se produzcan conflictos de simultaneidad y reaccionar correctamente si ocurren.</span><span class="sxs-lookup"><span data-stu-id="e9483-134">Optimistic concurrency means allowing concurrency conflicts to happen, and then reacting appropriately if they do.</span></span> <span data-ttu-id="e9483-135">Por ejemplo, Juan ejecuta la página *Department. aspx* , hace clic en el vínculo **Editar** del Departamento de historial y reduce la cantidad de **presupuesto** de $1.000.000,00 a $125.000,00.</span><span class="sxs-lookup"><span data-stu-id="e9483-135">For example, John runs the *Department.aspx* page, clicks the **Edit** link for the History department, and reduces the **Budget** amount from $1,000,000.00 to $125,000.00.</span></span> <span data-ttu-id="e9483-136">(Juan administra un departamento competidor y desea liberar dinero para su propio departamento).</span><span class="sxs-lookup"><span data-stu-id="e9483-136">(John administers a competing department and wants to free up money for his own department.)</span></span>

<span data-ttu-id="e9483-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span></span>

<span data-ttu-id="e9483-138">Antes de que John haga clic en **Actualizar**, Julia ejecuta la misma página, hace clic en el vínculo **Editar** del Departamento de historial y, a continuación, cambia el campo de **fecha de inicio** de 1/10/2011 a 1/1/1999.</span><span class="sxs-lookup"><span data-stu-id="e9483-138">Before John clicks **Update**, Jane runs the same page, clicks the **Edit** link for the History department, and then changes the **Start Date** field from 1/10/2011 to 1/1/1999.</span></span> <span data-ttu-id="e9483-139">(Julia administra el Departamento de historial y desea darle más responsabilidad).</span><span class="sxs-lookup"><span data-stu-id="e9483-139">(Jane administers the History department and wants to give it more seniority.)</span></span>

<span data-ttu-id="e9483-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span></span>

<span data-ttu-id="e9483-141">Juan hace clic en **Actualizar** primero y, a continuación, Julia hace clic en **Actualizar**.</span><span class="sxs-lookup"><span data-stu-id="e9483-141">John clicks **Update** first, then Jane clicks **Update**.</span></span> <span data-ttu-id="e9483-142">El explorador de Julia ahora muestra el importe de la **cotización** como $1.000.000,00, pero es incorrecto porque el importe ha cambiado por John a $125.000,00.</span><span class="sxs-lookup"><span data-stu-id="e9483-142">Jane's browser now lists the **Budget** amount as $1,000,000.00, but this is incorrect because the amount has been changed by John to $125,000.00.</span></span>

<span data-ttu-id="e9483-143">Algunas de las acciones que puede realizar en este escenario son las siguientes:</span><span class="sxs-lookup"><span data-stu-id="e9483-143">Some of the actions you can take in this scenario include the following:</span></span>

- <span data-ttu-id="e9483-144">Puede realizar un seguimiento de la propiedad que ha modificado un usuario y actualizar solo las columnas correspondientes de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="e9483-144">You can keep track of which property a user has modified and update only the corresponding columns in the database.</span></span> <span data-ttu-id="e9483-145">En el escenario de ejemplo, no se perdería ningún dato porque los dos usuarios actualizaron diferentes propiedades.</span><span class="sxs-lookup"><span data-stu-id="e9483-145">In the example scenario, no data would be lost, because different properties were updated by the two users.</span></span> <span data-ttu-id="e9483-146">La próxima vez que un usuario examine el Departamento de historial, verá 1/1/1999 y $125.000,00.</span><span class="sxs-lookup"><span data-stu-id="e9483-146">The next time someone browses the History department, they will see 1/1/1999 and $125,000.00.</span></span> 

    <span data-ttu-id="e9483-147">Este es el comportamiento predeterminado en el Entity Framework y puede reducir considerablemente el número de conflictos que podrían provocar la pérdida de datos.</span><span class="sxs-lookup"><span data-stu-id="e9483-147">This is the default behavior in the Entity Framework, and it can substantially reduce the number of conflicts that could result in data loss.</span></span> <span data-ttu-id="e9483-148">Sin embargo, este comportamiento no evita la pérdida de datos si se realizan cambios competitivos en la misma propiedad de una entidad.</span><span class="sxs-lookup"><span data-stu-id="e9483-148">However, this behavior doesn't avoid data loss if competing changes are made to the same property of an entity.</span></span> <span data-ttu-id="e9483-149">Además, este comportamiento no siempre es posible; al asignar procedimientos almacenados a un tipo de entidad, todas las propiedades de una entidad se actualizan cuando se realizan cambios en la entidad en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="e9483-149">In addition, this behavior isn't always possible; when you map stored procedures to an entity type, all of an entity's properties are updated when any changes to the entity are made in the database.</span></span>
- <span data-ttu-id="e9483-150">Puede dejar que el cambio de Julia sobrescriba el cambio de John.</span><span class="sxs-lookup"><span data-stu-id="e9483-150">You can let Jane's change overwrite John's change.</span></span> <span data-ttu-id="e9483-151">Una vez que Julia haga clic en **Actualizar**, la cantidad de **presupuesto** volverá a $1.000.000,00.</span><span class="sxs-lookup"><span data-stu-id="e9483-151">After Jane clicks **Update**, the **Budget** amount goes back to $1,000,000.00.</span></span> <span data-ttu-id="e9483-152">Esto se denomina un escenario de *Prevalece el cliente* o *Prevalece el último*.</span><span class="sxs-lookup"><span data-stu-id="e9483-152">This is called a *Client Wins* or *Last in Wins* scenario.</span></span> <span data-ttu-id="e9483-153">(Los valores del cliente tienen prioridad sobre lo que hay en el almacén de datos).</span><span class="sxs-lookup"><span data-stu-id="e9483-153">(The client's values take precedence over what's in the data store.)</span></span>
- <span data-ttu-id="e9483-154">Puede impedir que el cambio de Julia se actualice en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="e9483-154">You can prevent Jane's change from being updated in the database.</span></span> <span data-ttu-id="e9483-155">Normalmente, se muestra un mensaje de error, se muestra el estado actual de los datos y se le permite volver a escribir los cambios si todavía desea realizarlos.</span><span class="sxs-lookup"><span data-stu-id="e9483-155">Typically, you would display an error message, show her the current state of the data, and allow her to reenter her changes if she still wants to make them.</span></span> <span data-ttu-id="e9483-156">También puede automatizar el proceso si guarda su entrada y le proporciona la oportunidad de volver a aplicarla sin tener que volver a escribirla.</span><span class="sxs-lookup"><span data-stu-id="e9483-156">You could further automate the process by saving her input and giving her an opportunity to reapply it without having to reenter it.</span></span> <span data-ttu-id="e9483-157">Esto se denomina un escenario de *Prevalece el almacén*.</span><span class="sxs-lookup"><span data-stu-id="e9483-157">This is called a *Store Wins* scenario.</span></span> <span data-ttu-id="e9483-158">(Los valores del almacén de datos tienen prioridad sobre los valores enviados por el cliente).</span><span class="sxs-lookup"><span data-stu-id="e9483-158">(The data-store values take precedence over the values submitted by the client.)</span></span>

### <a name="detecting-concurrency-conflicts"></a><span data-ttu-id="e9483-159">Detectar conflictos de simultaneidad</span><span class="sxs-lookup"><span data-stu-id="e9483-159">Detecting Concurrency Conflicts</span></span>

<span data-ttu-id="e9483-160">En el Entity Framework, puede resolver conflictos controlando `OptimisticConcurrencyException` excepciones que inicia la Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="e9483-160">In the Entity Framework, you can resolve conflicts by handling `OptimisticConcurrencyException` exceptions that the Entity Framework throws.</span></span> <span data-ttu-id="e9483-161">Para saber cuándo se producen dichas excepciones, Entity Framework debe ser capaz de detectar conflictos.</span><span class="sxs-lookup"><span data-stu-id="e9483-161">In order to know when to throw these exceptions, the Entity Framework must be able to detect conflicts.</span></span> <span data-ttu-id="e9483-162">Por lo tanto, debe configurar correctamente la base de datos y el modelo de datos.</span><span class="sxs-lookup"><span data-stu-id="e9483-162">Therefore, you must configure the database and the data model appropriately.</span></span> <span data-ttu-id="e9483-163">Algunas opciones para habilitar la detección de conflictos son las siguientes:</span><span class="sxs-lookup"><span data-stu-id="e9483-163">Some options for enabling conflict detection include the following:</span></span>

- <span data-ttu-id="e9483-164">En la base de datos, incluya una columna de la tabla que se puede usar para determinar cuándo se ha cambiado una fila.</span><span class="sxs-lookup"><span data-stu-id="e9483-164">In the database, include a table column that can be used to determine when a row has been changed.</span></span> <span data-ttu-id="e9483-165">Después, puede configurar el Entity Framework para incluir esa columna en la cláusula `Where` de los comandos SQL `Update` o `Delete`.</span><span class="sxs-lookup"><span data-stu-id="e9483-165">You can then configure the Entity Framework to include that column in the `Where` clause of SQL `Update` or `Delete` commands.</span></span>

    <span data-ttu-id="e9483-166">Este es el propósito de la columna `Timestamp` en la tabla `OfficeAssignment`.</span><span class="sxs-lookup"><span data-stu-id="e9483-166">That's the purpose of the `Timestamp` column in the `OfficeAssignment` table.</span></span>

    <span data-ttu-id="e9483-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span></span>

    <span data-ttu-id="e9483-168">El tipo de datos de la columna de `Timestamp` también se denomina `Timestamp`.</span><span class="sxs-lookup"><span data-stu-id="e9483-168">The data type of the `Timestamp` column is also called `Timestamp`.</span></span> <span data-ttu-id="e9483-169">Sin embargo, la columna no contiene realmente un valor de fecha u hora.</span><span class="sxs-lookup"><span data-stu-id="e9483-169">However, the column doesn't actually contain a date or time value.</span></span> <span data-ttu-id="e9483-170">En su lugar, el valor es un número secuencial que se incrementa cada vez que se actualiza la fila.</span><span class="sxs-lookup"><span data-stu-id="e9483-170">Instead, the value is a sequential number that's incremented each time the row is updated.</span></span> <span data-ttu-id="e9483-171">En un comando `Update` o `Delete`, la cláusula `Where` incluye el valor de `Timestamp` original.</span><span class="sxs-lookup"><span data-stu-id="e9483-171">In an `Update` or `Delete` command, the `Where` clause includes the original `Timestamp` value.</span></span> <span data-ttu-id="e9483-172">Si otro usuario ha cambiado la fila que se está actualizando, el valor de `Timestamp` es diferente del valor original, por lo que la cláusula `Where` no devuelve ninguna fila para actualizar.</span><span class="sxs-lookup"><span data-stu-id="e9483-172">If the row being updated has been changed by another user, the value in `Timestamp` is different than the original value, so the `Where` clause returns no row to update.</span></span> <span data-ttu-id="e9483-173">Cuando el Entity Framework encuentra que no se ha actualizado ninguna fila con el comando actual o el `Update` de `Delete` (es decir, cuando el número de filas afectadas es cero), lo interpreta como un conflicto de simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="e9483-173">When the Entity Framework finds that no rows have been updated by the current `Update` or `Delete` command (that is, when the number of affected rows is zero), it interprets that as a concurrency conflict.</span></span>
- <span data-ttu-id="e9483-174">Configure el Entity Framework para incluir los valores originales de cada columna de la tabla en la cláusula `Where` de los comandos `Update` y `Delete`.</span><span class="sxs-lookup"><span data-stu-id="e9483-174">Configure the Entity Framework to include the original values of every column in the table in the `Where` clause of `Update` and `Delete` commands.</span></span>

    <span data-ttu-id="e9483-175">Como en la primera opción, si alguna de las filas ha cambiado desde la primera vez que se leyó la fila, la cláusula `Where` no devolverá una fila para actualizar, lo que el Entity Framework interpreta como un conflicto de simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="e9483-175">As in the first option, if anything in the row has changed since the row was first read, the `Where` clause won't return a row to update, which the Entity Framework interprets as a concurrency conflict.</span></span> <span data-ttu-id="e9483-176">Este método es tan eficaz como el uso de un campo de `Timestamp`, pero puede ser ineficaz.</span><span class="sxs-lookup"><span data-stu-id="e9483-176">This method is as effective as using a `Timestamp` field, but can be inefficient.</span></span> <span data-ttu-id="e9483-177">En el caso de las tablas de base de datos que tienen muchas columnas, puede dar lugar a cláusulas de `Where` muy grandes y, en una aplicación Web, puede requerir que mantenga grandes cantidades de estado.</span><span class="sxs-lookup"><span data-stu-id="e9483-177">For database tables that have many columns, it can result in very large `Where` clauses, and in a web application it can require that you maintain large amounts of state.</span></span> <span data-ttu-id="e9483-178">Mantener grandes cantidades de estado puede afectar al rendimiento de la aplicación porque requiere recursos del servidor (por ejemplo, el estado de la sesión) o debe incluirse en la propia página web (por ejemplo, el estado de vista).</span><span class="sxs-lookup"><span data-stu-id="e9483-178">Maintaining large amounts of state can affect application performance because it either requires server resources (for example, session state) or must be included in the web page itself (for example, view state).</span></span>

<span data-ttu-id="e9483-179">En este tutorial, agregará control de errores para conflictos de simultaneidad optimista para una entidad que no tiene una propiedad de seguimiento (la entidad `Department`) y para una entidad que tiene una propiedad de seguimiento (la entidad `OfficeAssignment`).</span><span class="sxs-lookup"><span data-stu-id="e9483-179">In this tutorial you will add error handling for optimistic concurrency conflicts for an entity that doesn't have a tracking property (the `Department` entity) and for an entity that does have a tracking property (the `OfficeAssignment` entity).</span></span>

## <a name="handling-optimistic-concurrency-without-a-tracking-property"></a><span data-ttu-id="e9483-180">Controlar la simultaneidad optimista sin una propiedad de seguimiento</span><span class="sxs-lookup"><span data-stu-id="e9483-180">Handling Optimistic Concurrency Without a Tracking Property</span></span>

<span data-ttu-id="e9483-181">Para implementar la simultaneidad optimista para la entidad `Department`, que no tiene una propiedad Tracking (`Timestamp`), realizará las tareas siguientes:</span><span class="sxs-lookup"><span data-stu-id="e9483-181">To implement optimistic concurrency for the `Department` entity, which doesn't have a tracking (`Timestamp`) property, you will complete the following tasks:</span></span>

- <span data-ttu-id="e9483-182">Cambie el modelo de datos para habilitar el seguimiento de simultaneidad para entidades de `Department`.</span><span class="sxs-lookup"><span data-stu-id="e9483-182">Change the data model to enable concurrency tracking for `Department` entities.</span></span>
- <span data-ttu-id="e9483-183">En la clase `SchoolRepository`, controle las excepciones de simultaneidad en el método `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="e9483-183">In the `SchoolRepository` class, handle concurrency exceptions in the `SaveChanges` method.</span></span>
- <span data-ttu-id="e9483-184">En la página *departments. aspx* , controle las excepciones de simultaneidad mostrando un mensaje a la advertencia del usuario de que los cambios que se han intentado no se han realizado correctamente.</span><span class="sxs-lookup"><span data-stu-id="e9483-184">In the *Departments.aspx* page, handle concurrency exceptions by displaying a message to the user warning that the attempted changes were unsuccessful.</span></span> <span data-ttu-id="e9483-185">Después, el usuario puede ver los valores actuales y volver a intentar los cambios si todavía son necesarios.</span><span class="sxs-lookup"><span data-stu-id="e9483-185">The user can then see the current values and retry the changes if they are still needed.</span></span>

### <a name="enabling-concurrency-tracking-in-the-data-model"></a><span data-ttu-id="e9483-186">Habilitar el seguimiento de simultaneidad en el modelo de datos</span><span class="sxs-lookup"><span data-stu-id="e9483-186">Enabling Concurrency Tracking in the Data Model</span></span>

<span data-ttu-id="e9483-187">En Visual Studio, abra la aplicación web contoso University con la que estaba trabajando en el tutorial anterior de esta serie.</span><span class="sxs-lookup"><span data-stu-id="e9483-187">In Visual Studio, open the Contoso University web application that you were working with in the previous tutorial in this series.</span></span>

<span data-ttu-id="e9483-188">Abra *SchoolModel. edmx*y, en el diseñador de modelos de datos, haga clic con el botón secundario en la propiedad `Name` de la entidad `Department` y, a continuación, haga clic en **propiedades**.</span><span class="sxs-lookup"><span data-stu-id="e9483-188">Open *SchoolModel.edmx*, and in the data model designer, right-click the `Name` property in the `Department` entity and then click **Properties**.</span></span> <span data-ttu-id="e9483-189">En la ventana **propiedades** , cambie la propiedad `ConcurrencyMode` a `Fixed`.</span><span class="sxs-lookup"><span data-stu-id="e9483-189">In the **Properties** window, change the `ConcurrencyMode` property to `Fixed`.</span></span>

<span data-ttu-id="e9483-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span></span>

<span data-ttu-id="e9483-191">Haga lo mismo para las demás propiedades escalares que no sean de clave principal (`Budget`, `StartDate`y `Administrator`). (No se puede hacer esto para las propiedades de navegación). Esto especifica que, cada vez que el Entity Framework genera un comando SQL `Update` o `Delete` para actualizar la entidad `Department` en la base de datos, estas columnas (con valores originales) deben incluirse en la cláusula `Where`.</span><span class="sxs-lookup"><span data-stu-id="e9483-191">Do the same for the other non-primary-key scalar properties (`Budget`, `StartDate`, and `Administrator`.) (You can't do this for navigation properties.) This specifies that whenever the Entity Framework generates a `Update` or `Delete` SQL command to update the `Department` entity in the database, these columns (with original values) must be included in the `Where` clause.</span></span> <span data-ttu-id="e9483-192">Si no se encuentra ninguna fila cuando se ejecuta el comando `Update` o `Delete`, el Entity Framework producirá una excepción de simultaneidad optimista.</span><span class="sxs-lookup"><span data-stu-id="e9483-192">If no row is found when the `Update` or `Delete` command executes, the Entity Framework will throw an optimistic-concurrency exception.</span></span>

<span data-ttu-id="e9483-193">Guarde y cierre el modelo de datos.</span><span class="sxs-lookup"><span data-stu-id="e9483-193">Save and close the data model.</span></span>

### <a name="handling-concurrency-exceptions-in-the-dal"></a><span data-ttu-id="e9483-194">Controlar las excepciones de simultaneidad en la capa DAL</span><span class="sxs-lookup"><span data-stu-id="e9483-194">Handling Concurrency Exceptions in the DAL</span></span>

<span data-ttu-id="e9483-195">Abra *SchoolRepository.CS* y agregue la siguiente instrucción `using` para el espacio de nombres `System.Data`:</span><span class="sxs-lookup"><span data-stu-id="e9483-195">Open *SchoolRepository.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample1.cs)]

<span data-ttu-id="e9483-196">Agregue el siguiente método `SaveChanges` nuevo, que controla las excepciones de simultaneidad optimista:</span><span class="sxs-lookup"><span data-stu-id="e9483-196">Add the following new `SaveChanges` method, which handles optimistic concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample2.cs)]

<span data-ttu-id="e9483-197">Si se produce un error de simultaneidad cuando se llama a este método, los valores de propiedad de la entidad en memoria se reemplazan por los valores que se encuentran actualmente en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="e9483-197">If a concurrency error occurs when this method is called, the property values of the entity in memory are replaced with the values currently in the database.</span></span> <span data-ttu-id="e9483-198">Se vuelve a producir la excepción de simultaneidad para que la página web pueda controlarla.</span><span class="sxs-lookup"><span data-stu-id="e9483-198">The concurrency exception is rethrown so that the web page can handle it.</span></span>

<span data-ttu-id="e9483-199">En los métodos `DeleteDepartment` y `UpdateDepartment`, reemplace la llamada existente a `context.SaveChanges()` por una llamada a `SaveChanges()` para invocar el nuevo método.</span><span class="sxs-lookup"><span data-stu-id="e9483-199">In the `DeleteDepartment` and `UpdateDepartment` methods, replace the existing call to `context.SaveChanges()` with a call to `SaveChanges()` in order to invoke the new method.</span></span>

### <a name="handling-concurrency-exceptions-in-the-presentation-layer"></a><span data-ttu-id="e9483-200">Controlar las excepciones de simultaneidad en el nivel de presentación</span><span class="sxs-lookup"><span data-stu-id="e9483-200">Handling Concurrency Exceptions in the Presentation Layer</span></span>

<span data-ttu-id="e9483-201">Abra *departments. aspx* y agregue un atributo `OnDeleted="DepartmentsObjectDataSource_Deleted"` al control `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="e9483-201">Open *Departments.aspx* and add an `OnDeleted="DepartmentsObjectDataSource_Deleted"` attribute to the `DepartmentsObjectDataSource` control.</span></span> <span data-ttu-id="e9483-202">La etiqueta de apertura del control ahora será similar a la del ejemplo siguiente.</span><span class="sxs-lookup"><span data-stu-id="e9483-202">The opening tag for the control will now resemble the following example.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample3.aspx)]

<span data-ttu-id="e9483-203">En el control `DepartmentsGridView`, especifique todas las columnas de la tabla en el atributo `DataKeyNames`, tal y como se muestra en el ejemplo siguiente.</span><span class="sxs-lookup"><span data-stu-id="e9483-203">In the `DepartmentsGridView` control, specify all of the table columns in the `DataKeyNames` attribute, as shown in the following example.</span></span> <span data-ttu-id="e9483-204">Tenga en cuenta que esto creará campos de estado de vista muy grandes, que es una de las razones por las que el uso de un campo de seguimiento suele ser la mejor manera de realizar un seguimiento de los conflictos de simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="e9483-204">Note that this will create very large view state fields, which is one reason why using a tracking field is generally the preferred way to track concurrency conflicts.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample4.aspx)]

<span data-ttu-id="e9483-205">Abra *departments.aspx.CS* y agregue la siguiente instrucción `using` para el espacio de nombres `System.Data`:</span><span class="sxs-lookup"><span data-stu-id="e9483-205">Open *Departments.aspx.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample5.cs)]

<span data-ttu-id="e9483-206">Agregue el siguiente método nuevo, al que se llamará desde los controladores de eventos `Updated` y `Deleted` del control de origen de datos para controlar las excepciones de simultaneidad:</span><span class="sxs-lookup"><span data-stu-id="e9483-206">Add the following new method, which you will call from the data source control's `Updated` and `Deleted` event handlers for handling concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample6.cs)]

<span data-ttu-id="e9483-207">Este código comprueba el tipo de excepción y, si se trata de una excepción de simultaneidad, el código crea dinámicamente un control `CustomValidator` que, a su vez, muestra un mensaje en el control `ValidationSummary`.</span><span class="sxs-lookup"><span data-stu-id="e9483-207">This code checks the exception type, and if it's a concurrency exception, the code dynamically creates a `CustomValidator` control that in turn displays a message in the `ValidationSummary` control.</span></span>

<span data-ttu-id="e9483-208">Llame al nuevo método desde el `Updated` controlador de eventos que agregó anteriormente.</span><span class="sxs-lookup"><span data-stu-id="e9483-208">Call the new method from the `Updated` event handler that you added earlier.</span></span> <span data-ttu-id="e9483-209">Además, cree un nuevo controlador de eventos `Deleted` que llame al mismo método (pero no haga nada más):</span><span class="sxs-lookup"><span data-stu-id="e9483-209">In addition, create a new `Deleted` event handler that calls the same method (but doesn't do anything else):</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample7.cs)]

### <a name="testing-optimistic-concurrency-in-the-departments-page"></a><span data-ttu-id="e9483-210">Prueba de la simultaneidad optimista en la página de departamentos</span><span class="sxs-lookup"><span data-stu-id="e9483-210">Testing Optimistic Concurrency in the Departments Page</span></span>

<span data-ttu-id="e9483-211">Ejecute la página *departments. aspx* .</span><span class="sxs-lookup"><span data-stu-id="e9483-211">Run the *Departments.aspx* page.</span></span>

<span data-ttu-id="e9483-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span></span>

<span data-ttu-id="e9483-213">Haga clic en **Editar** en una fila y cambie el valor de la columna **presupuesto** .</span><span class="sxs-lookup"><span data-stu-id="e9483-213">Click **Edit** in a row and change the value in the **Budget** column.</span></span> <span data-ttu-id="e9483-214">(Recuerde que solo puede editar los registros que ha creado para este tutorial, ya que los registros de la base de datos de `School` existentes contienen algunos datos no válidos.</span><span class="sxs-lookup"><span data-stu-id="e9483-214">(Remember that you can only edit records that you've created for this tutorial, because the existing `School` database records contain some invalid data.</span></span> <span data-ttu-id="e9483-215">El registro del Departamento de economía es un seguro con el que experimentar.</span><span class="sxs-lookup"><span data-stu-id="e9483-215">The record for the Economics department is a safe one to experiment with.)</span></span>

<span data-ttu-id="e9483-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span></span>

<span data-ttu-id="e9483-217">Abra una nueva ventana del explorador y vuelva a ejecutar la página (Copie la dirección URL del cuadro de dirección de la primera ventana del explorador en la segunda ventana del explorador).</span><span class="sxs-lookup"><span data-stu-id="e9483-217">Open a new browser window and run the page again (copy the URL from the first browser window's address box to the second browser window).</span></span>

<span data-ttu-id="e9483-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span></span>

<span data-ttu-id="e9483-219">Haga clic en **Editar** en la misma fila que editó anteriormente y cambie el valor de **presupuesto** a algo diferente.</span><span class="sxs-lookup"><span data-stu-id="e9483-219">Click **Edit** in the same row you edited earlier and change the **Budget** value to something different.</span></span>

<span data-ttu-id="e9483-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span></span>

<span data-ttu-id="e9483-221">En la segunda ventana del explorador, haga clic en **Actualizar**.</span><span class="sxs-lookup"><span data-stu-id="e9483-221">In the second browser window, click **Update**.</span></span> <span data-ttu-id="e9483-222">El importe del **presupuesto** se ha cambiado correctamente a este nuevo valor.</span><span class="sxs-lookup"><span data-stu-id="e9483-222">The **Budget** amount is successfully changed to this new value.</span></span>

<span data-ttu-id="e9483-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span></span>

<span data-ttu-id="e9483-224">En la primera ventana del explorador, haga clic en **Actualizar**.</span><span class="sxs-lookup"><span data-stu-id="e9483-224">In the first browser window, click **Update**.</span></span> <span data-ttu-id="e9483-225">Se produce un error en la actualización.</span><span class="sxs-lookup"><span data-stu-id="e9483-225">The update fails.</span></span> <span data-ttu-id="e9483-226">El importe del **presupuesto** se vuelve a mostrar con el valor establecido en la segunda ventana del explorador y se muestra un mensaje de error.</span><span class="sxs-lookup"><span data-stu-id="e9483-226">The **Budget** amount is redisplayed using the value you set in the second browser window, and you see an error message.</span></span>

<span data-ttu-id="e9483-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span></span>

## <a name="handling-optimistic-concurrency-using-a-tracking-property"></a><span data-ttu-id="e9483-228">Controlar la simultaneidad optimista mediante una propiedad de seguimiento</span><span class="sxs-lookup"><span data-stu-id="e9483-228">Handling Optimistic Concurrency Using a Tracking Property</span></span>

<span data-ttu-id="e9483-229">Para controlar la simultaneidad optimista de una entidad que tiene una propiedad de seguimiento, realizará las tareas siguientes:</span><span class="sxs-lookup"><span data-stu-id="e9483-229">To handle optimistic concurrency for an entity that has a tracking property, you will complete the following tasks:</span></span>

- <span data-ttu-id="e9483-230">Agregue procedimientos almacenados al modelo de datos para administrar entidades `OfficeAssignment`.</span><span class="sxs-lookup"><span data-stu-id="e9483-230">Add stored procedures to the data model to manage `OfficeAssignment` entities.</span></span> <span data-ttu-id="e9483-231">(Las propiedades de seguimiento y los procedimientos almacenados no tienen que usarse juntos; se agrupan aquí para ilustrarlos).</span><span class="sxs-lookup"><span data-stu-id="e9483-231">(Tracking properties and stored procedures don't have to be used together; they're just grouped together here for illustration.)</span></span>
- <span data-ttu-id="e9483-232">Agregue métodos CRUD a la capa DAL y el BLL para entidades `OfficeAssignment`, incluido el código para controlar las excepciones de simultaneidad optimista en la capa DAL.</span><span class="sxs-lookup"><span data-stu-id="e9483-232">Add CRUD methods to the DAL and the BLL for `OfficeAssignment` entities, including code to handle optimistic concurrency exceptions in the DAL.</span></span>
- <span data-ttu-id="e9483-233">Cree una página web de asignaciones de Office.</span><span class="sxs-lookup"><span data-stu-id="e9483-233">Create an office-assignments web page.</span></span>
- <span data-ttu-id="e9483-234">Pruebe la simultaneidad optimista en la nueva página web.</span><span class="sxs-lookup"><span data-stu-id="e9483-234">Test optimistic concurrency in the new web page.</span></span>

### <a name="adding-officeassignment-stored-procedures-to-the-data-model"></a><span data-ttu-id="e9483-235">Agregar procedimientos almacenados OfficeAssignment al modelo de datos</span><span class="sxs-lookup"><span data-stu-id="e9483-235">Adding OfficeAssignment Stored Procedures to the Data Model</span></span>

<span data-ttu-id="e9483-236">Abra el archivo *SchoolModel. edmx* en el diseñador de modelos, haga clic con el botón secundario en la superficie de diseño y haga clic en **Actualizar modelo desde base de datos**.</span><span class="sxs-lookup"><span data-stu-id="e9483-236">Open the *SchoolModel.edmx* file in the model designer, right-click the design surface, and click **Update Model from Database**.</span></span> <span data-ttu-id="e9483-237">En la pestaña **Agregar** del cuadro de diálogo **Elija los objetos de base de datos** , expanda **procedimientos almacenados** y seleccione los tres `OfficeAssignment` procedimientos almacenados (vea la siguiente captura de pantalla) y, a continuación, haga clic en **Finalizar**.</span><span class="sxs-lookup"><span data-stu-id="e9483-237">In the **Add** tab of the **Choose Your Database Objects** dialog box, expand **Stored Procedures** and select the three `OfficeAssignment` stored procedures (see the following screenshot), and then click **Finish**.</span></span> <span data-ttu-id="e9483-238">(Estos procedimientos almacenados ya estaban en la base de datos cuando lo descargó o creó mediante un script).</span><span class="sxs-lookup"><span data-stu-id="e9483-238">(These stored procedures were already in the database when you downloaded or created it using a script.)</span></span>

<span data-ttu-id="e9483-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span></span>

<span data-ttu-id="e9483-240">Haga clic con el botón secundario en la entidad `OfficeAssignment` y seleccione **asignación de procedimiento almacenado**.</span><span class="sxs-lookup"><span data-stu-id="e9483-240">Right-click the `OfficeAssignment` entity and select **Stored Procedure Mapping**.</span></span>

<span data-ttu-id="e9483-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span></span>

<span data-ttu-id="e9483-242">Establezca las funciones de **inserción**, **actualización**y **eliminación** para usar sus procedimientos almacenados correspondientes.</span><span class="sxs-lookup"><span data-stu-id="e9483-242">Set the **Insert**, **Update**, and **Delete** functions to use their corresponding stored procedures.</span></span> <span data-ttu-id="e9483-243">Para el parámetro `OrigTimestamp` de la función `Update`, establezca la **propiedad** en `Timestamp` y seleccione la opción **usar valor original** .</span><span class="sxs-lookup"><span data-stu-id="e9483-243">For the `OrigTimestamp` parameter of the `Update` function, set the **Property** to `Timestamp` and select the **Use Original Value** option.</span></span>

<span data-ttu-id="e9483-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span></span>

<span data-ttu-id="e9483-245">Cuando el Entity Framework llama al procedimiento almacenado `UpdateOfficeAssignment`, pasará el valor original de la columna `Timestamp` en el parámetro `OrigTimestamp`.</span><span class="sxs-lookup"><span data-stu-id="e9483-245">When the Entity Framework calls the `UpdateOfficeAssignment` stored procedure, it will pass the original value of the `Timestamp` column in the `OrigTimestamp` parameter.</span></span> <span data-ttu-id="e9483-246">El procedimiento almacenado utiliza este parámetro en su cláusula `Where`:</span><span class="sxs-lookup"><span data-stu-id="e9483-246">The stored procedure uses this parameter in its `Where` clause:</span></span>

[!code-sql[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample8.sql)]

<span data-ttu-id="e9483-247">El procedimiento almacenado también selecciona el nuevo valor de la columna `Timestamp` después de la actualización para que el Entity Framework pueda mantener la entidad `OfficeAssignment` que está en la memoria sincronizada con la fila de base de datos correspondiente.</span><span class="sxs-lookup"><span data-stu-id="e9483-247">The stored procedure also selects the new value of the `Timestamp` column after the update so that the Entity Framework can keep the `OfficeAssignment` entity that's in memory in sync with the corresponding database row.</span></span>

<span data-ttu-id="e9483-248">(Tenga en cuenta que el procedimiento almacenado para eliminar una asignación de Office no tiene un parámetro `OrigTimestamp`.</span><span class="sxs-lookup"><span data-stu-id="e9483-248">(Note that the stored procedure for deleting an office assignment doesn't have an `OrigTimestamp` parameter.</span></span> <span data-ttu-id="e9483-249">Por este motivo, el Entity Framework no puede comprobar que una entidad no ha cambiado antes de eliminarla.)</span><span class="sxs-lookup"><span data-stu-id="e9483-249">Because of this, the Entity Framework can't verify that an entity is unchanged before deleting it.)</span></span>

<span data-ttu-id="e9483-250">Guarde y cierre el modelo de datos.</span><span class="sxs-lookup"><span data-stu-id="e9483-250">Save and close the data model.</span></span>

### <a name="adding-officeassignment-methods-to-the-dal"></a><span data-ttu-id="e9483-251">Agregar métodos OfficeAssignment a la capa DAL</span><span class="sxs-lookup"><span data-stu-id="e9483-251">Adding OfficeAssignment Methods to the DAL</span></span>

<span data-ttu-id="e9483-252">Abra *ISchoolRepository.CS* y agregue los siguientes métodos CRUD para el conjunto de entidades `OfficeAssignment`:</span><span class="sxs-lookup"><span data-stu-id="e9483-252">Open *ISchoolRepository.cs* and add the following CRUD methods for the `OfficeAssignment` entity set:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample9.cs)]

<span data-ttu-id="e9483-253">Agregue los siguientes métodos nuevos a *SchoolRepository.CS*.</span><span class="sxs-lookup"><span data-stu-id="e9483-253">Add the following new methods to *SchoolRepository.cs*.</span></span> <span data-ttu-id="e9483-254">En el método `UpdateOfficeAssignment`, se llama al método de `SaveChanges` local en lugar de a `context.SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="e9483-254">In the `UpdateOfficeAssignment` method, you call the local `SaveChanges` method instead of `context.SaveChanges`.</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample10.cs)]

<span data-ttu-id="e9483-255">En el proyecto de prueba, Abra *MockSchoolRepository.CS* y agregue la siguiente `OfficeAssignment` colección y métodos CRUD.</span><span class="sxs-lookup"><span data-stu-id="e9483-255">In the test project, open *MockSchoolRepository.cs* and add the following `OfficeAssignment` collection and CRUD methods to it.</span></span> <span data-ttu-id="e9483-256">(El repositorio ficticio debe implementar la interfaz del repositorio o la solución no se compilará).</span><span class="sxs-lookup"><span data-stu-id="e9483-256">(The mock repository must implement the repository interface, or the solution won't compile.)</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample11.cs)]

### <a name="adding-officeassignment-methods-to-the-bll"></a><span data-ttu-id="e9483-257">Agregar métodos OfficeAssignment a la capa BLL</span><span class="sxs-lookup"><span data-stu-id="e9483-257">Adding OfficeAssignment Methods to the BLL</span></span>

<span data-ttu-id="e9483-258">En el proyecto principal, Abra *SchoolBL.CS* y agregue los siguientes métodos CRUD para el conjunto de entidades `OfficeAssignment`:</span><span class="sxs-lookup"><span data-stu-id="e9483-258">In the main project, open *SchoolBL.cs* and add the following CRUD methods for the `OfficeAssignment` entity set to it:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample12.cs)]

## <a name="creating-an-officeassignments-web-page"></a><span data-ttu-id="e9483-259">Crear una página web de OfficeAssignments</span><span class="sxs-lookup"><span data-stu-id="e9483-259">Creating an OfficeAssignments Web Page</span></span>

<span data-ttu-id="e9483-260">Cree una nueva página web que use la página maestra *site. Master* y asígnele el nombre *OfficeAssignments. aspx*.</span><span class="sxs-lookup"><span data-stu-id="e9483-260">Create a new web page that uses the *Site.Master* master page and name it *OfficeAssignments.aspx*.</span></span> <span data-ttu-id="e9483-261">Agregue el marcado siguiente al control `Content` denominado `Content2`:</span><span class="sxs-lookup"><span data-stu-id="e9483-261">Add the following markup to the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample13.aspx)]

<span data-ttu-id="e9483-262">Observe que en el atributo `DataKeyNames`, el marcado especifica la propiedad `Timestamp` así como la clave de registro (`InstructorID`).</span><span class="sxs-lookup"><span data-stu-id="e9483-262">Notice that in the `DataKeyNames` attribute, the markup specifies the `Timestamp` property as well as the record key (`InstructorID`).</span></span> <span data-ttu-id="e9483-263">Al especificar propiedades en el atributo `DataKeyNames`, el control los guarda en el estado de control (que es similar al estado de vista) para que los valores originales estén disponibles durante el procesamiento de los postback.</span><span class="sxs-lookup"><span data-stu-id="e9483-263">Specifying properties in the `DataKeyNames` attribute causes the control to save them in control state (which is similar to view state) so that the original values are available during postback processing.</span></span>

<span data-ttu-id="e9483-264">Si no guardó el valor de `Timestamp`, el Entity Framework no lo tendría para la cláusula `Where` del comando de SQL `Update`.</span><span class="sxs-lookup"><span data-stu-id="e9483-264">If you didn't save the `Timestamp` value, the Entity Framework would not have it for the `Where` clause of the SQL `Update` command.</span></span> <span data-ttu-id="e9483-265">En consecuencia, no se puede actualizar nada.</span><span class="sxs-lookup"><span data-stu-id="e9483-265">Consequently nothing would be found to update.</span></span> <span data-ttu-id="e9483-266">Como resultado, el Entity Framework produciría una excepción de simultaneidad optimista cada vez que se actualiza una entidad de `OfficeAssignment`.</span><span class="sxs-lookup"><span data-stu-id="e9483-266">As a result, the Entity Framework would throw an optimistic concurrency exception every time an `OfficeAssignment` entity is updated.</span></span>

<span data-ttu-id="e9483-267">Abra *OfficeAssignments.aspx.CS* y agregue la siguiente instrucción `using` para la capa de acceso a datos:</span><span class="sxs-lookup"><span data-stu-id="e9483-267">Open *OfficeAssignments.aspx.cs* and add the following `using` statement for the data access layer:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample14.cs)]

<span data-ttu-id="e9483-268">Agregue el siguiente método de `Page_Init`, que habilita la funcionalidad de datos dinámicos.</span><span class="sxs-lookup"><span data-stu-id="e9483-268">Add the following `Page_Init` method, which enables Dynamic Data functionality.</span></span> <span data-ttu-id="e9483-269">Agregue también el siguiente controlador para el evento de `Updated` del control `ObjectDataSource` para comprobar los errores de simultaneidad:</span><span class="sxs-lookup"><span data-stu-id="e9483-269">Also add the following handler for the `ObjectDataSource` control's `Updated` event in order to check for concurrency errors:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample15.cs)]

### <a name="testing-optimistic-concurrency-in-the-officeassignments-page"></a><span data-ttu-id="e9483-270">Prueba de la simultaneidad optimista en la página OfficeAssignments</span><span class="sxs-lookup"><span data-stu-id="e9483-270">Testing Optimistic Concurrency in the OfficeAssignments Page</span></span>

<span data-ttu-id="e9483-271">Ejecute la página *OfficeAssignments. aspx* .</span><span class="sxs-lookup"><span data-stu-id="e9483-271">Run the *OfficeAssignments.aspx* page.</span></span>

<span data-ttu-id="e9483-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span></span>

<span data-ttu-id="e9483-273">Haga clic en **Editar** en una fila y cambie el valor en la columna **Ubicación** .</span><span class="sxs-lookup"><span data-stu-id="e9483-273">Click **Edit** in a row and change the value in the **Location** column.</span></span>

<span data-ttu-id="e9483-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span></span>

<span data-ttu-id="e9483-275">Abra una nueva ventana del explorador y vuelva a ejecutar la página (Copie la dirección URL de la primera ventana del explorador en la segunda ventana del explorador).</span><span class="sxs-lookup"><span data-stu-id="e9483-275">Open a new browser window and run the page again (copy the URL from the first browser window to the second browser window).</span></span>

<span data-ttu-id="e9483-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span></span>

<span data-ttu-id="e9483-277">Haga clic en **Editar** en la misma fila que editó anteriormente y cambie el valor de **Ubicación** a algo diferente.</span><span class="sxs-lookup"><span data-stu-id="e9483-277">Click **Edit** in the same row you edited earlier and change the **Location** value to something different.</span></span>

<span data-ttu-id="e9483-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span></span>

<span data-ttu-id="e9483-279">En la segunda ventana del explorador, haga clic en **Actualizar**.</span><span class="sxs-lookup"><span data-stu-id="e9483-279">In the second browser window, click **Update**.</span></span>

<span data-ttu-id="e9483-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span></span>

<span data-ttu-id="e9483-281">Cambie a la primera ventana del explorador y haga clic en **Actualizar**.</span><span class="sxs-lookup"><span data-stu-id="e9483-281">Switch to the first browser window and click **Update**.</span></span>

<span data-ttu-id="e9483-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span></span>

<span data-ttu-id="e9483-283">Verá un mensaje de error y el valor de **Ubicación** se ha actualizado para mostrar el valor en el que lo ha cambiado en la segunda ventana del explorador.</span><span class="sxs-lookup"><span data-stu-id="e9483-283">You see an error message and the **Location** value has been updated to show the value you changed it to in the second browser window.</span></span>

## <a name="handling-concurrency-with-the-entitydatasource-control"></a><span data-ttu-id="e9483-284">Controlar la simultaneidad con el control EntityDataSource</span><span class="sxs-lookup"><span data-stu-id="e9483-284">Handling Concurrency with the EntityDataSource Control</span></span>

<span data-ttu-id="e9483-285">El control `EntityDataSource` incluye lógica integrada que reconoce la configuración de simultaneidad en el modelo de datos y controla las operaciones de actualización y eliminación en consecuencia.</span><span class="sxs-lookup"><span data-stu-id="e9483-285">The `EntityDataSource` control includes built-in logic that recognizes the concurrency settings in the data model and handles update and delete operations accordingly.</span></span> <span data-ttu-id="e9483-286">Sin embargo, al igual que con todas las excepciones, debe controlar las excepciones de `OptimisticConcurrencyException` para proporcionar un mensaje de error descriptivo.</span><span class="sxs-lookup"><span data-stu-id="e9483-286">However, as with all exceptions, you must handle `OptimisticConcurrencyException` exceptions yourself in order to provide a user-friendly error message.</span></span>

<span data-ttu-id="e9483-287">A continuación, configurará la página *Courses. aspx* (que usa un control de `EntityDataSource`) para permitir las operaciones de actualización y eliminación y para mostrar un mensaje de error si se produce un conflicto de simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="e9483-287">Next, you will configure the *Courses.aspx* page (which uses an `EntityDataSource` control) to allow update and delete operations and to display an error message if a concurrency conflict occurs.</span></span> <span data-ttu-id="e9483-288">La entidad `Course` no tiene una columna de seguimiento de simultaneidad, por lo que usará el mismo método que hizo con la entidad `Department`: realice un seguimiento de los valores de todas las propiedades que no son de clave.</span><span class="sxs-lookup"><span data-stu-id="e9483-288">The `Course` entity doesn't have a concurrency tracking column, so you will use the same method that you did with the `Department` entity: track the values of all non-key properties.</span></span>

<span data-ttu-id="e9483-289">Abra el archivo *SchoolModel. edmx* .</span><span class="sxs-lookup"><span data-stu-id="e9483-289">Open the *SchoolModel.edmx* file.</span></span> <span data-ttu-id="e9483-290">Para las propiedades que no son de clave de la entidad `Course` (`Title`, `Credits`y `DepartmentID`), establezca la propiedad **modo de simultaneidad** en `Fixed`.</span><span class="sxs-lookup"><span data-stu-id="e9483-290">For the non-key properties of the `Course` entity (`Title`, `Credits`, and `DepartmentID`), set the **Concurrency Mode** property to `Fixed`.</span></span> <span data-ttu-id="e9483-291">A continuación, guarde y cierre el modelo de datos.</span><span class="sxs-lookup"><span data-stu-id="e9483-291">Then save and close the data model.</span></span>

<span data-ttu-id="e9483-292">Abra la página *Courses. aspx* y realice los cambios siguientes:</span><span class="sxs-lookup"><span data-stu-id="e9483-292">Open the *Courses.aspx* page and make the following changes:</span></span>

- <span data-ttu-id="e9483-293">En el control `CoursesEntityDataSource`, agregue los atributos `EnableUpdate="true"` y `EnableDelete="true"`.</span><span class="sxs-lookup"><span data-stu-id="e9483-293">In the `CoursesEntityDataSource` control, add `EnableUpdate="true"` and `EnableDelete="true"` attributes.</span></span> <span data-ttu-id="e9483-294">La etiqueta de apertura de ese control ahora es similar al ejemplo siguiente:</span><span class="sxs-lookup"><span data-stu-id="e9483-294">The opening tag for that control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample16.aspx)]
- <span data-ttu-id="e9483-295">En el control `CoursesGridView`, cambie el valor del atributo `DataKeyNames` a `"CourseID,Title,Credits,DepartmentID"`.</span><span class="sxs-lookup"><span data-stu-id="e9483-295">In the `CoursesGridView` control, change the `DataKeyNames` attribute value to `"CourseID,Title,Credits,DepartmentID"`.</span></span> <span data-ttu-id="e9483-296">A continuación, agregue un elemento `CommandField` al elemento `Columns` que muestra los botones de **edición** y **eliminación** (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span><span class="sxs-lookup"><span data-stu-id="e9483-296">Then add a `CommandField` element to the `Columns` element that shows **Edit** and **Delete** buttons (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span></span> <span data-ttu-id="e9483-297">El control `GridView` ahora es similar al ejemplo siguiente:</span><span class="sxs-lookup"><span data-stu-id="e9483-297">The `GridView` control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample17.aspx)]

<span data-ttu-id="e9483-298">Ejecute la página y cree una situación de conflicto como hizo antes en la página departamentos.</span><span class="sxs-lookup"><span data-stu-id="e9483-298">Run the page and create a conflict situation as you did before in the Departments page.</span></span> <span data-ttu-id="e9483-299">Ejecute la página en dos ventanas del explorador, haga clic en **Editar** en la misma línea en cada ventana y realice un cambio diferente en cada una de ellas.</span><span class="sxs-lookup"><span data-stu-id="e9483-299">Run the page in two browser windows, click **Edit** in the same line in each window, and make a different change in each one.</span></span> <span data-ttu-id="e9483-300">Haga clic en **Actualizar** en una ventana y, a continuación, haga clic en **Actualizar** en la otra ventana.</span><span class="sxs-lookup"><span data-stu-id="e9483-300">Click **Update** in one window and then click **Update** in the other window.</span></span> <span data-ttu-id="e9483-301">Al hacer clic en **Actualizar** la segunda vez, verá la página de error que resulta de una excepción de simultaneidad no controlada.</span><span class="sxs-lookup"><span data-stu-id="e9483-301">When you click **Update** the second time, you see the error page that results from an unhandled concurrency exception.</span></span>

<span data-ttu-id="e9483-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span></span>

<span data-ttu-id="e9483-303">Este error se controla de forma muy similar a como se controla en el control de `ObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="e9483-303">You handle this error in a manner very similar to how you handled it for the `ObjectDataSource` control.</span></span> <span data-ttu-id="e9483-304">Abra la página *Courses. aspx* y, en el control `CoursesEntityDataSource`, especifique los controladores para los eventos `Deleted` y `Updated`.</span><span class="sxs-lookup"><span data-stu-id="e9483-304">Open the *Courses.aspx* page, and in the `CoursesEntityDataSource` control, specify handlers for the `Deleted` and `Updated` events.</span></span> <span data-ttu-id="e9483-305">La etiqueta de apertura del control ahora es similar al ejemplo siguiente:</span><span class="sxs-lookup"><span data-stu-id="e9483-305">The opening tag of the control now resembles the following example:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample18.aspx)]

<span data-ttu-id="e9483-306">Antes del control `CoursesGridView`, agregue el siguiente control de `ValidationSummary`:</span><span class="sxs-lookup"><span data-stu-id="e9483-306">Before the `CoursesGridView` control, add the following `ValidationSummary` control:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample19.aspx)]

<span data-ttu-id="e9483-307">En *Courses.aspx.CS*, agregue una instrucción `using` para el espacio de nombres `System.Data`, agregue un método que compruebe las excepciones de simultaneidad y agregue Controladores para los controladores de `Updated` y `Deleted` del control `EntityDataSource`.</span><span class="sxs-lookup"><span data-stu-id="e9483-307">In *Courses.aspx.cs*, add a `using` statement for the `System.Data` namespace, add a method that checks for concurrency exceptions, and add handlers for the `EntityDataSource` control's `Updated` and `Deleted` handlers.</span></span> <span data-ttu-id="e9483-308">El código tendrá un aspecto similar al siguiente:</span><span class="sxs-lookup"><span data-stu-id="e9483-308">The code will look like the following:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample20.cs)]

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample21.cs)]

<span data-ttu-id="e9483-309">La única diferencia entre este código y lo que hizo para el control `ObjectDataSource` es que, en este caso, la excepción de simultaneidad está en la propiedad `Exception` del objeto argumentos de evento en lugar de en la propiedad `InnerException` de esa excepción.</span><span class="sxs-lookup"><span data-stu-id="e9483-309">The only difference between this code and what you did for the `ObjectDataSource` control is that in this case the concurrency exception is in the `Exception` property of the event arguments object rather than in that exception's `InnerException` property.</span></span>

<span data-ttu-id="e9483-310">Ejecute la página y vuelva a crear un conflicto de simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="e9483-310">Run the page and create a concurrency conflict again.</span></span> <span data-ttu-id="e9483-311">Esta vez aparece un mensaje de error:</span><span class="sxs-lookup"><span data-stu-id="e9483-311">This time you see an error message:</span></span>

<span data-ttu-id="e9483-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span><span class="sxs-lookup"><span data-stu-id="e9483-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span></span>

<span data-ttu-id="e9483-313">Con esto finaliza la introducción para el control de los conflictos de simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="e9483-313">This completes the introduction to handling concurrency conflicts.</span></span> <span data-ttu-id="e9483-314">En el siguiente tutorial se proporcionan instrucciones sobre cómo mejorar el rendimiento en una aplicación web que utiliza el Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="e9483-314">The next tutorial will provide guidance on how to improve performance in a web application that uses the Entity Framework.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="e9483-315">[Anterior](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
> [Siguiente](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span><span class="sxs-lookup"><span data-stu-id="e9483-315">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
[Next](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span></span>
