---
uid: web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
title: Ajustar las modificaciones de base de datosC#dentro de una transacción () | Microsoft Docs
author: rick-anderson
description: Este tutorial es el primero de cuatro que examina la actualización, eliminación e inserción de lotes de datos. En este tutorial se explica cómo permiten las transacciones de base de datos...
ms.author: riande
ms.date: 06/26/2007
ms.assetid: b45fede3-c53a-4ea1-824b-20200808dbae
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
msc.type: authoredcontent
ms.openlocfilehash: da69e466a5b506b869dc8fc0624f3e6a479199a8
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 11/28/2019
ms.locfileid: "74624694"
---
# <a name="wrapping-database-modifications-within-a-transaction-c"></a><span data-ttu-id="3281b-104">Ajustar las modificaciones de base de datos dentro de una transacción (C#)</span><span class="sxs-lookup"><span data-stu-id="3281b-104">Wrapping Database Modifications within a Transaction (C#)</span></span>

<span data-ttu-id="3281b-105">por [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="3281b-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="3281b-106">[Descargar código](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) o [Descargar PDF](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="3281b-106">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) or [Download PDF](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span></span>

> <span data-ttu-id="3281b-107">Este tutorial es el primero de cuatro que examina la actualización, eliminación e inserción de lotes de datos.</span><span class="sxs-lookup"><span data-stu-id="3281b-107">This tutorial is the first of four that looks at updating, deleting, and inserting batches of data.</span></span> <span data-ttu-id="3281b-108">En este tutorial, aprenderá cómo las transacciones de base de datos permiten realizar modificaciones de lotes como una operación atómica, lo que garantiza que todos los pasos se realizan correctamente o que se produce un error en todos los pasos.</span><span class="sxs-lookup"><span data-stu-id="3281b-108">In this tutorial we learn how database transactions allow batch modifications to be carried out as an atomic operation, which ensures that either all steps succeed or all steps fail.</span></span>

## <a name="introduction"></a><span data-ttu-id="3281b-109">Introducción</span><span class="sxs-lookup"><span data-stu-id="3281b-109">Introduction</span></span>

<span data-ttu-id="3281b-110">Como vimos a partir de la [información general sobre la inserción, actualización y eliminación de tutoriales de datos](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) , GridView proporciona compatibilidad integrada para la edición y eliminación de filas.</span><span class="sxs-lookup"><span data-stu-id="3281b-110">As we saw starting with the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) tutorial, the GridView provides built-in support for row-level editing and deleting.</span></span> <span data-ttu-id="3281b-111">Con unos pocos clics del mouse, es posible crear una interfaz de modificación de datos enriquecida sin escribir una línea de código, siempre y cuando el contenido se modifique y se elimine por fila.</span><span class="sxs-lookup"><span data-stu-id="3281b-111">With a few clicks of the mouse it is possible to create a rich data modification interface without writing a line of code, so long as you are content with editing and deleting on a per-row basis.</span></span> <span data-ttu-id="3281b-112">Sin embargo, en ciertos escenarios esto no es suficiente y es necesario proporcionar a los usuarios la capacidad de editar o eliminar un lote de registros.</span><span class="sxs-lookup"><span data-stu-id="3281b-112">However, in certain scenarios this is insufficient and we need to provide users with the ability to edit or delete a batch of records.</span></span>

<span data-ttu-id="3281b-113">Por ejemplo, la mayoría de los clientes de correo electrónico basados en web usan una cuadrícula para mostrar cada mensaje en el que cada fila incluye una casilla junto con la información de correo electrónico (asunto, remitente, etc.).</span><span class="sxs-lookup"><span data-stu-id="3281b-113">For example, most web-based email clients use a grid to list each message where each row includes a checkbox along with the email s information (subject, sender, and so forth).</span></span> <span data-ttu-id="3281b-114">Esta interfaz permite al usuario eliminar varios mensajes mediante su comprobación y, a continuación, hacer clic en el botón Eliminar mensajes seleccionados.</span><span class="sxs-lookup"><span data-stu-id="3281b-114">This interface permits the user to delete multiple messages by checking them and then clicking a Delete Selected Messages button.</span></span> <span data-ttu-id="3281b-115">Una interfaz de edición de lotes es ideal en situaciones en las que los usuarios suelen editar muchos registros diferentes.</span><span class="sxs-lookup"><span data-stu-id="3281b-115">A batch editing interface is ideal in situations where users commonly edit many different records.</span></span> <span data-ttu-id="3281b-116">En lugar de forzar al usuario a hacer clic en editar, realizar el cambio y, a continuación, hacer clic en actualizar para cada registro que deba modificarse, una interfaz de edición por lotes representa cada fila con su interfaz de edición.</span><span class="sxs-lookup"><span data-stu-id="3281b-116">Rather than forcing the user to click Edit, make their change, and then click Update for each record that needs to be modified, a batch editing interface renders each row with its editing interface.</span></span> <span data-ttu-id="3281b-117">El usuario puede modificar rápidamente el conjunto de filas que se deben cambiar y, a continuación, guardar estos cambios haciendo clic en el botón Actualizar todo.</span><span class="sxs-lookup"><span data-stu-id="3281b-117">The user can quickly modify the set of rows that need to be changed and then save these changes by clicking an Update All button.</span></span> <span data-ttu-id="3281b-118">En este conjunto de tutoriales, examinaremos cómo crear interfaces para insertar, editar y eliminar lotes de datos.</span><span class="sxs-lookup"><span data-stu-id="3281b-118">In this set of tutorials we'll examine how to create interfaces for inserting, editing, and deleting batches of data.</span></span>

<span data-ttu-id="3281b-119">Al realizar operaciones por lotes, es importante determinar si es posible que algunas de las operaciones del lote se realicen correctamente mientras se producen errores en otros.</span><span class="sxs-lookup"><span data-stu-id="3281b-119">When performing batch operations it s important to determine whether it should be possible for some of the operations in the batch to succeed while others fail.</span></span> <span data-ttu-id="3281b-120">Considere la posibilidad de usar una interfaz de eliminación de lotes: ¿Qué ocurrirá si el primer registro seleccionado se elimina correctamente, pero se produce un error en el segundo, por ejemplo, debido a una infracción de restricción de clave externa?</span><span class="sxs-lookup"><span data-stu-id="3281b-120">Consider a batch deleting interface - what should happen if the first selected record is deleted successfully, but the second one fails, say, because of a foreign key constraint violation?</span></span> <span data-ttu-id="3281b-121">¿Se debe revertir la eliminación del primer registro o es aceptable que el primer registro permanezca eliminado?</span><span class="sxs-lookup"><span data-stu-id="3281b-121">Should the first record s delete be rolled back or is it acceptable for the first record to remain deleted?</span></span>

<span data-ttu-id="3281b-122">Si desea que la operación por lotes se trate como una [operación atómica](http://en.wikipedia.org/wiki/Atomic_operation), una en la que todos los pasos se realicen correctamente o se produzca un error en todos los pasos, la capa de acceso a datos debe aumentarse para incluir la compatibilidad con [las transacciones de base](http://en.wikipedia.org/wiki/Database_transaction)de datos.</span><span class="sxs-lookup"><span data-stu-id="3281b-122">If you want the batch operation to be treated as an [atomic operation](http://en.wikipedia.org/wiki/Atomic_operation), one where either all of the steps succeed or all of the steps fail, then the Data Access Layer needs to be augmented to include support for [database transactions](http://en.wikipedia.org/wiki/Database_transaction).</span></span> <span data-ttu-id="3281b-123">Las transacciones de base de datos garantizan la atomicidad para el conjunto de instrucciones `INSERT`, `UPDATE`y `DELETE` que se ejecutan bajo el paraguas de la transacción y son una característica admitida por la mayoría de los sistemas de bases de datos modernos.</span><span class="sxs-lookup"><span data-stu-id="3281b-123">Database transactions guarantee atomicity for the set of `INSERT`, `UPDATE`, and `DELETE` statements executed under the umbrella of the transaction and are a feature supported by most all modern database systems.</span></span>

<span data-ttu-id="3281b-124">En este tutorial veremos cómo extender la capa DAL para usar transacciones de base de datos.</span><span class="sxs-lookup"><span data-stu-id="3281b-124">In this tutorial we'll look at how to extend the DAL to use database transactions.</span></span> <span data-ttu-id="3281b-125">En los tutoriales siguientes se examinará la implementación de páginas web para las interfaces de inserción, actualización y eliminación de lotes.</span><span class="sxs-lookup"><span data-stu-id="3281b-125">Subsequent tutorials will examine implementing web pages for batch inserting, updating, and deleting interfaces.</span></span> <span data-ttu-id="3281b-126">Vamos a empezar a trabajar.</span><span class="sxs-lookup"><span data-stu-id="3281b-126">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="3281b-127">Cuando se modifican datos en una transacción por lotes, no siempre se necesita atomicidad.</span><span class="sxs-lookup"><span data-stu-id="3281b-127">When modifying data in a batch transaction, atomicity is not always needed.</span></span> <span data-ttu-id="3281b-128">En algunos escenarios, puede ser aceptable tener algunas modificaciones de datos correctas y otras en el mismo lote producen un error, como cuando se elimina un conjunto de correos electrónicos de un cliente de correo electrónico basado en Web.</span><span class="sxs-lookup"><span data-stu-id="3281b-128">In some scenarios, it may be acceptable to have some data modifications succeed and others in the same batch fail, such as when deleting a set of emails from a web-based email client.</span></span> <span data-ttu-id="3281b-129">Si se produce un error de base de datos a la mitad del proceso de eliminación, es probable que no se eliminen los registros procesados sin errores.</span><span class="sxs-lookup"><span data-stu-id="3281b-129">If there s a database error midway through the deletion process, it s probably acceptable that those records processed without error remain deleted.</span></span> <span data-ttu-id="3281b-130">En tales casos, no es necesario modificar la capa DAL para admitir transacciones de base de datos.</span><span class="sxs-lookup"><span data-stu-id="3281b-130">In such cases, the DAL does not need to be modified to support database transactions.</span></span> <span data-ttu-id="3281b-131">Sin embargo, hay otros escenarios de operaciones por lotes en los que la atomicidad es fundamental.</span><span class="sxs-lookup"><span data-stu-id="3281b-131">There are other batch operation scenarios, however, where atomicity is vital.</span></span> <span data-ttu-id="3281b-132">Cuando un cliente mueve sus fondos de una cuenta bancaria a otra, se deben realizar dos operaciones: los fondos se deben deducir de la primera cuenta y agregarse después al segundo.</span><span class="sxs-lookup"><span data-stu-id="3281b-132">When a customer moves her funds from one bank account to another, two operations must be performed: the funds must be deducted from the first account and then added to the second.</span></span> <span data-ttu-id="3281b-133">Aunque es posible que el Banco no tenga en cuenta que el primer paso se realiza correctamente, pero se produce un error en el segundo paso, los clientes podrían interferir.</span><span class="sxs-lookup"><span data-stu-id="3281b-133">While the bank may not mind having the first step succeed but the second step fail, its customers would understandably be upset.</span></span> <span data-ttu-id="3281b-134">Le recomiendo que siga este tutorial e implemente las mejoras en la capa DAL para admitir transacciones de base de datos, incluso si no tiene previsto usarlas en las interfaces de inserción, actualización y eliminación de Batch que se van a crear en los tres tutoriales siguientes.</span><span class="sxs-lookup"><span data-stu-id="3281b-134">I encourage you to work through this tutorial and implement the enhancements to the DAL to support database transactions even if you do not plan on using them in the batch inserting, updating, and deleting interfaces we'll be building in the following three tutorials.</span></span>

## <a name="an-overview-of-transactions"></a><span data-ttu-id="3281b-135">Información general sobre transacciones</span><span class="sxs-lookup"><span data-stu-id="3281b-135">An Overview of Transactions</span></span>

<span data-ttu-id="3281b-136">La mayoría de las bases de datos son compatibles con *las transacciones*, que permiten agrupar varios comandos de base de datos en una única unidad lógica de trabajo.</span><span class="sxs-lookup"><span data-stu-id="3281b-136">Most databases include support for *transactions*, which enable multiple database commands to be grouped into a single logical unit of work.</span></span> <span data-ttu-id="3281b-137">Se garantiza que los comandos de base de datos que componen una transacción son atómicos, lo que significa que se producirá un error en todos los comandos o todos se realizarán correctamente.</span><span class="sxs-lookup"><span data-stu-id="3281b-137">The database commands that comprise a transaction are guaranteed to be atomic, meaning that either all commands will fail or all will succeed.</span></span>

<span data-ttu-id="3281b-138">En general, las transacciones se implementan a través de instrucciones SQL con el siguiente patrón:</span><span class="sxs-lookup"><span data-stu-id="3281b-138">In general, transactions are implemented through SQL statements using the following pattern:</span></span>

1. <span data-ttu-id="3281b-139">Indica el inicio de una transacción.</span><span class="sxs-lookup"><span data-stu-id="3281b-139">Indicate the start of a transaction.</span></span>
2. <span data-ttu-id="3281b-140">Ejecutar las instrucciones SQL que componen la transacción.</span><span class="sxs-lookup"><span data-stu-id="3281b-140">Execute the SQL statements that comprise the transaction.</span></span>
3. <span data-ttu-id="3281b-141">Si hay un error en una de las instrucciones del paso 2, revierta la transacción.</span><span class="sxs-lookup"><span data-stu-id="3281b-141">If there is an error in one of the statements from Step 2, rollback the transaction.</span></span>
4. <span data-ttu-id="3281b-142">Si todas las instrucciones del paso 2 se completan sin errores, confirme la transacción.</span><span class="sxs-lookup"><span data-stu-id="3281b-142">If all of the statements from Step 2 complete without error, commit the transaction.</span></span>

<span data-ttu-id="3281b-143">Las instrucciones SQL utilizadas para crear, confirmar y revertir la transacción se pueden escribir manualmente al escribir scripts SQL o crear procedimientos almacenados, o mediante programación, mediante ADO.NET o las clases del espacio de [nombres`System.Transactions`](https://msdn.microsoft.com/library/system.transactions.aspx).</span><span class="sxs-lookup"><span data-stu-id="3281b-143">The SQL statements used to create, commit, and roll back the transaction can be entered manually when writing SQL scripts or creating stored procedures, or through programmatic means using either ADO.NET or the classes in the [`System.Transactions` namespace](https://msdn.microsoft.com/library/system.transactions.aspx).</span></span> <span data-ttu-id="3281b-144">En este tutorial solo se examinará la administración de transacciones mediante ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="3281b-144">In this tutorial we will only examine managing transactions using ADO.NET.</span></span> <span data-ttu-id="3281b-145">En un futuro tutorial, veremos cómo usar los procedimientos almacenados en el nivel de acceso a datos, en cuyo momento exploraremos las instrucciones SQL para crear, revertir y confirmar transacciones.</span><span class="sxs-lookup"><span data-stu-id="3281b-145">In a future tutorial we will look at how to use stored procedures in the Data Access Layer, at which time we'll explore the SQL statements for creating, rolling back, and committing transactions.</span></span> <span data-ttu-id="3281b-146">Mientras tanto, consulte [Administración de transacciones en SQL Server procedimientos almacenados](http://www.4guysfromrolla.com/webtech/080305-1.shtml) para obtener más información.</span><span class="sxs-lookup"><span data-stu-id="3281b-146">In the meantime, consult [Managing Transactions in SQL Server Stored Procedures](http://www.4guysfromrolla.com/webtech/080305-1.shtml) for more information.</span></span>

> [!NOTE]
> <span data-ttu-id="3281b-147">La [clase`TransactionScope`](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) del espacio de nombres `System.Transactions` permite a los programadores encapsular mediante programación una serie de instrucciones en el ámbito de una transacción e incluye compatibilidad con transacciones complejas que implican varios orígenes, como dos bases de datos diferentes o incluso tipos heterogéneos de almacenes de datos, como una base de datos de Microsoft SQL Server, una base de datos de Oracle y un servicio Web.</span><span class="sxs-lookup"><span data-stu-id="3281b-147">The [`TransactionScope` class](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) in the `System.Transactions` namespace enables developers to programmatically wrap a series of statements within the scope of a transaction and includes support for complex transactions that involve multiple sources, such as two different databases or even heterogeneous types of data stores, such as a Microsoft SQL Server database, an Oracle database, and a Web service.</span></span> <span data-ttu-id="3281b-148">He decidido usar las transacciones de ADO.NET para este tutorial en lugar de la clase `TransactionScope` porque ADO.NET es más específico para las transacciones de base de datos y, en muchos casos, es mucho menos intensivo de recursos.</span><span class="sxs-lookup"><span data-stu-id="3281b-148">I ve decided to use ADO.NET transactions for this tutorial instead of the `TransactionScope` class because ADO.NET is more specific for database transactions and, in many cases, is far less resource intensive.</span></span> <span data-ttu-id="3281b-149">Además, en ciertos escenarios, la clase `TransactionScope` usa el Coordinador de transacciones distribuidas de Microsoft (MSDTC).</span><span class="sxs-lookup"><span data-stu-id="3281b-149">In addition, under certain scenarios the `TransactionScope` class uses the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="3281b-150">Los problemas de configuración, implementación y rendimiento relacionados con MSDTC lo convierten en un tema bastante especializado y avanzado y más allá del ámbito de estos tutoriales.</span><span class="sxs-lookup"><span data-stu-id="3281b-150">The configuration, implementation, and performance issues surrounding MSDTC makes it a rather specialized and advanced topic and beyond the scope of these tutorials.</span></span>

<span data-ttu-id="3281b-151">Cuando se trabaja con el proveedor SqlClient en ADO.NET, las transacciones se inician a través de una llamada al método [`SqlConnection` Class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction`](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), que devuelve un [objeto`SqlTransaction`](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span><span class="sxs-lookup"><span data-stu-id="3281b-151">When working with the SqlClient provider in ADO.NET, transactions are initiated through a call to the [`SqlConnection` class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), which returns a [`SqlTransaction` object](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span></span> <span data-ttu-id="3281b-152">Las instrucciones de modificación de datos que estructuran la transacción se colocan dentro de un bloque `try...catch`.</span><span class="sxs-lookup"><span data-stu-id="3281b-152">The data modification statements that makeup the transaction are placed within a `try...catch` block.</span></span> <span data-ttu-id="3281b-153">Si se produce un error en una instrucción del bloque `try`, la ejecución se transfiere al bloque `catch` en el que se puede revertir la transacción a través del método `SqlTransaction` Object s [`Rollback`](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span><span class="sxs-lookup"><span data-stu-id="3281b-153">If an error occurs in a statement in the `try` block, execution transfers to the `catch` block where the transaction can be rolled back via the `SqlTransaction` object s [`Rollback` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span></span> <span data-ttu-id="3281b-154">Si todas las instrucciones se completan correctamente, una llamada al método `SqlTransaction` Object s [`Commit`](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) al final del bloque `try` confirma la transacción.</span><span class="sxs-lookup"><span data-stu-id="3281b-154">If all of the statements complete successfully, a call to the `SqlTransaction` object s [`Commit` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) at the end of the `try` block commits the transaction.</span></span> <span data-ttu-id="3281b-155">En el fragmento de código siguiente se muestra este patrón.</span><span class="sxs-lookup"><span data-stu-id="3281b-155">The following code snippet illustrates this pattern.</span></span> <span data-ttu-id="3281b-156">Consulte mantenimiento de la coherencia de la [base de datos con transacciones](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) para obtener más sintaxis y ejemplos del uso de transacciones con ADO.net.</span><span class="sxs-lookup"><span data-stu-id="3281b-156">See [Maintaining Database Consistency with Transactions](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) for additional syntax and examples of using transactions with ADO.NET.</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample1.cs)]

<span data-ttu-id="3281b-157">De forma predeterminada, los TableAdapters de un conjunto de un DataSet con tipo no usan transacciones.</span><span class="sxs-lookup"><span data-stu-id="3281b-157">By default, the TableAdapters in a Typed DataSet do not use transactions.</span></span> <span data-ttu-id="3281b-158">Para proporcionar compatibilidad con las transacciones, necesitamos aumentar las clases de TableAdapter para incluir métodos adicionales que usan el patrón anterior para realizar una serie de instrucciones de modificación de datos dentro del ámbito de una transacción.</span><span class="sxs-lookup"><span data-stu-id="3281b-158">To provide support for transactions we need to augment the TableAdapter classes to include additional methods that use the above pattern to perform a series of data modification statements within the scope of a transaction.</span></span> <span data-ttu-id="3281b-159">En el paso 2 veremos cómo usar las clases parciales para agregar estos métodos.</span><span class="sxs-lookup"><span data-stu-id="3281b-159">In Step 2 we'll see how to use partial classes to add these methods.</span></span>

## <a name="step-1-creating-the-working-with-batched-data-web-pages"></a><span data-ttu-id="3281b-160">Paso 1: crear páginas web de trabajo con datos por lotes</span><span class="sxs-lookup"><span data-stu-id="3281b-160">Step 1: Creating the Working with Batched Data Web Pages</span></span>

<span data-ttu-id="3281b-161">Antes de empezar a explorar cómo aumentar la capa DAL para admitir las transacciones de base de datos, deje que primero dedique un momento a crear las páginas web de ASP.NET que necesitamos para este tutorial y las tres siguientes.</span><span class="sxs-lookup"><span data-stu-id="3281b-161">Before we start exploring how to augment the DAL to support database transactions, let s first take a moment to create the ASP.NET web pages that we will need for this tutorial and the three that follow.</span></span> <span data-ttu-id="3281b-162">Comience agregando una nueva carpeta denominada `BatchData` y, a continuación, agregue las siguientes páginas de ASP.NET, asociando cada página con la página maestra de `Site.master`.</span><span class="sxs-lookup"><span data-stu-id="3281b-162">Start by adding a new folder named `BatchData` and then add the following ASP.NET pages, associating each page with the `Site.master` master page.</span></span>

- `Default.aspx`
- `Transactions.aspx`
- `BatchUpdate.aspx`
- `BatchDelete.aspx`
- `BatchInsert.aspx`

![Agregue las páginas ASP.NET para los tutoriales relacionados con SqlDataSource](wrapping-database-modifications-within-a-transaction-cs/_static/image1.gif)

<span data-ttu-id="3281b-164">**Figura 1**: agregar las páginas ASP.net para los tutoriales relacionados con SqlDataSource</span><span class="sxs-lookup"><span data-stu-id="3281b-164">**Figure 1**: Add the ASP.NET Pages for the SqlDataSource-Related Tutorials</span></span>

<span data-ttu-id="3281b-165">Al igual que con las demás carpetas, `Default.aspx` utilizará el control de usuario `SectionLevelTutorialListing.ascx` para enumerar los tutoriales de la sección.</span><span class="sxs-lookup"><span data-stu-id="3281b-165">As with the other folders, `Default.aspx` will use the `SectionLevelTutorialListing.ascx` User Control to list the tutorials within its section.</span></span> <span data-ttu-id="3281b-166">Por lo tanto, agregue este control de usuario a `Default.aspx` arrastrándolo desde el Explorador de soluciones hasta la página s Vista de diseño.</span><span class="sxs-lookup"><span data-stu-id="3281b-166">Therefore, add this User Control to `Default.aspx` by dragging it from the Solution Explorer onto the page s Design view.</span></span>

<span data-ttu-id="3281b-167">[![agregar el control de usuario SectionLevelTutorialListing. ascx a default. aspx](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="3281b-167">[![Add the SectionLevelTutorialListing.ascx User Control to Default.aspx](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span></span>

<span data-ttu-id="3281b-168">**Figura 2**: agregar el control de usuario `SectionLevelTutorialListing.ascx` a `Default.aspx` ([haga clic para ver la imagen de tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="3281b-168">**Figure 2**: Add the `SectionLevelTutorialListing.ascx` User Control to `Default.aspx` ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span></span>

<span data-ttu-id="3281b-169">Por último, agregue estas cuatro páginas como entradas al archivo `Web.sitemap`.</span><span class="sxs-lookup"><span data-stu-id="3281b-169">Lastly, add these four pages as entries to the `Web.sitemap` file.</span></span> <span data-ttu-id="3281b-170">En concreto, agregue el siguiente marcado después de la personalización del mapa del sitio `<siteMapNode>`:</span><span class="sxs-lookup"><span data-stu-id="3281b-170">Specifically, add the following markup after the Customizing the Site Map `<siteMapNode>`:</span></span>

[!code-xml[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample2.xml)]

<span data-ttu-id="3281b-171">Después de actualizar `Web.sitemap`, dedique un momento a ver el sitio web de tutoriales a través de un explorador.</span><span class="sxs-lookup"><span data-stu-id="3281b-171">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="3281b-172">El menú de la izquierda incluye ahora los elementos para trabajar con tutoriales de datos por lotes.</span><span class="sxs-lookup"><span data-stu-id="3281b-172">The menu on the left now includes items for the working with batched data tutorials.</span></span>

![El mapa del sitio ahora incluye entradas para los tutoriales sobre cómo trabajar con datos por lotes](wrapping-database-modifications-within-a-transaction-cs/_static/image3.gif)

<span data-ttu-id="3281b-174">**Figura 3**: ahora, el mapa del sitio incluye entradas para los tutoriales sobre cómo trabajar con datos por lotes</span><span class="sxs-lookup"><span data-stu-id="3281b-174">**Figure 3**: The Site Map Now Includes Entries for the Working with Batched Data Tutorials</span></span>

## <a name="step-2-updating-the-data-access-layer-to-support-database-transactions"></a><span data-ttu-id="3281b-175">Paso 2: actualización de la capa de acceso a datos para admitir transacciones de base de datos</span><span class="sxs-lookup"><span data-stu-id="3281b-175">Step 2: Updating the Data Access Layer to Support Database Transactions</span></span>

<span data-ttu-id="3281b-176">Como hemos comentado en el primer tutorial, la [creación de una capa de acceso a datos](../introduction/creating-a-data-access-layer-cs.md), el conjunto de datos con tipo de la capa Dal se compone de objetos DataTable y TableAdapters.</span><span class="sxs-lookup"><span data-stu-id="3281b-176">As we discussed back in the first tutorial, [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md), the Typed DataSet in our DAL is composed of DataTables and TableAdapters.</span></span> <span data-ttu-id="3281b-177">Los objetos DataTable contienen datos mientras que los TableAdapters proporcionan la funcionalidad para leer los datos de la base de datos en las DataTables, actualizar la base de datos con los cambios realizados en los objetos DataTable, etc.</span><span class="sxs-lookup"><span data-stu-id="3281b-177">The DataTables hold data while the TableAdapters provide the functionality to read data from the database into the DataTables, to update the database with changes made to the DataTables, and so forth.</span></span> <span data-ttu-id="3281b-178">Recuerde que los TableAdapters proporcionan dos patrones para actualizar los datos, a los que se hace referencia como actualización por lotes y DB-Direct.</span><span class="sxs-lookup"><span data-stu-id="3281b-178">Recall that the TableAdapters provide two patterns for updating data, which I referred to as Batch Update and DB-Direct.</span></span> <span data-ttu-id="3281b-179">Con el patrón de actualización por lotes, el TableAdapter pasa un DataSet, DataTable o colección de DataRows.</span><span class="sxs-lookup"><span data-stu-id="3281b-179">With the Batch Update pattern, the TableAdapter is passed a DataSet, DataTable, or collection of DataRows.</span></span> <span data-ttu-id="3281b-180">Estos datos se enumeran y, para cada fila insertada, modificada o eliminada, se ejecutan los `InsertCommand`, `UpdateCommand`o `DeleteCommand`.</span><span class="sxs-lookup"><span data-stu-id="3281b-180">This data is enumerated and for each inserted, modified, or deleted row, the `InsertCommand`, `UpdateCommand`, or `DeleteCommand` is executed.</span></span> <span data-ttu-id="3281b-181">Con el patrón DB-Direct, el TableAdapter pasa en su lugar los valores de las columnas necesarias para insertar, actualizar o eliminar un solo registro.</span><span class="sxs-lookup"><span data-stu-id="3281b-181">With the DB-Direct pattern, the TableAdapter is instead passed the values of the columns necessary for inserting, updating, or deleting a single record.</span></span> <span data-ttu-id="3281b-182">A continuación, el método de modelo directo DB utiliza esos valores pasados para ejecutar la instrucción `InsertCommand`, `UpdateCommand`o `DeleteCommand` adecuada.</span><span class="sxs-lookup"><span data-stu-id="3281b-182">The DB Direct pattern method then uses those passed-in values to execute the appropriate `InsertCommand`, `UpdateCommand`, or `DeleteCommand` statement.</span></span>

<span data-ttu-id="3281b-183">Independientemente del patrón de actualización utilizado, los métodos generados automáticamente por TableAdapters no usan transacciones.</span><span class="sxs-lookup"><span data-stu-id="3281b-183">Regardless of the update pattern used, the TableAdapters auto-generated methods do not use transactions.</span></span> <span data-ttu-id="3281b-184">De forma predeterminada, las operaciones de inserción, actualización o eliminación realizadas por el TableAdapter se tratan como una única operación discreta.</span><span class="sxs-lookup"><span data-stu-id="3281b-184">By default each insert, update, or delete performed by the TableAdapter is treated as a single discrete operation.</span></span> <span data-ttu-id="3281b-185">Por ejemplo, Imagine que el modelo de DB-Direct es utilizado por algún código de la capa BLL para insertar diez registros en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="3281b-185">For instance, imagine that the DB-Direct pattern is used by some code in the BLL to insert ten records into the database.</span></span> <span data-ttu-id="3281b-186">Este código llamaría al método `Insert` TableAdapter s diez veces.</span><span class="sxs-lookup"><span data-stu-id="3281b-186">This code would call the TableAdapter s `Insert` method ten times.</span></span> <span data-ttu-id="3281b-187">Si las primeras cinco inserciones se realizan correctamente, pero la sexta produjo una excepción, los cinco primeros registros insertados permanecerían en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="3281b-187">If the first five inserts succeed, but the sixth one resulted in an exception, the first five inserted records would remain in the database.</span></span> <span data-ttu-id="3281b-188">Del mismo modo, si se usa el patrón de actualización por lotes para realizar inserciones, actualizaciones y eliminaciones en las filas insertadas, modificadas y eliminadas en un objeto DataTable, si las primeras modificaciones se han realizado correctamente pero una posterior ha encontrado un error, esas modificaciones anteriores Completed permanece en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="3281b-188">Similarly, if the Batch Update pattern is used to perform inserts, updates, and deletes to the inserted, modified, and deleted rows in a DataTable, if the first several modifications succeeded but a later one encountered an error, those earlier modifications that completed would remain in the database.</span></span>

<span data-ttu-id="3281b-189">En ciertos escenarios queremos asegurar la atomicidad en una serie de modificaciones.</span><span class="sxs-lookup"><span data-stu-id="3281b-189">In certain scenarios we want to ensure atomicity across a series of modifications.</span></span> <span data-ttu-id="3281b-190">Para lograr esto, debemos extender manualmente el TableAdapter agregando nuevos métodos que ejecuten los `InsertCommand`, `UpdateCommand`y `DeleteCommand` s bajo el Paragua de una transacción.</span><span class="sxs-lookup"><span data-stu-id="3281b-190">To accomplish this we must manually extend the TableAdapter by adding new methods that execute the `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s under the umbrella of a transaction.</span></span> <span data-ttu-id="3281b-191">Al [crear una capa de acceso a datos](../introduction/creating-a-data-access-layer-cs.md) , analizamos el uso de [clases parciales](http://en.wikipedia.org/wiki/Partial_type) para extender la funcionalidad de las tablas de datos en el conjunto de datos con tipo.</span><span class="sxs-lookup"><span data-stu-id="3281b-191">In [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) we looked at using [partial classes](http://en.wikipedia.org/wiki/Partial_type) to extend the functionality of the DataTables within the Typed DataSet.</span></span> <span data-ttu-id="3281b-192">Esta técnica también se puede utilizar con TableAdapters.</span><span class="sxs-lookup"><span data-stu-id="3281b-192">This technique can also be used with TableAdapters.</span></span>

<span data-ttu-id="3281b-193">El `Northwind.xsd` del conjunto de elementos con tipo se encuentra en la subcarpeta `App_Code` de `DAL` carpeta.</span><span class="sxs-lookup"><span data-stu-id="3281b-193">The Typed DataSet `Northwind.xsd` is located in the `App_Code` folder s `DAL` subfolder.</span></span> <span data-ttu-id="3281b-194">Cree una subcarpeta en la carpeta `DAL` denominada `TransactionSupport` y agregue un nuevo archivo de clase denominado `ProductsTableAdapter.TransactionSupport.cs` (consulte la figura 4).</span><span class="sxs-lookup"><span data-stu-id="3281b-194">Create a subfolder in the `DAL` folder named `TransactionSupport` and add a new class file named `ProductsTableAdapter.TransactionSupport.cs` (see Figure 4).</span></span> <span data-ttu-id="3281b-195">Este archivo contendrá la implementación parcial de la `ProductsTableAdapter` que incluye métodos para realizar modificaciones de datos mediante una transacción.</span><span class="sxs-lookup"><span data-stu-id="3281b-195">This file will hold the partial implementation of the `ProductsTableAdapter` that includes methods for performing data modifications using a transaction.</span></span>

![Agregue una carpeta denominada TransactionSupport y un archivo de clase denominado ProductsTableAdapter.TransactionSupport.cs](wrapping-database-modifications-within-a-transaction-cs/_static/image4.gif)

<span data-ttu-id="3281b-197">**Figura 4**: agregue una carpeta denominada `TransactionSupport` y un archivo de clase denominado `ProductsTableAdapter.TransactionSupport.cs`</span><span class="sxs-lookup"><span data-stu-id="3281b-197">**Figure 4**: Add a Folder Named `TransactionSupport` and a Class File Named `ProductsTableAdapter.TransactionSupport.cs`</span></span>

<span data-ttu-id="3281b-198">Escriba el siguiente código en el archivo de `ProductsTableAdapter.TransactionSupport.cs`:</span><span class="sxs-lookup"><span data-stu-id="3281b-198">Enter the following code into the `ProductsTableAdapter.TransactionSupport.cs` file:</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample3.cs)]

<span data-ttu-id="3281b-199">La palabra clave `partial` en la declaración de clase aquí indica al compilador que los miembros agregados en se van a agregar a la clase `ProductsTableAdapter` en el espacio de nombres `NorthwindTableAdapters`.</span><span class="sxs-lookup"><span data-stu-id="3281b-199">The `partial` keyword in the class declaration here indicates to the compiler that the members added within are to be added to the `ProductsTableAdapter` class in the `NorthwindTableAdapters` namespace.</span></span> <span data-ttu-id="3281b-200">Observe la instrucción `using System.Data.SqlClient` en la parte superior del archivo.</span><span class="sxs-lookup"><span data-stu-id="3281b-200">Note the `using System.Data.SqlClient` statement at the top of the file.</span></span> <span data-ttu-id="3281b-201">Puesto que el TableAdapter se configuró para usar el proveedor SqlClient, utiliza internamente un objeto [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) para emitir sus comandos a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="3281b-201">Since the TableAdapter was configured to use the SqlClient provider, internally it uses a [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) object to issue its commands to the database.</span></span> <span data-ttu-id="3281b-202">Por lo tanto, es necesario usar la clase `SqlTransaction` para iniciar la transacción y, a continuación, confirmarla o revertirla.</span><span class="sxs-lookup"><span data-stu-id="3281b-202">Consequently, we need to use the `SqlTransaction` class to begin the transaction and then to commit it or roll it back.</span></span> <span data-ttu-id="3281b-203">Si usa un almacén de datos distinto de Microsoft SQL Server, deberá usar el proveedor adecuado.</span><span class="sxs-lookup"><span data-stu-id="3281b-203">If you are using a data store other than Microsoft SQL Server, you'll need to use the appropriate provider.</span></span>

<span data-ttu-id="3281b-204">Estos métodos proporcionan los bloques de creación necesarios para iniciar, revertir y confirmar una transacción.</span><span class="sxs-lookup"><span data-stu-id="3281b-204">These methods provide the building blocks needed to start, rollback, and commit a transaction.</span></span> <span data-ttu-id="3281b-205">Se marcan `public`, lo que les permite usarse desde el `ProductsTableAdapter`, desde otra clase de la capa DAL o desde otra capa de la arquitectura, como la capa BLL.</span><span class="sxs-lookup"><span data-stu-id="3281b-205">They are marked `public`, enabling them to be used from within the `ProductsTableAdapter`, from another class in the DAL, or from another layer in the architecture, such as the BLL.</span></span> <span data-ttu-id="3281b-206">`BeginTransaction` abre el `SqlConnection` interno de TableAdapter (si es necesario), comienza la transacción y la asigna a la propiedad `Transaction` y adjunta la transacción a los objetos de `SqlCommand` de `SqlDataAdapter` s internos.</span><span class="sxs-lookup"><span data-stu-id="3281b-206">`BeginTransaction` opens the TableAdapter s internal `SqlConnection` (if needed), begins the transaction and assigns it to the `Transaction` property, and attaches the transaction to the internal `SqlDataAdapter` s `SqlCommand` objects.</span></span> <span data-ttu-id="3281b-207">`CommitTransaction` y `RollbackTransaction` llamar a los métodos `Commit` y `Rollback` del objeto `Transaction`, respectivamente, antes de cerrar el objeto `Connection` interno.</span><span class="sxs-lookup"><span data-stu-id="3281b-207">`CommitTransaction` and `RollbackTransaction` call the `Transaction` object s `Commit` and `Rollback` methods, respectively, before closing the internal `Connection` object.</span></span>

## <a name="step-3-adding-methods-to-update-and-delete-data-under-the-umbrella-of-a-transaction"></a><span data-ttu-id="3281b-208">Paso 3: agregar métodos para actualizar y eliminar datos bajo el paraguas de una transacción</span><span class="sxs-lookup"><span data-stu-id="3281b-208">Step 3: Adding Methods to Update and Delete Data Under the Umbrella of a Transaction</span></span>

<span data-ttu-id="3281b-209">Una vez completados estos métodos, se ha preparado para agregar métodos a `ProductsDataTable` o el BLL que realiza una serie de comandos bajo el Paragua de una transacción.</span><span class="sxs-lookup"><span data-stu-id="3281b-209">With these methods complete, we re ready to add methods to `ProductsDataTable` or the BLL that perform a series of commands under the umbrella of a transaction.</span></span> <span data-ttu-id="3281b-210">El método siguiente utiliza el patrón de actualización por lotes para actualizar una instancia de `ProductsDataTable` mediante una transacción.</span><span class="sxs-lookup"><span data-stu-id="3281b-210">The following method uses the Batch Update pattern to update a `ProductsDataTable` instance using a transaction.</span></span> <span data-ttu-id="3281b-211">Inicia una transacción llamando al método `BeginTransaction` y, a continuación, usa un bloque `try...catch` para emitir las instrucciones de modificación de datos.</span><span class="sxs-lookup"><span data-stu-id="3281b-211">It starts a transaction by calling the `BeginTransaction` method and then uses a `try...catch` block to issue the data modification statements.</span></span> <span data-ttu-id="3281b-212">Si la llamada al método `Adapter` Object s `Update` produce una excepción, la ejecución se transferirá al bloque `catch` donde se revertirá la transacción y se volverá a producir la excepción.</span><span class="sxs-lookup"><span data-stu-id="3281b-212">If the call to the `Adapter` object s `Update` method results in an exception, execution will transfer to the `catch` block where the transaction will be rolled back and the exception re-thrown.</span></span> <span data-ttu-id="3281b-213">Recuerde que el método `Update` implementa el patrón de actualización por lotes enumerando las filas del `ProductsDataTable` proporcionado y realizando los `InsertCommand`, `UpdateCommand`y `DeleteCommand` necesarios.</span><span class="sxs-lookup"><span data-stu-id="3281b-213">Recall that the `Update` method implements the Batch Update pattern by enumerating the rows of the supplied `ProductsDataTable` and performing the necessary `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s.</span></span> <span data-ttu-id="3281b-214">Si alguno de estos comandos produce un error, se revierte la transacción y se deshacen las modificaciones anteriores realizadas durante la duración de la transacción.</span><span class="sxs-lookup"><span data-stu-id="3281b-214">If any one of these commands results in an error, the transaction is rolled back, undoing the previous modifications made during the transaction s lifetime.</span></span> <span data-ttu-id="3281b-215">Si la instrucción de `Update` se completa sin errores, la transacción se confirma en su totalidad.</span><span class="sxs-lookup"><span data-stu-id="3281b-215">Should the `Update` statement complete without error, the transaction is committed in its entirety.</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample4.cs)]

<span data-ttu-id="3281b-216">Agregue el método `UpdateWithTransaction` a la clase `ProductsTableAdapter` a través de la clase parcial en `ProductsTableAdapter.TransactionSupport.cs`.</span><span class="sxs-lookup"><span data-stu-id="3281b-216">Add the `UpdateWithTransaction` method to the `ProductsTableAdapter` class through the partial class in `ProductsTableAdapter.TransactionSupport.cs`.</span></span> <span data-ttu-id="3281b-217">También puede Agregar este método a la clase de `ProductsBLL` de la capa de lógica de negocios con unos pocos cambios sintácticos.</span><span class="sxs-lookup"><span data-stu-id="3281b-217">Alternatively, this method could be added to the Business Logic Layer s `ProductsBLL` class with a few minor syntactical changes.</span></span> <span data-ttu-id="3281b-218">Es decir, la palabra clave this en `this.BeginTransaction()`, `this.CommitTransaction()`y `this.RollbackTransaction()` tendría que reemplazarse por `Adapter` (Recuerde que `Adapter` es el nombre de una propiedad en `ProductsBLL` de tipo `ProductsTableAdapter`).</span><span class="sxs-lookup"><span data-stu-id="3281b-218">Namely, the keyword this in `this.BeginTransaction()`, `this.CommitTransaction()`, and `this.RollbackTransaction()` would need to be replaced with `Adapter` (recall that `Adapter` is the name of a property in `ProductsBLL` of type `ProductsTableAdapter`).</span></span>

<span data-ttu-id="3281b-219">El método `UpdateWithTransaction` usa el patrón de actualización por lotes, pero también se puede usar una serie de llamadas de DB-Direct en el ámbito de una transacción, como se muestra en el siguiente método.</span><span class="sxs-lookup"><span data-stu-id="3281b-219">The `UpdateWithTransaction` method uses the Batch Update pattern, but a series of DB-Direct calls can also be used within the scope of a transaction, as the following method shows.</span></span> <span data-ttu-id="3281b-220">El método `DeleteProductsWithTransaction` acepta como entrada una `List<T>` de tipo `int`, que son las `ProductID` s que se van a eliminar.</span><span class="sxs-lookup"><span data-stu-id="3281b-220">The `DeleteProductsWithTransaction` method accepts as input a `List<T>` of type `int`, which are the `ProductID` s to delete.</span></span> <span data-ttu-id="3281b-221">El método inicia la transacción a través de una llamada a `BeginTransaction` y, a continuación, en el bloque de `try`, recorre en iteración la lista proporcionada que llama al método `Delete` de DB-Direct para cada valor de `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="3281b-221">The method initiates the transaction via a call to `BeginTransaction` and then, in the `try` block, iterates through the supplied list calling the DB-Direct pattern `Delete` method for each `ProductID` value.</span></span> <span data-ttu-id="3281b-222">Si se produce un error en alguna de las llamadas a `Delete`, el control se transfiere al bloque de `catch` en el que se revierte la transacción y se vuelve a producir la excepción.</span><span class="sxs-lookup"><span data-stu-id="3281b-222">If any of the calls to `Delete` fails, control is transferred to the `catch` block where the transaction is rolled back and the exception re-thrown.</span></span> <span data-ttu-id="3281b-223">Si todas las llamadas a `Delete` se realizan correctamente, se confirma la transacción.</span><span class="sxs-lookup"><span data-stu-id="3281b-223">If all calls to `Delete` succeed, then transaction is committed.</span></span> <span data-ttu-id="3281b-224">Agregue este método a la clase `ProductsBLL`.</span><span class="sxs-lookup"><span data-stu-id="3281b-224">Add this method to the `ProductsBLL` class.</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample5.cs)]

## <a name="applying-transactions-across-multiple-tableadapters"></a><span data-ttu-id="3281b-225">Aplicar transacciones en varios TableAdapters</span><span class="sxs-lookup"><span data-stu-id="3281b-225">Applying Transactions Across Multiple TableAdapters</span></span>

<span data-ttu-id="3281b-226">El código relacionado con la transacción examinado en este tutorial permite que varias instrucciones del `ProductsTableAdapter` se traten como una operación atómica.</span><span class="sxs-lookup"><span data-stu-id="3281b-226">The transaction-related code examined in this tutorial allows for multiple statements against the `ProductsTableAdapter` to be treated as an atomic operation.</span></span> <span data-ttu-id="3281b-227">Pero ¿qué ocurre si hay varias modificaciones en las tablas de bases de datos diferentes que deben realizarse de forma atómica?</span><span class="sxs-lookup"><span data-stu-id="3281b-227">But what if multiple modifications to different database tables need to be performed atomically?</span></span> <span data-ttu-id="3281b-228">Por ejemplo, al eliminar una categoría, es posible que primero quiera reasignar sus productos actuales a alguna otra categoría.</span><span class="sxs-lookup"><span data-stu-id="3281b-228">For instance, when deleting a category, we might first want to reassign its current products to some other category.</span></span> <span data-ttu-id="3281b-229">Estos dos pasos que reasignan los productos y eliminan la categoría deben ejecutarse como una operación atómica.</span><span class="sxs-lookup"><span data-stu-id="3281b-229">These two steps reassigning the products and deleting the category should be executed as an atomic operation.</span></span> <span data-ttu-id="3281b-230">Pero el `ProductsTableAdapter` solo incluye métodos para modificar la tabla `Products` y el `CategoriesTableAdapter` solo incluye métodos para modificar la tabla `Categories`.</span><span class="sxs-lookup"><span data-stu-id="3281b-230">But the `ProductsTableAdapter` includes only methods for modifying the `Products` table and the `CategoriesTableAdapter` includes only methods for modifying the `Categories` table.</span></span> <span data-ttu-id="3281b-231">Entonces, ¿cómo puede una transacción abarcar ambos TableAdapters?</span><span class="sxs-lookup"><span data-stu-id="3281b-231">So how can a transaction encompass both TableAdapters?</span></span>

<span data-ttu-id="3281b-232">Una opción consiste en agregar un método al `CategoriesTableAdapter` denominado `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` y hacer que ese método llame a un procedimiento almacenado que reasigne los productos y elimine la categoría dentro del ámbito de una transacción definida en el procedimiento almacenado.</span><span class="sxs-lookup"><span data-stu-id="3281b-232">One option is to add a method to the `CategoriesTableAdapter` named `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` and have that method call a stored procedure that both reassigns the products and deletes the category within the scope of a transaction defined within the stored procedure.</span></span> <span data-ttu-id="3281b-233">Veremos cómo iniciar, confirmar y revertir las transacciones en procedimientos almacenados en un tutorial futuro.</span><span class="sxs-lookup"><span data-stu-id="3281b-233">We'll look at how to begin, commit, and rollback transactions in stored procedures in a future tutorial.</span></span>

<span data-ttu-id="3281b-234">Otra opción consiste en crear una clase auxiliar en la capa DAL que contenga el método `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)`.</span><span class="sxs-lookup"><span data-stu-id="3281b-234">Another option is to create a helper class in the DAL that contains the `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` method.</span></span> <span data-ttu-id="3281b-235">Este método crearía una instancia de la `CategoriesTableAdapter` y el `ProductsTableAdapter` y, a continuación, establecería estos dos TableAdapters `Connection` propiedades en la misma instancia de `SqlConnection`.</span><span class="sxs-lookup"><span data-stu-id="3281b-235">This method would create an instance of the `CategoriesTableAdapter` and the `ProductsTableAdapter` and then set these two TableAdapters `Connection` properties to the same `SqlConnection` instance.</span></span> <span data-ttu-id="3281b-236">En ese momento, cualquiera de los dos TableAdapters iniciaría la transacción con una llamada a `BeginTransaction`.</span><span class="sxs-lookup"><span data-stu-id="3281b-236">At that point, either one of the two TableAdapters would initiate the transaction with a call to `BeginTransaction`.</span></span> <span data-ttu-id="3281b-237">Los métodos de TableAdapter para reasignar los productos y eliminar la categoría se invocarían en un bloque `try...catch` con la transacción confirmada o revertida según sea necesario.</span><span class="sxs-lookup"><span data-stu-id="3281b-237">The TableAdapters methods for reassigning the products and deleting the category would be invoked in a `try...catch` block with the transaction committed or rolled back as needed.</span></span>

## <a name="step-4-adding-theupdatewithtransactionmethod-to-the-business-logic-layer"></a><span data-ttu-id="3281b-238">Paso 4: agregar el método`UpdateWithTransaction`a la capa de lógica de negocios</span><span class="sxs-lookup"><span data-stu-id="3281b-238">Step 4: Adding the`UpdateWithTransaction`Method to the Business Logic Layer</span></span>

<span data-ttu-id="3281b-239">En el paso 3 se ha agregado un método `UpdateWithTransaction` a la `ProductsTableAdapter` de la capa DAL.</span><span class="sxs-lookup"><span data-stu-id="3281b-239">In Step 3 we added an `UpdateWithTransaction` method to the `ProductsTableAdapter` in the DAL.</span></span> <span data-ttu-id="3281b-240">Debemos agregar un método correspondiente a la capa BLL.</span><span class="sxs-lookup"><span data-stu-id="3281b-240">We should add a corresponding method to the BLL.</span></span> <span data-ttu-id="3281b-241">Aunque el nivel de presentación podría llamar directamente a la capa DAL para invocar el método de `UpdateWithTransaction`, estos tutoriales han luchado por definir una arquitectura en capas que aísla la capa DAL del nivel de presentación.</span><span class="sxs-lookup"><span data-stu-id="3281b-241">While the Presentation Layer could call directly down to the DAL to invoke the `UpdateWithTransaction` method, these tutorials have strived to define a layered architecture that insulates the DAL from the Presentation Layer.</span></span> <span data-ttu-id="3281b-242">Por lo tanto, nos importa para continuar este enfoque.</span><span class="sxs-lookup"><span data-stu-id="3281b-242">Therefore, it behooves us to continue this approach.</span></span>

<span data-ttu-id="3281b-243">Abra el archivo de clase `ProductsBLL` y agregue un método denominado `UpdateWithTransaction` que simplemente llama al método DAL correspondiente.</span><span class="sxs-lookup"><span data-stu-id="3281b-243">Open the `ProductsBLL` class file and add a method named `UpdateWithTransaction` that simply calls down to the corresponding DAL method.</span></span> <span data-ttu-id="3281b-244">Ahora debería haber dos nuevos métodos en `ProductsBLL`: `UpdateWithTransaction`, que acaba de agregar y `DeleteProductsWithTransaction`, que se agregó en el paso 3.</span><span class="sxs-lookup"><span data-stu-id="3281b-244">There should now be two new methods in `ProductsBLL`: `UpdateWithTransaction`, which you just added, and `DeleteProductsWithTransaction`, which was added in Step 3.</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample6.cs)]

> [!NOTE]
> <span data-ttu-id="3281b-245">Estos métodos no incluyen el atributo `DataObjectMethodAttribute` asignado a la mayoría de los demás métodos de la clase `ProductsBLL` porque vamos a invocar estos métodos directamente desde las clases de código subyacente de páginas de ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="3281b-245">These methods do not include the `DataObjectMethodAttribute` attribute assigned to most other methods in the `ProductsBLL` class because we'll be invoking these methods directly from the ASP.NET pages code-behind classes.</span></span> <span data-ttu-id="3281b-246">Recuerde que `DataObjectMethodAttribute` se usa para marcar qué métodos deben aparecer en el Asistente para configurar origen de datos de ObjectDataSource s y en la pestaña (SELECT, UPDATE, INSERT o DELETE).</span><span class="sxs-lookup"><span data-stu-id="3281b-246">Recall that `DataObjectMethodAttribute` is used to flag what methods should appear in the ObjectDataSource s Configure Data Source wizard and under what tab (SELECT, UPDATE, INSERT, or DELETE).</span></span> <span data-ttu-id="3281b-247">Dado que GridView carece de compatibilidad integrada para la edición o eliminación de lotes, tendremos que invocar estos métodos mediante programación en lugar de usar el enfoque declarativo sin código.</span><span class="sxs-lookup"><span data-stu-id="3281b-247">Since the GridView lacks any built-in support for batch editing or deleting, we'll have to invoke these methods programmatically rather than use the code-free declarative approach.</span></span>

## <a name="step-5-atomically-updating-database-data-from-the-presentation-layer"></a><span data-ttu-id="3281b-248">Paso 5: actualizar atómicamente los datos de la base de datos desde el nivel de presentación</span><span class="sxs-lookup"><span data-stu-id="3281b-248">Step 5: Atomically Updating Database Data from the Presentation Layer</span></span>

<span data-ttu-id="3281b-249">Para ilustrar el efecto que tiene la transacción al actualizar un lote de registros, cree una interfaz de usuario que haga una lista de todos los productos de GridView e incluya un control Web de botón que, cuando se hace clic en él, reasigna los productos `CategoryID` valores.</span><span class="sxs-lookup"><span data-stu-id="3281b-249">To illustrate the effect that the transaction has when updating a batch of records, let s create a user interface that lists all products in a GridView and includes a Button Web control that, when clicked, reassigns the products `CategoryID` values.</span></span> <span data-ttu-id="3281b-250">En concreto, la reasignación de categoría progresará de modo que se asigne a los primeros productos un valor de `CategoryID` válido, mientras que a otros se les asigna un valor `CategoryID` que no existe.</span><span class="sxs-lookup"><span data-stu-id="3281b-250">In particular, the category reassignment will progress so that the first several products are assigned a valid `CategoryID` value while others are purposefully assigned a non-existent `CategoryID` value.</span></span> <span data-ttu-id="3281b-251">Si intentamos actualizar la base de datos con un producto cuyo `CategoryID` no coincide con una categoría existente `CategoryID`, se producirá una infracción de la restricción de clave externa y se producirá una excepción.</span><span class="sxs-lookup"><span data-stu-id="3281b-251">If we attempt to update the database with a product whose `CategoryID` does not match an existing category s `CategoryID`, a foreign key constraint violation will occur and an exception will be raised.</span></span> <span data-ttu-id="3281b-252">Lo que veremos en este ejemplo es que, cuando se usa una transacción, la excepción generada por la infracción de la restricción de clave externa hará que se reviertan los cambios de `CategoryID` válidos anteriores.</span><span class="sxs-lookup"><span data-stu-id="3281b-252">What we'll see in this example is that when using a transaction the exception raised from the foreign key constraint violation will cause the previous valid `CategoryID` changes to be rolled back.</span></span> <span data-ttu-id="3281b-253">Sin embargo, cuando no se utiliza una transacción, las modificaciones de las categorías iniciales permanecerán.</span><span class="sxs-lookup"><span data-stu-id="3281b-253">When not using a transaction, however, the modifications to the initial categories will remain.</span></span>

<span data-ttu-id="3281b-254">Comience abriendo la página `Transactions.aspx` en la carpeta `BatchData` y arrastre un control GridView desde el cuadro de herramientas hasta el diseñador.</span><span class="sxs-lookup"><span data-stu-id="3281b-254">Start by opening the `Transactions.aspx` page in the `BatchData` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="3281b-255">Establezca su `ID` en `Products` y, desde su etiqueta inteligente, enlácelo a un nuevo ObjectDataSource denominado `ProductsDataSource`.</span><span class="sxs-lookup"><span data-stu-id="3281b-255">Set its `ID` to `Products` and, from its smart tag, bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="3281b-256">Configure ObjectDataSource para que extraiga sus datos del método `ProductsBLL` Class s `GetProducts`.</span><span class="sxs-lookup"><span data-stu-id="3281b-256">Configure the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProducts` method.</span></span> <span data-ttu-id="3281b-257">Este será un control GridView de solo lectura, así que establezca las listas desplegables de las pestañas actualizar, insertar y eliminar en (ninguna) y haga clic en finalizar.</span><span class="sxs-lookup"><span data-stu-id="3281b-257">This will be a read-only GridView, so set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and click Finish.</span></span>

<span data-ttu-id="3281b-258">[![Figura 5: configuración de ObjectDataSource para usar el método ProductsBLL de la clase GetProducts](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="3281b-258">[![Figure 5: Configure the ObjectDataSource to Use the ProductsBLL Class s GetProducts Method](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span></span>

<span data-ttu-id="3281b-259">**Figura 5**: Figura 5: configuración de ObjectDataSource para usar el método `ProductsBLL` Class s `GetProducts` ([haga clic para ver la imagen de tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="3281b-259">**Figure 5**: Figure 5: Configure the ObjectDataSource to Use the `ProductsBLL` Class s `GetProducts` Method ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span></span>

<span data-ttu-id="3281b-260">[![establecer las listas desplegables de las pestañas actualizar, insertar y eliminar en (ninguna)](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="3281b-260">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span></span>

<span data-ttu-id="3281b-261">**Figura 6**: establecer las listas desplegables de las pestañas actualizar, insertar y eliminar en (ninguna) ([haga clic para ver la imagen a tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="3281b-261">**Figure 6**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span></span>

<span data-ttu-id="3281b-262">Después de completar el Asistente para configurar orígenes de datos, Visual Studio creará BoundFields y CheckBoxField para los campos de datos del producto.</span><span class="sxs-lookup"><span data-stu-id="3281b-262">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and a CheckBoxField for the product data fields.</span></span> <span data-ttu-id="3281b-263">Quite todos estos campos, excepto `ProductID`, `ProductName`, `CategoryID`y `CategoryName`, y cambie el nombre de las propiedades `ProductName` y `CategoryName` BoundFields `HeaderText` a product y Category, respectivamente.</span><span class="sxs-lookup"><span data-stu-id="3281b-263">Remove all of these fields except for `ProductID`, `ProductName`, `CategoryID`, and `CategoryName` and rename the `ProductName` and `CategoryName` BoundFields `HeaderText` properties to Product and Category, respectively.</span></span> <span data-ttu-id="3281b-264">En la etiqueta inteligente, active la opción Habilitar paginación.</span><span class="sxs-lookup"><span data-stu-id="3281b-264">From the smart tag, check the Enable Paging option.</span></span> <span data-ttu-id="3281b-265">Después de realizar estas modificaciones, el marcado declarativo GridView y ObjectDataSource s debe ser similar al siguiente:</span><span class="sxs-lookup"><span data-stu-id="3281b-265">After making these modifications, the GridView and ObjectDataSource s declarative markup should look like the following:</span></span>

[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample7.aspx)]

<span data-ttu-id="3281b-266">A continuación, agregue tres controles Web Button por encima de GridView.</span><span class="sxs-lookup"><span data-stu-id="3281b-266">Next, add three Button Web controls above the GridView.</span></span> <span data-ttu-id="3281b-267">Establezca la propiedad de texto del primer botón en actualizar cuadrícula, la segunda para modificar las categorías (con transacción) y la tercera para modificar las categorías (sin transacción).</span><span class="sxs-lookup"><span data-stu-id="3281b-267">Set the first Button s Text property to Refresh Grid, the second s to Modify Categories (WITH TRANSACTION), and the third one s to Modify Categories (WITHOUT TRANSACTION) .</span></span>

[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample8.aspx)]

<span data-ttu-id="3281b-268">En este momento, el Vista de diseño en Visual Studio debe ser similar a la captura de pantalla que se muestra en la figura 7.</span><span class="sxs-lookup"><span data-stu-id="3281b-268">At this point the Design view in Visual Studio should look similar to the screen shot shown in Figure 7.</span></span>

<span data-ttu-id="3281b-269">[![la página contiene un control GridView y tres controles Web Button](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="3281b-269">[![The Page Contains a GridView and Three Button Web Controls](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span></span>

<span data-ttu-id="3281b-270">**Figura 7**: la página contiene un control GridView y tres controles Web Button ([haga clic para ver la imagen de tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="3281b-270">**Figure 7**: The Page Contains a GridView and Three Button Web Controls ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span></span>

<span data-ttu-id="3281b-271">Cree controladores de eventos para cada uno de los tres eventos Button `Click` y use el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="3281b-271">Create event handlers for each of the three Button s `Click` events and use the following code:</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample9.cs)]

<span data-ttu-id="3281b-272">El controlador de eventos del botón actualizar s `Click` simplemente vuelve a enlazar los datos a GridView llamando al método `Products` GridView s `DataBind`.</span><span class="sxs-lookup"><span data-stu-id="3281b-272">The refresh Button s `Click` event handler simply rebinds the data to the GridView by calling the `Products` GridView s `DataBind` method.</span></span>

<span data-ttu-id="3281b-273">El segundo controlador de eventos reasigna los productos `CategoryID` s y usa el nuevo método de transacción de la capa BLL para realizar las actualizaciones de la base de datos bajo el Paragua de una transacción.</span><span class="sxs-lookup"><span data-stu-id="3281b-273">The second event handler reassigns the products `CategoryID` s and uses the new transaction method from the BLL to perform the database updates under the umbrella of a transaction.</span></span> <span data-ttu-id="3281b-274">Tenga en cuenta que cada producto s `CategoryID` se establece arbitrariamente en el mismo valor que su `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="3281b-274">Note that each product s `CategoryID` is arbitrarily set to the same value as its `ProductID`.</span></span> <span data-ttu-id="3281b-275">Esto funcionará bien para los primeros productos, ya que estos productos tienen `ProductID` valores que se asignan a `CategoryID` s válidos.</span><span class="sxs-lookup"><span data-stu-id="3281b-275">This will work fine for the first few products, since those products have `ProductID` values that happen to map to valid `CategoryID` s.</span></span> <span data-ttu-id="3281b-276">Pero una vez que el `ProductID` s comienza a obtener un tamaño demasiado grande, esta superposición una coincidencia de `ProductID` s y `CategoryID` s ya no se aplica.</span><span class="sxs-lookup"><span data-stu-id="3281b-276">But once the `ProductID` s start getting too large, this coincidental overlap of `ProductID` s and `CategoryID` s no longer applies.</span></span>

<span data-ttu-id="3281b-277">El tercer controlador de eventos `Click` actualiza los productos `CategoryID` s de la misma manera, pero envía la actualización a la base de datos mediante el método de `Update` predeterminado `ProductsTableAdapter` s.</span><span class="sxs-lookup"><span data-stu-id="3281b-277">The third `Click` event handler updates the products `CategoryID` s in the same manner, but sends the update to the database using the `ProductsTableAdapter` s default `Update` method.</span></span> <span data-ttu-id="3281b-278">Este método `Update` no encapsula la serie de comandos dentro de una transacción, por lo que los cambios realizados antes del primer error de infracción de la restricción de clave externa encontrada se conservarán.</span><span class="sxs-lookup"><span data-stu-id="3281b-278">This `Update` method does not wrap the series of commands within a transaction, so those changes are made prior to the first encountered foreign key constraint violation error will persist.</span></span>

<span data-ttu-id="3281b-279">Para mostrar este comportamiento, visite esta página a través de un explorador.</span><span class="sxs-lookup"><span data-stu-id="3281b-279">To demonstrate this behavior, visit this page through a browser.</span></span> <span data-ttu-id="3281b-280">Inicialmente debería ver la primera página de datos, tal como se muestra en la figura 8.</span><span class="sxs-lookup"><span data-stu-id="3281b-280">Initially you should see the first page of data as shown in Figure 8.</span></span> <span data-ttu-id="3281b-281">A continuación, haga clic en el botón modificar categorías (con transacción).</span><span class="sxs-lookup"><span data-stu-id="3281b-281">Next, click the Modify Categories (WITH TRANSACTION) button.</span></span> <span data-ttu-id="3281b-282">Esto producirá un postback e intentará actualizar todos los productos `CategoryID` valores, pero producirá una infracción de la restricción de clave externa (consulte la figura 9).</span><span class="sxs-lookup"><span data-stu-id="3281b-282">This will cause a postback and attempt to update all of the products `CategoryID` values, but will result in a foreign key constraint violation (see Figure 9).</span></span>

<span data-ttu-id="3281b-283">[![los productos se muestran en un control GridView paginable](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="3281b-283">[![The Products are Displayed in a Pageable GridView](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span></span>

<span data-ttu-id="3281b-284">**Figura 8**: los productos se muestran en un control GridView paginable ([haga clic para ver la imagen de tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="3281b-284">**Figure 8**: The Products are Displayed in a Pageable GridView ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span></span>

<span data-ttu-id="3281b-285">[![reasignar las categorías da como resultado una infracción de restricción de clave externa](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="3281b-285">[![Reassigning the Categories Results in a Foreign Key Constraint Violation](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span></span>

<span data-ttu-id="3281b-286">**Figura 9**: reasignación de las categorías da como resultado una infracción de restricción de clave externa ([haga clic para ver la imagen de tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="3281b-286">**Figure 9**: Reassigning the Categories Results in a Foreign Key Constraint Violation ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span></span>

<span data-ttu-id="3281b-287">Ahora, presione el botón atrás del explorador y, a continuación, haga clic en el botón actualizar cuadrícula.</span><span class="sxs-lookup"><span data-stu-id="3281b-287">Now hit your browser s Back button and then click the Refresh Grid button.</span></span> <span data-ttu-id="3281b-288">Tras actualizar los datos, debería ver el mismo resultado que se muestra en la figura 8.</span><span class="sxs-lookup"><span data-stu-id="3281b-288">Upon refreshing the data you should see the exact same output as shown in Figure 8.</span></span> <span data-ttu-id="3281b-289">Es decir, aunque algunos de los productos `CategoryID` s se cambiaron a valores legales y se actualizaron en la base de datos, se revirtieron cuando se produjo la infracción de la restricción de clave externa.</span><span class="sxs-lookup"><span data-stu-id="3281b-289">That is, even though some of the products `CategoryID` s were changed to legal values and updated in the database, they were rolled back when the foreign key constraint violation occurred.</span></span>

<span data-ttu-id="3281b-290">Ahora, intente hacer clic en el botón modificar categorías (sin transacción).</span><span class="sxs-lookup"><span data-stu-id="3281b-290">Now try clicking the Modify Categories (WITHOUT TRANSACTION) button.</span></span> <span data-ttu-id="3281b-291">Esto producirá el mismo error de infracción de la restricción de clave externa (vea la ilustración 9), pero esta vez no se revertirán los productos cuyos valores de `CategoryID` se cambiaron a un valor válido.</span><span class="sxs-lookup"><span data-stu-id="3281b-291">This will result in the same foreign key constraint violation error (see Figure 9), but this time those products whose `CategoryID` values were changed to a legal value will not be rolled back.</span></span> <span data-ttu-id="3281b-292">Presione el botón atrás del explorador y, después, el botón actualizar cuadrícula.</span><span class="sxs-lookup"><span data-stu-id="3281b-292">Hit your browser s Back button and then the Refresh Grid button.</span></span> <span data-ttu-id="3281b-293">Como se muestra en la figura 10, se han reasignado los `CategoryID` s de los ocho primeros productos.</span><span class="sxs-lookup"><span data-stu-id="3281b-293">As Figure 10 shows, the `CategoryID` s of the first eight products have been reassigned.</span></span> <span data-ttu-id="3281b-294">Por ejemplo, en la figura 8, Chang tenía una `CategoryID` de 1, pero en la figura 10 se ha reasignado a 2.</span><span class="sxs-lookup"><span data-stu-id="3281b-294">For example, in Figure 8, Chang had a `CategoryID` of 1, but in Figure 10 it s been reassigned to 2.</span></span>

<span data-ttu-id="3281b-295">[![algunos productos los valores CategoryID se actualizaron mientras que otros no](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="3281b-295">[![Some Products CategoryID Values were Updated While Others Were Not](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span></span>

<span data-ttu-id="3281b-296">**Figura 10**: algunos productos `CategoryID` valores se actualizaron mientras que otros no estaban ([haga clic para ver la imagen de tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="3281b-296">**Figure 10**: Some Products `CategoryID` Values were Updated While Others Were Not ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span></span>

## <a name="summary"></a><span data-ttu-id="3281b-297">Resumen</span><span class="sxs-lookup"><span data-stu-id="3281b-297">Summary</span></span>

<span data-ttu-id="3281b-298">De forma predeterminada, los métodos de TableAdapter s no encapsulan las instrucciones de base de datos ejecutadas dentro del ámbito de una transacción, pero con un poco de trabajo podemos agregar métodos que crearán, confirmarán y revierten una transacción.</span><span class="sxs-lookup"><span data-stu-id="3281b-298">By default, the TableAdapter s methods do not wrap the executed database statements within the scope of a transaction, but with a little work we can add methods that will create, commit, and rollback a transaction.</span></span> <span data-ttu-id="3281b-299">En este tutorial, hemos creado tres métodos de este tipo en la clase `ProductsTableAdapter`: `BeginTransaction`, `CommitTransaction`y `RollbackTransaction`.</span><span class="sxs-lookup"><span data-stu-id="3281b-299">In this tutorial we created three such methods in the `ProductsTableAdapter` class: `BeginTransaction`, `CommitTransaction`, and `RollbackTransaction`.</span></span> <span data-ttu-id="3281b-300">Vimos cómo usar estos métodos junto con un bloque `try...catch` para realizar una serie de instrucciones de modificación de datos atómicas.</span><span class="sxs-lookup"><span data-stu-id="3281b-300">We saw how to use these methods along with a `try...catch` block to make a series of data modification statements atomic.</span></span> <span data-ttu-id="3281b-301">En concreto, creamos el método `UpdateWithTransaction` en el `ProductsTableAdapter`, que usa el patrón de actualización por lotes para realizar las modificaciones necesarias en las filas de un `ProductsDataTable`proporcionado.</span><span class="sxs-lookup"><span data-stu-id="3281b-301">In particular, we created the `UpdateWithTransaction` method in the `ProductsTableAdapter`, which uses the Batch Update pattern to perform the necessary modifications to the rows of a supplied `ProductsDataTable`.</span></span> <span data-ttu-id="3281b-302">También hemos agregado el método `DeleteProductsWithTransaction` a la clase `ProductsBLL` de la capa BLL, que acepta un `List` de `ProductID` valores como entrada y llama al método de patrón DB-Direct `Delete` para cada `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="3281b-302">We also added the `DeleteProductsWithTransaction` method to the `ProductsBLL` class in the BLL, which accepts a `List` of `ProductID` values as its input and calls the DB-Direct pattern method `Delete` for each `ProductID`.</span></span> <span data-ttu-id="3281b-303">Ambos métodos comienzan por crear una transacción y, después, ejecutar las instrucciones de modificación de datos dentro de un bloque `try...catch`.</span><span class="sxs-lookup"><span data-stu-id="3281b-303">Both methods start by creating a transaction and then executing the data modification statements within a `try...catch` block.</span></span> <span data-ttu-id="3281b-304">Si se produce una excepción, la transacción se revierte; de lo contrario, se confirma.</span><span class="sxs-lookup"><span data-stu-id="3281b-304">If an exception occurs, the transaction is rolled back, otherwise it is committed.</span></span>

<span data-ttu-id="3281b-305">En el paso 5 se ilustra el efecto de las actualizaciones de lotes transaccionales frente a las actualizaciones por lotes que no han podido usar una transacción.</span><span class="sxs-lookup"><span data-stu-id="3281b-305">Step 5 illustrated the effect of transactional batch updates versus batch updates that neglected to use a transaction.</span></span> <span data-ttu-id="3281b-306">En los tres tutoriales siguientes se basará en la base que se proporciona en este tutorial y creará interfaces de usuario para realizar actualizaciones, eliminaciones e inserciones por lotes.</span><span class="sxs-lookup"><span data-stu-id="3281b-306">In the next three tutorials we will build upon the foundation laid in this tutorial and create user interfaces for performing batch updates, deletes, and inserts.</span></span>

<span data-ttu-id="3281b-307">¡ Feliz programación!</span><span class="sxs-lookup"><span data-stu-id="3281b-307">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="3281b-308">Información adicional</span><span class="sxs-lookup"><span data-stu-id="3281b-308">Further Reading</span></span>

<span data-ttu-id="3281b-309">Para obtener más información sobre los temas descritos en este tutorial, consulte los siguientes recursos:</span><span class="sxs-lookup"><span data-stu-id="3281b-309">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="3281b-310">Mantener la coherencia de la base de datos con transacciones</span><span class="sxs-lookup"><span data-stu-id="3281b-310">Maintaining Database Consistency with Transactions</span></span>](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)
- [<span data-ttu-id="3281b-311">Administrar transacciones en SQL Server procedimientos almacenados</span><span class="sxs-lookup"><span data-stu-id="3281b-311">Managing Transactions in SQL Server Stored Procedures</span></span>](http://www.4guysfromrolla.com/webtech/080305-1.shtml)
- [<span data-ttu-id="3281b-312">Transacciones simplificadas: `System.Transactions`</span><span class="sxs-lookup"><span data-stu-id="3281b-312">Transactions Made Easy: `System.Transactions`</span></span>](https://blogs.msdn.com/florinlazar/archive/2004/07/23/192239.aspx)
- [<span data-ttu-id="3281b-313">TransactionScope y DataAdapters</span><span class="sxs-lookup"><span data-stu-id="3281b-313">TransactionScope and DataAdapters</span></span>](http://andyclymer.blogspot.com/2007/01/transactionscope-and-dataadapters.html)
- [<span data-ttu-id="3281b-314">Usar transacciones de Oracle Database en .NET</span><span class="sxs-lookup"><span data-stu-id="3281b-314">Using Oracle Database Transactions in .NET</span></span>](http://www.oracle.com/technology/pub/articles/price_dbtrans_dotnet.html)

## <a name="about-the-author"></a><span data-ttu-id="3281b-315">Acerca del autor</span><span class="sxs-lookup"><span data-stu-id="3281b-315">About the Author</span></span>

<span data-ttu-id="3281b-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), autor de siete libros de ASP/ASP. net y fundador de [4GuysFromRolla.com](http://www.4guysfromrolla.com), ha estado trabajando con las tecnologías Web de Microsoft desde 1998.</span><span class="sxs-lookup"><span data-stu-id="3281b-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="3281b-317">Scott funciona como consultor, profesor y redactor independiente.</span><span class="sxs-lookup"><span data-stu-id="3281b-317">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="3281b-318">Su último libro se [*enseña a ASP.NET 2,0 en 24 horas*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="3281b-318">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="3281b-319">Puede ponerse en contacto con usted en [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="3281b-319">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="3281b-320">o a través de su blog, que encontrará en [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="3281b-320">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="3281b-321">Agradecimiento especial a</span><span class="sxs-lookup"><span data-stu-id="3281b-321">Special Thanks To</span></span>

<span data-ttu-id="3281b-322">Muchos revisores útiles revisaron esta serie de tutoriales.</span><span class="sxs-lookup"><span data-stu-id="3281b-322">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="3281b-323">Los revisores responsables de este tutorial fueron Dave Gardner, Hilton Giesenow y Teresa Murphy.</span><span class="sxs-lookup"><span data-stu-id="3281b-323">Lead reviewers for this tutorial were Dave Gardner, Hilton Giesenow, and Teresa Murphy.</span></span> <span data-ttu-id="3281b-324">¿Está interesado en revisar los próximos artículos de MSDN?</span><span class="sxs-lookup"><span data-stu-id="3281b-324">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="3281b-325">En caso afirmativo, suéltelo en [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="3281b-325">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="3281b-326">Siguiente</span><span class="sxs-lookup"><span data-stu-id="3281b-326">Next</span></span>](batch-updating-cs.md)
