---
uid: mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application
title: Implementar el repositorio y unidad de patrones de trabajo en una aplicación de ASP.NET MVC (9 de 10) | Microsoft Docs
author: tdykstra
description: La aplicación web de Contoso University muestra cómo crear aplicaciones de ASP.NET MVC 4 mediante Code First de Entity Framework 5 y Visual Studio...
ms.author: riande
ms.date: 07/30/2013
ms.assetid: 44761193-04ba-4990-9f90-145d3c10a716
msc.legacyurl: /mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 71ff3c269c5d1ed43a67d19442eda8e9d4728295
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 04/09/2019
ms.locfileid: "59405708"
---
# <a name="implementing-the-repository-and-unit-of-work-patterns-in-an-aspnet-mvc-application-9-of-10"></a><span data-ttu-id="fcd90-103">Implementar el repositorio y unidad de patrones de trabajo en una aplicación de ASP.NET MVC (9 de 10)</span><span class="sxs-lookup"><span data-stu-id="fcd90-103">Implementing the Repository and Unit of Work Patterns in an ASP.NET MVC Application (9 of 10)</span></span>

<span data-ttu-id="fcd90-104">por [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="fcd90-104">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

[<span data-ttu-id="fcd90-105">Descargue el proyecto completado</span><span class="sxs-lookup"><span data-stu-id="fcd90-105">Download Completed Project</span></span>](http://code.msdn.microsoft.com/Getting-Started-with-dd0e2ed8)

> <span data-ttu-id="fcd90-106">La aplicación web de Contoso University muestra cómo crear aplicaciones de ASP.NET MVC 4 mediante Code First de Entity Framework 5 y Visual Studio 2012.</span><span class="sxs-lookup"><span data-stu-id="fcd90-106">The Contoso University sample web application demonstrates how to create ASP.NET MVC 4 applications using the Entity Framework 5 Code First and Visual Studio 2012.</span></span> <span data-ttu-id="fcd90-107">Para obtener información sobre la serie de tutoriales, consulte [el primer tutorial de la serie](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span><span class="sxs-lookup"><span data-stu-id="fcd90-107">For information about the tutorial series, see [the first tutorial in the series](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span></span> <span data-ttu-id="fcd90-108">Puede iniciar la serie de tutoriales desde el principio o [descargar un proyecto de inicio de este capítulo](building-the-ef5-mvc4-chapter-downloads.md) y comience aquí.</span><span class="sxs-lookup"><span data-stu-id="fcd90-108">You can start the tutorial series from the beginning or [download a starter project for this chapter](building-the-ef5-mvc4-chapter-downloads.md) and start here.</span></span>
> 
> > [!NOTE] 
> > 
> > <span data-ttu-id="fcd90-109">Si surge un problema que no se puede resolver, [descargar el capítulo completado](building-the-ef5-mvc4-chapter-downloads.md) e intente reproducir el problema.</span><span class="sxs-lookup"><span data-stu-id="fcd90-109">If you run into a problem you can't resolve, [download the completed chapter](building-the-ef5-mvc4-chapter-downloads.md) and try to reproduce your problem.</span></span> <span data-ttu-id="fcd90-110">Por lo general puede encontrar la solución al problema comparando el código para el código completo.</span><span class="sxs-lookup"><span data-stu-id="fcd90-110">You can generally find the solution to the problem by comparing your code to the completed code.</span></span> <span data-ttu-id="fcd90-111">Para que algunos errores comunes y cómo resolverlos, consulte [errores y soluciones alternativas.](advanced-entity-framework-scenarios-for-an-mvc-web-application.md#errors)</span><span class="sxs-lookup"><span data-stu-id="fcd90-111">For some common errors and how to solve them, see [Errors and Workarounds.](advanced-entity-framework-scenarios-for-an-mvc-web-application.md#errors)</span></span>


<span data-ttu-id="fcd90-112">En el tutorial anterior usa la herencia para reducir el código redundante en la `Student` y `Instructor` las clases de entidad.</span><span class="sxs-lookup"><span data-stu-id="fcd90-112">In the previous tutorial you used inheritance to reduce redundant code in the `Student` and `Instructor` entity classes.</span></span> <span data-ttu-id="fcd90-113">En este tutorial, verá algunas formas de usar el repositorio y unidad de patrones de trabajo para las operaciones CRUD.</span><span class="sxs-lookup"><span data-stu-id="fcd90-113">In this tutorial you'll see some ways to use the repository and unit of work patterns for CRUD operations.</span></span> <span data-ttu-id="fcd90-114">Como se muestra en el tutorial anterior, en éste va a cambiar la manera en que el código funciona con las páginas que ya creó en lugar de crear nuevas páginas.</span><span class="sxs-lookup"><span data-stu-id="fcd90-114">As in the previous tutorial, in this one you'll change the way your code works with pages you already created rather than creating new pages.</span></span>

## <a name="the-repository-and-unit-of-work-patterns"></a><span data-ttu-id="fcd90-115">El repositorio y unidad de patrones de trabajo</span><span class="sxs-lookup"><span data-stu-id="fcd90-115">The Repository and Unit of Work Patterns</span></span>

<span data-ttu-id="fcd90-116">El repositorio y unidad de patrones de trabajo están diseñados para crear una capa de abstracción entre la capa de acceso a datos y la capa de lógica de negocios de una aplicación.</span><span class="sxs-lookup"><span data-stu-id="fcd90-116">The repository and unit of work patterns are intended to create an abstraction layer between the data access layer and the business logic layer of an application.</span></span> <span data-ttu-id="fcd90-117">Implementar estos patrones puede ayudar a aislar la aplicación de cambios en el almacén de datos y puede facilitar la realización de pruebas unitarias automatizadas o el desarrollo controlado por pruebas (TDD).</span><span class="sxs-lookup"><span data-stu-id="fcd90-117">Implementing these patterns can help insulate your application from changes in the data store and can facilitate automated unit testing or test-driven development (TDD).</span></span>

<span data-ttu-id="fcd90-118">En este tutorial se implementa una clase de repositorio para cada tipo de entidad.</span><span class="sxs-lookup"><span data-stu-id="fcd90-118">In this tutorial you'll implement a repository class for each entity type.</span></span> <span data-ttu-id="fcd90-119">Para el `Student` tipo de entidad que se creará una interfaz de repositorio y una clase de repositorio.</span><span class="sxs-lookup"><span data-stu-id="fcd90-119">For the `Student` entity type you'll create a repository interface and a repository class.</span></span> <span data-ttu-id="fcd90-120">Cuando crea una instancia del repositorio en el controlador, deberá usar la interfaz para que el controlador acepta una referencia a cualquier objeto que implementa la interfaz del repositorio.</span><span class="sxs-lookup"><span data-stu-id="fcd90-120">When you instantiate the repository in your controller, you'll use the interface so that the controller will accept a reference to any object that implements the repository interface.</span></span> <span data-ttu-id="fcd90-121">Cuando el controlador se ejecuta en un servidor web, recibe un repositorio que funciona con Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="fcd90-121">When the controller runs under a web server, it receives a repository that works with the Entity Framework.</span></span> <span data-ttu-id="fcd90-122">Cuando el controlador se ejecuta en una clase de prueba unitaria, recibe un repositorio que funciona con los datos almacenados de forma que se puede manipular con facilidad para pruebas, como una colección en memoria.</span><span class="sxs-lookup"><span data-stu-id="fcd90-122">When the controller runs under a unit test class, it receives a repository that works with data stored in a way that you can easily manipulate for testing, such as an in-memory collection.</span></span>

<span data-ttu-id="fcd90-123">Más adelante en el tutorial usará varios repositorios y una unidad de trabajo de clase para el `Course` y `Department` tipos de entidad en el `Course` controlador.</span><span class="sxs-lookup"><span data-stu-id="fcd90-123">Later in the tutorial you'll use multiple repositories and a unit of work class for the `Course` and `Department` entity types in the `Course` controller.</span></span> <span data-ttu-id="fcd90-124">La unidad de trabajo clase coordina el trabajo de varios repositorios mediante la creación de una clase de contexto de base de datos única compartida por todos ellos.</span><span class="sxs-lookup"><span data-stu-id="fcd90-124">The unit of work class coordinates the work of multiple repositories by creating a single database context class shared by all of them.</span></span> <span data-ttu-id="fcd90-125">Si desea poder realizar pruebas unitarias automatizadas, podría crear y usar interfaces para estas clases en la misma manera que para el `Student` repositorio.</span><span class="sxs-lookup"><span data-stu-id="fcd90-125">If you wanted to be able to perform automated unit testing, you'd create and use interfaces for these classes in the same way you did for the `Student` repository.</span></span> <span data-ttu-id="fcd90-126">Sin embargo, para simplificar el tutorial, creará y utilizar estas clases sin interfaces.</span><span class="sxs-lookup"><span data-stu-id="fcd90-126">However, to keep the tutorial simple, you'll create and use these classes without interfaces.</span></span>

<span data-ttu-id="fcd90-127">La siguiente ilustración muestra una manera de conceptualizar las relaciones entre el controlador y las clases de contexto en comparación con no usa el repositorio o la unidad del patrón de trabajo en absoluto.</span><span class="sxs-lookup"><span data-stu-id="fcd90-127">The following illustration shows one way to conceptualize the relationships between the controller and context classes compared to not using the repository or unit of work pattern at all.</span></span>

![Repository_pattern_diagram](https://asp.net/media/2578149/Windows-Live-Writer_8c4963ba1fa3_CE3B_Repository_pattern_diagram_1df790d3-bdf2-4c11-9098-946ddd9cd884.png)

<span data-ttu-id="fcd90-129">No cree pruebas unitarias en esta serie de tutoriales.</span><span class="sxs-lookup"><span data-stu-id="fcd90-129">You won't create unit tests in this tutorial series.</span></span> <span data-ttu-id="fcd90-130">Para obtener una introducción sobre TDD con una aplicación de MVC que usa el patrón de repositorio, consulte [Tutorial: Usar TDD con ASP.NET MVC](https://msdn.microsoft.com/library/ff847525.aspx).</span><span class="sxs-lookup"><span data-stu-id="fcd90-130">For an introduction to TDD with an MVC application that uses the repository pattern, see [Walkthrough: Using TDD with ASP.NET MVC](https://msdn.microsoft.com/library/ff847525.aspx).</span></span> <span data-ttu-id="fcd90-131">Para obtener más información sobre el modelo de repositorio, consulte los siguientes recursos:</span><span class="sxs-lookup"><span data-stu-id="fcd90-131">For more information about the repository pattern, see the following resources:</span></span>

- <span data-ttu-id="fcd90-132">[El modelo de repositorio](https://msdn.microsoft.com/library/ff649690.aspx) en MSDN.</span><span class="sxs-lookup"><span data-stu-id="fcd90-132">[The Repository Pattern](https://msdn.microsoft.com/library/ff649690.aspx) on MSDN.</span></span>
- <span data-ttu-id="fcd90-133">[Uso de patrones de repositorio y unidad de trabajo con Entity Framework 4.0](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx) en el blog del equipo de Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="fcd90-133">[Using Repository and Unit of Work patterns with Entity Framework 4.0](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx) on the Entity Framework team blog.</span></span>
- <span data-ttu-id="fcd90-134">[Repositorio de Agile Entity Framework 4](http://thedatafarm.com/blog/data-access/agile-entity-framework-4-repository-part-1-model-and-poco-classes/) serie de publicaciones en blog de Julie.</span><span class="sxs-lookup"><span data-stu-id="fcd90-134">[Agile Entity Framework 4 Repository](http://thedatafarm.com/blog/data-access/agile-entity-framework-4-repository-part-1-model-and-poco-classes/) series of posts on Julie Lerman's blog.</span></span>
- <span data-ttu-id="fcd90-135">[Creación de la cuenta en una aplicación de vista HTML5/jQuery](https://weblogs.asp.net/dwahlin/archive/2011/08/15/building-the-account-at-a-glance-html5-jquery-application.aspx) en blog Wahlin.</span><span class="sxs-lookup"><span data-stu-id="fcd90-135">[Building the Account at a Glance HTML5/jQuery Application](https://weblogs.asp.net/dwahlin/archive/2011/08/15/building-the-account-at-a-glance-html5-jquery-application.aspx) on Dan Wahlin's blog.</span></span>

> [!NOTE]
> <span data-ttu-id="fcd90-136">Hay muchas maneras de implementar el repositorio y unidad de patrones de trabajo.</span><span class="sxs-lookup"><span data-stu-id="fcd90-136">There are many ways to implement the repository and unit of work patterns.</span></span> <span data-ttu-id="fcd90-137">Puede usar las clases de repositorio con o sin una unidad de la clase de trabajo.</span><span class="sxs-lookup"><span data-stu-id="fcd90-137">You can use repository classes with or without a unit of work class.</span></span> <span data-ttu-id="fcd90-138">Puede implementar un único repositorio para todos los tipos de entidad, o uno para cada tipo.</span><span class="sxs-lookup"><span data-stu-id="fcd90-138">You can implement a single repository for all entity types, or one for each type.</span></span> <span data-ttu-id="fcd90-139">Si implementa una para cada tipo, puede usar clases independientes, una clase base genérica y las clases derivadas, o una clase base abstracta y las clases derivadas.</span><span class="sxs-lookup"><span data-stu-id="fcd90-139">If you implement one for each type, you can use separate classes, a generic base class and derived classes, or an abstract base class and derived classes.</span></span> <span data-ttu-id="fcd90-140">Puede incluir la lógica de negocios en el repositorio o restringirlo a la lógica de acceso a datos.</span><span class="sxs-lookup"><span data-stu-id="fcd90-140">You can include business logic in your repository or restrict it to data access logic.</span></span> <span data-ttu-id="fcd90-141">También puede crear una capa de abstracción en la clase de contexto de base de datos mediante el uso de [IDbSet](https://msdn.microsoft.com/library/gg679233(v=vs.103).aspx) hay interfaces en lugar de [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) tipos para los conjuntos de entidades.</span><span class="sxs-lookup"><span data-stu-id="fcd90-141">You can also build an abstraction layer into your database context class by using [IDbSet](https://msdn.microsoft.com/library/gg679233(v=vs.103).aspx) interfaces there instead of [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) types for your entity sets.</span></span> <span data-ttu-id="fcd90-142">El enfoque para implementar una capa de abstracción que se muestra en este tutorial es una opción para tener en cuenta, no una recomendación para todos los escenarios y entornos.</span><span class="sxs-lookup"><span data-stu-id="fcd90-142">The approach to implementing an abstraction layer shown in this tutorial is one option for you to consider, not a recommendation for all scenarios and environments.</span></span>


## <a name="creating-the-student-repository-class"></a><span data-ttu-id="fcd90-143">Creación de la clase de repositorio para estudiantes</span><span class="sxs-lookup"><span data-stu-id="fcd90-143">Creating the Student Repository Class</span></span>

<span data-ttu-id="fcd90-144">En el *DAL* carpeta, cree un archivo de clase denominado *IStudentRepository.cs* y reemplace el código existente por el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="fcd90-144">In the *DAL* folder, create a class file named *IStudentRepository.cs* and replace the existing code with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample1.cs)]

<span data-ttu-id="fcd90-145">Este código declara un conjunto típico de métodos CRUD, incluidos los dos métodos de lectura, que todos los devuelve `Student` entidades y que busca un único `Student` entidad por identificador.</span><span class="sxs-lookup"><span data-stu-id="fcd90-145">This code declares a typical set of CRUD methods, including two read methods — one that returns all `Student` entities, and one that finds a single `Student` entity by ID.</span></span>

<span data-ttu-id="fcd90-146">En el *DAL* carpeta, cree un archivo de clase denominado *StudentRepository.cs* archivo.</span><span class="sxs-lookup"><span data-stu-id="fcd90-146">In the *DAL* folder, create a class file named *StudentRepository.cs* file.</span></span> <span data-ttu-id="fcd90-147">Reemplace el código existente por el código siguiente, que implementa el `IStudentRepository` interfaz:</span><span class="sxs-lookup"><span data-stu-id="fcd90-147">Replace the existing code with the following code, which implements the `IStudentRepository` interface:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample2.cs)]

<span data-ttu-id="fcd90-148">El contexto de base de datos se define en una variable de clase y el constructor espera que el objeto de llamada para pasar una instancia del contexto:</span><span class="sxs-lookup"><span data-stu-id="fcd90-148">The database context is defined in a class variable, and the constructor expects the calling object to pass in an instance of the context:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample3.cs)]

<span data-ttu-id="fcd90-149">Puede crear una instancia de un nuevo contexto en el repositorio, pero, a continuación, si usa varios repositorios en un controlador, cada uno de ellos Baton Rouge acabaría con un contexto independiente.</span><span class="sxs-lookup"><span data-stu-id="fcd90-149">You could instantiate a new context in the repository, but then if you used multiple repositories in one controller, each would end up with a separate context.</span></span> <span data-ttu-id="fcd90-150">Más adelante usará varios repositorios en el `Course` controlador y verá cómo puede asegurarse de que todos los repositorios usan el mismo contexto de una unidad de la clase de trabajo.</span><span class="sxs-lookup"><span data-stu-id="fcd90-150">Later you'll use multiple repositories in the `Course` controller, and you'll see how a unit of work class can ensure that all repositories use the same context.</span></span>

<span data-ttu-id="fcd90-151">Implementa el repositorio [IDisposable](https://msdn.microsoft.com/library/system.idisposable.aspx) y elimina el contexto de base de datos tal como se vio anteriormente en el controlador y sus métodos CRUD realizan llamadas en el contexto de base de datos de la misma manera que vimos antes.</span><span class="sxs-lookup"><span data-stu-id="fcd90-151">The repository implements [IDisposable](https://msdn.microsoft.com/library/system.idisposable.aspx) and disposes the database context as you saw earlier in the controller, and its CRUD methods make calls to the database context in the same way that you saw earlier.</span></span>

## <a name="change-the-student-controller-to-use-the-repository"></a><span data-ttu-id="fcd90-152">Cambiar el controlador de estudiante para usar el repositorio</span><span class="sxs-lookup"><span data-stu-id="fcd90-152">Change the Student Controller to Use the Repository</span></span>

<span data-ttu-id="fcd90-153">En *StudentController.cs*, reemplace el código actualmente en la clase con el código siguiente.</span><span class="sxs-lookup"><span data-stu-id="fcd90-153">In *StudentController.cs*, replace the code currently in the class with the following code.</span></span> <span data-ttu-id="fcd90-154">Los cambios aparecen resaltados.</span><span class="sxs-lookup"><span data-stu-id="fcd90-154">The changes are highlighted.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample4.cs?highlight=13-18,44,75,77,102-103,120,137-138,159,172-174,186)]

<span data-ttu-id="fcd90-155">El controlador ahora declara una variable de clase para un objeto que implementa el `IStudentRepository` interfaz en lugar de la clase de contexto:</span><span class="sxs-lookup"><span data-stu-id="fcd90-155">The controller now declares a class variable for an object that implements the `IStudentRepository` interface instead of the context class:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample5.cs)]

<span data-ttu-id="fcd90-156">El constructor predeterminado (sin parámetros) crea una nueva instancia de contexto y un constructor opcional permite al llamador pasar una instancia de contexto.</span><span class="sxs-lookup"><span data-stu-id="fcd90-156">The default (parameterless) constructor creates a new context instance, and an optional constructor allows the caller to pass in a context instance.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample6.cs)]

<span data-ttu-id="fcd90-157">(Si estaba usando *inserción de dependencias*, o la inserción de dependencias, no necesitaría el constructor predeterminado porque el software de DI garantizará que siempre se les ofrecerá el objeto de repositorio correcto.)</span><span class="sxs-lookup"><span data-stu-id="fcd90-157">(If you were using *dependency injection*, or DI, you wouldn't need the default constructor because the DI software would ensure that the correct repository object would always be provided.)</span></span>

<span data-ttu-id="fcd90-158">En los métodos CRUD, el repositorio se denomina ahora en lugar del contexto:</span><span class="sxs-lookup"><span data-stu-id="fcd90-158">In the CRUD methods, the repository is now called instead of the context:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample7.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample8.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample9.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample10.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample11.cs)]

<span data-ttu-id="fcd90-159">Y el `Dispose` método desecha ahora el repositorio en lugar del contexto:</span><span class="sxs-lookup"><span data-stu-id="fcd90-159">And the `Dispose` method now disposes the repository instead of the context:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample12.cs)]

<span data-ttu-id="fcd90-160">Ejecute el sitio Web y haga clic en el **estudiantes** ficha.</span><span class="sxs-lookup"><span data-stu-id="fcd90-160">Run the site and click the **Students** tab.</span></span>

![Students_Index_page](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image1.png)

<span data-ttu-id="fcd90-162">La página parece y funciona igual que lo hacía antes de cambiar el código para usar el repositorio y las otras páginas de alumno también funcionan igual.</span><span class="sxs-lookup"><span data-stu-id="fcd90-162">The page looks and works the same as it did before you changed the code to use the repository, and the other Student pages also work the same.</span></span> <span data-ttu-id="fcd90-163">Sin embargo, hay una diferencia importante en la forma en la `Index` hace el método del controlador de filtrado y ordenación.</span><span class="sxs-lookup"><span data-stu-id="fcd90-163">However, there's an important difference in the way the `Index` method of the controller does filtering and ordering.</span></span> <span data-ttu-id="fcd90-164">La versión original de este método contiene el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="fcd90-164">The original version of this method contained the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample13.cs?highlight=1)]

<span data-ttu-id="fcd90-165">La actualización `Index` método contiene el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="fcd90-165">The updated `Index` method contains the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample14.cs?highlight=1)]

<span data-ttu-id="fcd90-166">Solo el código resaltado ha cambiado.</span><span class="sxs-lookup"><span data-stu-id="fcd90-166">Only the highlighted code has changed.</span></span>

<span data-ttu-id="fcd90-167">En la versión original del código, `students` se escribe como un `IQueryable` objeto.</span><span class="sxs-lookup"><span data-stu-id="fcd90-167">In the original version of the code, `students` is typed as an `IQueryable` object.</span></span> <span data-ttu-id="fcd90-168">La consulta no se envía a la base de datos hasta que se convierte en una colección mediante un método como `ToList`, que no se produce hasta que la vista de índice tiene acceso al modelo de estudiante.</span><span class="sxs-lookup"><span data-stu-id="fcd90-168">The query isn't sent to the database until it's converted into a collection using a method such as `ToList`, which doesn't occur until the Index view accesses the student model.</span></span> <span data-ttu-id="fcd90-169">El `Where` método en el código original anterior se convierte en un `WHERE` cláusula de la consulta SQL que se envía a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="fcd90-169">The `Where` method in the original code above becomes a `WHERE` clause in the SQL query that is sent to the database.</span></span> <span data-ttu-id="fcd90-170">A su vez, esto significa que se devuelven solo las entidades seleccionadas por la base de datos.</span><span class="sxs-lookup"><span data-stu-id="fcd90-170">That in turn means that only the selected entities are returned by the database.</span></span> <span data-ttu-id="fcd90-171">Sin embargo, como resultado de cambiar `context.Students` a `studentRepository.GetStudents()`, `students` variable después de esta instrucción es un `IEnumerable` recopilación que incluye todos los alumnos en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="fcd90-171">However, as a result of changing `context.Students` to `studentRepository.GetStudents()`, the `students` variable after this statement is an `IEnumerable` collection that includes all students in the database.</span></span> <span data-ttu-id="fcd90-172">El resultado final de la aplicación de la `Where` método es el mismo, pero ahora el trabajo se realiza en la memoria en el servidor web y no por la base de datos.</span><span class="sxs-lookup"><span data-stu-id="fcd90-172">The end result of applying the `Where` method is the same, but now the work is done in memory on the web server and not by the database.</span></span> <span data-ttu-id="fcd90-173">Para las consultas que devuelven grandes volúmenes de datos, esto puede ser ineficaz.</span><span class="sxs-lookup"><span data-stu-id="fcd90-173">For queries that return large volumes of data, this can be inefficient.</span></span>

> [!TIP]
> 
> **<span data-ttu-id="fcd90-174">Vs IQueryable. IEnumerable</span><span class="sxs-lookup"><span data-stu-id="fcd90-174">IQueryable vs. IEnumerable</span></span>**
> 
> <span data-ttu-id="fcd90-175">Después de implementar el repositorio, como se muestra aquí, incluso si escribe algo en el **búsqueda** cuadro de la consulta enviada a SQL Server devuelve todas las filas de alumnos porque no incluye los criterios de búsqueda:</span><span class="sxs-lookup"><span data-stu-id="fcd90-175">After you implement the repository as shown here, even if you enter something in the **Search** box the query sent to SQL Server returns all Student rows because it doesn't include your search criteria:</span></span>
> 
> ![](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image2.png)
> 
> [!code-sql[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample15.sql)]
> 
> <span data-ttu-id="fcd90-176">Esta consulta devuelve todos los datos de estudiante, dado que el repositorio ejecuta la consulta sin saber acerca de los criterios de búsqueda.</span><span class="sxs-lookup"><span data-stu-id="fcd90-176">This query returns all of the student data because the repository executed the query without knowing about the search criteria.</span></span> <span data-ttu-id="fcd90-177">El proceso de ordenación, aplicar los criterios de búsqueda y seleccionar un subconjunto de los datos para la paginación (mostrando solo 3 filas en este caso) se realiza en la memoria más adelante cuando el `ToPagedList` se llama al método en el `IEnumerable` colección.</span><span class="sxs-lookup"><span data-stu-id="fcd90-177">The process of sorting, applying search criteria, and selecting a subset of the data for paging (showing only 3 rows in this case) is done in memory later when the `ToPagedList` method is called on the `IEnumerable` collection.</span></span>
> 
> <span data-ttu-id="fcd90-178">En la versión anterior del código (antes de implementar el repositorio), la consulta no se envía a la base de datos hasta después de aplicar los criterios de búsqueda, cuando `ToPagedList` se llama en el `IQueryable` objeto.</span><span class="sxs-lookup"><span data-stu-id="fcd90-178">In the previous version of the code (before you implemented the repository), the query is not sent to the database until after you apply the search criteria, when `ToPagedList` is called on the `IQueryable` object.</span></span>
> 
> ![](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image3.png)
> 
> <span data-ttu-id="fcd90-179">Cuando se llama a ToPagedList en un `IQueryable` de objetos, la consulta enviada al servidor SQL especifica la cadena de búsqueda y como resultado se devuelven solo las filas que cumplen los criterios de búsqueda y ningún filtrado debe hacerse en la memoria.</span><span class="sxs-lookup"><span data-stu-id="fcd90-179">When ToPagedList is called on an `IQueryable` object, the query sent to SQL Server specifies the search string, and as a result only rows that meet the search criteria are returned, and no filtering needs to be done in memory.</span></span>
> 
> [!code-sql[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample16.sql)]
> 
> <span data-ttu-id="fcd90-180">(El siguiente tutorial explica cómo examinar las consultas enviadas a SQL Server.)</span><span class="sxs-lookup"><span data-stu-id="fcd90-180">(The following tutorial explains how to examine queries sent to SQL Server.)</span></span>


<span data-ttu-id="fcd90-181">En la sección siguiente se muestra cómo implementar métodos de repositorio que le permiten especificar que debe hacer este trabajo por la base de datos.</span><span class="sxs-lookup"><span data-stu-id="fcd90-181">The following section shows how to implement repository methods that enable you to specify that this work should be done by the database.</span></span>

<span data-ttu-id="fcd90-182">Ahora ha creado una capa de abstracción entre el controlador y el contexto de base de datos de Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="fcd90-182">You've now created an abstraction layer between the controller and the Entity Framework database context.</span></span> <span data-ttu-id="fcd90-183">Si se va a realizar pruebas con esta aplicación unitarias automatizadas, podría crear una clase de repositorio alternativo en un proyecto de prueba unitaria que implementa `IStudentRepository` *.*</span><span class="sxs-lookup"><span data-stu-id="fcd90-183">If you were going to perform automated unit testing with this application, you could create an alternative repository class in a unit test project that implements `IStudentRepository`*.*</span></span> <span data-ttu-id="fcd90-184">En lugar de llamar el contexto para leer y escribir datos, esta clase de repositorio ficticio podría manipular colecciones en memoria con el fin de probar las funciones del controlador.</span><span class="sxs-lookup"><span data-stu-id="fcd90-184">Instead of calling the context to read and write data, this mock repository class could manipulate in-memory collections in order to test controller functions.</span></span>

## <a name="implement-a-generic-repository-and-a-unit-of-work-class"></a><span data-ttu-id="fcd90-185">Implementar un repositorio genérico y una unidad de la clase de trabajo</span><span class="sxs-lookup"><span data-stu-id="fcd90-185">Implement a Generic Repository and a Unit of Work Class</span></span>

<span data-ttu-id="fcd90-186">Creación de una clase de repositorio para cada tipo de entidad podría dar lugar a una gran cantidad de código redundante y podría dar como resultado actualizaciones parciales.</span><span class="sxs-lookup"><span data-stu-id="fcd90-186">Creating a repository class for each entity type could result in a lot of redundant code, and it could result in partial updates.</span></span> <span data-ttu-id="fcd90-187">Por ejemplo, suponga que tiene que actualizar dos tipos de entidad diferente como parte de la misma transacción.</span><span class="sxs-lookup"><span data-stu-id="fcd90-187">For example, suppose you have to update two different entity types as part of the same transaction.</span></span> <span data-ttu-id="fcd90-188">Si cada uno de ellos usa una instancia de contexto de base de datos independientes, uno podría realizarse correctamente y el otro puede producir un error.</span><span class="sxs-lookup"><span data-stu-id="fcd90-188">If each uses a separate database context instance, one might succeed and the other might fail.</span></span> <span data-ttu-id="fcd90-189">Una manera de minimizar el código redundante es usar un repositorio genérico y una manera de asegurarse de que todos los repositorios utilizan el mismo contexto de base de datos (y, por tanto, coordinan todas las actualizaciones) consiste en utilizar una unidad de la clase de trabajo.</span><span class="sxs-lookup"><span data-stu-id="fcd90-189">One way to minimize redundant code is to use a generic repository, and one way to ensure that all repositories use the same database context (and thus coordinate all updates) is to use a unit of work class.</span></span>

<span data-ttu-id="fcd90-190">En esta sección del tutorial, creará un `GenericRepository` clase y un `UnitOfWork` clase y usarlos en el `Course` controlador para tener acceso a ambos el `Department` y `Course` conjuntos de entidades.</span><span class="sxs-lookup"><span data-stu-id="fcd90-190">In this section of the tutorial, you'll create a `GenericRepository` class and a `UnitOfWork` class, and use them in the `Course` controller to access both the `Department` and the `Course` entity sets.</span></span> <span data-ttu-id="fcd90-191">Como se explicó anteriormente, para que esta parte del tutorial resulte sencillo, que no está creando las interfaces de estas clases.</span><span class="sxs-lookup"><span data-stu-id="fcd90-191">As explained earlier, to keep this part of the tutorial simple, you aren't creating interfaces for these classes.</span></span> <span data-ttu-id="fcd90-192">Pero si se va a usarlas para facilitar el TDD, normalmente desea implementarlos con interfaces de la misma manera que el `Student` repositorio.</span><span class="sxs-lookup"><span data-stu-id="fcd90-192">But if you were going to use them to facilitate TDD, you'd typically implement them with interfaces the same way you did the `Student` repository.</span></span>

### <a name="create-a-generic-repository"></a><span data-ttu-id="fcd90-193">Crear un repositorio genérico</span><span class="sxs-lookup"><span data-stu-id="fcd90-193">Create a Generic Repository</span></span>

<span data-ttu-id="fcd90-194">En el *DAL* carpeta, cree *GenericRepository.cs* y reemplace el código existente por el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="fcd90-194">In the *DAL* folder, create *GenericRepository.cs* and replace the existing code with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample17.cs)]

<span data-ttu-id="fcd90-195">Se declaran las variables de clase para el contexto de base de datos y el conjunto de entidades que se crea una instancia del repositorio para:</span><span class="sxs-lookup"><span data-stu-id="fcd90-195">Class variables are declared for the database context and for the entity set that the repository is instantiated for:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample18.cs)]

<span data-ttu-id="fcd90-196">El constructor acepta una instancia de contexto de base de datos e inicializa la variable de conjunto de entidades:</span><span class="sxs-lookup"><span data-stu-id="fcd90-196">The constructor accepts a database context instance and initializes the entity set variable:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample19.cs)]

<span data-ttu-id="fcd90-197">El `Get` método usa las expresiones lambda para permitir que el código de llamada especificar una condición de filtro y una columna para ordenar los resultados por y un parámetro de cadena permite al llamador proporcionar una lista delimitada por comas de las propiedades de navegación para la carga diligente:</span><span class="sxs-lookup"><span data-stu-id="fcd90-197">The `Get` method uses lambda expressions to allow the calling code to specify a filter condition and a column to order the results by, and a string parameter lets the caller provide a comma-delimited list of navigation properties for eager loading:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample20.cs)]

<span data-ttu-id="fcd90-198">El código `Expression<Func<TEntity, bool>> filter` significa que el llamador proporcionará una expresión lambda basada en la `TEntity` tipo y esta expresión devolverá un valor booleano.</span><span class="sxs-lookup"><span data-stu-id="fcd90-198">The code `Expression<Func<TEntity, bool>> filter` means the caller will provide a lambda expression based on the `TEntity` type, and this expression will return a Boolean value.</span></span> <span data-ttu-id="fcd90-199">Por ejemplo, si el repositorio se crea una instancia de la `Student` tipo de entidad, puede especificar el código del método de llamada `student => student.LastName == "Smith` &quot; para el `filter` parámetro.</span><span class="sxs-lookup"><span data-stu-id="fcd90-199">For example, if the repository is instantiated for the `Student` entity type, the code in the calling method might specify `student => student.LastName == "Smith`&quot; for the `filter` parameter.</span></span>

<span data-ttu-id="fcd90-200">El código `Func<IQueryable<TEntity>, IOrderedQueryable<TEntity>> orderBy` también significa que el llamador proporcionará una expresión lambda.</span><span class="sxs-lookup"><span data-stu-id="fcd90-200">The code `Func<IQueryable<TEntity>, IOrderedQueryable<TEntity>> orderBy` also means the caller will provide a lambda expression.</span></span> <span data-ttu-id="fcd90-201">Pero en este caso, la entrada a la expresión es un `IQueryable` de objeto para el `TEntity` tipo.</span><span class="sxs-lookup"><span data-stu-id="fcd90-201">But in this case, the input to the expression is an `IQueryable` object for the `TEntity` type.</span></span> <span data-ttu-id="fcd90-202">La expresión devolverá una versión ordenada de dicho `IQueryable` objeto.</span><span class="sxs-lookup"><span data-stu-id="fcd90-202">The expression will return an ordered version of that `IQueryable` object.</span></span> <span data-ttu-id="fcd90-203">Por ejemplo, si el repositorio se crea una instancia de la `Student` tipo de entidad, puede especificar el código del método de llamada `q => q.OrderBy(s => s.LastName)` para el `orderBy` parámetro.</span><span class="sxs-lookup"><span data-stu-id="fcd90-203">For example, if the repository is instantiated for the `Student` entity type, the code in the calling method might specify `q => q.OrderBy(s => s.LastName)` for the `orderBy` parameter.</span></span>

<span data-ttu-id="fcd90-204">El código en el `Get` método crea un `IQueryable` de objetos y, a continuación, se aplica la expresión de filtro si hay alguno:</span><span class="sxs-lookup"><span data-stu-id="fcd90-204">The code in the `Get` method creates an `IQueryable` object and then applies the filter expression if there is one:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample21.cs)]

<span data-ttu-id="fcd90-205">A continuación se aplica la carga diligente de expresiones después de analizar la lista delimitada por comas:</span><span class="sxs-lookup"><span data-stu-id="fcd90-205">Next it applies the eager-loading expressions after parsing the comma-delimited list:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample22.cs)]

<span data-ttu-id="fcd90-206">Por último, se aplica el `orderBy` expresión si lo hay y devuelve los resultados; en caso contrario devuelve los resultados de la consulta no ordenada:</span><span class="sxs-lookup"><span data-stu-id="fcd90-206">Finally, it applies the `orderBy` expression if there is one and returns the results; otherwise it returns the results from the unordered query:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample23.cs)]

<span data-ttu-id="fcd90-207">Cuando se llama a la `Get` método, podría hacer el filtrado y ordenación en el `IEnumerable` colección devuelta por el método en lugar de proporcionar parámetros para estas funciones.</span><span class="sxs-lookup"><span data-stu-id="fcd90-207">When you call the `Get` method, you could do filtering and sorting on the `IEnumerable` collection returned by the method instead of providing parameters for these functions.</span></span> <span data-ttu-id="fcd90-208">Pero la ordenación y filtrado de trabajo, a continuación, se haría en la memoria en el servidor web.</span><span class="sxs-lookup"><span data-stu-id="fcd90-208">But the sorting and filtering work would then be done in memory on the web server.</span></span> <span data-ttu-id="fcd90-209">Con estos parámetros, se asegura de que el trabajo se realiza mediante la base de datos en lugar de en el servidor web.</span><span class="sxs-lookup"><span data-stu-id="fcd90-209">By using these parameters, you ensure that the work is done by the database rather than the web server.</span></span> <span data-ttu-id="fcd90-210">Una alternativa es crear las clases derivadas para tipos de entidad específico y agregue especializada `Get` métodos, como `GetStudentsInNameOrder` o `GetStudentsByName`.</span><span class="sxs-lookup"><span data-stu-id="fcd90-210">An alternative is to create derived classes for specific entity types and add specialized `Get` methods, such as `GetStudentsInNameOrder` or `GetStudentsByName`.</span></span> <span data-ttu-id="fcd90-211">Sin embargo, en una aplicación compleja, esto puede dar lugar a un gran número de estos métodos especializados, lo que sería más trabajo para mantener y clases derivadas.</span><span class="sxs-lookup"><span data-stu-id="fcd90-211">However, in a complex application, this can result in a large number of such derived classes and specialized methods, which could be more work to maintain.</span></span>

<span data-ttu-id="fcd90-212">El código en el `GetByID`, `Insert`, y `Update` métodos es similar a lo que vio en el repositorio no genérico.</span><span class="sxs-lookup"><span data-stu-id="fcd90-212">The code in the `GetByID`, `Insert`, and `Update` methods is similar to what you saw in the non-generic repository.</span></span> <span data-ttu-id="fcd90-213">(No se proporciona un parámetro de la carga diligente en la `GetByID` firma, ya que no puede realizar la carga diligente con el `Find` método.)</span><span class="sxs-lookup"><span data-stu-id="fcd90-213">(You aren't providing an eager loading parameter in the `GetByID` signature, because you can't do eager loading with the `Find` method.)</span></span>

<span data-ttu-id="fcd90-214">Se proporcionan dos sobrecargas para el `Delete` método:</span><span class="sxs-lookup"><span data-stu-id="fcd90-214">Two overloads are provided for the `Delete` method:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample24.cs)]

<span data-ttu-id="fcd90-215">Uno de estos permite pase solo el identificador de la entidad que se puede eliminar y uno toma una instancia de entidad.</span><span class="sxs-lookup"><span data-stu-id="fcd90-215">One of these lets you pass in just the ID of the entity to be deleted, and one takes an entity instance.</span></span> <span data-ttu-id="fcd90-216">Como se vio en el [control de simultaneidad](../../getting-started/getting-started-with-ef-using-mvc/handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md) tutorial, necesita el control de simultaneidad un `Delete` método que toma una instancia de entidad que incluye el valor original de una propiedad de seguimiento.</span><span class="sxs-lookup"><span data-stu-id="fcd90-216">As you saw in the [Handling Concurrency](../../getting-started/getting-started-with-ef-using-mvc/handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md) tutorial, for concurrency handling you need a `Delete` method that takes an entity instance that includes the original value of a tracking property.</span></span>

<span data-ttu-id="fcd90-217">Este repositorio genérico controlará requisitos típicos de CRUD.</span><span class="sxs-lookup"><span data-stu-id="fcd90-217">This generic repository will handle typical CRUD requirements.</span></span> <span data-ttu-id="fcd90-218">Cuando un tipo de entidad concreto tiene requisitos especiales, como el filtrado más complejas o la ordenación, puede crear una clase derivada que tiene métodos adicionales para ese tipo.</span><span class="sxs-lookup"><span data-stu-id="fcd90-218">When a particular entity type has special requirements, such as more complex filtering or ordering, you can create a derived class that has additional methods for that type.</span></span>

## <a name="creating-the-unit-of-work-class"></a><span data-ttu-id="fcd90-219">Creación de la unidad de la clase de trabajo</span><span class="sxs-lookup"><span data-stu-id="fcd90-219">Creating the Unit of Work Class</span></span>

<span data-ttu-id="fcd90-220">La unidad de la clase de trabajo tiene una finalidad: para asegurarse de que, cuando se usan en varios repositorios, comparten un contexto de base de datos única.</span><span class="sxs-lookup"><span data-stu-id="fcd90-220">The unit of work class serves one purpose: to make sure that when you use multiple repositories, they share a single database context.</span></span> <span data-ttu-id="fcd90-221">De este modo, cuando se completa una unidad de trabajo se puede llamar a la `SaveChanges` método en esa instancia del contexto y se garantiza que todos los relacionados se coordina los cambios.</span><span class="sxs-lookup"><span data-stu-id="fcd90-221">That way, when a unit of work is complete you can call the `SaveChanges` method on that instance of the context and be assured that all related changes will be coordinated.</span></span> <span data-ttu-id="fcd90-222">Todo lo que las necesidades de la clase es un `Save` método y una propiedad de cada repositorio.</span><span class="sxs-lookup"><span data-stu-id="fcd90-222">All that the class needs is a `Save` method and a property for each repository.</span></span> <span data-ttu-id="fcd90-223">Cada propiedad repository devuelve una instancia de repositorio que se ha creado una instancia con la misma instancia de contexto de base de datos como las demás instancias de repositorio.</span><span class="sxs-lookup"><span data-stu-id="fcd90-223">Each repository property returns a repository instance that has been instantiated using the same database context instance as the other repository instances.</span></span>

<span data-ttu-id="fcd90-224">En el *DAL* carpeta, cree un archivo de clase denominado *UnitOfWork.cs* y reemplace el código de plantilla con el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="fcd90-224">In the *DAL* folder, create a class file named *UnitOfWork.cs* and replace the template code with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample25.cs)]

<span data-ttu-id="fcd90-225">El código crea las variables de clase para el contexto de base de datos y cada repositorio.</span><span class="sxs-lookup"><span data-stu-id="fcd90-225">The code creates class variables for the database context and each repository.</span></span> <span data-ttu-id="fcd90-226">Para el `context` variable, se crea un nuevo contexto:</span><span class="sxs-lookup"><span data-stu-id="fcd90-226">For the `context` variable, a new context is instantiated:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample26.cs)]

<span data-ttu-id="fcd90-227">Cada propiedad repository comprueba si el repositorio ya existe.</span><span class="sxs-lookup"><span data-stu-id="fcd90-227">Each repository property checks whether the repository already exists.</span></span> <span data-ttu-id="fcd90-228">Si no es así, crea una instancia del repositorio, pasando la instancia de contexto.</span><span class="sxs-lookup"><span data-stu-id="fcd90-228">If not, it instantiates the repository, passing in the context instance.</span></span> <span data-ttu-id="fcd90-229">Como resultado, todos los repositorios comparten la misma instancia de contexto.</span><span class="sxs-lookup"><span data-stu-id="fcd90-229">As a result, all repositories share the same context instance.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample27.cs)]

<span data-ttu-id="fcd90-230">El `Save` llamadas al método `SaveChanges` en el contexto de base de datos.</span><span class="sxs-lookup"><span data-stu-id="fcd90-230">The `Save` method calls `SaveChanges` on the database context.</span></span>

<span data-ttu-id="fcd90-231">Al igual que cualquier clase que crea una instancia de un contexto de base de datos en una variable de clase, el `UnitOfWork` la clase implementa `IDisposable` y elimina el contexto.</span><span class="sxs-lookup"><span data-stu-id="fcd90-231">Like any class that instantiates a database context in a class variable, the `UnitOfWork` class implements `IDisposable` and disposes the context.</span></span>

### <a name="changing-the-course-controller-to-use-the-unitofwork-class-and-repositories"></a><span data-ttu-id="fcd90-232">Cambiar el controlador de curso para usar la clase UnitOfWork y repositorios</span><span class="sxs-lookup"><span data-stu-id="fcd90-232">Changing the Course Controller to use the UnitOfWork Class and Repositories</span></span>

<span data-ttu-id="fcd90-233">Reemplace el código que tiene actualmente en *CourseController.cs* con el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="fcd90-233">Replace the code you currently have in *CourseController.cs* with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample28.cs?highlight=15,20,22,31,54-55,70,85-86,101-102,122-124,130)]

<span data-ttu-id="fcd90-234">Este código agrega una variable de clase para el `UnitOfWork` clase.</span><span class="sxs-lookup"><span data-stu-id="fcd90-234">This code adds a class variable for the `UnitOfWork` class.</span></span> <span data-ttu-id="fcd90-235">(Si estaba usando interfaces aquí, que no inicializa la variable aquí; en su lugar, podría implementar un patrón de los dos constructores tal como hizo el `Student` repositorio.)</span><span class="sxs-lookup"><span data-stu-id="fcd90-235">(If you were using interfaces here, you wouldn't initialize the variable here; instead, you'd implement a pattern of two constructors just as you did for the `Student` repository.)</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample29.cs)]

<span data-ttu-id="fcd90-236">En el resto de la clase, todas las referencias en el contexto de base de datos se reemplazan por las referencias en el repositorio adecuado, con `UnitOfWork` propiedades para obtener acceso al repositorio.</span><span class="sxs-lookup"><span data-stu-id="fcd90-236">In the rest of the class, all references to the database context are replaced by references to the appropriate repository, using `UnitOfWork` properties to access the repository.</span></span> <span data-ttu-id="fcd90-237">El `Dispose` método desecha el `UnitOfWork` instancia.</span><span class="sxs-lookup"><span data-stu-id="fcd90-237">The `Dispose` method disposes the `UnitOfWork` instance.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample30.cs)]

<span data-ttu-id="fcd90-238">Ejecute el sitio Web y haga clic en el **cursos** ficha.</span><span class="sxs-lookup"><span data-stu-id="fcd90-238">Run the site and click the **Courses** tab.</span></span>

![Courses_Index_page](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image4.png)

<span data-ttu-id="fcd90-240">La página parece y funciona tal como lo hacía antes de los cambios y las otras páginas del curso también funcionan igual.</span><span class="sxs-lookup"><span data-stu-id="fcd90-240">The page looks and works the same as it did before your changes, and the other Course pages also work the same.</span></span>

## <a name="summary"></a><span data-ttu-id="fcd90-241">Resumen</span><span class="sxs-lookup"><span data-stu-id="fcd90-241">Summary</span></span>

<span data-ttu-id="fcd90-242">Se han implementado el repositorio y la unidad de patrones de trabajo.</span><span class="sxs-lookup"><span data-stu-id="fcd90-242">You have now implemented both the repository and unit of work patterns.</span></span> <span data-ttu-id="fcd90-243">Ha usado las expresiones lambda como parámetros de método en el repositorio genérico.</span><span class="sxs-lookup"><span data-stu-id="fcd90-243">You have used lambda expressions as method parameters in the generic repository.</span></span> <span data-ttu-id="fcd90-244">Para obtener más información sobre cómo usar estas expresiones con un `IQueryable` de objetos, consulte [IQueryable(T) interfaz (System.Linq)](https://msdn.microsoft.com/library/bb351562.aspx) en MSDN Library.</span><span class="sxs-lookup"><span data-stu-id="fcd90-244">For more information about how to use these expressions with an `IQueryable` object, see [IQueryable(T) Interface (System.Linq)](https://msdn.microsoft.com/library/bb351562.aspx) in the MSDN Library.</span></span> <span data-ttu-id="fcd90-245">En el siguiente tutorial, obtendrá información sobre cómo controlar algunos escenarios avanzados.</span><span class="sxs-lookup"><span data-stu-id="fcd90-245">In the next tutorial you'll learn how to handle some advanced scenarios.</span></span>

<span data-ttu-id="fcd90-246">Pueden encontrar vínculos a otros recursos de Entity Framework en el [mapa de contenido de acceso de datos de ASP.NET](../../../../whitepapers/aspnet-data-access-content-map.md).</span><span class="sxs-lookup"><span data-stu-id="fcd90-246">Links to other Entity Framework resources can be found in the [ASP.NET Data Access Content Map](../../../../whitepapers/aspnet-data-access-content-map.md).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="fcd90-247">[Anterior](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application.md)
> [Siguiente](advanced-entity-framework-scenarios-for-an-mvc-web-application.md)</span><span class="sxs-lookup"><span data-stu-id="fcd90-247">[Previous](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application.md)
[Next](advanced-entity-framework-scenarios-for-an-mvc-web-application.md)</span></span>
