---
uid: aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
title: Middleware de OWIN en IIS integrado canalización | Microsoft Docs
author: Praburaj
description: En este artículo se muestra cómo ejecutar componentes de middleware OWIN (OMCs) en la canalización integrada de IIS, y cómo establecer el evento de la canalización un OMC se ejecuta en. Debería...
ms.author: riande
ms.date: 11/07/2013
ms.assetid: d031c021-33c2-45a5-bf9f-98f8fa78c2ab
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
msc.type: authoredcontent
ms.openlocfilehash: bb1211de0a3fe876f5640538034ab5a58b3a070c
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 05/06/2019
ms.locfileid: "65118225"
---
# <a name="owin-middleware-in-the-iis-integrated-pipeline"></a><span data-ttu-id="d1fe9-104">Middleware de OWIN en la canalización integrada de IIS</span><span class="sxs-lookup"><span data-stu-id="d1fe9-104">OWIN Middleware in the IIS integrated pipeline</span></span>

<span data-ttu-id="d1fe9-105">por [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson]((https://twitter.com/RickAndMSFT))</span><span class="sxs-lookup"><span data-stu-id="d1fe9-105">by [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson]((https://twitter.com/RickAndMSFT))</span></span>

> <span data-ttu-id="d1fe9-106">En este artículo se muestra cómo ejecutar componentes de middleware OWIN (OMCs) en la canalización integrada de IIS, y cómo establecer el evento de la canalización un OMC se ejecuta en.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-106">This article shows how to run OWIN middleware Components (OMCs) in the IIS integrated pipeline, and how to set the pipeline event an OMC runs on.</span></span> <span data-ttu-id="d1fe9-107">Debe revisar [una visión general del proyecto Katana](an-overview-of-project-katana.md) y [detección de clase de inicio OWIN](owin-startup-class-detection.md) antes de leer este tutorial.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-107">You should review [An Overview of Project Katana](an-overview-of-project-katana.md) and [OWIN Startup Class Detection](owin-startup-class-detection.md) before reading this tutorial.</span></span> <span data-ttu-id="d1fe9-108">En este tutorial se escribió por Rick Anderson ( [ @RickAndMSFT ](https://twitter.com/#!/RickAndMSFT) ), Howard Dierking, Chris Ross y Praburaj Thiagarajan ( [ @howard \_dierking](https://twitter.com/howard_dierking) ).</span><span class="sxs-lookup"><span data-stu-id="d1fe9-108">This tutorial was written by Rick Anderson ( [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT) ), Chris Ross, Praburaj Thiagarajan, and Howard Dierking ( [@howard\_dierking](https://twitter.com/howard_dierking) ).</span></span>

<span data-ttu-id="d1fe9-109">Aunque [OWIN](an-overview-of-project-katana.md) componentes de middleware (OMCs) están diseñados principalmente para ejecutarse en una canalización independiente del servidor, es posible ejecutar una OMC en así la canalización integrada de IIS (**es el modo clásico *no* admite**).</span><span class="sxs-lookup"><span data-stu-id="d1fe9-109">Although [OWIN](an-overview-of-project-katana.md) middleware components (OMCs) are primarily designed to run in a server-agnostic pipeline, it is possible to run an OMC in the IIS integrated pipeline as well (**classic mode is *not* supported**).</span></span> <span data-ttu-id="d1fe9-110">¿Se pueden hacer un OMC para trabajar en la canalización integrada de IIS al instalar el paquete siguiente desde la consola de administrador de paquetes (PMC):</span><span class="sxs-lookup"><span data-stu-id="d1fe9-110">An OMC can be made to work in the IIS integrated pipeline by installing the following package from the Package Manager Console (PMC):</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample1.cmd)]

<span data-ttu-id="d1fe9-111">Esto significa que todos los marcos de aplicaciones, incluso aquellos que no son capaz de ejecutar fuera de IIS o System.Web, pueden beneficiarse de los componentes de middleware OWIN existentes.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-111">This means that all application frameworks, even those that are not yet able to run outside of IIS and System.Web, can benefit from existing OWIN middleware components.</span></span> 

> [!NOTE]
> <span data-ttu-id="d1fe9-112">Todos los `Microsoft.Owin.Security.*` paquetes trasvase de registros con el nuevo sistema de identidad en Visual Studio 2013 (por ejemplo: Las cookies, Account de Microsoft, Google, Facebook, Twitter, [el Token de portador](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html), OAuth, servidor de autorización, JWT, Azure Active directory y servicios de federación de Active Directory) se crean como OMCs y puede usarse en ambos autohospedado y en escenarios hospedados por IIS.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-112">All of the `Microsoft.Owin.Security.*` packages shipping with the new Identity System in Visual Studio 2013 (for example: Cookies, Microsoft Account, Google, Facebook, Twitter, [Bearer Token](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html), OAuth, Authorization server, JWT, Azure Active directory, and Active directory federation services) are authored as OMCs, and can be used in both self-hosted and IIS-hosted scenarios.</span></span>

## <a name="how-owin-middleware-executes-in-the-iis-integrated-pipeline"></a><span data-ttu-id="d1fe9-113">Cómo se ejecuta el Middleware de OWIN en la canalización integrada de IIS</span><span class="sxs-lookup"><span data-stu-id="d1fe9-113">How OWIN Middleware Executes in the IIS Integrated Pipeline</span></span>

<span data-ttu-id="d1fe9-114">OWIN para aplicaciones de consola, la canalización de aplicación creados con el [configuración de inicio](owin-startup-class-detection.md) está establecido por el orden de los componentes se agregan utilizando la `IAppBuilder.Use` método.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-114">For OWIN console applications, the application pipeline built using the [startup configuration](owin-startup-class-detection.md) is set by the order the components are added using the `IAppBuilder.Use` method.</span></span> <span data-ttu-id="d1fe9-115">Es decir, la canalización de OWIN en la [Katana](an-overview-of-project-katana.md) en tiempo de ejecución procesará OMCs en el orden en que se han registrado con `IAppBuilder.Use`.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-115">That is, the OWIN pipeline in the [Katana](an-overview-of-project-katana.md) runtime will process OMCs in the order they were registered using `IAppBuilder.Use`.</span></span> <span data-ttu-id="d1fe9-116">En la canalización integrada de IIS se compone de la canalización de solicitudes [HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx) suscrito a un conjunto predefinido de eventos de la canalización como [BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx), [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx), etcetera.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-116">In the IIS integrated pipeline the request pipeline consists of [HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx) subscribed to a pre-defined set of the pipeline events such as [BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx), [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx), etc.</span></span>

<span data-ttu-id="d1fe9-117">Si se compara una OMC a la de un [HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx) en el mundo ASP.NET, un OMC debe estar registrado en el evento correcto de canalización predefinida.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-117">If we compare an OMC to that of an [HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx) in the ASP.NET world, an OMC must be registered to the correct pre-defined pipeline event.</span></span> <span data-ttu-id="d1fe9-118">Por ejemplo, HttpModule `MyModule` se invoca cuando llega una solicitud la [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) fase de la canalización:</span><span class="sxs-lookup"><span data-stu-id="d1fe9-118">For example, the HttpModule `MyModule` will get invoked when a request comes to the [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) stage in the pipeline:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample2.cs?highlight=10)]

<span data-ttu-id="d1fe9-119">En orden para una OMC participar en este orden de ejecución de la misma, basado en eventos, el [Katana](an-overview-of-project-katana.md) examina el código en tiempo de ejecución a través de la [configuración de inicio](owin-startup-class-detection.md) y se suscribe a cada uno de los componentes de middleware a un eventos de canalización integrada.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-119">In order for an OMC to participate in this same, event-based execution ordering, the [Katana](an-overview-of-project-katana.md) runtime code scans through the [startup configuration](owin-startup-class-detection.md) and subscribes each of the middleware components to an integrated pipeline event.</span></span> <span data-ttu-id="d1fe9-120">Por ejemplo, el siguiente código OMC y registro permite ver el registro de eventos predeterminados de los componentes de middleware.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-120">For example, the following OMC and registration code enables you to see the default event registration of middleware components.</span></span> <span data-ttu-id="d1fe9-121">(Para obtener más instrucciones sobre cómo crear una clase de inicio OWIN, consulte [detección de clase de inicio de OWIN](owin-startup-class-detection.md).)</span><span class="sxs-lookup"><span data-stu-id="d1fe9-121">(For more detailed instructions on creating an OWIN startup class, see [OWIN Startup Class Detection](owin-startup-class-detection.md).)</span></span>

1. <span data-ttu-id="d1fe9-122">Crear un proyecto de aplicación web vacía y asígnele el nombre **owin2**.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-122">Create an empty web application project and name it **owin2**.</span></span>
2. <span data-ttu-id="d1fe9-123">Desde la consola de administrador de paquetes (PMC), ejecute el siguiente comando:</span><span class="sxs-lookup"><span data-stu-id="d1fe9-123">From the Package Manager Console (PMC), run the following command:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample3.cmd)]
3. <span data-ttu-id="d1fe9-124">Agregar un `OWIN Startup Class` y asígnele el nombre `Startup`.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-124">Add an `OWIN Startup Class` and name it `Startup`.</span></span> <span data-ttu-id="d1fe9-125">Reemplace el código generado por lo siguiente (se resaltan los cambios):</span><span class="sxs-lookup"><span data-stu-id="d1fe9-125">Replace the generated code with the following (the changes are highlighted):</span></span>  

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample4.cs?highlight=5-7,15-36)]
4. <span data-ttu-id="d1fe9-126">Presione F5 para ejecutar la aplicación.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-126">Hit F5 to run the app.</span></span>

<span data-ttu-id="d1fe9-127">Establece la configuración del inicio de una canalización con componentes de middleware de tres, los dos primeros mostrar información de diagnóstico y la última de ellas responde a eventos (y también mostrar información de diagnóstico).</span><span class="sxs-lookup"><span data-stu-id="d1fe9-127">The Startup configuration sets up a pipeline with three middleware components, the first two displaying diagnostic information and the last one responding to events (and also displaying diagnostic information).</span></span> <span data-ttu-id="d1fe9-128">El `PrintCurrentIntegratedPipelineStage` método muestra un mensaje y este middleware se invoca en el evento de canalización integrada.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-128">The `PrintCurrentIntegratedPipelineStage` method displays the integrated pipeline event this middleware is invoked on and a message.</span></span> <span data-ttu-id="d1fe9-129">Las ventanas de salida muestra lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="d1fe9-129">The output windows displays the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample5.cmd)]

<span data-ttu-id="d1fe9-130">El tiempo de ejecución de Katana asigna a cada uno de los componentes de middleware OWIN a [PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) de forma predeterminada, que se corresponde con la canalización IIS [PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx).</span><span class="sxs-lookup"><span data-stu-id="d1fe9-130">The Katana runtime mapped each of the OWIN middleware components to [PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) by default, which corresponds to the IIS pipeline event [PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx).</span></span>

## <a name="stage-markers"></a><span data-ttu-id="d1fe9-131">Marcadores de escenario</span><span class="sxs-lookup"><span data-stu-id="d1fe9-131">Stage Markers</span></span>

<span data-ttu-id="d1fe9-132">Puede marcar OMCs para ejecutar en fases específicas de la canalización mediante el uso de la `IAppBuilder UseStageMarker()` método de extensión.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-132">You can mark OMCs to execute at specific stages of the pipeline by using the `IAppBuilder UseStageMarker()` extension method.</span></span> <span data-ttu-id="d1fe9-133">Para ejecutar un conjunto de componentes de middleware durante una fase determinada, insertar un marcador de fases justo después del último componente es el conjunto durante el registro.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-133">To run a set of middleware components during a particular stage, insert a stage marker right after the last component is the set during registration.</span></span> <span data-ttu-id="d1fe9-134">Hay reglas en qué fase de la canalización pueden ejecutar software intermedio y los componentes de orden se deben ejecutar (las reglas se explican más adelante en el tutorial).</span><span class="sxs-lookup"><span data-stu-id="d1fe9-134">There are rules on which stage of the pipeline you can execute middleware and the order components must run (The rules are explained later in the tutorial).</span></span> <span data-ttu-id="d1fe9-135">Agregar el `UseStageMarker` método a la `Configuration` de código como se muestra a continuación:</span><span class="sxs-lookup"><span data-stu-id="d1fe9-135">Add the `UseStageMarker` method to the `Configuration` code as shown below:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample6.cs?highlight=13,19)]

<span data-ttu-id="d1fe9-136">El `app.UseStageMarker(PipelineStage.Authenticate)` llamada configura todos los componentes de middleware registrado anteriormente (en este caso, nuestro dos componentes de diagnóstico) para ejecutarse en la fase de autenticación de la canalización.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-136">The `app.UseStageMarker(PipelineStage.Authenticate)` call configures all the previously registered middleware components (in this case, our two diagnostic components) to run on the authentication stage of the pipeline.</span></span> <span data-ttu-id="d1fe9-137">El último componente de middleware (que muestra los diagnósticos y responde a las solicitudes) que se ejecutará en el `ResolveCache` etapa (la [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx) eventos).</span><span class="sxs-lookup"><span data-stu-id="d1fe9-137">The last middleware component (which displays diagnostics and responds to requests) will run on the `ResolveCache` stage (the [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx) event).</span></span>

<span data-ttu-id="d1fe9-138">Presione F5 para ejecutar la aplicación. La ventana de salida muestra lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="d1fe9-138">Hit F5 to run the app.The output window shows the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample7.cmd)]

## <a name="stage-marker-rules"></a><span data-ttu-id="d1fe9-139">Reglas de marcador de fase</span><span class="sxs-lookup"><span data-stu-id="d1fe9-139">Stage Marker Rules</span></span>

<span data-ttu-id="d1fe9-140">Componentes de middleware de Owin (OMC) pueden configurarse para ejecutarse en los siguientes eventos de fase de canalización OWIN:</span><span class="sxs-lookup"><span data-stu-id="d1fe9-140">Owin middleware components (OMC) can be configured to run at the following OWIN pipeline stage events:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample8.cs)]

1. <span data-ttu-id="d1fe9-141">De forma predeterminada, OMCs se ejecutan en el último evento (`PreHandlerExecute`).</span><span class="sxs-lookup"><span data-stu-id="d1fe9-141">By default, OMCs run at the last event (`PreHandlerExecute`).</span></span> <span data-ttu-id="d1fe9-142">Por eso nuestro primer ejemplo de código muestra "PreExecuteRequestHandler".</span><span class="sxs-lookup"><span data-stu-id="d1fe9-142">That's why our first example code displayed "PreExecuteRequestHandler".</span></span>
2. <span data-ttu-id="d1fe9-143">Puede usar el un `app.UseStageMarker` método para registrar un OMC para ejecutar versiones anteriores, en cualquier etapa de la canalización OWIN que se muestra en el `PipelineStage` enum.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-143">You can use the a `app.UseStageMarker` method to register a OMC to run earlier, at any stage of the OWIN pipeline listed in the `PipelineStage` enum.</span></span>
3. <span data-ttu-id="d1fe9-144">La canalización OWIN y la canalización IIS está ordenado, por lo tanto, las llamadas a `app.UseStageMarker` deben estar en orden.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-144">The OWIN pipeline and the IIS pipeline is ordered, therefore calls to `app.UseStageMarker` must be in order.</span></span> <span data-ttu-id="d1fe9-145">No se puede establecer el controlador de eventos a un evento que precede al último evento registrado con en `app.UseStageMarker`.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-145">You cannot set the event handler to an event that precedes the last event registered with to `app.UseStageMarker`.</span></span> <span data-ttu-id="d1fe9-146">Por ejemplo, *después* llamada:</span><span class="sxs-lookup"><span data-stu-id="d1fe9-146">For example, *after* calling:</span></span>

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample9.cmd)]

   <span data-ttu-id="d1fe9-147">las llamadas a `app.UseStageMarker` pasando `Authenticate` o `PostAuthenticate` no se respetan y no se producirá ninguna excepción.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-147">calls to `app.UseStageMarker` passing `Authenticate` or `PostAuthenticate` will not be honored, and no exception will be thrown.</span></span> <span data-ttu-id="d1fe9-148">OMCs ejecutar en la fase más reciente, cuyo valor predeterminado es `PreHandlerExecute`.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-148">OMCs run at the latest stage, which by default is `PreHandlerExecute`.</span></span> <span data-ttu-id="d1fe9-149">Los marcadores de escenario se usan para hacer que se ejecuten en versiones anteriores.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-149">The stage markers are used to make them to run earlier.</span></span> <span data-ttu-id="d1fe9-150">Si especifica los marcadores de escenario de desorden, hemos de ida y vuelta al marcador anterior.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-150">If you specify stage markers out of order, we round to the earlier marker.</span></span> <span data-ttu-id="d1fe9-151">En otras palabras, la adición de un marcador de fases dice "Run no posterior a la fase X".</span><span class="sxs-lookup"><span data-stu-id="d1fe9-151">In other words, adding a stage marker says "Run no later than stage X".</span></span> <span data-ttu-id="d1fe9-152">Ejecución de OMC en el marcador de fases más antiguo agregado después de ellos en la canalización de OWIN.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-152">OMC's run at the earliest stage marker added after them in the OWIN pipeline.</span></span>
4. <span data-ttu-id="d1fe9-153">La fase más temprana de las llamadas a `app.UseStageMarker` wins.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-153">The earliest stage of calls to `app.UseStageMarker` wins.</span></span> <span data-ttu-id="d1fe9-154">Por ejemplo, si cambia el orden de `app.UseStageMarker` llamadas desde nuestro ejemplo anterior:</span><span class="sxs-lookup"><span data-stu-id="d1fe9-154">For example, if you switch the order of `app.UseStageMarker` calls from our previous example:</span></span>

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample10.cs?highlight=13,19)]

   <span data-ttu-id="d1fe9-155">Se mostrará la ventana de salida:</span><span class="sxs-lookup"><span data-stu-id="d1fe9-155">The output window will display:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample11.cmd)]

   <span data-ttu-id="d1fe9-156">El OMCs ejecutan todas en el `AuthenticateRequest` fase, porque el último OMC registrado con el `Authenticate` eventos y el `Authenticate` event precede a todos los demás eventos.</span><span class="sxs-lookup"><span data-stu-id="d1fe9-156">The OMCs all run in the `AuthenticateRequest` stage, because the last OMC registered with the `Authenticate` event, and the `Authenticate` event precedes all other events.</span></span>
