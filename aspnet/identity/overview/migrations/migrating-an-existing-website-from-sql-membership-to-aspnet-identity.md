---
uid: identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
title: Migración de un sitio web existente desde la pertenencia de SQL a ASP.NET Identity ASP.NET 4. x
author: Rick-Anderson
description: En este tutorial se muestran los pasos para migrar una aplicación web existente con datos de usuarios y roles creados mediante la pertenencia a SQL al nuevo ASP.NET Identity...
ms.author: riande
ms.date: 12/19/2014
ms.custom: seoapril2019
ms.assetid: 220d3d75-16b2-4240-beae-a5b534f06419
msc.legacyurl: /identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 633229cc4311d151121bf6a91b9fa8aeecca1197
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 02/19/2020
ms.locfileid: "77456158"
---
# <a name="migrating-an-existing-website-from-sql-membership-to-aspnet-identity"></a><span data-ttu-id="d8698-103">Migrar un sitio web existente desde la pertenencia de SQL a ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="d8698-103">Migrating an Existing Website from SQL Membership to ASP.NET Identity</span></span>

<span data-ttu-id="d8698-104">por [Rick Anderson](https://twitter.com/RickAndMSFT), [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="d8698-104">by [Rick Anderson](https://twitter.com/RickAndMSFT), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="d8698-105">En este tutorial se muestran los pasos necesarios para migrar una aplicación web existente con datos de roles y usuarios creados mediante la pertenencia a SQL al nuevo sistema de ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="d8698-105">This tutorial illustrates the steps to migrate an existing web application with user and role data created using SQL Membership to the new ASP.NET Identity system.</span></span> <span data-ttu-id="d8698-106">Este enfoque implica cambiar el esquema de la base de datos existente por el que necesita el ASP.NET Identity y enlazarlo en las clases antiguas y nuevas.</span><span class="sxs-lookup"><span data-stu-id="d8698-106">This approach involves changing the existing database schema to the one needed by the ASP.NET Identity and hook in the old/new classes to it.</span></span> <span data-ttu-id="d8698-107">Después de adoptar este enfoque, una vez que se haya migrado la base de datos, las actualizaciones futuras de la identidad se tratarán sin esfuerzo.</span><span class="sxs-lookup"><span data-stu-id="d8698-107">After you adopt this approach, once your database is migrated, future updates to Identity will be handled effortlessly.</span></span>

<span data-ttu-id="d8698-108">En este tutorial, se tomará una plantilla de aplicación web (formularios Web Forms) creada con Visual Studio 2010 para crear datos de usuarios y roles.</span><span class="sxs-lookup"><span data-stu-id="d8698-108">For this tutorial, we will take a web application template (Web Forms) created using Visual Studio 2010 to create user and role data.</span></span> <span data-ttu-id="d8698-109">A continuación, usaremos scripts SQL para migrar la base de datos existente a las tablas que necesita el sistema de identidad.</span><span class="sxs-lookup"><span data-stu-id="d8698-109">We will then use SQL scripts to migrate the existing database to tables needed by the Identity system.</span></span> <span data-ttu-id="d8698-110">A continuación, instalaremos los paquetes de NuGet necesarios y agregaremos nuevas páginas de administración de cuentas que usan el sistema de identidad para la administración de la pertenencia.</span><span class="sxs-lookup"><span data-stu-id="d8698-110">Next we'll install the necessary NuGet packages and add new account management pages which use the Identity system for membership management.</span></span> <span data-ttu-id="d8698-111">Como prueba de la migración, los usuarios creados mediante la pertenencia a SQL deberían poder iniciar sesión y los usuarios nuevos deben poder registrarse.</span><span class="sxs-lookup"><span data-stu-id="d8698-111">As a test of migration, users created using SQL membership should be able to log in and new users should be able to register.</span></span> <span data-ttu-id="d8698-112">Puede encontrar el ejemplo completo [aquí](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/).</span><span class="sxs-lookup"><span data-stu-id="d8698-112">You can find the complete sample [here](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/).</span></span> <span data-ttu-id="d8698-113">Vea también [migrar de la pertenencia a ASP.net a ASP.net Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).</span><span class="sxs-lookup"><span data-stu-id="d8698-113">See also [Migrating from ASP.NET Membership to ASP.NET Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).</span></span>

## <a name="getting-started"></a><span data-ttu-id="d8698-114">Introducción</span><span class="sxs-lookup"><span data-stu-id="d8698-114">Getting started</span></span>

### <a name="creating-an-application-with-sql-membership"></a><span data-ttu-id="d8698-115">Creación de una aplicación con pertenencia a SQL</span><span class="sxs-lookup"><span data-stu-id="d8698-115">Creating an application with SQL Membership</span></span>

1. <span data-ttu-id="d8698-116">Necesitamos comenzar con una aplicación existente que use la pertenencia a SQL y tenga datos de usuario y de rol.</span><span class="sxs-lookup"><span data-stu-id="d8698-116">We need to start with an existing application that uses SQL membership and has user and role data.</span></span> <span data-ttu-id="d8698-117">Para el propósito de este artículo, vamos a crear una aplicación web en Visual Studio 2010.</span><span class="sxs-lookup"><span data-stu-id="d8698-117">For the purpose of this article, let's create a web application in Visual Studio 2010.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.jpg)
2. <span data-ttu-id="d8698-118">Con la herramienta de configuración de ASP.NET, cree 2 usuarios: **oldAdminUser** y **oldUser.**</span><span class="sxs-lookup"><span data-stu-id="d8698-118">Using the ASP.NET Configuration tool, create 2 users: **oldAdminUser** and **oldUser.**</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.jpg)
3. <span data-ttu-id="d8698-119">Cree un rol denominado admin y agregue ' oldAdminUser ' como usuario en ese rol.</span><span class="sxs-lookup"><span data-stu-id="d8698-119">Create a role named Admin and add 'oldAdminUser' as a user in that role.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.png)
4. <span data-ttu-id="d8698-120">Cree una sección de administración del sitio con default. aspx.</span><span class="sxs-lookup"><span data-stu-id="d8698-120">Create an Admin section of the site with a Default.aspx.</span></span> <span data-ttu-id="d8698-121">Establezca la etiqueta de autorización en el archivo Web. config para permitir el acceso solo a los usuarios de roles de administrador.</span><span class="sxs-lookup"><span data-stu-id="d8698-121">Set the authorization tag in the web.config file to enable access only to users in Admin roles.</span></span> <span data-ttu-id="d8698-122">Puede encontrar más información aquí [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span><span class="sxs-lookup"><span data-stu-id="d8698-122">More information can be found here [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.png)
5. <span data-ttu-id="d8698-123">Vea la base de datos en Explorador de servidores para comprender las tablas creadas por el sistema de pertenencia de SQL.</span><span class="sxs-lookup"><span data-stu-id="d8698-123">View the database in Server Explorer to understand the tables created by the SQL membership system.</span></span> <span data-ttu-id="d8698-124">Los datos de inicio de sesión del usuario se almacenan en las tablas de pertenencia ASPNET\_Users y ASPNET\_, mientras que los datos de roles se almacenan en la tabla ASPNET\_roles.</span><span class="sxs-lookup"><span data-stu-id="d8698-124">The user login data is stored in the aspnet\_Users and aspnet\_Membership tables, while role data is stored in the aspnet\_Roles table.</span></span> <span data-ttu-id="d8698-125">Información sobre los usuarios en los que se almacenan roles en la tabla UsersInRoles de ASPNET\_.</span><span class="sxs-lookup"><span data-stu-id="d8698-125">Information about which users are in which roles is stored in the aspnet\_UsersInRoles table.</span></span> <span data-ttu-id="d8698-126">Para la administración básica de la pertenencia, es suficiente para portar la información de las tablas anteriores al sistema ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="d8698-126">For basic membership management it is sufficient to port the information in the above tables to the ASP.NET Identity system.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.png)

### <a name="migrating-to-visual-studio-2013"></a><span data-ttu-id="d8698-127">Migrar a Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="d8698-127">Migrating to Visual Studio 2013</span></span>

1. <span data-ttu-id="d8698-128">Instale Visual Studio Express 2013 para web o Visual Studio 2013 junto con las [actualizaciones más recientes](https://www.microsoft.com/download/details.aspx?id=44921).</span><span class="sxs-lookup"><span data-stu-id="d8698-128">Install Visual Studio Express 2013 for Web or Visual Studio 2013 along with the [latest updates](https://www.microsoft.com/download/details.aspx?id=44921).</span></span>
2. <span data-ttu-id="d8698-129">Abra el proyecto anterior en la versión instalada de Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="d8698-129">Open the above project in your installed version of Visual Studio.</span></span> <span data-ttu-id="d8698-130">Si SQL Server Express no está instalado en el equipo, se muestra un mensaje al abrir el proyecto, ya que la cadena de conexión utiliza SQL Express.</span><span class="sxs-lookup"><span data-stu-id="d8698-130">If SQL Server Express is not installed on the machine, a prompt is displayed when you open the project, since the connection string uses SQL Express.</span></span> <span data-ttu-id="d8698-131">Puede optar por instalar SQL Express o como solución alternativa cambiar la cadena de conexión a LocalDb.</span><span class="sxs-lookup"><span data-stu-id="d8698-131">You can either choose to install SQL Express or as work around change the connection string to LocalDb.</span></span> <span data-ttu-id="d8698-132">En este artículo, cambiaremos a LocalDb.</span><span class="sxs-lookup"><span data-stu-id="d8698-132">For this article we'll change it to LocalDb.</span></span>
3. <span data-ttu-id="d8698-133">Abra Web. config y cambie la cadena de conexión de. SQLExpress en (LocalDb) v 11.0.</span><span class="sxs-lookup"><span data-stu-id="d8698-133">Open web.config and change the connection string from .SQLExpress to (LocalDb)v11.0.</span></span> <span data-ttu-id="d8698-134">Quite ' User Instance = true ' de la cadena de conexión.</span><span class="sxs-lookup"><span data-stu-id="d8698-134">Remove 'User Instance=true' from the connection string.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.jpg)
4. <span data-ttu-id="d8698-135">Abra Explorador de servidores y compruebe que se pueden observar el esquema de la tabla y los datos.</span><span class="sxs-lookup"><span data-stu-id="d8698-135">Open Server Explorer and verify that the table schema and data can be observed.</span></span>
5. <span data-ttu-id="d8698-136">El sistema ASP.NET Identity funciona con la versión 4,5 o posterior del marco.</span><span class="sxs-lookup"><span data-stu-id="d8698-136">The ASP.NET Identity system works with version 4.5 or higher of the framework.</span></span> <span data-ttu-id="d8698-137">Redestinar la aplicación a 4,5 o superior.</span><span class="sxs-lookup"><span data-stu-id="d8698-137">Retarget the application to 4.5 or higher.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image5.png)

    <span data-ttu-id="d8698-138">Compile el proyecto para comprobar que no hay errores.</span><span class="sxs-lookup"><span data-stu-id="d8698-138">Build the project to verify that there are no errors.</span></span>

### <a name="installing-the-nuget-packages"></a><span data-ttu-id="d8698-139">Instalación de paquetes Nuget</span><span class="sxs-lookup"><span data-stu-id="d8698-139">Installing the Nuget packages</span></span>

1. <span data-ttu-id="d8698-140">En Explorador de soluciones, haga clic con el botón derecho en el proyecto &gt; **administrar paquetes NuGet**.</span><span class="sxs-lookup"><span data-stu-id="d8698-140">In Solution Explorer, right-click the project &gt; **Manage NuGet Packages**.</span></span> <span data-ttu-id="d8698-141">En el cuadro de búsqueda, escriba "Asp.net Identity".</span><span class="sxs-lookup"><span data-stu-id="d8698-141">In the search box, enter "Asp.net Identity".</span></span> <span data-ttu-id="d8698-142">Seleccione el paquete en la lista de resultados y haga clic en instalar.</span><span class="sxs-lookup"><span data-stu-id="d8698-142">Select the package in the list of results and click install.</span></span> <span data-ttu-id="d8698-143">Para aceptar el contrato de licencia, haga clic en el botón "Acepto".</span><span class="sxs-lookup"><span data-stu-id="d8698-143">Accept the license agreement by clicking on "I Accept" button.</span></span> <span data-ttu-id="d8698-144">Tenga en cuenta que este paquete instalará los paquetes de dependencia: EntityFramework y Microsoft ASP.NET principal de identidad.</span><span class="sxs-lookup"><span data-stu-id="d8698-144">Note that this package will install the dependency packages: EntityFramework and Microsoft ASP.NET Identity Core.</span></span> <span data-ttu-id="d8698-145">De igual forma, instale los siguientes paquetes (omita los últimos 4 paquetes OWIN si no desea habilitar el inicio de sesión de OAuth):</span><span class="sxs-lookup"><span data-stu-id="d8698-145">Similarly install the following packages (skip the last 4 OWIN packages if you don't want to enable OAuth log-in):</span></span>

   - <span data-ttu-id="d8698-146">Microsoft.AspNet.Identity.Owin</span><span class="sxs-lookup"><span data-stu-id="d8698-146">Microsoft.AspNet.Identity.Owin</span></span>
   - <span data-ttu-id="d8698-147">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="d8698-147">Microsoft.Owin.Host.SystemWeb</span></span>
   - <span data-ttu-id="d8698-148">Microsoft.Owin.Security.Facebook</span><span class="sxs-lookup"><span data-stu-id="d8698-148">Microsoft.Owin.Security.Facebook</span></span>
   - <span data-ttu-id="d8698-149">Microsoft.Owin.Security.Google</span><span class="sxs-lookup"><span data-stu-id="d8698-149">Microsoft.Owin.Security.Google</span></span>
   - <span data-ttu-id="d8698-150">Microsoft.Owin.Security.MicrosoftAccount</span><span class="sxs-lookup"><span data-stu-id="d8698-150">Microsoft.Owin.Security.MicrosoftAccount</span></span>
   - <span data-ttu-id="d8698-151">Microsoft.Owin.Security.Twitter</span><span class="sxs-lookup"><span data-stu-id="d8698-151">Microsoft.Owin.Security.Twitter</span></span>

     ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image6.png)

### <a name="migrate-database-to-the-new-identity-system"></a><span data-ttu-id="d8698-152">Migrar la base de datos al nuevo sistema de identidad</span><span class="sxs-lookup"><span data-stu-id="d8698-152">Migrate database to the new Identity system</span></span>

<span data-ttu-id="d8698-153">El siguiente paso consiste en migrar la base de datos existente a un esquema requerido por el sistema ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="d8698-153">The next step is to migrate the existing database to a schema required by the ASP.NET Identity system.</span></span> <span data-ttu-id="d8698-154">Para lograr esto, ejecutamos un script SQL que tiene un conjunto de comandos para crear nuevas tablas y migrar la información de usuario existente a las nuevas tablas.</span><span class="sxs-lookup"><span data-stu-id="d8698-154">To achieve this we run a SQL script which has a set of commands to create new tables and migrate existing user information to the new tables.</span></span> <span data-ttu-id="d8698-155">El archivo de script se puede encontrar [aquí](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/Migrations.sql).</span><span class="sxs-lookup"><span data-stu-id="d8698-155">The script file can be found [here](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/Migrations.sql).</span></span>

<span data-ttu-id="d8698-156">Este archivo de script es específico de este ejemplo.</span><span class="sxs-lookup"><span data-stu-id="d8698-156">This script file is specific to this sample.</span></span> <span data-ttu-id="d8698-157">Si el esquema de las tablas creadas mediante la pertenencia a SQL es personalizado o modificado, los scripts deben cambiarse según corresponda.</span><span class="sxs-lookup"><span data-stu-id="d8698-157">If the schema for the tables created using SQL membership is customized or modified the scripts need to be changed accordingly.</span></span>

### <a name="how-to-generate-the-sql-script-for-schema-migration"></a><span data-ttu-id="d8698-158">Cómo generar el script SQL para la migración de esquemas</span><span class="sxs-lookup"><span data-stu-id="d8698-158">How to generate the SQL script for schema migration</span></span>

<span data-ttu-id="d8698-159">Para que las clases de ASP.NET Identity funcionen de forma prebox con los datos de los usuarios existentes, es necesario migrar el esquema de la base de datos al que necesita ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="d8698-159">For ASP.NET Identity classes to work out of the box with the data of existing users, we need to migrate the database schema to the one needed by ASP.NET Identity.</span></span> <span data-ttu-id="d8698-160">Podemos hacer esto agregando nuevas tablas y copiando la información existente en esas tablas.</span><span class="sxs-lookup"><span data-stu-id="d8698-160">We can do this by adding new tables and copying the existing information to those tables.</span></span> <span data-ttu-id="d8698-161">De forma predeterminada ASP.NET Identity usa EntityFramework para volver a asignar las clases del modelo de identidad a la base de datos para almacenar o recuperar información.</span><span class="sxs-lookup"><span data-stu-id="d8698-161">By default ASP.NET Identity uses EntityFramework to map the Identity model classes back to the database to store/retrieve information.</span></span> <span data-ttu-id="d8698-162">Estas clases de modelo implementan las interfaces de identidad básicas que definen los objetos de usuario y de función.</span><span class="sxs-lookup"><span data-stu-id="d8698-162">These model classes implement the core Identity interfaces defining user and role objects.</span></span> <span data-ttu-id="d8698-163">Las tablas y las columnas de la base de datos se basan en estas clases de modelo.</span><span class="sxs-lookup"><span data-stu-id="d8698-163">The tables and the columns in the database are based on these model classes.</span></span> <span data-ttu-id="d8698-164">Las clases del modelo EntityFramework en la identidad v 2.1.0 y sus propiedades se definen a continuación.</span><span class="sxs-lookup"><span data-stu-id="d8698-164">The EntityFramework model classes in Identity v2.1.0 and their properties are as defined below</span></span>

| <span data-ttu-id="d8698-165">**IdentityUser**</span><span class="sxs-lookup"><span data-stu-id="d8698-165">**IdentityUser**</span></span> | <span data-ttu-id="d8698-166">**Tipo**</span><span class="sxs-lookup"><span data-stu-id="d8698-166">**Type**</span></span> | <span data-ttu-id="d8698-167">**IdentityRole**</span><span class="sxs-lookup"><span data-stu-id="d8698-167">**IdentityRole**</span></span> | <span data-ttu-id="d8698-168">**IdentityUserRole**</span><span class="sxs-lookup"><span data-stu-id="d8698-168">**IdentityUserRole**</span></span> | <span data-ttu-id="d8698-169">**IdentityUserLogin**</span><span class="sxs-lookup"><span data-stu-id="d8698-169">**IdentityUserLogin**</span></span> | <span data-ttu-id="d8698-170">**IdentityUserClaim**</span><span class="sxs-lookup"><span data-stu-id="d8698-170">**IdentityUserClaim**</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="d8698-171">Identificador</span><span class="sxs-lookup"><span data-stu-id="d8698-171">Id</span></span> | <span data-ttu-id="d8698-172">string</span><span class="sxs-lookup"><span data-stu-id="d8698-172">string</span></span> | <span data-ttu-id="d8698-173">Identificador</span><span class="sxs-lookup"><span data-stu-id="d8698-173">Id</span></span> | <span data-ttu-id="d8698-174">RoleId</span><span class="sxs-lookup"><span data-stu-id="d8698-174">RoleId</span></span> | <span data-ttu-id="d8698-175">ProviderKey</span><span class="sxs-lookup"><span data-stu-id="d8698-175">ProviderKey</span></span> | <span data-ttu-id="d8698-176">Identificador</span><span class="sxs-lookup"><span data-stu-id="d8698-176">Id</span></span> |
| <span data-ttu-id="d8698-177">Nombre de usuario</span><span class="sxs-lookup"><span data-stu-id="d8698-177">Username</span></span> | <span data-ttu-id="d8698-178">string</span><span class="sxs-lookup"><span data-stu-id="d8698-178">string</span></span> | <span data-ttu-id="d8698-179">Nombre</span><span class="sxs-lookup"><span data-stu-id="d8698-179">Name</span></span> | <span data-ttu-id="d8698-180">UserId</span><span class="sxs-lookup"><span data-stu-id="d8698-180">UserId</span></span> | <span data-ttu-id="d8698-181">UserId</span><span class="sxs-lookup"><span data-stu-id="d8698-181">UserId</span></span> | <span data-ttu-id="d8698-182">ClaimType</span><span class="sxs-lookup"><span data-stu-id="d8698-182">ClaimType</span></span> |
| <span data-ttu-id="d8698-183">PasswordHash</span><span class="sxs-lookup"><span data-stu-id="d8698-183">PasswordHash</span></span> | <span data-ttu-id="d8698-184">string</span><span class="sxs-lookup"><span data-stu-id="d8698-184">string</span></span> |  |  | <span data-ttu-id="d8698-185">LoginProvider</span><span class="sxs-lookup"><span data-stu-id="d8698-185">LoginProvider</span></span> | <span data-ttu-id="d8698-186">ClaimValue</span><span class="sxs-lookup"><span data-stu-id="d8698-186">ClaimValue</span></span> |
| <span data-ttu-id="d8698-187">SecurityStamp</span><span class="sxs-lookup"><span data-stu-id="d8698-187">SecurityStamp</span></span> | <span data-ttu-id="d8698-188">string</span><span class="sxs-lookup"><span data-stu-id="d8698-188">string</span></span> |  |  |  | <span data-ttu-id="d8698-189">Identificador de\_de usuario</span><span class="sxs-lookup"><span data-stu-id="d8698-189">User\_Id</span></span> |
| <span data-ttu-id="d8698-190">Email</span><span class="sxs-lookup"><span data-stu-id="d8698-190">Email</span></span> | <span data-ttu-id="d8698-191">string</span><span class="sxs-lookup"><span data-stu-id="d8698-191">string</span></span> |  |  |  |  |
| <span data-ttu-id="d8698-192">EmailConfirmed</span><span class="sxs-lookup"><span data-stu-id="d8698-192">EmailConfirmed</span></span> | <span data-ttu-id="d8698-193">bool</span><span class="sxs-lookup"><span data-stu-id="d8698-193">bool</span></span> |  |  |  |  |
| <span data-ttu-id="d8698-194">PhoneNumber</span><span class="sxs-lookup"><span data-stu-id="d8698-194">PhoneNumber</span></span> | <span data-ttu-id="d8698-195">string</span><span class="sxs-lookup"><span data-stu-id="d8698-195">string</span></span> |  |  |  |  |
| <span data-ttu-id="d8698-196">PhoneNumberConfirmed</span><span class="sxs-lookup"><span data-stu-id="d8698-196">PhoneNumberConfirmed</span></span> | <span data-ttu-id="d8698-197">bool</span><span class="sxs-lookup"><span data-stu-id="d8698-197">bool</span></span> |  |  |  |  |
| <span data-ttu-id="d8698-198">LockoutEnabled</span><span class="sxs-lookup"><span data-stu-id="d8698-198">LockoutEnabled</span></span> | <span data-ttu-id="d8698-199">bool</span><span class="sxs-lookup"><span data-stu-id="d8698-199">bool</span></span> |  |  |  |  |
| <span data-ttu-id="d8698-200">LockoutEndDate</span><span class="sxs-lookup"><span data-stu-id="d8698-200">LockoutEndDate</span></span> | <span data-ttu-id="d8698-201">DateTime</span><span class="sxs-lookup"><span data-stu-id="d8698-201">DateTime</span></span> |  |  |  |  |
| <span data-ttu-id="d8698-202">AccessFailedCount</span><span class="sxs-lookup"><span data-stu-id="d8698-202">AccessFailedCount</span></span> | <span data-ttu-id="d8698-203">int</span><span class="sxs-lookup"><span data-stu-id="d8698-203">int</span></span> |  |  |  |  |

<span data-ttu-id="d8698-204">Necesitamos tener tablas para cada uno de estos modelos con columnas que se correspondan con las propiedades.</span><span class="sxs-lookup"><span data-stu-id="d8698-204">We need to have tables for each of these models with columns corresponding to the properties.</span></span> <span data-ttu-id="d8698-205">La asignación entre las clases y las tablas se define en el método `OnModelCreating` de la `IdentityDBContext`.</span><span class="sxs-lookup"><span data-stu-id="d8698-205">The mapping between classes and tables is defined in the `OnModelCreating` method of the `IdentityDBContext`.</span></span> <span data-ttu-id="d8698-206">Esto se conoce como el método de configuración de la API fluida y se puede encontrar más información [aquí](https://msdn.microsoft.com/data/jj591617.aspx).</span><span class="sxs-lookup"><span data-stu-id="d8698-206">This is known as the fluent API method of configuration and more information can be found [here](https://msdn.microsoft.com/data/jj591617.aspx).</span></span> <span data-ttu-id="d8698-207">La configuración de las clases es como se menciona a continuación</span><span class="sxs-lookup"><span data-stu-id="d8698-207">The configuration for the classes is as mentioned below</span></span>

| <span data-ttu-id="d8698-208">**Clase**</span><span class="sxs-lookup"><span data-stu-id="d8698-208">**Class**</span></span> | <span data-ttu-id="d8698-209">**Table**</span><span class="sxs-lookup"><span data-stu-id="d8698-209">**Table**</span></span> | <span data-ttu-id="d8698-210">**Clave principal**</span><span class="sxs-lookup"><span data-stu-id="d8698-210">**Primary key**</span></span> | <span data-ttu-id="d8698-211">**Clave externa**</span><span class="sxs-lookup"><span data-stu-id="d8698-211">**Foreign key**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="d8698-212">IdentityUser</span><span class="sxs-lookup"><span data-stu-id="d8698-212">IdentityUser</span></span> | <span data-ttu-id="d8698-213">AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="d8698-213">AspnetUsers</span></span> | <span data-ttu-id="d8698-214">Identificador</span><span class="sxs-lookup"><span data-stu-id="d8698-214">Id</span></span> |  |
| <span data-ttu-id="d8698-215">IdentityRole</span><span class="sxs-lookup"><span data-stu-id="d8698-215">IdentityRole</span></span> | <span data-ttu-id="d8698-216">AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="d8698-216">AspnetRoles</span></span> | <span data-ttu-id="d8698-217">Identificador</span><span class="sxs-lookup"><span data-stu-id="d8698-217">Id</span></span> |  |
| <span data-ttu-id="d8698-218">IdentityUserRole</span><span class="sxs-lookup"><span data-stu-id="d8698-218">IdentityUserRole</span></span> | <span data-ttu-id="d8698-219">AspnetUserRole</span><span class="sxs-lookup"><span data-stu-id="d8698-219">AspnetUserRole</span></span> | <span data-ttu-id="d8698-220">UserId + RoleId</span><span class="sxs-lookup"><span data-stu-id="d8698-220">UserId + RoleId</span></span> | <span data-ttu-id="d8698-221">Identificador de\_de usuario:&gt;AspnetUsers RoleId-&gt;AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="d8698-221">User\_Id-&gt;AspnetUsers RoleId-&gt;AspnetRoles</span></span> |
| <span data-ttu-id="d8698-222">IdentityUserLogin</span><span class="sxs-lookup"><span data-stu-id="d8698-222">IdentityUserLogin</span></span> | <span data-ttu-id="d8698-223">AspnetUserLogins</span><span class="sxs-lookup"><span data-stu-id="d8698-223">AspnetUserLogins</span></span> | <span data-ttu-id="d8698-224">ProviderKey + UserId + LoginProvider</span><span class="sxs-lookup"><span data-stu-id="d8698-224">ProviderKey+UserId + LoginProvider</span></span> | <span data-ttu-id="d8698-225">UserId-&gt;AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="d8698-225">UserId-&gt;AspnetUsers</span></span> |
| <span data-ttu-id="d8698-226">IdentityUserClaim</span><span class="sxs-lookup"><span data-stu-id="d8698-226">IdentityUserClaim</span></span> | <span data-ttu-id="d8698-227">AspnetUserClaims</span><span class="sxs-lookup"><span data-stu-id="d8698-227">AspnetUserClaims</span></span> | <span data-ttu-id="d8698-228">Identificador</span><span class="sxs-lookup"><span data-stu-id="d8698-228">Id</span></span> | <span data-ttu-id="d8698-229">Identificador de\_de usuario:&gt;AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="d8698-229">User\_Id-&gt;AspnetUsers</span></span> |

<span data-ttu-id="d8698-230">Con esta información, podemos crear instrucciones SQL para crear nuevas tablas.</span><span class="sxs-lookup"><span data-stu-id="d8698-230">With this information we can create SQL statements to create new tables.</span></span> <span data-ttu-id="d8698-231">Podemos escribir cada instrucción individualmente o generar el script completo mediante los comandos de PowerShell de EntityFramework que podemos editar según sea necesario.</span><span class="sxs-lookup"><span data-stu-id="d8698-231">We can either write each statement individually or generate the entire script using EntityFramework PowerShell commands which we can then edit as required.</span></span> <span data-ttu-id="d8698-232">Para ello, en VS, abra la **consola del administrador de paquetes** desde el menú **Ver** o **herramientas** .</span><span class="sxs-lookup"><span data-stu-id="d8698-232">To do this, in VS open the **Package Manager Console** from the **View** or **Tools** menu</span></span>

- <span data-ttu-id="d8698-233">Ejecute el comando "Enable-Migrations" para habilitar las migraciones de EntityFramework.</span><span class="sxs-lookup"><span data-stu-id="d8698-233">Run command "Enable-Migrations" to enable EntityFramework migrations.</span></span>
- <span data-ttu-id="d8698-234">Ejecute el comando "Add-Migration Initial", que crea el código de instalación inicial para crear C#la base de datos en/VB.</span><span class="sxs-lookup"><span data-stu-id="d8698-234">Run command "Add-migration initial" which creates the initial setup code to create the database in C#/VB.</span></span>
- <span data-ttu-id="d8698-235">El paso final consiste en ejecutar el comando "Update-Database – script" que genera el script SQL basado en las clases de modelo.</span><span class="sxs-lookup"><span data-stu-id="d8698-235">The final step is to run "Update-Database –Script" command that generates the SQL script based on the model classes.</span></span>

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

<span data-ttu-id="d8698-236">Este script de generación de bases de datos se puede usar como un inicio en el que se van a realizar más cambios para agregar nuevas columnas y copiar los datos.</span><span class="sxs-lookup"><span data-stu-id="d8698-236">This database generation script can be used as a start where we'll be making additional changes to add new columns and copy data.</span></span> <span data-ttu-id="d8698-237">La ventaja de esto es que se genera la tabla `_MigrationHistory` que usa EntityFramework para modificar el esquema de la base de datos cuando las clases de modelo cambian en versiones futuras de las versiones de identidad.</span><span class="sxs-lookup"><span data-stu-id="d8698-237">The advantage of this is that we generate the `_MigrationHistory` table which is used by EntityFramework to modify the database schema when the model classes change for future versions of Identity releases.</span></span>

<span data-ttu-id="d8698-238">La información del usuario de pertenencia a SQL tenía otras propiedades además de las de la clase de modelo de usuario de identidad, es decir, el correo electrónico, los intentos de contraseña, la fecha de último inicio de sesión, la última fecha de bloqueo, etc. Esta información es útil y nos gustaría que se lleve a cabo en el sistema de identidades.</span><span class="sxs-lookup"><span data-stu-id="d8698-238">The SQL membership user information had other properties in addition to the ones in the Identity user model class namely email, password attempts, last login date, last lock-out date etc. This is useful information and we would like it to be carried over to the Identity system.</span></span> <span data-ttu-id="d8698-239">Esto puede hacerse agregando propiedades adicionales al modelo de usuario y asignándolos de nuevo a las columnas de la tabla en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="d8698-239">This can be done by adding additional properties to the user model and mapping them back to the table columns in the database.</span></span> <span data-ttu-id="d8698-240">Para ello, se agrega una clase que subclase el modelo de `IdentityUser`.</span><span class="sxs-lookup"><span data-stu-id="d8698-240">We can do this by adding a class that subclasses the `IdentityUser` model.</span></span> <span data-ttu-id="d8698-241">Podemos agregar las propiedades a esta clase personalizada y editar el script SQL para agregar las columnas correspondientes al crear la tabla.</span><span class="sxs-lookup"><span data-stu-id="d8698-241">We can add the properties to this custom class and edit the SQL script to add the corresponding columns when creating the table.</span></span> <span data-ttu-id="d8698-242">El código de esta clase se describe con más detalle en el artículo.</span><span class="sxs-lookup"><span data-stu-id="d8698-242">The code for this class is described further in the article.</span></span> <span data-ttu-id="d8698-243">El script SQL para crear la tabla `AspnetUsers` después de agregar las nuevas propiedades sería</span><span class="sxs-lookup"><span data-stu-id="d8698-243">The SQL script for creating the `AspnetUsers` table after adding the new properties would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample1.sql)]

<span data-ttu-id="d8698-244">A continuación, es necesario copiar la información existente de la base de datos de pertenencia a SQL en las tablas recién agregadas para la identidad.</span><span class="sxs-lookup"><span data-stu-id="d8698-244">Next we need to copy the existing information from the SQL membership database to the newly added tables for Identity.</span></span> <span data-ttu-id="d8698-245">Esto puede realizarse a través de SQL copiando los datos directamente de una tabla a otra.</span><span class="sxs-lookup"><span data-stu-id="d8698-245">This can be done through SQL by copying data directly from one table to another.</span></span> <span data-ttu-id="d8698-246">Para agregar datos a las filas de la tabla, usamos la construcción `INSERT INTO [Table]`.</span><span class="sxs-lookup"><span data-stu-id="d8698-246">To add data into the rows of table, we use the `INSERT INTO [Table]` construct.</span></span> <span data-ttu-id="d8698-247">Para copiar desde otra tabla, se puede usar la instrucción `INSERT INTO` junto con la instrucción `SELECT`.</span><span class="sxs-lookup"><span data-stu-id="d8698-247">To copy from another table we can use the `INSERT INTO` statement along with the `SELECT` statement.</span></span> <span data-ttu-id="d8698-248">Para obtener toda la información de usuario necesaria para consultar los *usuarios de aspnet\_* y las tablas de *pertenencia de ASPNET\_* y copiar los datos en la tabla *AspNetUsers* .</span><span class="sxs-lookup"><span data-stu-id="d8698-248">To get all the user information we need to query the *aspnet\_Users* and *aspnet\_Membership* tables and copy the data to the *AspNetUsers* table.</span></span> <span data-ttu-id="d8698-249">Usamos el `INSERT INTO` y `SELECT` junto con las instrucciones `JOIN` y `LEFT OUTER JOIN`.</span><span class="sxs-lookup"><span data-stu-id="d8698-249">We use the `INSERT INTO` and `SELECT` along with `JOIN` and `LEFT OUTER JOIN` statements.</span></span> <span data-ttu-id="d8698-250">Para obtener más información sobre cómo consultar y copiar datos entre tablas, consulte [este](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) vínculo.</span><span class="sxs-lookup"><span data-stu-id="d8698-250">For more information about querying and copying data between tables, refer to [this](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) link.</span></span> <span data-ttu-id="d8698-251">Además, las tablas AspnetUserLogins y AspnetUserClaims están vacías para comenzar, ya que no hay información en la pertenencia a SQL que se asigne a esta de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="d8698-251">Additionally the AspnetUserLogins and AspnetUserClaims tables are empty to begin with since there is no information in SQL membership that maps to this by default.</span></span> <span data-ttu-id="d8698-252">La única información que se copia es para usuarios y roles.</span><span class="sxs-lookup"><span data-stu-id="d8698-252">The only information copied is for users and roles.</span></span> <span data-ttu-id="d8698-253">En el caso del proyecto creado en los pasos anteriores, la consulta SQL para copiar información en la tabla de usuarios sería</span><span class="sxs-lookup"><span data-stu-id="d8698-253">For the project created in the previous steps, the SQL query to copy information to the users table would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample2.sql)]

<span data-ttu-id="d8698-254">En la instrucción SQL anterior, la información sobre cada usuario de las tablas de pertenencia de *aspnet\_users* y *ASPNET\_* se copia en las columnas de la tabla *AspnetUsers* .</span><span class="sxs-lookup"><span data-stu-id="d8698-254">In the above SQL statement, information about each user from the *aspnet\_Users* and *aspnet\_Membership* tables is copied into the columns of the *AspnetUsers* table.</span></span> <span data-ttu-id="d8698-255">La única modificación realizada aquí es cuando se copia la contraseña.</span><span class="sxs-lookup"><span data-stu-id="d8698-255">The only modification done here is when we copy the password.</span></span> <span data-ttu-id="d8698-256">Dado que el algoritmo de cifrado para contraseñas en la pertenencia a SQL usó ' PasswordSalt ' y ' PasswordFormat ', copiamos esto junto con la contraseña con hash para que se pueda usar para descifrar la contraseña por identidad.</span><span class="sxs-lookup"><span data-stu-id="d8698-256">Since the encryption algorithm for passwords in SQL membership used 'PasswordSalt' and 'PasswordFormat', we copy that too along with the hashed password so that it can be used to decrypt the password by Identity.</span></span> <span data-ttu-id="d8698-257">Esto se explica con más detalle en el artículo al enlazar un hash de contraseña personalizado.</span><span class="sxs-lookup"><span data-stu-id="d8698-257">This is explained further in the article when hooking up a custom password hasher.</span></span>

<span data-ttu-id="d8698-258">Este archivo de script es específico de este ejemplo.</span><span class="sxs-lookup"><span data-stu-id="d8698-258">This script file is specific to this sample.</span></span> <span data-ttu-id="d8698-259">En el caso de las aplicaciones que tienen tablas adicionales, los desarrolladores pueden seguir un enfoque similar para agregar propiedades adicionales a la clase de modelo de usuario y asignarlas a las columnas de la tabla AspnetUsers.</span><span class="sxs-lookup"><span data-stu-id="d8698-259">For applications which have additional tables, developers can follow a similar approach to add additional properties on the user model class and map them to columns in the AspnetUsers table.</span></span> <span data-ttu-id="d8698-260">Para ejecutar el script,</span><span class="sxs-lookup"><span data-stu-id="d8698-260">To run the script,</span></span>

1. <span data-ttu-id="d8698-261">Abra el Explorador de servidores.</span><span class="sxs-lookup"><span data-stu-id="d8698-261">Open Server Explorer.</span></span> <span data-ttu-id="d8698-262">Expanda la conexión ' ApplicationServices ' para mostrar las tablas.</span><span class="sxs-lookup"><span data-stu-id="d8698-262">Expand the 'ApplicationServices' connection to display the tables.</span></span> <span data-ttu-id="d8698-263">Haga clic con el botón derecho en el nodo tablas y seleccione la opción "nueva consulta".</span><span class="sxs-lookup"><span data-stu-id="d8698-263">Right click on the Tables node and select the 'New Query' option</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image7.png)
2. <span data-ttu-id="d8698-264">En la ventana de consulta, copie y pegue todo el script SQL del archivo Migrations. SQL.</span><span class="sxs-lookup"><span data-stu-id="d8698-264">In the query window, copy and paste the entire SQL script from the Migrations.sql file.</span></span> <span data-ttu-id="d8698-265">Ejecute el archivo de script presionando el botón de flecha "ejecutar".</span><span class="sxs-lookup"><span data-stu-id="d8698-265">Run the script file by hitting the 'Execute' arrow button.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.jpg)

    <span data-ttu-id="d8698-266">Actualice la ventana Explorador de servidores.</span><span class="sxs-lookup"><span data-stu-id="d8698-266">Refresh the Server Explorer window.</span></span> <span data-ttu-id="d8698-267">Se crean cinco tablas nuevas en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="d8698-267">Five new tables are created in the database.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image8.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image9.png)

    <span data-ttu-id="d8698-268">A continuación se muestra cómo se asigna la información de las tablas de pertenencia a SQL al nuevo sistema de identidad.</span><span class="sxs-lookup"><span data-stu-id="d8698-268">Below is how the information in the SQL membership tables are mapped to the new Identity system.</span></span>

    <span data-ttu-id="d8698-269">Roles de\_de ASPNET:&gt; AspNetRoles</span><span class="sxs-lookup"><span data-stu-id="d8698-269">aspnet\_Roles --&gt; AspNetRoles</span></span>

    <span data-ttu-id="d8698-270">ASP\_netUsers y ASP\_netMembership--&gt; AspNetUsers</span><span class="sxs-lookup"><span data-stu-id="d8698-270">asp\_netUsers and asp\_netMembership --&gt; AspNetUsers</span></span>

    <span data-ttu-id="d8698-271">ASPNET\_UserInRoles--&gt; AspNetUserRoles</span><span class="sxs-lookup"><span data-stu-id="d8698-271">aspnet\_UserInRoles --&gt; AspNetUserRoles</span></span>

    <span data-ttu-id="d8698-272">Como se explicó en la sección anterior, las tablas AspNetUserClaims y AspNetUserLogins están vacías.</span><span class="sxs-lookup"><span data-stu-id="d8698-272">As explained in the above section, the AspNetUserClaims and AspNetUserLogins tables are empty.</span></span> <span data-ttu-id="d8698-273">El campo ' discriminador ' de la tabla AspNetUser debe coincidir con el nombre de la clase de modelo que se define como paso siguiente.</span><span class="sxs-lookup"><span data-stu-id="d8698-273">The 'Discriminator' field in the AspNetUser table should match the model class name which is defined as a next step.</span></span> <span data-ttu-id="d8698-274">Además, la columna PasswordHash tiene el formato ' contraseña cifrada | contraseña sal | formato de contraseña '.</span><span class="sxs-lookup"><span data-stu-id="d8698-274">Also the PasswordHash column is in the form 'encrypted password |password salt|password format'.</span></span> <span data-ttu-id="d8698-275">Esto le permite usar lógica de cifrado de pertenencia a SQL especial para poder reutilizar las contraseñas antiguas.</span><span class="sxs-lookup"><span data-stu-id="d8698-275">This enables you to use special SQL membership crypto logic so that you can reuse old passwords.</span></span> <span data-ttu-id="d8698-276">Esto se explica más adelante en el artículo.</span><span class="sxs-lookup"><span data-stu-id="d8698-276">That is explained in later in the article.</span></span>

### <a name="creating-models-and-membership-pages"></a><span data-ttu-id="d8698-277">Crear modelos y páginas de pertenencia</span><span class="sxs-lookup"><span data-stu-id="d8698-277">Creating models and membership pages</span></span>

<span data-ttu-id="d8698-278">Como se mencionó anteriormente, la característica de identidad usa Entity Framework para comunicarse con la base de datos para almacenar información de la cuenta de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="d8698-278">As mentioned earlier, the Identity feature uses Entity Framework to talk to the database for storing account information by default.</span></span> <span data-ttu-id="d8698-279">Para trabajar con los datos existentes en la tabla, es necesario crear clases de modelo que se asignan a las tablas y se enlazan en el sistema de identidades.</span><span class="sxs-lookup"><span data-stu-id="d8698-279">To work with existing data in the table, we need to create model classes which map back to the tables and hook them up in the Identity system.</span></span> <span data-ttu-id="d8698-280">Como parte del contrato de identidad, las clases de modelo deben implementar las interfaces definidas en el archivo dll de identidad. Core o pueden extender la implementación existente de estas interfaces disponibles en Microsoft. AspNet. Identity. EntityFramework.</span><span class="sxs-lookup"><span data-stu-id="d8698-280">As part of the Identity contract, the model classes should either implement the interfaces defined in the Identity.Core dll or can extend the existing implementation of these interfaces available in Microsoft.AspNet.Identity.EntityFramework.</span></span>

<span data-ttu-id="d8698-281">En nuestro ejemplo, las tablas AspNetRoles, AspNetUserClaims, AspNetLogins y AspNetUserRole tienen columnas que son similares a la implementación existente del sistema de identidad.</span><span class="sxs-lookup"><span data-stu-id="d8698-281">In our sample, the AspNetRoles, AspNetUserClaims, AspNetLogins and AspNetUserRole tables have columns that are similar to the existing implementation of the Identity system.</span></span> <span data-ttu-id="d8698-282">Por lo tanto, se pueden volver a usar las clases existentes para asignar a estas tablas.</span><span class="sxs-lookup"><span data-stu-id="d8698-282">Hence we can reuse the existing classes to map to these tables.</span></span> <span data-ttu-id="d8698-283">La tabla AspNetUser tiene algunas columnas adicionales que se usan para almacenar información adicional de las tablas de pertenencia de SQL.</span><span class="sxs-lookup"><span data-stu-id="d8698-283">The AspNetUser table has some additional columns which are used to store additional information from the SQL membership tables.</span></span> <span data-ttu-id="d8698-284">Esto puede asignarse mediante la creación de una clase de modelo que extienda la implementación existente de ' IdentityUser ' y agregue las propiedades adicionales.</span><span class="sxs-lookup"><span data-stu-id="d8698-284">This can be mapped by creating a model class that extend the existing implementation of 'IdentityUser' and add the additional properties.</span></span>

1. <span data-ttu-id="d8698-285">Cree una carpeta models en el proyecto y agregue un usuario de clase.</span><span class="sxs-lookup"><span data-stu-id="d8698-285">Create a Models folder in the project and add a class User.</span></span> <span data-ttu-id="d8698-286">El nombre de la clase debe coincidir con los datos agregados en la columna ' Discriminator ' de la tabla ' AspnetUsers '.</span><span class="sxs-lookup"><span data-stu-id="d8698-286">The name of the class should match the data added in the 'Discriminator' column of 'AspnetUsers' table.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image10.png)

    <span data-ttu-id="d8698-287">La clase de usuario debe extender la clase IdentityUser que se encuentra en el archivo dll *Microsoft. Aspnet. Identity. EntityFramework* .</span><span class="sxs-lookup"><span data-stu-id="d8698-287">The User class should extend the IdentityUser class found in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="d8698-288">Declare las propiedades de la clase que se asignan a las columnas AspNetUser.</span><span class="sxs-lookup"><span data-stu-id="d8698-288">Declare the properties in class that map back to the AspNetUser columns.</span></span> <span data-ttu-id="d8698-289">Las propiedades ID, username, PasswordHash y SecurityStamp se definen en IdentityUser, por lo que se omiten.</span><span class="sxs-lookup"><span data-stu-id="d8698-289">The properties ID, Username, PasswordHash and SecurityStamp are defined in the IdentityUser and so are omitted.</span></span> <span data-ttu-id="d8698-290">A continuación se muestra el código de la clase de usuario que tiene todas las propiedades</span><span class="sxs-lookup"><span data-stu-id="d8698-290">Below is the code for the User class that has all the properties</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample3.cs)]
2. <span data-ttu-id="d8698-291">Se requiere una Entity Framework clase DbContext para conservar los datos de los modelos en las tablas y recuperar los datos de las tablas para rellenar los modelos.</span><span class="sxs-lookup"><span data-stu-id="d8698-291">An Entity Framework DbContext class is required in order to persist data in models back to tables and retrieve data from tables to populate the models.</span></span> <span data-ttu-id="d8698-292">El archivo dll *Microsoft. Aspnet. Identity. EntityFramework* define la clase IdentityDbContext, que interactúa con las tablas de identidad para recuperar y almacenar información.</span><span class="sxs-lookup"><span data-stu-id="d8698-292">*Microsoft.AspNet.Identity.EntityFramework* dll defines the IdentityDbContext class which interacts with the Identity tables to retrieve and store information.</span></span> <span data-ttu-id="d8698-293">El&gt; IdentityDbContext&lt;TUser toma una clase ' TUser ' que puede ser cualquier clase que extienda la clase IdentityUser.</span><span class="sxs-lookup"><span data-stu-id="d8698-293">The IdentityDbContext&lt;tuser&gt; takes a 'TUser' class which can be any class that extends the IdentityUser class.</span></span>

    <span data-ttu-id="d8698-294">Cree una nueva clase ApplicationDBContext que extienda IdentityDbContext en la carpeta ' models ', pasando la clase ' User ' creada en el paso 1</span><span class="sxs-lookup"><span data-stu-id="d8698-294">Create a new class ApplicationDBContext that extends IdentityDbContext under the 'Models' folder, passing in the 'User' class created in step 1</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample4.cs)]
3. <span data-ttu-id="d8698-295">La administración de usuarios en el nuevo sistema de identidad se realiza mediante la clase UserManager&lt;TUser&gt; definida en el archivo dll *Microsoft. Aspnet. Identity. EntityFramework* .</span><span class="sxs-lookup"><span data-stu-id="d8698-295">User management in the new Identity system is done using the UserManager&lt;tuser&gt; class defined in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="d8698-296">Necesitamos crear una clase personalizada que extienda UserManager y pasar la clase ' User ' creada en el paso 1.</span><span class="sxs-lookup"><span data-stu-id="d8698-296">We need to create a custom class that extends UserManager, passing in the 'User' class created in step 1.</span></span>

    <span data-ttu-id="d8698-297">En la carpeta models, cree una nueva clase UserManager que extienda UserManager&lt;usuario&gt;</span><span class="sxs-lookup"><span data-stu-id="d8698-297">In the Models folder create a new class UserManager that extends UserManager&lt;user&gt;</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample5.cs)]
4. <span data-ttu-id="d8698-298">Las contraseñas de los usuarios de la aplicación se cifran y almacenan en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="d8698-298">The passwords of the users of the application are encrypted and stored in the database.</span></span> <span data-ttu-id="d8698-299">El algoritmo criptográfico que se usa en la pertenencia a SQL es diferente del del nuevo sistema de identidad.</span><span class="sxs-lookup"><span data-stu-id="d8698-299">The crypto algorithm used in SQL membership is different from the one in the new Identity system.</span></span> <span data-ttu-id="d8698-300">Para volver a usar las contraseñas antiguas, es necesario descifrar selectivamente las contraseñas cuando los usuarios antiguos inician sesión con el algoritmo de pertenencia a SQL y al usar el algoritmo de cifrado en la identidad para los nuevos usuarios.</span><span class="sxs-lookup"><span data-stu-id="d8698-300">To reuse old passwords we need to selectively decrypt passwords when old users log in using the SQL memberships algorithm while using the crypto algorithm in Identity for the new users.</span></span>

    <span data-ttu-id="d8698-301">La clase UserManager tiene una propiedad ' PasswordHasher ' que almacena una instancia de una clase que implementa la interfaz ' IPasswordHasher '.</span><span class="sxs-lookup"><span data-stu-id="d8698-301">The UserManager class has a property 'PasswordHasher' which stores an instance of a class that implements the 'IPasswordHasher' interface.</span></span> <span data-ttu-id="d8698-302">Se usa para cifrar o descifrar las contraseñas durante las transacciones de autenticación del usuario.</span><span class="sxs-lookup"><span data-stu-id="d8698-302">This is used to encrypt/decrypt passwords during user authentication transactions.</span></span> <span data-ttu-id="d8698-303">En la clase UserManager definida en el paso 3, cree una nueva clase SQLPasswordHasher y copie el código siguiente.</span><span class="sxs-lookup"><span data-stu-id="d8698-303">In the UserManager class defined in step 3, create a new class SQLPasswordHasher and copy the below code.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample6.cs)]

    <span data-ttu-id="d8698-304">Resuelva los errores de compilación importando los espacios de nombres System. Text y System. Security. Cryptography.</span><span class="sxs-lookup"><span data-stu-id="d8698-304">Resolve the compilation errors by importing the System.Text and System.Security.Cryptography namespaces.</span></span>

    <span data-ttu-id="d8698-305">El método EncodePassword cifra la contraseña según la implementación de cifrado de pertenencia a SQL predeterminada.</span><span class="sxs-lookup"><span data-stu-id="d8698-305">The EncodePassword method encrypts the password according to the default SQL membership crypto implementation.</span></span> <span data-ttu-id="d8698-306">Esto se toma del archivo dll de System. Web.</span><span class="sxs-lookup"><span data-stu-id="d8698-306">This is taken from the System.Web dll.</span></span> <span data-ttu-id="d8698-307">Si la aplicación anterior usaba una implementación personalizada, debe reflejarse aquí.</span><span class="sxs-lookup"><span data-stu-id="d8698-307">If the old app used a custom implementation then it should be reflected here.</span></span> <span data-ttu-id="d8698-308">Necesitamos definir otros dos métodos *HashPassword* y *VerifyHashedPassword* que usan el método *EncodePassword* para aplicar un algoritmo hash a una contraseña determinada o comprobar una contraseña de texto sin formato con la que existe en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="d8698-308">We need to define two other methods *HashPassword* and *VerifyHashedPassword* that use the *EncodePassword* method to hash a given password or verify a plain text password with the one existing in the database.</span></span>

    <span data-ttu-id="d8698-309">El sistema de pertenencia de SQL usó PasswordHash, PasswordSalt y PasswordFormat para aplicar un algoritmo hash a la contraseña especificada por los usuarios al registrar o cambiar su contraseña.</span><span class="sxs-lookup"><span data-stu-id="d8698-309">The SQL membership system used PasswordHash, PasswordSalt and PasswordFormat to hash the password entered by users when they register or change their password.</span></span> <span data-ttu-id="d8698-310">Durante la migración, todos los tres campos se almacenan en la columna PasswordHash de la tabla AspNetUser separadas por el carácter "|".</span><span class="sxs-lookup"><span data-stu-id="d8698-310">During the migration all the three fields are stored in the PasswordHash column in the AspNetUser table separated by the '|' character.</span></span> <span data-ttu-id="d8698-311">Cuando un usuario inicia sesión y la contraseña tiene estos campos, usamos la criptografía de pertenencia de SQL para comprobar la contraseña; en caso contrario, usamos la criptografía predeterminada del sistema de identidad para comprobar la contraseña.</span><span class="sxs-lookup"><span data-stu-id="d8698-311">When a user logs in and the password has these fields, we use the SQL membership crypto to check the password; otherwise we use the Identity system's default crypto to verify the password.</span></span> <span data-ttu-id="d8698-312">De esta forma, los usuarios antiguos no tendrían que cambiar sus contraseñas una vez migrada la aplicación.</span><span class="sxs-lookup"><span data-stu-id="d8698-312">This way old users would not have to change their passwords once the app is migrated.</span></span>
5. <span data-ttu-id="d8698-313">Declare el constructor para la clase UserManager y páselo como SQLPasswordHasher a la propiedad en el constructor.</span><span class="sxs-lookup"><span data-stu-id="d8698-313">Declare the constructor for the UserManager class and pass this as the SQLPasswordHasher to the property in the constructor.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample7.cs)]

### <a name="create-new-account-management-pages"></a><span data-ttu-id="d8698-314">Crear nuevas páginas de administración de cuentas</span><span class="sxs-lookup"><span data-stu-id="d8698-314">Create new account management pages</span></span>

<span data-ttu-id="d8698-315">El siguiente paso de la migración es agregar páginas de administración de cuentas que permitan que un usuario se registre e inicie sesión.</span><span class="sxs-lookup"><span data-stu-id="d8698-315">The next step in the migration is to add account management pages that will let a user register and log in.</span></span> <span data-ttu-id="d8698-316">Las páginas de cuenta antiguas de la pertenencia a SQL usan controles que no funcionan con el nuevo sistema de identidad.</span><span class="sxs-lookup"><span data-stu-id="d8698-316">The old account pages from SQL membership use controls that don't work with the new Identity system.</span></span> <span data-ttu-id="d8698-317">Para agregar las nuevas páginas de administración de usuarios, siga el tutorial de este vínculo [https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) a partir del paso ' agregar Web Forms para registrar usuarios a la aplicación ' porque ya hemos creado el proyecto y agregado los paquetes de NuGet.</span><span class="sxs-lookup"><span data-stu-id="d8698-317">To add the new user management pages follow the tutorial at this link [https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) starting from the step 'Adding Web Forms for registering users to your application' since we have already created the project and added the NuGet packages.</span></span>

<span data-ttu-id="d8698-318">Necesitamos realizar algunos cambios en el ejemplo para trabajar con el proyecto que tenemos aquí.</span><span class="sxs-lookup"><span data-stu-id="d8698-318">We need to make some changes for the sample to work with the project we have here.</span></span>

- <span data-ttu-id="d8698-319">Las clases de código subyacente Register.aspx.cs y Login.aspx.cs usan el `UserManager` de los paquetes de identidad para crear un usuario.</span><span class="sxs-lookup"><span data-stu-id="d8698-319">The Register.aspx.cs and Login.aspx.cs code behind classes use the `UserManager` from the Identity packages to create a User.</span></span> <span data-ttu-id="d8698-320">En este ejemplo, use el UserManager agregado en la carpeta models siguiendo los pasos mencionados anteriormente.</span><span class="sxs-lookup"><span data-stu-id="d8698-320">For this example use the UserManager added in the Models folder by following the steps mentioned earlier.</span></span>
- <span data-ttu-id="d8698-321">Use la clase de usuario creada en lugar de IdentityUser en las clases de código subyacente Register.aspx.cs y Login.aspx.cs.</span><span class="sxs-lookup"><span data-stu-id="d8698-321">Use the User class created instead of the IdentityUser in Register.aspx.cs and Login.aspx.cs code behind classes.</span></span> <span data-ttu-id="d8698-322">Esto enlaza en la clase de usuario personalizada en el sistema de identidades.</span><span class="sxs-lookup"><span data-stu-id="d8698-322">This hooks in our custom user class into the Identity system.</span></span>
- <span data-ttu-id="d8698-323">Se puede omitir el elemento para crear la base de datos.</span><span class="sxs-lookup"><span data-stu-id="d8698-323">The part to create the database can be skipped.</span></span>
- <span data-ttu-id="d8698-324">El desarrollador debe establecer el valor de ApplicationId del nuevo usuario para que coincida con el identificador de aplicación actual.</span><span class="sxs-lookup"><span data-stu-id="d8698-324">The developer needs to set the ApplicationId for the new user to match the current application ID.</span></span> <span data-ttu-id="d8698-325">Esto puede hacerse consultando el ApplicationId de esta aplicación antes de que se cree un objeto de usuario en la clase Register.aspx.cs y estableciéndolo antes de crear el usuario.</span><span class="sxs-lookup"><span data-stu-id="d8698-325">This can be done by querying the ApplicationId for this application before a user object is created in the Register.aspx.cs class and setting it before creating user.</span></span>

    <span data-ttu-id="d8698-326">Ejemplo:</span><span class="sxs-lookup"><span data-stu-id="d8698-326">Example:</span></span>

    <span data-ttu-id="d8698-327">Defina un método en la página Register.aspx.cs para consultar la tabla de aplicaciones ASPNET\_y obtener el identificador de la aplicación según el nombre de la aplicación</span><span class="sxs-lookup"><span data-stu-id="d8698-327">Define a method in Register.aspx.cs page to query the aspnet\_Applications table and get the application Id according to application name</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample8.cs)]

    <span data-ttu-id="d8698-328">Ahora, Get Set this en el objeto User</span><span class="sxs-lookup"><span data-stu-id="d8698-328">Now get set this on the user object</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="d8698-329">Use el nombre de usuario y la contraseña antiguos para iniciar sesión con un usuario existente.</span><span class="sxs-lookup"><span data-stu-id="d8698-329">Use the old username and password to login an existing user.</span></span> <span data-ttu-id="d8698-330">Use la página registrar para crear un nuevo usuario.</span><span class="sxs-lookup"><span data-stu-id="d8698-330">Use the Register page to create a new user.</span></span> <span data-ttu-id="d8698-331">Compruebe también que los usuarios están en roles según lo esperado.</span><span class="sxs-lookup"><span data-stu-id="d8698-331">Also verify that the users are in roles as expected.</span></span>

<span data-ttu-id="d8698-332">La migración al sistema de identidad ayuda al usuario a agregar autenticación abierta (OAuth) a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="d8698-332">Porting to the Identity system helps the user add Open Authentication (OAuth) to the application.</span></span> <span data-ttu-id="d8698-333">Consulte [el ejemplo que](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/) tiene OAuth habilitado.</span><span class="sxs-lookup"><span data-stu-id="d8698-333">Please refer to the sample [here](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/) which has OAuth enabled.</span></span>

## <a name="next-steps"></a><span data-ttu-id="d8698-334">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="d8698-334">Next Steps</span></span>

<span data-ttu-id="d8698-335">En este tutorial se ha mostrado cómo trasladar a los usuarios de la pertenencia a SQL a ASP.NET Identity, pero no se han migrado los datos de perfil.</span><span class="sxs-lookup"><span data-stu-id="d8698-335">In this tutorial we showed how to port users from SQL membership to ASP.NET Identity, but we didn't port Profile data.</span></span> <span data-ttu-id="d8698-336">En el siguiente tutorial, veremos cómo trasladar los datos de Perfil de la pertenencia de SQL al nuevo sistema de identidad.</span><span class="sxs-lookup"><span data-stu-id="d8698-336">In the next tutorial we'll look into porting Profile data from SQL membership to the new Identity system.</span></span>

<span data-ttu-id="d8698-337">Puede dejar comentarios en la parte inferior de este artículo.</span><span class="sxs-lookup"><span data-stu-id="d8698-337">You can leave feedback at the bottom of this article.</span></span>

<span data-ttu-id="d8698-338">*Gracias a Tom Dykstra y Rick Anderson para revisar el artículo.*</span><span class="sxs-lookup"><span data-stu-id="d8698-338">*Thanks to Tom Dykstra and Rick Anderson for reviewing the article.*</span></span>
