---
uid: web-forms/overview/data-access/editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb
title: Implementar la simultaneidad optimista (VB) | Microsoft Docs
author: rick-anderson
description: En el caso de una aplicación web que permite a varios usuarios editar datos, existe el riesgo de que dos usuarios puedan editar los mismos datos al mismo tiempo. En este tutori...
ms.author: riande
ms.date: 07/17/2006
ms.assetid: 2646968c-2826-4418-b1d0-62610ed177e3
msc.legacyurl: /web-forms/overview/data-access/editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb
msc.type: authoredcontent
ms.openlocfilehash: 28c39fe2a290cc3a5b093fdd09de341630606137
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 11/28/2019
ms.locfileid: "74628734"
---
# <a name="implementing-optimistic-concurrency-vb"></a><span data-ttu-id="f348c-104">Implementar la simultaneidad optimista (VB)</span><span class="sxs-lookup"><span data-stu-id="f348c-104">Implementing Optimistic Concurrency (VB)</span></span>

<span data-ttu-id="f348c-105">por [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="f348c-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="f348c-106">[Descarga](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_21_VB.exe) de la aplicación de ejemplo o [descarga de PDF](implementing-optimistic-concurrency-vb/_static/datatutorial21vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="f348c-106">[Download Sample App](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_21_VB.exe) or [Download PDF](implementing-optimistic-concurrency-vb/_static/datatutorial21vb1.pdf)</span></span>

> <span data-ttu-id="f348c-107">En el caso de una aplicación web que permite a varios usuarios editar datos, existe el riesgo de que dos usuarios puedan editar los mismos datos al mismo tiempo.</span><span class="sxs-lookup"><span data-stu-id="f348c-107">For a web application that allows multiple users to edit data, there is the risk that two users may be editing the same data at the same time.</span></span> <span data-ttu-id="f348c-108">En este tutorial, vamos a implementar el control de simultaneidad optimista para controlar este riesgo.</span><span class="sxs-lookup"><span data-stu-id="f348c-108">In this tutorial we'll implement optimistic concurrency control to handle this risk.</span></span>

## <a name="introduction"></a><span data-ttu-id="f348c-109">Introducción</span><span class="sxs-lookup"><span data-stu-id="f348c-109">Introduction</span></span>

<span data-ttu-id="f348c-110">En el caso de las aplicaciones web que solo permiten a los usuarios ver datos, o para aquellos que incluyen solo un usuario que puede modificar datos, no hay ninguna amenaza de que dos usuarios simultáneos sobrescriban accidentalmente los cambios de los demás.</span><span class="sxs-lookup"><span data-stu-id="f348c-110">For web applications that only allow users to view data, or for those that include only a single user who can modify data, there's no threat of two concurrent users accidentally overwriting one another's changes.</span></span> <span data-ttu-id="f348c-111">Sin embargo, para las aplicaciones web que permiten a varios usuarios actualizar o eliminar datos, existe la posibilidad de que las modificaciones de un usuario entren en conflicto con otro usuario simultáneo.</span><span class="sxs-lookup"><span data-stu-id="f348c-111">For web applications that allow multiple users to update or delete data, however, there's the potential for one user's modifications to clash with another concurrent user's.</span></span> <span data-ttu-id="f348c-112">Si no hay ninguna directiva de simultaneidad implementada, cuando dos usuarios están editando un único registro simultáneamente, el usuario que realiza la confirmación de la última modificación reemplazará los cambios realizados por el primero.</span><span class="sxs-lookup"><span data-stu-id="f348c-112">Without any concurrency policy in place, when two users are simultaneously editing a single record, the user who commits her changes last will override the changes made by the first.</span></span>

<span data-ttu-id="f348c-113">Por ejemplo, Imagine que dos usuarios, Jisun y Sam, visitan una página de la aplicación que permitía a los visitantes actualizar y eliminar los productos a través de un control GridView.</span><span class="sxs-lookup"><span data-stu-id="f348c-113">For example, imagine that two users, Jisun and Sam, were both visiting a page in our application that allowed visitors to update and delete the products through a GridView control.</span></span> <span data-ttu-id="f348c-114">Ambos clics en el botón Editar de GridView aproximadamente al mismo tiempo.</span><span class="sxs-lookup"><span data-stu-id="f348c-114">Both click the Edit button in the GridView around the same time.</span></span> <span data-ttu-id="f348c-115">Jisun cambia el nombre del producto a "Chai té" y hace clic en el botón actualizar.</span><span class="sxs-lookup"><span data-stu-id="f348c-115">Jisun changes the product name to "Chai Tea" and clicks the Update button.</span></span> <span data-ttu-id="f348c-116">El resultado neto es una instrucción `UPDATE` que se envía a la base de datos, que establece *todos* los campos actualizables del producto (aunque Jisun solo haya actualizado un campo, `ProductName`).</span><span class="sxs-lookup"><span data-stu-id="f348c-116">The net result is an `UPDATE` statement that is sent to the database, which sets *all* of the product's updateable fields (even though Jisun only updated one field, `ProductName`).</span></span> <span data-ttu-id="f348c-117">En este momento, la base de datos tiene los valores "Chai té", la categoría Beverages, el proveedor exótico Liquiders, etc. para este producto en particular.</span><span class="sxs-lookup"><span data-stu-id="f348c-117">At this point in time, the database has the values "Chai Tea," the category Beverages, the supplier Exotic Liquids, and so on for this particular product.</span></span> <span data-ttu-id="f348c-118">Sin embargo, la pantalla GridView en el Sam sigue mostrando el nombre del producto en la fila de GridView modificable como "Chai".</span><span class="sxs-lookup"><span data-stu-id="f348c-118">However, the GridView on Sam's screen still shows the product name in the editable GridView row as "Chai".</span></span> <span data-ttu-id="f348c-119">Unos segundos después de que se hayan confirmado los cambios de JISUN, Sam actualiza la categoría a los condimentos y hace clic en actualizar.</span><span class="sxs-lookup"><span data-stu-id="f348c-119">A few seconds after Jisun's changes have been committed, Sam updates the category to Condiments and clicks Update.</span></span> <span data-ttu-id="f348c-120">Esto da como resultado una `UPDATE` instrucción enviada a la base de datos que establece el nombre del producto en "Chai", el `CategoryID` en el identificador de categoría de bebidas correspondiente, etc.</span><span class="sxs-lookup"><span data-stu-id="f348c-120">This results in an `UPDATE` statement sent to the database that sets the product name to "Chai," the `CategoryID` to the corresponding Beverages category ID, and so on.</span></span> <span data-ttu-id="f348c-121">Se han sobrescrito los cambios de Jisun en el nombre del producto.</span><span class="sxs-lookup"><span data-stu-id="f348c-121">Jisun's changes to the product name have been overwritten.</span></span> <span data-ttu-id="f348c-122">En la figura 1 se muestra gráficamente esta serie de eventos.</span><span class="sxs-lookup"><span data-stu-id="f348c-122">Figure 1 graphically depicts this series of events.</span></span>

<span data-ttu-id="f348c-123">[![cuando dos usuarios actualizan simultáneamente un registro, es posible que los cambios de un usuario sobrescriban el](implementing-optimistic-concurrency-vb/_static/image2.png)](implementing-optimistic-concurrency-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-123">[![When Two Users Simultaneously Update a Record There s Potential for One User 's Changes to Overwrite the Other 's](implementing-optimistic-concurrency-vb/_static/image2.png)](implementing-optimistic-concurrency-vb/_static/image1.png)</span></span>

<span data-ttu-id="f348c-124">**Figura 1**: cuando dos usuarios actualizan simultáneamente un registro, es posible que los cambios de un usuario sobrescriban el otro ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-124">**Figure 1**: When Two Users Simultaneously Update a Record There s Potential for One User 's Changes to Overwrite the Other 's ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image3.png))</span></span>

<span data-ttu-id="f348c-125">Del mismo modo, cuando dos usuarios visitan una página, un usuario podría estar en medio de actualizar un registro cuando lo eliminó otro usuario.</span><span class="sxs-lookup"><span data-stu-id="f348c-125">Similarly, when two users are visiting a page, one user might be in the midst of updating a record when it is deleted by another user.</span></span> <span data-ttu-id="f348c-126">O bien, entre cuando un usuario carga una página y cuando hace clic en el botón eliminar, es posible que otro usuario haya modificado el contenido de ese registro.</span><span class="sxs-lookup"><span data-stu-id="f348c-126">Or, between when a user loads a page and when they click the Delete button, another user may have modified the contents of that record.</span></span>

<span data-ttu-id="f348c-127">Hay tres estrategias de [control de simultaneidad](http://en.wikipedia.org/wiki/Concurrency_control) disponibles:</span><span class="sxs-lookup"><span data-stu-id="f348c-127">There are three [concurrency control](http://en.wikipedia.org/wiki/Concurrency_control) strategies available:</span></span>

- <span data-ttu-id="f348c-128">**No hacer nada** : si los usuarios simultáneos están modificando el mismo registro, permita que la última confirmación gane (el comportamiento predeterminado)</span><span class="sxs-lookup"><span data-stu-id="f348c-128">**Do Nothing** -if concurrent users are modifying the same record, let the last commit win (the default behavior)</span></span>
- <span data-ttu-id="f348c-129">[**Simultaneidad optimista**](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) : Supongamos que aunque puede haber conflictos de simultaneidad cada vez y, a continuación, la mayoría del tiempo, estos conflictos no surgirán. por lo tanto, si se produce un conflicto, simplemente informe al usuario de que no se pueden guardar los cambios porque otro usuario ha modificado los mismos datos</span><span class="sxs-lookup"><span data-stu-id="f348c-129">[**Optimistic Concurrency**](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) - assume that while there may be concurrency conflicts every now and then, the vast majority of the time such conflicts won't arise; therefore, if a conflict does arise, simply inform the user that their changes can't be saved because another user has modified the same data</span></span>
- <span data-ttu-id="f348c-130">**Simultaneidad pesimista** : Supongamos que los conflictos de simultaneidad son comunes y que los usuarios no toleran que sus cambios no se hayan guardado debido a la actividad simultánea de otro usuario. por lo tanto, cuando un usuario empieza a actualizar un registro, lo bloquea, lo que impide que otros usuarios editen o eliminen ese registro hasta que el usuario confirme sus modificaciones.</span><span class="sxs-lookup"><span data-stu-id="f348c-130">**Pessimistic Concurrency** - assume that concurrency conflicts are commonplace and that users won't tolerate being told their changes weren't saved due to another user's concurrent activity; therefore, when one user starts updating a record, lock it, thereby preventing any other users from editing or deleting that record until the user commits their modifications</span></span>

<span data-ttu-id="f348c-131">En la actualidad, todos nuestros tutoriales han usado la estrategia de resolución de simultaneidad predeterminada: es decir, se permite que la última escritura gane.</span><span class="sxs-lookup"><span data-stu-id="f348c-131">All of our tutorials thus far have used the default concurrency resolution strategy - namely, we've let the last write win.</span></span> <span data-ttu-id="f348c-132">En este tutorial, examinaremos cómo implementar el control de simultaneidad optimista.</span><span class="sxs-lookup"><span data-stu-id="f348c-132">In this tutorial we'll examine how to implement optimistic concurrency control.</span></span>

> [!NOTE]
> <span data-ttu-id="f348c-133">En esta serie de tutoriales no veremos ejemplos de simultaneidad pesimista.</span><span class="sxs-lookup"><span data-stu-id="f348c-133">We won't look at pessimistic concurrency examples in this tutorial series.</span></span> <span data-ttu-id="f348c-134">Rara vez se usa la simultaneidad pesimista porque tales bloqueos, si no se han renunciado correctamente, pueden impedir que otros usuarios actualicen los datos.</span><span class="sxs-lookup"><span data-stu-id="f348c-134">Pessimistic concurrency is rarely used because such locks, if not properly relinquished, can prevent other users from updating data.</span></span> <span data-ttu-id="f348c-135">Por ejemplo, si un usuario bloquea un registro para su edición y, a continuación, sale del día antes de desbloquearlo, ningún otro usuario podrá actualizar dicho registro hasta que el usuario original devuelva y complete su actualización.</span><span class="sxs-lookup"><span data-stu-id="f348c-135">For example, if a user locks a record for editing and then leaves for the day before unlocking it, no other user will be able to update that record until the original user returns and completes his update.</span></span> <span data-ttu-id="f348c-136">Por lo tanto, en situaciones en las que se usa la simultaneidad pesimista, normalmente hay un tiempo de espera que, si se alcanza, cancela el bloqueo.</span><span class="sxs-lookup"><span data-stu-id="f348c-136">Therefore, in situations where pessimistic concurrency is used, there's typically a timeout that, if reached, cancels the lock.</span></span> <span data-ttu-id="f348c-137">Sitios web de ventas de entradas, que bloquean una ubicación de plazas determinada durante un período de tiempo corto mientras el usuario completa el proceso de pedido, es un ejemplo de control de simultaneidad pesimista.</span><span class="sxs-lookup"><span data-stu-id="f348c-137">Ticket sales websites, which lock a particular seating location for short period while the user completes the order process, is an example of pessimistic concurrency control.</span></span>

## <a name="step-1-looking-at-how-optimistic-concurrency-is-implemented"></a><span data-ttu-id="f348c-138">Paso 1: ver cómo se implementa la simultaneidad optimista</span><span class="sxs-lookup"><span data-stu-id="f348c-138">Step 1: Looking at How Optimistic Concurrency is Implemented</span></span>

<span data-ttu-id="f348c-139">El control de simultaneidad optimista funciona asegurándose de que el registro que se está actualizando o eliminando tiene los mismos valores que cuando se inició el proceso de actualización o eliminación.</span><span class="sxs-lookup"><span data-stu-id="f348c-139">Optimistic concurrency control works by ensuring that the record being updated or deleted has the same values as it did when the updating or deleting process started.</span></span> <span data-ttu-id="f348c-140">Por ejemplo, al hacer clic en el botón Editar en un GridView modificable, los valores del registro se leen de la base de datos y se muestran en cuadros de texto y otros controles Web.</span><span class="sxs-lookup"><span data-stu-id="f348c-140">For example, when clicking the Edit button in an editable GridView, the record's values are read from the database and displayed in TextBoxes and other Web controls.</span></span> <span data-ttu-id="f348c-141">GridView guarda estos valores originales.</span><span class="sxs-lookup"><span data-stu-id="f348c-141">These original values are saved by the GridView.</span></span> <span data-ttu-id="f348c-142">Más adelante, después de que el usuario realice los cambios y haga clic en el botón actualizar, los valores originales más los nuevos valores se enviarán a la capa de lógica de negocios y, a continuación, a la capa de acceso a datos.</span><span class="sxs-lookup"><span data-stu-id="f348c-142">Later, after the user makes her changes and clicks the Update button, the original values plus the new values are sent to the Business Logic Layer, and then down to the Data Access Layer.</span></span> <span data-ttu-id="f348c-143">La capa de acceso a datos debe emitir una instrucción SQL que solo actualizará el registro si los valores originales que el usuario ha empezado a editar son idénticos a los valores de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="f348c-143">The Data Access Layer must issue a SQL statement that will only update the record if the original values that the user started editing are identical to the values still in the database.</span></span> <span data-ttu-id="f348c-144">En la ilustración 2 se muestra esta secuencia de eventos.</span><span class="sxs-lookup"><span data-stu-id="f348c-144">Figure 2 depicts this sequence of events.</span></span>

<span data-ttu-id="f348c-145">[![para que la actualización o eliminación se realice correctamente, los valores originales deben ser iguales a los valores de la base de datos actual.](implementing-optimistic-concurrency-vb/_static/image5.png)](implementing-optimistic-concurrency-vb/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-145">[![For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values](implementing-optimistic-concurrency-vb/_static/image5.png)](implementing-optimistic-concurrency-vb/_static/image4.png)</span></span>

<span data-ttu-id="f348c-146">**Figura 2**: para que la actualización o eliminación se realice correctamente, los valores originales deben ser iguales a los valores de la base de datos actual ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-146">**Figure 2**: For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image6.png))</span></span>

<span data-ttu-id="f348c-147">Existen varios enfoques para implementar la simultaneidad optimista (vea la [lógica de actualización de simultaneidad optimista](http://www.eggheadcafe.com/articles/20050719.asp) de [Peter a. Bromberg](http://peterbromberg.net/)para ver una breve descripción de una serie de opciones).</span><span class="sxs-lookup"><span data-stu-id="f348c-147">There are various approaches to implementing optimistic concurrency (see [Peter A. Bromberg](http://peterbromberg.net/)'s [Optimistic Concurrency Updating Logic](http://www.eggheadcafe.com/articles/20050719.asp) for a brief look at a number of options).</span></span> <span data-ttu-id="f348c-148">El conjunto de ADO.NET con tipo proporciona una implementación que se puede configurar con solo el paso de una casilla.</span><span class="sxs-lookup"><span data-stu-id="f348c-148">The ADO.NET Typed DataSet provides one implementation that can be configured with just the tick of a checkbox.</span></span> <span data-ttu-id="f348c-149">Al habilitar la simultaneidad optimista para un TableAdapter en el DataSet con tipo, se amplían las instrucciones `UPDATE` y `DELETE` del TableAdapter para incluir una comparación de todos los valores originales en la cláusula `WHERE`.</span><span class="sxs-lookup"><span data-stu-id="f348c-149">Enabling optimistic concurrency for a TableAdapter in the Typed DataSet augments the TableAdapter's `UPDATE` and `DELETE` statements to include a comparison of all of the original values in the `WHERE` clause.</span></span> <span data-ttu-id="f348c-150">Por ejemplo, la siguiente instrucción `UPDATE` actualiza el nombre y el precio de un producto solo si los valores de la base de datos actual son iguales a los valores que se recuperaron originalmente al actualizar el registro en GridView.</span><span class="sxs-lookup"><span data-stu-id="f348c-150">The following `UPDATE` statement, for example, updates the name and price of a product only if the current database values are equal to the values that were originally retrieved when updating the record in the GridView.</span></span> <span data-ttu-id="f348c-151">Los parámetros `@ProductName` y `@UnitPrice` contienen los nuevos valores introducidos por el usuario, mientras que `@original_ProductName` y `@original_UnitPrice` contienen los valores que se cargaron originalmente en el control GridView cuando se hizo clic en el botón Editar:</span><span class="sxs-lookup"><span data-stu-id="f348c-151">The `@ProductName` and `@UnitPrice` parameters contain the new values entered by the user, whereas `@original_ProductName` and `@original_UnitPrice` contain the values that were originally loaded into the GridView when the Edit button was clicked:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample1.sql)]

> [!NOTE]
> <span data-ttu-id="f348c-152">Esta instrucción `UPDATE` se ha simplificado para facilitar la lectura.</span><span class="sxs-lookup"><span data-stu-id="f348c-152">This `UPDATE` statement has been simplified for readability.</span></span> <span data-ttu-id="f348c-153">En la práctica, la `UnitPrice` proteger la cláusula de `WHERE` sería más complicada, ya que `UnitPrice` puede contener `NULL` s y comprobar si `NULL = NULL` devuelve siempre false (en su lugar, debe usar `IS NULL`).</span><span class="sxs-lookup"><span data-stu-id="f348c-153">In practice, the `UnitPrice` check in the `WHERE` clause would be more involved since `UnitPrice` can contain `NULL` s and checking if `NULL = NULL` always returns False (instead you must use `IS NULL`).</span></span>

<span data-ttu-id="f348c-154">Además de utilizar una instrucción de `UPDATE` subyacente diferente, la configuración de un TableAdapter para usar la simultaneidad optimista también modifica la firma de los métodos directos de la base de de.</span><span class="sxs-lookup"><span data-stu-id="f348c-154">In addition to using a different underlying `UPDATE` statement, configuring a TableAdapter to use optimistic concurrency also modifies the signature of its DB direct methods.</span></span> <span data-ttu-id="f348c-155">Recuerde que en el primer tutorial, [*la creación de una capa de acceso a datos*](../introduction/creating-a-data-access-layer-cs.md), los métodos directos de DB eran los que aceptan una lista de valores escalares como parámetros de entrada (en lugar de una instancia de DataRow o DataTable fuertemente tipada).</span><span class="sxs-lookup"><span data-stu-id="f348c-155">Recall from our first tutorial, [*Creating a Data Access Layer*](../introduction/creating-a-data-access-layer-cs.md), that DB direct methods were those that accepts a list of scalar values as input parameters (rather than a strongly-typed DataRow or DataTable instance).</span></span> <span data-ttu-id="f348c-156">Al usar la simultaneidad optimista, los métodos de `Update()` y `Delete()` de la base de datos directa también incluyen los parámetros de entrada de los valores originales.</span><span class="sxs-lookup"><span data-stu-id="f348c-156">When using optimistic concurrency, the DB direct `Update()` and `Delete()` methods include input parameters for the original values as well.</span></span> <span data-ttu-id="f348c-157">Además, el código de la capa BLL para usar el patrón de actualización por lotes (las sobrecargas del método `Update()` que aceptan DataRows y DataTables en lugar de valores escalares) también debe cambiarse.</span><span class="sxs-lookup"><span data-stu-id="f348c-157">Moreover, the code in the BLL for using the batch update pattern (the `Update()` method overloads that accept DataRows and DataTables rather than scalar values) must be changed as well.</span></span>

<span data-ttu-id="f348c-158">En lugar de ampliar nuestros TableAdapters de la capa DAL existentes para usar la simultaneidad optimista (lo que requeriría cambiar la capa BLL para acomodarse), vamos a crear un nuevo conjunto de objetos con tipo denominado `NorthwindOptimisticConcurrency`, al que agregaremos un `Products` TableAdapter que use la simultaneidad optimista.</span><span class="sxs-lookup"><span data-stu-id="f348c-158">Rather than extend our existing DAL's TableAdapters to use optimistic concurrency (which would necessitate changing the BLL to accommodate), let's instead create a new Typed DataSet named `NorthwindOptimisticConcurrency`, to which we'll add a `Products` TableAdapter that uses optimistic concurrency.</span></span> <span data-ttu-id="f348c-159">A continuación, crearemos una clase de capa de lógica de negocios `ProductsOptimisticConcurrencyBLL` que tenga las modificaciones adecuadas para admitir la simultaneidad optimista DAL.</span><span class="sxs-lookup"><span data-stu-id="f348c-159">Following that, we'll create a `ProductsOptimisticConcurrencyBLL` Business Logic Layer class that has the appropriate modifications to support the optimistic concurrency DAL.</span></span> <span data-ttu-id="f348c-160">Una vez que se haya establecido esta preparación, vamos a crear la página ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="f348c-160">Once this groundwork has been laid, we'll be ready to create the ASP.NET page.</span></span>

## <a name="step-2-creating-a-data-access-layer-that-supports-optimistic-concurrency"></a><span data-ttu-id="f348c-161">Paso 2: creación de una capa de acceso a datos que admita la simultaneidad optimista</span><span class="sxs-lookup"><span data-stu-id="f348c-161">Step 2: Creating a Data Access Layer That Supports Optimistic Concurrency</span></span>

<span data-ttu-id="f348c-162">Para crear un nuevo conjunto de contenido con tipo, haga clic con el botón derecho en la carpeta `DAL` dentro de la carpeta `App_Code` y agregue un nuevo conjunto de tipos denominado `NorthwindOptimisticConcurrency`.</span><span class="sxs-lookup"><span data-stu-id="f348c-162">To create a new Typed DataSet, right-click on the `DAL` folder within the `App_Code` folder and add a new DataSet named `NorthwindOptimisticConcurrency`.</span></span> <span data-ttu-id="f348c-163">Como vimos en el primer tutorial, al hacerlo, se agregará un nuevo TableAdapter al conjunto de DataSet con tipo, con lo que se iniciará automáticamente el Asistente para configuración de TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="f348c-163">As we saw in the first tutorial, doing so will add a new TableAdapter to the Typed DataSet, automatically launching the TableAdapter Configuration Wizard.</span></span> <span data-ttu-id="f348c-164">En la primera pantalla, se le pedirá que especifique la base de datos a la que conectarse: Conéctese a la misma base de datos Northwind con la configuración `NORTHWNDConnectionString` de `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="f348c-164">In the first screen, we're prompted to specify the database to connect to - connect to the same Northwind database using the `NORTHWNDConnectionString` setting from `Web.config`.</span></span>

<span data-ttu-id="f348c-165">[![conectarse a la misma base de datos Northwind](implementing-optimistic-concurrency-vb/_static/image8.png)](implementing-optimistic-concurrency-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-165">[![Connect to the Same Northwind Database](implementing-optimistic-concurrency-vb/_static/image8.png)](implementing-optimistic-concurrency-vb/_static/image7.png)</span></span>

<span data-ttu-id="f348c-166">**Figura 3**: conexión a la misma base de datos Northwind ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-166">**Figure 3**: Connect to the Same Northwind Database ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image9.png))</span></span>

<span data-ttu-id="f348c-167">A continuación, se le pedirá que consulte Cómo consultar los datos: a través de una instrucción SQL ad hoc, un nuevo procedimiento almacenado o un procedimiento almacenado existente.</span><span class="sxs-lookup"><span data-stu-id="f348c-167">Next, we are prompted as to how to query the data: through an ad-hoc SQL statement, a new stored procedure, or an existing stored procedure.</span></span> <span data-ttu-id="f348c-168">Como hemos usado consultas SQL ad hoc en la capa DAL original, use esta opción aquí también.</span><span class="sxs-lookup"><span data-stu-id="f348c-168">Since we used ad-hoc SQL queries in our original DAL, use this option here as well.</span></span>

<span data-ttu-id="f348c-169">[![especificar los datos que se van a recuperar mediante una instrucción SQL ad hoc](implementing-optimistic-concurrency-vb/_static/image11.png)](implementing-optimistic-concurrency-vb/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-169">[![Specify the Data to Retrieve Using an Ad-Hoc SQL Statement](implementing-optimistic-concurrency-vb/_static/image11.png)](implementing-optimistic-concurrency-vb/_static/image10.png)</span></span>

<span data-ttu-id="f348c-170">**Figura 4**: especificación de los datos que se van a recuperar mediante una instrucción SQL ad hoc ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-170">**Figure 4**: Specify the Data to Retrieve Using an Ad-Hoc SQL Statement ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image12.png))</span></span>

<span data-ttu-id="f348c-171">En la siguiente pantalla, escriba la consulta SQL que se va a usar para recuperar la información del producto.</span><span class="sxs-lookup"><span data-stu-id="f348c-171">On the following screen, enter the SQL query to use to retrieve the product information.</span></span> <span data-ttu-id="f348c-172">Vamos a usar la misma consulta SQL exacta utilizada para el `Products` TableAdapter de la capa DAL original, que devuelve todas las columnas `Product` junto con los nombres de categoría y proveedor del producto:</span><span class="sxs-lookup"><span data-stu-id="f348c-172">Let's use the exact same SQL query used for the `Products` TableAdapter from our original DAL, which returns all of the `Product` columns along with the product's supplier and category names:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample2.sql)]

<span data-ttu-id="f348c-173">[![usar la misma consulta SQL de los productos TableAdapter en la capa DAL original](implementing-optimistic-concurrency-vb/_static/image14.png)](implementing-optimistic-concurrency-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-173">[![Use the Same SQL Query from the Products TableAdapter in the Original DAL](implementing-optimistic-concurrency-vb/_static/image14.png)](implementing-optimistic-concurrency-vb/_static/image13.png)</span></span>

<span data-ttu-id="f348c-174">**Figura 5**: uso de la misma consulta SQL desde el `Products` TableAdapter en la capa Dal original ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-174">**Figure 5**: Use the Same SQL Query from the `Products` TableAdapter in the Original DAL ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image15.png))</span></span>

<span data-ttu-id="f348c-175">Antes de pasar a la siguiente pantalla, haga clic en el botón Opciones avanzadas.</span><span class="sxs-lookup"><span data-stu-id="f348c-175">Before moving onto the next screen, click the Advanced Options button.</span></span> <span data-ttu-id="f348c-176">Para que este TableAdapter emplee el control de simultaneidad optimista, solo tiene que activar la casilla "usar simultaneidad optimista".</span><span class="sxs-lookup"><span data-stu-id="f348c-176">To have this TableAdapter employ optimistic concurrency control, simply check the "Use optimistic concurrency" checkbox.</span></span>

<span data-ttu-id="f348c-177">[![habilitar el control de simultaneidad optimista activando la casilla de verificación &quot;usar&quot; de simultaneidad optimista](implementing-optimistic-concurrency-vb/_static/image17.png)](implementing-optimistic-concurrency-vb/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-177">[![Enable Optimistic Concurrency Control by Checking the &quot;Use optimistic concurrency&quot; CheckBox](implementing-optimistic-concurrency-vb/_static/image17.png)](implementing-optimistic-concurrency-vb/_static/image16.png)</span></span>

<span data-ttu-id="f348c-178">**Figura 6**: habilitación del control de simultaneidad optimista activando la casilla "usar simultaneidad optimista" ([haga clic para ver la imagen a tamaño completo](implementing-optimistic-concurrency-vb/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-178">**Figure 6**: Enable Optimistic Concurrency Control by Checking the "Use optimistic concurrency" CheckBox ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image18.png))</span></span>

<span data-ttu-id="f348c-179">Por último, indique que el TableAdapter debe utilizar los patrones de acceso a datos que rellenan un objeto DataTable y devuelven una DataTable. indique también que se deben crear los métodos directos de la base de de.</span><span class="sxs-lookup"><span data-stu-id="f348c-179">Lastly, indicate that the TableAdapter should use the data access patterns that both fill a DataTable and return a DataTable; also indicate that the DB direct methods should be created.</span></span> <span data-ttu-id="f348c-180">Cambie el nombre del método para devolver un modelo DataTable de GetData a GetProducts, de modo que se reflejen las convenciones de nomenclatura que se usan en la capa DAL original.</span><span class="sxs-lookup"><span data-stu-id="f348c-180">Change the method name for the Return a DataTable pattern from GetData to GetProducts, so as to mirror the naming conventions we used in our original DAL.</span></span>

<span data-ttu-id="f348c-181">[![que TableAdapter Use todos los patrones de acceso a datos](implementing-optimistic-concurrency-vb/_static/image20.png)](implementing-optimistic-concurrency-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-181">[![Have the TableAdapter Utilize All Data Access Patterns](implementing-optimistic-concurrency-vb/_static/image20.png)](implementing-optimistic-concurrency-vb/_static/image19.png)</span></span>

<span data-ttu-id="f348c-182">**Figura 7**: hacer que TableAdapter Use todos los patrones de acceso a datos ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-182">**Figure 7**: Have the TableAdapter Utilize All Data Access Patterns ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image21.png))</span></span>

<span data-ttu-id="f348c-183">Después de completar el asistente, el diseñador de DataSet incluirá un `Products` DataTable y un TableAdapter fuertemente tipados.</span><span class="sxs-lookup"><span data-stu-id="f348c-183">After completing the wizard, the DataSet Designer will include a strongly-typed `Products` DataTable and TableAdapter.</span></span> <span data-ttu-id="f348c-184">Dedique un momento a cambiar el nombre de la tabla de texto de `Products` a `ProductsOptimisticConcurrency`, que puede hacer haciendo clic con el botón secundario en la barra de título de la DataTable y eligiendo cambiar nombre en el menú contextual.</span><span class="sxs-lookup"><span data-stu-id="f348c-184">Take a moment to rename the DataTable from `Products` to `ProductsOptimisticConcurrency`, which you can do by right-clicking on the DataTable's title bar and choosing Rename from the context menu.</span></span>

<span data-ttu-id="f348c-185">[![DataTable y TableAdapter se han agregado al DataSet con tipo](implementing-optimistic-concurrency-vb/_static/image23.png)](implementing-optimistic-concurrency-vb/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-185">[![A DataTable and TableAdapter Have Been Added to the Typed DataSet](implementing-optimistic-concurrency-vb/_static/image23.png)](implementing-optimistic-concurrency-vb/_static/image22.png)</span></span>

<span data-ttu-id="f348c-186">**Figura 8**: se han agregado un DataTable y un TableAdapter al conjunto de tipos ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image24.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-186">**Figure 8**: A DataTable and TableAdapter Have Been Added to the Typed DataSet ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image24.png))</span></span>

<span data-ttu-id="f348c-187">Para ver las diferencias entre las consultas `UPDATE` y `DELETE` entre la `ProductsOptimisticConcurrency` TableAdapter (que usa la simultaneidad optimista) y los productos TableAdapter (que no), haga clic en el TableAdapter y vaya al ventana Propiedades.</span><span class="sxs-lookup"><span data-stu-id="f348c-187">To see the differences between the `UPDATE` and `DELETE` queries between the `ProductsOptimisticConcurrency` TableAdapter (which uses optimistic concurrency) and the Products TableAdapter (which doesn't), click on the TableAdapter and go to the Properties window.</span></span> <span data-ttu-id="f348c-188">En las subpropiedades de `CommandText` de propiedades `DeleteCommand` y `UpdateCommand`, puede ver la sintaxis SQL real que se envía a la base de datos cuando se invocan los métodos relacionados con la actualización o eliminación de DAL.</span><span class="sxs-lookup"><span data-stu-id="f348c-188">In the `DeleteCommand` and `UpdateCommand` properties' `CommandText` subproperties you can see the actual SQL syntax that is sent to the database when the DAL's update or delete-related methods are invoked.</span></span> <span data-ttu-id="f348c-189">Para el `ProductsOptimisticConcurrency` TableAdapter, la instrucción `DELETE` utilizada es:</span><span class="sxs-lookup"><span data-stu-id="f348c-189">For the `ProductsOptimisticConcurrency` TableAdapter the `DELETE` statement used is:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample3.sql)]

<span data-ttu-id="f348c-190">Mientras que la instrucción `DELETE` para el TableAdapter del producto en la capa DAL original es mucho más sencilla:</span><span class="sxs-lookup"><span data-stu-id="f348c-190">Whereas the `DELETE` statement for the Product TableAdapter in our original DAL is the much simpler:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample4.sql)]

<span data-ttu-id="f348c-191">Como puede ver, la cláusula `WHERE` de la instrucción `DELETE` para el TableAdapter que utiliza la simultaneidad optimista incluye una comparación entre cada uno de los valores de columna existentes de la tabla `Product` y los valores originales en el momento en que se rellenó GridView (o DetailsView o FormView) por última vez.</span><span class="sxs-lookup"><span data-stu-id="f348c-191">As you can see, the `WHERE` clause in the `DELETE` statement for the TableAdapter that uses optimistic concurrency includes a comparison between each of the `Product` table's existing column values and the original values at the time the GridView (or DetailsView or FormView) was last populated.</span></span> <span data-ttu-id="f348c-192">Dado que todos los campos distintos de `ProductID`, `ProductName`y `Discontinued` pueden tener `NULL` valores, se incluyen parámetros y comprobaciones adicionales para comparar correctamente `NULL` valores en la cláusula `WHERE`.</span><span class="sxs-lookup"><span data-stu-id="f348c-192">Since all fields other than `ProductID`, `ProductName`, and `Discontinued` can have `NULL` values, additional parameters and checks are included to correctly compare `NULL` values in the `WHERE` clause.</span></span>

<span data-ttu-id="f348c-193">No vamos a agregar ninguna tabla de datos adicional al conjunto de datos con la simultaneidad optimista habilitada para este tutorial, ya que nuestra página de ASP.NET solo proporcionará la actualización y eliminación de la información del producto.</span><span class="sxs-lookup"><span data-stu-id="f348c-193">We won't be adding any additional DataTables to the optimistic concurrency-enabled DataSet for this tutorial, as our ASP.NET page will only provide updating and deleting product information.</span></span> <span data-ttu-id="f348c-194">Sin embargo, todavía es necesario agregar el método `GetProductByProductID(productID)` a la `ProductsOptimisticConcurrency` TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="f348c-194">However, we do still need to add the `GetProductByProductID(productID)` method to the `ProductsOptimisticConcurrency` TableAdapter.</span></span>

<span data-ttu-id="f348c-195">Para ello, haga clic con el botón secundario en la barra de título del TableAdapter (el área que se encuentra encima de los nombres de método `Fill` y `GetProducts`) y elija Agregar consulta en el menú contextual.</span><span class="sxs-lookup"><span data-stu-id="f348c-195">To accomplish this, right-click on the TableAdapter's title bar (the area right above the `Fill` and `GetProducts` method names) and choose Add Query from the context menu.</span></span> <span data-ttu-id="f348c-196">Se iniciará el Asistente para la configuración de consultas de TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="f348c-196">This will launch the TableAdapter Query Configuration Wizard.</span></span> <span data-ttu-id="f348c-197">Al igual que con la configuración inicial de su TableAdapter, opte por crear el método de `GetProductByProductID(productID)` mediante una instrucción SQL ad hoc (consulte la figura 4).</span><span class="sxs-lookup"><span data-stu-id="f348c-197">As with our TableAdapter's initial configuration, opt to create the `GetProductByProductID(productID)` method using an ad-hoc SQL statement (see Figure 4).</span></span> <span data-ttu-id="f348c-198">Dado que el método `GetProductByProductID(productID)` devuelve información acerca de un producto determinado, indique que esta consulta es un tipo de consulta `SELECT` que devuelve filas.</span><span class="sxs-lookup"><span data-stu-id="f348c-198">Since the `GetProductByProductID(productID)` method returns information about a particular product, indicate that this query is a `SELECT` query type that returns rows.</span></span>

<span data-ttu-id="f348c-199">[![marcar el tipo de consulta como &quot;SELECT que devuelve las filas&quot;](implementing-optimistic-concurrency-vb/_static/image26.png)](implementing-optimistic-concurrency-vb/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-199">[![Mark the Query Type as a &quot;SELECT which returns rows&quot;](implementing-optimistic-concurrency-vb/_static/image26.png)](implementing-optimistic-concurrency-vb/_static/image25.png)</span></span>

<span data-ttu-id="f348c-200">**Figura 9**: marcar el tipo de consulta como "`SELECT` que devuelve filas" ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image27.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-200">**Figure 9**: Mark the Query Type as a "`SELECT` which returns rows" ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image27.png))</span></span>

<span data-ttu-id="f348c-201">En la siguiente pantalla se le pedirá la consulta SQL que se va a usar, con la consulta predeterminada del TableAdapter cargada previamente.</span><span class="sxs-lookup"><span data-stu-id="f348c-201">On the next screen we're prompted for the SQL query to use, with the TableAdapter's default query pre-loaded.</span></span> <span data-ttu-id="f348c-202">Aumente la consulta existente para incluir la cláusula `WHERE ProductID = @ProductID`, como se muestra en la figura 10.</span><span class="sxs-lookup"><span data-stu-id="f348c-202">Augment the existing query to include the clause `WHERE ProductID = @ProductID`, as shown in Figure 10.</span></span>

<span data-ttu-id="f348c-203">[![agregar una cláusula WHERE a la consulta cargada previamente para devolver un registro de producto específico](implementing-optimistic-concurrency-vb/_static/image29.png)](implementing-optimistic-concurrency-vb/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-203">[![Add a WHERE Clause to the Pre-Loaded Query to Return a Specific Product Record](implementing-optimistic-concurrency-vb/_static/image29.png)](implementing-optimistic-concurrency-vb/_static/image28.png)</span></span>

<span data-ttu-id="f348c-204">**Figura 10**: agregar una cláusula `WHERE` a la consulta precargada para devolver un registro de producto específico ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image30.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-204">**Figure 10**: Add a `WHERE` Clause to the Pre-Loaded Query to Return a Specific Product Record ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image30.png))</span></span>

<span data-ttu-id="f348c-205">Por último, cambie los nombres de método generados por `FillByProductID` y `GetProductByProductID`.</span><span class="sxs-lookup"><span data-stu-id="f348c-205">Finally, change the generated method names to `FillByProductID` and `GetProductByProductID`.</span></span>

<span data-ttu-id="f348c-206">[![cambiar el nombre de los métodos a FillByProductID y GetProductByProductID](implementing-optimistic-concurrency-vb/_static/image32.png)](implementing-optimistic-concurrency-vb/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-206">[![Rename the Methods to FillByProductID and GetProductByProductID](implementing-optimistic-concurrency-vb/_static/image32.png)](implementing-optimistic-concurrency-vb/_static/image31.png)</span></span>

<span data-ttu-id="f348c-207">**Figura 11**: cambiar el nombre de los métodos a `FillByProductID` y `GetProductByProductID` ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image33.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-207">**Figure 11**: Rename the Methods to `FillByProductID` and `GetProductByProductID` ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image33.png))</span></span>

<span data-ttu-id="f348c-208">Con este asistente completo, el TableAdapter ahora contiene dos métodos para recuperar datos: `GetProducts()`, que devuelve *todos* los productos; y `GetProductByProductID(productID)`, que devuelve el producto especificado.</span><span class="sxs-lookup"><span data-stu-id="f348c-208">With this wizard complete, the TableAdapter now contains two methods for retrieving data: `GetProducts()`, which returns *all* products; and `GetProductByProductID(productID)`, which returns the specified product.</span></span>

## <a name="step-3-creating-a-business-logic-layer-for-the-optimistic-concurrency-enabled-dal"></a><span data-ttu-id="f348c-209">Paso 3: crear una capa de lógica de negocios para la DAL con simultaneidad optimista habilitada</span><span class="sxs-lookup"><span data-stu-id="f348c-209">Step 3: Creating a Business Logic Layer for the Optimistic Concurrency-Enabled DAL</span></span>

<span data-ttu-id="f348c-210">Nuestra clase de `ProductsBLL` existente tiene ejemplos de uso de los modelos de actualización por lotes y de DB Direct.</span><span class="sxs-lookup"><span data-stu-id="f348c-210">Our existing `ProductsBLL` class has examples of using both the batch update and DB direct patterns.</span></span> <span data-ttu-id="f348c-211">El método `AddProduct` y las sobrecargas de `UpdateProduct` usan el patrón de actualización por lotes, pasando una instancia de `ProductRow` al método Update de TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="f348c-211">The `AddProduct` method and `UpdateProduct` overloads both use the batch update pattern, passing in a `ProductRow` instance to the TableAdapter's Update method.</span></span> <span data-ttu-id="f348c-212">Por otro lado, el método `DeleteProduct` usa el patrón de base de BD Direct, que llama al método `Delete(productID)` de TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="f348c-212">The `DeleteProduct` method, on the other hand, uses the DB direct pattern, calling the TableAdapter's `Delete(productID)` method.</span></span>

<span data-ttu-id="f348c-213">Con el nuevo `ProductsOptimisticConcurrency` TableAdapter, los métodos de DB Direct ahora requieren que se pasen los valores originales.</span><span class="sxs-lookup"><span data-stu-id="f348c-213">With the new `ProductsOptimisticConcurrency` TableAdapter, the DB direct methods now require that the original values also be passed in.</span></span> <span data-ttu-id="f348c-214">Por ejemplo, el método `Delete` espera ahora diez parámetros de entrada: el `ProductID`original, `ProductName`, `SupplierID`, `CategoryID`, `QuantityPerUnit`, `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, `ReorderLevel`y `Discontinued`.</span><span class="sxs-lookup"><span data-stu-id="f348c-214">For example, the `Delete` method now expects ten input parameters: the original `ProductID`, `ProductName`, `SupplierID`, `CategoryID`, `QuantityPerUnit`, `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, `ReorderLevel`, and `Discontinued`.</span></span> <span data-ttu-id="f348c-215">Usa estos valores de parámetros de entrada adicionales en `WHERE` cláusula de la instrucción `DELETE` enviada a la base de datos, eliminando solo el registro especificado si los valores actuales de la base de datos se asignan a los originales.</span><span class="sxs-lookup"><span data-stu-id="f348c-215">It uses these additional input parameters' values in `WHERE` clause of the `DELETE` statement sent to the database, only deleting the specified record if the database's current values map up to the original ones.</span></span>

<span data-ttu-id="f348c-216">Aunque no ha cambiado la firma de método del método `Update` del TableAdapter usado en el patrón de actualización por lotes, el código necesario para registrar los valores originales y nuevos tiene.</span><span class="sxs-lookup"><span data-stu-id="f348c-216">While the method signature for the TableAdapter's `Update` method used in the batch update pattern hasn't changed, the code needed to record the original and new values has.</span></span> <span data-ttu-id="f348c-217">Por lo tanto, en lugar de intentar usar la capa DAL habilitada para simultaneidad optimista con nuestra clase de `ProductsBLL` existente, vamos a crear una nueva clase de capa de lógica de negocios para trabajar con la nueva capa DAL.</span><span class="sxs-lookup"><span data-stu-id="f348c-217">Therefore, rather than attempt to use the optimistic concurrency-enabled DAL with our existing `ProductsBLL` class, let's create a new Business Logic Layer class for working with our new DAL.</span></span>

<span data-ttu-id="f348c-218">Agregue una clase denominada `ProductsOptimisticConcurrencyBLL` a la carpeta `BLL` en la carpeta `App_Code`.</span><span class="sxs-lookup"><span data-stu-id="f348c-218">Add a class named `ProductsOptimisticConcurrencyBLL` to the `BLL` folder within the `App_Code` folder.</span></span>

![Agregar la clase ProductsOptimisticConcurrencyBLL a la carpeta BLL](implementing-optimistic-concurrency-vb/_static/image34.png)

<span data-ttu-id="f348c-220">**Figura 12**: adición de la clase `ProductsOptimisticConcurrencyBLL` a la carpeta BLL</span><span class="sxs-lookup"><span data-stu-id="f348c-220">**Figure 12**: Add the `ProductsOptimisticConcurrencyBLL` Class to the BLL Folder</span></span>

<span data-ttu-id="f348c-221">A continuación, agregue el siguiente código a la clase `ProductsOptimisticConcurrencyBLL`:</span><span class="sxs-lookup"><span data-stu-id="f348c-221">Next, add the following code to the `ProductsOptimisticConcurrencyBLL` class:</span></span>

[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample5.vb)]

<span data-ttu-id="f348c-222">Observe la instrucción using `NorthwindOptimisticConcurrencyTableAdapters` encima del inicio de la declaración de clase.</span><span class="sxs-lookup"><span data-stu-id="f348c-222">Note the using `NorthwindOptimisticConcurrencyTableAdapters` statement above the start of the class declaration.</span></span> <span data-ttu-id="f348c-223">El espacio de nombres `NorthwindOptimisticConcurrencyTableAdapters` contiene la clase `ProductsOptimisticConcurrencyTableAdapter`, que proporciona los métodos de la capa DAL.</span><span class="sxs-lookup"><span data-stu-id="f348c-223">The `NorthwindOptimisticConcurrencyTableAdapters` namespace contains the `ProductsOptimisticConcurrencyTableAdapter` class, which provides the DAL's methods.</span></span> <span data-ttu-id="f348c-224">También antes de la declaración de clase encontrará el `System.ComponentModel.DataObject` atributo, que indica a Visual Studio que incluya esta clase en la lista desplegable del asistente ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="f348c-224">Also before the class declaration you'll find the `System.ComponentModel.DataObject` attribute, which instructs Visual Studio to include this class in the ObjectDataSource wizard's drop-down list.</span></span>

<span data-ttu-id="f348c-225">La propiedad `Adapter` del `ProductsOptimisticConcurrencyBLL`proporciona acceso rápido a una instancia de la clase `ProductsOptimisticConcurrencyTableAdapter` y sigue el patrón que se usa en las clases de BLL originales (`ProductsBLL`, `CategoriesBLL`, etc.).</span><span class="sxs-lookup"><span data-stu-id="f348c-225">The `ProductsOptimisticConcurrencyBLL`'s `Adapter` property provides quick access to an instance of the `ProductsOptimisticConcurrencyTableAdapter` class, and follows the pattern used in our original BLL classes (`ProductsBLL`, `CategoriesBLL`, and so on).</span></span> <span data-ttu-id="f348c-226">Por último, el método `GetProducts()` simplemente llama al método `GetProducts()` de la capa DAL y devuelve un objeto `ProductsOptimisticConcurrencyDataTable` rellenado con una instancia de `ProductsOptimisticConcurrencyRow` para cada registro del producto en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="f348c-226">Finally, the `GetProducts()` method simply calls down into the DAL's `GetProducts()` method and returns a `ProductsOptimisticConcurrencyDataTable` object populated with a `ProductsOptimisticConcurrencyRow` instance for each product record in the database.</span></span>

## <a name="deleting-a-product-using-the-db-direct-pattern-with-optimistic-concurrency"></a><span data-ttu-id="f348c-227">Eliminación de un producto mediante el patrón de base de BD Direct con simultaneidad optimista</span><span class="sxs-lookup"><span data-stu-id="f348c-227">Deleting a Product Using the DB Direct Pattern with Optimistic Concurrency</span></span>

<span data-ttu-id="f348c-228">Cuando se usa el patrón de base de BD Direct en una capa DAL que usa la simultaneidad optimista, se deben pasar los valores nuevos y originales a los métodos.</span><span class="sxs-lookup"><span data-stu-id="f348c-228">When using the DB direct pattern against a DAL that uses optimistic concurrency, the methods must be passed the new and original values.</span></span> <span data-ttu-id="f348c-229">Para eliminar, no hay valores nuevos, por lo que solo es necesario pasar los valores originales.</span><span class="sxs-lookup"><span data-stu-id="f348c-229">For deleting, there are no new values, so only the original values need be passed in.</span></span> <span data-ttu-id="f348c-230">En nuestro BLL, debemos aceptar todos los parámetros originales como parámetros de entrada.</span><span class="sxs-lookup"><span data-stu-id="f348c-230">In our BLL, then, we must accept all of the original parameters as input parameters.</span></span> <span data-ttu-id="f348c-231">Vamos a tener el método de `DeleteProduct` en la clase `ProductsOptimisticConcurrencyBLL` usar el método de DB Direct.</span><span class="sxs-lookup"><span data-stu-id="f348c-231">Let's have the `DeleteProduct` method in the `ProductsOptimisticConcurrencyBLL` class use the DB direct method.</span></span> <span data-ttu-id="f348c-232">Esto significa que este método debe tomar los diez campos de datos de producto como parámetros de entrada y pasarlos a la capa DAL, tal como se muestra en el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="f348c-232">This means that this method needs to take in all ten product data fields as input parameters, and pass these to the DAL, as shown in the following code:</span></span>

[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample6.vb)]

<span data-ttu-id="f348c-233">Si los valores originales (los valores que se cargaron por última vez en GridView (o DetailsView o FormView) difieren de los valores de la base de datos cuando el usuario hace clic en el botón eliminar, la cláusula `WHERE` no coincidirá con ningún registro de base de datos y no se verán afectados los registros.</span><span class="sxs-lookup"><span data-stu-id="f348c-233">If the original values - those values that were last loaded into the GridView (or DetailsView or FormView) - differ from the values in the database when the user clicks the Delete button the `WHERE` clause won't match up with any database record and no records will be affected.</span></span> <span data-ttu-id="f348c-234">Por lo tanto, el método `Delete` del TableAdapter devolverá `0` y el método `DeleteProduct` de la capa BLL devolverá `false`.</span><span class="sxs-lookup"><span data-stu-id="f348c-234">Hence, the TableAdapter's `Delete` method will return `0` and the BLL's `DeleteProduct` method will return `false`.</span></span>

## <a name="updating-a-product-using-the-batch-update-pattern-with-optimistic-concurrency"></a><span data-ttu-id="f348c-235">Actualización de un producto mediante el patrón de actualización por lotes con simultaneidad optimista</span><span class="sxs-lookup"><span data-stu-id="f348c-235">Updating a Product Using the Batch Update Pattern with Optimistic Concurrency</span></span>

<span data-ttu-id="f348c-236">Como se indicó anteriormente, el método `Update` del TableAdapter para el patrón de actualización por lotes tiene la misma firma de método independientemente de si se emplea o no la simultaneidad optimista.</span><span class="sxs-lookup"><span data-stu-id="f348c-236">As noted earlier, the TableAdapter's `Update` method for the batch update pattern has the same method signature regardless of whether or not optimistic concurrency is employed.</span></span> <span data-ttu-id="f348c-237">A saber, el método `Update` espera una DataRow, una matriz de DataRows, una DataTable o un DataSet con tipo.</span><span class="sxs-lookup"><span data-stu-id="f348c-237">Namely, the `Update` method expects a DataRow, an array of DataRows, a DataTable, or a Typed DataSet.</span></span> <span data-ttu-id="f348c-238">No hay parámetros de entrada adicionales para especificar los valores originales.</span><span class="sxs-lookup"><span data-stu-id="f348c-238">There are no additional input parameters for specifying the original values.</span></span> <span data-ttu-id="f348c-239">Esto es posible porque la DataTable realiza un seguimiento de los valores originales y modificados de sus DataRow (s).</span><span class="sxs-lookup"><span data-stu-id="f348c-239">This is possible because the DataTable keeps track of the original and modified values for its DataRow(s).</span></span> <span data-ttu-id="f348c-240">Cuando la capa DAL emite su instrucción `UPDATE`, los parámetros de `@original_ColumnName` se rellenan con los valores originales de DataRow, mientras que los parámetros de `@ColumnName` se rellenan con los valores modificados de DataRow.</span><span class="sxs-lookup"><span data-stu-id="f348c-240">When the DAL issues its `UPDATE` statement, the `@original_ColumnName` parameters are populated with the DataRow's original values, whereas the `@ColumnName` parameters are populated with the DataRow's modified values.</span></span>

<span data-ttu-id="f348c-241">En la clase `ProductsBLL` (que usa nuestra capa de simultaneidad original, no optimista), al usar el patrón de actualización por lotes para actualizar la información del producto, nuestro código realiza la siguiente secuencia de eventos:</span><span class="sxs-lookup"><span data-stu-id="f348c-241">In the `ProductsBLL` class (which uses our original, non-optimistic concurrency DAL), when using the batch update pattern to update product information our code performs the following sequence of events:</span></span>

1. <span data-ttu-id="f348c-242">Leer la información actual del producto de la base de datos en una instancia de `ProductRow` mediante el método `GetProductByProductID(productID)` del TableAdapter</span><span class="sxs-lookup"><span data-stu-id="f348c-242">Read the current database product information into a `ProductRow` instance using the TableAdapter's `GetProductByProductID(productID)` method</span></span>
2. <span data-ttu-id="f348c-243">Asignar los nuevos valores a la instancia de `ProductRow` del paso 1</span><span class="sxs-lookup"><span data-stu-id="f348c-243">Assign the new values to the `ProductRow` instance from Step 1</span></span>
3. <span data-ttu-id="f348c-244">Llame al método `Update` del TableAdapter, pasando la instancia de `ProductRow`.</span><span class="sxs-lookup"><span data-stu-id="f348c-244">Call the TableAdapter's `Update` method, passing in the `ProductRow` instance</span></span>

<span data-ttu-id="f348c-245">Sin embargo, esta secuencia de pasos no admitirá correctamente la simultaneidad optimista porque los `ProductRow` rellenados en el paso 1 se rellenan directamente a partir de la base de datos, lo que significa que los valores originales utilizados por DataRow son los que existen actualmente en la base de datos, y no los que estaban enlazados a GridView al comienzo del proceso de edición.</span><span class="sxs-lookup"><span data-stu-id="f348c-245">This sequence of steps, however, won't correctly support optimistic concurrency because the `ProductRow` populated in Step 1 is populated directly from the database, meaning that the original values used by the DataRow are those that currently exist in the database, and not those that were bound to the GridView at the start of the editing process.</span></span> <span data-ttu-id="f348c-246">En su lugar, cuando se usa una capa DAL habilitada para simultaneidad optimista, es necesario modificar las sobrecargas del método `UpdateProduct` para usar los siguientes pasos:</span><span class="sxs-lookup"><span data-stu-id="f348c-246">Instead, when using an optimistic concurrency-enabled DAL, we need to alter the `UpdateProduct` method overloads to use the following steps:</span></span>

1. <span data-ttu-id="f348c-247">Leer la información actual del producto de la base de datos en una instancia de `ProductsOptimisticConcurrencyRow` mediante el método `GetProductByProductID(productID)` del TableAdapter</span><span class="sxs-lookup"><span data-stu-id="f348c-247">Read the current database product information into a `ProductsOptimisticConcurrencyRow` instance using the TableAdapter's `GetProductByProductID(productID)` method</span></span>
2. <span data-ttu-id="f348c-248">Asigne los valores *originales* a la instancia de `ProductsOptimisticConcurrencyRow` del paso 1.</span><span class="sxs-lookup"><span data-stu-id="f348c-248">Assign the *original* values to the `ProductsOptimisticConcurrencyRow` instance from Step 1</span></span>
3. <span data-ttu-id="f348c-249">Llame al método `AcceptChanges()` de la instancia de `ProductsOptimisticConcurrencyRow`, que indica al DataRow que sus valores actuales son los "originales".</span><span class="sxs-lookup"><span data-stu-id="f348c-249">Call the `ProductsOptimisticConcurrencyRow` instance's `AcceptChanges()` method, which instructs the DataRow that its current values are the "original" ones</span></span>
4. <span data-ttu-id="f348c-250">Asignar los *nuevos* valores a la instancia de `ProductsOptimisticConcurrencyRow`</span><span class="sxs-lookup"><span data-stu-id="f348c-250">Assign the *new* values to the `ProductsOptimisticConcurrencyRow` instance</span></span>
5. <span data-ttu-id="f348c-251">Llame al método `Update` del TableAdapter, pasando la instancia de `ProductsOptimisticConcurrencyRow`.</span><span class="sxs-lookup"><span data-stu-id="f348c-251">Call the TableAdapter's `Update` method, passing in the `ProductsOptimisticConcurrencyRow` instance</span></span>

<span data-ttu-id="f348c-252">En el paso 1 se leen todos los valores de la base de datos actual del registro de producto especificado.</span><span class="sxs-lookup"><span data-stu-id="f348c-252">Step 1 reads in all of the current database values for the specified product record.</span></span> <span data-ttu-id="f348c-253">Este paso es superfluo en la sobrecarga `UpdateProduct` que actualiza *todas* las columnas Product (ya que estos valores se sobrescriben en el paso 2), pero es esencial para las sobrecargas en las que solo un subconjunto de los valores de columna se pasan como parámetros de entrada.</span><span class="sxs-lookup"><span data-stu-id="f348c-253">This step is superfluous in the `UpdateProduct` overload that updates *all* of the product columns (as these values are overwritten in Step 2), but is essential for those overloads where only a subset of the column values are passed in as input parameters.</span></span> <span data-ttu-id="f348c-254">Una vez asignados los valores originales a la instancia de `ProductsOptimisticConcurrencyRow`, se llama al método `AcceptChanges()`, que marca los valores de DataRow actuales como los valores originales que se van a usar en los parámetros `@original_ColumnName` de la instrucción `UPDATE`.</span><span class="sxs-lookup"><span data-stu-id="f348c-254">Once the original values have been assigned to the `ProductsOptimisticConcurrencyRow` instance, the `AcceptChanges()` method is called, which marks the current DataRow values as the original values to be used in the `@original_ColumnName` parameters in the `UPDATE` statement.</span></span> <span data-ttu-id="f348c-255">A continuación, se asignan los nuevos valores de parámetro al `ProductsOptimisticConcurrencyRow` y, por último, se invoca el método `Update`, pasando el DataRow.</span><span class="sxs-lookup"><span data-stu-id="f348c-255">Next, the new parameter values are assigned to the `ProductsOptimisticConcurrencyRow` and, finally, the `Update` method is invoked, passing in the DataRow.</span></span>

<span data-ttu-id="f348c-256">En el código siguiente se muestra la sobrecarga `UpdateProduct` que acepta todos los campos de datos de producto como parámetros de entrada.</span><span class="sxs-lookup"><span data-stu-id="f348c-256">The following code shows the `UpdateProduct` overload that accepts all product data fields as input parameters.</span></span> <span data-ttu-id="f348c-257">Aunque no se muestra aquí, la clase `ProductsOptimisticConcurrencyBLL` incluida en la descarga para este tutorial también contiene una sobrecarga de `UpdateProduct` que acepta solo el nombre y el precio del producto como parámetros de entrada.</span><span class="sxs-lookup"><span data-stu-id="f348c-257">While not shown here, the `ProductsOptimisticConcurrencyBLL` class included in the download for this tutorial also contains an `UpdateProduct` overload that accepts just the product's name and price as input parameters.</span></span>

[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample7.vb)]

## <a name="step-4-passing-the-original-and-new-values-from-the-aspnet-page-to-the-bll-methods"></a><span data-ttu-id="f348c-258">Paso 4: pasar los valores originales y nuevos de la página ASP.NET a los métodos BLL</span><span class="sxs-lookup"><span data-stu-id="f348c-258">Step 4: Passing the Original and New Values From the ASP.NET Page to the BLL Methods</span></span>

<span data-ttu-id="f348c-259">Con DAL y BLL completado, todo lo que queda es crear una página ASP.NET que pueda emplear la lógica de simultaneidad optimista integrada en el sistema.</span><span class="sxs-lookup"><span data-stu-id="f348c-259">With the DAL and BLL complete, all that remains is to create an ASP.NET page that can utilize the optimistic concurrency logic built in to the system.</span></span> <span data-ttu-id="f348c-260">En concreto, el control Web de datos (GridView, DetailsView o FormView) debe recordar sus valores originales y el ObjectDataSource debe pasar ambos conjuntos de valores a la capa de lógica de negocios.</span><span class="sxs-lookup"><span data-stu-id="f348c-260">Specifically, the data Web control (the GridView, DetailsView, or FormView) must remember its original values and the ObjectDataSource must pass both sets of values to the Business Logic Layer.</span></span> <span data-ttu-id="f348c-261">Además, la página ASP.NET debe estar configurada para controlar correctamente las infracciones de simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="f348c-261">Furthermore, the ASP.NET page must be configured to gracefully handle concurrency violations.</span></span>

<span data-ttu-id="f348c-262">Para empezar, abra la página `OptimisticConcurrency.aspx` en la carpeta `EditInsertDelete` y agregue un control GridView al diseñador y establezca su propiedad `ID` en `ProductsGrid`.</span><span class="sxs-lookup"><span data-stu-id="f348c-262">Start by opening the `OptimisticConcurrency.aspx` page in the `EditInsertDelete` folder and adding a GridView to the Designer, setting its `ID` property to `ProductsGrid`.</span></span> <span data-ttu-id="f348c-263">En la etiqueta inteligente de GridView, opte por crear un nuevo ObjectDataSource denominado `ProductsOptimisticConcurrencyDataSource`.</span><span class="sxs-lookup"><span data-stu-id="f348c-263">From the GridView's smart tag, opt to create a new ObjectDataSource named `ProductsOptimisticConcurrencyDataSource`.</span></span> <span data-ttu-id="f348c-264">Dado que deseamos que ObjectDataSource use la capa DAL que admite la simultaneidad optimista, configúrela para usar el objeto `ProductsOptimisticConcurrencyBLL`.</span><span class="sxs-lookup"><span data-stu-id="f348c-264">Since we want this ObjectDataSource to use the DAL that supports optimistic concurrency, configure it to use the `ProductsOptimisticConcurrencyBLL` object.</span></span>

<span data-ttu-id="f348c-265">[![que ObjectDataSource use el objeto ProductsOptimisticConcurrencyBLL](implementing-optimistic-concurrency-vb/_static/image36.png)](implementing-optimistic-concurrency-vb/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-265">[![Have the ObjectDataSource Use the ProductsOptimisticConcurrencyBLL Object](implementing-optimistic-concurrency-vb/_static/image36.png)](implementing-optimistic-concurrency-vb/_static/image35.png)</span></span>

<span data-ttu-id="f348c-266">**Figura 13**: hacer que ObjectDataSource use el objeto de `ProductsOptimisticConcurrencyBLL` ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image37.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-266">**Figure 13**: Have the ObjectDataSource Use the `ProductsOptimisticConcurrencyBLL` Object ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image37.png))</span></span>

<span data-ttu-id="f348c-267">Elija los métodos `GetProducts`, `UpdateProduct`y `DeleteProduct` en las listas desplegables del asistente.</span><span class="sxs-lookup"><span data-stu-id="f348c-267">Choose the `GetProducts`, `UpdateProduct`, and `DeleteProduct` methods from drop-down lists in the wizard.</span></span> <span data-ttu-id="f348c-268">Para el método UpdateProduct, use la sobrecarga que acepta todos los campos de datos del producto.</span><span class="sxs-lookup"><span data-stu-id="f348c-268">For the UpdateProduct method, use the overload that accepts all of the product's data fields.</span></span>

## <a name="configuring-the-objectdatasource-controls-properties"></a><span data-ttu-id="f348c-269">Configurar las propiedades del control ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="f348c-269">Configuring the ObjectDataSource Control's Properties</span></span>

<span data-ttu-id="f348c-270">Después de completar el asistente, el marcado declarativo de ObjectDataSource debería tener un aspecto similar al siguiente:</span><span class="sxs-lookup"><span data-stu-id="f348c-270">After completing the wizard, the ObjectDataSource's declarative markup should look like the following:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample8.aspx)]

<span data-ttu-id="f348c-271">Como puede ver, la colección `DeleteParameters` contiene una instancia de `Parameter` para cada uno de los diez parámetros de entrada en el método `DeleteProduct` de la clase `ProductsOptimisticConcurrencyBLL`.</span><span class="sxs-lookup"><span data-stu-id="f348c-271">As you can see, the `DeleteParameters` collection contains a `Parameter` instance for each of the ten input parameters in the `ProductsOptimisticConcurrencyBLL` class's `DeleteProduct` method.</span></span> <span data-ttu-id="f348c-272">Del mismo modo, la colección de `UpdateParameters` contiene una instancia de `Parameter` para cada uno de los parámetros de entrada en `UpdateProduct`.</span><span class="sxs-lookup"><span data-stu-id="f348c-272">Likewise, the `UpdateParameters` collection contains a `Parameter` instance for each of the input parameters in `UpdateProduct`.</span></span>

<span data-ttu-id="f348c-273">En el caso de los tutoriales anteriores que implican la modificación de los datos, quitaremos la propiedad `OldValuesParameterFormatString` de ObjectDataSource en este momento, ya que esta propiedad indica que el método BLL espera que se pasen los valores antiguos (o originales), así como los nuevos valores.</span><span class="sxs-lookup"><span data-stu-id="f348c-273">For those previous tutorials that involved data modification, we'd remove the ObjectDataSource's `OldValuesParameterFormatString` property at this point, since this property indicates that the BLL method expects the old (or original) values to be passed in as well as the new values.</span></span> <span data-ttu-id="f348c-274">Además, este valor de propiedad indica los nombres de los parámetros de entrada de los valores originales.</span><span class="sxs-lookup"><span data-stu-id="f348c-274">Furthermore, this property value indicates the input parameter names for the original values.</span></span> <span data-ttu-id="f348c-275">Dado que pasamos los valores originales a la capa BLL, *no* Quite esta propiedad.</span><span class="sxs-lookup"><span data-stu-id="f348c-275">Since we are passing in the original values into the BLL, do *not* remove this property.</span></span>

> [!NOTE]
> <span data-ttu-id="f348c-276">El valor de la propiedad `OldValuesParameterFormatString` debe asignarse a los nombres de los parámetros de entrada de la capa BLL que esperan los valores originales.</span><span class="sxs-lookup"><span data-stu-id="f348c-276">The value of the `OldValuesParameterFormatString` property must map to the input parameter names in the BLL that expect the original values.</span></span> <span data-ttu-id="f348c-277">Como hemos denominado estos parámetros `original_productName`, `original_supplierID`, etc., puede dejar el valor de la propiedad `OldValuesParameterFormatString` como `original_{0}`.</span><span class="sxs-lookup"><span data-stu-id="f348c-277">Since we named these parameters `original_productName`, `original_supplierID`, and so on, you can leave the `OldValuesParameterFormatString` property value as `original_{0}`.</span></span> <span data-ttu-id="f348c-278">Sin embargo, si los parámetros de entrada de los métodos BLL tenían nombres como `old_productName`, `old_supplierID`, etc., tendría que actualizar la propiedad `OldValuesParameterFormatString` a `old_{0}`.</span><span class="sxs-lookup"><span data-stu-id="f348c-278">If, however, the BLL methods' input parameters had names like `old_productName`, `old_supplierID`, and so on, you'd need to update the `OldValuesParameterFormatString` property to `old_{0}`.</span></span>

<span data-ttu-id="f348c-279">Hay una configuración de propiedad final que se debe realizar para que ObjectDataSource pase correctamente los valores originales a los métodos de BLL.</span><span class="sxs-lookup"><span data-stu-id="f348c-279">There's one final property setting that needs to be made in order for the ObjectDataSource to correctly pass the original values to the BLL methods.</span></span> <span data-ttu-id="f348c-280">ObjectDataSource tiene una [propiedad ConflictDetection](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.conflictdetection.aspx) que se puede asignar a [uno de dos valores](https://msdn.microsoft.com/library/system.web.ui.conflictoptions.aspx):</span><span class="sxs-lookup"><span data-stu-id="f348c-280">The ObjectDataSource has a [ConflictDetection property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.conflictdetection.aspx) that can be assigned to [one of two values](https://msdn.microsoft.com/library/system.web.ui.conflictoptions.aspx):</span></span>

- <span data-ttu-id="f348c-281">`OverwriteChanges`: el valor predeterminado; no envía los valores originales a los parámetros de entrada originales de los métodos de BLL</span><span class="sxs-lookup"><span data-stu-id="f348c-281">`OverwriteChanges` - the default value; does not send the original values to the BLL methods' original input parameters</span></span>
- <span data-ttu-id="f348c-282">`CompareAllValues`-envía los valores originales a los métodos de BLL; Elija esta opción cuando use la simultaneidad optimista</span><span class="sxs-lookup"><span data-stu-id="f348c-282">`CompareAllValues` - does send the original values to the BLL methods; choose this option when using optimistic concurrency</span></span>

<span data-ttu-id="f348c-283">Dedique un momento a establecer la propiedad `ConflictDetection` en `CompareAllValues`.</span><span class="sxs-lookup"><span data-stu-id="f348c-283">Take a moment to set the `ConflictDetection` property to `CompareAllValues`.</span></span>

## <a name="configuring-the-gridviews-properties-and-fields"></a><span data-ttu-id="f348c-284">Configurar las propiedades y los campos de GridView</span><span class="sxs-lookup"><span data-stu-id="f348c-284">Configuring the GridView's Properties and Fields</span></span>

<span data-ttu-id="f348c-285">Una vez que las propiedades de ObjectDataSource estén configuradas correctamente, vamos a activar la atención para configurar GridView.</span><span class="sxs-lookup"><span data-stu-id="f348c-285">With the ObjectDataSource's properties properly configured, let's turn our attention to setting up the GridView.</span></span> <span data-ttu-id="f348c-286">En primer lugar, como queremos que GridView admita la edición y eliminación, haga clic en las casillas habilitar edición y habilitar eliminación de la etiqueta inteligente de GridView.</span><span class="sxs-lookup"><span data-stu-id="f348c-286">First, since we want the GridView to support editing and deleting, click the Enable Editing and Enable Deleting checkboxes from the GridView's smart tag.</span></span> <span data-ttu-id="f348c-287">Esto agregará un CommandField cuyo `ShowEditButton` y `ShowDeleteButton` están establecidos en `true`.</span><span class="sxs-lookup"><span data-stu-id="f348c-287">This will add a CommandField whose `ShowEditButton` and `ShowDeleteButton` are both set to `true`.</span></span>

<span data-ttu-id="f348c-288">Cuando se enlaza a la `ProductsOptimisticConcurrencyDataSource` ObjectDataSource, GridView contiene un campo para cada uno de los campos de datos del producto.</span><span class="sxs-lookup"><span data-stu-id="f348c-288">When bound to the `ProductsOptimisticConcurrencyDataSource` ObjectDataSource, the GridView contains a field for each of the product's data fields.</span></span> <span data-ttu-id="f348c-289">Aunque este tipo de GridView se puede editar, la experiencia del usuario es algo que es aceptable.</span><span class="sxs-lookup"><span data-stu-id="f348c-289">While such a GridView can be edited, the user experience is anything but acceptable.</span></span> <span data-ttu-id="f348c-290">Los `CategoryID` y `SupplierID` BoundFields se representarán como cuadros de texto, lo que requiere que el usuario especifique la categoría y el proveedor adecuados como números de identificador.</span><span class="sxs-lookup"><span data-stu-id="f348c-290">The `CategoryID` and `SupplierID` BoundFields will render as TextBoxes, requiring the user to enter the appropriate category and supplier as ID numbers.</span></span> <span data-ttu-id="f348c-291">No habrá ningún formato para los campos numéricos y ningún control de validación para asegurarse de que se ha proporcionado el nombre del producto y de que el precio unitario, las unidades en existencias, las unidades en el pedido y los valores de nivel de reordenación son valores numéricos correctos y son mayores o iguales en cero.</span><span class="sxs-lookup"><span data-stu-id="f348c-291">There will be no formatting for the numeric fields and no validation controls to ensure that the product's name has been supplied and that the unit price, units in stock, units on order, and reorder level values are both proper numeric values and are greater than or equal to zero.</span></span>

<span data-ttu-id="f348c-292">Como se explicó en los tutoriales *Agregar controles de validación a las interfaces de edición e inserción* y *Personalización de la interfaz de modificación de datos* , se puede personalizar la interfaz de usuario reemplazando BoundFields por TemplateFields.</span><span class="sxs-lookup"><span data-stu-id="f348c-292">As we discussed in the *Adding Validation Controls to the Editing and Inserting Interfaces* and *Customizing the Data Modification Interface* tutorials, the user interface can be customized by replacing the BoundFields with TemplateFields.</span></span> <span data-ttu-id="f348c-293">He modificado este GridView y su interfaz de edición de las siguientes maneras:</span><span class="sxs-lookup"><span data-stu-id="f348c-293">I've modified this GridView and its editing interface in the following ways:</span></span>

- <span data-ttu-id="f348c-294">Se han quitado los `ProductID`, `SupplierName`y `CategoryName` BoundFields</span><span class="sxs-lookup"><span data-stu-id="f348c-294">Removed the `ProductID`, `SupplierName`, and `CategoryName` BoundFields</span></span>
- <span data-ttu-id="f348c-295">Se ha convertido el `ProductName` BoundField en TemplateField y se ha agregado un control RequiredFieldValidation.</span><span class="sxs-lookup"><span data-stu-id="f348c-295">Converted the `ProductName` BoundField to a TemplateField and added a RequiredFieldValidation control.</span></span>
- <span data-ttu-id="f348c-296">Se ha convertido el `CategoryID` y `SupplierID` BoundFields en TemplateFields y se ha ajustado la interfaz de edición para usar DropDownLists en lugar de cuadros de texto.</span><span class="sxs-lookup"><span data-stu-id="f348c-296">Converted the `CategoryID` and `SupplierID` BoundFields to TemplateFields, and adjusted the editing interface to use DropDownLists rather than TextBoxes.</span></span> <span data-ttu-id="f348c-297">En estos `ItemTemplates`de TemplateFields, se muestran los campos de datos `CategoryName` y `SupplierName`.</span><span class="sxs-lookup"><span data-stu-id="f348c-297">In these TemplateFields' `ItemTemplates`, the `CategoryName` and `SupplierName` data fields are displayed.</span></span>
- <span data-ttu-id="f348c-298">Se han convertido los `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`y `ReorderLevel` BoundFields en TemplateFields y se han agregado controles CompareValidator.</span><span class="sxs-lookup"><span data-stu-id="f348c-298">Converted the `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, and `ReorderLevel` BoundFields to TemplateFields and added CompareValidator controls.</span></span>

<span data-ttu-id="f348c-299">Como ya hemos examinado cómo llevar a cabo estas tareas en los tutoriales anteriores, solo mostraré la sintaxis declarativa final y dejaremos la implementación como práctica.</span><span class="sxs-lookup"><span data-stu-id="f348c-299">Since we've already examined how to accomplish these tasks in previous tutorials, I'll just list the final declarative syntax here and leave the implementation as practice.</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample9.aspx)]

<span data-ttu-id="f348c-300">Estamos muy cerca de tener un ejemplo totalmente funcional.</span><span class="sxs-lookup"><span data-stu-id="f348c-300">We're very close to having a fully-working example.</span></span> <span data-ttu-id="f348c-301">Sin embargo, hay algunos matices que se expedirán y provocarán problemas.</span><span class="sxs-lookup"><span data-stu-id="f348c-301">However, there are a few subtleties that will creep up and cause us problems.</span></span> <span data-ttu-id="f348c-302">Además, todavía necesitamos una interfaz que alerta al usuario cuando se ha producido una infracción de simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="f348c-302">Additionally, we still need some interface that alerts the user when a concurrency violation has occurred.</span></span>

> [!NOTE]
> <span data-ttu-id="f348c-303">Para que un control Web de datos pase correctamente los valores originales a ObjectDataSource (que luego se pasan a la capa BLL), es fundamental que la propiedad `EnableViewState` de GridView esté establecida en `true` (el valor predeterminado).</span><span class="sxs-lookup"><span data-stu-id="f348c-303">In order for a data Web control to correctly pass the original values to the ObjectDataSource (which are then passed to the BLL), it's vital that the GridView's `EnableViewState` property is set to `true` (the default).</span></span> <span data-ttu-id="f348c-304">Si deshabilita el estado de vista, los valores originales se pierden en el PostBack.</span><span class="sxs-lookup"><span data-stu-id="f348c-304">If you disable view state, the original values are lost on postback.</span></span>

## <a name="passing-the-correct-original-values-to-the-objectdatasource"></a><span data-ttu-id="f348c-305">Pasar los valores originales correctos a ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="f348c-305">Passing the Correct Original Values to the ObjectDataSource</span></span>

<span data-ttu-id="f348c-306">Hay un par de problemas con la forma en que se ha configurado GridView.</span><span class="sxs-lookup"><span data-stu-id="f348c-306">There are a couple of problems with the way the GridView has been configured.</span></span> <span data-ttu-id="f348c-307">Si la propiedad `ConflictDetection` de ObjectDataSource está establecida en `CompareAllValues` (tal cual es nuestra), cuando GridView (o DetailsView o FormView) invoca los métodos de la `Update()` o `Delete()` de ObjectDataSource, el ObjectDataSource intenta copiar los valores originales de GridView en sus instancias de `Parameter` adecuadas.</span><span class="sxs-lookup"><span data-stu-id="f348c-307">If the ObjectDataSource's `ConflictDetection` property is set to `CompareAllValues` (as is ours), when the ObjectDataSource's `Update()` or `Delete()` methods are invoked by the GridView (or DetailsView or FormView), the ObjectDataSource attempts to copy the GridView's original values into its appropriate `Parameter` instances.</span></span> <span data-ttu-id="f348c-308">Consulte la figura 2 para obtener una representación gráfica de este proceso.</span><span class="sxs-lookup"><span data-stu-id="f348c-308">Refer back to Figure 2 for a graphical representation of this process.</span></span>

<span data-ttu-id="f348c-309">En concreto, a los valores originales de GridView se les asignan los valores de las instrucciones de enlace de datos bidireccionales cada vez que los datos están enlazados a GridView.</span><span class="sxs-lookup"><span data-stu-id="f348c-309">Specifically, the GridView's original values are assigned the values in the two-way databinding statements each time the data is bound to the GridView.</span></span> <span data-ttu-id="f348c-310">Por lo tanto, es esencial que todos los valores originales necesarios se capturen a través de un enlace de los dos sentidos y que se proporcionen en un formato convertible.</span><span class="sxs-lookup"><span data-stu-id="f348c-310">Therefore, it's essential that the required original values all are captured via two-way databinding and that they are provided in a convertible format.</span></span>

<span data-ttu-id="f348c-311">Para ver por qué esto es importante, dedique un momento a visitar la página en un explorador.</span><span class="sxs-lookup"><span data-stu-id="f348c-311">To see why this is important, take a moment to visit our page in a browser.</span></span> <span data-ttu-id="f348c-312">Como se esperaba, el control GridView muestra cada producto con un botón Editar y eliminar en la columna situada más a la izquierda.</span><span class="sxs-lookup"><span data-stu-id="f348c-312">As expected, the GridView lists each product with an Edit and Delete button in the leftmost column.</span></span>

<span data-ttu-id="f348c-313">[![los productos se muestran en un control GridView](implementing-optimistic-concurrency-vb/_static/image39.png)](implementing-optimistic-concurrency-vb/_static/image38.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-313">[![The Products are Listed in a GridView](implementing-optimistic-concurrency-vb/_static/image39.png)](implementing-optimistic-concurrency-vb/_static/image38.png)</span></span>

<span data-ttu-id="f348c-314">**Figura 14**: los productos se muestran en un control GridView ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image40.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-314">**Figure 14**: The Products are Listed in a GridView ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image40.png))</span></span>

<span data-ttu-id="f348c-315">Si hace clic en el botón eliminar de cualquier producto, se produce una `FormatException`.</span><span class="sxs-lookup"><span data-stu-id="f348c-315">If you click the Delete button for any product, a `FormatException` is thrown.</span></span>

<span data-ttu-id="f348c-316">[![intentar eliminar los resultados de un producto en FormatException](implementing-optimistic-concurrency-vb/_static/image42.png)](implementing-optimistic-concurrency-vb/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-316">[![Attempting to Delete Any Product Results in a FormatException](implementing-optimistic-concurrency-vb/_static/image42.png)](implementing-optimistic-concurrency-vb/_static/image41.png)</span></span>

<span data-ttu-id="f348c-317">**Figura 15**: intento de eliminar los resultados de un producto en un `FormatException` ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image43.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-317">**Figure 15**: Attempting to Delete Any Product Results in a `FormatException` ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image43.png))</span></span>

<span data-ttu-id="f348c-318">El `FormatException` se genera cuando ObjectDataSource intenta leer en el valor de `UnitPrice` original.</span><span class="sxs-lookup"><span data-stu-id="f348c-318">The `FormatException` is raised when the ObjectDataSource attempts to read in the original `UnitPrice` value.</span></span> <span data-ttu-id="f348c-319">Como el `ItemTemplate` tiene el `UnitPrice` con formato de moneda (`<%# Bind("UnitPrice", "{0:C}") %>`), incluye un símbolo de moneda, como $19,95.</span><span class="sxs-lookup"><span data-stu-id="f348c-319">Since the `ItemTemplate` has the `UnitPrice` formatted as a currency (`<%# Bind("UnitPrice", "{0:C}") %>`), it includes a currency symbol, like $19.95.</span></span> <span data-ttu-id="f348c-320">El `FormatException` se produce como ObjectDataSource intenta convertir esta cadena en un `decimal`.</span><span class="sxs-lookup"><span data-stu-id="f348c-320">The `FormatException` occurs as the ObjectDataSource attempts to convert this string into a `decimal`.</span></span> <span data-ttu-id="f348c-321">Para evitar este problema, tenemos varias opciones:</span><span class="sxs-lookup"><span data-stu-id="f348c-321">To circumvent this problem, we have a number of options:</span></span>

- <span data-ttu-id="f348c-322">Quite el formato de moneda de la `ItemTemplate`.</span><span class="sxs-lookup"><span data-stu-id="f348c-322">Remove the currency formatting from the `ItemTemplate`.</span></span> <span data-ttu-id="f348c-323">Es decir, en lugar de usar `<%# Bind("UnitPrice", "{0:C}") %>`, simplemente use `<%# Bind("UnitPrice") %>`.</span><span class="sxs-lookup"><span data-stu-id="f348c-323">That is, instead of using `<%# Bind("UnitPrice", "{0:C}") %>`, simply use `<%# Bind("UnitPrice") %>`.</span></span> <span data-ttu-id="f348c-324">La desventaja es que ya no se da formato al precio.</span><span class="sxs-lookup"><span data-stu-id="f348c-324">The downside of this is that the price is no longer formatted.</span></span>
- <span data-ttu-id="f348c-325">Muestre el `UnitPrice` con formato de moneda en el `ItemTemplate`, pero use la palabra clave `Eval` para lograrlo.</span><span class="sxs-lookup"><span data-stu-id="f348c-325">Display the `UnitPrice` formatted as a currency in the `ItemTemplate`, but use the `Eval` keyword to accomplish this.</span></span> <span data-ttu-id="f348c-326">Recuerde que `Eval` realiza el enlace de una sola dirección.</span><span class="sxs-lookup"><span data-stu-id="f348c-326">Recall that `Eval` performs one-way databinding.</span></span> <span data-ttu-id="f348c-327">Todavía es necesario proporcionar el valor de `UnitPrice` para los valores originales, por lo que seguiremos necesitando una instrucción de enlace de los dos sentidos en el `ItemTemplate`, pero se puede colocar en un control Web de etiqueta cuya propiedad `Visible` esté establecida en `false`.</span><span class="sxs-lookup"><span data-stu-id="f348c-327">We still need to provide the `UnitPrice` value for the original values, so we'll still need a two-way databinding statement in the `ItemTemplate`, but this can be placed in a Label Web control whose `Visible` property is set to `false`.</span></span> <span data-ttu-id="f348c-328">Podríamos usar el marcado siguiente en ItemTemplate:</span><span class="sxs-lookup"><span data-stu-id="f348c-328">We could use the following markup in the ItemTemplate:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample10.aspx)]

- <span data-ttu-id="f348c-329">Quite el formato de moneda del `ItemTemplate`mediante `<%# Bind("UnitPrice") %>`.</span><span class="sxs-lookup"><span data-stu-id="f348c-329">Remove the currency formatting from the `ItemTemplate`, using `<%# Bind("UnitPrice") %>`.</span></span> <span data-ttu-id="f348c-330">En el controlador de eventos `RowDataBound` de GridView, acceda mediante programación al control Web Label en el que se muestra el valor `UnitPrice` y establezca su propiedad `Text` en la versión con formato.</span><span class="sxs-lookup"><span data-stu-id="f348c-330">In the GridView's `RowDataBound` event handler, programmatically access the Label Web control within which the `UnitPrice` value is displayed and set its `Text` property to the formatted version.</span></span>
- <span data-ttu-id="f348c-331">Deje el `UnitPrice` con formato de moneda.</span><span class="sxs-lookup"><span data-stu-id="f348c-331">Leave the `UnitPrice` formatted as a currency.</span></span> <span data-ttu-id="f348c-332">En el controlador de eventos `RowDeleting` de GridView, reemplace el valor de `UnitPrice` original existente ($19,95) por un valor decimal real mediante `Decimal.Parse`.</span><span class="sxs-lookup"><span data-stu-id="f348c-332">In the GridView's `RowDeleting` event handler, replace the existing original `UnitPrice` value ($19.95) with an actual decimal value using `Decimal.Parse`.</span></span> <span data-ttu-id="f348c-333">Vimos cómo conseguir algo similar en el controlador de eventos `RowUpdating` en el [*control de excepciones de nivel BLL y Dal en un tutorial de página de ASP.net*](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) .</span><span class="sxs-lookup"><span data-stu-id="f348c-333">We saw how to accomplish something similar in the `RowUpdating` event handler in the [*Handling BLL- and DAL-Level Exceptions in an ASP.NET Page*](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) tutorial.</span></span>

<span data-ttu-id="f348c-334">En mi ejemplo, decidí usar el segundo enfoque, agregar un control Web de etiqueta oculto cuya propiedad `Text` sea datos bidireccionales enlazados al valor de `UnitPrice` sin formato.</span><span class="sxs-lookup"><span data-stu-id="f348c-334">For my example I chose to go with the second approach, adding a hidden Label Web control whose `Text` property is two-way data bound to the unformatted `UnitPrice` value.</span></span>

<span data-ttu-id="f348c-335">Después de resolver este problema, intente hacer clic de nuevo en el botón eliminar de cualquier producto.</span><span class="sxs-lookup"><span data-stu-id="f348c-335">After solving this problem, try clicking the Delete button for any product again.</span></span> <span data-ttu-id="f348c-336">Esta vez obtendrá un `InvalidOperationException` cuando ObjectDataSource intente invocar el método de `UpdateProduct` de la capa BLL.</span><span class="sxs-lookup"><span data-stu-id="f348c-336">This time you'll get an `InvalidOperationException` when the ObjectDataSource attempts to invoke the BLL's `UpdateProduct` method.</span></span>

<span data-ttu-id="f348c-337">[![ObjectDataSource no encuentra un método con los parámetros de entrada que desea enviar](implementing-optimistic-concurrency-vb/_static/image45.png)](implementing-optimistic-concurrency-vb/_static/image44.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-337">[![The ObjectDataSource Cannot Find a Method with the Input Parameters it Wants to Send](implementing-optimistic-concurrency-vb/_static/image45.png)](implementing-optimistic-concurrency-vb/_static/image44.png)</span></span>

<span data-ttu-id="f348c-338">**Figura 16**: ObjectDataSource no encuentra un método con los parámetros de entrada que desea enviar ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image46.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-338">**Figure 16**: The ObjectDataSource Cannot Find a Method with the Input Parameters it Wants to Send ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image46.png))</span></span>

<span data-ttu-id="f348c-339">Al examinar el mensaje de la excepción, es evidente que ObjectDataSource desea invocar un método BLL `DeleteProduct` que incluye los parámetros de entrada `original_CategoryName` y `original_SupplierName`.</span><span class="sxs-lookup"><span data-stu-id="f348c-339">Looking at the exception's message, it's clear that the ObjectDataSource wants to invoke a BLL `DeleteProduct` method that includes `original_CategoryName` and `original_SupplierName` input parameters.</span></span> <span data-ttu-id="f348c-340">Esto se debe a que los `ItemTemplate` s para el `CategoryID` y `SupplierID` TemplateFields contienen actualmente instrucciones de enlace bidireccionales con los campos de datos `CategoryName` y `SupplierName`.</span><span class="sxs-lookup"><span data-stu-id="f348c-340">This is because the `ItemTemplate` s for the `CategoryID` and `SupplierID` TemplateFields currently contain two-way Bind statements with the `CategoryName` and `SupplierName` data fields.</span></span> <span data-ttu-id="f348c-341">En su lugar, es necesario incluir `Bind` instrucciones con los campos de datos `CategoryID` y `SupplierID`.</span><span class="sxs-lookup"><span data-stu-id="f348c-341">Instead, we need to include `Bind` statements with the `CategoryID` and `SupplierID` data fields.</span></span> <span data-ttu-id="f348c-342">Para ello, reemplace las instrucciones BIND existentes por `Eval` instrucciones y, a continuación, agregue controles de etiqueta ocultos cuyas propiedades `Text` estén enlazadas a los campos de datos `CategoryID` y `SupplierID` mediante el enlace de datos bidireccional, como se muestra a continuación:</span><span class="sxs-lookup"><span data-stu-id="f348c-342">To accomplish this, replace the existing Bind statements with `Eval` statements, and then add hidden Label controls whose `Text` properties are bound to the `CategoryID` and `SupplierID` data fields using two-way databinding, as shown below:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample11.aspx)]

<span data-ttu-id="f348c-343">Con estos cambios, ahora podemos eliminar y editar correctamente la información del producto.</span><span class="sxs-lookup"><span data-stu-id="f348c-343">With these changes, we are now able to successfully delete and edit product information!</span></span> <span data-ttu-id="f348c-344">En el paso 5 veremos cómo comprobar que se detectan infracciones de simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="f348c-344">In Step 5 we'll look at how to verify that concurrency violations are being detected.</span></span> <span data-ttu-id="f348c-345">Pero por ahora, dedique unos minutos a intentar actualizar y eliminar algunos registros para asegurarse de que la actualización y la eliminación de un solo usuario funcionan según lo previsto.</span><span class="sxs-lookup"><span data-stu-id="f348c-345">But for now, take a few minutes to try updating and deleting a few records to ensure that updating and deleting for a single user works as expected.</span></span>

## <a name="step-5-testing-the-optimistic-concurrency-support"></a><span data-ttu-id="f348c-346">Paso 5: probar la compatibilidad con la simultaneidad optimista</span><span class="sxs-lookup"><span data-stu-id="f348c-346">Step 5: Testing the Optimistic Concurrency Support</span></span>

<span data-ttu-id="f348c-347">Con el fin de comprobar que se detectan infracciones de simultaneidad (en lugar de que se sobrescriban los datos), es necesario abrir dos ventanas del explorador en esta página.</span><span class="sxs-lookup"><span data-stu-id="f348c-347">In order to verify that concurrency violations are being detected (rather than resulting in data being blindly overwritten), we need to open two browser windows to this page.</span></span> <span data-ttu-id="f348c-348">En ambas instancias del explorador, haga clic en el botón Editar para Chai.</span><span class="sxs-lookup"><span data-stu-id="f348c-348">In both browser instances, click on the Edit button for Chai.</span></span> <span data-ttu-id="f348c-349">A continuación, en solo uno de los exploradores, cambie el nombre a "Chai té" y haga clic en actualizar.</span><span class="sxs-lookup"><span data-stu-id="f348c-349">Then, in just one of the browsers, change the name to "Chai Tea" and click Update.</span></span> <span data-ttu-id="f348c-350">La actualización debe realizarse correctamente y devolver GridView a su estado de edición previa, con "Chai té" como el nuevo nombre del producto.</span><span class="sxs-lookup"><span data-stu-id="f348c-350">The update should succeed and return the GridView to its pre-editing state, with "Chai Tea" as the new product name.</span></span>

<span data-ttu-id="f348c-351">En la otra instancia de la ventana del explorador, sin embargo, el cuadro de texto nombre del producto sigue mostrando "Chai".</span><span class="sxs-lookup"><span data-stu-id="f348c-351">In the other browser window instance, however, the product name TextBox still shows "Chai".</span></span> <span data-ttu-id="f348c-352">En esta segunda ventana del explorador, actualice el `UnitPrice` a `25.00`.</span><span class="sxs-lookup"><span data-stu-id="f348c-352">In this second browser window, update the `UnitPrice` to `25.00`.</span></span> <span data-ttu-id="f348c-353">Sin la compatibilidad con la simultaneidad optimista, al hacer clic en actualizar en la segunda instancia del explorador se cambia el nombre del producto de nuevo a "Chai", con lo que se sobrescriben los cambios realizados por la primera instancia del explorador.</span><span class="sxs-lookup"><span data-stu-id="f348c-353">Without optimistic concurrency support, clicking update in the second browser instance would change the product name back to "Chai", thereby overwriting the changes made by the first browser instance.</span></span> <span data-ttu-id="f348c-354">Sin embargo, con la simultaneidad optimista empleada, al hacer clic en el botón actualizar de la segunda instancia del explorador, se produce una [DBConcurrencyException](https://msdn.microsoft.com/library/system.data.dbconcurrencyexception.aspx).</span><span class="sxs-lookup"><span data-stu-id="f348c-354">With optimistic concurrency employed, however, clicking the Update button in the second browser instance results in a [DBConcurrencyException](https://msdn.microsoft.com/library/system.data.dbconcurrencyexception.aspx).</span></span>

<span data-ttu-id="f348c-355">[![cuando se detecta una infracción de simultaneidad, se produce una excepción DBConcurrencyException](implementing-optimistic-concurrency-vb/_static/image48.png)](implementing-optimistic-concurrency-vb/_static/image47.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-355">[![When a Concurrency Violation is Detected, a DBConcurrencyException is Thrown](implementing-optimistic-concurrency-vb/_static/image48.png)](implementing-optimistic-concurrency-vb/_static/image47.png)</span></span>

<span data-ttu-id="f348c-356">**Figura 17**: cuando se detecta una infracción de simultaneidad, se produce una `DBConcurrencyException` ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image49.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-356">**Figure 17**: When a Concurrency Violation is Detected, a `DBConcurrencyException` is Thrown ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image49.png))</span></span>

<span data-ttu-id="f348c-357">El `DBConcurrencyException` solo se produce cuando se emplea el modelo de actualización por lotes de la capa DAL.</span><span class="sxs-lookup"><span data-stu-id="f348c-357">The `DBConcurrencyException` is only thrown when the DAL's batch update pattern is utilized.</span></span> <span data-ttu-id="f348c-358">El patrón de DB Direct no genera una excepción, simplemente indica que no se ha visto afectada ninguna fila.</span><span class="sxs-lookup"><span data-stu-id="f348c-358">The DB direct pattern does not raise an exception, it merely indicates that no rows were affected.</span></span> <span data-ttu-id="f348c-359">Para ilustrar esto, devuelva el valor de GridView de ambas instancias del explorador a su estado de edición previa.</span><span class="sxs-lookup"><span data-stu-id="f348c-359">To illustrate this, return both browser instances' GridView to their pre-editing state.</span></span> <span data-ttu-id="f348c-360">Después, en la primera instancia del explorador, haga clic en el botón Editar y cambie el nombre del producto de "Chai té" a "Chai" y haga clic en actualizar.</span><span class="sxs-lookup"><span data-stu-id="f348c-360">Next, in the first browser instance, click the Edit button and change the product name from "Chai Tea" back to "Chai" and click Update.</span></span> <span data-ttu-id="f348c-361">En la segunda ventana del explorador, haga clic en el botón eliminar de Chai.</span><span class="sxs-lookup"><span data-stu-id="f348c-361">In the second browser window, click the Delete button for Chai.</span></span>

<span data-ttu-id="f348c-362">Al hacer clic en eliminar, la página se devuelve, el control GridView invoca el método `Delete()` de ObjectDataSource y el ObjectDataSource llama al método `DeleteProduct` de la clase `ProductsOptimisticConcurrencyBLL`, pasando a lo largo de los valores originales.</span><span class="sxs-lookup"><span data-stu-id="f348c-362">Upon clicking Delete, the page posts back, the GridView invokes the ObjectDataSource's `Delete()` method, and the ObjectDataSource calls down into the `ProductsOptimisticConcurrencyBLL` class's `DeleteProduct` method, passing along the original values.</span></span> <span data-ttu-id="f348c-363">El valor de `ProductName` original para la segunda instancia del explorador es "Chai té", que no coincide con el valor de `ProductName` actual de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="f348c-363">The original `ProductName` value for the second browser instance is "Chai Tea", which doesn't match up with the current `ProductName` value in the database.</span></span> <span data-ttu-id="f348c-364">Por lo tanto, la instrucción `DELETE` emitida a la base de datos afecta a cero filas, ya que no hay ningún registro en la base de datos que cumpla la cláusula `WHERE`.</span><span class="sxs-lookup"><span data-stu-id="f348c-364">Therefore the `DELETE` statement issued to the database affects zero rows since there's no record in the database that the `WHERE` clause satisfies.</span></span> <span data-ttu-id="f348c-365">El método `DeleteProduct` devuelve `false` y los datos de ObjectDataSource se reenlazan a GridView.</span><span class="sxs-lookup"><span data-stu-id="f348c-365">The `DeleteProduct` method returns `false` and the ObjectDataSource's data is rebound to the GridView.</span></span>

<span data-ttu-id="f348c-366">Desde la perspectiva del usuario final, al hacer clic en el botón Eliminar para el té de Chai en la segunda ventana del explorador se produjo que la pantalla parpadee y, al volver, el producto sigue estando allí, aunque ahora aparece como "Chai" (el cambio de nombre de producto realizado por el primer explorador instancia).</span><span class="sxs-lookup"><span data-stu-id="f348c-366">From the end user's perspective, clicking on the Delete button for Chai Tea in the second browser window caused the screen to flash and, upon coming back, the product is still there, although now it's listed as "Chai" (the product name change made by the first browser instance).</span></span> <span data-ttu-id="f348c-367">Si el usuario vuelve a hacer clic en el botón eliminar, la eliminación se realizará correctamente, ya que el valor de `ProductName` original de GridView ("Chai") coincide ahora con el valor de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="f348c-367">If the user clicks the Delete button again, the Delete will succeed, as the GridView's original `ProductName` value ("Chai") now matches up with the value in the database.</span></span>

<span data-ttu-id="f348c-368">En ambos casos, la experiencia del usuario está lejos del ideal.</span><span class="sxs-lookup"><span data-stu-id="f348c-368">In both of these cases, the user experience is far from ideal.</span></span> <span data-ttu-id="f348c-369">No queremos mostrar al usuario los detalles esenciales de la `DBConcurrencyException` excepción al usar el patrón de actualización por lotes.</span><span class="sxs-lookup"><span data-stu-id="f348c-369">We clearly don't want to show the user the nitty-gritty details of the `DBConcurrencyException` exception when using the batch update pattern.</span></span> <span data-ttu-id="f348c-370">Y el comportamiento cuando se usa el patrón de DB Direct es algo confuso a medida que se produce un error en el comando de los usuarios, pero no hay ninguna indicación precisa de por qué.</span><span class="sxs-lookup"><span data-stu-id="f348c-370">And the behavior when using the DB direct pattern is somewhat confusing as the users command failed, but there was no precise indication of why.</span></span>

<span data-ttu-id="f348c-371">Para solucionar estos dos problemas, podemos crear controles Web de etiqueta en la página que proporcionan una explicación de por qué se produjo un error en una actualización o una eliminación.</span><span class="sxs-lookup"><span data-stu-id="f348c-371">To remedy these two issues, we can create Label Web controls on the page that provide an explanation to why an update or delete failed.</span></span> <span data-ttu-id="f348c-372">Para el patrón de actualización por lotes, podemos determinar si se produjo o no una excepción `DBConcurrencyException` en el controlador de eventos de nivel posterior de GridView, mostrando la etiqueta de advertencia según sea necesario.</span><span class="sxs-lookup"><span data-stu-id="f348c-372">For the batch update pattern, we can determine whether or not a `DBConcurrencyException` exception occurred in the GridView's post-level event handler, displaying the warning label as needed.</span></span> <span data-ttu-id="f348c-373">En el método de DB Direct, podemos examinar el valor devuelto del método BLL (que es `true` si una fila se ve afectada, `false` de otro modo) y mostrar un mensaje informativo según sea necesario.</span><span class="sxs-lookup"><span data-stu-id="f348c-373">For the DB direct method, we can examine the return value of the BLL method (which is `true` if one row was affected, `false` otherwise) and display an informational message as needed.</span></span>

## <a name="step-6-adding-informational-messages-and-displaying-them-in-the-face-of-a-concurrency-violation"></a><span data-ttu-id="f348c-374">Paso 6: agregar mensajes informativos y mostrarlos en caso de que se produzca una infracción de simultaneidad</span><span class="sxs-lookup"><span data-stu-id="f348c-374">Step 6: Adding Informational Messages and Displaying Them in the Face of a Concurrency Violation</span></span>

<span data-ttu-id="f348c-375">Cuando se produce una infracción de simultaneidad, el comportamiento que se exhibe depende de si se ha utilizado la actualización por lotes o el patrón de base de BD de la capa DAL.</span><span class="sxs-lookup"><span data-stu-id="f348c-375">When a concurrency violation occurs, the behavior exhibited depends on whether the DAL's batch update or DB direct pattern was used.</span></span> <span data-ttu-id="f348c-376">En nuestro tutorial se usan ambos patrones, con el patrón de actualización por lotes que se usa para la actualización y el patrón de DB Direct que se usa para la eliminación.</span><span class="sxs-lookup"><span data-stu-id="f348c-376">Our tutorial uses both patterns, with the batch update pattern being used for updating and the DB direct pattern used for deleting.</span></span> <span data-ttu-id="f348c-377">Para empezar, vamos a agregar dos controles Web Label a nuestra página que explican que se ha producido una infracción de simultaneidad al intentar eliminar o actualizar los datos.</span><span class="sxs-lookup"><span data-stu-id="f348c-377">To get started, let's add two Label Web controls to our page that explain that a concurrency violation occurred when attempting to delete or update data.</span></span> <span data-ttu-id="f348c-378">Establezca las propiedades `Visible` y `EnableViewState` del control de etiqueta en `false`; Esto hará que se oculten en cada visita de página, excepto en las visitas de página concretas en las que la propiedad `Visible` se establece mediante programación en `true`.</span><span class="sxs-lookup"><span data-stu-id="f348c-378">Set the Label control's `Visible` and `EnableViewState` properties to `false`; this will cause them to be hidden on each page visit except for those particular page visits where their `Visible` property is programmatically set to `true`.</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample12.aspx)]

<span data-ttu-id="f348c-379">Además de establecer las propiedades `Visible`, `EnabledViewState`y `Text`, también se ha establecido la propiedad `CssClass` en `Warning`, lo que hace que la etiqueta se muestre en una fuente grande, roja, cursiva y negrita.</span><span class="sxs-lookup"><span data-stu-id="f348c-379">In addition to setting their `Visible`, `EnabledViewState`, and `Text` properties, I've also set the `CssClass` property to `Warning`, which causes the Label's to be displayed in a large, red, italic, bold font.</span></span> <span data-ttu-id="f348c-380">Esta clase de `Warning` CSS se definió y se agregó a Styles. CSS de nuevo en el tutorial *examinar los eventos asociados con la inserción, actualización y eliminación* .</span><span class="sxs-lookup"><span data-stu-id="f348c-380">This CSS `Warning` class was defined and added to Styles.css back in the *Examining the Events Associated with Inserting, Updating, and Deleting* tutorial.</span></span>

<span data-ttu-id="f348c-381">Después de agregar estas etiquetas, el diseñador de Visual Studio debería tener un aspecto similar al de la figura 18.</span><span class="sxs-lookup"><span data-stu-id="f348c-381">After adding these Labels, the Designer in Visual Studio should look similar to Figure 18.</span></span>

<span data-ttu-id="f348c-382">[![se han agregado dos controles de etiqueta a la página](implementing-optimistic-concurrency-vb/_static/image51.png)](implementing-optimistic-concurrency-vb/_static/image50.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-382">[![Two Label Controls Have Been Added to the Page](implementing-optimistic-concurrency-vb/_static/image51.png)](implementing-optimistic-concurrency-vb/_static/image50.png)</span></span>

<span data-ttu-id="f348c-383">**Figura 18**: se han agregado dos controles de etiqueta a la página ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image52.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-383">**Figure 18**: Two Label Controls Have Been Added to the Page ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image52.png))</span></span>

<span data-ttu-id="f348c-384">Con estos controles Web de etiqueta en su lugar, estamos preparados para examinar cómo determinar cuándo se ha producido una infracción de simultaneidad, momento en el que la propiedad `Visible` de la etiqueta adecuada se puede establecer en `true`, mostrando el mensaje informativo.</span><span class="sxs-lookup"><span data-stu-id="f348c-384">With these Label Web controls in place, we're ready to examine how to determine when a concurrency violation has occurred, at which point the appropriate Label's `Visible` property can be set to `true`, displaying the informational message.</span></span>

## <a name="handling-concurrency-violations-when-updating"></a><span data-ttu-id="f348c-385">Controlar infracciones de simultaneidad al actualizar</span><span class="sxs-lookup"><span data-stu-id="f348c-385">Handling Concurrency Violations When Updating</span></span>

<span data-ttu-id="f348c-386">Veamos primero cómo administrar las infracciones de simultaneidad al usar el patrón de actualización por lotes.</span><span class="sxs-lookup"><span data-stu-id="f348c-386">Let's first look at how to handle concurrency violations when using the batch update pattern.</span></span> <span data-ttu-id="f348c-387">Puesto que estas infracciones con el patrón de actualización por lotes provocan que se inicie una excepción `DBConcurrencyException`, es necesario agregar código a la página ASP.NET para determinar si se ha producido una excepción `DBConcurrencyException` durante el proceso de actualización.</span><span class="sxs-lookup"><span data-stu-id="f348c-387">Since such violations with the batch update pattern cause a `DBConcurrencyException` exception to be thrown, we need to add code to our ASP.NET page to determine whether a `DBConcurrencyException` exception occurred during the update process.</span></span> <span data-ttu-id="f348c-388">Si es así, se debe mostrar un mensaje al usuario que explique que sus cambios no se guardaron porque otro usuario modificó los mismos datos entre el momento en que comenzó a editar el registro y cuando hizo clic en el botón actualizar.</span><span class="sxs-lookup"><span data-stu-id="f348c-388">If so, we should display a message to the user explaining that their changes were not saved because another user had modified the same data between when they started editing the record and when they clicked the Update button.</span></span>

<span data-ttu-id="f348c-389">Como hemos visto en el artículo sobre cómo *controlar las excepciones de nivel BLL y Dal en un tutorial de páginas de ASP.net* , estas excepciones se pueden detectar y suprimir en los controladores de eventos de nivel posterior del control Web de datos.</span><span class="sxs-lookup"><span data-stu-id="f348c-389">As we saw in the *Handling BLL- and DAL-Level Exceptions in an ASP.NET Page* tutorial, such exceptions can be detected and suppressed in the data Web control's post-level event handlers.</span></span> <span data-ttu-id="f348c-390">Por lo tanto, es necesario crear un controlador de eventos para el evento de `RowUpdated` de GridView que comprueba si se ha producido una excepción de `DBConcurrencyException`.</span><span class="sxs-lookup"><span data-stu-id="f348c-390">Therefore, we need to create an event handler for the GridView's `RowUpdated` event that checks if a `DBConcurrencyException` exception has been thrown.</span></span> <span data-ttu-id="f348c-391">A este controlador de eventos se le pasa una referencia a cualquier excepción que se provocó durante el proceso de actualización, como se muestra en el código del controlador de eventos siguiente:</span><span class="sxs-lookup"><span data-stu-id="f348c-391">This event handler is passed a reference to any exception that was raised during the updating process, as shown in the event handler code below:</span></span>

[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample13.vb)]

<span data-ttu-id="f348c-392">En el caso de una excepción `DBConcurrencyException`, este controlador de eventos muestra el control etiqueta de `UpdateConflictMessage` e indica que se ha controlado la excepción.</span><span class="sxs-lookup"><span data-stu-id="f348c-392">In the face of a `DBConcurrencyException` exception, this event handler displays the `UpdateConflictMessage` Label control and indicates that the exception has been handled.</span></span> <span data-ttu-id="f348c-393">Con este código en su lugar, cuando se produce una infracción de simultaneidad al actualizar un registro, se pierden los cambios del usuario, ya que se habrían sobrescrito las modificaciones de otro usuario al mismo tiempo.</span><span class="sxs-lookup"><span data-stu-id="f348c-393">With this code in place, when a concurrency violation occurs when updating a record, the user's changes are lost, since they would have overwritten another user's modifications at the same time.</span></span> <span data-ttu-id="f348c-394">En concreto, el control GridView se devuelve a su estado de edición previa y se enlaza a los datos de la base de datos actual.</span><span class="sxs-lookup"><span data-stu-id="f348c-394">In particular, the GridView is returned to its pre-editing state and bound to the current database data.</span></span> <span data-ttu-id="f348c-395">Esto actualizará la fila de GridView con los cambios del otro usuario, que antes no eran visibles.</span><span class="sxs-lookup"><span data-stu-id="f348c-395">This will update the GridView row with the other user's changes, which were previously not visible.</span></span> <span data-ttu-id="f348c-396">Además, el control etiqueta de `UpdateConflictMessage` le explicará al usuario lo que ha sucedido.</span><span class="sxs-lookup"><span data-stu-id="f348c-396">Additionally, the `UpdateConflictMessage` Label control will explain to the user what just happened.</span></span> <span data-ttu-id="f348c-397">Esta secuencia de eventos se detalla en la figura 19.</span><span class="sxs-lookup"><span data-stu-id="f348c-397">This sequence of events is detailed in Figure 19.</span></span>

<span data-ttu-id="f348c-398">[![se pierden las actualizaciones de un usuario en caso de que se produzca una infracción de simultaneidad](implementing-optimistic-concurrency-vb/_static/image54.png)](implementing-optimistic-concurrency-vb/_static/image53.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-398">[![A User s Updates are Lost in the Face of a Concurrency Violation](implementing-optimistic-concurrency-vb/_static/image54.png)](implementing-optimistic-concurrency-vb/_static/image53.png)</span></span>

<span data-ttu-id="f348c-399">**Figura 19**: las actualizaciones de un usuario se pierden en el caso de una infracción de simultaneidad ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image55.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-399">**Figure 19**: A User s Updates are Lost in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image55.png))</span></span>

> [!NOTE]
> <span data-ttu-id="f348c-400">Como alternativa, en lugar de devolver GridView al estado de edición previa, podríamos dejar GridView en su estado de edición estableciendo la propiedad `KeepInEditMode` del objeto `GridViewUpdatedEventArgs` pasado en true.</span><span class="sxs-lookup"><span data-stu-id="f348c-400">Alternatively, rather than returning the GridView to the pre-editing state, we could leave the GridView in its editing state by setting the `KeepInEditMode` property of the passed-in `GridViewUpdatedEventArgs` object to true.</span></span> <span data-ttu-id="f348c-401">Sin embargo, si adopta este enfoque, asegúrese de volver a enlazar los datos a GridView (invocando su método `DataBind()`) para que los valores del otro usuario se carguen en la interfaz de edición.</span><span class="sxs-lookup"><span data-stu-id="f348c-401">If you take this approach, however, be certain to rebind the data to the GridView (by invoking its `DataBind()` method) so that the other user's values are loaded into the editing interface.</span></span> <span data-ttu-id="f348c-402">El código disponible para su descarga con este tutorial tiene dos líneas de código en el `RowUpdated` controlador de eventos comentado. simplemente quite la marca de comentario de estas líneas de código para que GridView permanezca en modo de edición después de una infracción de simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="f348c-402">The code available for download with this tutorial has these two lines of code in the `RowUpdated` event handler commented out; simply uncomment these lines of code to have the GridView remain in edit mode after a concurrency violation.</span></span>

## <a name="responding-to-concurrency-violations-when-deleting"></a><span data-ttu-id="f348c-403">Responder a infracciones de simultaneidad al eliminar</span><span class="sxs-lookup"><span data-stu-id="f348c-403">Responding to Concurrency Violations When Deleting</span></span>

<span data-ttu-id="f348c-404">Con el patrón de DB Direct, no se produce ninguna excepción en el caso de una infracción de simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="f348c-404">With the DB direct pattern, there is no exception raised in the face of a concurrency violation.</span></span> <span data-ttu-id="f348c-405">En su lugar, la instrucción de base de datos simplemente afecta a los registros, ya que la cláusula WHERE no coincide con ningún registro.</span><span class="sxs-lookup"><span data-stu-id="f348c-405">Instead, the database statement simply affects no records, as the WHERE clause does not match with any record.</span></span> <span data-ttu-id="f348c-406">Todos los métodos de modificación de datos creados en el BLL se han diseñado de forma que devuelvan un valor booleano que indique si afectan exactamente a un registro.</span><span class="sxs-lookup"><span data-stu-id="f348c-406">All of the data modification methods created in the BLL have been designed such that they return a Boolean value indicating whether or not they affected precisely one record.</span></span> <span data-ttu-id="f348c-407">Por lo tanto, para determinar si se produjo una infracción de simultaneidad al eliminar un registro, podemos examinar el valor devuelto del método `DeleteProduct` de la capa BLL.</span><span class="sxs-lookup"><span data-stu-id="f348c-407">Therefore, to determine if a concurrency violation occurred when deleting a record, we can examine the return value of the BLL's `DeleteProduct` method.</span></span>

<span data-ttu-id="f348c-408">El valor devuelto para un método BLL se puede examinar en los controladores de eventos de nivel posterior de ObjectDataSource a través de la propiedad `ReturnValue` del `ObjectDataSourceStatusEventArgs` objeto pasado al controlador de eventos.</span><span class="sxs-lookup"><span data-stu-id="f348c-408">The return value for a BLL method can be examined in the ObjectDataSource's post-level event handlers through the `ReturnValue` property of the `ObjectDataSourceStatusEventArgs` object passed into the event handler.</span></span> <span data-ttu-id="f348c-409">Como estamos interesados en determinar el valor devuelto del método `DeleteProduct`, es necesario crear un controlador de eventos para el evento de `Deleted` de ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="f348c-409">Since we are interested in determining the return value from the `DeleteProduct` method, we need to create an event handler for the ObjectDataSource's `Deleted` event.</span></span> <span data-ttu-id="f348c-410">La propiedad `ReturnValue` es de tipo `object` y se puede `null` si se ha producido una excepción y se ha interrumpido el método antes de que pueda devolver un valor.</span><span class="sxs-lookup"><span data-stu-id="f348c-410">The `ReturnValue` property is of type `object` and can be `null` if an exception was raised and the method was interrupted before it could return a value.</span></span> <span data-ttu-id="f348c-411">Por lo tanto, primero debemos asegurarnos de que la propiedad `ReturnValue` no sea `null` y sea un valor booleano.</span><span class="sxs-lookup"><span data-stu-id="f348c-411">Therefore, we should first ensure that the `ReturnValue` property is not `null` and is a Boolean value.</span></span> <span data-ttu-id="f348c-412">Suponiendo que esta comprobación se supere, mostramos el control etiqueta `DeleteConflictMessage` si el `ReturnValue` es `false`.</span><span class="sxs-lookup"><span data-stu-id="f348c-412">Assuming this check passes, we show the `DeleteConflictMessage` Label control if the `ReturnValue` is `false`.</span></span> <span data-ttu-id="f348c-413">Esto puede realizarse mediante el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="f348c-413">This can be accomplished by using the following code:</span></span>

[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample14.vb)]

<span data-ttu-id="f348c-414">En el caso de una infracción de simultaneidad, se cancela la solicitud de eliminación del usuario.</span><span class="sxs-lookup"><span data-stu-id="f348c-414">In the face of a concurrency violation, the user's delete request is canceled.</span></span> <span data-ttu-id="f348c-415">Se actualiza GridView, que muestra los cambios que se produjeron para ese registro entre el momento en que el usuario cargó la página y cuando hizo clic en el botón Eliminar.</span><span class="sxs-lookup"><span data-stu-id="f348c-415">The GridView is refreshed, showing the changes that occurred for that record between the time the user loaded the page and when he clicked the Delete button.</span></span> <span data-ttu-id="f348c-416">Cuando se produzca una infracción de este tipo, se muestra la etiqueta de `DeleteConflictMessage`, en la que se explica lo que sucede (vea la figura 20).</span><span class="sxs-lookup"><span data-stu-id="f348c-416">When such a violation transpires, the `DeleteConflictMessage` Label is shown, explaining what just happened (see Figure 20).</span></span>

<span data-ttu-id="f348c-417">[![una eliminación de usuario se cancela en el caso de una infracción de simultaneidad](implementing-optimistic-concurrency-vb/_static/image57.png)](implementing-optimistic-concurrency-vb/_static/image56.png)</span><span class="sxs-lookup"><span data-stu-id="f348c-417">[![A User s Delete is Canceled in the Face of a Concurrency Violation](implementing-optimistic-concurrency-vb/_static/image57.png)](implementing-optimistic-concurrency-vb/_static/image56.png)</span></span>

<span data-ttu-id="f348c-418">**Figura 20**: la eliminación de un usuario se cancela en el caso de una infracción de simultaneidad ([haga clic para ver la imagen de tamaño completo](implementing-optimistic-concurrency-vb/_static/image58.png))</span><span class="sxs-lookup"><span data-stu-id="f348c-418">**Figure 20**: A User s Delete is Canceled in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image58.png))</span></span>

## <a name="summary"></a><span data-ttu-id="f348c-419">Resumen</span><span class="sxs-lookup"><span data-stu-id="f348c-419">Summary</span></span>

<span data-ttu-id="f348c-420">Existen oportunidades de infracciones de simultaneidad en todas las aplicaciones que permiten a varios usuarios simultáneos actualizar o eliminar datos.</span><span class="sxs-lookup"><span data-stu-id="f348c-420">Opportunities for concurrency violations exist in every application that allows multiple, concurrent users to update or delete data.</span></span> <span data-ttu-id="f348c-421">Si estas infracciones no se tienen en cuenta, cuando dos usuarios actualizan simultáneamente los mismos datos que ganan en la última escritura "gana", se sobrescriben los cambios del otro usuario.</span><span class="sxs-lookup"><span data-stu-id="f348c-421">If such violations are not accounted for, when two users simultaneously update the same data whoever gets in the last write "wins," overwriting the other user's changes changes.</span></span> <span data-ttu-id="f348c-422">Como alternativa, los desarrolladores pueden implementar el control de simultaneidad optimista o pesimista.</span><span class="sxs-lookup"><span data-stu-id="f348c-422">Alternatively, developers can implement either optimistic or pessimistic concurrency control.</span></span> <span data-ttu-id="f348c-423">El control de simultaneidad optimista supone que las infracciones de simultaneidad son poco frecuentes y simplemente no permiten un comando UPDATE o DELETE que constituya una infracción de simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="f348c-423">Optimistic concurrency control assumes that concurrency violations are infrequent and simply disallows an update or delete command that would constitute a concurrency violation.</span></span> <span data-ttu-id="f348c-424">El control de simultaneidad pesimista supone que las infracciones de simultaneidad son frecuentes y simplemente rechazar el comando UPDATE o DELETE de un usuario no es aceptable.</span><span class="sxs-lookup"><span data-stu-id="f348c-424">Pessimistic concurrency control assumes that concurrency violations are frequent and simply rejecting one user's update or delete command is not acceptable.</span></span> <span data-ttu-id="f348c-425">Con el control de simultaneidad pesimista, la actualización de un registro implica su bloqueo, lo que impide que otros usuarios modifiquen o eliminen el registro mientras está bloqueado.</span><span class="sxs-lookup"><span data-stu-id="f348c-425">With pessimistic concurrency control, updating a record involves locking it, thereby preventing any other users from modifying or deleting the record while it is locked.</span></span>

<span data-ttu-id="f348c-426">El DataSet con tipo en .NET proporciona funcionalidad para admitir el control de simultaneidad optimista.</span><span class="sxs-lookup"><span data-stu-id="f348c-426">The Typed DataSet in .NET provides functionality for supporting optimistic concurrency control.</span></span> <span data-ttu-id="f348c-427">En concreto, las instrucciones `UPDATE` y `DELETE` que se emiten a la base de datos incluyen todas las columnas de la tabla, lo que garantiza que la actualización o eliminación solo se producirá si los datos actuales del registro coinciden con los datos originales que tenía el usuario al realizar la actualización o la eliminación.</span><span class="sxs-lookup"><span data-stu-id="f348c-427">In particular, the `UPDATE` and `DELETE` statements issued to the database include all of the table's columns, thereby ensuring that the update or delete will only occur if the record's current data matches with the original data the user had when performing their update or delete.</span></span> <span data-ttu-id="f348c-428">Una vez configurada la capa DAL para admitir la simultaneidad optimista, los métodos de BLL deben actualizarse.</span><span class="sxs-lookup"><span data-stu-id="f348c-428">Once the DAL has been configured to support optimistic concurrency, the BLL methods need to be updated.</span></span> <span data-ttu-id="f348c-429">Además, la página ASP.NET que llama a la capa BLL debe estar configurada de modo que ObjectDataSource recupere los valores originales de su control Web de datos y los pase a la capa BLL.</span><span class="sxs-lookup"><span data-stu-id="f348c-429">Additionally, the ASP.NET page that calls down into the BLL must be configured such that the ObjectDataSource retrieves the original values from its data Web control and passes them down into the BLL.</span></span>

<span data-ttu-id="f348c-430">Como hemos visto en este tutorial, la implementación del control de simultaneidad optimista en una aplicación Web ASP.NET implica la actualización de la capa DAL y BLL y la adición de compatibilidad en la página ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="f348c-430">As we saw in this tutorial, implementing optimistic concurrency control in an ASP.NET web application involves updating the DAL and BLL and adding support in the ASP.NET page.</span></span> <span data-ttu-id="f348c-431">Si este trabajo agregado es una inversión razonable de su tiempo y esfuerzo depende de su aplicación.</span><span class="sxs-lookup"><span data-stu-id="f348c-431">Whether or not this added work is a wise investment of your time and effort depends on your application.</span></span> <span data-ttu-id="f348c-432">Si tiene pocos usuarios simultáneos que actualizan datos, o si los datos que se están actualizando son diferentes entre sí, el control de simultaneidad no es un problema clave.</span><span class="sxs-lookup"><span data-stu-id="f348c-432">If you infrequently have concurrent users updating data, or the data they are updating is different from one another, then concurrency control is not a key issue.</span></span> <span data-ttu-id="f348c-433">Sin embargo, si habitualmente tiene varios usuarios en el sitio que trabajan con los mismos datos, el control de simultaneidad puede ayudar a evitar que las actualizaciones o eliminaciones de un usuario sobrescriban de forma involuntaria otras.</span><span class="sxs-lookup"><span data-stu-id="f348c-433">If, however, you routinely have multiple users on your site working with the same data, concurrency control can help prevent one user's updates or deletes from unwittingly overwriting another's.</span></span>

<span data-ttu-id="f348c-434">¡ Feliz programación!</span><span class="sxs-lookup"><span data-stu-id="f348c-434">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="f348c-435">Acerca del autor</span><span class="sxs-lookup"><span data-stu-id="f348c-435">About the Author</span></span>

<span data-ttu-id="f348c-436">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), autor de siete libros de ASP/ASP. net y fundador de [4GuysFromRolla.com](http://www.4guysfromrolla.com), ha estado trabajando con las tecnologías Web de Microsoft desde 1998.</span><span class="sxs-lookup"><span data-stu-id="f348c-436">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="f348c-437">Scott funciona como consultor, profesor y redactor independiente.</span><span class="sxs-lookup"><span data-stu-id="f348c-437">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="f348c-438">Su último libro se [*enseña a ASP.NET 2,0 en 24 horas*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="f348c-438">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="f348c-439">Puede ponerse en contacto con usted en [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="f348c-439">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="f348c-440">o a través de su blog, que encontrará en [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="f348c-440">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="f348c-441">[Anterior](customizing-the-data-modification-interface-vb.md)
> [Siguiente](adding-client-side-confirmation-when-deleting-vb.md)</span><span class="sxs-lookup"><span data-stu-id="f348c-441">[Previous](customizing-the-data-modification-interface-vb.md)
[Next](adding-client-side-confirmation-when-deleting-vb.md)</span></span>
