---
uid: aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
title: Servidor de autorización de OAuth 2.0 de OWIN | Microsoft Docs
author: hongyes
description: Este tutorial le guiará para implementar un servidor de autorización de OAuth 2.0 con middleware de OWIN OAuth. Esto es un tutorial avanzado que sólo figuración...
ms.author: riande
ms.date: 01/28/2019
ms.assetid: 20acee16-c70c-41e9-b38f-92bfcf9a4c1c
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
msc.type: authoredcontent
ms.openlocfilehash: b8451d2d9e346bd5e2f51ba45e48030a5221b549
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 03/01/2019
ms.locfileid: "57059752"
---
# <a name="owin-oauth-20-authorization-server"></a><span data-ttu-id="13c65-104">Servidor de autorización de OAuth 2.0 de OWIN</span><span class="sxs-lookup"><span data-stu-id="13c65-104">OWIN OAuth 2.0 Authorization Server</span></span>

> <span data-ttu-id="13c65-105">Este tutorial le guiará para implementar un servidor de autorización de OAuth 2.0 con middleware de OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="13c65-105">This tutorial will guide you on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span> <span data-ttu-id="13c65-106">Se trata de un tutorial avanzado que solo se describe los pasos para crear un servidor de autorización de OWIN OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="13c65-106">This is an advanced tutorial that only outlines the steps to create an OWIN OAuth 2.0 Authorization Server.</span></span> <span data-ttu-id="13c65-107">Esto no es un tutorial paso a paso.</span><span class="sxs-lookup"><span data-stu-id="13c65-107">This is not a step by step tutorial.</span></span> <span data-ttu-id="13c65-108">[Descargar el código de ejemplo](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span><span class="sxs-lookup"><span data-stu-id="13c65-108">[Download the sample code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span></span>
>
> > [!NOTE]
> > <span data-ttu-id="13c65-109">Este esquema no debe ser intencionado que se usará para crear una aplicación de producción seguro.</span><span class="sxs-lookup"><span data-stu-id="13c65-109">This outline should not be intended to be used for creating a secure production app.</span></span> <span data-ttu-id="13c65-110">Este tutorial está pensado para proporcionar solo una descripción sobre cómo implementar un servidor de autorización de OAuth 2.0 con middleware de OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="13c65-110">This tutorial is intended to provide only an outline on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span>
>
>
> ## <a name="software-versions"></a><span data-ttu-id="13c65-111">Versiones de software</span><span class="sxs-lookup"><span data-stu-id="13c65-111">Software versions</span></span>
>
> | <span data-ttu-id="13c65-112">**Se muestra en el tutorial**</span><span class="sxs-lookup"><span data-stu-id="13c65-112">**Shown in the tutorial**</span></span> | <span data-ttu-id="13c65-113">**También funciona con**</span><span class="sxs-lookup"><span data-stu-id="13c65-113">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="13c65-114">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="13c65-114">Windows 8.1</span></span> | <span data-ttu-id="13c65-115">Windows 10, Windows 8, Windows 7</span><span class="sxs-lookup"><span data-stu-id="13c65-115">Windows 10, Windows 8, Windows 7</span></span> |
> | [<span data-ttu-id="13c65-116">Visual Studio 2017</span><span class="sxs-lookup"><span data-stu-id="13c65-116">Visual Studio 2017</span></span>](https://visualstudio.microsoft.com/downloads/)
> | <span data-ttu-id="13c65-117">.NET 4.7.2</span><span class="sxs-lookup"><span data-stu-id="13c65-117">.NET 4.7.2</span></span> |  |
>
> ## <a name="questions-and-comments"></a><span data-ttu-id="13c65-118">Preguntas y comentarios</span><span class="sxs-lookup"><span data-stu-id="13c65-118">Questions and comments</span></span>
>
> <span data-ttu-id="13c65-119">Si tiene preguntas que no están directamente relacionados con el tutorial, puede publicarlos en [proyecto Katana en GitHub](https://github.com/aspnet/AspNetKatana/).</span><span class="sxs-lookup"><span data-stu-id="13c65-119">If you have questions that are not directly related to the tutorial, you can post them at [Katana Project on GitHub](https://github.com/aspnet/AspNetKatana/).</span></span> <span data-ttu-id="13c65-120">Para preguntas y comentarios sobre el tutorial en Sí, consulte la sección de comentarios en la parte inferior de la página.</span><span class="sxs-lookup"><span data-stu-id="13c65-120">For questions and comments regarding the tutorial itself, see the comments section at the bottom of the page.</span></span>


<span data-ttu-id="13c65-121">El [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) permite que una aplicación de terceros obtener acceso limitado a un servicio HTTP.</span><span class="sxs-lookup"><span data-stu-id="13c65-121">The [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) enables a third-party app to obtain limited access to an HTTP service.</span></span> <span data-ttu-id="13c65-122">En lugar de usar las credenciales del propietario del recurso para tener acceso a un recurso protegido, el cliente obtiene un token de acceso (que es una cadena que denota un ámbito específico, duración y otros atributos de acceso).</span><span class="sxs-lookup"><span data-stu-id="13c65-122">Instead of using the resource owner's credentials to access a protected resource, the client obtains an access token (which is a string denoting a specific scope, lifetime, and other access attributes).</span></span> <span data-ttu-id="13c65-123">Un servidor de autorización emite tokens de acceso a los clientes de terceros con la aprobación del propietario del recurso.</span><span class="sxs-lookup"><span data-stu-id="13c65-123">Access tokens are issued to third-party clients by an authorization server with the approval of the resource owner.</span></span>

<span data-ttu-id="13c65-124">Este tutorial tratará:</span><span class="sxs-lookup"><span data-stu-id="13c65-124">This tutorial will cover:</span></span>

- <span data-ttu-id="13c65-125">Cómo crear un servidor de autorización para admitir la autorización de cuatro tipos de concesión y tokens de actualización:</span><span class="sxs-lookup"><span data-stu-id="13c65-125">How to create an authorization server to support four authorization grant types and refresh tokens:</span></span>
    - <span data-ttu-id="13c65-126">Concesión de código de autorización</span><span class="sxs-lookup"><span data-stu-id="13c65-126">Authorization code grant</span></span>
    - <span data-ttu-id="13c65-127">Concesión implícita</span><span class="sxs-lookup"><span data-stu-id="13c65-127">Implicit Grant</span></span>
    - <span data-ttu-id="13c65-128">Concesión de credenciales de contraseña de propietario de recursos</span><span class="sxs-lookup"><span data-stu-id="13c65-128">Resource Owner Password Credentials Grant</span></span>
    - <span data-ttu-id="13c65-129">Concesión de credenciales de cliente</span><span class="sxs-lookup"><span data-stu-id="13c65-129">Client Credentials Grant</span></span>
- <span data-ttu-id="13c65-130">Creación de un servidor de recursos que se protege mediante un token de acceso.</span><span class="sxs-lookup"><span data-stu-id="13c65-130">Creating a resource server which is protected by an access token.</span></span>
- <span data-ttu-id="13c65-131">Creación de los clientes de OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="13c65-131">Creating OAuth 2.0 clients.</span></span>

<a id="prerequisites"></a>
## <a name="prerequisites"></a><span data-ttu-id="13c65-132">Requisitos previos</span><span class="sxs-lookup"><span data-stu-id="13c65-132">Prerequisites</span></span>

- <span data-ttu-id="13c65-133">[Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) como se indica en **versiones de Software** en la parte superior de la página.</span><span class="sxs-lookup"><span data-stu-id="13c65-133">[Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) as indicated in **Software Versions** at the top of the page.</span></span>
- <span data-ttu-id="13c65-134">Debe estar familiarizado con OWIN.</span><span class="sxs-lookup"><span data-stu-id="13c65-134">Familiarity with OWIN.</span></span> <span data-ttu-id="13c65-135">Consulte [introducción con el proyecto Katana](https://msdn.microsoft.com/magazine/dn451439.aspx) y [Novedades de OWIN y Katana](index.md).</span><span class="sxs-lookup"><span data-stu-id="13c65-135">See [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx) and [What's new in OWIN and Katana](index.md).</span></span>
- <span data-ttu-id="13c65-136">Familiaridad con [OAuth](http://tools.ietf.org/html/rfc6749) terminología, incluyendo [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [protocolo flujo](http://tools.ietf.org/html/rfc6749#section-1.2), y [concesión de autorización](http://tools.ietf.org/html/rfc6749#section-1.3).</span><span class="sxs-lookup"><span data-stu-id="13c65-136">Familiarity with [OAuth](http://tools.ietf.org/html/rfc6749) terminology, including [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), and [Authorization Grant](http://tools.ietf.org/html/rfc6749#section-1.3).</span></span> <span data-ttu-id="13c65-137">[Introducción de OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-1) proporciona una buena introducción.</span><span class="sxs-lookup"><span data-stu-id="13c65-137">[OAuth 2.0 introduction](http://tools.ietf.org/html/rfc6749#section-1) provides a good introduction.</span></span>

## <a name="create-an-authorization-server"></a><span data-ttu-id="13c65-138">Crear un servidor de autorización</span><span class="sxs-lookup"><span data-stu-id="13c65-138">Create an Authorization Server</span></span>

<span data-ttu-id="13c65-139">En este tutorial, se le aproximadamente boceto de cómo usar [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) y ASP.NET MVC para crear un servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="13c65-139">In this tutorial, we will roughly sketch out how to use [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) and ASP.NET MVC to create an authorization server.</span></span> <span data-ttu-id="13c65-140">Esperamos proporcionar pronto una descarga para el ejemplo completo, como en este tutorial no incluye cada paso.</span><span class="sxs-lookup"><span data-stu-id="13c65-140">We hope to soon provide a download for the completed sample, as this tutorial does not include each step.</span></span> <span data-ttu-id="13c65-141">En primer lugar, cree una aplicación web vacía denominada *AuthorizationServer* e instalar los siguientes paquetes:</span><span class="sxs-lookup"><span data-stu-id="13c65-141">First, create an empty web app named *AuthorizationServer* and install the following packages:</span></span>

- <span data-ttu-id="13c65-142">Microsoft.AspNet.Mvc</span><span class="sxs-lookup"><span data-stu-id="13c65-142">Microsoft.AspNet.Mvc</span></span>
- <span data-ttu-id="13c65-143">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="13c65-143">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="13c65-144">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="13c65-144">Microsoft.Owin.Security.OAuth</span></span>
- <span data-ttu-id="13c65-145">Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="13c65-145">Microsoft.Owin.Security.Cookies</span></span>
- <span data-ttu-id="13c65-146">Microsoft.Owin.Security.Google (o cualquier otro inicio de sesión social empaquetar como Microsoft.Owin.Security.Facebook)</span><span class="sxs-lookup"><span data-stu-id="13c65-146">Microsoft.Owin.Security.Google (Or any other social login package such as Microsoft.Owin.Security.Facebook)</span></span>

<span data-ttu-id="13c65-147">Agregar un [clase OWIN Startup](owin-startup-class-detection.md) bajo la carpeta raíz del proyecto denominada *inicio*.</span><span class="sxs-lookup"><span data-stu-id="13c65-147">Add an [OWIN Startup class](owin-startup-class-detection.md) under the project root folder named *Startup*.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample1.cs?highlight=8)]

<span data-ttu-id="13c65-148">Crear un *aplicación\_iniciar* carpeta.</span><span class="sxs-lookup"><span data-stu-id="13c65-148">Create an *App\_Start* folder.</span></span> <span data-ttu-id="13c65-149">Seleccione el *aplicación\_iniciar* carpeta y use Alt + Mayús + A para agregar la versión descargada de la *AuthorizationServer\App\_Start\Startup.Auth.cs* archivo.</span><span class="sxs-lookup"><span data-stu-id="13c65-149">Select the *App\_Start* folder and use Shift+Alt+A to add the downloaded version of the *AuthorizationServer\App\_Start\Startup.Auth.cs* file.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample2.cs)]

<span data-ttu-id="13c65-150">El código anterior permite cookies y la autenticación de Google, que se usan por el propio servidor de autorización para administrar las cuentas de inicio de sesión de aplicación/externa.</span><span class="sxs-lookup"><span data-stu-id="13c65-150">The code above enables application/external sign in cookies and Google authentication, which are used by authorization server itself to manage accounts.</span></span>

<span data-ttu-id="13c65-151">El `UseOAuthAuthorizationServer` método de extensión consiste en configurar el servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="13c65-151">The `UseOAuthAuthorizationServer` extension method is to setup the authorization server.</span></span> <span data-ttu-id="13c65-152">Las opciones de configuración son:</span><span class="sxs-lookup"><span data-stu-id="13c65-152">The setup options are:</span></span>

- <span data-ttu-id="13c65-153">`AuthorizeEndpointPath`: La ruta de acceso de solicitud que las aplicaciones cliente redirigirá el agente de usuario con el fin de obtener los usuarios de dar su consentimiento para emitir un token o código.</span><span class="sxs-lookup"><span data-stu-id="13c65-153">`AuthorizeEndpointPath`: The request path where client applications will redirect the user-agent in order to obtain the users consent to issue a token or code.</span></span> <span data-ttu-id="13c65-154">Debe comenzar con una barra inicial, por ejemplo, "`/Authorize`".</span><span class="sxs-lookup"><span data-stu-id="13c65-154">It must begin with a leading slash, for example, "`/Authorize`".</span></span>
- <span data-ttu-id="13c65-155">`TokenEndpointPath`: Las aplicaciones de cliente de la ruta de acceso de solicitud se comunican directamente para obtener el token de acceso.</span><span class="sxs-lookup"><span data-stu-id="13c65-155">`TokenEndpointPath`: The request path client applications directly communicate to obtain the access token.</span></span> <span data-ttu-id="13c65-156">Debe comenzar con una barra inicial, como "/ Token".</span><span class="sxs-lookup"><span data-stu-id="13c65-156">It must begin with a leading slash, like "/Token".</span></span> <span data-ttu-id="13c65-157">Si el cliente ha emitido una [cliente\_secreto](http://tools.ietf.org/html/rfc6749#appendix-A.2), pero se debe proporcionar a este extremo.</span><span class="sxs-lookup"><span data-stu-id="13c65-157">If the client is issued a [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), it must be provided to this endpoint.</span></span>
- <span data-ttu-id="13c65-158">`ApplicationCanDisplayErrors`: Establecido en `true` si desea implementar la aplicación web generar una página de error personalizado para los errores de validación del cliente en `/Authorize` punto de conexión.</span><span class="sxs-lookup"><span data-stu-id="13c65-158">`ApplicationCanDisplayErrors`: Set to `true` if the web application wants to generate a custom error page for the client validation errors on `/Authorize` endpoint.</span></span> <span data-ttu-id="13c65-159">Esto solo es necesario para los casos donde no se redirige el Explorador de nuevo a la aplicación cliente, por ejemplo, cuando el `client_id` o `redirect_uri` son incorrectas.</span><span class="sxs-lookup"><span data-stu-id="13c65-159">This is only needed for cases where the browser is not redirected back to the client application, for example, when the `client_id` or `redirect_uri` are incorrect.</span></span> <span data-ttu-id="13c65-160">El `/Authorize` punto de conexión debería ver la "oauth. Error","oauth. ErrorDescription"y"oauth. Propiedades de ErrorUri"se agregan al entorno OWIN.</span><span class="sxs-lookup"><span data-stu-id="13c65-160">The `/Authorize` endpoint should expect to see the "oauth.Error", "oauth.ErrorDescription", and "oauth.ErrorUri" properties are added to the OWIN environment.</span></span>

    > [!NOTE]
    > <span data-ttu-id="13c65-161">Si no es true, el servidor de autorización devolverá una página de error predeterminada con los detalles del error.</span><span class="sxs-lookup"><span data-stu-id="13c65-161">If not true, the authorization server will return a default error page with the error details.</span></span>
- <span data-ttu-id="13c65-162">`AllowInsecureHttp`: Es True para permitir autorizar y solicitudes de token para llegar de direcciones URI HTTP y permitir la entrada `redirect_uri` autorizar a los parámetros de solicitud tenga direcciones URI de HTTP.</span><span class="sxs-lookup"><span data-stu-id="13c65-162">`AllowInsecureHttp`: True to allow authorize and token requests to arrive on HTTP URI addresses, and to allow incoming `redirect_uri` authorize request parameters to have HTTP URI addresses.</span></span>

    > [!WARNING]
    > <span data-ttu-id="13c65-163">Seguridad: Esto es solamente para desarrollo.</span><span class="sxs-lookup"><span data-stu-id="13c65-163">Security - This is for development only.</span></span>
- <span data-ttu-id="13c65-164">`Provider`: El objeto proporcionado por la aplicación para procesar los eventos generados por el middleware de servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="13c65-164">`Provider`: The object provided by the application to process events raised by the Authorization Server middleware.</span></span> <span data-ttu-id="13c65-165">La aplicación puede implementar la interfaz por completo o puede crear una instancia de `OAuthAuthorizationServerProvider` y asignar delegados necesarios para los flujos de OAuth es compatible con este servidor.</span><span class="sxs-lookup"><span data-stu-id="13c65-165">The application may implement the interface fully, or it may create an instance of `OAuthAuthorizationServerProvider` and assign delegates necessary for the OAuth flows this server supports.</span></span>
- <span data-ttu-id="13c65-166">`AuthorizationCodeProvider`: Genera un código de autorización de uso único para volver a la aplicación cliente.</span><span class="sxs-lookup"><span data-stu-id="13c65-166">`AuthorizationCodeProvider`: Produces a single-use authorization code to return to the client application.</span></span> <span data-ttu-id="13c65-167">Para que el servidor OAuth pueda proteger la aplicación **debe** proporcionar una instancia de `AuthorizationCodeProvider` donde el token generado por el `OnCreate/OnCreateAsync` eventos se consideran válido para sólo una llamada a `OnReceive/OnReceiveAsync`.</span><span class="sxs-lookup"><span data-stu-id="13c65-167">For the OAuth server to be secure the application **MUST** provide an instance for `AuthorizationCodeProvider` where the token produced by the `OnCreate/OnCreateAsync` event is considered valid for only one call to `OnReceive/OnReceiveAsync`.</span></span>
- <span data-ttu-id="13c65-168">`RefreshTokenProvider`: Genera un token de actualización que se puede usar para generar un nuevo token de acceso cuando sea necesario.</span><span class="sxs-lookup"><span data-stu-id="13c65-168">`RefreshTokenProvider`: Produces a refresh token which may be used to produce a new access token when needed.</span></span> <span data-ttu-id="13c65-169">Si no se proporciona el servidor de autorización no devolverá los tokens de actualización de la `/Token` punto de conexión.</span><span class="sxs-lookup"><span data-stu-id="13c65-169">If not provided the authorization server will not return refresh tokens from the `/Token` endpoint.</span></span>

## <a name="account-management"></a><span data-ttu-id="13c65-170">Administración de cuentas</span><span class="sxs-lookup"><span data-stu-id="13c65-170">Account Management</span></span>

<span data-ttu-id="13c65-171">OAuth no le importa dónde y cómo administrar la información de su cuenta de usuario.</span><span class="sxs-lookup"><span data-stu-id="13c65-171">OAuth doesn't care where or how you manage your user account information.</span></span> <span data-ttu-id="13c65-172">Tiene [ASP.NET Identity](../../../identity/index.md) que es responsable de ella.</span><span class="sxs-lookup"><span data-stu-id="13c65-172">It's [ASP.NET Identity](../../../identity/index.md) which is responsible for it.</span></span> <span data-ttu-id="13c65-173">En este tutorial, se simplifica el código de administración de cuenta y sólo tiene que asegurarse de que el usuario puede iniciar sesión con el OWIN middleware de cookie.</span><span class="sxs-lookup"><span data-stu-id="13c65-173">In this tutorial, we will simplify the account management code and just make sure that user can login using OWIN cookie middleware.</span></span> <span data-ttu-id="13c65-174">Este es el código de ejemplo simplificado para el `AccountController`:</span><span class="sxs-lookup"><span data-stu-id="13c65-174">Here is the simplified sample code for the `AccountController`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample3.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample4.cs?highlight=1)]

<span data-ttu-id="13c65-175">`ValidateClientRedirectUri` se utiliza para validar al cliente con su dirección URL de redireccionamiento registrado.</span><span class="sxs-lookup"><span data-stu-id="13c65-175">`ValidateClientRedirectUri` is used to validate the client with its registered redirect URL.</span></span> <span data-ttu-id="13c65-176">`ValidateClientAuthentication` comprueba el encabezado de esquema básico y el cuerpo del formulario para obtener las credenciales del cliente.</span><span class="sxs-lookup"><span data-stu-id="13c65-176">`ValidateClientAuthentication` checks the basic scheme header and form body to get the client's credentials.</span></span>

<span data-ttu-id="13c65-177">A continuación se muestra la página de inicio de sesión:</span><span class="sxs-lookup"><span data-stu-id="13c65-177">The login page is shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image1.png)

<span data-ttu-id="13c65-178">Revise el IETF OAuth 2 [concesión de código de autorización](http://tools.ietf.org/html/rfc6749#section-4.1) sección ahora.</span><span class="sxs-lookup"><span data-stu-id="13c65-178">Review the IETF's OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) section now.</span></span>

<span data-ttu-id="13c65-179">**Proveedor** (en la tabla siguiente) es [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx). Proveedor, que es de tipo `OAuthAuthorizationServerProvider`, que contiene todos los eventos de servidor de OAuth.</span><span class="sxs-lookup"><span data-stu-id="13c65-179">**Provider** (in the table below) is [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx).Provider, which is of type `OAuthAuthorizationServerProvider`, which contains all OAuth server events.</span></span>

| <span data-ttu-id="13c65-180">Pasos del flujo de la sección de concesión de código de autorización</span><span class="sxs-lookup"><span data-stu-id="13c65-180">Flow steps from Authorization Code Grant section</span></span> | <span data-ttu-id="13c65-181">Descarga de ejemplo lleva a cabo estos pasos con:</span><span class="sxs-lookup"><span data-stu-id="13c65-181">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="13c65-182">(A) el cliente inicia el flujo dirigiendo el agente de usuario del propietario del recurso para el extremo de autorización.</span><span class="sxs-lookup"><span data-stu-id="13c65-182">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="13c65-183">El cliente incluye su identificador de cliente, el ámbito solicitado, el estado local y un URI de redirección a la que el servidor de autorización enviará al agente de usuario una vez concedido (o deniega el acceso).</span><span class="sxs-lookup"><span data-stu-id="13c65-183">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="13c65-184">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="13c65-184">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="13c65-185">(B) el servidor de autorización autentica al propietario del recurso (mediante el agente de usuario) y establece si el propietario del recurso se concede o deniega la solicitud de acceso del cliente.</span><span class="sxs-lookup"><span data-stu-id="13c65-185">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="13c65-186">**&lt;Si el usuario concede el acceso&gt;**  Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="13c65-186">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="13c65-187">(C) suponiendo que el propietario del recurso conceda el acceso, el servidor de autorización redirige el agente de usuario al cliente utilizando el URI de redirección especificado antes (en la solicitud o durante el registro de cliente).</span><span class="sxs-lookup"><span data-stu-id="13c65-187">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="13c65-188">...</span><span class="sxs-lookup"><span data-stu-id="13c65-188">...</span></span> |  |
|  |  |
| <span data-ttu-id="13c65-189">(D) el cliente solicita un token de acceso de extremo de token del servidor de autorización incluyendo el código de autorización recibido en el paso anterior.</span><span class="sxs-lookup"><span data-stu-id="13c65-189">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="13c65-190">Al realizar la solicitud, el cliente se autentica con el servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="13c65-190">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="13c65-191">El cliente incluye el URI de redirección utilizado para obtener el código de autorización para la comprobación.</span><span class="sxs-lookup"><span data-stu-id="13c65-191">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> | <span data-ttu-id="13c65-192">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="13c65-192">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |

<span data-ttu-id="13c65-193">Una implementación de ejemplo para `AuthorizationCodeProvider.CreateAsync` y `ReceiveAsync` controlar la creación y validación de código de autorización se muestra a continuación.</span><span class="sxs-lookup"><span data-stu-id="13c65-193">A sample implementation for `AuthorizationCodeProvider.CreateAsync` and `ReceiveAsync` to control the creation and validation of authorization code is shown below.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample5.cs)]

<span data-ttu-id="13c65-194">El código anterior usa un diccionario simultáneo en memoria para almacenar el vale de código y la identidad y restaurar la identidad después de recibir el código.</span><span class="sxs-lookup"><span data-stu-id="13c65-194">The code above uses an in-memory concurrent dictionary to store the code and identity ticket and restore the identity after receiving the code.</span></span> <span data-ttu-id="13c65-195">En una aplicación real, se sustituirá por un almacén de datos persistente.</span><span class="sxs-lookup"><span data-stu-id="13c65-195">In a real application, it would be replaced by a persistent data store.</span></span> <span data-ttu-id="13c65-196">Es el punto de conexión de autorización para que el propietario del recurso conceder acceso al cliente.</span><span class="sxs-lookup"><span data-stu-id="13c65-196">The authorization endpoint is for the resource owner to grant access to the client.</span></span> <span data-ttu-id="13c65-197">Por lo general, necesita una interfaz de usuario para permitir que el usuario haga clic en un botón y confirme la concesión.</span><span class="sxs-lookup"><span data-stu-id="13c65-197">Usually, it needs a user interface to allow the user to click a button and confirm the grant.</span></span> <span data-ttu-id="13c65-198">Middleware de OWIN OAuth permite que el código de aplicación controlar el punto de conexión de autorización.</span><span class="sxs-lookup"><span data-stu-id="13c65-198">OWIN OAuth middleware allows application code to handle the authorization endpoint.</span></span> <span data-ttu-id="13c65-199">En nuestra aplicación de ejemplo, usamos un controlador MVC llama `OAuthController` para controlarla.</span><span class="sxs-lookup"><span data-stu-id="13c65-199">In our sample app, we use an MVC controller called `OAuthController` to handle it.</span></span> <span data-ttu-id="13c65-200">Esta es la implementación de ejemplo:</span><span class="sxs-lookup"><span data-stu-id="13c65-200">Here is the sample implementation:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample6.cs?highlight=15)]

<span data-ttu-id="13c65-201">El `Authorize` acción comprobará primero si el usuario ha iniciado sesión el servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="13c65-201">The `Authorize` action will first check if the user has logged in to the authorization server.</span></span> <span data-ttu-id="13c65-202">Si no, el middleware de autenticación desafíos al llamador para autenticarse con la cookie de "Aplicación" y redirige a la página de inicio de sesión.</span><span class="sxs-lookup"><span data-stu-id="13c65-202">If not, the authentication middleware challenges the caller to authenticate using the "Application" cookie and redirects to the login page.</span></span> <span data-ttu-id="13c65-203">(Vea el código resaltado anterior). Si el usuario ha iniciado sesión, representará la vista Authorize, tal como se muestra a continuación:</span><span class="sxs-lookup"><span data-stu-id="13c65-203">(See highlighted code above.) If user has logged in, it will render the Authorize view, as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image2.png)

<span data-ttu-id="13c65-204">Si el **Grant** botón está seleccionado, el `Authorize` acción creará una nueva identidad de "Bearer" e inicie sesión con el.</span><span class="sxs-lookup"><span data-stu-id="13c65-204">If the **Grant** button is selected, the `Authorize` action will create a new "Bearer" identity and sign in with it.</span></span> <span data-ttu-id="13c65-205">Desencadenará el servidor de autorización para generar un token de portador y enviar al cliente con la carga de JSON.</span><span class="sxs-lookup"><span data-stu-id="13c65-205">It will trigger the authorization server to generate a bearer token and send it back to the client with JSON payload.</span></span>

### <a name="implicit-grant"></a><span data-ttu-id="13c65-206">Concesión implícita</span><span class="sxs-lookup"><span data-stu-id="13c65-206">Implicit Grant</span></span>

<span data-ttu-id="13c65-207">Consulte el IETF OAuth 2 [concesión implícita](http://tools.ietf.org/html/rfc6749#section-4.2) sección ahora.</span><span class="sxs-lookup"><span data-stu-id="13c65-207">Refer to the IETF's OAuth 2 [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) section now.</span></span>

 <span data-ttu-id="13c65-208">El [concesión implícita](http://tools.ietf.org/html/rfc6749#section-4.2) flujo que se muestra en la figura 4 es el flujo y asignación que la OAuth de OWIN middleware sigue.</span><span class="sxs-lookup"><span data-stu-id="13c65-208">The [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) flow shown in Figure 4 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="13c65-209">Pasos del flujo de la sección de concesión implícita</span><span class="sxs-lookup"><span data-stu-id="13c65-209">Flow steps from Implicit Grant section</span></span> | <span data-ttu-id="13c65-210">Descarga de ejemplo lleva a cabo estos pasos con:</span><span class="sxs-lookup"><span data-stu-id="13c65-210">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="13c65-211">(A) el cliente inicia el flujo dirigiendo el agente de usuario del propietario del recurso para el extremo de autorización.</span><span class="sxs-lookup"><span data-stu-id="13c65-211">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="13c65-212">El cliente incluye su identificador de cliente, el ámbito solicitado, el estado local y un URI de redirección a la que el servidor de autorización enviará al agente de usuario una vez concedido (o deniega el acceso).</span><span class="sxs-lookup"><span data-stu-id="13c65-212">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="13c65-213">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="13c65-213">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="13c65-214">(B) el servidor de autorización autentica al propietario del recurso (mediante el agente de usuario) y establece si el propietario del recurso se concede o deniega la solicitud de acceso del cliente.</span><span class="sxs-lookup"><span data-stu-id="13c65-214">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="13c65-215">**&lt;Si el usuario concede el acceso&gt;**  Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="13c65-215">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="13c65-216">(C) suponiendo que el propietario del recurso conceda el acceso, el servidor de autorización redirige el agente de usuario al cliente utilizando el URI de redirección especificado antes (en la solicitud o durante el registro de cliente).</span><span class="sxs-lookup"><span data-stu-id="13c65-216">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="13c65-217">...</span><span class="sxs-lookup"><span data-stu-id="13c65-217">...</span></span> |  |
|  |  |
| <span data-ttu-id="13c65-218">(D) el cliente solicita un token de acceso de extremo de token del servidor de autorización incluyendo el código de autorización recibido en el paso anterior.</span><span class="sxs-lookup"><span data-stu-id="13c65-218">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="13c65-219">Al realizar la solicitud, el cliente se autentica con el servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="13c65-219">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="13c65-220">El cliente incluye el URI de redirección utilizado para obtener el código de autorización para la comprobación.</span><span class="sxs-lookup"><span data-stu-id="13c65-220">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> |  |

<span data-ttu-id="13c65-221">Puesto que ya hemos implementado el extremo de autorización (`OAuthController.Authorize` acción) para la concesión de código de autorización, habilita automáticamente también el flujo implícito.</span><span class="sxs-lookup"><span data-stu-id="13c65-221">Since we already implemented the authorization endpoint (`OAuthController.Authorize` action) for authorization code grant, it automatically enables implicit flow as well.</span></span> <span data-ttu-id="13c65-222">Nota: `Provider.ValidateClientRedirectUri` se utiliza para validar el identificador de cliente con su dirección URL de redirección, que protege el flujo de concesión implícita de enviar el acceso a los clientes tokens a ataques malintencionados ([ataque Man-in-the-middle](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span><span class="sxs-lookup"><span data-stu-id="13c65-222">Note: `Provider.ValidateClientRedirectUri` is used to validate the client ID with its redirection URL, which protects the implicit grant flow from sending the access token to malicious clients ([Man-in-the-middle attack](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span></span>

### <a name="resource-owner-password-credentials-grant"></a><span data-ttu-id="13c65-223">Concesión de credenciales de contraseña de propietario de recursos</span><span class="sxs-lookup"><span data-stu-id="13c65-223">Resource Owner Password Credentials Grant</span></span>

<span data-ttu-id="13c65-224">Consulte el IETF OAuth 2 [concesión de credenciales de contraseña de propietario de recursos](http://tools.ietf.org/html/rfc6749#section-4.3) sección ahora.</span><span class="sxs-lookup"><span data-stu-id="13c65-224">Refer to the IETF's OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) section now.</span></span>

 <span data-ttu-id="13c65-225">El [concesión de credenciales de contraseña de propietario de recursos](http://tools.ietf.org/html/rfc6749#section-4.3) flujo que se muestra en la figura 5 es el flujo y asignación que la OAuth de OWIN middleware sigue.</span><span class="sxs-lookup"><span data-stu-id="13c65-225">The [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) flow shown in Figure 5 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="13c65-226">Pasos del flujo de la sección de concesión de credenciales de contraseña de propietario de recursos</span><span class="sxs-lookup"><span data-stu-id="13c65-226">Flow steps from Resource Owner Password Credentials Grant section</span></span> | <span data-ttu-id="13c65-227">Descarga de ejemplo lleva a cabo estos pasos con:</span><span class="sxs-lookup"><span data-stu-id="13c65-227">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="13c65-228">(A) el propietario del recurso proporciona al cliente con su nombre de usuario y contraseña.</span><span class="sxs-lookup"><span data-stu-id="13c65-228">(A) The resource owner provides the client with its username and password.</span></span> |  |
|  |  |
| <span data-ttu-id="13c65-229">(B) el cliente solicita un token de acceso de extremo de token del servidor de autorización mediante la inclusión de las credenciales recibidas del propietario del recurso.</span><span class="sxs-lookup"><span data-stu-id="13c65-229">(B) The client requests an access token from the authorization server's token endpoint by including the credentials received from the resource owner.</span></span> <span data-ttu-id="13c65-230">Al realizar la solicitud, el cliente se autentica con el servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="13c65-230">When making the request, the client authenticates with the authorization server.</span></span> | <span data-ttu-id="13c65-231">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="13c65-231">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="13c65-232">(C) el servidor de autorización autentica al cliente y valida las credenciales del propietario de recursos y, si es válido, emite un token de acceso.</span><span class="sxs-lookup"><span data-stu-id="13c65-232">(C) The authorization server authenticates the client and validates the resource owner credentials, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="13c65-233">Esta es la implementación de ejemplo para `Provider.GrantResourceOwnerCredentials`:</span><span class="sxs-lookup"><span data-stu-id="13c65-233">Here is the sample implementation for `Provider.GrantResourceOwnerCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample7.cs)]

> [!NOTE]
> <span data-ttu-id="13c65-234">El código anterior está diseñado para explicar en esta sección del tutorial y no debe usarse en seguro o aplicaciones de producción.</span><span class="sxs-lookup"><span data-stu-id="13c65-234">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="13c65-235">No comprueba las credenciales de los propietarios de recursos.</span><span class="sxs-lookup"><span data-stu-id="13c65-235">It does not check the resource owners credentials.</span></span> <span data-ttu-id="13c65-236">Se supone que cada credencial es válida y cuando crea una nueva identidad.</span><span class="sxs-lookup"><span data-stu-id="13c65-236">It assumes every credential is valid and creates a new identity for it.</span></span> <span data-ttu-id="13c65-237">La nueva identidad se utilizará para generar el token de acceso y el token de actualización.</span><span class="sxs-lookup"><span data-stu-id="13c65-237">The new identity will be used to generate the access token and refresh token.</span></span> <span data-ttu-id="13c65-238">Reemplace el código con su propio código de administración de cuenta segura.</span><span class="sxs-lookup"><span data-stu-id="13c65-238">Please replace the code with your own secure account management code.</span></span>


### <a name="client-credentials-grant"></a><span data-ttu-id="13c65-239">Concesión de credenciales de cliente</span><span class="sxs-lookup"><span data-stu-id="13c65-239">Client Credentials Grant</span></span>

<span data-ttu-id="13c65-240">Consulte el IETF OAuth 2 [concesión de credenciales de cliente](http://tools.ietf.org/html/rfc6749#section-4.4) sección ahora.</span><span class="sxs-lookup"><span data-stu-id="13c65-240">Refer to the IETF's OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) section now.</span></span>

 <span data-ttu-id="13c65-241">El [concesión de credenciales de cliente](http://tools.ietf.org/html/rfc6749#section-4.4) flujo que se muestra en la figura 6 es el flujo y asignación que la OAuth de OWIN middleware sigue.</span><span class="sxs-lookup"><span data-stu-id="13c65-241">The [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) flow shown in Figure 6 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="13c65-242">Pasos del flujo de la sección de concesión de credenciales de cliente</span><span class="sxs-lookup"><span data-stu-id="13c65-242">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="13c65-243">Descarga de ejemplo lleva a cabo estos pasos con:</span><span class="sxs-lookup"><span data-stu-id="13c65-243">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="13c65-244">(A) el cliente se autentica con el servidor de autorización y solicita un token de acceso desde el extremo de token.</span><span class="sxs-lookup"><span data-stu-id="13c65-244">(A) The client authenticates with the authorization server and requests an access token from the token endpoint.</span></span> | <span data-ttu-id="13c65-245">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="13c65-245">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="13c65-246">(B) el servidor de autorización autentica al cliente y si es válido, emite un token de acceso.</span><span class="sxs-lookup"><span data-stu-id="13c65-246">(B) The authorization server authenticates the client, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="13c65-247">Esta es la implementación de ejemplo para `Provider.GrantClientCredentials`:</span><span class="sxs-lookup"><span data-stu-id="13c65-247">Here is the sample implementation for `Provider.GrantClientCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample8.cs)]

> [!NOTE]
> <span data-ttu-id="13c65-248">El código anterior está diseñado para explicar en esta sección del tutorial y no debe usarse en seguro o aplicaciones de producción.</span><span class="sxs-lookup"><span data-stu-id="13c65-248">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="13c65-249">Reemplace el código con su propio código de administración de cliente segura.</span><span class="sxs-lookup"><span data-stu-id="13c65-249">Please replace the code with your own secure client management code.</span></span>


### <a name="refresh-token"></a><span data-ttu-id="13c65-250">Token de actualización</span><span class="sxs-lookup"><span data-stu-id="13c65-250">Refresh Token</span></span>

<span data-ttu-id="13c65-251">Consulte el IETF OAuth 2 [Token de actualización](http://tools.ietf.org/html/rfc6749#section-1.5) sección ahora.</span><span class="sxs-lookup"><span data-stu-id="13c65-251">Refer to the IETF's OAuth 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) section now.</span></span>

 <span data-ttu-id="13c65-252">El [Token de actualización](http://tools.ietf.org/html/rfc6749#section-1.5) flujo que se muestra en la figura 2 es el flujo y asignación que la OAuth de OWIN middleware sigue.</span><span class="sxs-lookup"><span data-stu-id="13c65-252">The [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) flow shown in Figure 2 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="13c65-253">Pasos del flujo de la sección de concesión de credenciales de cliente</span><span class="sxs-lookup"><span data-stu-id="13c65-253">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="13c65-254">Descarga de ejemplo lleva a cabo estos pasos con:</span><span class="sxs-lookup"><span data-stu-id="13c65-254">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="13c65-255">(G) el cliente solicita un nuevo token de acceso mediante la autenticación con el servidor de autorización y presentar el token de actualización.</span><span class="sxs-lookup"><span data-stu-id="13c65-255">(G) The client requests a new access token by authenticating with the authorization server and presenting the refresh token.</span></span> <span data-ttu-id="13c65-256">Los requisitos de autenticación de cliente se basan en el tipo de cliente y en las directivas del servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="13c65-256">The client authentication requirements are based on the client type and on the authorization server policies.</span></span> | <span data-ttu-id="13c65-257">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="13c65-257">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="13c65-258">(H) en el servidor de autorización autentica al cliente y valida el token de actualización y, si es válido, emite un nuevo token de acceso (y, opcionalmente, un nuevo token de actualización).</span><span class="sxs-lookup"><span data-stu-id="13c65-258">(H) The authorization server authenticates the client and validates the refresh token, and if valid, issues a new access token (and, optionally, a new refresh token).</span></span> |  |

<span data-ttu-id="13c65-259">Esta es la implementación de ejemplo para `Provider.GrantRefreshToken`:</span><span class="sxs-lookup"><span data-stu-id="13c65-259">Here is the sample implementation for `Provider.GrantRefreshToken`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample9.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample10.cs)]

## <a name="create-a-resource-server-which-is-protected-by-access-token"></a><span data-ttu-id="13c65-260">Crear un servidor de recursos que se protege mediante el Token de acceso</span><span class="sxs-lookup"><span data-stu-id="13c65-260">Create a Resource Server which is protected by Access Token</span></span>

<span data-ttu-id="13c65-261">Crear un proyecto de aplicación web vacía e instale los paquetes en el proyecto de las siguientes:</span><span class="sxs-lookup"><span data-stu-id="13c65-261">Create an empty web app project and install following packages in the project:</span></span>

- <span data-ttu-id="13c65-262">Microsoft.AspNet.WebApi.Owin</span><span class="sxs-lookup"><span data-stu-id="13c65-262">Microsoft.AspNet.WebApi.Owin</span></span>
- <span data-ttu-id="13c65-263">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="13c65-263">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="13c65-264">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="13c65-264">Microsoft.Owin.Security.OAuth</span></span>

<span data-ttu-id="13c65-265">Cree una clase de inicio y configurar la autenticación y la API Web.</span><span class="sxs-lookup"><span data-stu-id="13c65-265">Create a startup class and configure authentication and Web API.</span></span> <span data-ttu-id="13c65-266">Consulte *AuthorizationServer\ResourceServer\Startup.cs* en la descarga de ejemplo.</span><span class="sxs-lookup"><span data-stu-id="13c65-266">See *AuthorizationServer\ResourceServer\Startup.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample11.cs)]

<span data-ttu-id="13c65-267">Consulte *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* en la descarga de ejemplo.</span><span class="sxs-lookup"><span data-stu-id="13c65-267">See *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample12.cs)]

<span data-ttu-id="13c65-268">Consulte *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* en la descarga de ejemplo.</span><span class="sxs-lookup"><span data-stu-id="13c65-268">See *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample13.cs)]

- <span data-ttu-id="13c65-269">`UseCors` método permite la CORS para todos los dominios.</span><span class="sxs-lookup"><span data-stu-id="13c65-269">`UseCors` method allows CORS for all domains.</span></span>
- <span data-ttu-id="13c65-270">`UseOAuthBearerAuthentication` método habilita el middleware de autenticación de token de portador de OAuth que recibirá y validar el token de portador de encabezado de autorización de la solicitud.</span><span class="sxs-lookup"><span data-stu-id="13c65-270">`UseOAuthBearerAuthentication` method enables OAuth bearer token authentication middleware which will receive and validate bearer token from authorization header in the request.</span></span>
- <span data-ttu-id="13c65-271">`Config.SuppressDefaultHostAuthenticaiton` suprime de forma predeterminada una entidad de seguridad autenticada desde la aplicación de host, por lo tanto, todas las solicitudes será anónimas después de esta llamada.</span><span class="sxs-lookup"><span data-stu-id="13c65-271">`Config.SuppressDefaultHostAuthenticaiton` suppresses default host authenticated principal from the app, therefore all requests will be anonymous after this call.</span></span>
- <span data-ttu-id="13c65-272">`HostAuthenticationFilter` habilita la autenticación solo para el tipo de autenticación.</span><span class="sxs-lookup"><span data-stu-id="13c65-272">`HostAuthenticationFilter` enables authentication just for the specified authentication type.</span></span> <span data-ttu-id="13c65-273">En este caso, es el tipo de autenticación de portador.</span><span class="sxs-lookup"><span data-stu-id="13c65-273">In this case, it's bearer authentication type.</span></span>

<span data-ttu-id="13c65-274">Para demostrar la identidad autenticada, creamos un controlador ApiController para generar notificaciones del usuario actual.</span><span class="sxs-lookup"><span data-stu-id="13c65-274">In order to demonstrate the authenticated identity, we create an ApiController to output current user's claims.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample14.cs)]

<span data-ttu-id="13c65-275">Si el servidor de autorización y el servidor de recursos no están en el mismo equipo, el middleware de OAuth usará las claves de equipo diferente para cifrar y descifrar el token de acceso de portador.</span><span class="sxs-lookup"><span data-stu-id="13c65-275">If the authorization server and the resource server are not on the same computer, the OAuth middleware will use the different machine keys to encrypt and decrypt bearer access token.</span></span> <span data-ttu-id="13c65-276">Para compartir la misma clave privada entre ambos proyectos, agregamos el mismo `machinekey` en ambos *web.config* archivos.</span><span class="sxs-lookup"><span data-stu-id="13c65-276">In order to share the same private key between both projects, we add the same `machinekey` setting in both *web.config* files.</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample15.xml?highlight=8-10)]

## <a name="create-oauth-20-clients"></a><span data-ttu-id="13c65-277">Crear a clientes OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="13c65-277">Create OAuth 2.0 Clients</span></span>

 <span data-ttu-id="13c65-278">Usamos el [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) paquete NuGet para simplificar el código de cliente.</span><span class="sxs-lookup"><span data-stu-id="13c65-278">We use the [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet package to simplify the client code.</span></span>

### <a name="authorization-code-grant-client"></a><span data-ttu-id="13c65-279">Cliente de concesión de código de autorización</span><span class="sxs-lookup"><span data-stu-id="13c65-279">Authorization Code Grant Client</span></span>

 <span data-ttu-id="13c65-280">Este cliente es una aplicación de MVC.</span><span class="sxs-lookup"><span data-stu-id="13c65-280">This client is an MVC application.</span></span> <span data-ttu-id="13c65-281">Desencadena un flujo de concesión de código de autorización para obtener el token el acceso desde el back-end.</span><span class="sxs-lookup"><span data-stu-id="13c65-281">It will trigger an authorization code grant flow to get the access token from backend.</span></span> <span data-ttu-id="13c65-282">Tiene una sola página tal como se muestra a continuación:</span><span class="sxs-lookup"><span data-stu-id="13c65-282">It has a single page as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image3.png)

- <span data-ttu-id="13c65-283">El **Authorize** botón redirigirá el explorador al servidor de autorización para notificar el propietario del recurso para conceder acceso a este cliente.</span><span class="sxs-lookup"><span data-stu-id="13c65-283">The **Authorize** button will redirect browser to the authorization server to notify the resource owner to grant access to this client.</span></span>
- <span data-ttu-id="13c65-284">El **actualizar** botón obtendrá un nuevo token de acceso y el token de actualización mediante la actualización actual token.</span><span class="sxs-lookup"><span data-stu-id="13c65-284">The **Refresh** button will get a new access token and refresh token using the current refresh token.</span></span>
- <span data-ttu-id="13c65-285">El **API de acceso protegido recursos** botón llamará el servidor de recursos para obtener los datos de las notificaciones del usuario actual y mostrarlos en la página.</span><span class="sxs-lookup"><span data-stu-id="13c65-285">The **Access Protected Resource API** button will call the resource server to get current user's claims data and show them on the page.</span></span>

<span data-ttu-id="13c65-286">Este es el código de ejemplo de la `HomeController` del cliente.</span><span class="sxs-lookup"><span data-stu-id="13c65-286">Here is the sample code of the `HomeController` of the client.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample16.cs)]

<span data-ttu-id="13c65-287">`DotNetOpenAuth` requiere SSL de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="13c65-287">`DotNetOpenAuth` requires SSL by default.</span></span> <span data-ttu-id="13c65-288">Dado que nuestra demostración usa HTTP, deberá agregar después de la configuración en el archivo de configuración:</span><span class="sxs-lookup"><span data-stu-id="13c65-288">Since our demo is using HTTP, you need to add following setting in the config file:</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample17.xml?highlight=4-6)]

> [!WARNING]
> <span data-ttu-id="13c65-289">Security - nunca deshabilitar SSL en una aplicación de producción.</span><span class="sxs-lookup"><span data-stu-id="13c65-289">Security - Never disable SSL in a production app.</span></span> <span data-ttu-id="13c65-290">Ahora las credenciales de inicio de sesión se envían en texto sin cifrar a través de la conexión.</span><span class="sxs-lookup"><span data-stu-id="13c65-290">Your login credentials are now being sent in clear-text across the wire.</span></span> <span data-ttu-id="13c65-291">El código anterior es solo para la depuración de ejemplo local y la exploración.</span><span class="sxs-lookup"><span data-stu-id="13c65-291">The code above is just for local sample debugging and exploration.</span></span>


### <a name="implicit-grant-client"></a><span data-ttu-id="13c65-292">Cliente de concesión implícita</span><span class="sxs-lookup"><span data-stu-id="13c65-292">Implicit Grant Client</span></span>

<span data-ttu-id="13c65-293">Este cliente está usando JavaScript para:</span><span class="sxs-lookup"><span data-stu-id="13c65-293">This client is using JavaScript to:</span></span>

1. <span data-ttu-id="13c65-294">Abra una nueva ventana y redirija al punto de conexión de autorización del servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="13c65-294">Open a new window and redirect to the authorize endpoint of the Authorization Server.</span></span>
2. <span data-ttu-id="13c65-295">Obtener el token de acceso de fragmentos de dirección URL cuando se redirige de nuevo.</span><span class="sxs-lookup"><span data-stu-id="13c65-295">Get the access token from URL fragments when it redirects back.</span></span>

<span data-ttu-id="13c65-296">La imagen siguiente muestra este proceso:</span><span class="sxs-lookup"><span data-stu-id="13c65-296">The following image shows this process:</span></span>

![](owin-oauth-20-authorization-server/_static/image4.png)

<span data-ttu-id="13c65-297">El cliente debe tener dos páginas: uno para la página principal y otro para la devolución de llamada. Este es el ejemplo de JavaScript de código se encuentra en la *Index.cshtml* archivo:</span><span class="sxs-lookup"><span data-stu-id="13c65-297">The client should have two pages: one for home page and the other for callback.Here is the sample JavaScript code found in the *Index.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample18.cshtml)]

<span data-ttu-id="13c65-298">Este es el código de control de devolución de llamada *SignIn.cshtml* archivo:</span><span class="sxs-lookup"><span data-stu-id="13c65-298">Here is the callback handling code in *SignIn.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample19.cshtml)]

> [!NOTE]
> <span data-ttu-id="13c65-299">Una práctica recomendada es mover el código JavaScript a un archivo externo y no se incrusta con el marcado de Razor.</span><span class="sxs-lookup"><span data-stu-id="13c65-299">A best practice is to move the JavaScript to an external file and not embed it with the Razor markup.</span></span> <span data-ttu-id="13c65-300">Para simplificar este ejemplo, se han combinado.</span><span class="sxs-lookup"><span data-stu-id="13c65-300">To keep this sample simple, they have been combined.</span></span>


### <a name="resource-owner-password-credentials-grant-client"></a><span data-ttu-id="13c65-301">Concesión de cliente de credenciales de contraseña de propietario de recursos</span><span class="sxs-lookup"><span data-stu-id="13c65-301">Resource Owner Password Credentials Grant Client</span></span>

<span data-ttu-id="13c65-302">Se usa una aplicación de consola para este cliente de demostración.</span><span class="sxs-lookup"><span data-stu-id="13c65-302">We uses a console app to demo this client.</span></span> <span data-ttu-id="13c65-303">Este es el código:</span><span class="sxs-lookup"><span data-stu-id="13c65-303">Here is the code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample20.cs)]

### <a name="client-credentials-grant-client"></a><span data-ttu-id="13c65-304">Concesión de credenciales de cliente</span><span class="sxs-lookup"><span data-stu-id="13c65-304">Client Credentials Grant Client</span></span>

<span data-ttu-id="13c65-305">Al igual que la concesión de credenciales de contraseña de propietario de recursos, este es un código de aplicación de consola:</span><span class="sxs-lookup"><span data-stu-id="13c65-305">Similar to the Resource Owner Password Credentials Grant, here is console app code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample21.cs)]
