---
uid: web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
title: Ajuste las modificaciones de base de datos dentro de una transacción (C#) | Microsoft Docs
author: rick-anderson
description: Este tutorial es el primero de cuatro que examina la actualización, eliminación e inserción de lotes de datos. En este tutorial, aprenderá cómo permitir que las transacciones de base de datos...
ms.author: riande
ms.date: 06/26/2007
ms.assetid: b45fede3-c53a-4ea1-824b-20200808dbae
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
msc.type: authoredcontent
ms.openlocfilehash: ab1ffa147545ab0d4fa0a3cce6f7dca91dfe3ffb
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 03/01/2019
ms.locfileid: "57026532"
---
<a name="wrapping-database-modifications-within-a-transaction-c"></a><span data-ttu-id="45787-104">Ajustar las modificaciones de base de datos dentro de una transacción (C#)</span><span class="sxs-lookup"><span data-stu-id="45787-104">Wrapping Database Modifications within a Transaction (C#)</span></span>
====================
<span data-ttu-id="45787-105">por [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="45787-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="45787-106">[Descargar código](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) o [descargar PDF](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="45787-106">[Download Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) or [Download PDF](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span></span>

> <span data-ttu-id="45787-107">Este tutorial es el primero de cuatro que examina la actualización, eliminación e inserción de lotes de datos.</span><span class="sxs-lookup"><span data-stu-id="45787-107">This tutorial is the first of four that looks at updating, deleting, and inserting batches of data.</span></span> <span data-ttu-id="45787-108">En este tutorial, aprenderá cómo las transacciones de base de datos permiten modificaciones por lotes que se lleven a cabo como una operación atómica, lo que garantiza que todos los pasos se realizan correctamente o producirá un error en todos los pasos.</span><span class="sxs-lookup"><span data-stu-id="45787-108">In this tutorial we learn how database transactions allow batch modifications to be carried out as an atomic operation, which ensures that either all steps succeed or all steps fail.</span></span>


## <a name="introduction"></a><span data-ttu-id="45787-109">Introducción</span><span class="sxs-lookup"><span data-stu-id="45787-109">Introduction</span></span>

<span data-ttu-id="45787-110">Como hemos visto a partir de la [una visión general de insertar, actualizar y eliminar datos](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) tutorial, el control GridView ofrece compatibilidad integrada para la edición de nivel de fila y la eliminación.</span><span class="sxs-lookup"><span data-stu-id="45787-110">As we saw starting with the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) tutorial, the GridView provides built-in support for row-level editing and deleting.</span></span> <span data-ttu-id="45787-111">Con unos pocos clics del mouse es posible crear una interfaz de modificación de datos enriquecidos sin necesidad de escribir una línea de código, siempre y cuando está satisfecho con la edición y eliminación según una fila por fila.</span><span class="sxs-lookup"><span data-stu-id="45787-111">With a few clicks of the mouse it is possible to create a rich data modification interface without writing a line of code, so long as you are content with editing and deleting on a per-row basis.</span></span> <span data-ttu-id="45787-112">Sin embargo, en determinadas situaciones esto no es suficiente y necesitamos proporcionar a los usuarios la capacidad de editar o eliminar un lote de registros.</span><span class="sxs-lookup"><span data-stu-id="45787-112">However, in certain scenarios this is insufficient and we need to provide users with the ability to edit or delete a batch of records.</span></span>

<span data-ttu-id="45787-113">Por ejemplo, basada en web más clientes de correo electrónico usar una cuadrícula para mostrar todos los mensajes donde cada fila incluye una casilla de verificación junto con la información del correo electrónico s (asunto, remitente etc.).</span><span class="sxs-lookup"><span data-stu-id="45787-113">For example, most web-based email clients use a grid to list each message where each row includes a checkbox along with the email s information (subject, sender, and so forth).</span></span> <span data-ttu-id="45787-114">Esta interfaz permite al usuario eliminar varios mensajes Actívelas y haga clic en un botón Eliminar mensajes seleccionados.</span><span class="sxs-lookup"><span data-stu-id="45787-114">This interface permits the user to delete multiple messages by checking them and then clicking a Delete Selected Messages button.</span></span> <span data-ttu-id="45787-115">Un lote a la interfaz de edición es ideal en situaciones donde los usuarios normalmente Editar número de registros diferentes.</span><span class="sxs-lookup"><span data-stu-id="45787-115">A batch editing interface is ideal in situations where users commonly edit many different records.</span></span> <span data-ttu-id="45787-116">En lugar de obligar al usuario hacer clic en Editar, realizar sus cambios y, a continuación, haga clic en Actualizar para cada registro que debe modificarse, cada fila con su interfaz de edición representa un lote en la interfaz de edición.</span><span class="sxs-lookup"><span data-stu-id="45787-116">Rather than forcing the user to click Edit, make their change, and then click Update for each record that needs to be modified, a batch editing interface renders each row with its editing interface.</span></span> <span data-ttu-id="45787-117">El usuario puede modificar rápidamente el conjunto de filas que deben cambiarse y, a continuación, guardar estos cambios, haga clic en un botón Actualizar todo.</span><span class="sxs-lookup"><span data-stu-id="45787-117">The user can quickly modify the set of rows that need to be changed and then save these changes by clicking an Update All button.</span></span> <span data-ttu-id="45787-118">En este conjunto de tutoriales, examinaremos cómo crear interfaces para insertar, editar y eliminar lotes de datos.</span><span class="sxs-lookup"><span data-stu-id="45787-118">In this set of tutorials we'll examine how to create interfaces for inserting, editing, and deleting batches of data.</span></span>

<span data-ttu-id="45787-119">Al realizar operaciones por lotes se producirá un error importante determinar si debe ser posible para algunas de las operaciones del lote se realice correctamente mientras que otras.</span><span class="sxs-lookup"><span data-stu-id="45787-119">When performing batch operations it s important to determine whether it should be possible for some of the operations in the batch to succeed while others fail.</span></span> <span data-ttu-id="45787-120">¿Considere la posibilidad de un lote de eliminación de la interfaz: qué debe ocurrir si el primer registro seleccionado se elimina correctamente, pero el segundo se produce un error, por ejemplo, debido a una infracción de restricción de clave externa?</span><span class="sxs-lookup"><span data-stu-id="45787-120">Consider a batch deleting interface - what should happen if the first selected record is deleted successfully, but the second one fails, say, because of a foreign key constraint violation?</span></span> <span data-ttu-id="45787-121">¿La eliminación de registro s. primera se debería deshacer o si es aceptable para el primer registro permanezca eliminados?</span><span class="sxs-lookup"><span data-stu-id="45787-121">Should the first record s delete be rolled back or is it acceptable for the first record to remain deleted?</span></span>

<span data-ttu-id="45787-122">Si desea que la operación por lotes se trate como un [operación atómica](http://en.wikipedia.org/wiki/Atomic_operation), uno que ya sea todos los pasos se realizan correctamente o producirá un error en todos los pasos y, después, debe ampliarse para incluir compatibilidad con la capa de acceso a datos [base de datos las transacciones](http://en.wikipedia.org/wiki/Database_transaction).</span><span class="sxs-lookup"><span data-stu-id="45787-122">If you want the batch operation to be treated as an [atomic operation](http://en.wikipedia.org/wiki/Atomic_operation), one where either all of the steps succeed or all of the steps fail, then the Data Access Layer needs to be augmented to include support for [database transactions](http://en.wikipedia.org/wiki/Database_transaction).</span></span> <span data-ttu-id="45787-123">Las transacciones de base de datos garantizan la atomicidad para el conjunto de `INSERT`, `UPDATE`, y `DELETE` instrucciones se ejecutan bajo el paraguas de la transacción y son una característica admitida por la mayoría de los sistemas modernos de la base de datos de todos los.</span><span class="sxs-lookup"><span data-stu-id="45787-123">Database transactions guarantee atomicity for the set of `INSERT`, `UPDATE`, and `DELETE` statements executed under the umbrella of the transaction and are a feature supported by most all modern database systems.</span></span>

<span data-ttu-id="45787-124">En este tutorial, buscaremos en cómo ampliar la capa DAL para utilizar las transacciones de base de datos.</span><span class="sxs-lookup"><span data-stu-id="45787-124">In this tutorial we'll look at how to extend the DAL to use database transactions.</span></span> <span data-ttu-id="45787-125">Los tutoriales posteriores, examinarán implementación páginas web para insertar, actualizar y eliminar interfaces de lote.</span><span class="sxs-lookup"><span data-stu-id="45787-125">Subsequent tutorials will examine implementing web pages for batch inserting, updating, and deleting interfaces.</span></span> <span data-ttu-id="45787-126">Introducción s Let!</span><span class="sxs-lookup"><span data-stu-id="45787-126">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="45787-127">Al modificar los datos en una transacción por lotes, no se necesita siempre atomicidad.</span><span class="sxs-lookup"><span data-stu-id="45787-127">When modifying data in a batch transaction, atomicity is not always needed.</span></span> <span data-ttu-id="45787-128">En algunos escenarios, puede ser aceptable tener algunas modificaciones de datos se realice correctamente y otros usuarios en el mismo lote producirá un error, por ejemplo, cuando la eliminación de un conjunto de mensajes de correo electrónico desde un cliente de correo electrónico basado en web.</span><span class="sxs-lookup"><span data-stu-id="45787-128">In some scenarios, it may be acceptable to have some data modifications succeed and others in the same batch fail, such as when deleting a set of emails from a web-based email client.</span></span> <span data-ttu-id="45787-129">Si hay s para procesar una mitad de error de base de datos a través de la eliminación, lo s probablemente aceptable que los registros procesados sin errores se conservan eliminados.</span><span class="sxs-lookup"><span data-stu-id="45787-129">If there s a database error midway through the deletion process, it s probably acceptable that those records processed without error remain deleted.</span></span> <span data-ttu-id="45787-130">En tales casos, la capa DAL no debe modificarse para admitir las transacciones de base de datos.</span><span class="sxs-lookup"><span data-stu-id="45787-130">In such cases, the DAL does not need to be modified to support database transactions.</span></span> <span data-ttu-id="45787-131">Hay otros lotes operación escenarios, sin embargo, cuando atomicidad es vital.</span><span class="sxs-lookup"><span data-stu-id="45787-131">There are other batch operation scenarios, however, where atomicity is vital.</span></span> <span data-ttu-id="45787-132">Cuando un cliente mueve sus fondos de una cuenta bancaria a otra, se deben realizar dos operaciones: los fondos deben ser la primera cuenta que se deducen y, a continuación, se agrega a la segunda.</span><span class="sxs-lookup"><span data-stu-id="45787-132">When a customer moves her funds from one bank account to another, two operations must be performed: the funds must be deducted from the first account and then added to the second.</span></span> <span data-ttu-id="45787-133">Mientras que el banco es posible que no cuenta con el primer paso se realice correctamente, pero producirá un error en el segundo paso, como es lógico sería malestares sus clientes.</span><span class="sxs-lookup"><span data-stu-id="45787-133">While the bank may not mind having the first step succeed but the second step fail, its customers would understandably be upset.</span></span> <span data-ttu-id="45787-134">Lo animo a trabajar con este tutorial e implementar las mejoras de la capa DAL para admitir las transacciones de base de datos, incluso si no planea su uso en el lote de insertar, actualizar y eliminar interfaces que se va a compilar en los tres tutoriales siguientes.</span><span class="sxs-lookup"><span data-stu-id="45787-134">I encourage you to work through this tutorial and implement the enhancements to the DAL to support database transactions even if you do not plan on using them in the batch inserting, updating, and deleting interfaces we'll be building in the following three tutorials.</span></span>


## <a name="an-overview-of-transactions"></a><span data-ttu-id="45787-135">Información general de las transacciones</span><span class="sxs-lookup"><span data-stu-id="45787-135">An Overview of Transactions</span></span>

<span data-ttu-id="45787-136">La mayoría de las bases de datos incluyen compatibilidad con *transacciones*, que permiten que varios comandos de base de datos que se desea agrupar en una sola unidad lógica de trabajo.</span><span class="sxs-lookup"><span data-stu-id="45787-136">Most databases include support for *transactions*, which enable multiple database commands to be grouped into a single logical unit of work.</span></span> <span data-ttu-id="45787-137">Se garantiza que los comandos de base de datos que componen una transacción atómico, lo que significa que todos los comandos se producirá un error o todos se realizará correctamente.</span><span class="sxs-lookup"><span data-stu-id="45787-137">The database commands that comprise a transaction are guaranteed to be atomic, meaning that either all commands will fail or all will succeed.</span></span>

<span data-ttu-id="45787-138">En general, las transacciones se implementan a través de instrucciones SQL con el siguiente patrón:</span><span class="sxs-lookup"><span data-stu-id="45787-138">In general, transactions are implemented through SQL statements using the following pattern:</span></span>

1. <span data-ttu-id="45787-139">Indicar el inicio de una transacción.</span><span class="sxs-lookup"><span data-stu-id="45787-139">Indicate the start of a transaction.</span></span>
2. <span data-ttu-id="45787-140">Ejecute las instrucciones SQL que componen la transacción.</span><span class="sxs-lookup"><span data-stu-id="45787-140">Execute the SQL statements that comprise the transaction.</span></span>
3. <span data-ttu-id="45787-141">Si se produce un error en una de las instrucciones del paso 2, revierta la transacción.</span><span class="sxs-lookup"><span data-stu-id="45787-141">If there is an error in one of the statements from Step 2, rollback the transaction.</span></span>
4. <span data-ttu-id="45787-142">Si todas las instrucciones del paso 2 se completan sin errores, confirme la transacción.</span><span class="sxs-lookup"><span data-stu-id="45787-142">If all of the statements from Step 2 complete without error, commit the transaction.</span></span>

<span data-ttu-id="45787-143">Las instrucciones SQL usadas para crear, confirmar y revertir la transacción puede especificarse manualmente al escribir secuencias de comandos SQL o crear los procedimientos almacenados o mediante programación implica el uso de ADO.NET o las clases de la [ `System.Transactions` espacio de nombres](https://msdn.microsoft.com/library/system.transactions.aspx).</span><span class="sxs-lookup"><span data-stu-id="45787-143">The SQL statements used to create, commit, and roll back the transaction can be entered manually when writing SQL scripts or creating stored procedures, or through programmatic means using either ADO.NET or the classes in the [`System.Transactions` namespace](https://msdn.microsoft.com/library/system.transactions.aspx).</span></span> <span data-ttu-id="45787-144">En este tutorial, examinaremos solo administrar transacciones utilizando ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="45787-144">In this tutorial we will only examine managing transactions using ADO.NET.</span></span> <span data-ttu-id="45787-145">En un futuro tutorial veremos cómo usar procedimientos almacenados en la capa de acceso a datos, momento en el que se explorará las instrucciones SQL para crear, revertir y confirmar las transacciones.</span><span class="sxs-lookup"><span data-stu-id="45787-145">In a future tutorial we will look at how to use stored procedures in the Data Access Layer, at which time we'll explore the SQL statements for creating, rolling back, and committing transactions.</span></span> <span data-ttu-id="45787-146">Mientras tanto, consulte [administrar transacciones en procedimientos almacenados de SQL Server](http://www.4guysfromrolla.com/webtech/080305-1.shtml) para obtener más información.</span><span class="sxs-lookup"><span data-stu-id="45787-146">In the meantime, consult [Managing Transactions in SQL Server Stored Procedures](http://www.4guysfromrolla.com/webtech/080305-1.shtml) for more information.</span></span>

> [!NOTE]
> <span data-ttu-id="45787-147">El [ `TransactionScope` clase](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) en el `System.Transactions` espacio de nombres permite a los desarrolladores ajustar mediante programación una serie de instrucciones dentro del ámbito de una transacción e incluye compatibilidad con transacciones complejas que implican varios orígenes, como dos bases de datos diferentes o incluso heterogéneos tipos de almacenes de datos, como una base de datos de Microsoft SQL Server, una base de datos de Oracle y un servicio Web.</span><span class="sxs-lookup"><span data-stu-id="45787-147">The [`TransactionScope` class](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) in the `System.Transactions` namespace enables developers to programmatically wrap a series of statements within the scope of a transaction and includes support for complex transactions that involve multiple sources, such as two different databases or even heterogeneous types of data stores, such as a Microsoft SQL Server database, an Oracle database, and a Web service.</span></span> <span data-ttu-id="45787-148">Se decidió usar transacciones de ADO.NET para este tutorial en lugar de quitar el `TransactionScope` clase porque es más específica para las transacciones de base de datos y, en muchos casos, ADO.NET es mucho menos consumen muchos recursos.</span><span class="sxs-lookup"><span data-stu-id="45787-148">I ve decided to use ADO.NET transactions for this tutorial instead of the `TransactionScope` class because ADO.NET is more specific for database transactions and, in many cases, is far less resource intensive.</span></span> <span data-ttu-id="45787-149">Además, en ciertos escenarios el `TransactionScope` clase utiliza el Coordinador de transacciones distribuidas de Microsoft (MSDTC).</span><span class="sxs-lookup"><span data-stu-id="45787-149">In addition, under certain scenarios the `TransactionScope` class uses the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="45787-150">Los problemas de rendimiento, implementación y configuración de MSDTC circundante facilita un tema avanzado y bastante especializado y más allá del ámbito de estos tutoriales.</span><span class="sxs-lookup"><span data-stu-id="45787-150">The configuration, implementation, and performance issues surrounding MSDTC makes it a rather specialized and advanced topic and beyond the scope of these tutorials.</span></span>


<span data-ttu-id="45787-151">Cuando se trabaja con el proveedor SqlClient en ADO.NET, las transacciones se inician a través de una llamada a la [ `SqlConnection` clase](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [ `BeginTransaction` método](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), que devuelve un [ `SqlTransaction` objeto](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span><span class="sxs-lookup"><span data-stu-id="45787-151">When working with the SqlClient provider in ADO.NET, transactions are initiated through a call to the [`SqlConnection` class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), which returns a [`SqlTransaction` object](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span></span> <span data-ttu-id="45787-152">Las instrucciones de modificación de datos que la transacción de composición se colocan dentro de un `try...catch` bloque.</span><span class="sxs-lookup"><span data-stu-id="45787-152">The data modification statements that makeup the transaction are placed within a `try...catch` block.</span></span> <span data-ttu-id="45787-153">Si se produce un error en una instrucción en el `try` bloquear las transferencias de ejecución a la `catch` bloque donde la transacción se puede revertir a través de la `SqlTransaction` objeto s [ `Rollback` método](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span><span class="sxs-lookup"><span data-stu-id="45787-153">If an error occurs in a statement in the `try` block, execution transfers to the `catch` block where the transaction can be rolled back via the `SqlTransaction` object s [`Rollback` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span></span> <span data-ttu-id="45787-154">Si todas las instrucciones completa correctamente, una llamada a la `SqlTransaction` objeto s [ `Commit` método](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) al final de la `try` bloque confirma la transacción.</span><span class="sxs-lookup"><span data-stu-id="45787-154">If all of the statements complete successfully, a call to the `SqlTransaction` object s [`Commit` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) at the end of the `try` block commits the transaction.</span></span> <span data-ttu-id="45787-155">El fragmento de código siguiente muestra este modelo.</span><span class="sxs-lookup"><span data-stu-id="45787-155">The following code snippet illustrates this pattern.</span></span> <span data-ttu-id="45787-156">Consulte [mantener la coherencia de base de datos con transacciones](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) para una sintaxis adicional y ejemplos del uso de las transacciones con ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="45787-156">See [Maintaining Database Consistency with Transactions](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) for additional syntax and examples of using transactions with ADO.NET.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample1.cs)]

<span data-ttu-id="45787-157">De forma predeterminada, los TableAdapters del conjunto de datos con tipo no utiliza transacciones.</span><span class="sxs-lookup"><span data-stu-id="45787-157">By default, the TableAdapters in a Typed DataSet do not use transactions.</span></span> <span data-ttu-id="45787-158">Para proporcionar compatibilidad con las transacciones que se deba aumentar las clases TableAdapter para incluir métodos adicionales que usan el patrón anterior para realizar una serie de instrucciones de modificación de datos dentro del ámbito de una transacción.</span><span class="sxs-lookup"><span data-stu-id="45787-158">To provide support for transactions we need to augment the TableAdapter classes to include additional methods that use the above pattern to perform a series of data modification statements within the scope of a transaction.</span></span> <span data-ttu-id="45787-159">En el paso 2, veremos cómo usar las clases parciales para agregar estos métodos.</span><span class="sxs-lookup"><span data-stu-id="45787-159">In Step 2 we'll see how to use partial classes to add these methods.</span></span>

## <a name="step-1-creating-the-working-with-batched-data-web-pages"></a><span data-ttu-id="45787-160">Paso 1: Crear el trabajo con las páginas Web de datos por lotes</span><span class="sxs-lookup"><span data-stu-id="45787-160">Step 1: Creating the Working with Batched Data Web Pages</span></span>

<span data-ttu-id="45787-161">Antes de empezar a explorar cómo aumentar la capa DAL para admitir las transacciones de base de datos, permiten s primero dedique un momento para crear las páginas web ASP.NET que necesitamos para este tutorial y los tres siguientes.</span><span class="sxs-lookup"><span data-stu-id="45787-161">Before we start exploring how to augment the DAL to support database transactions, let s first take a moment to create the ASP.NET web pages that we will need for this tutorial and the three that follow.</span></span> <span data-ttu-id="45787-162">Empiece por agregar una carpeta nueva denominada `BatchData` y, a continuación, agregue las siguientes páginas ASP.NET, asociar cada página con el `Site.master` página maestra.</span><span class="sxs-lookup"><span data-stu-id="45787-162">Start by adding a new folder named `BatchData` and then add the following ASP.NET pages, associating each page with the `Site.master` master page.</span></span>

- `Default.aspx`
- `Transactions.aspx`
- `BatchUpdate.aspx`
- `BatchDelete.aspx`
- `BatchInsert.aspx`


![Agregar las páginas ASP.NET para los tutoriales relacionados con SqlDataSource](wrapping-database-modifications-within-a-transaction-cs/_static/image1.gif)

<span data-ttu-id="45787-164">**Figura 1**: Agregar las páginas ASP.NET para los tutoriales relacionados con SqlDataSource</span><span class="sxs-lookup"><span data-stu-id="45787-164">**Figure 1**: Add the ASP.NET Pages for the SqlDataSource-Related Tutorials</span></span>


<span data-ttu-id="45787-165">Al igual que con las demás carpetas `Default.aspx` usará el `SectionLevelTutorialListing.ascx` Control de usuario para enumerar los tutoriales dentro de su sección.</span><span class="sxs-lookup"><span data-stu-id="45787-165">As with the other folders, `Default.aspx` will use the `SectionLevelTutorialListing.ascx` User Control to list the tutorials within its section.</span></span> <span data-ttu-id="45787-166">Por lo tanto, agrega este Control de usuario a `Default.aspx` arrastrándolo desde el Explorador de soluciones en la página de vista de diseño de s.</span><span class="sxs-lookup"><span data-stu-id="45787-166">Therefore, add this User Control to `Default.aspx` by dragging it from the Solution Explorer onto the page s Design view.</span></span>


<span data-ttu-id="45787-167">[![Agregar el Control de usuario SectionLevelTutorialListing.ascx a Default.aspx](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="45787-167">[![Add the SectionLevelTutorialListing.ascx User Control to Default.aspx](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span></span>

<span data-ttu-id="45787-168">**Figura 2**: Agregar el `SectionLevelTutorialListing.ascx` Control de usuario `Default.aspx` ([haga clic aquí para ver imagen en tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="45787-168">**Figure 2**: Add the `SectionLevelTutorialListing.ascx` User Control to `Default.aspx` ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span></span>


<span data-ttu-id="45787-169">Por último, agregue estas cuatro páginas como entradas para el `Web.sitemap` archivo.</span><span class="sxs-lookup"><span data-stu-id="45787-169">Lastly, add these four pages as entries to the `Web.sitemap` file.</span></span> <span data-ttu-id="45787-170">En concreto, agregue el siguiente marcado después de la personalización del mapa del sitio `<siteMapNode>`:</span><span class="sxs-lookup"><span data-stu-id="45787-170">Specifically, add the following markup after the Customizing the Site Map `<siteMapNode>`:</span></span>


[!code-xml[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample2.xml)]

<span data-ttu-id="45787-171">Después de actualizar `Web.sitemap`, dedique un momento para ver el sitio Web de tutoriales a través de un explorador.</span><span class="sxs-lookup"><span data-stu-id="45787-171">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="45787-172">El menú de la izquierda ahora incluye elementos para el trabajo con los tutoriales de datos por lotes.</span><span class="sxs-lookup"><span data-stu-id="45787-172">The menu on the left now includes items for the working with batched data tutorials.</span></span>


![El mapa del sitio incluye ahora entradas para el trabajo con los tutoriales de datos por lotes](wrapping-database-modifications-within-a-transaction-cs/_static/image3.gif)

<span data-ttu-id="45787-174">**Figura 3**: El mapa del sitio incluye ahora entradas para el trabajo con los tutoriales de datos por lotes</span><span class="sxs-lookup"><span data-stu-id="45787-174">**Figure 3**: The Site Map Now Includes Entries for the Working with Batched Data Tutorials</span></span>


## <a name="step-2-updating-the-data-access-layer-to-support-database-transactions"></a><span data-ttu-id="45787-175">Paso 2: Actualización de la capa de acceso a datos para admitir las transacciones de base de datos</span><span class="sxs-lookup"><span data-stu-id="45787-175">Step 2: Updating the Data Access Layer to Support Database Transactions</span></span>

<span data-ttu-id="45787-176">Como se explicó en el primer tutorial, [crear una capa de acceso a datos](../introduction/creating-a-data-access-layer-cs.md), el conjunto de datos con tipo en nuestro DAL se compone de tablas de datos y TableAdapters.</span><span class="sxs-lookup"><span data-stu-id="45787-176">As we discussed back in the first tutorial, [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md), the Typed DataSet in our DAL is composed of DataTables and TableAdapters.</span></span> <span data-ttu-id="45787-177">Las tablas de datos contienen datos mientras los TableAdapters proporcionan la funcionalidad para leer datos de la base de datos en las tablas de datos, para actualizar la base de datos con los cambios realizados en las tablas de datos y así sucesivamente.</span><span class="sxs-lookup"><span data-stu-id="45787-177">The DataTables hold data while the TableAdapters provide the functionality to read data from the database into the DataTables, to update the database with changes made to the DataTables, and so forth.</span></span> <span data-ttu-id="45787-178">Recuerde que los TableAdapters proporcionan dos modelos para actualizar los datos, que conocen como actualización por lotes y directos de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="45787-178">Recall that the TableAdapters provide two patterns for updating data, which I referred to as Batch Update and DB-Direct.</span></span> <span data-ttu-id="45787-179">Con el patrón de actualización por lotes, lo TableAdapter se pasa un DataSet, DataTable o colección de objetos DataRow.</span><span class="sxs-lookup"><span data-stu-id="45787-179">With the Batch Update pattern, the TableAdapter is passed a DataSet, DataTable, or collection of DataRows.</span></span> <span data-ttu-id="45787-180">Estos datos se enumera y para cada uno, insertar, modificar o Eliminar fila, el `InsertCommand`, `UpdateCommand`, o `DeleteCommand` se ejecuta.</span><span class="sxs-lookup"><span data-stu-id="45787-180">This data is enumerated and for each inserted, modified, or deleted row, the `InsertCommand`, `UpdateCommand`, or `DeleteCommand` is executed.</span></span> <span data-ttu-id="45787-181">Con el patrón directos de la base de datos, lo TableAdapter se pasa en su lugar los valores de las columnas necesarias para insertar, actualizar o eliminar un registro único.</span><span class="sxs-lookup"><span data-stu-id="45787-181">With the DB-Direct pattern, the TableAdapter is instead passed the values of the columns necessary for inserting, updating, or deleting a single record.</span></span> <span data-ttu-id="45787-182">El método de patrón directo de base de datos, a continuación, usa esos valores en el pasado para ejecutar adecuado `InsertCommand`, `UpdateCommand`, o `DeleteCommand` instrucción.</span><span class="sxs-lookup"><span data-stu-id="45787-182">The DB Direct pattern method then uses those passed-in values to execute the appropriate `InsertCommand`, `UpdateCommand`, or `DeleteCommand` statement.</span></span>

<span data-ttu-id="45787-183">Usa el patrón de actualización, independientemente de los métodos generados automáticamente de los TableAdapters no utilizan transacciones.</span><span class="sxs-lookup"><span data-stu-id="45787-183">Regardless of the update pattern used, the TableAdapters auto-generated methods do not use transactions.</span></span> <span data-ttu-id="45787-184">De forma predeterminada cada insert, update o delete realizadas por el TableAdapter se trata como una sola operación discreta.</span><span class="sxs-lookup"><span data-stu-id="45787-184">By default each insert, update, or delete performed by the TableAdapter is treated as a single discrete operation.</span></span> <span data-ttu-id="45787-185">Por ejemplo, imagine que se usa el patrón directos de la base de datos por parte del código en el nivel de lógica empresarial para insertar los diez registros en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="45787-185">For instance, imagine that the DB-Direct pattern is used by some code in the BLL to insert ten records into the database.</span></span> <span data-ttu-id="45787-186">Este código llamaría a TableAdapters `Insert` método diez veces.</span><span class="sxs-lookup"><span data-stu-id="45787-186">This code would call the TableAdapter s `Insert` method ten times.</span></span> <span data-ttu-id="45787-187">Si las cinco primeras inserciones se realizan correctamente, pero lo sexto dieron lugar a una excepción, los primeros cinco registros insertados permanecerán en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="45787-187">If the first five inserts succeed, but the sixth one resulted in an exception, the first five inserted records would remain in the database.</span></span> <span data-ttu-id="45787-188">De forma similar, si se usa el patrón de actualización por lotes para realizar inserciones, actualizaciones y eliminaciones a insertado, modificado y las filas eliminadas en una DataTable, si se ha realizado correctamente en el primer varias modificaciones, pero una posterior detectó un error, las modificaciones anteriores que completado permanecería en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="45787-188">Similarly, if the Batch Update pattern is used to perform inserts, updates, and deletes to the inserted, modified, and deleted rows in a DataTable, if the first several modifications succeeded but a later one encountered an error, those earlier modifications that completed would remain in the database.</span></span>

<span data-ttu-id="45787-189">En ciertos escenarios desea garantizar la atomicidad en toda una serie de modificaciones.</span><span class="sxs-lookup"><span data-stu-id="45787-189">In certain scenarios we want to ensure atomicity across a series of modifications.</span></span> <span data-ttu-id="45787-190">Para lograr esto debemos manualmente ampliamos el TableAdapter mediante la adición de nuevos métodos que se ejecutan los `InsertCommand`, `UpdateCommand`, y `DeleteCommand` s bajo el paraguas de una transacción.</span><span class="sxs-lookup"><span data-stu-id="45787-190">To accomplish this we must manually extend the TableAdapter by adding new methods that execute the `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s under the umbrella of a transaction.</span></span> <span data-ttu-id="45787-191">En [crear una capa de acceso a datos](../introduction/creating-a-data-access-layer-cs.md) contemplamos utilizando [clases parciales](http://en.wikipedia.org/wiki/Partial_type) para ampliar la funcionalidad de las DataTables del conjunto de datos con tipo.</span><span class="sxs-lookup"><span data-stu-id="45787-191">In [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) we looked at using [partial classes](http://en.wikipedia.org/wiki/Partial_type) to extend the functionality of the DataTables within the Typed DataSet.</span></span> <span data-ttu-id="45787-192">Esta técnica también puede usarse con los TableAdapters.</span><span class="sxs-lookup"><span data-stu-id="45787-192">This technique can also be used with TableAdapters.</span></span>

<span data-ttu-id="45787-193">El conjunto de datos con tipo `Northwind.xsd` se encuentra en la `App_Code` carpeta s `DAL` subcarpeta.</span><span class="sxs-lookup"><span data-stu-id="45787-193">The Typed DataSet `Northwind.xsd` is located in the `App_Code` folder s `DAL` subfolder.</span></span> <span data-ttu-id="45787-194">Cree una subcarpeta en el `DAL` carpeta denominada `TransactionSupport` y agregue un nuevo archivo de clase denominado `ProductsTableAdapter.TransactionSupport.cs` (consulte la figura 4).</span><span class="sxs-lookup"><span data-stu-id="45787-194">Create a subfolder in the `DAL` folder named `TransactionSupport` and add a new class file named `ProductsTableAdapter.TransactionSupport.cs` (see Figure 4).</span></span> <span data-ttu-id="45787-195">Este archivo contendrá la implementación parcial de la `ProductsTableAdapter` que incluye métodos para realizar las modificaciones de datos mediante una transacción.</span><span class="sxs-lookup"><span data-stu-id="45787-195">This file will hold the partial implementation of the `ProductsTableAdapter` that includes methods for performing data modifications using a transaction.</span></span>


![Agregar una carpeta denominada el TransactionSupport y un archivo de clase denominado ProductsTableAdapter.TransactionSupport.cs](wrapping-database-modifications-within-a-transaction-cs/_static/image4.gif)

<span data-ttu-id="45787-197">**Figura 4**: Agregue una carpeta denominada `TransactionSupport` y el archivo de clase `ProductsTableAdapter.TransactionSupport.cs`</span><span class="sxs-lookup"><span data-stu-id="45787-197">**Figure 4**: Add a Folder Named `TransactionSupport` and a Class File Named `ProductsTableAdapter.TransactionSupport.cs`</span></span>


<span data-ttu-id="45787-198">Escriba el código siguiente en el `ProductsTableAdapter.TransactionSupport.cs` archivo:</span><span class="sxs-lookup"><span data-stu-id="45787-198">Enter the following code into the `ProductsTableAdapter.TransactionSupport.cs` file:</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample3.cs)]

<span data-ttu-id="45787-199">El `partial` palabra clave en la declaración de clase aquí indica al compilador que son los miembros agregados en que se agregarán a la `ProductsTableAdapter` clase en el `NorthwindTableAdapters` espacio de nombres.</span><span class="sxs-lookup"><span data-stu-id="45787-199">The `partial` keyword in the class declaration here indicates to the compiler that the members added within are to be added to the `ProductsTableAdapter` class in the `NorthwindTableAdapters` namespace.</span></span> <span data-ttu-id="45787-200">Tenga en cuenta el `using System.Data.SqlClient` instrucción en la parte superior del archivo.</span><span class="sxs-lookup"><span data-stu-id="45787-200">Note the `using System.Data.SqlClient` statement at the top of the file.</span></span> <span data-ttu-id="45787-201">Dado que el TableAdapter se configuró para usar el proveedor SqlClient, internamente se usa un [ `SqlDataAdapter` ](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) objeto para emitir comandos a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="45787-201">Since the TableAdapter was configured to use the SqlClient provider, internally it uses a [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) object to issue its commands to the database.</span></span> <span data-ttu-id="45787-202">Por lo tanto, debemos usar la `SqlTransaction` clase para iniciar la transacción y, después, confirmarla o revertirla.</span><span class="sxs-lookup"><span data-stu-id="45787-202">Consequently, we need to use the `SqlTransaction` class to begin the transaction and then to commit it or roll it back.</span></span> <span data-ttu-id="45787-203">Si usa un almacén de datos que no sean de Microsoft SQL Server, deberá utilizar el proveedor adecuado.</span><span class="sxs-lookup"><span data-stu-id="45787-203">If you are using a data store other than Microsoft SQL Server, you'll need to use the appropriate provider.</span></span>

<span data-ttu-id="45787-204">Estos métodos proporcionan los bloques de creación necesarios para iniciar, reversión y confirmación una transacción.</span><span class="sxs-lookup"><span data-stu-id="45787-204">These methods provide the building blocks needed to start, rollback, and commit a transaction.</span></span> <span data-ttu-id="45787-205">Se marcan `public`, lo que les permite que se usará desde el `ProductsTableAdapter`, de otra clase en la capa DAL, o de otra capa en la arquitectura, como la capa BLL.</span><span class="sxs-lookup"><span data-stu-id="45787-205">They are marked `public`, enabling them to be used from within the `ProductsTableAdapter`, from another class in the DAL, or from another layer in the architecture, such as the BLL.</span></span> <span data-ttu-id="45787-206">`BeginTransaction` Abre el TableAdapter interno `SqlConnection` (si es necesario), comienza la transacción y lo asigna a la `Transaction` propiedad y se asocia la transacción a interno `SqlDataAdapter` s `SqlCommand` objetos.</span><span class="sxs-lookup"><span data-stu-id="45787-206">`BeginTransaction` opens the TableAdapter s internal `SqlConnection` (if needed), begins the transaction and assigns it to the `Transaction` property, and attaches the transaction to the internal `SqlDataAdapter` s `SqlCommand` objects.</span></span> <span data-ttu-id="45787-207">`CommitTransaction` y `RollbackTransaction` llamar a la `Transaction` objeto s `Commit` y `Rollback` métodos, respectivamente, antes de cerrar interno `Connection` objeto.</span><span class="sxs-lookup"><span data-stu-id="45787-207">`CommitTransaction` and `RollbackTransaction` call the `Transaction` object s `Commit` and `Rollback` methods, respectively, before closing the internal `Connection` object.</span></span>

## <a name="step-3-adding-methods-to-update-and-delete-data-under-the-umbrella-of-a-transaction"></a><span data-ttu-id="45787-208">Paso 3: Adición de métodos para actualizar y eliminar datos bajo el paraguas de una transacción</span><span class="sxs-lookup"><span data-stu-id="45787-208">Step 3: Adding Methods to Update and Delete Data Under the Umbrella of a Transaction</span></span>

<span data-ttu-id="45787-209">Con estos métodos completados, hemos re está listo para agregar métodos a `ProductsDataTable` o BLL que llevan a cabo una serie de comandos bajo el paraguas de una transacción.</span><span class="sxs-lookup"><span data-stu-id="45787-209">With these methods complete, we re ready to add methods to `ProductsDataTable` or the BLL that perform a series of commands under the umbrella of a transaction.</span></span> <span data-ttu-id="45787-210">El método siguiente utiliza el patrón de actualización por lotes para actualizar un `ProductsDataTable` instancia mediante una transacción.</span><span class="sxs-lookup"><span data-stu-id="45787-210">The following method uses the Batch Update pattern to update a `ProductsDataTable` instance using a transaction.</span></span> <span data-ttu-id="45787-211">Inicia una transacción mediante una llamada a la `BeginTransaction` método y, a continuación, usa un `try...catch` bloque para emitir las instrucciones de modificación de datos.</span><span class="sxs-lookup"><span data-stu-id="45787-211">It starts a transaction by calling the `BeginTransaction` method and then uses a `try...catch` block to issue the data modification statements.</span></span> <span data-ttu-id="45787-212">Si la llamada a la `Adapter` objeto s `Update` método produce una excepción, la ejecución se transferirá a la `catch` bloque donde se revertirá la transacción y la excepción que se vuelvan a lanzar.</span><span class="sxs-lookup"><span data-stu-id="45787-212">If the call to the `Adapter` object s `Update` method results in an exception, execution will transfer to the `catch` block where the transaction will be rolled back and the exception re-thrown.</span></span> <span data-ttu-id="45787-213">Recuerde que el `Update` método implementa el patrón de actualización por lotes mediante la enumeración de las filas de la `ProductsDataTable` y la realización de la necesaria `InsertCommand`, `UpdateCommand`, y `DeleteCommand` s.</span><span class="sxs-lookup"><span data-stu-id="45787-213">Recall that the `Update` method implements the Batch Update pattern by enumerating the rows of the supplied `ProductsDataTable` and performing the necessary `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s.</span></span> <span data-ttu-id="45787-214">Si cualquiera de estos resultados de comandos en un error, la transacción se revierte, deshace los cambios realizados durante la vigencia de s de transacciones en el anteriores.</span><span class="sxs-lookup"><span data-stu-id="45787-214">If any one of these commands results in an error, the transaction is rolled back, undoing the previous modifications made during the transaction s lifetime.</span></span> <span data-ttu-id="45787-215">Debe el `Update` instrucción completará sin errores, la transacción se confirma en su totalidad.</span><span class="sxs-lookup"><span data-stu-id="45787-215">Should the `Update` statement complete without error, the transaction is committed in its entirety.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample4.cs)]

<span data-ttu-id="45787-216">Agregar el `UpdateWithTransaction` método a la `ProductsTableAdapter` clase a través de la clase parcial en `ProductsTableAdapter.TransactionSupport.cs`.</span><span class="sxs-lookup"><span data-stu-id="45787-216">Add the `UpdateWithTransaction` method to the `ProductsTableAdapter` class through the partial class in `ProductsTableAdapter.TransactionSupport.cs`.</span></span> <span data-ttu-id="45787-217">Como alternativa, este método se puede agregar a la capa de lógica empresarial de s `ProductsBLL` clase con algunos cambios menores de sintaxis.</span><span class="sxs-lookup"><span data-stu-id="45787-217">Alternatively, this method could be added to the Business Logic Layer s `ProductsBLL` class with a few minor syntactical changes.</span></span> <span data-ttu-id="45787-218">Es decir, la palabra clave en `this.BeginTransaction()`, `this.CommitTransaction()`, y `this.RollbackTransaction()` tendría que reemplazarse con `Adapter` (Recuerde que `Adapter` es el nombre de una propiedad en `ProductsBLL` de tipo `ProductsTableAdapter`).</span><span class="sxs-lookup"><span data-stu-id="45787-218">Namely, the keyword this in `this.BeginTransaction()`, `this.CommitTransaction()`, and `this.RollbackTransaction()` would need to be replaced with `Adapter` (recall that `Adapter` is the name of a property in `ProductsBLL` of type `ProductsTableAdapter`).</span></span>

<span data-ttu-id="45787-219">El `UpdateWithTransaction` método usa el patrón de actualización por lotes, pero también se puede usar una serie de llamadas directas de la base de datos dentro del ámbito de una transacción, como se muestra en el siguiente método.</span><span class="sxs-lookup"><span data-stu-id="45787-219">The `UpdateWithTransaction` method uses the Batch Update pattern, but a series of DB-Direct calls can also be used within the scope of a transaction, as the following method shows.</span></span> <span data-ttu-id="45787-220">El `DeleteProductsWithTransaction` método acepta como entrada un `List<T>` typu `int`, que son el `ProductID` que se eliminan.</span><span class="sxs-lookup"><span data-stu-id="45787-220">The `DeleteProductsWithTransaction` method accepts as input a `List<T>` of type `int`, which are the `ProductID` s to delete.</span></span> <span data-ttu-id="45787-221">El método inicia la transacción a través de una llamada a `BeginTransaction` y, a continuación, en el `try` en bloques, recorre en iteración la lista proporcionada llamar el patrón de DB-Direct `Delete` método para cada `ProductID` valor.</span><span class="sxs-lookup"><span data-stu-id="45787-221">The method initiates the transaction via a call to `BeginTransaction` and then, in the `try` block, iterates through the supplied list calling the DB-Direct pattern `Delete` method for each `ProductID` value.</span></span> <span data-ttu-id="45787-222">Si cualquiera de las llamadas a `Delete` se produce un error, el control se transfiere a la `catch` bloque donde se revierte la transacción y la excepción que se vuelvan a lanzar.</span><span class="sxs-lookup"><span data-stu-id="45787-222">If any of the calls to `Delete` fails, control is transferred to the `catch` block where the transaction is rolled back and the exception re-thrown.</span></span> <span data-ttu-id="45787-223">Si todas las llamadas a `Delete` se realiza correctamente, a continuación, se confirma la transacción.</span><span class="sxs-lookup"><span data-stu-id="45787-223">If all calls to `Delete` succeed, then transaction is committed.</span></span> <span data-ttu-id="45787-224">Agregue este método para el `ProductsBLL` clase.</span><span class="sxs-lookup"><span data-stu-id="45787-224">Add this method to the `ProductsBLL` class.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample5.cs)]

## <a name="applying-transactions-across-multiple-tableadapters"></a><span data-ttu-id="45787-225">Aplicación de transacciones a través de varios de los TableAdapters</span><span class="sxs-lookup"><span data-stu-id="45787-225">Applying Transactions Across Multiple TableAdapters</span></span>

<span data-ttu-id="45787-226">El código relacionado con la transacción examinado en este tutorial permite varias instrucciones en el `ProductsTableAdapter` se traten como una operación atómica.</span><span class="sxs-lookup"><span data-stu-id="45787-226">The transaction-related code examined in this tutorial allows for multiple statements against the `ProductsTableAdapter` to be treated as an atomic operation.</span></span> <span data-ttu-id="45787-227">Pero ¿qué ocurre si deben realizarse de forma atómica varias modificaciones a las tablas de base de datos diferente?</span><span class="sxs-lookup"><span data-stu-id="45787-227">But what if multiple modifications to different database tables need to be performed atomically?</span></span> <span data-ttu-id="45787-228">Por ejemplo, al eliminar una categoría, podríamos primero queremos volver a asignar sus productos actuales a otra categoría.</span><span class="sxs-lookup"><span data-stu-id="45787-228">For instance, when deleting a category, we might first want to reassign its current products to some other category.</span></span> <span data-ttu-id="45787-229">Estos dos pasos reasignar los productos y la eliminación de la categoría deben ejecutarse como una operación atómica.</span><span class="sxs-lookup"><span data-stu-id="45787-229">These two steps reassigning the products and deleting the category should be executed as an atomic operation.</span></span> <span data-ttu-id="45787-230">Pero la `ProductsTableAdapter` incluye solo los métodos para modificar el `Products` tabla y el `CategoriesTableAdapter` incluye solo los métodos para modificar el `Categories` tabla.</span><span class="sxs-lookup"><span data-stu-id="45787-230">But the `ProductsTableAdapter` includes only methods for modifying the `Products` table and the `CategoriesTableAdapter` includes only methods for modifying the `Categories` table.</span></span> <span data-ttu-id="45787-231">¿Cómo una transacción puede abarcar ambos TableAdapters?</span><span class="sxs-lookup"><span data-stu-id="45787-231">So how can a transaction encompass both TableAdapters?</span></span>

<span data-ttu-id="45787-232">Una opción consiste en Agregar un método para el `CategoriesTableAdapter` denominado `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` y que ese método llame a un procedimiento almacenado que reasigna los productos y elimina la categoría dentro del ámbito de una transacción definida dentro del procedimiento almacenado.</span><span class="sxs-lookup"><span data-stu-id="45787-232">One option is to add a method to the `CategoriesTableAdapter` named `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` and have that method call a stored procedure that both reassigns the products and deletes the category within the scope of a transaction defined within the stored procedure.</span></span> <span data-ttu-id="45787-233">Veremos cómo iniciar, confirmar y deshacer las transacciones en procedimientos almacenados en un futuro tutorial.</span><span class="sxs-lookup"><span data-stu-id="45787-233">We'll look at how to begin, commit, and rollback transactions in stored procedures in a future tutorial.</span></span>

<span data-ttu-id="45787-234">Otra opción consiste en crear una clase auxiliar en la capa DAL que contiene el `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` método.</span><span class="sxs-lookup"><span data-stu-id="45787-234">Another option is to create a helper class in the DAL that contains the `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` method.</span></span> <span data-ttu-id="45787-235">Este método crearía una instancia de la `CategoriesTableAdapter` y `ProductsTableAdapter` y, a continuación, establezca estos dos TableAdapters `Connection` propiedades al mismo `SqlConnection` instancia.</span><span class="sxs-lookup"><span data-stu-id="45787-235">This method would create an instance of the `CategoriesTableAdapter` and the `ProductsTableAdapter` and then set these two TableAdapters `Connection` properties to the same `SqlConnection` instance.</span></span> <span data-ttu-id="45787-236">En ese punto, uno de los dos TableAdapters iniciaría la transacción con una llamada a `BeginTransaction`.</span><span class="sxs-lookup"><span data-stu-id="45787-236">At that point, either one of the two TableAdapters would initiate the transaction with a call to `BeginTransaction`.</span></span> <span data-ttu-id="45787-237">Sería necesario invocar los métodos de TableAdapter para reasignar los productos y eliminar la categoría en un `try...catch` bloque con la transacción que se confirmarán o revertirán volver según sea necesario.</span><span class="sxs-lookup"><span data-stu-id="45787-237">The TableAdapters methods for reassigning the products and deleting the category would be invoked in a `try...catch` block with the transaction committed or rolled back as needed.</span></span>

## <a name="step-4-adding-theupdatewithtransactionmethod-to-the-business-logic-layer"></a><span data-ttu-id="45787-238">Paso 4: Agregar el`UpdateWithTransaction`método a la capa de lógica de negocios</span><span class="sxs-lookup"><span data-stu-id="45787-238">Step 4: Adding the`UpdateWithTransaction`Method to the Business Logic Layer</span></span>

<span data-ttu-id="45787-239">En el paso 3 se ha agregado un `UpdateWithTransaction` método a la `ProductsTableAdapter` en la capa DAL.</span><span class="sxs-lookup"><span data-stu-id="45787-239">In Step 3 we added an `UpdateWithTransaction` method to the `ProductsTableAdapter` in the DAL.</span></span> <span data-ttu-id="45787-240">Debemos agregar un método correspondiente a la capa BLL.</span><span class="sxs-lookup"><span data-stu-id="45787-240">We should add a corresponding method to the BLL.</span></span> <span data-ttu-id="45787-241">Aunque la capa de presentación podría llamar directamente a la capa DAL para invocar el `UpdateWithTransaction` método, han luchado por estos tutoriales definir una arquitectura por capas que aísla la capa DAL desde la capa de presentación.</span><span class="sxs-lookup"><span data-stu-id="45787-241">While the Presentation Layer could call directly down to the DAL to invoke the `UpdateWithTransaction` method, these tutorials have strived to define a layered architecture that insulates the DAL from the Presentation Layer.</span></span> <span data-ttu-id="45787-242">Por lo tanto, corresponde a nosotros para seguir este enfoque.</span><span class="sxs-lookup"><span data-stu-id="45787-242">Therefore, it behooves us to continue this approach.</span></span>

<span data-ttu-id="45787-243">Abra el `ProductsBLL` archivo de clase y agregue un método denominado `UpdateWithTransaction` que llama simplemente hasta el método correspondiente de la capa DAL.</span><span class="sxs-lookup"><span data-stu-id="45787-243">Open the `ProductsBLL` class file and add a method named `UpdateWithTransaction` that simply calls down to the corresponding DAL method.</span></span> <span data-ttu-id="45787-244">Ahora debería haber dos nuevos métodos en `ProductsBLL`: `UpdateWithTransaction`, que acaba de agregar, y `DeleteProductsWithTransaction`, que se agregó en el paso 3.</span><span class="sxs-lookup"><span data-stu-id="45787-244">There should now be two new methods in `ProductsBLL`: `UpdateWithTransaction`, which you just added, and `DeleteProductsWithTransaction`, which was added in Step 3.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample6.cs)]

> [!NOTE]
> <span data-ttu-id="45787-245">Estos métodos no incluyen el `DataObjectMethodAttribute` atributo asignado a la mayoría de los otra métodos en el `ProductsBLL` clase porque se invocará estos métodos directamente desde las clases de código subyacente de las páginas ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="45787-245">These methods do not include the `DataObjectMethodAttribute` attribute assigned to most other methods in the `ProductsBLL` class because we'll be invoking these methods directly from the ASP.NET pages code-behind classes.</span></span> <span data-ttu-id="45787-246">Recuerde que `DataObjectMethodAttribute` se usa para marcar los métodos que deben aparecer en la s ObjectDataSource Configurar origen de datos asistente y en qué ficha (SELECT, UPDATE, INSERT o DELETE).</span><span class="sxs-lookup"><span data-stu-id="45787-246">Recall that `DataObjectMethodAttribute` is used to flag what methods should appear in the ObjectDataSource s Configure Data Source wizard and under what tab (SELECT, UPDATE, INSERT, or DELETE).</span></span> <span data-ttu-id="45787-247">Puesto que el control GridView no tiene ninguna compatibilidad integrada para batch editen o eliminen, tenemos invocar estos métodos mediante programación, en lugar de utilizar el enfoque sin código declarativo.</span><span class="sxs-lookup"><span data-stu-id="45787-247">Since the GridView lacks any built-in support for batch editing or deleting, we'll have to invoke these methods programmatically rather than use the code-free declarative approach.</span></span>


## <a name="step-5-atomically-updating-database-data-from-the-presentation-layer"></a><span data-ttu-id="45787-248">Paso 5: Actualizando la base de datos de la capa de presentación de forma atómica</span><span class="sxs-lookup"><span data-stu-id="45787-248">Step 5: Atomically Updating Database Data from the Presentation Layer</span></span>

<span data-ttu-id="45787-249">Para ilustrar el efecto que la transacción tiene al actualizar un lote de registros, s permiten crear una interfaz de usuario que se enumera todos los productos en un control GridView e incluye un sitio Web de botón de control que, al hacer clic, reasigna los productos `CategoryID` valores.</span><span class="sxs-lookup"><span data-stu-id="45787-249">To illustrate the effect that the transaction has when updating a batch of records, let s create a user interface that lists all products in a GridView and includes a Button Web control that, when clicked, reassigns the products `CategoryID` values.</span></span> <span data-ttu-id="45787-250">En concreto, la reasignación de categoría progresan para que varios productos de la primera se asignan válido `CategoryID` valor mientras que otros son útiles asigna un inexistente `CategoryID` valor.</span><span class="sxs-lookup"><span data-stu-id="45787-250">In particular, the category reassignment will progress so that the first several products are assigned a valid `CategoryID` value while others are purposefully assigned a non-existent `CategoryID` value.</span></span> <span data-ttu-id="45787-251">Si se intenta actualizar la base de datos con un producto cuyo `CategoryID` no coincide con una categoría existente s `CategoryID`, se producirá una infracción de restricción de clave externa y se producirá una excepción.</span><span class="sxs-lookup"><span data-stu-id="45787-251">If we attempt to update the database with a product whose `CategoryID` does not match an existing category s `CategoryID`, a foreign key constraint violation will occur and an exception will be raised.</span></span> <span data-ttu-id="45787-252">Lo veremos en este ejemplo es que cuando el uso de una transacción de la excepción de la infracción de restricción de clave externa hará que el anterior válida `CategoryID` los cambios se desharán.</span><span class="sxs-lookup"><span data-stu-id="45787-252">What we'll see in this example is that when using a transaction the exception raised from the foreign key constraint violation will cause the previous valid `CategoryID` changes to be rolled back.</span></span> <span data-ttu-id="45787-253">Si no usa una transacción, sin embargo, seguirá siendo las modificaciones en las categorías iniciales.</span><span class="sxs-lookup"><span data-stu-id="45787-253">When not using a transaction, however, the modifications to the initial categories will remain.</span></span>

<span data-ttu-id="45787-254">Comience abriendo la `Transactions.aspx` página en el `BatchData` carpetas y arrastre un control GridView del cuadro de herramientas hasta el diseñador.</span><span class="sxs-lookup"><span data-stu-id="45787-254">Start by opening the `Transactions.aspx` page in the `BatchData` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="45787-255">Establezca su `ID` a `Products` y, en la etiqueta inteligente, de enlazarla a un nuevo origen ObjectDataSource denominado `ProductsDataSource`.</span><span class="sxs-lookup"><span data-stu-id="45787-255">Set its `ID` to `Products` and, from its smart tag, bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="45787-256">Configurar el origen ObjectDataSource para extraer sus datos de la `ProductsBLL` clase s `GetProducts` método.</span><span class="sxs-lookup"><span data-stu-id="45787-256">Configure the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProducts` method.</span></span> <span data-ttu-id="45787-257">Esto se un control GridView de solo lectura, por lo que establece las listas desplegables en la actualización, INSERCIÓN y eliminar las fichas en (None) y haga clic en Finalizar.</span><span class="sxs-lookup"><span data-stu-id="45787-257">This will be a read-only GridView, so set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and click Finish.</span></span>


<span data-ttu-id="45787-258">[![Figura 5: Configurar el origen ObjectDataSource para usar el método de clase ProductsBLL s GetProducts](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="45787-258">[![Figure 5: Configure the ObjectDataSource to Use the ProductsBLL Class s GetProducts Method](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span></span>

<span data-ttu-id="45787-259">**Figura 5**: Figura 5: Configurar el origen ObjectDataSource que se usarán el `ProductsBLL` clase s `GetProducts` método ([haga clic aquí para ver imagen en tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="45787-259">**Figure 5**: Figure 5: Configure the ObjectDataSource to Use the `ProductsBLL` Class s `GetProducts` Method ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span></span>


<span data-ttu-id="45787-260">[![Establecer las listas desplegables en la actualización, INSERCIÓN y eliminar las fichas en (None)](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="45787-260">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span></span>

<span data-ttu-id="45787-261">**Figura 6**: Establecer la lista desplegable se enumeran en la actualización, INSERCIÓN y eliminar pestañas en (None) ([haga clic aquí para ver imagen en tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="45787-261">**Figure 6**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span></span>


<span data-ttu-id="45787-262">Después de completar al Asistente para configurar orígenes de datos, Visual Studio creará BoundFields y un CampoCasillaVerificación para los campos de datos del producto.</span><span class="sxs-lookup"><span data-stu-id="45787-262">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and a CheckBoxField for the product data fields.</span></span> <span data-ttu-id="45787-263">Quite todos estos campos, excepto para `ProductID`, `ProductName`, `CategoryID`, y `CategoryName` y cambiar el nombre de la `ProductName` y `CategoryName` BoundFields `HeaderText` propiedades para el producto y categoría, respectivamente.</span><span class="sxs-lookup"><span data-stu-id="45787-263">Remove all of these fields except for `ProductID`, `ProductName`, `CategoryID`, and `CategoryName` and rename the `ProductName` and `CategoryName` BoundFields `HeaderText` properties to Product and Category, respectively.</span></span> <span data-ttu-id="45787-264">En la etiqueta inteligente, active la opción de habilitar la paginación.</span><span class="sxs-lookup"><span data-stu-id="45787-264">From the smart tag, check the Enable Paging option.</span></span> <span data-ttu-id="45787-265">Después de realizar estas modificaciones, el marcado declarativo de s GridView y ObjectDataSource debería ser similar al siguiente:</span><span class="sxs-lookup"><span data-stu-id="45787-265">After making these modifications, the GridView and ObjectDataSource s declarative markup should look like the following:</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample7.aspx)]

<span data-ttu-id="45787-266">A continuación, agregue tres controles de botón Web por encima del control GridView.</span><span class="sxs-lookup"><span data-stu-id="45787-266">Next, add three Button Web controls above the GridView.</span></span> <span data-ttu-id="45787-267">Establecer el primer botón s propiedad Text para actualizar la cuadrícula, la segunda s para modificar categorías (con la transacción) y el tercero s para modificar categorías (sin transacción).</span><span class="sxs-lookup"><span data-stu-id="45787-267">Set the first Button s Text property to Refresh Grid, the second s to Modify Categories (WITH TRANSACTION), and the third one s to Modify Categories (WITHOUT TRANSACTION) .</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample8.aspx)]

<span data-ttu-id="45787-268">En este momento, la vista de diseño en Visual Studio debe ser similar a la que se muestra en la figura 7 de captura de pantalla.</span><span class="sxs-lookup"><span data-stu-id="45787-268">At this point the Design view in Visual Studio should look similar to the screen shot shown in Figure 7.</span></span>


<span data-ttu-id="45787-269">[![La página contiene tres controles Button de Web y de un control GridView](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="45787-269">[![The Page Contains a GridView and Three Button Web Controls](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span></span>

<span data-ttu-id="45787-270">**Figura 7**: La página contiene un control GridView y tres controles Button de Web ([haga clic aquí para ver imagen en tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="45787-270">**Figure 7**: The Page Contains a GridView and Three Button Web Controls ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span></span>


<span data-ttu-id="45787-271">Crear controladores de eventos para cada uno de los tres botón s `Click` eventos y use el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="45787-271">Create event handlers for each of the three Button s `Click` events and use the following code:</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample9.cs)]

<span data-ttu-id="45787-272">La actualización de botón s `Click` controlador de eventos simplemente vuelve a enlazar los datos en GridView mediante una llamada a la `Products` GridView s `DataBind` método.</span><span class="sxs-lookup"><span data-stu-id="45787-272">The refresh Button s `Click` event handler simply rebinds the data to the GridView by calling the `Products` GridView s `DataBind` method.</span></span>

<span data-ttu-id="45787-273">El segundo controlador de eventos reasigna los productos `CategoryID` s y se usa el nuevo método de transacción de la capa BLL para realizar la base de datos actualiza bajo el paraguas de una transacción.</span><span class="sxs-lookup"><span data-stu-id="45787-273">The second event handler reassigns the products `CategoryID` s and uses the new transaction method from the BLL to perform the database updates under the umbrella of a transaction.</span></span> <span data-ttu-id="45787-274">Tenga en cuenta que cada producto s `CategoryID` se establece arbitrariamente en el mismo valor que su `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="45787-274">Note that each product s `CategoryID` is arbitrarily set to the same value as its `ProductID`.</span></span> <span data-ttu-id="45787-275">Esto funcionará correctamente para el primer algunos productos, dado que esos productos tienen `ProductID` valores que se producen asignar a válido `CategoryID` s.</span><span class="sxs-lookup"><span data-stu-id="45787-275">This will work fine for the first few products, since those products have `ProductID` values that happen to map to valid `CategoryID` s.</span></span> <span data-ttu-id="45787-276">Pero una vez el `ProductID` inicio s demasiado grande, esta superposición una coincidencia de `ProductID` s y `CategoryID` s ya no es aplicable.</span><span class="sxs-lookup"><span data-stu-id="45787-276">But once the `ProductID` s start getting too large, this coincidental overlap of `ProductID` s and `CategoryID` s no longer applies.</span></span>

<span data-ttu-id="45787-277">La tercera `Click` controlador de eventos actualiza los productos `CategoryID` s de la misma manera, pero envía la actualización a la base de datos mediante el `ProductsTableAdapter` predeterminados `Update` método.</span><span class="sxs-lookup"><span data-stu-id="45787-277">The third `Click` event handler updates the products `CategoryID` s in the same manner, but sends the update to the database using the `ProductsTableAdapter` s default `Update` method.</span></span> <span data-ttu-id="45787-278">Esto `Update` método no se ajusta a la serie de comandos dentro de una transacción, se mantendrá por lo que dichos cambios se realizan antes que el primer error de infracción de restricción de clave externa se ha encontrado.</span><span class="sxs-lookup"><span data-stu-id="45787-278">This `Update` method does not wrap the series of commands within a transaction, so those changes are made prior to the first encountered foreign key constraint violation error will persist.</span></span>

<span data-ttu-id="45787-279">Para demostrar este comportamiento, visite esta página a través de un explorador.</span><span class="sxs-lookup"><span data-stu-id="45787-279">To demonstrate this behavior, visit this page through a browser.</span></span> <span data-ttu-id="45787-280">Inicialmente verá la primera página de datos tal como se muestra en la figura 8.</span><span class="sxs-lookup"><span data-stu-id="45787-280">Initially you should see the first page of data as shown in Figure 8.</span></span> <span data-ttu-id="45787-281">A continuación, haga clic en el botón Modificar categorías (con la transacción).</span><span class="sxs-lookup"><span data-stu-id="45787-281">Next, click the Modify Categories (WITH TRANSACTION) button.</span></span> <span data-ttu-id="45787-282">Esto se producen un postback y error al intentar actualizar todos los productos `CategoryID` valores, pero se producirá una infracción de restricción de clave externa (consulte la figura 9).</span><span class="sxs-lookup"><span data-stu-id="45787-282">This will cause a postback and attempt to update all of the products `CategoryID` values, but will result in a foreign key constraint violation (see Figure 9).</span></span>


<span data-ttu-id="45787-283">[![Los productos se muestran en un control GridView paginable](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="45787-283">[![The Products are Displayed in a Pageable GridView](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span></span>

<span data-ttu-id="45787-284">**Figura 8**: Los productos se muestran en un control GridView paginable ([haga clic aquí para ver imagen en tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="45787-284">**Figure 8**: The Products are Displayed in a Pageable GridView ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span></span>


<span data-ttu-id="45787-285">[![Reasignación de los resultados de las categorías en una infracción de restricción de clave externa](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="45787-285">[![Reassigning the Categories Results in a Foreign Key Constraint Violation](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span></span>

<span data-ttu-id="45787-286">**Figura 9**: Reasignación de los resultados de las categorías en una infracción de restricción de clave externa ([haga clic aquí para ver imagen en tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="45787-286">**Figure 9**: Reassigning the Categories Results in a Foreign Key Constraint Violation ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span></span>


<span data-ttu-id="45787-287">Ahora presione el botón Atrás de explorador s y, a continuación, haga clic en el botón Actualizar la cuadrícula.</span><span class="sxs-lookup"><span data-stu-id="45787-287">Now hit your browser s Back button and then click the Refresh Grid button.</span></span> <span data-ttu-id="45787-288">Al actualizar los datos debería ver el mismo resultado exacto tal como se muestra en la figura 8.</span><span class="sxs-lookup"><span data-stu-id="45787-288">Upon refreshing the data you should see the exact same output as shown in Figure 8.</span></span> <span data-ttu-id="45787-289">Es decir, incluso aunque algunos de los productos `CategoryID` s eran los valores modificados a legal y actualiza en la base de datos, se revirtieron cuando se produjo la infracción de restricción de clave externa.</span><span class="sxs-lookup"><span data-stu-id="45787-289">That is, even though some of the products `CategoryID` s were changed to legal values and updated in the database, they were rolled back when the foreign key constraint violation occurred.</span></span>

<span data-ttu-id="45787-290">Ahora intente hacer clic en el botón Modificar categorías (sin transacción).</span><span class="sxs-lookup"><span data-stu-id="45787-290">Now try clicking the Modify Categories (WITHOUT TRANSACTION) button.</span></span> <span data-ttu-id="45787-291">Esto dará como resultado el mismo error de infracción de restricción de clave externa (consulte la figura 9), pero esta vez aquellos productos cuyo `CategoryID` los valores han cambiado a un legal valor no se revertirán.</span><span class="sxs-lookup"><span data-stu-id="45787-291">This will result in the same foreign key constraint violation error (see Figure 9), but this time those products whose `CategoryID` values were changed to a legal value will not be rolled back.</span></span> <span data-ttu-id="45787-292">Presione el botón Atrás de explorador s y, a continuación, el botón de actualización de la cuadrícula.</span><span class="sxs-lookup"><span data-stu-id="45787-292">Hit your browser s Back button and then the Refresh Grid button.</span></span> <span data-ttu-id="45787-293">Como se muestra en la figura 10, la `CategoryID` reasignación s de los ocho primeros productos.</span><span class="sxs-lookup"><span data-stu-id="45787-293">As Figure 10 shows, the `CategoryID` s of the first eight products have been reassigned.</span></span> <span data-ttu-id="45787-294">Por ejemplo, en la figura 8, Chang tenía un `CategoryID` de 1, pero en la figura 10 TI s se ha reasignado a 2.</span><span class="sxs-lookup"><span data-stu-id="45787-294">For example, in Figure 8, Chang had a `CategoryID` of 1, but in Figure 10 it s been reassigned to 2.</span></span>


<span data-ttu-id="45787-295">[![Algunos valores de Id. de categoría de productos actualizado mientras otros se han no estaban](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="45787-295">[![Some Products CategoryID Values were Updated While Others Were Not](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span></span>

<span data-ttu-id="45787-296">**Figura 10**: Algunos productos `CategoryID` valores actualizados mientras otros se han no eran ([haga clic aquí para ver imagen en tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="45787-296">**Figure 10**: Some Products `CategoryID` Values were Updated While Others Were Not ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span></span>


## <a name="summary"></a><span data-ttu-id="45787-297">Resumen</span><span class="sxs-lookup"><span data-stu-id="45787-297">Summary</span></span>

<span data-ttu-id="45787-298">De forma predeterminada, los métodos de TableAdapter s no incluyen las instrucciones ejecutadas de la base de datos dentro del ámbito de una transacción, pero con un poco de trabajo podemos agregar métodos que va a crear, confirmar y revertir una transacción.</span><span class="sxs-lookup"><span data-stu-id="45787-298">By default, the TableAdapter s methods do not wrap the executed database statements within the scope of a transaction, but with a little work we can add methods that will create, commit, and rollback a transaction.</span></span> <span data-ttu-id="45787-299">En este tutorial, hemos creado tres tales métodos en el `ProductsTableAdapter` clase: `BeginTransaction`, `CommitTransaction`, y `RollbackTransaction`.</span><span class="sxs-lookup"><span data-stu-id="45787-299">In this tutorial we created three such methods in the `ProductsTableAdapter` class: `BeginTransaction`, `CommitTransaction`, and `RollbackTransaction`.</span></span> <span data-ttu-id="45787-300">Hemos visto cómo usar estos métodos junto con un `try...catch` bloque para realizar una serie de instrucciones de modificación de datos atómico.</span><span class="sxs-lookup"><span data-stu-id="45787-300">We saw how to use these methods along with a `try...catch` block to make a series of data modification statements atomic.</span></span> <span data-ttu-id="45787-301">En concreto, hemos creado la `UpdateWithTransaction` método en el `ProductsTableAdapter`, que usa el patrón de actualización por lotes para realizar las modificaciones necesarias para las filas de una proporcionado `ProductsDataTable`.</span><span class="sxs-lookup"><span data-stu-id="45787-301">In particular, we created the `UpdateWithTransaction` method in the `ProductsTableAdapter`, which uses the Batch Update pattern to perform the necessary modifications to the rows of a supplied `ProductsDataTable`.</span></span> <span data-ttu-id="45787-302">También hemos agregado la `DeleteProductsWithTransaction` método a la `ProductsBLL` clase en el BLL, que acepta un `List` de `ProductID` valores como entrada y llama al método de patrón de DB-Direct `Delete` para cada `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="45787-302">We also added the `DeleteProductsWithTransaction` method to the `ProductsBLL` class in the BLL, which accepts a `List` of `ProductID` values as its input and calls the DB-Direct pattern method `Delete` for each `ProductID`.</span></span> <span data-ttu-id="45787-303">Ambos métodos empiece por crear una transacción y, a continuación, ejecutar las instrucciones de modificación de datos dentro de un `try...catch` bloque.</span><span class="sxs-lookup"><span data-stu-id="45787-303">Both methods start by creating a transaction and then executing the data modification statements within a `try...catch` block.</span></span> <span data-ttu-id="45787-304">Si se produce una excepción, se revierte la transacción, en caso contrario, se confirma.</span><span class="sxs-lookup"><span data-stu-id="45787-304">If an exception occurs, the transaction is rolled back, otherwise it is committed.</span></span>

<span data-ttu-id="45787-305">Paso 5 muestra el efecto de las actualizaciones de lote transaccional frente a las actualizaciones por lotes que dejó de usar una transacción.</span><span class="sxs-lookup"><span data-stu-id="45787-305">Step 5 illustrated the effect of transactional batch updates versus batch updates that neglected to use a transaction.</span></span> <span data-ttu-id="45787-306">En los tres tutoriales siguientes se compilará en los fundamentos establecidos en este tutorial y crear interfaces de usuario para realizar inserciones, eliminaciones y actualizaciones por lotes.</span><span class="sxs-lookup"><span data-stu-id="45787-306">In the next three tutorials we will build upon the foundation laid in this tutorial and create user interfaces for performing batch updates, deletes, and inserts.</span></span>

<span data-ttu-id="45787-307">Feliz programación.</span><span class="sxs-lookup"><span data-stu-id="45787-307">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="45787-308">Información adicional</span><span class="sxs-lookup"><span data-stu-id="45787-308">Further Reading</span></span>

<span data-ttu-id="45787-309">Para obtener más información sobre los temas tratados en este tutorial, consulte los siguientes recursos:</span><span class="sxs-lookup"><span data-stu-id="45787-309">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="45787-310">Mantener la coherencia de base de datos con transacciones</span><span class="sxs-lookup"><span data-stu-id="45787-310">Maintaining Database Consistency with Transactions</span></span>](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)
- [<span data-ttu-id="45787-311">Procedimientos almacenados de administración de transacciones en SQL Server</span><span class="sxs-lookup"><span data-stu-id="45787-311">Managing Transactions in SQL Server Stored Procedures</span></span>](http://www.4guysfromrolla.com/webtech/080305-1.shtml)
- [<span data-ttu-id="45787-312">Transacciones realizadas fácil: `System.Transactions`</span><span class="sxs-lookup"><span data-stu-id="45787-312">Transactions Made Easy: `System.Transactions`</span></span>](https://blogs.msdn.com/florinlazar/archive/2004/07/23/192239.aspx)
- [<span data-ttu-id="45787-313">TransactionScope y objetos DataAdapter</span><span class="sxs-lookup"><span data-stu-id="45787-313">TransactionScope and DataAdapters</span></span>](http://andyclymer.blogspot.com/2007/01/transactionscope-and-dataadapters.html)
- [<span data-ttu-id="45787-314">Uso de transacciones de bases de datos de Oracle en .NET</span><span class="sxs-lookup"><span data-stu-id="45787-314">Using Oracle Database Transactions in .NET</span></span>](http://www.oracle.com/technology/pub/articles/price_dbtrans_dotnet.html)

## <a name="about-the-author"></a><span data-ttu-id="45787-315">Acerca del autor</span><span class="sxs-lookup"><span data-stu-id="45787-315">About the Author</span></span>

<span data-ttu-id="45787-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), autor de siete libros sobre ASP/ASP.NET y fundador de [4GuysFromRolla.com](http://www.4guysfromrolla.com), trabaja con tecnologías Web de Microsoft desde 1998.</span><span class="sxs-lookup"><span data-stu-id="45787-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="45787-317">Scott trabaja como consultor independiente, instructor y escritor.</span><span class="sxs-lookup"><span data-stu-id="45787-317">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="45787-318">Su último libro es [*SAM enseñar a usted mismo ASP.NET 2.0 en 24 horas*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="45787-318">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="45787-319">Puede ponerse en [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="45787-319">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="45787-320">o a través de su blog, que puede encontrarse en [ http://ScottOnWriting.NET ](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="45787-320">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="45787-321">Agradecimientos especiales a</span><span class="sxs-lookup"><span data-stu-id="45787-321">Special Thanks To</span></span>

<span data-ttu-id="45787-322">Esta serie de tutoriales ha sido revisada por muchos revisores útiles.</span><span class="sxs-lookup"><span data-stu-id="45787-322">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="45787-323">Los revisores para este tutorial fueron Dave Gardner, Hilton Giesenow y Teresa Murphy.</span><span class="sxs-lookup"><span data-stu-id="45787-323">Lead reviewers for this tutorial were Dave Gardner, Hilton Giesenow, and Teresa Murphy.</span></span> <span data-ttu-id="45787-324">¿Está interesado en leer mi próximos artículos de MSDN?</span><span class="sxs-lookup"><span data-stu-id="45787-324">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="45787-325">Si es así, envíeme una línea en [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="45787-325">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="45787-326">Siguiente</span><span class="sxs-lookup"><span data-stu-id="45787-326">Next</span></span>](batch-updating-cs.md)
