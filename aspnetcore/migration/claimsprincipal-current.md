---
title: Migrar de ClaimsPrincipal.Current
author: mjrousos
description: Obtenga información sobre cómo migrar sin ClaimsPrincipal.Current para recuperar notificaciones en ASP.NET Core y la identidad del usuario autenticado actual.
ms.author: scaddie
ms.custom: mvc
ms.date: 05/04/2018
uid: migration/claimsprincipal-current
ms.openlocfilehash: 35c3389798041e141c45bf0a76fa9d7285212768
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 03/01/2019
ms.locfileid: "57039282"
---
# <a name="migrate-from-claimsprincipalcurrent"></a><span data-ttu-id="1e89d-103">Migrar de ClaimsPrincipal.Current</span><span class="sxs-lookup"><span data-stu-id="1e89d-103">Migrate from ClaimsPrincipal.Current</span></span>

<span data-ttu-id="1e89d-104">En proyectos ASP.NET 4.x, era habitual usar [ClaimsPrincipal.Current](/dotnet/api/system.security.claims.claimsprincipal.current) recuperar actual autenticado notificaciones y la identidad del usuario.</span><span class="sxs-lookup"><span data-stu-id="1e89d-104">In ASP.NET 4.x projects, it was common to use [ClaimsPrincipal.Current](/dotnet/api/system.security.claims.claimsprincipal.current) to retrieve the current authenticated user's identity and claims.</span></span> <span data-ttu-id="1e89d-105">En ASP.NET Core, ya no se establece esta propiedad.</span><span class="sxs-lookup"><span data-stu-id="1e89d-105">In ASP.NET Core, this property is no longer set.</span></span> <span data-ttu-id="1e89d-106">Código que dependía de la debe actualizarse para obtener la identidad del usuario autenticado actual mediante un medio diferente.</span><span class="sxs-lookup"><span data-stu-id="1e89d-106">Code that was depending on it needs to be updated to get the current authenticated user's identity through a different means.</span></span>

## <a name="context-specific-data-instead-of-static-data"></a><span data-ttu-id="1e89d-107">Datos específicos del contexto en lugar de datos estáticos</span><span class="sxs-lookup"><span data-stu-id="1e89d-107">Context-specific data instead of static data</span></span>

<span data-ttu-id="1e89d-108">Cuando se usa ASP.NET Core, los valores de `ClaimsPrincipal.Current` y `Thread.CurrentPrincipal` no están establecidos.</span><span class="sxs-lookup"><span data-stu-id="1e89d-108">When using ASP.NET Core, the values of both `ClaimsPrincipal.Current` and `Thread.CurrentPrincipal` aren't set.</span></span> <span data-ttu-id="1e89d-109">Estas propiedades representan el estado estático, lo que generalmente evita ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="1e89d-109">These properties both represent static state, which ASP.NET Core generally avoids.</span></span> <span data-ttu-id="1e89d-110">En su lugar, arquitectura de ASP.NET Core es recuperar las dependencias (como la identidad del usuario actual) de las colecciones específicas del contexto de servicio (mediante su [inserción de dependencias](xref:fundamentals/dependency-injection) modelo (DI)).</span><span class="sxs-lookup"><span data-stu-id="1e89d-110">Instead, ASP.NET Core's architecture is to retrieve dependencies (like the current user's identity) from context-specific service collections (using its [dependency injection](xref:fundamentals/dependency-injection) (DI) model).</span></span> <span data-ttu-id="1e89d-111">¿Qué es más, `Thread.CurrentPrincipal` es subproceso estático, por lo que no pueden conservar los cambios en algunos escenarios asincrónicos (y `ClaimsPrincipal.Current` simplemente llama a `Thread.CurrentPrincipal` de forma predeterminada).</span><span class="sxs-lookup"><span data-stu-id="1e89d-111">What's more, `Thread.CurrentPrincipal` is thread static, so it may not persist changes in some asynchronous scenarios (and `ClaimsPrincipal.Current` just calls `Thread.CurrentPrincipal` by default).</span></span>

<span data-ttu-id="1e89d-112">Para entender a los tipos de subprocesos de problemas pueden provocar que los miembros estáticos en escenarios asincrónicos, observe el siguiente fragmento de código:</span><span class="sxs-lookup"><span data-stu-id="1e89d-112">To understand the sorts of problems thread static members can lead to in asynchronous scenarios, consider the following code snippet:</span></span>

```csharp
// Create a ClaimsPrincipal and set Thread.CurrentPrincipal
var identity = new ClaimsIdentity();
identity.AddClaim(new Claim(ClaimTypes.Name, "User1"));
Thread.CurrentPrincipal = new ClaimsPrincipal(identity);

// Check the current user
Console.WriteLine($"Current user: {Thread.CurrentPrincipal?.Identity.Name}");

// For the method to complete asynchronously
await Task.Yield();

// Check the current user after
Console.WriteLine($"Current user: {Thread.CurrentPrincipal?.Identity.Name}");
```

<span data-ttu-id="1e89d-113">El código de ejemplo anterior establece `Thread.CurrentPrincipal` y comprueba su valor antes y después de esperar una llamada asincrónica.</span><span class="sxs-lookup"><span data-stu-id="1e89d-113">The preceding sample code sets `Thread.CurrentPrincipal` and checks its value before and after awaiting an asynchronous call.</span></span> <span data-ttu-id="1e89d-114">`Thread.CurrentPrincipal` es específico de la *subproceso* en el que se ha configurado y el método es apropiado reanudar la ejecución en un subproceso diferente después del await.</span><span class="sxs-lookup"><span data-stu-id="1e89d-114">`Thread.CurrentPrincipal` is specific to the *thread* on which it's set, and the method is likely to resume execution on a different thread after the await.</span></span> <span data-ttu-id="1e89d-115">Por lo tanto, `Thread.CurrentPrincipal` está presente cuando se comprueba en primer lugar, pero es null tras la llamada a `await Task.Yield()`.</span><span class="sxs-lookup"><span data-stu-id="1e89d-115">Consequently, `Thread.CurrentPrincipal` is present when it's first checked but is null after the call to `await Task.Yield()`.</span></span>

<span data-ttu-id="1e89d-116">Obtener la identidad del usuario actual de recopilación de la aplicación de servicio de inserción de dependencias es más estable, demasiado, puesto que se pueden insertar fácilmente las identidades de la prueba.</span><span class="sxs-lookup"><span data-stu-id="1e89d-116">Getting the current user's identity from the app's DI service collection is more testable, too, since test identities can be easily injected.</span></span>

## <a name="retrieve-the-current-user-in-an-aspnet-core-app"></a><span data-ttu-id="1e89d-117">Recuperar el usuario actual en una aplicación ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="1e89d-117">Retrieve the current user in an ASP.NET Core app</span></span>

<span data-ttu-id="1e89d-118">Hay varias opciones para la recuperación del usuario autenticado actual `ClaimsPrincipal` en ASP.NET Core en lugar de `ClaimsPrincipal.Current`:</span><span class="sxs-lookup"><span data-stu-id="1e89d-118">There are several options for retrieving the current authenticated user's `ClaimsPrincipal` in ASP.NET Core in place of `ClaimsPrincipal.Current`:</span></span>

* <span data-ttu-id="1e89d-119">**ControllerBase.User**.</span><span class="sxs-lookup"><span data-stu-id="1e89d-119">**ControllerBase.User**.</span></span> <span data-ttu-id="1e89d-120">Los controladores MVC pueden tener acceso al usuario autenticado actual con sus [usuario](/dotnet/api/microsoft.aspnetcore.mvc.controllerbase.user) propiedad.</span><span class="sxs-lookup"><span data-stu-id="1e89d-120">MVC controllers can access the current authenticated user with their [User](/dotnet/api/microsoft.aspnetcore.mvc.controllerbase.user) property.</span></span>
* <span data-ttu-id="1e89d-121">**HttpContext.User**.</span><span class="sxs-lookup"><span data-stu-id="1e89d-121">**HttpContext.User**.</span></span> <span data-ttu-id="1e89d-122">Los componentes con acceso a la actual `HttpContext` (middleware, por ejemplo) puede obtener el usuario actual `ClaimsPrincipal` desde [HttpContext.User](/dotnet/api/microsoft.aspnetcore.http.httpcontext.user).</span><span class="sxs-lookup"><span data-stu-id="1e89d-122">Components with access to the current `HttpContext` (middleware, for example) can get the current user's `ClaimsPrincipal` from [HttpContext.User](/dotnet/api/microsoft.aspnetcore.http.httpcontext.user).</span></span>
* <span data-ttu-id="1e89d-123">**Pasa del autor de llamada**.</span><span class="sxs-lookup"><span data-stu-id="1e89d-123">**Passed in from caller**.</span></span> <span data-ttu-id="1e89d-124">Bibliotecas sin acceso a la actual `HttpContext` a menudo se llaman desde los controladores o componentes de middleware y puede tener la identidad del usuario actual se pasa como un argumento.</span><span class="sxs-lookup"><span data-stu-id="1e89d-124">Libraries without access to the current `HttpContext` are often called from controllers or middleware components and can have the current user's identity passed as an argument.</span></span>
* <span data-ttu-id="1e89d-125">**IHttpContextAccessor**.</span><span class="sxs-lookup"><span data-stu-id="1e89d-125">**IHttpContextAccessor**.</span></span> <span data-ttu-id="1e89d-126">El proyecto que se está migrando a ASP.NET Core puede ser demasiado grande para pasar fácilmente la identidad del usuario actual para todas las ubicaciones necesarias.</span><span class="sxs-lookup"><span data-stu-id="1e89d-126">The project being migrated to ASP.NET Core may be too large to easily pass the current user's identity to all necessary locations.</span></span> <span data-ttu-id="1e89d-127">En tales casos, [IHttpContextAccessor](/dotnet/api/microsoft.aspnetcore.http.ihttpcontextaccessor) puede usarse como solución alternativa.</span><span class="sxs-lookup"><span data-stu-id="1e89d-127">In such cases, [IHttpContextAccessor](/dotnet/api/microsoft.aspnetcore.http.ihttpcontextaccessor) can be used as a workaround.</span></span> <span data-ttu-id="1e89d-128">`IHttpContextAccessor` puede tener acceso a la actual `HttpContext` (si existe).</span><span class="sxs-lookup"><span data-stu-id="1e89d-128">`IHttpContextAccessor` is able to access the current `HttpContext` (if one exists).</span></span> <span data-ttu-id="1e89d-129">Sería una solución a corto plazo para obtener la identidad del usuario actual en el código que aún no se ha actualizado para trabajar con la arquitectura controlada por DI de ASP.NET Core:</span><span class="sxs-lookup"><span data-stu-id="1e89d-129">A short-term solution to getting the current user's identity in code that hasn't yet been updated to work with ASP.NET Core's DI-driven architecture would be:</span></span>

  * <span data-ttu-id="1e89d-130">Asegúrese de `IHttpContextAccessor` disponibles en el contenedor de inserción de dependencias mediante una llamada a [AddHttpContextAccessor](https://github.com/aspnet/Hosting/issues/793) en `Startup.ConfigureServices`.</span><span class="sxs-lookup"><span data-stu-id="1e89d-130">Make `IHttpContextAccessor` available in the DI container by calling [AddHttpContextAccessor](https://github.com/aspnet/Hosting/issues/793) in `Startup.ConfigureServices`.</span></span>
  * <span data-ttu-id="1e89d-131">Obtener una instancia de `IHttpContextAccessor` durante el inicio y almacenarlo en una variable estática.</span><span class="sxs-lookup"><span data-stu-id="1e89d-131">Get an instance of `IHttpContextAccessor` during startup and store it in a static variable.</span></span> <span data-ttu-id="1e89d-132">La instancia está disponible para código que anteriormente estaba recuperando el usuario actual de una propiedad estática.</span><span class="sxs-lookup"><span data-stu-id="1e89d-132">The instance is made available to code that was previously retrieving the current user from a static property.</span></span>
  * <span data-ttu-id="1e89d-133">Recuperar el usuario actual `ClaimsPrincipal` mediante `HttpContextAccessor.HttpContext?.User`.</span><span class="sxs-lookup"><span data-stu-id="1e89d-133">Retrieve the current user's `ClaimsPrincipal` using `HttpContextAccessor.HttpContext?.User`.</span></span> <span data-ttu-id="1e89d-134">Si este código se usa fuera del contexto de una solicitud HTTP, el `HttpContext` es null.</span><span class="sxs-lookup"><span data-stu-id="1e89d-134">If this code is used outside of the context of an HTTP request, the `HttpContext` is null.</span></span>

<span data-ttu-id="1e89d-135">La última opción, mediante `IHttpContextAccessor`, al contrario de los principios de ASP.NET Core (prefiere sobre dependencias insertadas dependencia estática).</span><span class="sxs-lookup"><span data-stu-id="1e89d-135">The final option, using `IHttpContextAccessor`, is contrary to ASP.NET Core principles (preferring injected dependencies to static dependencies).</span></span> <span data-ttu-id="1e89d-136">Previsto eliminar eventualmente la dependencia de estático `IHttpContextAccessor` auxiliar.</span><span class="sxs-lookup"><span data-stu-id="1e89d-136">Plan to eventually remove the dependency on the static `IHttpContextAccessor` helper.</span></span> <span data-ttu-id="1e89d-137">Puede ser un puente útil, sin embargo, al migrar grandes aplicaciones ASP.NET existentes que estaban usando anteriormente `ClaimsPrincipal.Current`.</span><span class="sxs-lookup"><span data-stu-id="1e89d-137">It can be a useful bridge, though, when migrating large existing ASP.NET apps that were previously using `ClaimsPrincipal.Current`.</span></span>
