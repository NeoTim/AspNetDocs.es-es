---
uid: web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
title: Prevención de ataques de falsificación (CSRF) de solicitud entre sitios en ASP.NET MVC
author: MikeWasson
description: Describe el ataque de solicitudes entre sitios (CSRF) de la falsificación y cómo implementar medidas de anti-CSRF en Web de ASP.NET MVC.
ms.author: riande
ms.date: 12/12/2012
ms.assetid: 81d46f14-8f48-4d8c-830d-cc8d594dc11b
msc.legacyurl: /web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
msc.type: authoredcontent
ms.openlocfilehash: 5fb0f8bcc9e587ba4fbbf2b857d3bf7adcaafb94
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 04/09/2019
ms.locfileid: "59392032"
---
# <a name="preventing-cross-site-request-forgery-csrf-attacks-in-aspnet-mvc-application"></a><span data-ttu-id="fa4b1-103">Prevención de ataques de falsificación (CSRF) de solicitudes entre sitios en la aplicación ASP.NET MVC</span><span class="sxs-lookup"><span data-stu-id="fa4b1-103">Preventing Cross-Site Request Forgery (CSRF) Attacks in ASP.NET MVC Application</span></span>

<span data-ttu-id="fa4b1-104">por [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="fa4b1-104">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

<span data-ttu-id="fa4b1-105">Falsificación de solicitud entre sitios (CSRF) es un ataque en un sitio malintencionado envía una solicitud a un sitio vulnerable donde el usuario ha iniciado en</span><span class="sxs-lookup"><span data-stu-id="fa4b1-105">Cross-Site Request Forgery (CSRF) is an attack where a malicious site sends a request to a vulnerable site where the user is currently logged in</span></span>

<span data-ttu-id="fa4b1-106">Este es un ejemplo de un ataque CSRF:</span><span class="sxs-lookup"><span data-stu-id="fa4b1-106">Here is an example of a CSRF attack:</span></span>

1. <span data-ttu-id="fa4b1-107">Un usuario inicia sesión en `www.example.com` utilizando la autenticación de formularios.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-107">A user logs into `www.example.com` using forms authentication.</span></span>
2. <span data-ttu-id="fa4b1-108">El servidor autentica al usuario.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-108">The server authenticates the user.</span></span> <span data-ttu-id="fa4b1-109">La respuesta del servidor incluye una cookie de autenticación.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-109">The response from the server includes an authentication cookie.</span></span>
3. <span data-ttu-id="fa4b1-110">Sin cerrar la sesión, el usuario visita un sitio web malicioso.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-110">Without logging out, the user visits a malicious web site.</span></span> <span data-ttu-id="fa4b1-111">Este sitio malintencionado contiene el siguiente formulario HTML:</span><span class="sxs-lookup"><span data-stu-id="fa4b1-111">This malicious site contains the following HTML form:</span></span> 

    [!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample1.html)]

    <span data-ttu-id="fa4b1-112">Tenga en cuenta que la acción de formulario se publica en el sitio vulnerable, no en el sitio malintencionado.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-112">Notice that the form action posts to the vulnerable site, not to the malicious site.</span></span> <span data-ttu-id="fa4b1-113">Esta es la parte "cross-site" de CSRF.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-113">This is the "cross-site" part of CSRF.</span></span>
4. <span data-ttu-id="fa4b1-114">El usuario hace clic con el botón Enviar.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-114">The user clicks the submit button.</span></span> <span data-ttu-id="fa4b1-115">El explorador incluye la cookie de autenticación con la solicitud.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-115">The browser includes the authentication cookie with the request.</span></span>
5. <span data-ttu-id="fa4b1-116">La solicitud se ejecuta en el servidor con contexto de autenticación del usuario y puede hacer cualquier cosa que puede hacer un usuario autenticado.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-116">The request runs on the server with the user's authentication context, and can do anything that an authenticated user is allowed to do.</span></span>

<span data-ttu-id="fa4b1-117">Aunque este ejemplo requiere que el usuario haga clic en el botón del formulario, la página malintencionada podría tal como ejecutar fácilmente una secuencia de comandos que envía el formulario automáticamente.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-117">Although this example requires the user to click the form button, the malicious page could just as easily run a script that submits the form automatically.</span></span> <span data-ttu-id="fa4b1-118">Además, con SSL no impide que un ataque CSRF, dado que el sitio Web malintencionado puede enviar una solicitud de "https://".</span><span class="sxs-lookup"><span data-stu-id="fa4b1-118">Moreover, using SSL does not prevent a CSRF attack, because the malicious site can send an "https://" request.</span></span>

<span data-ttu-id="fa4b1-119">Normalmente, los ataques CSRF son posibles con sitios web que usan cookies para la autenticación, porque los exploradores envían todas las cookies relevantes al sitio web de destino.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-119">Typically, CSRF attacks are possible against web sites that use cookies for authentication, because browsers send all relevant cookies to the destination web site.</span></span> <span data-ttu-id="fa4b1-120">Sin embargo, los ataques CSRF no están limitados a aprovechar las cookies.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-120">However, CSRF attacks are not limited to exploiting cookies.</span></span> <span data-ttu-id="fa4b1-121">Por ejemplo, la autenticación básica e implícita también son vulnerables.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-121">For example, Basic and Digest authentication are also vulnerable.</span></span> <span data-ttu-id="fa4b1-122">Después de un usuario inicia sesión con la autenticación básica o implícita.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-122">After a user logs in with Basic or Digest authentication.</span></span> <span data-ttu-id="fa4b1-123">el explorador envía automáticamente las credenciales hasta que finaliza la sesión.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-123">the browser automatically sends the credentials until the session ends.</span></span>

## <a name="anti-forgery-tokens"></a><span data-ttu-id="fa4b1-124">Tokens antifalsificación</span><span class="sxs-lookup"><span data-stu-id="fa4b1-124">Anti-Forgery Tokens</span></span>

<span data-ttu-id="fa4b1-125">Para ayudar a evitar ataques CSRF, ASP.NET MVC usa tokens antifalsificación, también denominados *solicitar tokens de comprobación*.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-125">To help prevent CSRF attacks, ASP.NET MVC uses anti-forgery tokens, also called *request verification tokens*.</span></span>

1. <span data-ttu-id="fa4b1-126">El cliente solicita una página HTML que contiene un formulario.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-126">The client requests an HTML page that contains a form.</span></span>
2. <span data-ttu-id="fa4b1-127">El servidor incluye dos tokens en la respuesta.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-127">The server includes two tokens in the response.</span></span> <span data-ttu-id="fa4b1-128">Un token se envía como una cookie.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-128">One token is sent as a cookie.</span></span> <span data-ttu-id="fa4b1-129">El otro se coloca en un campo de formulario oculto.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-129">The other is placed in a hidden form field.</span></span> <span data-ttu-id="fa4b1-130">Los tokens se generan aleatoriamente para que un adversario no puede adivinar los valores.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-130">The tokens are generated randomly so that an adversary cannot guess the values.</span></span>
3. <span data-ttu-id="fa4b1-131">Cuando el cliente envía el formulario, ambos tokens debe enviar al servidor.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-131">When the client submits the form, it must send both tokens back to the server.</span></span> <span data-ttu-id="fa4b1-132">El cliente envía el token de cookie como una cookie y envía el token de formulario dentro de los datos del formulario.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-132">The client sends the cookie token as a cookie, and it sends the form token inside the form data.</span></span> <span data-ttu-id="fa4b1-133">(Un cliente del explorador hace automáticamente cuando el usuario envía el formulario.)</span><span class="sxs-lookup"><span data-stu-id="fa4b1-133">(A browser client automatically does this when the user submits the form.)</span></span>
4. <span data-ttu-id="fa4b1-134">Si una solicitud no incluye ambos tokens, el servidor no permite la solicitud.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-134">If a request does not include both tokens, the server disallows the request.</span></span>

<span data-ttu-id="fa4b1-135">Este es un ejemplo de un formulario HTML con un token de formulario oculto:</span><span class="sxs-lookup"><span data-stu-id="fa4b1-135">Here is an example of an HTML form with a hidden form token:</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample2.html)]

<span data-ttu-id="fa4b1-136">Tokens antifalsificación funcionan porque la página malintencionada no puede leer los tokens de usuario, debido a las directivas del mismo origen.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-136">Anti-forgery tokens work because the malicious page cannot read the user's tokens, due to same-origin policies.</span></span> <span data-ttu-id="fa4b1-137">([Directivas del mismo origen](http://www.w3.org/Security/wiki/Same_Origin_Policy) evitar que los documentos hospedados en dos sitios diferentes de obtener acceso al contenido de los demás.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-137">([Same-origin policies](http://www.w3.org/Security/wiki/Same_Origin_Policy) prevent documents hosted on two different sites from accessing each other's content.</span></span> <span data-ttu-id="fa4b1-138">Por lo que en el ejemplo anterior, la página malintencionada puede enviar solicitudes a ejemplo.com, pero no puede leer la respuesta).</span><span class="sxs-lookup"><span data-stu-id="fa4b1-138">So in the earlier example, the malicious page can send requests to example.com, but it cannot read the response.)</span></span>

<span data-ttu-id="fa4b1-139">Para evitar ataques CSRF, use tokens antifalsificación con cualquier protocolo de autenticación que el explorador envía automáticamente las credenciales después de que el usuario inicia sesión.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-139">To prevent CSRF attacks, use anti-forgery tokens with any authentication protocol where the browser silently sends credentials after the user logs in.</span></span> <span data-ttu-id="fa4b1-140">Esto incluye los protocolos de autenticación basada en cookies, como la autenticación de formularios, así como protocolos, como la autenticación básica e implícita.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-140">This includes cookie-based authentication protocols, such as forms authentication, as well as protocols such as Basic and Digest authentication.</span></span>

<span data-ttu-id="fa4b1-141">Debe solicitar tokens antifalsificación para todos los métodos nonsafe (POST, PUT, DELETE).</span><span class="sxs-lookup"><span data-stu-id="fa4b1-141">You should require anti-forgery tokens for any nonsafe methods (POST, PUT, DELETE).</span></span> <span data-ttu-id="fa4b1-142">Además, asegúrese de que los métodos de prueba de errores (GET, HEAD) no tienen efectos secundarios.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-142">Also, make sure that safe methods (GET, HEAD) do not have any side effects.</span></span> <span data-ttu-id="fa4b1-143">Además, si habilita la compatibilidad entre dominios, como la CORS o JSONP, métodos seguros incluso como obtener son potencialmente vulnerables a ataques CSRF, lo que permite al atacante leer datos potencialmente confidenciales.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-143">Moreover, if you enable cross-domain support, such as CORS or JSONP, then even safe methods like GET are potentially vulnerable to CSRF attacks, allowing the attacker to read potentially sensitive data.</span></span>

## <a name="anti-forgery-tokens-in-aspnet-mvc"></a><span data-ttu-id="fa4b1-144">Tokens antifalsificación en ASP.NET MVC</span><span class="sxs-lookup"><span data-stu-id="fa4b1-144">Anti-Forgery Tokens in ASP.NET MVC</span></span>

<span data-ttu-id="fa4b1-145">Para agregar los tokens antifalsificación a una página de Razor, use el **HtmlHelper.AntiForgeryToken** método auxiliar:</span><span class="sxs-lookup"><span data-stu-id="fa4b1-145">To add the anti-forgery tokens to a Razor page, use the **HtmlHelper.AntiForgeryToken** helper method:</span></span>

[!code-cshtml[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample3.cshtml)]

<span data-ttu-id="fa4b1-146">Este método agrega el campo de formulario oculto y también establece el token de cookie.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-146">This method adds the hidden form field and also sets the cookie token.</span></span>

## <a name="anti-csrf-and-ajax"></a><span data-ttu-id="fa4b1-147">Anti-CSRF y AJAX</span><span class="sxs-lookup"><span data-stu-id="fa4b1-147">Anti-CSRF and AJAX</span></span>

<span data-ttu-id="fa4b1-148">El token de formulario puede ser un problema para las solicitudes AJAX, porque una solicitud AJAX podría enviar datos JSON, no los datos de formulario HTML.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-148">The form token can be a problem for AJAX requests, because an AJAX request might send JSON data, not HTML form data.</span></span> <span data-ttu-id="fa4b1-149">Una solución consiste en enviar los tokens en un encabezado HTTP personalizado.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-149">One solution is to send the tokens in a custom HTTP header.</span></span> <span data-ttu-id="fa4b1-150">El código siguiente usa la sintaxis de Razor para generar los tokens y, a continuación, agrega a una solicitud AJAX.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-150">The following code uses Razor syntax to generate the tokens, and then adds the tokens to an AJAX request.</span></span> <span data-ttu-id="fa4b1-151">Los tokens se generan en el servidor mediante una llamada a **AntiForgery.GetTokens**.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-151">The tokens are generated at the server by calling **AntiForgery.GetTokens**.</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample4.html)]

<span data-ttu-id="fa4b1-152">Al procesar la solicitud, extraiga los tokens del encabezado de solicitud.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-152">When you process the request, extract the tokens from the request header.</span></span> <span data-ttu-id="fa4b1-153">A continuación, llame a la **AntiForgery.Validate** método para validar los tokens.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-153">Then call the **AntiForgery.Validate** method to validate the tokens.</span></span> <span data-ttu-id="fa4b1-154">El **validar** método produce una excepción si los tokens no son válidos.</span><span class="sxs-lookup"><span data-stu-id="fa4b1-154">The **Validate** method throws an exception if the tokens are not valid.</span></span>

[!code-csharp[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample5.cs)]
