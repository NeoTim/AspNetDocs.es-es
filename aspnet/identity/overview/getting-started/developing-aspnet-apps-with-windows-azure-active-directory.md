---
uid: identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
title: Desarrollo de aplicaciones de ASP.NET con Azure Active Directory-ASP.NET 4. x
author: Rick-Anderson
description: Microsoft ASP.NET herramientas para Azure Active Directory facilita la habilitación de la autenticación para las aplicaciones web hospedadas en Azure. Puede usar Azure autenti...
ms.author: riande
ms.date: 08/14/2014
ms.assetid: 457d7eaf-ee76-4ceb-9082-c7c1721435ad
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
msc.type: authoredcontent
ms.openlocfilehash: 28425ea8d1312dfc6e14df9677396f2cbcf6f16d
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 03/06/2020
ms.locfileid: "78471745"
---
# <a name="developing-aspnet-apps-with-azure-active-directory"></a><span data-ttu-id="3faa7-104">Desarrollo de aplicaciones ASP.NET con Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="3faa7-104">Developing ASP.NET Apps with Azure Active Directory</span></span>

<span data-ttu-id="3faa7-105">por [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="3faa7-105">by [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="3faa7-106">Las herramientas de Microsoft ASP.NET para Azure Active Directory simplifican la habilitación de la autenticación para las aplicaciones web hospedadas en [Azure](https://www.windowsazure.com/home/features/web-sites/).</span><span class="sxs-lookup"><span data-stu-id="3faa7-106">Microsoft ASP.NET tools for Azure Active Directory simplifies enabling authentication for web apps hosted on [Azure](https://www.windowsazure.com/home/features/web-sites/).</span></span> <span data-ttu-id="3faa7-107">Puede usar la autenticación de Azure para autenticar a usuarios de Office 365 de su organización, cuentas corporativas sincronizadas desde su Active Directory local o usuarios creados en su propio dominio de Azure Active Directory personalizado.</span><span class="sxs-lookup"><span data-stu-id="3faa7-107">You can use Azure Authentication to authenticate Office 365 users from your organization, corporate accounts synced from your on-premise Active Directory or users created in your own custom Azure Active Directory domain.</span></span> <span data-ttu-id="3faa7-108">Al habilitar la autenticación de Windows Azure, se configura la aplicación para autenticar a los usuarios mediante un solo inquilino de [Azure Active Directory](https://docs.microsoft.com/azure/active-directory/) .</span><span class="sxs-lookup"><span data-stu-id="3faa7-108">Enabling Windows Azure Authentication configures your application to authenticate users using a single [Azure Active Directory](https://docs.microsoft.com/azure/active-directory/) tenant.</span></span>

<span data-ttu-id="3faa7-109">En este tutorial se muestra cómo crear una aplicación ASP.NET que está configurada para el inicio de sesión con [Azure Active Directory](https://msdn.microsoft.com/library/azure/mt168838.aspx) (Azure ad).</span><span class="sxs-lookup"><span data-stu-id="3faa7-109">This tutorial will show you how to create an ASP.NET application that is configured for sign-on with [Azure Active Directory](https://msdn.microsoft.com/library/azure/mt168838.aspx) (Azure AD).</span></span> <span data-ttu-id="3faa7-110">También aprenderá a llamar a la Graph API para obtener información sobre el usuario que ha iniciado sesión actualmente y cómo implementar la aplicación en Azure.</span><span class="sxs-lookup"><span data-stu-id="3faa7-110">You will also learn how to call the Graph API to get information about the currently signed-in user and how to deploy the application to Azure.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="3faa7-111">Requisitos previos</span><span class="sxs-lookup"><span data-stu-id="3faa7-111">Prerequisites</span></span>

1. <span data-ttu-id="3faa7-112">[Visual Studio Express 2013 para web](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express) o [Visual Studio 2013](https://my.visualstudio.com/Downloads?q=visual%20studio%202013).</span><span class="sxs-lookup"><span data-stu-id="3faa7-112">[Visual Studio Express 2013 for Web](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express) or [Visual Studio 2013](https://my.visualstudio.com/Downloads?q=visual%20studio%202013).</span></span>
2. <span data-ttu-id="3faa7-113">Se requiere [Visual Studio 2013 update 4](https://www.microsoft.com/download/details.aspx?id=44921) -Update 3 o posterior.</span><span class="sxs-lookup"><span data-stu-id="3faa7-113">[Visual Studio 2013 Update 4](https://www.microsoft.com/download/details.aspx?id=44921) - Update 3 or higher is required.</span></span>
3. <span data-ttu-id="3faa7-114">Una cuenta de Azure.</span><span class="sxs-lookup"><span data-stu-id="3faa7-114">An Azure account.</span></span> <span data-ttu-id="3faa7-115">[Haga clic aquí](https://azure.microsoft.com/pricing/free-trial/) para obtener una evaluación gratuita si aún no tiene una cuenta.</span><span class="sxs-lookup"><span data-stu-id="3faa7-115">[Click here](https://azure.microsoft.com/pricing/free-trial/) for a free trial if you do not already have an account.</span></span>

## <a name="add-a-global-administrator-to-your-active-directory"></a><span data-ttu-id="3faa7-116">Agregue un administrador global a su Active Directory</span><span class="sxs-lookup"><span data-stu-id="3faa7-116">Add a Global Administrator to your Active Directory</span></span>

1. <span data-ttu-id="3faa7-117">Inicie sesión en el [Portal de administración de Azure](https://manage.windowsazure.com/).</span><span class="sxs-lookup"><span data-stu-id="3faa7-117">Sign in to the [Azure Management Portal](https://manage.windowsazure.com/).</span></span>
2. <span data-ttu-id="3faa7-118">Todas las cuentas de Azure contienen un **directorio predeterminado** , haga clic en ella y, a continuación, haga clic en la pestaña **usuarios** en la parte superior de la página (vea la imagen siguiente).</span><span class="sxs-lookup"><span data-stu-id="3faa7-118">All Azure accounts contain a **Default Directory** -- click on it, then click the **Users** tab at the top of the page (see image below).</span></span>
3. <span data-ttu-id="3faa7-119">Haga clic en Agregar usuario.</span><span class="sxs-lookup"><span data-stu-id="3faa7-119">Click Add User.</span></span>
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image1.png)
4. <span data-ttu-id="3faa7-120">Cree un nuevo usuario con el rol de **administrador global** .</span><span class="sxs-lookup"><span data-stu-id="3faa7-120">Create a new user with the **Global Administrator** role.</span></span> <span data-ttu-id="3faa7-121">Haga clic en **usuarios** en el menú superior y, a continuación, haga clic en el botón **Agregar usuario** de la barra de comandos.</span><span class="sxs-lookup"><span data-stu-id="3faa7-121">Click **Users** from the top menu, and then click the **Add User** button on the command bar.</span></span>
5. <span data-ttu-id="3faa7-122">En el cuadro de diálogo **Agregar usuario** , escriba un nombre para el nuevo usuario y, a continuación, haga clic en la flecha derecha.</span><span class="sxs-lookup"><span data-stu-id="3faa7-122">In the **Add User** dialog, enter a name for the new user and then click the right arrow.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image2.png)
6. <span data-ttu-id="3faa7-123">Escriba el nombre de usuario y establezca el rol en **administrador global**.</span><span class="sxs-lookup"><span data-stu-id="3faa7-123">Enter the user name and set the role to **Global Administrator**.</span></span> <span data-ttu-id="3faa7-124">Los administradores globales requieren una dirección de correo electrónico alternativa para la recuperación de contraseñas.</span><span class="sxs-lookup"><span data-stu-id="3faa7-124">Global administrators require an alternate email address for password recovery purposes.</span></span> <span data-ttu-id="3faa7-125">Cuando haya terminado, haga clic en la flecha derecha.</span><span class="sxs-lookup"><span data-stu-id="3faa7-125">After you're finished, click the right arrow.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image3.png)
7. <span data-ttu-id="3faa7-126">En la página siguiente del cuadro de diálogo, haga clic en **crear**.</span><span class="sxs-lookup"><span data-stu-id="3faa7-126">On the next page of the dialog, click **Create**.</span></span> <span data-ttu-id="3faa7-127">Se creará una contraseña temporal para el nuevo usuario y se mostrará en el cuadro de diálogo.</span><span class="sxs-lookup"><span data-stu-id="3faa7-127">A temporary password will be created for the new user and displayed in the dialog.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image4.png)

   <span data-ttu-id="3faa7-128">Guardar la contraseña, se le pedirá que cambie la contraseña después del primer inicio de sesión.</span><span class="sxs-lookup"><span data-stu-id="3faa7-128">Save the password, you will be required to change the password after the first log in.</span></span> <span data-ttu-id="3faa7-129">En la imagen siguiente se muestra la nueva cuenta de administrador.</span><span class="sxs-lookup"><span data-stu-id="3faa7-129">The following image shows the new admin account.</span></span> <span data-ttu-id="3faa7-130">Debe usar la Azure Active Directory para iniciar sesión en la aplicación, no en la cuenta de Microsoft también se muestra en esta página.</span><span class="sxs-lookup"><span data-stu-id="3faa7-130">You must use the Azure Active Directory to log into your app, not the Microsoft account also shown on this page.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image5.png)

## <a name="create-an-aspnet-application"></a><span data-ttu-id="3faa7-131">Creación de una aplicación de ASP.NET</span><span class="sxs-lookup"><span data-stu-id="3faa7-131">Create an ASP.NET Application</span></span>

<span data-ttu-id="3faa7-132">En los pasos siguientes se usa [Visual Studio Express 2013 para web](https://www.microsoft.com/download/details.aspx?id=40747)y se requiere [Visual Studio 2013 Update 3](https://www.microsoft.com/download/details.aspx?id=43721).</span><span class="sxs-lookup"><span data-stu-id="3faa7-132">The following steps use [Visual Studio Express 2013 for Web](https://www.microsoft.com/download/details.aspx?id=40747), and requires [Visual Studio 2013 Update 3](https://www.microsoft.com/download/details.aspx?id=43721).</span></span>

1. <span data-ttu-id="3faa7-133">En Visual Studio, haga clic en **archivo** y, a continuación, en **nuevo proyecto**.</span><span class="sxs-lookup"><span data-stu-id="3faa7-133">In Visual Studio, click **File** and then **New Project**.</span></span> <span data-ttu-id="3faa7-134">En el cuadro de diálogo **nuevo proyecto** , seleccione C# el proyecto web visual en el menú de la izquierda y haga clic en **Aceptar**.</span><span class="sxs-lookup"><span data-stu-id="3faa7-134">On the **New Project** dialog, select the Visual C# Web project from the left menu and click **OK**.</span></span> <span data-ttu-id="3faa7-135">También puede desactivar **agregar Application Insights a proyecto** si no desea la funcionalidad de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="3faa7-135">You may also want to uncheck the **Add Application Insights to Project** if you don't want the functionality for your application.</span></span>
2. <span data-ttu-id="3faa7-136">En el cuadro de diálogo **nuevo proyecto ASP.net** , seleccione **MVC**y, a continuación, haga clic en **cambiar autenticación**.</span><span class="sxs-lookup"><span data-stu-id="3faa7-136">In the **New ASP.NET Project** dialog, select **MVC**, and then click **Change Authentication**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image6.png)
3. <span data-ttu-id="3faa7-137">En el cuadro de diálogo **cambiar autenticación** , seleccione **cuentas organizativas**.</span><span class="sxs-lookup"><span data-stu-id="3faa7-137">On the **Change Authentication** dialog, select **Organizational Accounts**.</span></span> <span data-ttu-id="3faa7-138">Estas opciones se pueden usar para registrar automáticamente la aplicación con Azure AD y configurar automáticamente la aplicación para que se integre con Azure AD.</span><span class="sxs-lookup"><span data-stu-id="3faa7-138">These options can be used to automatically register your application with Azure AD as well as automatically configure your application to integrate with Azure AD.</span></span> <span data-ttu-id="3faa7-139">No tiene que usar el cuadro de diálogo **cambiar autenticación** para registrar y configurar la aplicación, pero hace que sea mucho más fácil.</span><span class="sxs-lookup"><span data-stu-id="3faa7-139">You don't have to use the **Change Authentication** dialog to register and configure your application, but it makes it much easier.</span></span> <span data-ttu-id="3faa7-140">Si usa Visual Studio 2012 por ejemplo, puede registrar manualmente la aplicación en Azure Portal de administración y actualizar su configuración para que se integre con Azure AD.</span><span class="sxs-lookup"><span data-stu-id="3faa7-140">If you are using Visual Studio 2012 for example, you can still manually register the application in the Azure Management Portal and update its configuration to integrate with Azure AD.</span></span>
   <span data-ttu-id="3faa7-141">En los menús desplegables, seleccione **la nube de una sola organización** y el **Inicio de sesión único, leer datos de directorio**.</span><span class="sxs-lookup"><span data-stu-id="3faa7-141">In the drop-down menus, select **Cloud - Single Organization** and **Single Sign On, Read directory data**.</span></span> <span data-ttu-id="3faa7-142">Escriba el dominio de su Azure AD directorio, por ejemplo (en las imágenes siguientes) *aricka0yahoo.onmicrosoft.com*y, a continuación, haga clic en **Aceptar**.</span><span class="sxs-lookup"><span data-stu-id="3faa7-142">Enter the domain for your Azure AD directory, for example (in the images below) *aricka0yahoo.onmicrosoft.com*, and then click **OK**.</span></span> <span data-ttu-id="3faa7-143">Puede obtener el nombre de dominio en la pestaña dominios del directorio predeterminado en el portal de Azure (consulte la imagen siguiente).</span><span class="sxs-lookup"><span data-stu-id="3faa7-143">You can get the domain name from the Domains tab for the Default Directory on the azure portal (see the next image down).</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image7.png)

   <span data-ttu-id="3faa7-144">En la imagen siguiente se muestra el nombre de dominio del Azure Portal.</span><span class="sxs-lookup"><span data-stu-id="3faa7-144">The following image shows the domain name from the Azure portal.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image8.png)

    > [!NOTE]
    > <span data-ttu-id="3faa7-145">Opcionalmente, puede configurar el URI del ID. de aplicación que se registrará en Azure AD haciendo clic en **más opciones**.</span><span class="sxs-lookup"><span data-stu-id="3faa7-145">You can optionally configure the Application ID URI that will be registered in Azure AD by clicking **More Options**.</span></span> <span data-ttu-id="3faa7-146">El URI de ID. de aplicación es el identificador único de una aplicación, que se registra en Azure AD y lo usa la aplicación para identificarse al comunicarse con Azure AD.</span><span class="sxs-lookup"><span data-stu-id="3faa7-146">The App ID URI is the unique identifier for an application, which is registered in Azure AD and used by the application to identify itself when communicating with Azure AD.</span></span> <span data-ttu-id="3faa7-147">Para obtener más información sobre el URI de ID. de aplicación y otras propiedades de aplicaciones registradas, consulte [este tema](https://msdn.microsoft.com/library/azure/dn499820.aspx#BKMK_Registering).</span><span class="sxs-lookup"><span data-stu-id="3faa7-147">For more information about the App ID URI and other properties of registered applications, see [this topic](https://msdn.microsoft.com/library/azure/dn499820.aspx#BKMK_Registering).</span></span> <span data-ttu-id="3faa7-148">Al hacer clic en la casilla situada debajo del campo URI de ID. de aplicación, también puede optar por sobrescribir un registro existente en Azure AD que usa el mismo URI de ID. de aplicación.</span><span class="sxs-lookup"><span data-stu-id="3faa7-148">By clicking the checkbox below the App ID URI field, you can also choose to overwrite an existing registration in Azure AD that uses the same App ID URI.</span></span>
4. <span data-ttu-id="3faa7-149">Después de hacer clic en **Aceptar**, aparecerá un cuadro de diálogo de inicio de sesión que tendrá que iniciar sesión con una cuenta de administrador global (no la cuenta de Microsoft asociada a su suscripción).</span><span class="sxs-lookup"><span data-stu-id="3faa7-149">After clicking **OK**, a sign-in dialog will appear, and you'll need to sign in using a Global Administrator account (not the Microsoft account associated with your subscription).</span></span> <span data-ttu-id="3faa7-150">Si ha creado una cuenta de administrador anterior, deberá cambiar la contraseña y, a continuación, volver a iniciar sesión con la nueva contraseña.</span><span class="sxs-lookup"><span data-stu-id="3faa7-150">If you created a new Administrator account earlier, you'll be required to change the password and then sign in again using the new password.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image9.png)
5. <span data-ttu-id="3faa7-151">Una vez que se haya autenticado correctamente, el cuadro de diálogo **nuevo proyecto de ASP.net** mostrará la opción de autenticación (**organización** ) y el directorio donde se registrará la nueva aplicación (*aricka0yahoo.onmicrosoft.com* en la siguiente imagen).</span><span class="sxs-lookup"><span data-stu-id="3faa7-151">After you've successfully authenticated, the **New ASP.NET Project** dialog will show your authentication choice (**Organizational** ) and the directory where the new application will be registered (*aricka0yahoo.onmicrosoft.com* in the image below).</span></span> <span data-ttu-id="3faa7-152">Debajo de esta información, active la casilla **host en la nube**.</span><span class="sxs-lookup"><span data-stu-id="3faa7-152">Below this information, select the checkbox labeled **Host in the cloud**.</span></span> <span data-ttu-id="3faa7-153">Si esta casilla está activada, el proyecto se aprovisionará como una aplicación Web de Azure y se habilitará para facilitar su publicación más adelante.</span><span class="sxs-lookup"><span data-stu-id="3faa7-153">If this checkbox is selected, the project will be provisioned as an Azure web app and will be enabled for easy publishing later.</span></span> <span data-ttu-id="3faa7-154">Haga clic en **Aceptar**.</span><span class="sxs-lookup"><span data-stu-id="3faa7-154">Click **OK**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image10.png)
6. <span data-ttu-id="3faa7-155">Aparecerá el cuadro de diálogo **configurar sitio web de Azure** con una región y un nombre de sitio generados automáticamente.</span><span class="sxs-lookup"><span data-stu-id="3faa7-155">The **Configure Azure Website** dialog will appear, using an auto-generated site name and region.</span></span> <span data-ttu-id="3faa7-156">Tenga en cuenta también la cuenta en la que ha iniciado sesión actualmente en el cuadro de diálogo.</span><span class="sxs-lookup"><span data-stu-id="3faa7-156">Also note the account you're currently signed into in the dialog.</span></span> <span data-ttu-id="3faa7-157">Desea asegurarse de que esta cuenta es la a la que está asociada la suscripción de Azure, normalmente una cuenta de Microsoft.</span><span class="sxs-lookup"><span data-stu-id="3faa7-157">You want to make sure that this account is the one that your Azure subscription is attached to, typically a Microsoft account.</span></span>

    > [!NOTE]
    > <span data-ttu-id="3faa7-158">Este proyecto requiere una base de datos.</span><span class="sxs-lookup"><span data-stu-id="3faa7-158">This project requires a database.</span></span> <span data-ttu-id="3faa7-159">Debe seleccionar una de las bases de datos existentes o crear una nueva.</span><span class="sxs-lookup"><span data-stu-id="3faa7-159">You need to select one of your existing databases, or create a new one.</span></span> <span data-ttu-id="3faa7-160">Se necesita una base de datos porque el proyecto ya usa un archivo de base de datos local para almacenar una pequeña cantidad de datos de configuración de autenticación.</span><span class="sxs-lookup"><span data-stu-id="3faa7-160">A database is required because the project already uses a local database file to store a small amount of authentication configuration data.</span></span> <span data-ttu-id="3faa7-161">Al implementar la aplicación en un sitio web de Azure, esta base de datos no está empaquetada con la implementación, por lo que debe elegir una que sea accesible en la nube.</span><span class="sxs-lookup"><span data-stu-id="3faa7-161">When you deploy the application to an Azure Website, this database isn't packaged with the deployment, so you need to choose one that's accessible in the cloud.</span></span> <span data-ttu-id="3faa7-162">Haga clic en **Aceptar**.</span><span class="sxs-lookup"><span data-stu-id="3faa7-162">Click **OK**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image11.png)
7. <span data-ttu-id="3faa7-163">Se creará el proyecto y las opciones de autenticación y las opciones de la aplicación web se configurarán automáticamente con el proyecto.</span><span class="sxs-lookup"><span data-stu-id="3faa7-163">The project will be created, and your authentication options and web app options will be automatically configured with the project.</span></span> <span data-ttu-id="3faa7-164">Una vez completado este proceso, ejecute el proyecto de forma local presionando **^ F5**.</span><span class="sxs-lookup"><span data-stu-id="3faa7-164">Once this process has completed, run the project locally by pressing **^F5**.</span></span> <span data-ttu-id="3faa7-165">Se le pedirá que inicie sesión con su cuenta de organización.</span><span class="sxs-lookup"><span data-stu-id="3faa7-165">You will be required to sign in using your organizational account.</span></span> <span data-ttu-id="3faa7-166">Proporcione el nombre de usuario y la contraseña de la cuenta que creó anteriormente y haga clic en **iniciar sesión**.</span><span class="sxs-lookup"><span data-stu-id="3faa7-166">Provide the username and password for the account you created earlier and click **Sign in**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image12.png)
8. <span data-ttu-id="3faa7-167">Después de iniciar sesión correctamente, el sitio de ASP.NET mostrará que se ha autenticado mostrando el nombre de usuario en la esquina superior derecha de la página.</span><span class="sxs-lookup"><span data-stu-id="3faa7-167">After successful sign in, the ASP.NET site will show that you've authenticated by displaying the username in the top right corner of the page.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image13.png)

   <span data-ttu-id="3faa7-168">Si obtiene el error: el valor no puede ser null ni estar vacío.</span><span class="sxs-lookup"><span data-stu-id="3faa7-168">If you get the error: Value cannot be null or empty.</span></span> <span data-ttu-id="3faa7-169">Nombre del parámetro: linkText ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image14.png)</span><span class="sxs-lookup"><span data-stu-id="3faa7-169">Parameter name: linkText ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image14.png)</span></span>

   <span data-ttu-id="3faa7-170">Vea la sección [depurar](#dbg) al final del tutorial.</span><span class="sxs-lookup"><span data-stu-id="3faa7-170">see the [debug](#dbg) section at the end of the tutorial.</span></span>

## <a name="basics-of-the-graph-api"></a><span data-ttu-id="3faa7-171">Aspectos básicos del Graph API</span><span class="sxs-lookup"><span data-stu-id="3faa7-171">Basics of the Graph API</span></span>

<span data-ttu-id="3faa7-172">[El Graph API](https://msdn.microsoft.com/library/azure/hh974476.aspx) es la interfaz de programación que se usa para realizar las operaciones CRUD y otras en los objetos del directorio Azure ad.</span><span class="sxs-lookup"><span data-stu-id="3faa7-172">[The Graph API](https://msdn.microsoft.com/library/azure/hh974476.aspx) is the programmatic interface used to perform CRUD and other operations on objects in your Azure AD directory.</span></span> <span data-ttu-id="3faa7-173">Si selecciona una opción de cuenta de la organización para la autenticación al crear un nuevo proyecto en Visual Studio 2013, la aplicación ya estará configurada para llamar a la Graph API.</span><span class="sxs-lookup"><span data-stu-id="3faa7-173">If you select an Organizational Account option for authentication when creating a new project in Visual Studio 2013, your application will already be configured to call the Graph API.</span></span> <span data-ttu-id="3faa7-174">En esta sección se muestra brevemente cómo funciona el Graph API.</span><span class="sxs-lookup"><span data-stu-id="3faa7-174">This section briefly shows you how the Graph API works.</span></span>

1. <span data-ttu-id="3faa7-175">En la aplicación en ejecución, haga clic en el nombre del usuario con sesión iniciada en la parte superior derecha de la página.</span><span class="sxs-lookup"><span data-stu-id="3faa7-175">In your running application, click on the name of the signed-in user at the top right of the page.</span></span> <span data-ttu-id="3faa7-176">Esto le llevará a la página de Perfil de usuario, que es una acción en el controlador Home.</span><span class="sxs-lookup"><span data-stu-id="3faa7-176">This will take you to the User Profile page, which is an action on the Home Controller.</span></span> <span data-ttu-id="3faa7-177">Observará que la tabla contiene información de usuario acerca de la cuenta de administrador que creó anteriormente.</span><span class="sxs-lookup"><span data-stu-id="3faa7-177">You'll notice that the table contains user information about the administrator account you created earlier.</span></span> <span data-ttu-id="3faa7-178">Esta información se almacena en el directorio y se llama al Graph API para recuperar esta información cuando se carga la página.</span><span class="sxs-lookup"><span data-stu-id="3faa7-178">This information is stored in your directory, and the Graph API is called to retrieve this information when the page loads.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image15.png)
2. <span data-ttu-id="3faa7-179">Vuelva a Visual Studio y expanda la carpeta **Controllers** y, a continuación, abra el archivo **HomeController.CS** .</span><span class="sxs-lookup"><span data-stu-id="3faa7-179">Go back to Visual Studio and expand the **Controllers** folder and then open the **HomeController.cs** file.</span></span> <span data-ttu-id="3faa7-180">Verá una acción **userprofile ()** que contiene el código para recuperar un token y, a continuación, llamar a la Graph API.</span><span class="sxs-lookup"><span data-stu-id="3faa7-180">You'll see a **UserProfile()** action that contains code to retrieve a token and then call the Graph API.</span></span> <span data-ttu-id="3faa7-181">Este código se duplica a continuación:</span><span class="sxs-lookup"><span data-stu-id="3faa7-181">This code is duplicated below:</span></span>

    [!code-csharp[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample1.cs?highlight=22)]

    <span data-ttu-id="3faa7-182">Para llamar al Graph API, primero debe recuperar un token.</span><span class="sxs-lookup"><span data-stu-id="3faa7-182">To call the Graph API, you first need to retrieve a token.</span></span> <span data-ttu-id="3faa7-183">Cuando se recupera el token, su valor de cadena debe anexarse en el encabezado de autorización para todas las solicitudes posteriores a la Graph API.</span><span class="sxs-lookup"><span data-stu-id="3faa7-183">When the token is retrieved, its string value must be appended in the Authorization header for all subsequent requests to the Graph API.</span></span> <span data-ttu-id="3faa7-184">La mayoría del código anterior controla los detalles de la autenticación en Azure AD para obtener un token, el uso del token para realizar una llamada al Graph API y, a continuación, la transformación de la respuesta para que se pueda presentar en la vista.</span><span class="sxs-lookup"><span data-stu-id="3faa7-184">Most of the code above handles the details of authenticating to Azure AD to get a token, using the token to make a call to the Graph API, and then transforming the response so that it can be presented in the View.</span></span>

    <span data-ttu-id="3faa7-185">La parte más relevante de la discusión es la siguiente línea resaltada: `UserProfile profile = JsonConvert.DeserializeObject<UserProfile>(responseString);`.</span><span class="sxs-lookup"><span data-stu-id="3faa7-185">The most relevant portion for discussion is the following highlighted line: `UserProfile profile = JsonConvert.DeserializeObject<UserProfile>(responseString);`.</span></span> <span data-ttu-id="3faa7-186">Esta línea representa el nombre del usuario, que se ha deserializado de la respuesta JSON y se presenta en la vista.</span><span class="sxs-lookup"><span data-stu-id="3faa7-186">This line represents the name of the user, which has been deserialized from the JSON response and is presented in the View.</span></span>

    <span data-ttu-id="3faa7-187">Puede llamar al Graph API mediante HttpClient y administrar los datos sin procesar usted mismo, pero una forma más sencilla es usar la [biblioteca de cliente de gráficos que está disponible a través de NuGet](http://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/).</span><span class="sxs-lookup"><span data-stu-id="3faa7-187">You can call the Graph API using HttpClient and handle the raw data yourself, but an easier way is to use the [Graph Client Library which is available via NuGet](http://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/).</span></span> <span data-ttu-id="3faa7-188">La biblioteca de cliente controla las solicitudes HTTP sin formato y la transformación de los datos devueltos, y facilita el trabajo con el Graph API en un entorno de .NET.</span><span class="sxs-lookup"><span data-stu-id="3faa7-188">The Client Library handles the raw HTTP requests and the transformation of the returned data for you, and makes it much easier to work with the Graph API in a .NET environment.</span></span> <span data-ttu-id="3faa7-189">Vea los ejemplos de código Graph API relacionados en [github.](https://github.com/AzureADSamples)</span><span class="sxs-lookup"><span data-stu-id="3faa7-189">See the related Graph API code samples on [GitHub.](https://github.com/AzureADSamples)</span></span>

## <a name="deploy-the-application-to-azure"></a><span data-ttu-id="3faa7-190">Implementación de la aplicación en Azure</span><span class="sxs-lookup"><span data-stu-id="3faa7-190">Deploy the Application to Azure</span></span>

<span data-ttu-id="3faa7-191">En los pasos siguientes se muestra cómo implementar la aplicación en Azure.</span><span class="sxs-lookup"><span data-stu-id="3faa7-191">The following steps will show you how to deploy the application to Azure.</span></span> <span data-ttu-id="3faa7-192">En los pasos anteriores, conectó el nuevo proyecto con una aplicación web en Azure, por lo que está listo para publicarse en unos pocos pasos.</span><span class="sxs-lookup"><span data-stu-id="3faa7-192">In the earlier steps, you connected your new project with a web app on Azure, so it's ready to be published in just a few steps.</span></span>

1. <span data-ttu-id="3faa7-193">En Visual Studio, haga clic con el botón derecho en el proyecto y seleccione **publicar**.</span><span class="sxs-lookup"><span data-stu-id="3faa7-193">In Visual Studio, right-click on the project and select **Publish**.</span></span> <span data-ttu-id="3faa7-194">Aparecerá el cuadro de diálogo **publicar web** con cada configuración ya configurada.</span><span class="sxs-lookup"><span data-stu-id="3faa7-194">The **Publish Web** dialog will appear with each setting already configured.</span></span> <span data-ttu-id="3faa7-195">Haga clic en el botón **siguiente** para ir a la página **configuración** .</span><span class="sxs-lookup"><span data-stu-id="3faa7-195">Click on the **Next** button to go to the **Settings** page.</span></span> <span data-ttu-id="3faa7-196">Es posible que se le pida que se autentique; Asegúrese de autenticarse con su cuenta de suscripción de Azure (normalmente una cuenta de Microsoft) y no la cuenta de la organización que creó anteriormente.</span><span class="sxs-lookup"><span data-stu-id="3faa7-196">You may be prompted to authenticate; make sure you authenticate using your Azure subscription account (typically a Microsoft account) and not the organizational account you created earlier.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image16.png)
2. <span data-ttu-id="3faa7-197">Active la opción **Habilitar autenticación organizativa** .</span><span class="sxs-lookup"><span data-stu-id="3faa7-197">Check the **Enable Organizational Authentication** option.</span></span> <span data-ttu-id="3faa7-198">En el campo **dominio** , escriba el dominio del directorio.</span><span class="sxs-lookup"><span data-stu-id="3faa7-198">In the **Domain** field, enter the domain for your directory.</span></span> <span data-ttu-id="3faa7-199">En el menú desplegable **nivel de acceso** , seleccione **Inicio de sesión único, leer datos de directorio**.</span><span class="sxs-lookup"><span data-stu-id="3faa7-199">From the **Access Level** drop-down, select **Single Sign On, Read directory data**.</span></span> <span data-ttu-id="3faa7-200">Observará que la base de datos anterior que usó ya se ha rellenado en la sección **bases de datos** .</span><span class="sxs-lookup"><span data-stu-id="3faa7-200">You'll notice that the previous database you used is already populated in the **Databases** section.</span></span> <span data-ttu-id="3faa7-201">Haga clic en **Publicar**.</span><span class="sxs-lookup"><span data-stu-id="3faa7-201">Click **Publish**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image17.png)
3. <span data-ttu-id="3faa7-202">Visual Studio comenzará a implementar el sitio web y, a continuación, aparecerá una nueva ventana del explorador.</span><span class="sxs-lookup"><span data-stu-id="3faa7-202">Visual Studio will begin deploying your website, and then a new browser window will appear.</span></span> <span data-ttu-id="3faa7-203">Es posible que se le pida que se autentique de nuevo en el directorio.</span><span class="sxs-lookup"><span data-stu-id="3faa7-203">You may be prompted to authenticate to your directory once again.</span></span> <span data-ttu-id="3faa7-204">Una vez que se haya autenticado, se le redirigirá al sitio web recién publicado en Azure.</span><span class="sxs-lookup"><span data-stu-id="3faa7-204">Once you've authenticated, you'll be redirected to your newly published website on Azure.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image18.png)

<a id="dbg"></a>
## <a name="debugging-the-app"></a><span data-ttu-id="3faa7-205">Depurar la aplicación</span><span class="sxs-lookup"><span data-stu-id="3faa7-205">Debugging the app</span></span>

<span data-ttu-id="3faa7-206">Si recibe el siguiente error: el valor no puede ser null ni estar vacío.</span><span class="sxs-lookup"><span data-stu-id="3faa7-206">If you get the following error: Value cannot be null or empty.</span></span> <span data-ttu-id="3faa7-207">Nombre del parámetro: linkText</span><span class="sxs-lookup"><span data-stu-id="3faa7-207">Parameter name: linkText</span></span>

![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image19.png)

<span data-ttu-id="3faa7-208">Reemplace el código del archivo *Views\Shared\\_LoginPartial. cshtml* con lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="3faa7-208">Replace the code in the *Views\Shared\\_LoginPartial.cshtml* file with the following:</span></span>

[!code-cshtml[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample2.cshtml?highlight=1-8,15-16)]

<span data-ttu-id="3faa7-209">Después de ejecutar la aplicación, si el usuario que ha iniciado sesión muestra "usuario nulo", cierre sesión y vuelva a iniciar sesión con la cuenta de Active Directory que creó anteriormente.</span><span class="sxs-lookup"><span data-stu-id="3faa7-209">After running the app, if the logged in user shows "Null User", sign out, and sign back in with the Active Directory account you created earlier.</span></span>

<span data-ttu-id="3faa7-210">Un tutorial excelente que debe seguir es el análisis detallado de Rick Rainey [: Azure websites y la autenticación de la organización con Azure ad](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/).</span><span class="sxs-lookup"><span data-stu-id="3faa7-210">An excellent tutorial to follow is Rick Rainey's [Deep Dive: Azure Websites and Organizational Authentication using Azure AD](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/).</span></span>

## <a name="more-information"></a><span data-ttu-id="3faa7-211">Más información</span><span class="sxs-lookup"><span data-stu-id="3faa7-211">More Information</span></span>

- [<span data-ttu-id="3faa7-212">Profundización: Azure websites y autenticación de la organización con Azure AD</span><span class="sxs-lookup"><span data-stu-id="3faa7-212">Deep Dive: Azure Websites and Organizational Authentication using Azure AD</span></span>](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/)
- [<span data-ttu-id="3faa7-213">Información general sobre Graph API de Azure AD</span><span class="sxs-lookup"><span data-stu-id="3faa7-213">Azure AD Graph API Overview</span></span>](https://msdn.microsoft.com/library/azure/hh974476.aspx)
- [<span data-ttu-id="3faa7-214">Escenarios de autenticación en Azure AD</span><span class="sxs-lookup"><span data-stu-id="3faa7-214">Authentication Scenarios in Azure AD</span></span>](https://msdn.microsoft.com/library/azure/dn499820.aspx)
- [<span data-ttu-id="3faa7-215">Azure AD ejemplos de código en GitHub</span><span class="sxs-lookup"><span data-stu-id="3faa7-215">Azure AD Code Samples on GitHub</span></span>](https://github.com/AzureADSamples)
