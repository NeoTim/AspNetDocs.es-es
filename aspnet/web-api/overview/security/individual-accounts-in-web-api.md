---
uid: web-api/overview/security/individual-accounts-in-web-api
title: Proteger una API Web con cuentas individuales e inicio de sesión Local en ASP.NET Web API 2.2 | Microsoft Docs
author: MikeWasson
description: En este tema se muestra cómo proteger una API web mediante OAuth2 para autenticarse en una base de datos de pertenencia. Versiones de software que se usa en el tutorial 201 Studio Visual...
ms.author: riande
ms.date: 10/15/2014
ms.assetid: 92c84846-f0ea-4b5e-94b6-5004874eb060
msc.legacyurl: /web-api/overview/security/individual-accounts-in-web-api
msc.type: authoredcontent
ms.openlocfilehash: 7492c4aa4c2a0a8aeed64c3462bda8fc51f35a6b
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 05/06/2019
ms.locfileid: "65134311"
---
# <a name="secure-a-web-api-with-individual-accounts-and-local-login-in-aspnet-web-api-22"></a><span data-ttu-id="7d3e5-104">Proteger una API Web con cuentas individuales e inicio de sesión Local en ASP.NET Web API 2.2</span><span class="sxs-lookup"><span data-stu-id="7d3e5-104">Secure a Web API with Individual Accounts and Local Login in ASP.NET Web API 2.2</span></span>

<span data-ttu-id="7d3e5-105">por [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="7d3e5-105">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

[<span data-ttu-id="7d3e5-106">Descargue la aplicación de ejemplo</span><span class="sxs-lookup"><span data-stu-id="7d3e5-106">Download Sample App</span></span>](https://github.com/MikeWasson/LocalAccountsApp)

> <span data-ttu-id="7d3e5-107">En este tema se muestra cómo proteger una API web mediante OAuth2 para autenticarse en una base de datos de pertenencia.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-107">This topic shows how to secure a web API using OAuth2 to authenticate against a membership database.</span></span>
> 
> ## <a name="software-versions-used-in-the-tutorial"></a><span data-ttu-id="7d3e5-108">Versiones de software que se usa en el tutorial</span><span class="sxs-lookup"><span data-stu-id="7d3e5-108">Software versions used in the tutorial</span></span>
> 
> 
> - [<span data-ttu-id="7d3e5-109">Visual Studio 2013 Update 3</span><span class="sxs-lookup"><span data-stu-id="7d3e5-109">Visual Studio 2013 Update 3</span></span>](https://www.microsoft.com/visualstudio/eng/2013-downloads)
> - [<span data-ttu-id="7d3e5-110">Web API 2.2</span><span class="sxs-lookup"><span data-stu-id="7d3e5-110">Web API 2.2</span></span>](../releases/whats-new-in-aspnet-web-api-22.md)
> - [<span data-ttu-id="7d3e5-111">ASP.NET Identity 2.1</span><span class="sxs-lookup"><span data-stu-id="7d3e5-111">ASP.NET Identity 2.1</span></span>](../../../identity/index.md)

<span data-ttu-id="7d3e5-112">En Visual Studio 2013, la plantilla de proyecto Web API ofrece tres opciones para la autenticación:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-112">In Visual Studio 2013, the Web API project template gives you three options for authentication:</span></span>

- <span data-ttu-id="7d3e5-113">**Cuentas individuales.**</span><span class="sxs-lookup"><span data-stu-id="7d3e5-113">**Individual accounts.**</span></span> <span data-ttu-id="7d3e5-114">La aplicación usa una base de datos de pertenencia.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-114">The app uses a membership database.</span></span>
- <span data-ttu-id="7d3e5-115">**Cuentas organizativas.**</span><span class="sxs-lookup"><span data-stu-id="7d3e5-115">**Organizational accounts.**</span></span> <span data-ttu-id="7d3e5-116">Los usuarios iniciar sesión con su Azure Active Directory, Office 365 o credenciales de Active Directory local.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-116">Users sign in with their Azure Active Directory, Office 365, or on-premise Active Directory credentials.</span></span>
- <span data-ttu-id="7d3e5-117">**Autenticación de Windows.**</span><span class="sxs-lookup"><span data-stu-id="7d3e5-117">**Windows authentication.**</span></span> <span data-ttu-id="7d3e5-118">Esta opción está diseñada para aplicaciones de Intranet y usa el módulo de IIS de la autenticación de Windows.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-118">This option is intended for Intranet applications, and uses the Windows Authentication IIS module.</span></span>

<span data-ttu-id="7d3e5-119">Para obtener más información acerca de estas opciones, consulte [Creating ASP.NET Web Projects in Visual Studio 2013](../../../visual-studio/overview/2013/creating-web-projects-in-visual-studio.md#auth).</span><span class="sxs-lookup"><span data-stu-id="7d3e5-119">For more details about these options, see [Creating ASP.NET Web Projects in Visual Studio 2013](../../../visual-studio/overview/2013/creating-web-projects-in-visual-studio.md#auth).</span></span>

<span data-ttu-id="7d3e5-120">Las cuentas individuales proporcionan dos formas para que un usuario inicie sesión:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-120">Individual accounts provide two ways for a user to log in:</span></span>

- <span data-ttu-id="7d3e5-121">**Inicio de sesión local**.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-121">**Local login**.</span></span> <span data-ttu-id="7d3e5-122">El usuario se registra en el sitio, escriba un nombre de usuario y una contraseña.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-122">The user registers at the site, entering a username and password.</span></span> <span data-ttu-id="7d3e5-123">La aplicación almacena el hash de contraseña en la base de datos de pertenencia.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-123">The app stores the password hash in the membership database.</span></span> <span data-ttu-id="7d3e5-124">Cuando el usuario inicia sesión, el sistema ASP.NET Identity comprueba la contraseña.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-124">When the user logs in, the ASP.NET Identity system verifies the password.</span></span>
- <span data-ttu-id="7d3e5-125">**Inicio de sesión social**.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-125">**Social login**.</span></span> <span data-ttu-id="7d3e5-126">El usuario inicia sesión con un servicio externo, como Facebook, Microsoft o Google.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-126">The user signs in with an external service, such as Facebook, Microsoft, or Google.</span></span> <span data-ttu-id="7d3e5-127">La aplicación crea una entrada para el usuario en la base de datos de pertenencia todavía, pero no almacena las credenciales.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-127">The app still creates an entry for the user in the membership database, but does not store any credentials.</span></span> <span data-ttu-id="7d3e5-128">El usuario se autentica, inicie sesión en el servicio externo.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-128">The user authenticates by signing into the external service.</span></span>

<span data-ttu-id="7d3e5-129">Este artículo examina el escenario de inicio de sesión local.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-129">This article looks at the local login scenario.</span></span> <span data-ttu-id="7d3e5-130">Inicio de sesión local y redes sociales, Web API usa OAuth2 para autenticar las solicitudes.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-130">For both local and social login, Web API uses OAuth2 to authenticate requests.</span></span> <span data-ttu-id="7d3e5-131">Sin embargo, los flujos de credenciales son diferentes para el inicio de sesión local y redes sociales.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-131">However, the credential flows are different for local and social login.</span></span>

<span data-ttu-id="7d3e5-132">En este artículo, mostraré una aplicación sencilla que permite al usuario iniciar sesión y enviar las llamadas AJAX autenticadas a una API web.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-132">In this article, I'll demonstrate a simple app that lets the user log in and send authenticated AJAX calls to a web API.</span></span> <span data-ttu-id="7d3e5-133">Puede descargar el código de ejemplo [aquí](https://github.com/MikeWasson/LocalAccountsApp).</span><span class="sxs-lookup"><span data-stu-id="7d3e5-133">You can download the sample code [here](https://github.com/MikeWasson/LocalAccountsApp).</span></span> <span data-ttu-id="7d3e5-134">El archivo Léame describe cómo crear el ejemplo desde cero en Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-134">The readme describes how to create the sample from scratch in Visual Studio.</span></span>

[![](individual-accounts-in-web-api/_static/image2.png)](individual-accounts-in-web-api/_static/image1.png)

<span data-ttu-id="7d3e5-135">La aplicación de ejemplo usa Knockout.js para enlace de datos y jQuery para enviar las solicitudes AJAX.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-135">The sample app uses Knockout.js for data-binding and jQuery for sending AJAX requests.</span></span> <span data-ttu-id="7d3e5-136">Me centraré en las llamadas AJAX, por lo que no necesita saber Knockout.js para este artículo.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-136">I'll be focusing on the AJAX calls, so you don't need to know Knockout.js for this article.</span></span>

<span data-ttu-id="7d3e5-137">En el camino, describiré:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-137">Along the way, I'll describe:</span></span>

- <span data-ttu-id="7d3e5-138">¿Qué está haciendo la aplicación en el lado cliente.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-138">What the app is doing on the client side.</span></span>
- <span data-ttu-id="7d3e5-139">Lo que sucede en el servidor.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-139">What's happening on the server.</span></span>
- <span data-ttu-id="7d3e5-140">El tráfico HTTP en el medio.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-140">The HTTP traffic in the middle.</span></span>

<span data-ttu-id="7d3e5-141">En primer lugar, necesitamos definir cierta terminología de OAuth2.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-141">First, we need to define some OAuth2 terminology.</span></span>

- <span data-ttu-id="7d3e5-142">*Recurso*.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-142">*Resource*.</span></span> <span data-ttu-id="7d3e5-143">Parte de los datos que se pueden proteger.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-143">Some piece of data that can be protected.</span></span>
- <span data-ttu-id="7d3e5-144">*Servidor de recursos*.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-144">*Resource server*.</span></span> <span data-ttu-id="7d3e5-145">El servidor que hospeda el recurso.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-145">The server that hosts the resource.</span></span>
- <span data-ttu-id="7d3e5-146">*Propietario del recurso*.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-146">*Resource owner*.</span></span> <span data-ttu-id="7d3e5-147">La entidad que puede conceder permiso para acceder a un recurso.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-147">The entity that can grant permission to access a resource.</span></span> <span data-ttu-id="7d3e5-148">(Normalmente, el usuario.)</span><span class="sxs-lookup"><span data-stu-id="7d3e5-148">(Typically the user.)</span></span>
- <span data-ttu-id="7d3e5-149">*Cliente*: La aplicación que desea tener acceso al recurso.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-149">*Client*: The app that wants access to the resource.</span></span> <span data-ttu-id="7d3e5-150">En este artículo, el cliente es un explorador web.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-150">In this article, the client is a web browser.</span></span>
- <span data-ttu-id="7d3e5-151">*Token de acceso*.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-151">*Access token*.</span></span> <span data-ttu-id="7d3e5-152">Un token que concede acceso a un recurso.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-152">A token that grants access to a resource.</span></span>
- <span data-ttu-id="7d3e5-153">*Token de portador*.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-153">*Bearer token*.</span></span> <span data-ttu-id="7d3e5-154">Un tipo determinado de token de acceso, con la propiedad que cualquier persona puede usar el token.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-154">A particular type of access token, with the property that anyone can use the token.</span></span> <span data-ttu-id="7d3e5-155">En otras palabras, un cliente no necesita una clave criptográfica u otro secreto para usar un token de portador.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-155">In other words, a client doesn't need a cryptographic key or other secret to use a bearer token.</span></span> <span data-ttu-id="7d3e5-156">Por ese motivo, los tokens de portador solo deben usarse a través de un HTTPS y deben tener unos tiempos de expiración relativamente corto.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-156">For that reason, bearer tokens should only be used over a HTTPS, and should have relatively short expiration times.</span></span>
- <span data-ttu-id="7d3e5-157">*Servidor de autorización*.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-157">*Authorization server*.</span></span> <span data-ttu-id="7d3e5-158">Un servidor que proporciona tokens de acceso.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-158">A server that gives out access tokens.</span></span>

<span data-ttu-id="7d3e5-159">Una aplicación puede actuar como servidor de autorización y de servidor de recursos.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-159">An application can act as both authorization server and resource server.</span></span> <span data-ttu-id="7d3e5-160">La plantilla de proyecto Web API sigue este patrón.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-160">The Web API project template follows this pattern.</span></span>

## <a name="local-login-credential-flow"></a><span data-ttu-id="7d3e5-161">Flujo de credenciales de inicio de sesión local</span><span class="sxs-lookup"><span data-stu-id="7d3e5-161">Local Login Credential Flow</span></span>

<span data-ttu-id="7d3e5-162">Inicio de sesión local, API Web usa el [flujo contraseña del propietario del recurso](http://oauthlib.readthedocs.org/en/latest/oauth2/grants/password.html) definidas en OAuth2.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-162">For local login, Web API uses the [resource owner password flow](http://oauthlib.readthedocs.org/en/latest/oauth2/grants/password.html) defined in OAuth2.</span></span>

1. <span data-ttu-id="7d3e5-163">El usuario escribe un nombre y una contraseña en el cliente.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-163">The user enters a name and password into the client.</span></span>
2. <span data-ttu-id="7d3e5-164">El cliente envía estas credenciales al servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-164">The client sends these credentials to the authorization server.</span></span>
3. <span data-ttu-id="7d3e5-165">El servidor de autorización autentica las credenciales y devuelve un token de acceso.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-165">The authorization server authenticates the credentials and returns an access token.</span></span>
4. <span data-ttu-id="7d3e5-166">Para obtener acceso a un recurso protegido, el cliente incluye el token de acceso en el encabezado de autorización de la solicitud HTTP.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-166">To access a protected resource, the client includes the access token in the Authorization header of the HTTP request.</span></span>

![](individual-accounts-in-web-api/_static/image3.png)

<span data-ttu-id="7d3e5-167">Al seleccionar **cuentas individuales** en la plantilla de proyecto Web API, el proyecto incluye un servidor de autorización que valida las credenciales de usuario y emite tokens.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-167">When you select **Individual accounts** in the Web API project template, the project includes an authorization server that validates user credentials and issues tokens.</span></span> <span data-ttu-id="7d3e5-168">El siguiente diagrama muestra el mismo flujo de credenciales en términos de componentes de la API Web.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-168">The following diagram shows the same credential flow in terms of Web API components.</span></span>

![](individual-accounts-in-web-api/_static/image4.png)

<span data-ttu-id="7d3e5-169">En este escenario, los controladores Web API actúan como servidores de recursos.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-169">In this scenario, Web API controllers act as resource servers.</span></span> <span data-ttu-id="7d3e5-170">Un filtro de autenticación valida los tokens de acceso y el **[Authorize]** atributo se utiliza para proteger un recurso.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-170">An authentication filter validates access tokens, and the **[Authorize]** attribute is used to protect a resource.</span></span> <span data-ttu-id="7d3e5-171">Cuando una acción o controlador tiene el **[Authorize]** de atributo, todas las solicitudes a ese controlador o acción que se debe autenticar.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-171">When a controller or action has the **[Authorize]** attribute, all requests to that controller or action must be authenticated.</span></span> <span data-ttu-id="7d3e5-172">En caso contrario, se deniega la autorización y API Web devuelve un error 401 (no autorizado).</span><span class="sxs-lookup"><span data-stu-id="7d3e5-172">Otherwise, authorization is denied, and Web API returns a 401 (Unauthorized) error.</span></span>

<span data-ttu-id="7d3e5-173">El servidor de autorización y el filtro de autenticación ambos llaman a un [OWIN middleware](../../../aspnet/overview/owin-and-katana/an-overview-of-project-katana.md) componente que controla los detalles de OAuth2.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-173">The authorization server and the authentication filter both call into an [OWIN middleware](../../../aspnet/overview/owin-and-katana/an-overview-of-project-katana.md) component that handles the details of OAuth2.</span></span> <span data-ttu-id="7d3e5-174">Describiré el diseño con más detalle más adelante en este tutorial.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-174">I'll describe the design in more detail later in this tutorial.</span></span>

## <a name="sending-an-unauthorized-request"></a><span data-ttu-id="7d3e5-175">Enviar una solicitud no autorizada</span><span class="sxs-lookup"><span data-stu-id="7d3e5-175">Sending an Unauthorized Request</span></span>

<span data-ttu-id="7d3e5-176">Para empezar, ejecute la aplicación y haga clic en el **llamar a API** botón.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-176">To get started, run the app and click the **Call API** button.</span></span> <span data-ttu-id="7d3e5-177">Cuando se completa la solicitud, debería ver un mensaje de error en la **resultado** cuadro.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-177">When the request completes, you should see an error message in the **Result** box.</span></span> <span data-ttu-id="7d3e5-178">Eso es porque la solicitud no contiene un token de acceso, por lo que la solicitud está autorizada.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-178">That's because the request does not contain an access token, so the request is unauthorized.</span></span>

[![](individual-accounts-in-web-api/_static/image6.png)](individual-accounts-in-web-api/_static/image5.png)

<span data-ttu-id="7d3e5-179">El **llamar a API** botón envía una solicitud AJAX ~/api/valores, que invoca una acción de controlador Web API.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-179">The **Call API** button sends an AJAX request to ~/api/values, which invokes a Web API controller action.</span></span> <span data-ttu-id="7d3e5-180">Esta es la sección de código JavaScript que envía la solicitud de AJAX.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-180">Here is the section of JavaScript code that sends the AJAX request.</span></span> <span data-ttu-id="7d3e5-181">En la aplicación de ejemplo, todo el código de aplicación de JavaScript se encuentra en el archivo Scripts\app.js.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-181">In the sample app, all of the JavaScript app code is located in the Scripts\app.js file.</span></span>

[!code-javascript[Main](individual-accounts-in-web-api/samples/sample1.js)]

<span data-ttu-id="7d3e5-182">Hasta que el usuario inicia sesión, no hay ningún token de portador y, por tanto, ningún encabezado de autorización en la solicitud.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-182">Until the user logs in, there is no bearer token, and therefore no Authorization header in the request.</span></span> <span data-ttu-id="7d3e5-183">Esto hace que la solicitud para devolver un error 401.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-183">This causes the request to return a 401 error.</span></span>

<span data-ttu-id="7d3e5-184">Aquí está la solicitud HTTP.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-184">Here is the HTTP request.</span></span> <span data-ttu-id="7d3e5-185">(He usado [Fiddler](http://www.telerik.com/fiddler) para capturar el tráfico HTTP.)</span><span class="sxs-lookup"><span data-stu-id="7d3e5-185">(I used [Fiddler](http://www.telerik.com/fiddler) to capture the HTTP traffic.)</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample2.cmd)]

<span data-ttu-id="7d3e5-186">Respuesta HTTP:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-186">HTTP response:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample3.cmd?highlight=1,4)]

<span data-ttu-id="7d3e5-187">Tenga en cuenta que la respuesta incluye un encabezado Www-Authenticate con el desafío de portador.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-187">Notice that the response includes a Www-Authenticate header with the challenge set to Bearer.</span></span> <span data-ttu-id="7d3e5-188">Valor que indica que el servidor espera que un token de portador.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-188">That indicates the server expects a bearer token.</span></span>

## <a name="register-a-user"></a><span data-ttu-id="7d3e5-189">Registrar un usuario</span><span class="sxs-lookup"><span data-stu-id="7d3e5-189">Register a User</span></span>

<span data-ttu-id="7d3e5-190">En el **registrar** sección de la aplicación, escriba un correo electrónico y contraseña y haga clic en el **registrar** botón.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-190">In the **Register** section of the app, enter an email and password, and click the **Register** button.</span></span>

<span data-ttu-id="7d3e5-191">No es necesario usar una dirección de correo electrónico válida para este ejemplo, pero una aplicación real podría confirmar la dirección.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-191">You don't need to use a valid email address for this sample, but a real app would confirm the address.</span></span> <span data-ttu-id="7d3e5-192">(Consulte [crear una aplicación web de ASP.NET MVC 5 segura con inicio de sesión, restablecimiento de confirmación y la contraseña de correo electrónico](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).) La contraseña, use algo parecido a "Password1!", con una letra mayúscula, letra minúscula, número y los caracteres no alfanuméricos.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-192">(See [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).) For the password, use something like "Password1!", with an upper case letter, lower case letter, number, and non-alpha-numeric character.</span></span> <span data-ttu-id="7d3e5-193">Para simplificar la aplicación, dejé la validación del lado cliente, por lo que si hay un problema con el formato de la contraseña, obtendrá un error 400 (solicitud incorrecta).</span><span class="sxs-lookup"><span data-stu-id="7d3e5-193">To keep the app simple, I left out client-side validation, so if there is a problem with the password format, you'll get a 400 (Bad Request) error.</span></span>

[![](individual-accounts-in-web-api/_static/image8.png)](individual-accounts-in-web-api/_static/image7.png)

<span data-ttu-id="7d3e5-194">El **registrar** botón envía una solicitud POST a ~/api/Account/Register /.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-194">The **Register** button sends a POST request to ~/api/Account/Register/.</span></span> <span data-ttu-id="7d3e5-195">El cuerpo de solicitud es un objeto JSON que contiene el nombre y la contraseña.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-195">The request body is a JSON object that holds the name and password.</span></span> <span data-ttu-id="7d3e5-196">Este es el código de JavaScript que envía la solicitud:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-196">Here is the JavaScript code that sends the request:</span></span>

[!code-javascript[Main](individual-accounts-in-web-api/samples/sample4.js)]

<span data-ttu-id="7d3e5-197">Solicitud HTTP:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-197">HTTP request:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample5.cmd?highlight=5,10)]

<span data-ttu-id="7d3e5-198">Respuesta HTTP:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-198">HTTP response:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample6.cmd)]

<span data-ttu-id="7d3e5-199">Esta solicitud se controla mediante la `AccountController` clase.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-199">This request is handled by the `AccountController` class.</span></span> <span data-ttu-id="7d3e5-200">Internamente, `AccountController` ASP.NET Identity se utiliza para administrar la base de datos de pertenencia.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-200">Internally, `AccountController` uses ASP.NET Identity to manage the membership database.</span></span>

<span data-ttu-id="7d3e5-201">Si ejecuta localmente la aplicación desde Visual Studio, las cuentas de usuario se almacenan en LocalDB, en la tabla AspNetUsers.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-201">If you run the app locally from Visual Studio, user accounts are stored in LocalDB, in the AspNetUsers table.</span></span> <span data-ttu-id="7d3e5-202">Para ver las tablas en Visual Studio, haga clic en el **vista** menú, seleccione **Explorador de servidores**, a continuación, expanda **conexiones de datos**.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-202">To view the tables in Visual Studio, click the **View** menu, select **Server Explorer**, then expand **Data Connections**.</span></span>

![](individual-accounts-in-web-api/_static/image9.png)

## <a name="get-an-access-token"></a><span data-ttu-id="7d3e5-203">Obtener un acceso Token</span><span class="sxs-lookup"><span data-stu-id="7d3e5-203">Get an Access Token</span></span>

<span data-ttu-id="7d3e5-204">Hasta ahora no hemos hecho cualquier OAuth, pero ahora veremos el servidor de autorización de OAuth en acción, cuando se solicite un token de acceso.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-204">So far we have not done any OAuth, but now we'll see the OAuth authorization server in action, when we request an access token.</span></span> <span data-ttu-id="7d3e5-205">En el **sesión** área de la aplicación de ejemplo, escriba el correo electrónico y la contraseña y haga clic en **en el registro**.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-205">In the **Log In** area of the sample app, enter the email and password and click **Log In**.</span></span>

[![](individual-accounts-in-web-api/_static/image11.png)](individual-accounts-in-web-api/_static/image10.png)

<span data-ttu-id="7d3e5-206">El **sesión** botón envía una solicitud al extremo de token.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-206">The **Log In** button sends a request to the token endpoint.</span></span> <span data-ttu-id="7d3e5-207">El cuerpo de la solicitud contiene los datos codificados de dirección url de formulario siguientes:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-207">The body of the request contains the following form-url-encoded data:</span></span>

- <span data-ttu-id="7d3e5-208">conceder\_tipo: "password"</span><span class="sxs-lookup"><span data-stu-id="7d3e5-208">grant\_type: "password"</span></span>
- <span data-ttu-id="7d3e5-209">nombre de usuario: &lt;correo electrónico del usuario&gt;</span><span class="sxs-lookup"><span data-stu-id="7d3e5-209">username: &lt;the user's email&gt;</span></span>
- <span data-ttu-id="7d3e5-210">Contraseña: &lt;contraseña&gt;</span><span class="sxs-lookup"><span data-stu-id="7d3e5-210">password: &lt;password&gt;</span></span>

<span data-ttu-id="7d3e5-211">Este es el código de JavaScript que envía la solicitud de AJAX:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-211">Here is the JavaScript code that sends the AJAX request:</span></span>

[!code-javascript[Main](individual-accounts-in-web-api/samples/sample7.js?highlight=14)]

<span data-ttu-id="7d3e5-212">Si la solicitud se realiza correctamente, el servidor de autorización devuelve un token de acceso en el cuerpo de respuesta.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-212">If the request succeeds, the authorization server returns an access token in the response body.</span></span> <span data-ttu-id="7d3e5-213">Tenga en cuenta que almacenamos el token en el almacenamiento de sesión, para usarla más adelante al enviar solicitudes a la API.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-213">Notice that we store the token in session storage, to use later when sending requests to the API.</span></span> <span data-ttu-id="7d3e5-214">A diferencia de algunas formas de autenticación (como la autenticación basada en cookies), el explorador no incluirá automáticamente el token de acceso en las solicitudes posteriores.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-214">Unlike some forms of authentication (such as cookie-based authentication), the browser will not automatically include the access token in subsequent requests.</span></span> <span data-ttu-id="7d3e5-215">La aplicación deberá hacerlo explícitamente.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-215">The application must do so explicitly.</span></span> <span data-ttu-id="7d3e5-216">Que es algo bueno, porque limita [vulnerabilidades CSRF](preventing-cross-site-request-forgery-csrf-attacks.md).</span><span class="sxs-lookup"><span data-stu-id="7d3e5-216">That's a good thing, because it limits [CSRF vulnerabilities](preventing-cross-site-request-forgery-csrf-attacks.md).</span></span>

<span data-ttu-id="7d3e5-217">Solicitud HTTP:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-217">HTTP request:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample8.cmd?highlight=5,10)]

<span data-ttu-id="7d3e5-218">Puede ver que la solicitud contiene las credenciales del usuario.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-218">You can see that the request contains the user's credentials.</span></span> <span data-ttu-id="7d3e5-219">Le *debe* usar HTTPS para proporcionar seguridad de la capa de transporte.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-219">You *must* use HTTPS to provide transport layer security.</span></span>

<span data-ttu-id="7d3e5-220">Respuesta HTTP:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-220">HTTP response:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample9.cmd?highlight=8)]

<span data-ttu-id="7d3e5-221">Para mejorar la legibilidad, aplica sangría a JSON y se trunca el token de acceso, que es bastante largo.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-221">For readability, I indented the JSON and truncated the access token, which is a quite long.</span></span>

<span data-ttu-id="7d3e5-222">El `access_token`, `token_type`, y `expires_in` propiedades se definen mediante la especificación OAuth2. Las demás propiedades (`userName`, `.issued`, y `.expires`) son solo para fines informativos.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-222">The `access_token`, `token_type`, and `expires_in` properties are defined by the OAuth2 spec. The other properties (`userName`, `.issued`, and `.expires`) are just for informational purposes.</span></span> <span data-ttu-id="7d3e5-223">Puede encontrar el código que agrega las propiedades adicionales en el `TokenEndpoint` método, en el archivo /Providers/ApplicationOAuthProvider.cs.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-223">You can find the code that adds those additional properties in the `TokenEndpoint` method, in the /Providers/ApplicationOAuthProvider.cs file.</span></span>

## <a name="send-an-authenticated-request"></a><span data-ttu-id="7d3e5-224">Enviar una solicitud autenticada</span><span class="sxs-lookup"><span data-stu-id="7d3e5-224">Send an Authenticated Request</span></span>

<span data-ttu-id="7d3e5-225">Ahora que tenemos un token de portador, nos podemos realizar una solicitud autenticada a la API.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-225">Now that we have a bearer token, we can make an authenticated request to the API.</span></span> <span data-ttu-id="7d3e5-226">Esto se hace estableciendo el encabezado de autorización en la solicitud.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-226">This is done by setting the Authorization header in the request.</span></span> <span data-ttu-id="7d3e5-227">Haga clic en el **llamar a API** botón nuevo para verlo.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-227">Click the **Call API** button again to see this.</span></span>

[![](individual-accounts-in-web-api/_static/image13.png)](individual-accounts-in-web-api/_static/image12.png)

<span data-ttu-id="7d3e5-228">Solicitud HTTP:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-228">HTTP request:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample10.cmd?highlight=5)]

<span data-ttu-id="7d3e5-229">Respuesta HTTP:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-229">HTTP response:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample11.cmd)]

## <a name="log-out"></a><span data-ttu-id="7d3e5-230">Cerrar sesión</span><span class="sxs-lookup"><span data-stu-id="7d3e5-230">Log Out</span></span>

<span data-ttu-id="7d3e5-231">Dado que el explorador no almacena en caché las credenciales o el token de acceso, el cierre de sesión es simplemente una cuestión de "olvidar" el token, quitándolo de almacenamiento de la sesión:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-231">Because the browser does not cache the credentials or the access token, logging out is simply a matter of "forgetting" the token, by removing it from session storage:</span></span>

[!code-javascript[Main](individual-accounts-in-web-api/samples/sample12.js)]

## <a name="understanding-the-individual-accounts-project-template"></a><span data-ttu-id="7d3e5-232">Descripción de la plantilla de proyecto cuentas individuales</span><span class="sxs-lookup"><span data-stu-id="7d3e5-232">Understanding the Individual Accounts Project Template</span></span>

<span data-ttu-id="7d3e5-233">Al seleccionar **cuentas individuales** en la plantilla de proyecto aplicación Web ASP.NET, el proyecto incluye:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-233">When you select **Individual Accounts** in the ASP.NET Web Application project template, the project includes:</span></span>

- <span data-ttu-id="7d3e5-234">Un servidor de autorización de OAuth2.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-234">An OAuth2 authorization server.</span></span>
- <span data-ttu-id="7d3e5-235">Un punto de conexión de API Web para administrar las cuentas de usuario</span><span class="sxs-lookup"><span data-stu-id="7d3e5-235">A Web API endpoint for managing user accounts</span></span>
- <span data-ttu-id="7d3e5-236">Un modelo de EF para almacenar las cuentas de usuario.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-236">An EF model for storing user accounts.</span></span>

<span data-ttu-id="7d3e5-237">Estas son las clases de aplicación principal que implementan estas características:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-237">Here are the main application classes that implement these features:</span></span>

- <span data-ttu-id="7d3e5-238">`AccountController`.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-238">`AccountController`.</span></span> <span data-ttu-id="7d3e5-239">Proporciona un punto de conexión de API Web para administrar las cuentas de usuario.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-239">Provides a Web API endpoint for managing user accounts.</span></span> <span data-ttu-id="7d3e5-240">El `Register` acción es la única que hemos usado en este tutorial.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-240">The `Register` action is the only one that we used in this tutorial.</span></span> <span data-ttu-id="7d3e5-241">Otros métodos en la clase admiten el restablecimiento de contraseña, inicios de sesión sociales y otras funciones.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-241">Other methods on the class support password reset, social logins, and other functionality.</span></span>
- <span data-ttu-id="7d3e5-242">`ApplicationUser`, definido en /Models/IdentityModels.cs.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-242">`ApplicationUser`, defined in /Models/IdentityModels.cs.</span></span> <span data-ttu-id="7d3e5-243">Esta clase es el modelo EF para cuentas de usuario de la base de datos de pertenencia.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-243">This class is the EF model for user accounts in the membership database.</span></span>
- <span data-ttu-id="7d3e5-244">`ApplicationUserManager`, definido en /App\_Start/IdentityConfig.cs esta clase se deriva de [UserManager](https://msdn.microsoft.com/library/dn613290.aspx) y realiza operaciones en cuentas de usuario, como la creación de un nuevo usuario, comprobar las contraseñas y así sucesivamente y conserva automáticamente cambios en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-244">`ApplicationUserManager`, defined in /App\_Start/IdentityConfig.cs This class derives from [UserManager](https://msdn.microsoft.com/library/dn613290.aspx) and performs operations on user accounts, such as creating a new user, verifying passwords, and so forth, and automatically persists changes to the database.</span></span>
- <span data-ttu-id="7d3e5-245">`ApplicationOAuthProvider`.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-245">`ApplicationOAuthProvider`.</span></span> <span data-ttu-id="7d3e5-246">Este objeto se inserta en el middleware de OWIN y procesa los eventos generados por el middleware.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-246">This object plugs into the OWIN middleware, and processes events raised by the middleware.</span></span> <span data-ttu-id="7d3e5-247">Se deriva de [OAuthAuthorizationServerProvider](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserverprovider.aspx).</span><span class="sxs-lookup"><span data-stu-id="7d3e5-247">It derives from [OAuthAuthorizationServerProvider](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserverprovider.aspx).</span></span>

![](individual-accounts-in-web-api/_static/image14.png)

### <a name="configuring-the-authorization-server"></a><span data-ttu-id="7d3e5-248">Configuración del servidor de autorización</span><span class="sxs-lookup"><span data-stu-id="7d3e5-248">Configuring the Authorization Server</span></span>

<span data-ttu-id="7d3e5-249">En StartupAuth.cs, el código siguiente configura el servidor de autorización de OAuth2.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-249">In StartupAuth.cs, the following code configures the OAuth2 authorization server.</span></span>

[!code-csharp[Main](individual-accounts-in-web-api/samples/sample13.cs)]

<span data-ttu-id="7d3e5-250">El `TokenEndpointPath` propiedad es la ruta de acceso de dirección URL para el punto de conexión del servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-250">The `TokenEndpointPath` property is the URL path to the authorization server endpoint.</span></span> <span data-ttu-id="7d3e5-251">Que es la dirección URL que la aplicación se usa para obtener los tokens de portador.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-251">That's the URL that app uses to get the bearer tokens.</span></span>

<span data-ttu-id="7d3e5-252">El `Provider` propiedad especifica un proveedor que se conecta al middleware de OWIN y procesa los eventos generados por el middleware.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-252">The `Provider` property specifies a provider that plugs into the OWIN middleware, and processes events raised by the middleware.</span></span>

<span data-ttu-id="7d3e5-253">Este es el flujo básico cuando la aplicación desea obtener un token:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-253">Here is the basic flow when the app wants to get a token:</span></span>

1. <span data-ttu-id="7d3e5-254">Para obtener un token de acceso, la aplicación envía una solicitud a ~ / Token.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-254">To get an access token, the app sends a request to ~/Token.</span></span>
2. <span data-ttu-id="7d3e5-255">Las llamadas de middleware OAuth `GrantResourceOwnerCredentials` en el proveedor.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-255">The OAuth middleware calls `GrantResourceOwnerCredentials` on the provider.</span></span>
3. <span data-ttu-id="7d3e5-256">El proveedor llame a la `ApplicationUserManager` para validar las credenciales y crear una identidad de notificaciones.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-256">The provider calls the `ApplicationUserManager` to validate the credentials and create a claims identity.</span></span>
4. <span data-ttu-id="7d3e5-257">Si se realiza correctamente, el proveedor crea un vale de autenticación, que se usa para generar el token.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-257">If that succeeds, the provider creates an authentication ticket, which is used to generate the token.</span></span>

[![](individual-accounts-in-web-api/_static/image16.png)](individual-accounts-in-web-api/_static/image15.png)

<span data-ttu-id="7d3e5-258">El middleware de OAuth no sabe nada acerca de las cuentas de usuario.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-258">The OAuth middleware doesn't know anything about the user accounts.</span></span> <span data-ttu-id="7d3e5-259">El proveedor se comunica entre el software intermedio y la identidad de ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-259">The provider communicates between the middleware and ASP.NET Identity.</span></span> <span data-ttu-id="7d3e5-260">Para obtener más información acerca de cómo implementar el servidor de autorización, consulte [servidor de autorización OAuth 2.0 de OWIN](../../../aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server.md).</span><span class="sxs-lookup"><span data-stu-id="7d3e5-260">For more information about implementing the authorization server, see [OWIN OAuth 2.0 Authorization Server](../../../aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server.md).</span></span>

### <a name="configuring-web-api-to-use-bearer-tokens"></a><span data-ttu-id="7d3e5-261">Configuración de Web API para usar los Tokens de portador</span><span class="sxs-lookup"><span data-stu-id="7d3e5-261">Configuring Web API to use Bearer Tokens</span></span>

<span data-ttu-id="7d3e5-262">En el `WebApiConfig.Register` método, el código siguiente establece la autenticación de la canalización de Web API:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-262">In the `WebApiConfig.Register` method, the following code sets up authentication for the Web API pipeline:</span></span>

[!code-csharp[Main](individual-accounts-in-web-api/samples/sample14.cs)]

<span data-ttu-id="7d3e5-263">El **HostAuthenticationFilter** clase habilita la autenticación con tokens de portador.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-263">The **HostAuthenticationFilter** class enables authentication using bearer tokens.</span></span>

<span data-ttu-id="7d3e5-264">El **SuppressDefaultHostAuthentication** método indica a API Web ignorar toda autenticación que se produce antes de la solicitud llega a la canalización de API Web, IIS o middleware de OWIN.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-264">The **SuppressDefaultHostAuthentication** method tells Web API to ignore any authentication that happens before the request reaches the Web API pipeline, either by IIS or by OWIN middleware.</span></span> <span data-ttu-id="7d3e5-265">De este modo, nos podemos restringir la API Web para autenticar solo con tokens de portador.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-265">That way, we can restrict Web API to authenticate only using bearer tokens.</span></span>

> [!NOTE]
> <span data-ttu-id="7d3e5-266">En concreto, la parte MVC de la aplicación puede usar la autenticación de formularios, que almacena las credenciales en una cookie.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-266">In particular, the MVC portion of your app might use forms authentication, which stores credentials in a cookie.</span></span> <span data-ttu-id="7d3e5-267">Autenticación basada en cookies requiere el uso de tokens antifalsificación, para evitar los ataques CSRF.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-267">Cookie-based authentication requires the use of anti-forgery tokens, to prevent CSRF attacks.</span></span> <span data-ttu-id="7d3e5-268">Que es un problema para la API web, porque no hay ninguna manera cómoda de enviar el token antifalsificación al cliente para la API web.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-268">That's a problem for web APIs, because there is no convenient way for the web API to send the anti-forgery token to the client.</span></span> <span data-ttu-id="7d3e5-269">(Para obtener más información sobre este problema, consulte [evitar los ataques de CSRF en Web API](preventing-cross-site-request-forgery-csrf-attacks.md).) Una llamada a **SuppressDefaultHostAuthentication** garantiza que la API Web no es vulnerable a ataques CSRF de credenciales almacenadas en las cookies.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-269">(For more background on this issue, see [Preventing CSRF Attacks in Web API](preventing-cross-site-request-forgery-csrf-attacks.md).) Calling **SuppressDefaultHostAuthentication** ensures that Web API is not vulnerable to CSRF attacks from credentials stored in cookies.</span></span>

<span data-ttu-id="7d3e5-270">Cuando el cliente solicita un recurso protegido, aquí es lo que sucede en la canalización de Web API:</span><span class="sxs-lookup"><span data-stu-id="7d3e5-270">When the client requests a protected resource, here is what happens in the Web API pipeline:</span></span>

1. <span data-ttu-id="7d3e5-271">El **HostAuthentication** filtro llama al middleware de OAuth para validar el token.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-271">The **HostAuthentication** filter calls the OAuth middleware to validate the token.</span></span>
2. <span data-ttu-id="7d3e5-272">El middleware convierte el token en una identidad de notificaciones.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-272">The middleware converts the token into a claims identity.</span></span>
3. <span data-ttu-id="7d3e5-273">En este momento, la solicitud es *autenticado* pero no *autorizado*.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-273">At this point, the request is *authenticated* but not *authorized*.</span></span>
4. <span data-ttu-id="7d3e5-274">El filtro de autorización examina la identidad de notificaciones.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-274">The authorization filter examines the claims identity.</span></span> <span data-ttu-id="7d3e5-275">Si las notificaciones autorización al usuario para ese recurso, la solicitud está autorizada.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-275">If the claims authorize the user for that resource, the request is authorized.</span></span> <span data-ttu-id="7d3e5-276">De forma predeterminada, el **[Authorize]** atributo autorizará cualquier solicitud que se han autenticado.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-276">By default, the **[Authorize]** attribute will authorize any request that is authenticated.</span></span> <span data-ttu-id="7d3e5-277">Sin embargo, puede autorizar por rol o por otras notificaciones.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-277">However, you can authorize by role or by other claims.</span></span> <span data-ttu-id="7d3e5-278">Para obtener más información, consulte [autenticación y autorización en Web API](authentication-and-authorization-in-aspnet-web-api.md).</span><span class="sxs-lookup"><span data-stu-id="7d3e5-278">For more information, see [Authentication and Authorization in Web API](authentication-and-authorization-in-aspnet-web-api.md).</span></span>
5. <span data-ttu-id="7d3e5-279">Si los pasos anteriores se realizan correctamente, el controlador devuelve el recurso protegido.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-279">If the previous steps are successful, the controller returns the protected resource.</span></span> <span data-ttu-id="7d3e5-280">En caso contrario, el cliente recibe un error 401 (no autorizado).</span><span class="sxs-lookup"><span data-stu-id="7d3e5-280">Otherwise, the client receives a 401 (Unauthorized) error.</span></span>

[![](individual-accounts-in-web-api/_static/image18.png)](individual-accounts-in-web-api/_static/image17.png)

## <a name="additional-resources"></a><span data-ttu-id="7d3e5-281">Recursos adicionales</span><span class="sxs-lookup"><span data-stu-id="7d3e5-281">Additional Resources</span></span>

- [<span data-ttu-id="7d3e5-282">ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="7d3e5-282">ASP.NET Identity</span></span>](../../../identity/index.md)
- <span data-ttu-id="7d3e5-283">[Descripción de características de seguridad de la plantilla SPA de RC de VS2013](https://blogs.msdn.com/b/webdev/archive/2013/09/20/understanding-security-features-in-spa-template.aspx).</span><span class="sxs-lookup"><span data-stu-id="7d3e5-283">[Understanding Security Features in the SPA Template for VS2013 RC](https://blogs.msdn.com/b/webdev/archive/2013/09/20/understanding-security-features-in-spa-template.aspx).</span></span> <span data-ttu-id="7d3e5-284">Entrada de blog de MSDN por Hongye Sun.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-284">MSDN blog post by Hongye Sun.</span></span>
- <span data-ttu-id="7d3e5-285">[Si examinamos la Web API individuales cuentas plantilla – parte 2: Las cuentas locales](http://leastprivilege.com/2013/11/26/dissecting-the-web-api-individual-accounts-templatepart-2-local-accounts/).</span><span class="sxs-lookup"><span data-stu-id="7d3e5-285">[Dissecting the Web API Individual Accounts Template–Part 2: Local Accounts](http://leastprivilege.com/2013/11/26/dissecting-the-web-api-individual-accounts-templatepart-2-local-accounts/).</span></span> <span data-ttu-id="7d3e5-286">Blog de Dominick Baier.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-286">Blog post by Dominick Baier.</span></span>
- <span data-ttu-id="7d3e5-287">[Hospedar Web API con OWIN y autenticación](http://brockallen.com/2013/10/27/host-authentication-and-web-api-with-owin-and-active-vs-passive-authentication-middleware/).</span><span class="sxs-lookup"><span data-stu-id="7d3e5-287">[Host authentication and Web API with OWIN](http://brockallen.com/2013/10/27/host-authentication-and-web-api-with-owin-and-active-vs-passive-authentication-middleware/).</span></span> <span data-ttu-id="7d3e5-288">Una buena explicación de `SuppressDefaultHostAuthentication` y `HostAuthenticationFilter` por Brock Allen.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-288">A good explanation of `SuppressDefaultHostAuthentication` and `HostAuthenticationFilter` by Brock Allen.</span></span>
- <span data-ttu-id="7d3e5-289">[Personalizar la información de perfil en ASP.NET Identity en las plantillas de VS 2013](https://blogs.msdn.com/b/webdev/archive/2013/10/16/customizing-profile-information-in-asp-net-identity-in-vs-2013-templates.aspx).</span><span class="sxs-lookup"><span data-stu-id="7d3e5-289">[Customizing profile information in ASP.NET Identity in VS 2013 templates](https://blogs.msdn.com/b/webdev/archive/2013/10/16/customizing-profile-information-in-asp-net-identity-in-vs-2013-templates.aspx).</span></span> <span data-ttu-id="7d3e5-290">Entrada de blog MSDN de Pranav Rastogi.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-290">MSDN blog post by Pranav Rastogi.</span></span>
- <span data-ttu-id="7d3e5-291">[Por la administración de la duración de solicitud para la clase UserManager en ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span><span class="sxs-lookup"><span data-stu-id="7d3e5-291">[Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span> <span data-ttu-id="7d3e5-292">Entrada de blog MSDN por Suhas Joshi, con una buena explicación de la `UserManager` clase.</span><span class="sxs-lookup"><span data-stu-id="7d3e5-292">MSDN blog post by Suhas Joshi, with a good explanation of the `UserManager` class.</span></span>
