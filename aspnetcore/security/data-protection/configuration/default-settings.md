---
title: Administración de claves de protección de datos y la duración en ASP.NET Core
author: rick-anderson
description: Obtenga información sobre la administración de claves de protección de datos y la duración en ASP.NET Core.
ms.author: riande
ms.date: 10/14/2016
uid: security/data-protection/configuration/default-settings
ms.openlocfilehash: 2f022a4c7519485fe629ce47c27d214c8c27d5bc
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 03/01/2019
ms.locfileid: "57036562"
---
# <a name="data-protection-key-management-and-lifetime-in-aspnet-core"></a><span data-ttu-id="46047-103">Administración de claves de protección de datos y la duración en ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="46047-103">Data Protection key management and lifetime in ASP.NET Core</span></span>

<span data-ttu-id="46047-104">Por [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="46047-104">By [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

## <a name="key-management"></a><span data-ttu-id="46047-105">Administración de claves</span><span class="sxs-lookup"><span data-stu-id="46047-105">Key management</span></span>

<span data-ttu-id="46047-106">La aplicación intenta detectar su entorno operativo y controlar la configuración de la clave por sí mismo.</span><span class="sxs-lookup"><span data-stu-id="46047-106">The app attempts to detect its operational environment and handle key configuration on its own.</span></span>

1. <span data-ttu-id="46047-107">Si la aplicación está hospedada en [Azure Apps](https://azure.microsoft.com/services/app-service/), las claves se conservan en el *%HOME%\ASP.NET\DataProtection-Keys* carpeta.</span><span class="sxs-lookup"><span data-stu-id="46047-107">If the app is hosted in [Azure Apps](https://azure.microsoft.com/services/app-service/), keys are persisted to the *%HOME%\ASP.NET\DataProtection-Keys* folder.</span></span> <span data-ttu-id="46047-108">Esta carpeta está respaldada por el almacenamiento de red y se sincroniza en todas las máquinas que hospedan la aplicación.</span><span class="sxs-lookup"><span data-stu-id="46047-108">This folder is backed by network storage and is synchronized across all machines hosting the app.</span></span>
   * <span data-ttu-id="46047-109">Las claves no están protegidas en reposo.</span><span class="sxs-lookup"><span data-stu-id="46047-109">Keys aren't protected at rest.</span></span>
   * <span data-ttu-id="46047-110">El *DataProtection claves* carpeta proporciona el conjunto de claves para todas las instancias de una aplicación en una única ranura de implementación.</span><span class="sxs-lookup"><span data-stu-id="46047-110">The *DataProtection-Keys* folder supplies the key ring to all instances of an app in a single deployment slot.</span></span>
   * <span data-ttu-id="46047-111">Las ranuras de implementación independientes, por ejemplo, almacenamiento provisional y producción, no comparten ningún anillo de clave.</span><span class="sxs-lookup"><span data-stu-id="46047-111">Separate deployment slots, such as Staging and Production, don't share a key ring.</span></span> <span data-ttu-id="46047-112">Al intercambiar las ranuras de implementación, por ejemplo, intercambio de ensayo y producción o usando A pruebas a/b, cualquier aplicación con la protección de datos no podrá descifrar los datos almacenados mediante el conjunto de claves dentro de la ranura anterior.</span><span class="sxs-lookup"><span data-stu-id="46047-112">When you swap between deployment slots, for example swapping Staging to Production or using A/B testing, any app using Data Protection won't be able to decrypt stored data using the key ring inside the previous slot.</span></span> <span data-ttu-id="46047-113">Esto conduce a los usuarios que se están registrados fuera de una aplicación que utiliza la autenticación de cookies estándar de ASP.NET Core, ya que usa la protección de datos para proteger sus cookies.</span><span class="sxs-lookup"><span data-stu-id="46047-113">This leads to users being logged out of an app that uses the standard ASP.NET Core cookie authentication, as it uses Data Protection to protect its cookies.</span></span> <span data-ttu-id="46047-114">Si así lo desea llaveros independiente de la ranura, utilice un proveedor de anillo de clave externa, como Azure Blob Storage, Azure Key Vault, un almacén de SQL, o de Redis cache.</span><span class="sxs-lookup"><span data-stu-id="46047-114">If you desire slot-independent key rings, use an external key ring provider, such as Azure Blob Storage, Azure Key Vault, a SQL store, or Redis cache.</span></span>

1. <span data-ttu-id="46047-115">Si el perfil de usuario está disponible, las claves se conservan en el *%LOCALAPPDATA%\ASP.NET\DataProtection-Keys* carpeta.</span><span class="sxs-lookup"><span data-stu-id="46047-115">If the user profile is available, keys are persisted to the *%LOCALAPPDATA%\ASP.NET\DataProtection-Keys* folder.</span></span> <span data-ttu-id="46047-116">Si el sistema operativo es Windows, las claves se cifran en reposo mediante DPAPI.</span><span class="sxs-lookup"><span data-stu-id="46047-116">If the operating system is Windows, the keys are encrypted at rest using DPAPI.</span></span>

   <span data-ttu-id="46047-117">También se debe habilitar el [atributo setProfileEnvironment](/iis/configuration/system.applicationhost/applicationpools/add/processmodel#configuration) del grupo de aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="46047-117">The app pool's [setProfileEnvironment attribute](/iis/configuration/system.applicationhost/applicationpools/add/processmodel#configuration) must also be enabled.</span></span> <span data-ttu-id="46047-118">El valor predeterminado de `setProfileEnvironment` es `true`.</span><span class="sxs-lookup"><span data-stu-id="46047-118">The default value of `setProfileEnvironment` is `true`.</span></span> <span data-ttu-id="46047-119">En algunos escenarios (por ejemplo, SO Windows), `setProfileEnvironment` está establecido en `false`.</span><span class="sxs-lookup"><span data-stu-id="46047-119">In some scenarios (for example, Windows OS), `setProfileEnvironment` is set to `false`.</span></span> <span data-ttu-id="46047-120">Si las claves no se almacenan en el directorio del perfil de usuario como se esperaba:</span><span class="sxs-lookup"><span data-stu-id="46047-120">If keys aren't stored in the user profile directory as expected:</span></span>

   1. <span data-ttu-id="46047-121">Vaya a la carpeta *%windir%/system32/inetsrv/config*.</span><span class="sxs-lookup"><span data-stu-id="46047-121">Navigate to the *%windir%/system32/inetsrv/config* folder.</span></span>
   1. <span data-ttu-id="46047-122">Abra el archivo *applicationHost.config*.</span><span class="sxs-lookup"><span data-stu-id="46047-122">Open the *applicationHost.config* file.</span></span>
   1. <span data-ttu-id="46047-123">Busque el elemento `<system.applicationHost><applicationPools><applicationPoolDefaults><processModel>` .</span><span class="sxs-lookup"><span data-stu-id="46047-123">Locate the `<system.applicationHost><applicationPools><applicationPoolDefaults><processModel>` element.</span></span>
   1. <span data-ttu-id="46047-124">Confirme que el atributo `setProfileEnvironment` no está presente, que adopta de forma predeterminada el valor `true`, o establezca explícitamente el valor del atributo en `true`.</span><span class="sxs-lookup"><span data-stu-id="46047-124">Confirm that the `setProfileEnvironment` attribute isn't present, which defaults the value to `true`, or explicitly set the attribute's value to `true`.</span></span>

1. <span data-ttu-id="46047-125">Si la aplicación se hospeda en IIS, las claves se guardan en el registro HKLM en una clave del registro especial que se incluye sólo la cuenta de proceso de trabajo.</span><span class="sxs-lookup"><span data-stu-id="46047-125">If the app is hosted in IIS, keys are persisted to the HKLM registry in a special registry key that's ACLed only to the worker process account.</span></span> <span data-ttu-id="46047-126">Las claves se cifran en reposo con DPAPI.</span><span class="sxs-lookup"><span data-stu-id="46047-126">Keys are encrypted at rest using DPAPI.</span></span>

1. <span data-ttu-id="46047-127">Si ninguna de estas condiciones coinciden, no se conservan las claves fuera del proceso actual.</span><span class="sxs-lookup"><span data-stu-id="46047-127">If none of these conditions match, keys aren't persisted outside of the current process.</span></span> <span data-ttu-id="46047-128">Cuando el proceso se cierra, todos los genera las claves se pierden.</span><span class="sxs-lookup"><span data-stu-id="46047-128">When the process shuts down, all generated keys are lost.</span></span>

<span data-ttu-id="46047-129">El desarrollador está siempre en control total y puede invalidar cómo y dónde se almacenan las claves.</span><span class="sxs-lookup"><span data-stu-id="46047-129">The developer is always in full control and can override how and where keys are stored.</span></span> <span data-ttu-id="46047-130">Las tres primeras opciones anteriores deben proporcionar valores predeterminados adecuados para la mayoría de las aplicaciones similar a cómo ASP.NET  **\<machineKey >** rutinas de la generación automática trabajado en el pasado.</span><span class="sxs-lookup"><span data-stu-id="46047-130">The first three options above should provide good defaults for most apps similar to how the ASP.NET **\<machineKey>** auto-generation routines worked in the past.</span></span> <span data-ttu-id="46047-131">La opción de reserva final es el único escenario que requiere que el desarrollador especificar [configuración](xref:security/data-protection/configuration/overview) por adelantado si quieren persistencia de clave, pero esta reserva solo se produce en situaciones excepcionales.</span><span class="sxs-lookup"><span data-stu-id="46047-131">The final, fallback option is the only scenario that requires the developer to specify [configuration](xref:security/data-protection/configuration/overview) upfront if they want key persistence, but this fallback only occurs in rare situations.</span></span>

<span data-ttu-id="46047-132">Cuando se hospedan en un contenedor de Docker, se deberían conservar las claves en una carpeta que es un volumen de Docker (un volumen compartido o un volumen montado en el host, que se conserva más allá de la duración del contenedor) o en un proveedor externo, como [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) o [Redis](https://redis.io/).</span><span class="sxs-lookup"><span data-stu-id="46047-132">When hosting in a Docker container, keys should be persisted in a folder that's a Docker volume (a shared volume or a host-mounted volume that persists beyond the container's lifetime) or in an external provider, such as [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) or [Redis](https://redis.io/).</span></span> <span data-ttu-id="46047-133">Un proveedor externo también es útil en escenarios de granja de servidores web si las aplicaciones no pueden acceder a un volumen compartido de red (consulte [PersistKeysToFileSystem](xref:security/data-protection/configuration/overview#persistkeystofilesystem) para obtener más información).</span><span class="sxs-lookup"><span data-stu-id="46047-133">An external provider is also useful in web farm scenarios if apps can't access a shared network volume (see [PersistKeysToFileSystem](xref:security/data-protection/configuration/overview#persistkeystofilesystem) for more information).</span></span>

> [!WARNING]
> <span data-ttu-id="46047-134">Si el desarrollador reemplaza las reglas descritas anteriormente y señala el sistema de protección de datos en un repositorio específico de claves, cifrado automático de las claves en reposo está deshabilitado.</span><span class="sxs-lookup"><span data-stu-id="46047-134">If the developer overrides the rules outlined above and points the Data Protection system at a specific key repository, automatic encryption of keys at rest is disabled.</span></span> <span data-ttu-id="46047-135">Protección de reposo puede habilitarse de nuevo a través de [configuración](xref:security/data-protection/configuration/overview).</span><span class="sxs-lookup"><span data-stu-id="46047-135">At-rest protection can be re-enabled via [configuration](xref:security/data-protection/configuration/overview).</span></span>

## <a name="key-lifetime"></a><span data-ttu-id="46047-136">Vigencia de clave</span><span class="sxs-lookup"><span data-stu-id="46047-136">Key lifetime</span></span>

<span data-ttu-id="46047-137">Las claves tienen una duración de 90 días de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="46047-137">Keys have a 90-day lifetime by default.</span></span> <span data-ttu-id="46047-138">Cuando expira una clave, la aplicación genera una nueva clave automáticamente y establece la nueva clave como la clave activa.</span><span class="sxs-lookup"><span data-stu-id="46047-138">When a key expires, the app automatically generates a new key and sets the new key as the active key.</span></span> <span data-ttu-id="46047-139">Claves retiradas permanecen en el sistema, siempre y cuando la aplicación puede descifrar los datos protegidos con ellos.</span><span class="sxs-lookup"><span data-stu-id="46047-139">As long as retired keys remain on the system, your app can decrypt any data protected with them.</span></span> <span data-ttu-id="46047-140">Consulte [administración de claves](xref:security/data-protection/implementation/key-management#key-expiration-and-rolling) para obtener más información.</span><span class="sxs-lookup"><span data-stu-id="46047-140">See [key management](xref:security/data-protection/implementation/key-management#key-expiration-and-rolling) for more information.</span></span>

## <a name="default-algorithms"></a><span data-ttu-id="46047-141">Algoritmos predeterminados</span><span class="sxs-lookup"><span data-stu-id="46047-141">Default algorithms</span></span>

<span data-ttu-id="46047-142">El algoritmo de protección de carga predeterminado usado es AES-256-CBC para confidencialidad y HMACSHA256 autenticidad.</span><span class="sxs-lookup"><span data-stu-id="46047-142">The default payload protection algorithm used is AES-256-CBC for confidentiality and HMACSHA256 for authenticity.</span></span> <span data-ttu-id="46047-143">Una clave maestra de 512 bits, puede cambiada cada 90 días, se usa para derivar las claves secundarias dos utilizadas para estos algoritmos en una base por cada carga.</span><span class="sxs-lookup"><span data-stu-id="46047-143">A 512-bit master key, changed every 90 days, is used to derive the two sub-keys used for these algorithms on a per-payload basis.</span></span> <span data-ttu-id="46047-144">Consulte [derivación de subclave](xref:security/data-protection/implementation/subkeyderivation#additional-authenticated-data-and-subkey-derivation) para obtener más información.</span><span class="sxs-lookup"><span data-stu-id="46047-144">See [subkey derivation](xref:security/data-protection/implementation/subkeyderivation#additional-authenticated-data-and-subkey-derivation) for more information.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="46047-145">Recursos adicionales</span><span class="sxs-lookup"><span data-stu-id="46047-145">Additional resources</span></span>

* <xref:security/data-protection/extensibility/key-management>
* <xref:host-and-deploy/web-farm>
