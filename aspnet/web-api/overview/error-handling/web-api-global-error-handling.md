---
uid: web-api/overview/error-handling/web-api-global-error-handling
title: Control global de errores en ASP.NET Web API 2 - ASP.NET 4.x
author: davidmatson
description: Una visión general del control de errores global en ASP.NET Web API 2 para ASP.NET 4.x.
ms.author: riande
ms.date: 02/03/2014
ms.custom: seoapril2019
ms.assetid: bffd7863-f63b-4b23-a13c-372b5492e9fb
msc.legacyurl: /web-api/overview/error-handling/web-api-global-error-handling
msc.type: authoredcontent
ms.openlocfilehash: 5ff54d2e4ed881ce927d0a401fb79d9b8bc5b8a1
ms.sourcegitcommit: ce28244209db8615bc9bdd576a2e2c88174d318d
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 04/06/2020
ms.locfileid: "80675428"
---
# <a name="global-error-handling-in-aspnet-web-api-2"></a><span data-ttu-id="5ef52-103">Control global de errores en ASP.NET Web API 2</span><span class="sxs-lookup"><span data-stu-id="5ef52-103">Global Error Handling in ASP.NET Web API 2</span></span>

<span data-ttu-id="5ef52-104">por [David Matson](https://github.com/davidmatson), [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="5ef52-104">by [David Matson](https://github.com/davidmatson), [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="5ef52-105">En este tema se proporciona información general sobre el control global de errores en ASP.NET Web API 2 para ASP.NET 4.x.</span><span class="sxs-lookup"><span data-stu-id="5ef52-105">This topic provides an overview of global error handling in ASP.NET Web API 2 for ASP.NET 4.x.</span></span> <span data-ttu-id="5ef52-106">Hoy en día no hay una manera fácil en Web API de registrar o controlar errores globalmente.</span><span class="sxs-lookup"><span data-stu-id="5ef52-106">Today there's no easy way in Web API to log or handle errors globally.</span></span> <span data-ttu-id="5ef52-107">Algunas excepciones no controladas se pueden procesar mediante filtros de [excepciones,](exception-handling.md)pero hay una serie de casos que los filtros de excepciones no pueden controlar.</span><span class="sxs-lookup"><span data-stu-id="5ef52-107">Some unhandled exceptions can be processed via [exception filters](exception-handling.md), but there are a number of cases that exception filters can't handle.</span></span> <span data-ttu-id="5ef52-108">Por ejemplo:</span><span class="sxs-lookup"><span data-stu-id="5ef52-108">For example:</span></span>

1. <span data-ttu-id="5ef52-109">Excepciones iniciadas por constructores del controlador.</span><span class="sxs-lookup"><span data-stu-id="5ef52-109">Exceptions thrown from controller constructors.</span></span>
2. <span data-ttu-id="5ef52-110">Excepciones iniciadas por controladores de mensajes.</span><span class="sxs-lookup"><span data-stu-id="5ef52-110">Exceptions thrown from message handlers.</span></span>
3. <span data-ttu-id="5ef52-111">Excepciones iniciadas durante el enrutamiento.</span><span class="sxs-lookup"><span data-stu-id="5ef52-111">Exceptions thrown during routing.</span></span>
4. <span data-ttu-id="5ef52-112">Excepciones iniciadas durante la serialización del contenido de respuesta.</span><span class="sxs-lookup"><span data-stu-id="5ef52-112">Exceptions thrown during response content serialization.</span></span>

<span data-ttu-id="5ef52-113">Queremos proporcionar una forma sencilla y coherente de registrar y controlar (cuando sea posible) estas excepciones.</span><span class="sxs-lookup"><span data-stu-id="5ef52-113">We want to provide a simple, consistent way to log and handle (where possible) these exceptions.</span></span> 

<span data-ttu-id="5ef52-114">Hay dos casos principales para controlar excepciones, el caso en el que podemos enviar una respuesta de error y el caso en el que todo lo que podemos hacer es registrar la excepción.</span><span class="sxs-lookup"><span data-stu-id="5ef52-114">There are two major cases for handling exceptions, the case where we are able to send an error response and the case where all we can do is log the exception.</span></span> <span data-ttu-id="5ef52-115">Un ejemplo para este último caso es cuando se produce una excepción en medio del contenido de respuesta de streaming; en ese caso, es demasiado tarde para enviar un nuevo mensaje de respuesta ya que el código de estado, los encabezados y el contenido parcial ya han pasado a través de la conexión, por lo que simplemente anulamos la conexión.</span><span class="sxs-lookup"><span data-stu-id="5ef52-115">An example for the latter case is when an exception is thrown in the middle of streaming response content; in that case it is too late to send a new response message since the status code, headers, and partial content have already gone across the wire, so we simply abort the connection.</span></span> <span data-ttu-id="5ef52-116">Aunque la excepción no se puede controlar para generar un nuevo mensaje de respuesta, todavía se admite el registro de la excepción.</span><span class="sxs-lookup"><span data-stu-id="5ef52-116">Even though the exception can't be handled to produce a new response message, we still support logging the exception.</span></span> <span data-ttu-id="5ef52-117">En los casos en los que podemos detectar un error, podemos devolver una respuesta de error adecuada como se muestra a continuación:</span><span class="sxs-lookup"><span data-stu-id="5ef52-117">In cases where we can detect an error, we can return an appropriate error response as shown in the following:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample1.cs?highlight=6)]

### <a name="existing-options"></a><span data-ttu-id="5ef52-118">Opciones existentes</span><span class="sxs-lookup"><span data-stu-id="5ef52-118">Existing Options</span></span>

<span data-ttu-id="5ef52-119">Además de los filtros de [excepciones,](exception-handling.md)los [controladores](../advanced/http-message-handlers.md) de mensajes se pueden usar hoy en día para observar todas las respuestas de 500 niveles, pero actuar en esas respuestas es difícil, ya que carecen de contexto sobre el error original.</span><span class="sxs-lookup"><span data-stu-id="5ef52-119">In addition to [exception filters](exception-handling.md), [message handlers](../advanced/http-message-handlers.md) can be used today to observe all 500-level responses, but acting on those responses is difficult, as they lack context about the original error.</span></span> <span data-ttu-id="5ef52-120">Los controladores de mensajes también tienen algunas de las mismas limitaciones que los filtros de excepciones con respecto a los casos que pueden controlar.</span><span class="sxs-lookup"><span data-stu-id="5ef52-120">Message handlers also have some of the same limitations as exception filters regarding the cases they can handle.</span></span> <span data-ttu-id="5ef52-121">Aunque La API web tiene una infraestructura de seguimiento que captura las condiciones de error, la infraestructura de seguimiento tiene fines de diagnóstico y no está diseñada ni es adecuada para ejecutarse en entornos de producción.</span><span class="sxs-lookup"><span data-stu-id="5ef52-121">While Web API does have tracing infrastructure that captures error conditions the tracing infrastructure is for diagnostics purposes and is not designed or suited for running in production environments.</span></span> <span data-ttu-id="5ef52-122">El control y el registro de excepciones globales deben ser servicios que se pueden ejecutar durante la producción y conectarse a soluciones de supervisión existentes (por ejemplo, [ELMAH).](https://code.google.com/p/elmah/)</span><span class="sxs-lookup"><span data-stu-id="5ef52-122">Global exception handling and logging should be services that can run during production and be plugged into existing monitoring solutions (for example, [ELMAH](https://code.google.com/p/elmah/)).</span></span>

### <a name="solution-overview"></a><span data-ttu-id="5ef52-123">Información general de la solución</span><span class="sxs-lookup"><span data-stu-id="5ef52-123">Solution Overview</span></span>

 <span data-ttu-id="5ef52-124">Proporcionamos dos nuevos servicios reemplazables por el usuario, [IExceptionLogger](../releases/whats-new-in-aspnet-web-api-21.md) e IExceptionHandler, para registrar y controlar excepciones no controladas.</span><span class="sxs-lookup"><span data-stu-id="5ef52-124">We provide two new user-replaceable services, [IExceptionLogger](../releases/whats-new-in-aspnet-web-api-21.md) and IExceptionHandler, to log and handle unhandled exceptions.</span></span> <span data-ttu-id="5ef52-125">Los servicios son muy similares, con dos diferencias principales:</span><span class="sxs-lookup"><span data-stu-id="5ef52-125">The services are very similar, with two main differences:</span></span>

1. <span data-ttu-id="5ef52-126">Admitimos el registro de varios registradores de excepciones, pero solo un único controlador de excepciones.</span><span class="sxs-lookup"><span data-stu-id="5ef52-126">We support registering multiple exception loggers but only a single exception handler.</span></span>
2. <span data-ttu-id="5ef52-127">Los registradores de excepciones siempre reciben llamadas, incluso si estamos a punto de anular la conexión.</span><span class="sxs-lookup"><span data-stu-id="5ef52-127">Exception loggers always get called, even if we're about to abort the connection.</span></span> <span data-ttu-id="5ef52-128">Solo se llama a los controladores de excepciones cuando todavía podemos elegir qué mensaje de respuesta enviar.</span><span class="sxs-lookup"><span data-stu-id="5ef52-128">Exception handlers only get called when we're still able to choose which response message to send.</span></span>

<span data-ttu-id="5ef52-129">Ambos servicios proporcionan acceso a un contexto de excepción que contiene información relevante desde el punto donde se detectó la excepción, especialmente [HttpRequestMessage](https://msdn.microsoft.com/library/system.net.http.httprequestmessage(v=vs.110).aspx), [HttpRequestContext](https://msdn.microsoft.com/library/system.web.http.controllers.httprequestcontext(v=vs.118).aspx), la excepción iniciada y el origen de la excepción (detalles a continuación).</span><span class="sxs-lookup"><span data-stu-id="5ef52-129">Both services provide access to an exception context containing relevant information from the point where the exception was detected, particularly the [HttpRequestMessage](https://msdn.microsoft.com/library/system.net.http.httprequestmessage(v=vs.110).aspx), the [HttpRequestContext](https://msdn.microsoft.com/library/system.web.http.controllers.httprequestcontext(v=vs.118).aspx), the thrown exception and the exception source (details below).</span></span>

### <a name="design-principles"></a><span data-ttu-id="5ef52-130">Principios de diseño</span><span class="sxs-lookup"><span data-stu-id="5ef52-130">Design Principles</span></span>

1. <span data-ttu-id="5ef52-131">**Sin cambios importantes** Dado que esta funcionalidad se agrega en una versión secundaria, una restricción importante que afecta a la solución es que no hay cambios importantes, ya sea para escribir contratos o para el comportamiento.</span><span class="sxs-lookup"><span data-stu-id="5ef52-131">**No breaking changes** Because this functionality is being added in a minor release, one important constraint impacting the solution is that there be no breaking changes, either to type contracts or to behavior.</span></span> <span data-ttu-id="5ef52-132">Esta restricción descartó alguna limpieza que nos gustaría haber hecho en términos de bloques de captura existentes que convierten las excepciones en 500 respuestas.</span><span class="sxs-lookup"><span data-stu-id="5ef52-132">This constraint ruled out some cleanup we would like to have done in terms of existing catch blocks turning exceptions into 500 responses.</span></span> <span data-ttu-id="5ef52-133">Esta limpieza adicional es algo que podríamos considerar para una versión principal posterior.</span><span class="sxs-lookup"><span data-stu-id="5ef52-133">This additional cleanup is something we might consider for a subsequent major release.</span></span> <span data-ttu-id="5ef52-134">Si esto es importante para usted, por favor vote sobre él en ASP.NET voz del usuario de [la API web.](http://aspnet.uservoice.com/forums/147201-asp-net-web-api/suggestions/5451321-add-flag-to-enable-iexceptionlogger-and-iexception)</span><span class="sxs-lookup"><span data-stu-id="5ef52-134">If this is important to you please vote on it at [ASP.NET Web API user voice](http://aspnet.uservoice.com/forums/147201-asp-net-web-api/suggestions/5451321-add-flag-to-enable-iexceptionlogger-and-iexception).</span></span>
2. <span data-ttu-id="5ef52-135">**Mantener la coherencia con las construcciones** de la API web La canalización de filtros de la API web es una excelente manera de controlar las preocupaciones transversales con la flexibilidad de aplicar la lógica en un ámbito global, específico de controlador o específico de la acción.</span><span class="sxs-lookup"><span data-stu-id="5ef52-135">**Maintaining consistency with Web API constructs** Web API's filter pipeline is a great way to handle cross-cutting concerns with the flexibility of applying the logic at an action-specific, controller-specific or global scope.</span></span> <span data-ttu-id="5ef52-136">Los filtros, incluidos los filtros de excepción, siempre tienen contextos de acción y controlador, incluso cuando se registran en el ámbito global.</span><span class="sxs-lookup"><span data-stu-id="5ef52-136">Filters, including exception filters, always have action and controller contexts, even when registered at the global scope.</span></span> <span data-ttu-id="5ef52-137">Ese contrato tiene sentido para los filtros, pero significa que los filtros de excepción, incluso los con ámbito global, no son adecuados para algunos casos de control de excepciones, como las excepciones de los controladores de mensajes, donde no existe ningún contexto de acción o controlador.</span><span class="sxs-lookup"><span data-stu-id="5ef52-137">That contract makes sense for filters, but it means that exception filters, even globally scoped ones, aren't a good fit for some exception handling cases, such as exceptions from message handlers, where no action or controller context exists.</span></span> <span data-ttu-id="5ef52-138">Si queremos usar el ámbito flexible que ofrecen los filtros para el control de excepciones, todavía necesitamos filtros de excepción.</span><span class="sxs-lookup"><span data-stu-id="5ef52-138">If we want to use the flexible scoping afforded by filters for exception handling, we still need exception filters.</span></span> <span data-ttu-id="5ef52-139">Pero si necesitamos controlar la excepción fuera de un contexto de controlador, también necesitamos una construcción independiente para el control de errores global completo (algo sin el contexto del controlador y las restricciones de contexto de acción).</span><span class="sxs-lookup"><span data-stu-id="5ef52-139">But if we need to handle exception outside of a controller context, we also need a separate construct for full global error handling (something without the controller context and action context constraints).</span></span>

### <a name="when-to-use"></a><span data-ttu-id="5ef52-140">Cuándo usar</span><span class="sxs-lookup"><span data-stu-id="5ef52-140">When to Use</span></span>

- <span data-ttu-id="5ef52-141">Los registradores de excepciones son la solución para ver todas las excepciones no controladas detectadas por Web API.</span><span class="sxs-lookup"><span data-stu-id="5ef52-141">Exception loggers are the solution to seeing all unhandled exception caught by Web API.</span></span>
- <span data-ttu-id="5ef52-142">Los controladores de excepciones son la solución para personalizar todas las posibles respuestas a las excepciones no controladas detectadas por la API web.</span><span class="sxs-lookup"><span data-stu-id="5ef52-142">Exception handlers are the solution for customizing all possible responses to unhandled exceptions caught by Web API.</span></span>
- <span data-ttu-id="5ef52-143">Los filtros de excepciones son la solución más fácil para procesar las excepciones no controladas del subconjunto relacionadas con una acción o controlador específico.</span><span class="sxs-lookup"><span data-stu-id="5ef52-143">Exception filters are the easiest solution for processing the subset unhandled exceptions related to a specific action or controller.</span></span>

### <a name="service-details"></a><span data-ttu-id="5ef52-144">Detalles del servicio</span><span class="sxs-lookup"><span data-stu-id="5ef52-144">Service Details</span></span>

 <span data-ttu-id="5ef52-145">Las interfaces de servicio de controlador y registrador de excepciones son métodos asincrónicos simples que toman los contextos respectivos:</span><span class="sxs-lookup"><span data-stu-id="5ef52-145">The exception logger and handler service interfaces are simple async methods taking the respective contexts:</span></span> 

[!code-csharp[Main](web-api-global-error-handling/samples/sample2.cs)]

 <span data-ttu-id="5ef52-146">También proporcionamos clases base para ambas interfaces.</span><span class="sxs-lookup"><span data-stu-id="5ef52-146">We also provide base classes for both of these interfaces.</span></span> <span data-ttu-id="5ef52-147">Reemplazar los métodos principales (sincronizar o asincrónicos) es todo lo que se requiere para registrar o controlar en los momentos recomendados.</span><span class="sxs-lookup"><span data-stu-id="5ef52-147">Overriding the core (sync or async) methods is all that is required to log or handle at the recommended times.</span></span> <span data-ttu-id="5ef52-148">Para el `ExceptionLogger` registro, la clase base se asegurará de que el método de registro principal solo se llama una vez para cada excepción (incluso si posteriormente se propaga más arriba de la pila de llamadas y se detecta de nuevo).</span><span class="sxs-lookup"><span data-stu-id="5ef52-148">For logging, the `ExceptionLogger` base class will ensure that the core logging method is only called once for each exception (even if it later propagates further up the call stack and is caught again).</span></span> <span data-ttu-id="5ef52-149">La `ExceptionHandler` clase base llamará al método de control principal solo para las excepciones en la parte superior de la pila de llamadas, ignorando los bloques de captura anidados heredados.</span><span class="sxs-lookup"><span data-stu-id="5ef52-149">The `ExceptionHandler` base class will call the core handling method only for exceptions at the top of the call stack, ignoring legacy nested catch blocks.</span></span> <span data-ttu-id="5ef52-150">(Las versiones simplificadas de estas clases base se encuentran en el apéndice siguiente.) Ambos `IExceptionLogger` `IExceptionHandler` y recibir información sobre `ExceptionContext`la excepción a través de un archivo .</span><span class="sxs-lookup"><span data-stu-id="5ef52-150">(Simplified versions of these base classes are in the appendix below.) Both `IExceptionLogger` and `IExceptionHandler` receive information about the exception via an `ExceptionContext`.</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample3.cs)]

<span data-ttu-id="5ef52-151">Cuando el marco de trabajo llama a un registrador `Exception` de `Request`excepciones o un controlador de excepciones, siempre proporcionará un archivo y un archivo .</span><span class="sxs-lookup"><span data-stu-id="5ef52-151">When the framework calls an exception logger or an exception handler, it will always provide an `Exception` and a `Request`.</span></span> <span data-ttu-id="5ef52-152">A excepción de las pruebas `RequestContext`unitarias, también siempre proporcionará un archivo .</span><span class="sxs-lookup"><span data-stu-id="5ef52-152">Except for unit testing, it will also always provide a `RequestContext`.</span></span> <span data-ttu-id="5ef52-153">Rara vez proporcionará `ControllerContext` a `ActionContext` y (sólo cuando se llama desde el bloque catch para los filtros de excepción).</span><span class="sxs-lookup"><span data-stu-id="5ef52-153">It will rarely provide a `ControllerContext` and `ActionContext` (only when calling from the catch block for exception filters).</span></span> <span data-ttu-id="5ef52-154">Muy rara vez proporcionará `Response`un (sólo en ciertos casos de IIS cuando en el medio de tratar de escribir la respuesta).</span><span class="sxs-lookup"><span data-stu-id="5ef52-154">It will very rarely provide a `Response`(only in certain IIS cases when in the middle of trying to write the response).</span></span> <span data-ttu-id="5ef52-155">Tenga en cuenta que, `null` dado que algunas de `null` estas propiedades pueden ser, depende del consumidor comprobar antes de tener acceso a los miembros de la clase de excepción.`CatchBlock`</span><span class="sxs-lookup"><span data-stu-id="5ef52-155">Note that because some of these properties may be `null` it is up to the consumer to check for `null` before accessing members of the exception class.`CatchBlock`</span></span> <span data-ttu-id="5ef52-156">es una cadena que indica qué bloque catch vio la excepción.</span><span class="sxs-lookup"><span data-stu-id="5ef52-156">is a string indicating which catch block saw the exception.</span></span> <span data-ttu-id="5ef52-157">Las cadenas de bloque catch son las siguientes:</span><span class="sxs-lookup"><span data-stu-id="5ef52-157">The catch block strings are as follows:</span></span>

- <span data-ttu-id="5ef52-158">HttpServer (método SendAsync)</span><span class="sxs-lookup"><span data-stu-id="5ef52-158">HttpServer (SendAsync method)</span></span>
- <span data-ttu-id="5ef52-159">HttpControllerDispatcher (método SendAsync)</span><span class="sxs-lookup"><span data-stu-id="5ef52-159">HttpControllerDispatcher (SendAsync method)</span></span>
- <span data-ttu-id="5ef52-160">HttpBatchHandler (método SendAsync)</span><span class="sxs-lookup"><span data-stu-id="5ef52-160">HttpBatchHandler (SendAsync method)</span></span>
- <span data-ttu-id="5ef52-161">IExceptionFilter (procesamiento de ApiController de la canalización de filtro de excepción en ExecuteAsync)</span><span class="sxs-lookup"><span data-stu-id="5ef52-161">IExceptionFilter (ApiController's processing of the exception filter pipeline in ExecuteAsync)</span></span>
- <span data-ttu-id="5ef52-162">Host OWIN:</span><span class="sxs-lookup"><span data-stu-id="5ef52-162">OWIN host:</span></span>

    - <span data-ttu-id="5ef52-163">HttpMessageHandlerAdapter.BufferResponseContentAsync (para almacenar en búfer)</span><span class="sxs-lookup"><span data-stu-id="5ef52-163">HttpMessageHandlerAdapter.BufferResponseContentAsync (for buffering output)</span></span>
    - <span data-ttu-id="5ef52-164">HttpMessageHandlerAdapter.CopyResponseContentAsync (para la salida de streaming)</span><span class="sxs-lookup"><span data-stu-id="5ef52-164">HttpMessageHandlerAdapter.CopyResponseContentAsync (for streaming output)</span></span>
- <span data-ttu-id="5ef52-165">Host web:</span><span class="sxs-lookup"><span data-stu-id="5ef52-165">Web host:</span></span>

    - <span data-ttu-id="5ef52-166">HttpControllerHandler.WriteBufferedResponseContentAsync (para la salida de almacenamiento en búfer)</span><span class="sxs-lookup"><span data-stu-id="5ef52-166">HttpControllerHandler.WriteBufferedResponseContentAsync (for buffering output)</span></span>
    - <span data-ttu-id="5ef52-167">HttpControllerHandler.WriteStreamedResponseContentAsync (para la salida de streaming)</span><span class="sxs-lookup"><span data-stu-id="5ef52-167">HttpControllerHandler.WriteStreamedResponseContentAsync (for streaming output)</span></span>
    - <span data-ttu-id="5ef52-168">HttpControllerHandler.WriteErrorResponseContentAsync (para errores en la recuperación de errores en modo de salida almacenado en búfer)</span><span class="sxs-lookup"><span data-stu-id="5ef52-168">HttpControllerHandler.WriteErrorResponseContentAsync (for failures in error recovery under buffered output mode)</span></span>

<span data-ttu-id="5ef52-169">La lista de cadenas de bloque catch también está disponible a través de propiedades estáticas readonly.</span><span class="sxs-lookup"><span data-stu-id="5ef52-169">The list of catch block strings is also available via static readonly properties.</span></span> <span data-ttu-id="5ef52-170">(La cadena de bloque catch principal se encuentra en la estática ExceptionCatchBlocks; el resto aparece en una clase estática cada uno para OWIN y host web).`IsTopLevelCatchBlock`</span><span class="sxs-lookup"><span data-stu-id="5ef52-170">(The core catch block string are on the static ExceptionCatchBlocks; the remainder appear on one static class each for OWIN and web host).`IsTopLevelCatchBlock`</span></span> <span data-ttu-id="5ef52-171">es útil para seguir el patrón recomendado de control de excepciones solo en la parte superior de la pila de llamadas.</span><span class="sxs-lookup"><span data-stu-id="5ef52-171">is helpful for following the recommended pattern of handling exceptions only at the top of the call stack.</span></span> <span data-ttu-id="5ef52-172">En lugar de convertir las excepciones en 500 respuestas en cualquier lugar donde se produzca un bloque catch anidado, un controlador de excepciones puede permitir que las excepciones se propaguen hasta que el host las vea.</span><span class="sxs-lookup"><span data-stu-id="5ef52-172">Rather than turning exceptions into 500 responses anywhere a nested catch block occurs, an exception handler can let exceptions propagate until they are about to be seen by the host.</span></span>

<span data-ttu-id="5ef52-173">Además `ExceptionContext`de la , un registrador obtiene una `ExceptionLoggerContext`pieza más de información a través de la completa :</span><span class="sxs-lookup"><span data-stu-id="5ef52-173">In addition to the `ExceptionContext`, a logger gets one more piece of information via the full `ExceptionLoggerContext`:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample4.cs)]

<span data-ttu-id="5ef52-174">La segunda `CanBeHandled`propiedad, , permite a un registrador identificar una excepción que no se puede controlar.</span><span class="sxs-lookup"><span data-stu-id="5ef52-174">The second property, `CanBeHandled`, allows a logger to identify an exception that cannot be handled.</span></span> <span data-ttu-id="5ef52-175">Cuando la conexión está a punto de anularse y no se puede enviar ningún mensaje de respuesta nuevo, se llamará a los registradores, pero ***no*** se llamará al controlador y los registradores pueden identificar este escenario desde esta propiedad.</span><span class="sxs-lookup"><span data-stu-id="5ef52-175">When the connection is about to be aborted and no new response message can be sent, the loggers will be called but the handler will ***not*** be called, and the loggers can identify this scenario from this property.</span></span>

<span data-ttu-id="5ef52-176">Además `ExceptionContext`de la , un controlador obtiene una `ExceptionHandlerContext` propiedad más que puede establecer en el conjunto para controlar la excepción:</span><span class="sxs-lookup"><span data-stu-id="5ef52-176">In additional to the `ExceptionContext`, a handler gets one more property it can set on the full `ExceptionHandlerContext` to handle the exception:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample5.cs)]

<span data-ttu-id="5ef52-177">Un controlador de excepciones indica que ha `Result` controlado una excepción estableciendo la propiedad en un resultado de acción (por ejemplo, un [ExceptionResult](https://msdn.microsoft.com/library/system.web.http.results.exceptionresult(v=vs.118).aspx), [InternalServerErrorResult](https://msdn.microsoft.com/library/system.web.http.results.internalservererrorresult(v=vs.118).aspx), [StatusCodeResult](https://msdn.microsoft.com/library/system.web.http.results.statuscoderesult(v=vs.118).aspx)o un resultado personalizado).</span><span class="sxs-lookup"><span data-stu-id="5ef52-177">An exception handler indicates that it has handled an exception by setting the `Result` property to an action result (for example, an [ExceptionResult](https://msdn.microsoft.com/library/system.web.http.results.exceptionresult(v=vs.118).aspx), [InternalServerErrorResult](https://msdn.microsoft.com/library/system.web.http.results.internalservererrorresult(v=vs.118).aspx), [StatusCodeResult](https://msdn.microsoft.com/library/system.web.http.results.statuscoderesult(v=vs.118).aspx), or a custom result).</span></span> <span data-ttu-id="5ef52-178">Si `Result` la propiedad es null, la excepción no se controla y se volverá a producir la excepción original.</span><span class="sxs-lookup"><span data-stu-id="5ef52-178">If the `Result` property is null, the exception is unhandled and the original exception will be re-thrown.</span></span>

<span data-ttu-id="5ef52-179">Para las excepciones en la parte superior de la pila de llamadas, hemos tomado un paso adicional para garantizar que la respuesta sea adecuada para los llamadores de API.</span><span class="sxs-lookup"><span data-stu-id="5ef52-179">For exceptions at the top of the call stack, we took an extra step to ensure the response is appropriate for API callers.</span></span> <span data-ttu-id="5ef52-180">Si la excepción se propaga hasta el host, el autor de la llamada vería la pantalla amarilla de la muerte o alguna respuesta proporcionada por algún otro host que normalmente es HTML y no suele ser una respuesta de error de API adecuada.</span><span class="sxs-lookup"><span data-stu-id="5ef52-180">If the exception propagates up to the host, the caller would see the yellow screen of death or some other host provided response which is typically HTML and not usually an appropriate API error response.</span></span> <span data-ttu-id="5ef52-181">En estos casos, el resultado se inicia sin null y solo si `null` un controlador de excepciones personalizado lo establece explícitamente en (no controlado) se propagará la excepción al host.</span><span class="sxs-lookup"><span data-stu-id="5ef52-181">In these cases, the Result starts out non-null, and only if a custom exception handler explicitly sets it back to `null` (unhandled) will the exception propagate to the host.</span></span> <span data-ttu-id="5ef52-182">Establecer `Result` `null` en estos casos puede ser útil para dos escenarios:</span><span class="sxs-lookup"><span data-stu-id="5ef52-182">Setting `Result` to `null` in such cases can be useful for two scenarios:</span></span>

1. <span data-ttu-id="5ef52-183">API web hospedada en OWIN con middleware de control de excepciones personalizado registrado antes o fuera de la API web.</span><span class="sxs-lookup"><span data-stu-id="5ef52-183">OWIN hosted Web API with custom exception handling middleware registered before/outside Web API.</span></span>
2. <span data-ttu-id="5ef52-184">Depuración local a través de un explorador, donde la pantalla amarilla de la muerte es en realidad una respuesta útil para una excepción no controlada.</span><span class="sxs-lookup"><span data-stu-id="5ef52-184">Local debugging via a browser, where the yellow screen of death is actually a helpful response for an unhandled exception.</span></span>

<span data-ttu-id="5ef52-185">Tanto para los registradores de excepciones como para los controladores de excepciones, no hacemos nada para recuperar si el propio registrador o controlador produce una excepción.</span><span class="sxs-lookup"><span data-stu-id="5ef52-185">For both exception loggers and exception handlers, we don't do anything to recover if the logger or handler itself throws an exception.</span></span> <span data-ttu-id="5ef52-186">(Aparte de dejar que la excepción se propague, deje comentarios en la parte inferior de esta página si tiene un mejor enfoque.) El contrato para registradores de excepciones y controladores es que no deben permitir que las excepciones se propaguen a sus llamadores; de lo contrario, la excepción simplemente se propagará, a menudo hasta el host, lo que resulta en un error HTML (como ASP. Pantalla amarilla de NET) que se devuelve al cliente (que normalmente no es la opción preferida para los llamadores de API que esperan JSON o XML).</span><span class="sxs-lookup"><span data-stu-id="5ef52-186">(Other than letting the exception propagate, leave feedback at the bottom of this page if you have a better approach.) The contract for exception loggers and handlers is that they should not let exceptions propagate up to their callers; otherwise, the exception will just propagate, often all the way to the host resulting in an HTML error (like ASP.NET's yellow screen) being sent back to the client (which usually isn't the preferred option for API callers that expect JSON or XML).</span></span>

## <a name="examples"></a><span data-ttu-id="5ef52-187">Ejemplos</span><span class="sxs-lookup"><span data-stu-id="5ef52-187">Examples</span></span>

### <a name="tracing-exception-logger"></a><span data-ttu-id="5ef52-188">Seguimiento del registrador de excepciones</span><span class="sxs-lookup"><span data-stu-id="5ef52-188">Tracing Exception Logger</span></span>

<span data-ttu-id="5ef52-189">El registrador de excepciones siguiente envía datos de excepción a orígenes de seguimiento configurados (incluida la ventana de salida Depurar en Visual Studio).</span><span class="sxs-lookup"><span data-stu-id="5ef52-189">The exception logger below sends exception data to configured Trace sources (including the Debug output window in Visual Studio).</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample6.cs)]

### <a name="custom-error-message-exception-handler"></a><span data-ttu-id="5ef52-190">Controlador de excepciones de mensajes de error personalizados</span><span class="sxs-lookup"><span data-stu-id="5ef52-190">Custom Error Message Exception Handler</span></span>

<span data-ttu-id="5ef52-191">El controlador de excepciones siguiente genera una respuesta de error personalizada a los clientes, incluida una dirección de correo electrónico para ponerse en contacto con el soporte técnico.</span><span class="sxs-lookup"><span data-stu-id="5ef52-191">The exception handler below produces a custom error response to clients, including an email address for contacting support.</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample7.cs)]

## <a name="registering-exception-filters"></a><span data-ttu-id="5ef52-192">Registro de filtros de excepción</span><span class="sxs-lookup"><span data-stu-id="5ef52-192">Registering Exception Filters</span></span>

<span data-ttu-id="5ef52-193">Si usa la plantilla de proyecto "ASP.NET MVC 4 Web Application" para `WebApiConfig` crear el proyecto, coloque el código de configuración de La API web dentro de la clase, en la carpeta *App_Start:*</span><span class="sxs-lookup"><span data-stu-id="5ef52-193">If you use the "ASP.NET MVC 4 Web Application" project template to create your project, put your Web API configuration code inside the `WebApiConfig` class, in the *App_Start* folder:</span></span>

[!code-csharp[Main](exception-handling/samples/sample7.cs?highlight=5)]

## <a name="appendix-base-class-details"></a><span data-ttu-id="5ef52-194">Apéndice: Detalles de la clase base</span><span class="sxs-lookup"><span data-stu-id="5ef52-194">Appendix: Base Class Details</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample8.cs)]
