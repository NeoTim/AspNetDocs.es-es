---
uid: mvc/overview/older-versions/using-oauth-providers-with-mvc
title: Usar proveedores OAuth con MVC 4 | Microsoft Docs
author: Rick-Anderson
description: Este tutorial muestra cómo crear una aplicación web de ASP.NET MVC 4 que permite a los usuarios inicien sesión con credenciales de un proveedor externo, como Facebo...
ms.author: riande
ms.date: 06/19/2013
ms.assetid: 7a87f16f-0e19-4f15-a88a-094ae866c4a2
msc.legacyurl: /mvc/overview/older-versions/using-oauth-providers-with-mvc
msc.type: authoredcontent
ms.openlocfilehash: c2fe74c3d7b1aa0d230f1893f6ba7dcaa7a88419
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 04/17/2019
ms.locfileid: "59396989"
---
# <a name="using-oauth-providers-with-mvc-4"></a><span data-ttu-id="2b8ed-103">Usar proveedores OAuth con MVC 4</span><span class="sxs-lookup"><span data-stu-id="2b8ed-103">Using OAuth Providers with MVC 4</span></span>

<span data-ttu-id="2b8ed-104">por [Tom FitzMacken](https://github.com/tfitzmac)</span><span class="sxs-lookup"><span data-stu-id="2b8ed-104">by [Tom FitzMacken](https://github.com/tfitzmac)</span></span>

> <span data-ttu-id="2b8ed-105">Este tutorial muestra cómo crear una aplicación web de ASP.NET MVC 4 que permite a los usuarios iniciar sesión con credenciales de un proveedor externo, como Facebook, Twitter, Microsoft o Google y luego la integrará algunas de las funcionalidades de dichos proveedores en su aplicación Web.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-105">This tutorial shows you how to build an ASP.NET MVC 4 web application that enables users to log in with credentials from an external provider, such as Facebook, Twitter, Microsoft, or Google, and then integrate some of the functionality from those providers into your web application.</span></span> <span data-ttu-id="2b8ed-106">Por motivos de simplicidad, este tutorial se centra en trabajar con las credenciales de Facebook.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-106">For simplicity, this tutorial focuses on working with credentials from Facebook.</span></span>
> 
> <span data-ttu-id="2b8ed-107">Para usar credenciales externas en una aplicación web ASP.NET MVC 5, consulte [crear una aplicación de ASP.NET MVC 5 con Facebook y Google OAuth2 y OpenID Sign-on](../security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span><span class="sxs-lookup"><span data-stu-id="2b8ed-107">To use external credentials in an ASP.NET MVC 5 web application, see [Create an ASP.NET MVC 5 App with Facebook and Google OAuth2 and OpenID Sign-on](../security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
> 
> <span data-ttu-id="2b8ed-108">Habilitar estas credenciales en los sitios web proporciona una ventaja considerable porque millones de usuarios ya tienen cuentas con estos proveedores externos.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-108">Enabling these credentials in your web sites provides a significant advantage because millions of users already have accounts with these external providers.</span></span> <span data-ttu-id="2b8ed-109">Estos usuarios pueden ser más propensos a suscribirse a su sitio si no tienen que crear y recordar un nuevo conjunto de credenciales.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-109">These users may be more inclined to sign up for your site if they do not have to create and remember a new set of credentials.</span></span> <span data-ttu-id="2b8ed-110">Además, después de que un usuario haya iniciado sesión a través de uno de estos proveedores, puede incorporar operaciones sociales desde el proveedor.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-110">Also, after a user has logged in through one of these providers, you can incorporate social operations from the provider.</span></span>


## <a name="what-youll-build"></a><span data-ttu-id="2b8ed-111">¿Qué va a crear</span><span class="sxs-lookup"><span data-stu-id="2b8ed-111">What you'll build</span></span>

<span data-ttu-id="2b8ed-112">En este tutorial, hay dos objetivos principales:</span><span class="sxs-lookup"><span data-stu-id="2b8ed-112">There are two main goals in this tutorial:</span></span>

1. <span data-ttu-id="2b8ed-113">Permitir que un usuario que inicie sesión con credenciales de un proveedor de OAuth.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-113">Enable a user to log in with credentials from an OAuth provider.</span></span>
2. <span data-ttu-id="2b8ed-114">Recuperar información de la cuenta del proveedor e integrar esa información en el registro de la cuenta para su sitio.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-114">Retrieve account information from the provider and integrate that information with the account registration for your site.</span></span>

<span data-ttu-id="2b8ed-115">Aunque se centran en los ejemplos de este tutorial sobre el uso de Facebook como proveedor de autenticación, puede modificar el código para usar cualquiera de los proveedores.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-115">Although the examples in this tutorial focus on using Facebook as the authentication provider, you can modify the code to use any of the providers.</span></span> <span data-ttu-id="2b8ed-116">Los pasos para implementar cualquier proveedor son muy similares a los pasos que verá en este tutorial.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-116">The steps to implement any provider are very similar to the steps you will see in this tutorial.</span></span> <span data-ttu-id="2b8ed-117">Solo se puede detectar diferencias significativas al realizar llamadas directas a la API del proveedor establezca.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-117">You will only notice significant differences when making direct calls to the provider's API set.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="2b8ed-118">Requisitos previos</span><span class="sxs-lookup"><span data-stu-id="2b8ed-118">Prerequisites</span></span>

- <span data-ttu-id="2b8ed-119">[Microsoft Visual Studio 2012](https://www.microsoft.com/visualstudio/eng/downloads#vs) o [Microsoft Visual Studio Express 2012 para Web](https://www.microsoft.com/visualstudio/eng/downloads#d-2012-express)</span><span class="sxs-lookup"><span data-stu-id="2b8ed-119">[Microsoft Visual Studio 2012](https://www.microsoft.com/visualstudio/eng/downloads#vs) or [Microsoft Visual Studio Express 2012 for Web](https://www.microsoft.com/visualstudio/eng/downloads#d-2012-express)</span></span>

<span data-ttu-id="2b8ed-120">O bien</span><span class="sxs-lookup"><span data-stu-id="2b8ed-120">Or</span></span>

- <span data-ttu-id="2b8ed-121">Microsoft Visual Studio 2010 SP1 o [Visual Web Developer Express 2010 SP1](https://www.microsoft.com/visualstudio/eng/downloads#d-2010-express)</span><span class="sxs-lookup"><span data-stu-id="2b8ed-121">Microsoft Visual Studio 2010 SP1 or [Visual Web Developer Express 2010 SP1](https://www.microsoft.com/visualstudio/eng/downloads#d-2010-express)</span></span>
- [<span data-ttu-id="2b8ed-122">ASP.NET MVC 4</span><span class="sxs-lookup"><span data-stu-id="2b8ed-122">ASP.NET MVC 4</span></span>](https://go.microsoft.com/fwlink/?LinkId=243392)

<span data-ttu-id="2b8ed-123">Además, en este tema se supone que tiene conocimientos básicos sobre ASP.NET MVC y Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-123">Furthermore, this topic assumes you have basic knowledge about ASP.NET MVC and Visual Studio.</span></span> <span data-ttu-id="2b8ed-124">Si necesita una introducción a ASP.NET MVC 4, consulte [Introducción a ASP.NET MVC 4](getting-started-with-aspnet-mvc4/intro-to-aspnet-mvc-4.md).</span><span class="sxs-lookup"><span data-stu-id="2b8ed-124">If you need an introduction to ASP.NET MVC 4, see [Intro to ASP.NET MVC 4](getting-started-with-aspnet-mvc4/intro-to-aspnet-mvc-4.md).</span></span>

## <a name="create-the-project"></a><span data-ttu-id="2b8ed-125">Crear el proyecto</span><span class="sxs-lookup"><span data-stu-id="2b8ed-125">Create the project</span></span>

<span data-ttu-id="2b8ed-126">En Visual Studio, cree una nueva aplicación Web de ASP.NET MVC 4 y asígnele el nombre &quot;OAuthMVC&quot;.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-126">In Visual Studio, create a new ASP.NET MVC 4 Web Application, and name it &quot;OAuthMVC&quot;.</span></span> <span data-ttu-id="2b8ed-127">Puede tener como destino .NET Framework 4.5 o 4.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-127">You can target either .NET Framework 4.5 or 4.</span></span>

![Crear proyecto](using-oauth-providers-with-mvc/_static/image1.png)

<span data-ttu-id="2b8ed-129">En la ventana nuevo proyecto de ASP.NET MVC 4, seleccione **aplicación de Internet** y dejar **Razor** como el motor de vista.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-129">In the New ASP.NET MVC 4 Project window, select **Internet Application** and leave **Razor** as the view engine.</span></span>

![Seleccione la aplicación de Internet](using-oauth-providers-with-mvc/_static/image2.png)

## <a name="enable-a-provider"></a><span data-ttu-id="2b8ed-131">Habilitación de un proveedor</span><span class="sxs-lookup"><span data-stu-id="2b8ed-131">Enable a provider</span></span>

<span data-ttu-id="2b8ed-132">Cuando se crea una aplicación web MVC 4 con la plantilla de aplicación de Internet, se crea el proyecto con un archivo denominado AuthConfig.cs en la aplicación\_carpeta de inicio.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-132">When you create an MVC 4 web application with the Internet Application template, the project is created with a file named AuthConfig.cs in the App\_Start folder.</span></span>

![Archivo AuthConfig](using-oauth-providers-with-mvc/_static/image3.png)

<span data-ttu-id="2b8ed-134">El archivo AuthConfig contiene código para registrar a los clientes para proveedores de autenticación externos.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-134">The AuthConfig file contains code to register clients for external authentication providers.</span></span> <span data-ttu-id="2b8ed-135">De forma predeterminada, este código está comentado, por lo que ninguno de los proveedores externos están habilitado.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-135">By default, this code is commented out, so none of the external providers are enabled.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample1.cs)]

<span data-ttu-id="2b8ed-136">Debe quite este código para usar al cliente de autenticación externo.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-136">You must uncomment this code to use the external authentication client.</span></span> <span data-ttu-id="2b8ed-137">Quite la marca de comentario solo los proveedores que desea incluir en el sitio.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-137">You uncomment only the providers you want to include in your site.</span></span> <span data-ttu-id="2b8ed-138">Para este tutorial, solo permitirá las credenciales de Facebook.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-138">For this tutorial, you will only enable the Facebook credentials.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample2.cs)]

<span data-ttu-id="2b8ed-139">Tenga en cuenta en el ejemplo anterior que el método incluye cadenas vacías para los parámetros de registro.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-139">Notice in the above example that the method includes empty strings for the registration parameters.</span></span> <span data-ttu-id="2b8ed-140">Si intenta ejecutar la aplicación ahora, la aplicación inicia una excepción de argumento porque no se permiten cadenas vacías para los parámetros.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-140">If you try to run the application now, the application throws an argument exception because empty strings are not allowed for the parameters.</span></span> <span data-ttu-id="2b8ed-141">Para proporcionar los valores válidos, debe registrar su sitio web con los proveedores externos, como se muestra en la sección siguiente.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-141">To provide valid values, you must register your web site with the external providers, as shown in the next section.</span></span>

## <a name="registering-with-an-external-provider"></a><span data-ttu-id="2b8ed-142">Registrar con un proveedor externo</span><span class="sxs-lookup"><span data-stu-id="2b8ed-142">Registering with an external provider</span></span>

<span data-ttu-id="2b8ed-143">Para autenticar usuarios con credenciales de un proveedor externo, debe registrar su sitio web con el proveedor.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-143">To authenticate users with credentials from an external provider, you must register your web site with the provider.</span></span> <span data-ttu-id="2b8ed-144">Al registrar su sitio, recibirá los parámetros (por ejemplo, clave o identificador y secreto) para incluir al registrar al cliente.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-144">When you register your site, you will receive the parameters (such as key or id, and secret) to include when registering the client.</span></span> <span data-ttu-id="2b8ed-145">Debe tener una cuenta con los proveedores que desea usar.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-145">You must have an account with the providers you wish to use.</span></span>

<span data-ttu-id="2b8ed-146">En este tutorial no muestra todos los pasos que debe realizar para registrar con estos proveedores.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-146">This tutorial does not show all of the steps you must perform to register with these providers.</span></span> <span data-ttu-id="2b8ed-147">Los pasos no suelen ser difíciles.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-147">The steps are typically not difficult.</span></span> <span data-ttu-id="2b8ed-148">Para registrar correctamente el sitio, siga las instrucciones proporcionadas en esos sitios.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-148">To successfully register your site, follow the instructions provided on those sites.</span></span> <span data-ttu-id="2b8ed-149">Para empezar a trabajar con el registro de su sitio, consulte el sitio para desarrolladores para:</span><span class="sxs-lookup"><span data-stu-id="2b8ed-149">To get started with registering your site, see the developer site for:</span></span>

- [<span data-ttu-id="2b8ed-150">Facebook</span><span class="sxs-lookup"><span data-stu-id="2b8ed-150">Facebook</span></span>](https://developers.facebook.com/)
- [<span data-ttu-id="2b8ed-151">Google</span><span class="sxs-lookup"><span data-stu-id="2b8ed-151">Google</span></span>](https://developers.google.com/)
- [<span data-ttu-id="2b8ed-152">Microsoft</span><span class="sxs-lookup"><span data-stu-id="2b8ed-152">Microsoft</span></span>](http://manage.dev.live.com/)
- [<span data-ttu-id="2b8ed-153">Twitter</span><span class="sxs-lookup"><span data-stu-id="2b8ed-153">Twitter</span></span>](https://dev.twitter.com/)

<span data-ttu-id="2b8ed-154">Al registrar su sitio con Facebook, puede proporcionar &quot;localhost&quot; para el dominio del sitio y `&quot;http://localhost/&quot;` para la dirección URL, tal como se muestra en la imagen siguiente.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-154">When registering your site with Facebook, you can provide &quot;localhost&quot; for the site domain and `&quot;http://localhost/&quot;` for the URL, as shown in the image below.</span></span> <span data-ttu-id="2b8ed-155">El uso de localhost funciona con la mayoría de los proveedores, pero actualmente no funciona con el proveedor de Microsoft.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-155">Using localhost works with most providers, but currently does not work with the Microsoft provider.</span></span> <span data-ttu-id="2b8ed-156">Para el proveedor de Microsoft, debe incluir una dirección URL del sitio web válido.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-156">For the Microsoft provider, you must include a valid web site URL.</span></span>

![registrar el sitio](using-oauth-providers-with-mvc/_static/image4.png)

<span data-ttu-id="2b8ed-158">En la imagen anterior, se han quitado los valores para el Id. de aplicación, el secreto de la aplicación y el correo electrónico de contacto.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-158">In the previous image, the values for the app id, app secret, and contact email have been removed.</span></span> <span data-ttu-id="2b8ed-159">Al registrar su sitio realmente, esos valores estará presentes.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-159">When you actually register your site, those values will be present.</span></span> <span data-ttu-id="2b8ed-160">Debe tener en cuenta los valores de Id. de aplicación y secreto de la aplicación, ya que lo agregará a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-160">You will want to note the values for app id and app secret because you will add them to your application.</span></span>

## <a name="creating-test-users"></a><span data-ttu-id="2b8ed-161">Creación de usuarios de prueba</span><span class="sxs-lookup"><span data-stu-id="2b8ed-161">Creating test users</span></span>

<span data-ttu-id="2b8ed-162">Si no cuenta con una cuenta existente de Facebook para probar su sitio, puede omitir esta sección.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-162">If you do not mind using an existing Facebook account to test your site, you can skip this section.</span></span>

<span data-ttu-id="2b8ed-163">Puede crear fácilmente usuarios de prueba para la aplicación dentro de la página de administración de aplicaciones de Facebook.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-163">You can easily create test users for your application within the Facebook app management page.</span></span> <span data-ttu-id="2b8ed-164">Puede usar estas cuentas para iniciar sesión en el sitio de prueba.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-164">You can use these test accounts to log in to your site.</span></span> <span data-ttu-id="2b8ed-165">Crear usuarios de prueba, haga clic en el **Roles** vínculo en el panel de navegación izquierdo y hacer clic en el **crear** vínculo.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-165">You create test users by clicking the **Roles** link in the left navigation pane and the clicking the **Create** link.</span></span>

![crear usuarios de prueba](using-oauth-providers-with-mvc/_static/image5.png)

<span data-ttu-id="2b8ed-167">El sitio de Facebook crea automáticamente el número de cuentas de prueba que solicitan.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-167">The Facebook site automatically creates the number of test accounts that you request.</span></span>

## <a name="adding-application-id-and-secret-from-the-provider"></a><span data-ttu-id="2b8ed-168">Adición de Id. de aplicación y el secreto desde el proveedor</span><span class="sxs-lookup"><span data-stu-id="2b8ed-168">Adding application id and secret from the provider</span></span>

<span data-ttu-id="2b8ed-169">Ahora que ha recibido el identificador y el secreto de Facebook, vuelva al archivo AuthConfig y agregarlas como los valores de parámetro.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-169">Now that you have received the id and secret from Facebook, go back to the AuthConfig file and add them as the parameter values.</span></span> <span data-ttu-id="2b8ed-170">Los valores que se muestra a continuación no son valores reales.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-170">The values shown below are not real values.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample3.cs)]

## <a name="log-in-with-external-credentials"></a><span data-ttu-id="2b8ed-171">Inicie sesión con credenciales externas</span><span class="sxs-lookup"><span data-stu-id="2b8ed-171">Log in with external credentials</span></span>

<span data-ttu-id="2b8ed-172">Eso es todo lo que debe hacer para habilitar las credenciales externas en el sitio.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-172">That is all you have to do to enable external credentials in your site.</span></span> <span data-ttu-id="2b8ed-173">Ejecute la aplicación y haga clic en el vínculo de inicio de sesión en la esquina superior derecha.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-173">Run your application and click the login link in the upper right corner.</span></span> <span data-ttu-id="2b8ed-174">La plantilla automáticamente reconoce que ha registrado Facebook como proveedor e incluye un botón para el proveedor.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-174">The template automatically recognizes that you have registered Facebook as a provider and includes a button for the provider.</span></span> <span data-ttu-id="2b8ed-175">Si registra varios proveedores, un botón para cada uno de ellos se incluye automáticamente.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-175">If you register multiple providers, a button for each one is automatically included.</span></span>

![inicio de sesión externo](using-oauth-providers-with-mvc/_static/image6.png)

<span data-ttu-id="2b8ed-177">Este tutorial no trata cómo personalizar el registro en los botones para los proveedores externos.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-177">This tutorial does not cover how to customize the log in buttons for the external providers.</span></span> <span data-ttu-id="2b8ed-178">Para obtener esa información, consulte [personalizar la interfaz de usuario de inicio de sesión al utilizar OAuth/OpenID](https://blogs.msdn.com/b/pranav_rastogi/archive/2012/08/24/customizing-the-login-ui-when-using-oauth-openid.aspx).</span><span class="sxs-lookup"><span data-stu-id="2b8ed-178">For that information, see [Customizing the login UI when using OAuth/OpenID](https://blogs.msdn.com/b/pranav_rastogi/archive/2012/08/24/customizing-the-login-ui-when-using-oauth-openid.aspx).</span></span>

<span data-ttu-id="2b8ed-179">Haga clic en el botón de Facebook para iniciar sesión con las credenciales de Facebook.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-179">Click on the Facebook button to log in with Facebook credentials.</span></span> <span data-ttu-id="2b8ed-180">Cuando selecciona uno de los proveedores externos, se le redirigirá a ese sitio y se lo solicite que el servicio para iniciar sesión.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-180">When you select one of the external providers, you are redirected to that site and prompted by that service to log in.</span></span>

<span data-ttu-id="2b8ed-181">La siguiente imagen muestra la pantalla de inicio de sesión de Facebook.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-181">The following image shows the login screen for Facebook.</span></span> <span data-ttu-id="2b8ed-182">Observa que está utilizando su cuenta de Facebook para iniciar sesión en un sitio denominado oauthmvcexample.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-182">It notes that you are using your Facebook account to log in to a site named oauthmvcexample.</span></span>

![autenticación de Facebook](using-oauth-providers-with-mvc/_static/image7.png)

<span data-ttu-id="2b8ed-184">Después de iniciar sesión con las credenciales de Facebook, una página informa al usuario que el sitio tendrá acceso a información básica.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-184">After logging in with Facebook credentials, a page informs the user that the site will have access to basic information.</span></span>

![permiso de solicitud](using-oauth-providers-with-mvc/_static/image8.png)

<span data-ttu-id="2b8ed-186">Después de seleccionar **ir a la aplicación**, el usuario debe registrar para el sitio.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-186">After selecting **Go to App**, the user must register for the site.</span></span> <span data-ttu-id="2b8ed-187">La siguiente imagen muestra la página de registro después de que un usuario ha iniciado sesión con las credenciales de Facebook.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-187">The following image shows the registration page after a user has logged in with Facebook credentials.</span></span> <span data-ttu-id="2b8ed-188">El nombre de usuario es normalmente se rellenan previamente con un nombre del proveedor.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-188">The user name is typically pre-filled with a name from the provider.</span></span>

![register](using-oauth-providers-with-mvc/_static/image9.png)

<span data-ttu-id="2b8ed-190">Haga clic en **registrar** para completar el registro.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-190">Click **Register** to complete registration.</span></span> <span data-ttu-id="2b8ed-191">Cierre el explorador.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-191">Close the browser.</span></span>

<span data-ttu-id="2b8ed-192">Puede ver que la nueva cuenta se ha agregado a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-192">You can see that the new account has been added to your database.</span></span> <span data-ttu-id="2b8ed-193">En el Explorador de servidores, abra el **DefaultConnection** de base de datos y abra la **tablas** carpeta.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-193">In Server Explorer, open the **DefaultConnection** database and open the **Tables** folder.</span></span>

![tablas de bases de datos](using-oauth-providers-with-mvc/_static/image10.png)

<span data-ttu-id="2b8ed-195">Haga clic en el **UserProfile** de tabla y seleccione **mostrar datos de tabla**.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-195">Right-click the **UserProfile** table and select **Show Table Data**.</span></span>

![Mostrar datos](using-oauth-providers-with-mvc/_static/image11.png)

<span data-ttu-id="2b8ed-197">Verá la nueva cuenta agregada.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-197">You will see the new account you added.</span></span> <span data-ttu-id="2b8ed-198">Examine los datos de **página Web\_OAuthMembership** tabla.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-198">Look at the data in **webpage\_OAuthMembership** table.</span></span> <span data-ttu-id="2b8ed-199">Verá más datos relacionados con el proveedor externo para la cuenta que acaba de agregar.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-199">You will see more data related to the external provider for the account you just added.</span></span>

<span data-ttu-id="2b8ed-200">Si solo desea habilitar la autenticación externa, está listo.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-200">If you only want to enable external authentication, you are done.</span></span> <span data-ttu-id="2b8ed-201">Sin embargo, puede integrar más información del proveedor en el nuevo proceso de registro de usuario, tal como se muestra en las secciones siguientes.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-201">However, you can further integrate information from the provider into the new user registration process, as shown in the following sections.</span></span>

## <a name="create-models-for-additional-user-information"></a><span data-ttu-id="2b8ed-202">Crear modelos para obtener información adicional del usuario</span><span class="sxs-lookup"><span data-stu-id="2b8ed-202">Create models for additional user information</span></span>

<span data-ttu-id="2b8ed-203">Como ha observado en las secciones anteriores, no es necesario recuperar cualquier información adicional para que funcione el registro de la cuenta integrada.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-203">As you noticed in the previous sections, you do not need to retrieve any additional information for the built-in account registration to work.</span></span> <span data-ttu-id="2b8ed-204">Sin embargo, los proveedores externos más pasan otros información sobre el usuario.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-204">However, most external providers pass back additional information about the user.</span></span> <span data-ttu-id="2b8ed-205">Las secciones siguientes muestran cómo conservar esta información y guárdelo en una base de datos.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-205">The following sections show how to retain that information and save it to a database.</span></span> <span data-ttu-id="2b8ed-206">En concreto, conservará los valores para el nombre completo del usuario, el URI de la página de web personal del usuario y un valor que indica si Facebook ha comprobado la cuenta.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-206">Specifically, you will retain values for the user's full name, the URI of the user's personal web page, and a value that indicates whether Facebook has verified the account.</span></span>

<span data-ttu-id="2b8ed-207">Va a usar [migraciones de Code First](https://msdn.microsoft.com/data/jj591621) para agregar una tabla para almacenar información adicional del usuario.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-207">You will use [Code First Migrations](https://msdn.microsoft.com/data/jj591621) to add a table for storing additional user information.</span></span> <span data-ttu-id="2b8ed-208">Va a agregar la tabla a una base de datos existente, por lo que primero deberá crear una instantánea de la base de datos actual.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-208">You are adding the table to an existing database, so you will first need to create a snapshot of the current database.</span></span> <span data-ttu-id="2b8ed-209">Al crear una instantánea de la base de datos actual, más adelante puede crear una migración que contiene solo la nueva tabla.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-209">By creating a snapshot of the current database, you can later create a migration that contains only the new table.</span></span> <span data-ttu-id="2b8ed-210">Para crear una instantánea de la base de datos actual:</span><span class="sxs-lookup"><span data-stu-id="2b8ed-210">To create a snapshot of the current database:</span></span>

1. <span data-ttu-id="2b8ed-211">Abra el **consola de administrador de paquetes**</span><span class="sxs-lookup"><span data-stu-id="2b8ed-211">Open the **Package Manager Console**</span></span>
2. <span data-ttu-id="2b8ed-212">Ejecute el comando **enable-migrations**</span><span class="sxs-lookup"><span data-stu-id="2b8ed-212">Run the command **enable-migrations**</span></span>
3. <span data-ttu-id="2b8ed-213">Ejecute el comando **agregar a la migración inicial: IgnoreChanges**</span><span class="sxs-lookup"><span data-stu-id="2b8ed-213">Run the command **add-migration initial –IgnoreChanges**</span></span>
4. <span data-ttu-id="2b8ed-214">Ejecute el comando **Actualizar base de datos**</span><span class="sxs-lookup"><span data-stu-id="2b8ed-214">Run the command **update-database**</span></span>

<span data-ttu-id="2b8ed-215">Ahora, agregará las nuevas propiedades.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-215">Now, you will add the new properties.</span></span> <span data-ttu-id="2b8ed-216">En la carpeta Models, abra el archivo AccountModels.cs y busque la clase RegisterExternalLoginModel.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-216">In the Models folder, open the AccountModels.cs file, and find the RegisterExternalLoginModel class.</span></span> <span data-ttu-id="2b8ed-217">La clase RegisterExternalLoginModel contiene valores que se devuelven desde el proveedor de autenticación.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-217">The RegisterExternalLoginModel class holds values that come back from the authentication provider.</span></span> <span data-ttu-id="2b8ed-218">Agregar propiedades llamadas FullName y vínculo, tal como se muestra a continuación.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-218">Add properties named FullName and Link, as highlighted below.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample4.cs?highlight=9-13)]

<span data-ttu-id="2b8ed-219">También en AccountModels.cs, agregue una nueva clase denominada ExtraUserInformation.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-219">Also in AccountModels.cs, add a new class called ExtraUserInformation.</span></span> <span data-ttu-id="2b8ed-220">Esta clase representa la nueva tabla que se creará en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-220">This class represents the new table which will be created in the database.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample5.cs)]

<span data-ttu-id="2b8ed-221">En la clase UsersContext, agregue el código resaltado a continuación para crear una propiedad DbSet para la nueva clase.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-221">In the UsersContext class, add the highlighted code below to create a DbSet property for the new class.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample6.cs?highlight=9)]

<span data-ttu-id="2b8ed-222">Ahora está listo para crear la nueva tabla.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-222">You are now ready to create the new table.</span></span> <span data-ttu-id="2b8ed-223">Abra la consola de administrador de paquetes de nuevo y esta vez:</span><span class="sxs-lookup"><span data-stu-id="2b8ed-223">Open the Package Manager Console again and this time:</span></span>

1. <span data-ttu-id="2b8ed-224">Ejecute el comando **AddExtraUserInformation agregar a la migración**</span><span class="sxs-lookup"><span data-stu-id="2b8ed-224">Run the command **add-migration AddExtraUserInformation**</span></span>
2. <span data-ttu-id="2b8ed-225">Ejecute el comando **Actualizar base de datos**</span><span class="sxs-lookup"><span data-stu-id="2b8ed-225">Run the command **update-database**</span></span>

<span data-ttu-id="2b8ed-226">La nueva tabla ya existe en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-226">The new table now exists in the database.</span></span>

## <a name="retrieve-the-additional-data"></a><span data-ttu-id="2b8ed-227">Recuperar los datos adicionales</span><span class="sxs-lookup"><span data-stu-id="2b8ed-227">Retrieve the additional data</span></span>

<span data-ttu-id="2b8ed-228">Hay dos maneras de recuperar datos de usuario adicionales.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-228">There are two ways to retrieve additional user data.</span></span> <span data-ttu-id="2b8ed-229">La primera consiste en conservar los datos de usuario que se pasan, de forma predeterminada, durante la solicitud de autenticación.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-229">The first way is to retain user data that is passed back, by default, during the authentication request.</span></span> <span data-ttu-id="2b8ed-230">La segunda consiste en concreto, llame a la API del proveedor y solicitar más información.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-230">The second way is to specifically call the provider API and request more information.</span></span> <span data-ttu-id="2b8ed-231">Automáticamente se pasan valores FullName y el vínculo volver por Facebook.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-231">Values for FullName and Link are automatically passed back by Facebook.</span></span> <span data-ttu-id="2b8ed-232">Un valor que indica si Facebook ha comprobado la cuenta se recupera mediante una llamada a la API de Facebook.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-232">A value that indicates whether Facebook has verified the account is retrieved through a call to the Facebook API.</span></span> <span data-ttu-id="2b8ed-233">En primer lugar, se rellenará los valores FullName y el vínculo y, a continuación, más adelante, obtendrá el valor comprobado.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-233">First, you will populate values for FullName and Link, and then later, you will get the verified value.</span></span>

<span data-ttu-id="2b8ed-234">Para recuperar los datos de usuario adicionales, abra el **AccountController.cs** de archivos en el **controladores** carpeta.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-234">To retrieve the additional user data, open the **AccountController.cs** file in the **Controllers** folder.</span></span>

<span data-ttu-id="2b8ed-235">Este archivo contiene la lógica para el registro, registrar y administrar cuentas.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-235">This file contains the logic for logging, registering, and managing accounts.</span></span> <span data-ttu-id="2b8ed-236">En concreto, tenga en cuenta los métodos llamados **ExternalLoginCallback** y **ExternalLoginConfirmation**.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-236">In particular, notice the methods called **ExternalLoginCallback** and **ExternalLoginConfirmation**.</span></span> <span data-ttu-id="2b8ed-237">Dentro de estos métodos, puede agregar código para personalizar las operaciones de inicio de sesión externo para la aplicación.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-237">Within these methods, you can add code to customize external login operations for your application.</span></span> <span data-ttu-id="2b8ed-238">La primera línea de la **ExternalLoginCallback** contiene el método:</span><span class="sxs-lookup"><span data-stu-id="2b8ed-238">The first line of the **ExternalLoginCallback** method contains:</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample7.cs)]

<span data-ttu-id="2b8ed-239">Datos de usuario adicionales que se pasan en el **ExtraData** propiedad de la **AuthenticationResult** objeto que se devuelve desde el **VerifyAuthentication** método.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-239">Additional user data is passed back in the **ExtraData** property of the **AuthenticationResult** object that is returned from the **VerifyAuthentication** method.</span></span> <span data-ttu-id="2b8ed-240">El cliente de Facebook contiene los siguientes valores en el **ExtraData** propiedad:</span><span class="sxs-lookup"><span data-stu-id="2b8ed-240">The Facebook client contains the following values in the **ExtraData** property:</span></span>

- <span data-ttu-id="2b8ed-241">id</span><span class="sxs-lookup"><span data-stu-id="2b8ed-241">id</span></span>
- <span data-ttu-id="2b8ed-242">name</span><span class="sxs-lookup"><span data-stu-id="2b8ed-242">name</span></span>
- <span data-ttu-id="2b8ed-243">link</span><span class="sxs-lookup"><span data-stu-id="2b8ed-243">link</span></span>
- <span data-ttu-id="2b8ed-244">sexo</span><span class="sxs-lookup"><span data-stu-id="2b8ed-244">gender</span></span>
- <span data-ttu-id="2b8ed-245">accesstoken</span><span class="sxs-lookup"><span data-stu-id="2b8ed-245">accesstoken</span></span>

<span data-ttu-id="2b8ed-246">Otros proveedores tendrá datos similar pero ligeramente distintos en la propiedad ExtraData.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-246">Other providers will have similar but slightly different data in the ExtraData property.</span></span>

<span data-ttu-id="2b8ed-247">Si el usuario es nuevo en su sitio, recuperar algunos de los datos adicionales y pasar datos a la vista de confirmación.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-247">If the user is new to your site, you will retrieve some the additional data and pass that data to the confirmation view.</span></span> <span data-ttu-id="2b8ed-248">El último bloque de código en el método se ejecuta sólo si el usuario es nuevo en su sitio.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-248">The last block of code in the method is run only if the user is new to your site.</span></span> <span data-ttu-id="2b8ed-249">Reemplace la línea siguiente:</span><span class="sxs-lookup"><span data-stu-id="2b8ed-249">Replace the following line:</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample8.cs)]

<span data-ttu-id="2b8ed-250">Con esta línea:</span><span class="sxs-lookup"><span data-stu-id="2b8ed-250">With this line:</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample9.cs)]

<span data-ttu-id="2b8ed-251">Este cambio simplemente incluye los valores de las propiedades FullName y vínculo.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-251">This change merely includes values for the FullName and Link properties.</span></span>

<span data-ttu-id="2b8ed-252">En el **ExternalLoginConfirmation** método, modifique el código tal como se muestra a continuación para guardar la información adicional del usuario.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-252">In the **ExternalLoginConfirmation** method, modify the code as highlighted below to save the additional user information.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample10.cs?highlight=4,7-13)]

## <a name="adjusting-the-view"></a><span data-ttu-id="2b8ed-253">Ajuste de la vista</span><span class="sxs-lookup"><span data-stu-id="2b8ed-253">Adjusting the view</span></span>

<span data-ttu-id="2b8ed-254">Los datos de usuario adicionales que recuperan desde el proveedor se mostrará en la página de registro.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-254">The additional user data that you retrieve from the provider will be displayed in the registration page.</span></span>

<span data-ttu-id="2b8ed-255">En el **vistas**/**cuenta** carpeta abierta **ExternalLoginConfirmation.cshtml**.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-255">In the **Views**/**Account** folder, open **ExternalLoginConfirmation.cshtml**.</span></span> <span data-ttu-id="2b8ed-256">Debajo del campo existente para el nombre de usuario, agregar campos para FullName, vínculo y PictureLink.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-256">Below the existing field for user name, add fields for FullName, Link, and PictureLink.</span></span>

[!code-cshtml[Main](using-oauth-providers-with-mvc/samples/sample11.cshtml)]

<span data-ttu-id="2b8ed-257">Ya está casi listo para ejecutar la aplicación y registrar un nuevo usuario con la información adicional que se guardó.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-257">You are now almost ready to run the application and register a new user with the additional information saved.</span></span> <span data-ttu-id="2b8ed-258">Debe tener una cuenta que ya no está registrada con el sitio.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-258">You must have an account that is not already registered with the site.</span></span> <span data-ttu-id="2b8ed-259">Puede usar una cuenta de prueba diferente, o eliminar las filas de la **UserProfile** y **páginas Web\_OAuthMembership** tablas para la cuenta que desea volver a usar.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-259">You can either use a different test account, or delete the rows in the **UserProfile** and **webpages\_OAuthMembership** tables for the account you wish to reuse.</span></span> <span data-ttu-id="2b8ed-260">Eliminando las filas, se asegurará de que la cuenta se vuelve a registrar.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-260">By deleting those rows, you will ensure that the account is registered again.</span></span>

<span data-ttu-id="2b8ed-261">Ejecute la aplicación y registrar el nuevo usuario.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-261">Run the application and register the new user.</span></span> <span data-ttu-id="2b8ed-262">Tenga en cuenta que esta vez la página de confirmación contiene más valores.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-262">Notice that this time the confirmation page contains more values.</span></span>

![register](using-oauth-providers-with-mvc/_static/image12.png)

<span data-ttu-id="2b8ed-264">Después de completar el registro, cierre el explorador.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-264">After completing registration, close the browser.</span></span> <span data-ttu-id="2b8ed-265">Buscar en la base de datos tenga en cuenta los nuevos valores en el **ExtraUserInformation** tabla.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-265">Look in the database to notice the new values in the **ExtraUserInformation** table.</span></span>

## <a name="install-nuget-package-for-facebook-api"></a><span data-ttu-id="2b8ed-266">Instale el paquete NuGet para la API de Facebook</span><span class="sxs-lookup"><span data-stu-id="2b8ed-266">Install NuGet package for Facebook API</span></span>

<span data-ttu-id="2b8ed-267">Facebook proporciona un [API](https://developers.facebook.com/docs/reference/apis/) que puede llamar para realizar operaciones.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-267">Facebook provides an [API](https://developers.facebook.com/docs/reference/apis/) that you can call to perform operations.</span></span> <span data-ttu-id="2b8ed-268">Puede llamar a la API de Facebook dirigiendo el envío de solicitudes HTTP, o mediante el uso de instalación de un paquete de NuGet que facilita el envío de dichas solicitudes.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-268">You can call the Facebook API either by directing sending HTTP requests, or by using installing a NuGet package that facilitates sending those requests.</span></span> <span data-ttu-id="2b8ed-269">Mediante un paquete de NuGet se muestra en este tutorial, pero la instalación de NuGet paquete no es esencial.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-269">Using a NuGet package is shown in this tutorial, but installing NuGet package is not essential.</span></span> <span data-ttu-id="2b8ed-270">Este tutorial muestra cómo usar el paquete del SDK de Facebook C#.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-270">This tutorial shows how to use the Facebook C# SDK package.</span></span> <span data-ttu-id="2b8ed-271">Hay otros paquetes de NuGet que ayudan con una llamada a la API de Facebook.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-271">There are other NuGet packages that assist with calling the Facebook API.</span></span>

<span data-ttu-id="2b8ed-272">Desde el **administrar paquetes de NuGet** windows, seleccione el paquete de C# SDK de Facebook.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-272">From the **Manage NuGet Packages** windows, select the Facebook C# SDK package.</span></span>

![Instalar paquete](using-oauth-providers-with-mvc/_static/image13.png)

<span data-ttu-id="2b8ed-274">Usará el SDK de Facebook C# para llamar a una operación que requiere el token de acceso para el usuario.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-274">You will use the Facebook C# SDK to call an operation that requires the access token for the user.</span></span> <span data-ttu-id="2b8ed-275">La sección siguiente muestra cómo obtener el token de acceso.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-275">The next section shows how to get the access token.</span></span>

## <a name="retrieve-access-token"></a><span data-ttu-id="2b8ed-276">Recuperar el token de acceso</span><span class="sxs-lookup"><span data-stu-id="2b8ed-276">Retrieve access token</span></span>

<span data-ttu-id="2b8ed-277">Proveedores externos más transmitir un token de acceso una vez comprobadas las credenciales del usuario.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-277">Most external providers pass back an access token after the user's credentials are verified.</span></span> <span data-ttu-id="2b8ed-278">Este token de acceso es muy importante porque permite llamar a las operaciones que solo están disponibles para los usuarios autenticados.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-278">This access token is very important because it enables you to call operations that are only available to authenticated users.</span></span> <span data-ttu-id="2b8ed-279">Por lo tanto, recuperar y almacenar el token de acceso es esencial cuando desea proporcionar más funcionalidad.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-279">Therefore, retrieving and storing the access token is essential when you want to provide more functionality.</span></span>

<span data-ttu-id="2b8ed-280">Dependiendo del proveedor externo, el token de acceso puede ser válido para solamente una cantidad limitada de tiempo.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-280">Depending on the external provider, the access token may be valid for only a limited amount of time.</span></span> <span data-ttu-id="2b8ed-281">Para asegurarse de que tiene un token de acceso válida, se lo recuperará cada vez que el usuario inicia sesión y almacenarla como un valor de sesión en lugar de guardarlo en una base de datos.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-281">To ensure that you have a valid access token, you will retrieve it each time the user logs in, and store it as a session value rather than save it to a database.</span></span>

<span data-ttu-id="2b8ed-282">En el **ExternalLoginCallback** método, también se pasa el token de acceso en el **ExtraData** propiedad de la **AuthenticationResult** objeto.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-282">In the **ExternalLoginCallback** method, the access token is also passed back in the **ExtraData** property of the **AuthenticationResult** object.</span></span> <span data-ttu-id="2b8ed-283">Agregue el código resaltado a **ExternalLoginCallback** para guardar el token de acceso en el **sesión** objeto.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-283">Add the highlighted code to **ExternalLoginCallback** to save the access token in the **Session** object.</span></span> <span data-ttu-id="2b8ed-284">Este código se ejecuta cada vez que el usuario inicia sesión con una cuenta de Facebook.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-284">This code is run every time the user logs in with a Facebook account.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample12.cs?highlight=11-14)]

<span data-ttu-id="2b8ed-285">Aunque en este ejemplo se recupera un token de acceso de Facebook, puede recuperar el token de acceso desde cualquier proveedor externo a través de la misma clave denominada &quot;accesstoken&quot;.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-285">Although this example retrieves an access token from Facebook, you can retrieve the access token from any external provider through the same key named &quot;accesstoken&quot;.</span></span>

## <a name="logging-off"></a><span data-ttu-id="2b8ed-286">Cerrar sesión</span><span class="sxs-lookup"><span data-stu-id="2b8ed-286">Logging off</span></span>

<span data-ttu-id="2b8ed-287">El valor predeterminado **LogOff** método registra el usuario de su aplicación, pero no se sesión del usuario en el proveedor externo.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-287">The default **LogOff** method logs the user out of your application, but does not log the user out of the external provider.</span></span> <span data-ttu-id="2b8ed-288">Para la sesión del usuario en Facebook e impedir que el token de persistencia después de que el usuario ha cerrado sesión, puede agregar el código resaltado siguiente a la **LogOff** método AccountController.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-288">To log the user out of Facebook, and prevent the token from persisting after the user has logged off, you can add the following highlighted code to the **LogOff** method in the AccountController.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample13.cs?highlight=6-14)]

<span data-ttu-id="2b8ed-289">El valor que proporcione en el `next` parámetro es la dirección URL para usar después de que el usuario ha cerrado la sesión Facebook.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-289">The value you provide in the `next` parameter is the URL to use after the user has logged out of Facebook.</span></span> <span data-ttu-id="2b8ed-290">Al realizar pruebas en el equipo local, proporcionaría el número de puerto correcto para el sitio local.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-290">When testing on your local computer, you would provide the correct port number for your local site.</span></span> <span data-ttu-id="2b8ed-291">En producción, proporcionaría una página predeterminada, por ejemplo, contoso.com.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-291">In production, you would provide a default page, such as contoso.com.</span></span>

## <a name="retrieve-user-information-that-requires-the-access-token"></a><span data-ttu-id="2b8ed-292">Recuperar información de usuario que requiere el token de acceso</span><span class="sxs-lookup"><span data-stu-id="2b8ed-292">Retrieve user information that requires the access token</span></span>

<span data-ttu-id="2b8ed-293">Ahora que ha almacenado el token de acceso e instalado el paquete del SDK de Facebook C#, puede utilizarlos juntos para solicitar información adicional del usuario de Facebook.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-293">Now that you have stored the access token and installed the Facebook C# SDK package, you can use them together to request additional user information from Facebook.</span></span> <span data-ttu-id="2b8ed-294">En el **ExternalLoginConfirmation** método, cree una instancia de la **FacebookClient** clase pasando el valor del token de acceso.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-294">In the **ExternalLoginConfirmation** method, create an instance of the **FacebookClient** class by passing the value of the access token.</span></span> <span data-ttu-id="2b8ed-295">Solicitar el valor de la **comprobado** propiedad para el usuario autenticado actual.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-295">Request the value of the **verified** property for the current, authenticated user.</span></span> <span data-ttu-id="2b8ed-296">El **comprobado** propiedad indica si Facebook ha validado la cuenta a través de otros medios, como enviar un mensaje a un teléfono móvil.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-296">The **verified** property indicates whether Facebook has validated the account through some other means, such as sending a message to a cell phone.</span></span> <span data-ttu-id="2b8ed-297">Guarde este valor en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-297">Save this value in the database.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample14.cs?highlight=7-18,25)]

<span data-ttu-id="2b8ed-298">Nuevamente, deberá eliminar los registros de la base de datos para el usuario, o usar otra cuenta de Facebook.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-298">You will again need to either delete the records in the database for the user, or use a different Facebook account.</span></span>

<span data-ttu-id="2b8ed-299">Ejecute la aplicación y registrar el nuevo usuario.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-299">Run the application, and register the new user.</span></span> <span data-ttu-id="2b8ed-300">Examine el **ExtraUserInformation** tabla para ver el valor de la propiedad comprobado.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-300">Look at the **ExtraUserInformation** table to see the value for the Verified property.</span></span>

## <a name="conclusion"></a><span data-ttu-id="2b8ed-301">Conclusión</span><span class="sxs-lookup"><span data-stu-id="2b8ed-301">Conclusion</span></span>

<span data-ttu-id="2b8ed-302">En este tutorial, ha creado un sitio que se integra con Facebook para la autenticación de usuario y datos de registro.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-302">In this tutorial, you created a site that is integrated with Facebook for user authentication and registration data.</span></span> <span data-ttu-id="2b8ed-303">Ha aprendido sobre el comportamiento predeterminado que está configurado para que la aplicación web MVC 4 y cómo personalizar el comportamiento predeterminado.</span><span class="sxs-lookup"><span data-stu-id="2b8ed-303">You learned about the default behavior that is set up for MVC 4 web application, and how to customize that default behavior.</span></span>

## <a name="related-topics"></a><span data-ttu-id="2b8ed-304">Temas relacionados</span><span class="sxs-lookup"><span data-stu-id="2b8ed-304">Related topics</span></span>

- [<span data-ttu-id="2b8ed-305">Crear una aplicación ASP.NET MVC con la autenticación y base de datos SQL e implementar en Azure App Service</span><span class="sxs-lookup"><span data-stu-id="2b8ed-305">Create an ASP.NET MVC app with auth and SQL DB and deploy to Azure App Service</span></span>](https://docs.microsoft.com/aspnet/core/security/authorization/secure-data)
