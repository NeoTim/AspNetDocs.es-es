---
uid: aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
title: Servidor de autorización OWIN OAuth 2.0 Microsoft Docs
author: hongyes
description: Este tutorial le guiará sobre cómo implementar un servidor de autorización de OAuth 2.0 mediante el middleware OWIN OAuth. Este es un tutorial avanzado que sólo outlin...
ms.author: riande
ms.date: 03/20/2014
ms.assetid: 20acee16-c70c-41e9-b38f-92bfcf9a4c1c
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
msc.type: authoredcontent
ms.openlocfilehash: d758fa2639d10e1b7be8d87c5d1f7adb7e292ac7
ms.sourcegitcommit: 022f79dbc1350e0c6ffaa1e7e7c6e850cdabf9af
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 04/17/2020
ms.locfileid: "81540429"
---
<a name="owin-oauth-20-authorization-server"></a><span data-ttu-id="76440-104">Servidor de autorización de OAuth 2.0 de OWIN</span><span class="sxs-lookup"><span data-stu-id="76440-104">OWIN OAuth 2.0 Authorization Server</span></span>
====================
<span data-ttu-id="76440-105">por [Hongye Sun](https://github.com/hongyes) y [Praburaj Thiagarajan](https://github.com/Praburaj)</span><span class="sxs-lookup"><span data-stu-id="76440-105">by [Hongye Sun](https://github.com/hongyes) and [Praburaj Thiagarajan](https://github.com/Praburaj)</span></span>

> <span data-ttu-id="76440-106">Este tutorial le guiará sobre cómo implementar un servidor de autorización de OAuth 2.0 mediante el middleware OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="76440-106">This tutorial will guide you on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span> <span data-ttu-id="76440-107">Este es un tutorial avanzado que solo describe los pasos para crear un servidor de autorización OWIN OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="76440-107">This is an advanced tutorial that only outlines the steps to create an OWIN OAuth 2.0 Authorization Server.</span></span> <span data-ttu-id="76440-108">Este no es un tutorial paso a paso.</span><span class="sxs-lookup"><span data-stu-id="76440-108">This is not a step by step tutorial.</span></span> <span data-ttu-id="76440-109">[Descargue el código de ejemplo](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span><span class="sxs-lookup"><span data-stu-id="76440-109">[Download the sample code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span></span>
>
> > [!NOTE]
> > <span data-ttu-id="76440-110">Este esquema no debe estar pensado para usarse para crear una aplicación de producción segura.</span><span class="sxs-lookup"><span data-stu-id="76440-110">This outline should not be intended to be used for creating a secure production app.</span></span> <span data-ttu-id="76440-111">Este tutorial está diseñado para proporcionar solo un esquema sobre cómo implementar un servidor de autorización de OAuth 2.0 mediante el middleware OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="76440-111">This tutorial is intended to provide only an outline on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span>
>
>
> ## <a name="software-versions"></a><span data-ttu-id="76440-112">Versiones de software</span><span class="sxs-lookup"><span data-stu-id="76440-112">Software versions</span></span>
>
> | <span data-ttu-id="76440-113">**Se muestra en el tutorial**</span><span class="sxs-lookup"><span data-stu-id="76440-113">**Shown in the tutorial**</span></span> | <span data-ttu-id="76440-114">**También funciona con**</span><span class="sxs-lookup"><span data-stu-id="76440-114">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="76440-115">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="76440-115">Windows 8.1</span></span> | <span data-ttu-id="76440-116">Windows 8, Windows 7</span><span class="sxs-lookup"><span data-stu-id="76440-116">Windows 8, Windows 7</span></span> |
> | [<span data-ttu-id="76440-117">Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="76440-117">Visual Studio 2013</span></span>](https://my.visualstudio.com/Downloads?q=visual%20studio%202013) | <span data-ttu-id="76440-118">[Visual Studio 2013 Express para escritorio](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express).</span><span class="sxs-lookup"><span data-stu-id="76440-118">[Visual Studio 2013 Express for Desktop](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express).</span></span> <span data-ttu-id="76440-119">Visual Studio 2012 con la actualización más reciente debería funcionar, pero el tutorial no se ha probado con él, y algunas selecciones de menú y cuadros de diálogo son diferentes.</span><span class="sxs-lookup"><span data-stu-id="76440-119">Visual Studio 2012 with the latest update should work, but the tutorial has not been tested with it, and some menu selections and dialog boxes are different.</span></span> |
> | <span data-ttu-id="76440-120">.NET 4.5</span><span class="sxs-lookup"><span data-stu-id="76440-120">.NET 4.5</span></span> |  |
>
> ## <a name="questions-and-comments"></a><span data-ttu-id="76440-121">Preguntas y comentarios</span><span class="sxs-lookup"><span data-stu-id="76440-121">Questions and Comments</span></span>
>
> <span data-ttu-id="76440-122">Si tiene preguntas que no están directamente relacionadas con el tutorial, puede publicarlas en [Katana Project en GitHub](https://github.com/aspnet/AspNetKatana/).</span><span class="sxs-lookup"><span data-stu-id="76440-122">If you have questions that are not directly related to the tutorial, you can post them at [Katana Project on GitHub](https://github.com/aspnet/AspNetKatana/).</span></span> <span data-ttu-id="76440-123">Para preguntas y comentarios sobre el tutorial en sí, consulte la sección de comentarios en la parte inferior de la página.</span><span class="sxs-lookup"><span data-stu-id="76440-123">For questions and comments regarding the tutorial itself, see the comments section at the bottom of the page.</span></span>


<span data-ttu-id="76440-124">El marco de trabajo de [OAuth 2.0](http://tools.ietf.org/html/rfc6749) permite que una aplicación de terceros obtenga acceso limitado a un servicio HTTP.</span><span class="sxs-lookup"><span data-stu-id="76440-124">The [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) enables a third-party app to obtain limited access to an HTTP service.</span></span> <span data-ttu-id="76440-125">En lugar de usar las credenciales del propietario del recurso para tener acceso a un recurso protegido, el cliente obtiene un token de acceso (que es una cadena que indica un ámbito, una duración y otros atributos de acceso específicos).</span><span class="sxs-lookup"><span data-stu-id="76440-125">Instead of using the resource owner's credentials to access a protected resource, the client obtains an access token (which is a string denoting a specific scope, lifetime, and other access attributes).</span></span> <span data-ttu-id="76440-126">Los tokens de acceso se emiten a clientes de terceros mediante un servidor de autorización con la aprobación del propietario del recurso.</span><span class="sxs-lookup"><span data-stu-id="76440-126">Access tokens are issued to third-party clients by an authorization server with the approval of the resource owner.</span></span>

<span data-ttu-id="76440-127">Este tutorial cubrirá:</span><span class="sxs-lookup"><span data-stu-id="76440-127">This tutorial will cover:</span></span>

- <span data-ttu-id="76440-128">Cómo crear un servidor de autorización para admitir cuatro tipos de concesión de autorización y actualizar tokens:</span><span class="sxs-lookup"><span data-stu-id="76440-128">How to create an authorization server to support four authorization grant types and refresh tokens:</span></span>
    - <span data-ttu-id="76440-129">Concesión del código de autorización</span><span class="sxs-lookup"><span data-stu-id="76440-129">Authorization code grant</span></span>
    - <span data-ttu-id="76440-130">Subvención implícita</span><span class="sxs-lookup"><span data-stu-id="76440-130">Implicit Grant</span></span>
    - <span data-ttu-id="76440-131">Concesión de credenciales de contraseña de propietario de recursos</span><span class="sxs-lookup"><span data-stu-id="76440-131">Resource Owner Password Credentials Grant</span></span>
    - <span data-ttu-id="76440-132">Concesión de credenciales de cliente</span><span class="sxs-lookup"><span data-stu-id="76440-132">Client Credentials Grant</span></span>
- <span data-ttu-id="76440-133">Creación de un servidor de recursos protegido por un token de acceso.</span><span class="sxs-lookup"><span data-stu-id="76440-133">Creating a resource server which is protected by an access token.</span></span>
- <span data-ttu-id="76440-134">Creación de clientes de OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="76440-134">Creating OAuth 2.0 clients.</span></span>

<a id="prerequisites"></a>
## <a name="prerequisites"></a><span data-ttu-id="76440-135">Prerrequisitos</span><span class="sxs-lookup"><span data-stu-id="76440-135">Prerequisites</span></span>

- <span data-ttu-id="76440-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) o [visual Studio Express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express)gratuito, como se indica en **Versiones** de software en la parte superior de la página.</span><span class="sxs-lookup"><span data-stu-id="76440-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) or the free [Visual Studio Express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express), as indicated in **Software Versions** at the top of the page.</span></span>
- <span data-ttu-id="76440-137">Familiaridad con OWIN.</span><span class="sxs-lookup"><span data-stu-id="76440-137">Familiarity with OWIN.</span></span> <span data-ttu-id="76440-138">Consulte [Introducción al proyecto Katana](https://msdn.microsoft.com/magazine/dn451439.aspx) y [Novedades de OWIN y Katana](index.md).</span><span class="sxs-lookup"><span data-stu-id="76440-138">See [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx) and [What's new in OWIN and Katana](index.md).</span></span>
- <span data-ttu-id="76440-139">Familiaridad con la terminología de [OAuth,](http://tools.ietf.org/html/rfc6749) incluidos [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [Flujo de protocolo](http://tools.ietf.org/html/rfc6749#section-1.2)y Concesión de [autorización](http://tools.ietf.org/html/rfc6749#section-1.3).</span><span class="sxs-lookup"><span data-stu-id="76440-139">Familiarity with [OAuth](http://tools.ietf.org/html/rfc6749) terminology, including [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), and [Authorization Grant](http://tools.ietf.org/html/rfc6749#section-1.3).</span></span> <span data-ttu-id="76440-140">[La introducción de OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-1) proporciona una buena introducción.</span><span class="sxs-lookup"><span data-stu-id="76440-140">[OAuth 2.0 introduction](http://tools.ietf.org/html/rfc6749#section-1) provides a good introduction.</span></span>

## <a name="create-an-authorization-server"></a><span data-ttu-id="76440-141">Crear un servidor de autorización</span><span class="sxs-lookup"><span data-stu-id="76440-141">Create an Authorization Server</span></span>

<span data-ttu-id="76440-142">En este tutorial, esbozaremos aproximadamente cómo usar [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) y ASP.NET MVC para crear un servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="76440-142">In this tutorial, we will roughly sketch out how to use [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) and ASP.NET MVC to create an authorization server.</span></span> <span data-ttu-id="76440-143">Esperamos proporcionar pronto una descarga para el ejemplo completado, ya que este tutorial no incluye cada paso.</span><span class="sxs-lookup"><span data-stu-id="76440-143">We hope to soon provide a download for the completed sample, as this tutorial does not include each step.</span></span> <span data-ttu-id="76440-144">En primer lugar, cree una aplicación web vacía denominada *AuthorizationServer* e instale los siguientes paquetes:</span><span class="sxs-lookup"><span data-stu-id="76440-144">First, create an empty web app named *AuthorizationServer* and install the following packages:</span></span>

- <span data-ttu-id="76440-145">Microsoft.AspNet.Mvc</span><span class="sxs-lookup"><span data-stu-id="76440-145">Microsoft.AspNet.Mvc</span></span>
- <span data-ttu-id="76440-146">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="76440-146">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="76440-147">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="76440-147">Microsoft.Owin.Security.OAuth</span></span>
- <span data-ttu-id="76440-148">Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="76440-148">Microsoft.Owin.Security.Cookies</span></span>
- <span data-ttu-id="76440-149">Microsoft.Owin.Security.Google (O cualquier otro paquete de inicio de sesión social como Microsoft.Owin.Security.Facebook)</span><span class="sxs-lookup"><span data-stu-id="76440-149">Microsoft.Owin.Security.Google (Or any other social login package such as Microsoft.Owin.Security.Facebook)</span></span>

<span data-ttu-id="76440-150">Agregue una [clase de inicio de OWIN](owin-startup-class-detection.md) en la carpeta raíz del proyecto denominada *Inicio*.</span><span class="sxs-lookup"><span data-stu-id="76440-150">Add an [OWIN Startup class](owin-startup-class-detection.md) under the project root folder named *Startup*.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample1.cs?highlight=8)]

<span data-ttu-id="76440-151">Cree una carpeta de inicio de *aplicación.\_*</span><span class="sxs-lookup"><span data-stu-id="76440-151">Create an *App\_Start* folder.</span></span> <span data-ttu-id="76440-152">Seleccione la carpeta Inicio de la *aplicación\_* y use Mayús+Alt+A para agregar la versión descargada del archivo *AuthorizationServer-App\_Start-Startup.Auth.cs.*</span><span class="sxs-lookup"><span data-stu-id="76440-152">Select the *App\_Start* folder and use Shift+Alt+A to add the downloaded version of the *AuthorizationServer\App\_Start\Startup.Auth.cs* file.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample2.cs)]

<span data-ttu-id="76440-153">El código anterior habilita las cookies de inicio de sesión de aplicaciones/externas y la autenticación de Google, que son utilizadas por el propio servidor de autorización para administrar cuentas.</span><span class="sxs-lookup"><span data-stu-id="76440-153">The code above enables application/external sign in cookies and Google authentication, which are used by authorization server itself to manage accounts.</span></span>

<span data-ttu-id="76440-154">El `UseOAuthAuthorizationServer` método de extensión consiste en configurar el servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="76440-154">The `UseOAuthAuthorizationServer` extension method is to setup the authorization server.</span></span> <span data-ttu-id="76440-155">Las opciones de configuración son:</span><span class="sxs-lookup"><span data-stu-id="76440-155">The setup options are:</span></span>

- <span data-ttu-id="76440-156">`AuthorizeEndpointPath`: la ruta de acceso de solicitud donde las aplicaciones cliente redirigirán el agente de usuario con el fin de obtener el consentimiento de los usuarios para emitir un token o código.</span><span class="sxs-lookup"><span data-stu-id="76440-156">`AuthorizeEndpointPath`: The request path where client applications will redirect the user-agent in order to obtain the users consent to issue a token or code.</span></span> <span data-ttu-id="76440-157">Debe comenzar con una barra diagonal`/Authorize`inicial, por ejemplo, "..</span><span class="sxs-lookup"><span data-stu-id="76440-157">It must begin with a leading slash, for example, "`/Authorize`".</span></span>
- <span data-ttu-id="76440-158">`TokenEndpointPath`: las aplicaciones cliente de ruta de acceso de solicitud se comunican directamente para obtener el token de acceso.</span><span class="sxs-lookup"><span data-stu-id="76440-158">`TokenEndpointPath`: The request path client applications directly communicate to obtain the access token.</span></span> <span data-ttu-id="76440-159">Debe comenzar con una barra diagonal inicial, como "/Token".</span><span class="sxs-lookup"><span data-stu-id="76440-159">It must begin with a leading slash, like "/Token".</span></span> <span data-ttu-id="76440-160">Si se emite un secreto de [cliente\_](http://tools.ietf.org/html/rfc6749#appendix-A.2)al cliente, se debe proporcionar a este punto de conexión.</span><span class="sxs-lookup"><span data-stu-id="76440-160">If the client is issued a [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), it must be provided to this endpoint.</span></span>
- <span data-ttu-id="76440-161">`ApplicationCanDisplayErrors`: se `true` establece en si la aplicación web desea generar `/Authorize` una página de error personalizada para los errores de validación de cliente en el punto de conexión.</span><span class="sxs-lookup"><span data-stu-id="76440-161">`ApplicationCanDisplayErrors`: Set to `true` if the web application wants to generate a custom error page for the client validation errors on `/Authorize` endpoint.</span></span> <span data-ttu-id="76440-162">Esto sólo es necesario para los casos en los que el explorador `client_id` no `redirect_uri` se redirige de nuevo a la aplicación cliente, por ejemplo, cuando el o son incorrectos.</span><span class="sxs-lookup"><span data-stu-id="76440-162">This is only needed for cases where the browser is not redirected back to the client application, for example, when the `client_id` or `redirect_uri` are incorrect.</span></span> <span data-ttu-id="76440-163">El `/Authorize` punto final debe esperar ver el "oauth. Error", "oauth. ErrorDescription" y "oauth. ErrorUri" se agregan al entorno OWIN.</span><span class="sxs-lookup"><span data-stu-id="76440-163">The `/Authorize` endpoint should expect to see the "oauth.Error", "oauth.ErrorDescription", and "oauth.ErrorUri" properties are added to the OWIN environment.</span></span>

    > [!NOTE]
    > <span data-ttu-id="76440-164">Si no es true, el servidor de autorización devolverá una página de error predeterminada con los detalles del error.</span><span class="sxs-lookup"><span data-stu-id="76440-164">If not true, the authorization server will return a default error page with the error details.</span></span>
- <span data-ttu-id="76440-165">`AllowInsecureHttp`: True para permitir que las solicitudes de autorización `redirect_uri` y token lleguen a direcciones URI HTTP y para permitir que los parámetros de solicitud de autorización entrantes tengan direcciones URI HTTP.</span><span class="sxs-lookup"><span data-stu-id="76440-165">`AllowInsecureHttp`: True to allow authorize and token requests to arrive on HTTP URI addresses, and to allow incoming `redirect_uri` authorize request parameters to have HTTP URI addresses.</span></span>

    > [!WARNING]
    > <span data-ttu-id="76440-166">Seguridad - Esto es sólo para el desarrollo.</span><span class="sxs-lookup"><span data-stu-id="76440-166">Security - This is for development only.</span></span>
- <span data-ttu-id="76440-167">`Provider`: el objeto proporcionado por la aplicación para procesar los eventos generados por el middleware del servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="76440-167">`Provider`: The object provided by the application to process events raised by the Authorization Server middleware.</span></span> <span data-ttu-id="76440-168">La aplicación puede implementar la interfaz completamente, `OAuthAuthorizationServerProvider` o puede crear una instancia y asignar delegados necesarios para los flujos de OAuth que admite este servidor.</span><span class="sxs-lookup"><span data-stu-id="76440-168">The application may implement the interface fully, or it may create an instance of `OAuthAuthorizationServerProvider` and assign delegates necessary for the OAuth flows this server supports.</span></span>
- <span data-ttu-id="76440-169">`AuthorizationCodeProvider`: produce un código de autorización de un solo uso para volver a la aplicación cliente.</span><span class="sxs-lookup"><span data-stu-id="76440-169">`AuthorizationCodeProvider`: Produces a single-use authorization code to return to the client application.</span></span> <span data-ttu-id="76440-170">Para que el servidor de OAuth sea `AuthorizationCodeProvider` seguro, la aplicación `OnCreate/OnCreateAsync` **DEBE** proporcionar una instancia para `OnReceive/OnReceiveAsync`donde el token generado por el evento se considera válido para una sola llamada a .</span><span class="sxs-lookup"><span data-stu-id="76440-170">For the OAuth server to be secure the application **MUST** provide an instance for `AuthorizationCodeProvider` where the token produced by the `OnCreate/OnCreateAsync` event is considered valid for only one call to `OnReceive/OnReceiveAsync`.</span></span>
- <span data-ttu-id="76440-171">`RefreshTokenProvider`: produce un token de actualización que se puede utilizar para producir un nuevo token de acceso cuando sea necesario.</span><span class="sxs-lookup"><span data-stu-id="76440-171">`RefreshTokenProvider`: Produces a refresh token which may be used to produce a new access token when needed.</span></span> <span data-ttu-id="76440-172">Si no se proporciona, el servidor `/Token` de autorización no devolverá tokens de actualización del punto de conexión.</span><span class="sxs-lookup"><span data-stu-id="76440-172">If not provided the authorization server will not return refresh tokens from the `/Token` endpoint.</span></span>

## <a name="account-management"></a><span data-ttu-id="76440-173">Administración de cuentas</span><span class="sxs-lookup"><span data-stu-id="76440-173">Account Management</span></span>

<span data-ttu-id="76440-174">A OAuth no le importa dónde ni cómo administre la información de su cuenta de usuario.</span><span class="sxs-lookup"><span data-stu-id="76440-174">OAuth doesn't care where or how you manage your user account information.</span></span> <span data-ttu-id="76440-175">Es [ASP.NET identidad](../../../identity/index.md) la que es responsable de ello.</span><span class="sxs-lookup"><span data-stu-id="76440-175">It's [ASP.NET Identity](../../../identity/index.md) which is responsible for it.</span></span> <span data-ttu-id="76440-176">En este tutorial, simplificaremos el código de administración de la cuenta y solo nos aseguraremos de que el usuario pueda iniciar sesión mediante el middleware de cookies OWIN.</span><span class="sxs-lookup"><span data-stu-id="76440-176">In this tutorial, we will simplify the account management code and just make sure that user can login using OWIN cookie middleware.</span></span> <span data-ttu-id="76440-177">Aquí está el código `AccountController`de ejemplo simplificado para:</span><span class="sxs-lookup"><span data-stu-id="76440-177">Here is the simplified sample code for the `AccountController`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample3.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample4.cs?highlight=1)]

<span data-ttu-id="76440-178">`ValidateClientRedirectUri`se utiliza para validar al cliente con su URL de redireccionamiento registrada.</span><span class="sxs-lookup"><span data-stu-id="76440-178">`ValidateClientRedirectUri` is used to validate the client with its registered redirect URL.</span></span> <span data-ttu-id="76440-179">`ValidateClientAuthentication`comprueba el encabezado de esquema básico y el cuerpo del formulario para obtener las credenciales del cliente.</span><span class="sxs-lookup"><span data-stu-id="76440-179">`ValidateClientAuthentication` checks the basic scheme header and form body to get the client's credentials.</span></span>

<span data-ttu-id="76440-180">La página de inicio de sesión se muestra a continuación:</span><span class="sxs-lookup"><span data-stu-id="76440-180">The login page is shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image1.png)

<span data-ttu-id="76440-181">Revise ahora la sección Concesión de código de [autorización](http://tools.ietf.org/html/rfc6749#section-4.1) oauth 2 del IETF.</span><span class="sxs-lookup"><span data-stu-id="76440-181">Review the IETF's OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) section now.</span></span>

<span data-ttu-id="76440-182">**El proveedor** (en la tabla siguiente) es [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx). Proveedor, que es `OAuthAuthorizationServerProvider`de tipo , que contiene todos los eventos del servidor OAuth.</span><span class="sxs-lookup"><span data-stu-id="76440-182">**Provider** (in the table below) is [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx).Provider, which is of type `OAuthAuthorizationServerProvider`, which contains all OAuth server events.</span></span>

| <span data-ttu-id="76440-183">Pasos de flujo de la sección Concesión de código de autorización</span><span class="sxs-lookup"><span data-stu-id="76440-183">Flow steps from Authorization Code Grant section</span></span> | <span data-ttu-id="76440-184">La descarga de ejemplo realiza estos pasos con:</span><span class="sxs-lookup"><span data-stu-id="76440-184">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="76440-185">(A) El cliente inicia el flujo dirigiendo el agente de usuario del propietario del recurso al punto de conexión de autorización.</span><span class="sxs-lookup"><span data-stu-id="76440-185">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="76440-186">El cliente incluye su identificador de cliente, el ámbito solicitado, el estado local y un URI de redirección al que el servidor de autorización enviará el agente de usuario una vez que se conceda (o deniegue) el acceso.</span><span class="sxs-lookup"><span data-stu-id="76440-186">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="76440-187">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="76440-187">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="76440-188">(B) El servidor de autorización autentica al propietario del recurso (a través del agente de usuario) y establece si el propietario del recurso concede o deniega la solicitud de acceso del cliente.</span><span class="sxs-lookup"><span data-stu-id="76440-188">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="76440-189">**Si el usuario concede acceso&gt; &lt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="76440-189">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="76440-190">(C) Suponiendo que el propietario del recurso concede acceso, el servidor de autorización redirige el agente de usuario al cliente mediante el URI de redirección proporcionado anteriormente (en la solicitud o durante el registro del cliente).</span><span class="sxs-lookup"><span data-stu-id="76440-190">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="76440-191">...</span><span class="sxs-lookup"><span data-stu-id="76440-191">...</span></span> |  |
|  |  |
| <span data-ttu-id="76440-192">(D) El cliente solicita un token de acceso desde el punto de conexión de token del servidor de autorización mediante la inclusión del código de autorización recibido en el paso anterior.</span><span class="sxs-lookup"><span data-stu-id="76440-192">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="76440-193">Al realizar la solicitud, el cliente se autentica con el servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="76440-193">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="76440-194">El cliente incluye el URI de redirección utilizado para obtener el código de autorización para la verificación.</span><span class="sxs-lookup"><span data-stu-id="76440-194">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> | <span data-ttu-id="76440-195">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="76440-195">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |

<span data-ttu-id="76440-196">A continuación `AuthorizationCodeProvider.CreateAsync` se `ReceiveAsync` muestra una implementación de ejemplo para y para controlar la creación y validación de código de autorización.</span><span class="sxs-lookup"><span data-stu-id="76440-196">A sample implementation for `AuthorizationCodeProvider.CreateAsync` and `ReceiveAsync` to control the creation and validation of authorization code is shown below.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample5.cs)]

<span data-ttu-id="76440-197">El código anterior utiliza un diccionario simultáneo en memoria para almacenar el código y el vale de identidad y restaurar la identidad después de recibir el código.</span><span class="sxs-lookup"><span data-stu-id="76440-197">The code above uses an in-memory concurrent dictionary to store the code and identity ticket and restore the identity after receiving the code.</span></span> <span data-ttu-id="76440-198">En una aplicación real, sería reemplazado por un almacén de datos persistente.</span><span class="sxs-lookup"><span data-stu-id="76440-198">In a real application, it would be replaced by a persistent data store.</span></span> <span data-ttu-id="76440-199">El punto de conexión de autorización es para que el propietario del recurso conceda acceso al cliente.</span><span class="sxs-lookup"><span data-stu-id="76440-199">The authorization endpoint is for the resource owner to grant access to the client.</span></span> <span data-ttu-id="76440-200">Por lo general, necesita una interfaz de usuario para permitir al usuario hacer clic en un botón y confirmar la concesión.</span><span class="sxs-lookup"><span data-stu-id="76440-200">Usually, it needs a user interface to allow the user to click a button and confirm the grant.</span></span> <span data-ttu-id="76440-201">El middleware OWIN OAuth permite que el código de aplicación controle el punto de conexión de autorización.</span><span class="sxs-lookup"><span data-stu-id="76440-201">OWIN OAuth middleware allows application code to handle the authorization endpoint.</span></span> <span data-ttu-id="76440-202">En nuestra aplicación de ejemplo, `OAuthController` usamos un controlador MVC llamado para controlarlo.</span><span class="sxs-lookup"><span data-stu-id="76440-202">In our sample app, we use an MVC controller called `OAuthController` to handle it.</span></span> <span data-ttu-id="76440-203">Aquí está la implementación de ejemplo:</span><span class="sxs-lookup"><span data-stu-id="76440-203">Here is the sample implementation:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample6.cs?highlight=15)]

<span data-ttu-id="76440-204">La `Authorize` acción comprobará primero si el usuario ha iniciado sesión en el servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="76440-204">The `Authorize` action will first check if the user has logged in to the authorization server.</span></span> <span data-ttu-id="76440-205">Si no es así, el middleware de autenticación desafía al autor de la llamada a autenticarse mediante la cookie "Aplicación" y redirige a la página de inicio de sesión.</span><span class="sxs-lookup"><span data-stu-id="76440-205">If not, the authentication middleware challenges the caller to authenticate using the "Application" cookie and redirects to the login page.</span></span> <span data-ttu-id="76440-206">(Véase el código resaltado arriba.) Si el usuario ha iniciado sesión, representará la vista Autorizar, como se muestra a continuación:</span><span class="sxs-lookup"><span data-stu-id="76440-206">(See highlighted code above.) If user has logged in, it will render the Authorize view, as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image2.png)

<span data-ttu-id="76440-207">Si se selecciona el `Authorize` botón **Conceder,** la acción creará una nueva identidad "Portador" e iniciará sesión con ella.</span><span class="sxs-lookup"><span data-stu-id="76440-207">If the **Grant** button is selected, the `Authorize` action will create a new "Bearer" identity and sign in with it.</span></span> <span data-ttu-id="76440-208">Desencadenará el servidor de autorización para generar un token de portador y enviarlo de vuelta al cliente con carga JSON.</span><span class="sxs-lookup"><span data-stu-id="76440-208">It will trigger the authorization server to generate a bearer token and send it back to the client with JSON payload.</span></span>

### <a name="implicit-grant"></a><span data-ttu-id="76440-209">Subvención implícita</span><span class="sxs-lookup"><span data-stu-id="76440-209">Implicit Grant</span></span>

<span data-ttu-id="76440-210">Refiera a la sección de la [concesión implícita de](http://tools.ietf.org/html/rfc6749#section-4.2) OAuth 2 del IETF ahora.</span><span class="sxs-lookup"><span data-stu-id="76440-210">Refer to the IETF's OAuth 2 [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) section now.</span></span>

 <span data-ttu-id="76440-211">El flujo [de concesión implícita](http://tools.ietf.org/html/rfc6749#section-4.2) que se muestra en la figura 4 es el flujo y la asignación que sigue el middleware OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="76440-211">The [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) flow shown in Figure 4 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="76440-212">Pasos de flujo de la sección Subvención implícita</span><span class="sxs-lookup"><span data-stu-id="76440-212">Flow steps from Implicit Grant section</span></span> | <span data-ttu-id="76440-213">La descarga de ejemplo realiza estos pasos con:</span><span class="sxs-lookup"><span data-stu-id="76440-213">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="76440-214">(A) El cliente inicia el flujo dirigiendo el agente de usuario del propietario del recurso al punto de conexión de autorización.</span><span class="sxs-lookup"><span data-stu-id="76440-214">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="76440-215">El cliente incluye su identificador de cliente, el ámbito solicitado, el estado local y un URI de redirección al que el servidor de autorización enviará el agente de usuario una vez que se conceda (o deniegue) el acceso.</span><span class="sxs-lookup"><span data-stu-id="76440-215">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="76440-216">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="76440-216">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="76440-217">(B) El servidor de autorización autentica al propietario del recurso (a través del agente de usuario) y establece si el propietario del recurso concede o deniega la solicitud de acceso del cliente.</span><span class="sxs-lookup"><span data-stu-id="76440-217">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="76440-218">**Si el usuario concede acceso&gt; &lt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="76440-218">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="76440-219">(C) Suponiendo que el propietario del recurso concede acceso, el servidor de autorización redirige el agente de usuario al cliente mediante el URI de redirección proporcionado anteriormente (en la solicitud o durante el registro del cliente).</span><span class="sxs-lookup"><span data-stu-id="76440-219">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="76440-220">...</span><span class="sxs-lookup"><span data-stu-id="76440-220">...</span></span> |  |
|  |  |
| <span data-ttu-id="76440-221">(D) El cliente solicita un token de acceso desde el punto de conexión de token del servidor de autorización mediante la inclusión del código de autorización recibido en el paso anterior.</span><span class="sxs-lookup"><span data-stu-id="76440-221">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="76440-222">Al realizar la solicitud, el cliente se autentica con el servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="76440-222">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="76440-223">El cliente incluye el URI de redirección utilizado para obtener el código de autorización para la verificación.</span><span class="sxs-lookup"><span data-stu-id="76440-223">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> |  |

<span data-ttu-id="76440-224">Puesto que ya hemos`OAuthController.Authorize` implementado el punto final de autorización (acción) para la concesión de código de autorización, habilita automáticamente el flujo implícito también.</span><span class="sxs-lookup"><span data-stu-id="76440-224">Since we already implemented the authorization endpoint (`OAuthController.Authorize` action) for authorization code grant, it automatically enables implicit flow as well.</span></span> <span data-ttu-id="76440-225">Nota: `Provider.ValidateClientRedirectUri` se utiliza para validar el ID de cliente con su URL de redirección, que protege el flujo de concesión implícito de enviar el token de acceso a los clientes malintencionados (ataque del[hombre en el medio).](https://www.owasp.org/index.php/Man-in-the-middle_attack)</span><span class="sxs-lookup"><span data-stu-id="76440-225">Note: `Provider.ValidateClientRedirectUri` is used to validate the client ID with its redirection URL, which protects the implicit grant flow from sending the access token to malicious clients ([Man-in-the-middle attack](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span></span>

### <a name="resource-owner-password-credentials-grant"></a><span data-ttu-id="76440-226">Concesión de credenciales de contraseña de propietario de recursos</span><span class="sxs-lookup"><span data-stu-id="76440-226">Resource Owner Password Credentials Grant</span></span>

<span data-ttu-id="76440-227">Refiera a la sección de la concesión de [credenciales](http://tools.ietf.org/html/rfc6749#section-4.3) del propietario del recurso OAuth 2 del IETF ahora.</span><span class="sxs-lookup"><span data-stu-id="76440-227">Refer to the IETF's OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) section now.</span></span>

 <span data-ttu-id="76440-228">El flujo [de concesión](http://tools.ietf.org/html/rfc6749#section-4.3) de credenciales de contraseña del propietario de recursos que se muestra en la figura 5 es el flujo y la asignación que sigue el middleware OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="76440-228">The [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) flow shown in Figure 5 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="76440-229">Pasos de flujo de la sección Concesión de credenciales de contraseña de propietario de recursos</span><span class="sxs-lookup"><span data-stu-id="76440-229">Flow steps from Resource Owner Password Credentials Grant section</span></span> | <span data-ttu-id="76440-230">La descarga de ejemplo realiza estos pasos con:</span><span class="sxs-lookup"><span data-stu-id="76440-230">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="76440-231">(A) El propietario del recurso proporciona al cliente su nombre de usuario y contraseña.</span><span class="sxs-lookup"><span data-stu-id="76440-231">(A) The resource owner provides the client with its username and password.</span></span> |  |
|  |  |
| <span data-ttu-id="76440-232">(B) El cliente solicita un token de acceso desde el punto de conexión de token del servidor de autorización mediante la inclusión de las credenciales recibidas del propietario del recurso.</span><span class="sxs-lookup"><span data-stu-id="76440-232">(B) The client requests an access token from the authorization server's token endpoint by including the credentials received from the resource owner.</span></span> <span data-ttu-id="76440-233">Al realizar la solicitud, el cliente se autentica con el servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="76440-233">When making the request, the client authenticates with the authorization server.</span></span> | <span data-ttu-id="76440-234">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="76440-234">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="76440-235">(C) El servidor de autorización autentica al cliente y valida las credenciales del propietario del recurso y, si es válida, emite un token de acceso.</span><span class="sxs-lookup"><span data-stu-id="76440-235">(C) The authorization server authenticates the client and validates the resource owner credentials, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="76440-236">Aquí está la `Provider.GrantResourceOwnerCredentials`implementación de ejemplo para:</span><span class="sxs-lookup"><span data-stu-id="76440-236">Here is the sample implementation for `Provider.GrantResourceOwnerCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample7.cs)]

> [!NOTE]
> <span data-ttu-id="76440-237">El código anterior está destinado a explicar esta sección del tutorial y no debe usarse en aplicaciones seguras o de producción.</span><span class="sxs-lookup"><span data-stu-id="76440-237">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="76440-238">No comprueba las credenciales de los propietarios de recursos.</span><span class="sxs-lookup"><span data-stu-id="76440-238">It does not check the resource owners credentials.</span></span> <span data-ttu-id="76440-239">Se supone que cada credencial es válida y crea una nueva identidad para ella.</span><span class="sxs-lookup"><span data-stu-id="76440-239">It assumes every credential is valid and creates a new identity for it.</span></span> <span data-ttu-id="76440-240">La nueva identidad se usará para generar el token de acceso y el token de actualización.</span><span class="sxs-lookup"><span data-stu-id="76440-240">The new identity will be used to generate the access token and refresh token.</span></span> <span data-ttu-id="76440-241">Sustituya el código por su propio código de administración de cuentas seguro.</span><span class="sxs-lookup"><span data-stu-id="76440-241">Please replace the code with your own secure account management code.</span></span>


### <a name="client-credentials-grant"></a><span data-ttu-id="76440-242">Concesión de credenciales de cliente</span><span class="sxs-lookup"><span data-stu-id="76440-242">Client Credentials Grant</span></span>

<span data-ttu-id="76440-243">Refiera a la sección de la concesión de [credenciales](http://tools.ietf.org/html/rfc6749#section-4.4) del cliente OAuth 2 del IETF ahora.</span><span class="sxs-lookup"><span data-stu-id="76440-243">Refer to the IETF's OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) section now.</span></span>

 <span data-ttu-id="76440-244">El flujo de concesión de [credenciales](http://tools.ietf.org/html/rfc6749#section-4.4) de cliente que se muestra en la figura 6 es el flujo y la asignación que sigue el middleware OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="76440-244">The [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) flow shown in Figure 6 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="76440-245">Pasos de flujo de la sección Concesión de credenciales de cliente</span><span class="sxs-lookup"><span data-stu-id="76440-245">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="76440-246">La descarga de ejemplo realiza estos pasos con:</span><span class="sxs-lookup"><span data-stu-id="76440-246">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="76440-247">(A) El cliente se autentica con el servidor de autorización y solicita un token de acceso desde el punto de conexión del token.</span><span class="sxs-lookup"><span data-stu-id="76440-247">(A) The client authenticates with the authorization server and requests an access token from the token endpoint.</span></span> | <span data-ttu-id="76440-248">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="76440-248">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="76440-249">(B) El servidor de autorización autentica al cliente y, si es válido, emite un token de acceso.</span><span class="sxs-lookup"><span data-stu-id="76440-249">(B) The authorization server authenticates the client, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="76440-250">Aquí está la `Provider.GrantClientCredentials`implementación de ejemplo para:</span><span class="sxs-lookup"><span data-stu-id="76440-250">Here is the sample implementation for `Provider.GrantClientCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample8.cs)]

> [!NOTE]
> <span data-ttu-id="76440-251">El código anterior está destinado a explicar esta sección del tutorial y no debe usarse en aplicaciones seguras o de producción.</span><span class="sxs-lookup"><span data-stu-id="76440-251">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="76440-252">Reemplace el código con su propio código de administración de cliente seguro.</span><span class="sxs-lookup"><span data-stu-id="76440-252">Please replace the code with your own secure client management code.</span></span>


### <a name="refresh-token"></a><span data-ttu-id="76440-253">Actualizar token</span><span class="sxs-lookup"><span data-stu-id="76440-253">Refresh Token</span></span>

<span data-ttu-id="76440-254">Refiera a la sección del [token](http://tools.ietf.org/html/rfc6749#section-1.5) de actualización de OAuth 2 del IETF ahora.</span><span class="sxs-lookup"><span data-stu-id="76440-254">Refer to the IETF's OAuth 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) section now.</span></span>

 <span data-ttu-id="76440-255">El flujo [de token](http://tools.ietf.org/html/rfc6749#section-1.5) de actualización que se muestra en la figura 2 es el flujo y la asignación que sigue el middleware OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="76440-255">The [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) flow shown in Figure 2 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="76440-256">Pasos de flujo de la sección Concesión de credenciales de cliente</span><span class="sxs-lookup"><span data-stu-id="76440-256">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="76440-257">La descarga de ejemplo realiza estos pasos con:</span><span class="sxs-lookup"><span data-stu-id="76440-257">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="76440-258">(G) El cliente solicita un nuevo token de acceso autenticando con el servidor de autorización y presentando el token de actualización.</span><span class="sxs-lookup"><span data-stu-id="76440-258">(G) The client requests a new access token by authenticating with the authorization server and presenting the refresh token.</span></span> <span data-ttu-id="76440-259">Los requisitos de autenticación de cliente se basan en el tipo de cliente y en las directivas del servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="76440-259">The client authentication requirements are based on the client type and on the authorization server policies.</span></span> | <span data-ttu-id="76440-260">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="76440-260">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="76440-261">(H) El servidor de autorización autentica al cliente y valida el token de actualización y, si es válido, emite un nuevo token de acceso (y, opcionalmente, un nuevo token de actualización).</span><span class="sxs-lookup"><span data-stu-id="76440-261">(H) The authorization server authenticates the client and validates the refresh token, and if valid, issues a new access token (and, optionally, a new refresh token).</span></span> |  |

<span data-ttu-id="76440-262">Aquí está la `Provider.GrantRefreshToken`implementación de ejemplo para:</span><span class="sxs-lookup"><span data-stu-id="76440-262">Here is the sample implementation for `Provider.GrantRefreshToken`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample9.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample10.cs)]

## <a name="create-a-resource-server-which-is-protected-by-access-token"></a><span data-ttu-id="76440-263">Cree un servidor de recursos protegido por el token de acceso</span><span class="sxs-lookup"><span data-stu-id="76440-263">Create a Resource Server which is protected by Access Token</span></span>

<span data-ttu-id="76440-264">Cree un proyecto de aplicación web vacío e instale los siguientes paquetes en el proyecto:</span><span class="sxs-lookup"><span data-stu-id="76440-264">Create an empty web app project and install following packages in the project:</span></span>

- <span data-ttu-id="76440-265">Microsoft.AspNet.WebApi.Owin</span><span class="sxs-lookup"><span data-stu-id="76440-265">Microsoft.AspNet.WebApi.Owin</span></span>
- <span data-ttu-id="76440-266">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="76440-266">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="76440-267">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="76440-267">Microsoft.Owin.Security.OAuth</span></span>

<span data-ttu-id="76440-268">Cree una clase de inicio y configure la autenticación y la API web.</span><span class="sxs-lookup"><span data-stu-id="76440-268">Create a startup class and configure authentication and Web API.</span></span> <span data-ttu-id="76440-269">Consulte *AuthorizationServer-ResourceServer-Startup.cs* en la descarga de ejemplo.</span><span class="sxs-lookup"><span data-stu-id="76440-269">See *AuthorizationServer\ResourceServer\Startup.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample11.cs)]

<span data-ttu-id="76440-270">En la descarga de ejemplo, consulte *\_AuthorizationServer-ResourceServer-App Start-Startup.Auth.cs.*</span><span class="sxs-lookup"><span data-stu-id="76440-270">See *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample12.cs)]

<span data-ttu-id="76440-271">En la descarga de ejemplo, consulte *\_AuthorizationServer-ResourceServer-App Start-Startup.WebApi.cs.*</span><span class="sxs-lookup"><span data-stu-id="76440-271">See *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample13.cs)]

- <span data-ttu-id="76440-272">`UseCors`método permite CORS para todos los dominios.</span><span class="sxs-lookup"><span data-stu-id="76440-272">`UseCors` method allows CORS for all domains.</span></span>
- <span data-ttu-id="76440-273">`UseOAuthBearerAuthentication`método habilita el middleware de autenticación de token de portador de OAuth que recibirá y validará el token de portador desde el encabezado de autorización en la solicitud.</span><span class="sxs-lookup"><span data-stu-id="76440-273">`UseOAuthBearerAuthentication` method enables OAuth bearer token authentication middleware which will receive and validate bearer token from authorization header in the request.</span></span>
- <span data-ttu-id="76440-274">`Config.SuppressDefaultHostAuthenticaiton`suprime la entidad de seguridad autenticada de host predeterminada de la aplicación, por lo tanto, todas las solicitudes serán anónimas después de esta llamada.</span><span class="sxs-lookup"><span data-stu-id="76440-274">`Config.SuppressDefaultHostAuthenticaiton` suppresses default host authenticated principal from the app, therefore all requests will be anonymous after this call.</span></span>
- <span data-ttu-id="76440-275">`HostAuthenticationFilter`habilita la autenticación solo para el tipo de autenticación especificado.</span><span class="sxs-lookup"><span data-stu-id="76440-275">`HostAuthenticationFilter` enables authentication just for the specified authentication type.</span></span> <span data-ttu-id="76440-276">En este caso, es el tipo de autenticación portador.</span><span class="sxs-lookup"><span data-stu-id="76440-276">In this case, it's bearer authentication type.</span></span>

<span data-ttu-id="76440-277">Para demostrar la identidad autenticada, creamos un ApiController para generar notificaciones de usuario actual.</span><span class="sxs-lookup"><span data-stu-id="76440-277">In order to demonstrate the authenticated identity, we create an ApiController to output current user's claims.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample14.cs)]

<span data-ttu-id="76440-278">Si el servidor de autorización y el servidor de recursos no están en el mismo equipo, el middleware de OAuth usará las diferentes claves de máquina para cifrar y descifrar el token de acceso del portador.</span><span class="sxs-lookup"><span data-stu-id="76440-278">If the authorization server and the resource server are not on the same computer, the OAuth middleware will use the different machine keys to encrypt and decrypt bearer access token.</span></span> <span data-ttu-id="76440-279">Para compartir la misma clave privada entre ambos `machinekey` proyectos, agregamos la misma configuración en ambos archivos *web.config.*</span><span class="sxs-lookup"><span data-stu-id="76440-279">In order to share the same private key between both projects, we add the same `machinekey` setting in both *web.config* files.</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample15.xml?highlight=8-10)]

## <a name="create-oauth-20-clients"></a><span data-ttu-id="76440-280">Crear clientes de OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="76440-280">Create OAuth 2.0 Clients</span></span>

 <span data-ttu-id="76440-281">Usamos el paquete NuGet [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) para simplificar el código de cliente.</span><span class="sxs-lookup"><span data-stu-id="76440-281">We use the [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet package to simplify the client code.</span></span>

### <a name="authorization-code-grant-client"></a><span data-ttu-id="76440-282">Cliente de Concesión de Código de Autorización</span><span class="sxs-lookup"><span data-stu-id="76440-282">Authorization Code Grant Client</span></span>

 <span data-ttu-id="76440-283">Este cliente es una aplicación MVC.</span><span class="sxs-lookup"><span data-stu-id="76440-283">This client is an MVC application.</span></span> <span data-ttu-id="76440-284">Desencadenará un flujo de concesión de código de autorización para obtener el token de acceso del back-end.</span><span class="sxs-lookup"><span data-stu-id="76440-284">It will trigger an authorization code grant flow to get the access token from backend.</span></span> <span data-ttu-id="76440-285">Tiene una sola página como se muestra a continuación:</span><span class="sxs-lookup"><span data-stu-id="76440-285">It has a single page as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image3.png)

- <span data-ttu-id="76440-286">El botón **Autorizar** redirigirá el explorador al servidor de autorización para notificar al propietario del recurso para conceder acceso a este cliente.</span><span class="sxs-lookup"><span data-stu-id="76440-286">The **Authorize** button will redirect browser to the authorization server to notify the resource owner to grant access to this client.</span></span>
- <span data-ttu-id="76440-287">El botón **Actualizar** obtendrá un nuevo token de acceso y un token de actualización mediante el token de actualización actual.</span><span class="sxs-lookup"><span data-stu-id="76440-287">The **Refresh** button will get a new access token and refresh token using the current refresh token.</span></span>
- <span data-ttu-id="76440-288">El botón **Access Protected Resource API** llamará al servidor de recursos para obtener los datos de notificaciones del usuario actual y mostrarlos en la página.</span><span class="sxs-lookup"><span data-stu-id="76440-288">The **Access Protected Resource API** button will call the resource server to get current user's claims data and show them on the page.</span></span>

<span data-ttu-id="76440-289">Aquí está el código `HomeController` de ejemplo del cliente.</span><span class="sxs-lookup"><span data-stu-id="76440-289">Here is the sample code of the `HomeController` of the client.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample16.cs)]

<span data-ttu-id="76440-290">`DotNetOpenAuth`requiere SSL de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="76440-290">`DotNetOpenAuth` requires SSL by default.</span></span> <span data-ttu-id="76440-291">Puesto que nuestra demostración está utilizando HTTP, debe agregar la siguiente configuración en el archivo de configuración:</span><span class="sxs-lookup"><span data-stu-id="76440-291">Since our demo is using HTTP, you need to add following setting in the config file:</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample17.xml?highlight=4-6)]

> [!WARNING]
> <span data-ttu-id="76440-292">Seguridad: nunca deshabilite SSL en una aplicación de producción.</span><span class="sxs-lookup"><span data-stu-id="76440-292">Security - Never disable SSL in a production app.</span></span> <span data-ttu-id="76440-293">Sus credenciales de inicio de sesión ahora se envían en texto no cifrado a través de la conexión.</span><span class="sxs-lookup"><span data-stu-id="76440-293">Your login credentials are now being sent in clear-text across the wire.</span></span> <span data-ttu-id="76440-294">El código anterior es solo para la depuración y exploración de ejemplo local.</span><span class="sxs-lookup"><span data-stu-id="76440-294">The code above is just for local sample debugging and exploration.</span></span>


### <a name="implicit-grant-client"></a><span data-ttu-id="76440-295">Cliente de subvención implícita</span><span class="sxs-lookup"><span data-stu-id="76440-295">Implicit Grant Client</span></span>

<span data-ttu-id="76440-296">Este cliente utiliza JavaScript para:</span><span class="sxs-lookup"><span data-stu-id="76440-296">This client is using JavaScript to:</span></span>

1. <span data-ttu-id="76440-297">Abra una nueva ventana y reoriente al punto final autorizado del servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="76440-297">Open a new window and redirect to the authorize endpoint of the Authorization Server.</span></span>
2. <span data-ttu-id="76440-298">Obtenga el token de acceso de los fragmentos de URL cuando redirija hacia atrás.</span><span class="sxs-lookup"><span data-stu-id="76440-298">Get the access token from URL fragments when it redirects back.</span></span>

<span data-ttu-id="76440-299">La siguiente imagen muestra este proceso:</span><span class="sxs-lookup"><span data-stu-id="76440-299">The following image shows this process:</span></span>

![](owin-oauth-20-authorization-server/_static/image4.png)

<span data-ttu-id="76440-300">El cliente debe tener dos páginas: una para la página de inicio y la otra para la devolución de llamada. Aquí está el código JavaScript de ejemplo que se encuentra en el archivo *Index.cshtml:*</span><span class="sxs-lookup"><span data-stu-id="76440-300">The client should have two pages: one for home page and the other for callback.Here is the sample JavaScript code found in the *Index.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample18.cshtml)]

<span data-ttu-id="76440-301">Aquí está el código de control de devolución de llamada en el archivo *SignIn.cshtml:*</span><span class="sxs-lookup"><span data-stu-id="76440-301">Here is the callback handling code in *SignIn.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample19.cshtml)]

> [!NOTE]
> <span data-ttu-id="76440-302">Una práctica recomendada es mover JavaScript a un archivo externo y no incrustarlo con el marcado Razor.</span><span class="sxs-lookup"><span data-stu-id="76440-302">A best practice is to move the JavaScript to an external file and not embed it with the Razor markup.</span></span> <span data-ttu-id="76440-303">Para mantener esta muestra simple, se han combinado.</span><span class="sxs-lookup"><span data-stu-id="76440-303">To keep this sample simple, they have been combined.</span></span>


### <a name="resource-owner-password-credentials-grant-client"></a><span data-ttu-id="76440-304">Credenciales de contraseña de propietario de recursos Conceder cliente</span><span class="sxs-lookup"><span data-stu-id="76440-304">Resource Owner Password Credentials Grant Client</span></span>

<span data-ttu-id="76440-305">Usamos una aplicación de consola para demostrar este cliente.</span><span class="sxs-lookup"><span data-stu-id="76440-305">We uses a console app to demo this client.</span></span> <span data-ttu-id="76440-306">Este es el código:</span><span class="sxs-lookup"><span data-stu-id="76440-306">Here is the code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample20.cs)]

### <a name="client-credentials-grant-client"></a><span data-ttu-id="76440-307">Cliente de concesión de credenciales de cliente</span><span class="sxs-lookup"><span data-stu-id="76440-307">Client Credentials Grant Client</span></span>

<span data-ttu-id="76440-308">Al igual que la concesión de credenciales de contraseña de propietario de recursos, aquí está el código de la aplicación de consola:</span><span class="sxs-lookup"><span data-stu-id="76440-308">Similar to the Resource Owner Password Credentials Grant, here is console app code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample21.cs)]
