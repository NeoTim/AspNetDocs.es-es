---
uid: mvc/overview/security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages
title: Prevención de XSRF/CSRF en ASP.NET MVC y Web Pages | Microsoft Docs
author: Rick-Anderson
description: Falsificación de solicitud entre sitios (también conocida como XSRF o CSRF) es un ataque contra aplicaciones hospedadas en web mediante el cual un sitio web malintencionado puede influir en el interactivo...
ms.author: riande
ms.date: 03/14/2013
ms.assetid: aadc5fa4-8215-4fc7-afd5-bcd2ef879728
msc.legacyurl: /mvc/overview/security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages
msc.type: authoredcontent
ms.openlocfilehash: 5db661cccc58d1101f95091b069ab5cbfe78a378
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 03/01/2019
ms.locfileid: "57063952"
---
<a name="xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages"></a><span data-ttu-id="26f0b-103">Prevención de XSRF/CSRF en ASP.NET MVC y Web Pages</span><span class="sxs-lookup"><span data-stu-id="26f0b-103">XSRF/CSRF Prevention in ASP.NET MVC and Web Pages</span></span>
====================
<span data-ttu-id="26f0b-104">by [Rick Anderson]((https://twitter.com/RickAndMSFT))</span><span class="sxs-lookup"><span data-stu-id="26f0b-104">by [Rick Anderson]((https://twitter.com/RickAndMSFT))</span></span>

> <span data-ttu-id="26f0b-105">Solicitud entre sitios que falsificación (también conocida como XSRF o CSRF) es un ataque contra aplicaciones hospedadas en web mediante el cual un sitio web malintencionado puede influir en la interacción entre un explorador cliente y un sitio web de confianza de ese explorador.</span><span class="sxs-lookup"><span data-stu-id="26f0b-105">Cross-site request forgery (also known as XSRF or CSRF) is an attack against web-hosted applications whereby a malicious web site can influence the interaction between a client browser and a web site trusted by that browser.</span></span> <span data-ttu-id="26f0b-106">Estos ataques se posible porque los exploradores web enviarán tokens de autenticación automáticamente con cada solicitud a un sitio web.</span><span class="sxs-lookup"><span data-stu-id="26f0b-106">These attacks are made possible because web browsers will send authentication tokens automatically with every request to a web site.</span></span> <span data-ttu-id="26f0b-107">El ejemplo canónico es una cookie de autenticación, por ejemplo, ASP. Vale de autenticación de formularios de la red.</span><span class="sxs-lookup"><span data-stu-id="26f0b-107">The canonical example is an authentication cookie, such as ASP.NET's Forms Authentication ticket.</span></span> <span data-ttu-id="26f0b-108">Sin embargo, los sitios web que use cualquier mecanismo de autenticación persistente (por ejemplo, la autenticación de Windows, Basic etc.) puede tener como destino estos ataques.</span><span class="sxs-lookup"><span data-stu-id="26f0b-108">However, web sites which use any persistent authentication mechanism (such as Windows Authentication, Basic, and so forth) can be targeted by these attacks.</span></span>
> 
> <span data-ttu-id="26f0b-109">Un ataque XSRF es distinto de un ataque de suplantación de identidad.</span><span class="sxs-lookup"><span data-stu-id="26f0b-109">An XSRF attack is distinct from a phishing attack.</span></span> <span data-ttu-id="26f0b-110">Los ataques de suplantación de identidad requieren interacción de la víctima.</span><span class="sxs-lookup"><span data-stu-id="26f0b-110">Phishing attacks require interaction from the victim.</span></span> <span data-ttu-id="26f0b-111">En un ataque de suplantación de identidad, un sitio web malintencionado imitará el sitio web de destino y la víctima se engañado para que proporcione información confidencial al atacante.</span><span class="sxs-lookup"><span data-stu-id="26f0b-111">In a phishing attack, a malicious web site will mimic the target web site, and the victim is fooled into providing sensitive information to the attacker.</span></span> <span data-ttu-id="26f0b-112">En un ataque XSRF, no suele haber ninguna interacción necesaria de la víctima.</span><span class="sxs-lookup"><span data-stu-id="26f0b-112">In an XSRF attack, there is often no interaction necessary from the victim.</span></span> <span data-ttu-id="26f0b-113">En su lugar, el atacante confía en el explorador enviando automáticamente todas las cookies relevantes al sitio web de destino.</span><span class="sxs-lookup"><span data-stu-id="26f0b-113">Rather, the attacker is relying on the browser automatically sending all relevant cookies to the destination web site.</span></span>
> 
> <span data-ttu-id="26f0b-114">Para obtener más información, consulte el [Open Web Application Security Project](https://www.owasp.org/index.php/Main_Page)(OWASP) [XSRF](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)).</span><span class="sxs-lookup"><span data-stu-id="26f0b-114">For more information, see the [Open Web Application Security Project](https://www.owasp.org/index.php/Main_Page)(OWASP) [XSRF](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)).</span></span>


## <a name="anatomy-of-an-attack"></a><span data-ttu-id="26f0b-115">Anatomía de un ataque</span><span class="sxs-lookup"><span data-stu-id="26f0b-115">Anatomy of an attack</span></span>

<span data-ttu-id="26f0b-116">Para recorrer en iteración un ataque XSRF, considere la posibilidad de un usuario que desea realizar algunas transacciones bancarias en línea.</span><span class="sxs-lookup"><span data-stu-id="26f0b-116">To walk through an XSRF attack, consider a user who wants to perform some online banking transactions.</span></span> <span data-ttu-id="26f0b-117">En primer lugar, este usuario visita WoodgroveBank.com y registros, momento en que el encabezado de respuesta contendrá la cookie de autenticación:</span><span class="sxs-lookup"><span data-stu-id="26f0b-117">This user first visits WoodgroveBank.com and logs in, at which point the response header will contain her authentication cookie:</span></span>

[!code-console[Main](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/samples/sample1.cmd)]

<span data-ttu-id="26f0b-118">Dado que la cookie de autenticación es una cookie de sesión, lo se borrará automáticamente el explorador cuando se cierra el proceso del explorador.</span><span class="sxs-lookup"><span data-stu-id="26f0b-118">Because the authentication cookie is a session cookie, it will be automatically cleared by the browser when the browser process exits.</span></span> <span data-ttu-id="26f0b-119">Sin embargo, hasta ese momento, el explorador incluirá automáticamente la cookie con cada solicitud a WoodgroveBank.com.</span><span class="sxs-lookup"><span data-stu-id="26f0b-119">However, until that time, the browser will automatically include the cookie with each request to WoodgroveBank.com.</span></span> <span data-ttu-id="26f0b-120">Ahora, el usuario desea transferir 1000 USD a otra cuenta, por lo que rellena un formulario en el sitio de banca, y el explorador realiza esta solicitud al servidor:</span><span class="sxs-lookup"><span data-stu-id="26f0b-120">The user now wants to transfer $1000 to another account, so she fills out a form on the banking site, and the browser makes this request to the server:</span></span>

[!code-console[Main](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/samples/sample2.cmd)]

<span data-ttu-id="26f0b-121">Dado que esta operación tiene un efecto secundario (inicia una transacción monetaria), ha decidido que el sitio de banca requieren una solicitud HTTP POST con el fin de iniciar la operación.</span><span class="sxs-lookup"><span data-stu-id="26f0b-121">Because this operation has a side effect (it initiates a monetary transaction), the banking site has chosen to require an HTTP POST in order to initiate this operation.</span></span> <span data-ttu-id="26f0b-122">El servidor lee el token de autenticación en la solicitud, busca el número de cuenta del usuario actual, comprueba que existe suficientes fondos y, a continuación, inicia la transacción en la cuenta de destino.</span><span class="sxs-lookup"><span data-stu-id="26f0b-122">The server reads the authentication token from the request, looks up the current user's account number, verifies that sufficient funds exist, and then initiates the transaction into the destination account.</span></span>

<span data-ttu-id="26f0b-123">Banca en línea completa, el usuario navega fuera del sitio de la banca y propia visita otras ubicaciones en la web.</span><span class="sxs-lookup"><span data-stu-id="26f0b-123">Her online banking complete, the user navigates away from the banking site and visits other locations on the web.</span></span> <span data-ttu-id="26f0b-124">Uno de esos sitios – fabrikam.com: incluye el siguiente marcado en una página insertada dentro de un &lt;iframe&gt;:</span><span class="sxs-lookup"><span data-stu-id="26f0b-124">One of those sites – fabrikam.com – includes the following markup on a page embedded within an &lt;iframe&gt;:</span></span>

[!code-html[Main](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/samples/sample3.html)]

<span data-ttu-id="26f0b-125">Lo que hace que el explorador realizar esta solicitud:</span><span class="sxs-lookup"><span data-stu-id="26f0b-125">Which then causes the browser to make this request:</span></span>

[!code-console[Main](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/samples/sample4.cmd)]

<span data-ttu-id="26f0b-126">El atacante está aprovechando el hecho de que el usuario puede seguir teniendo un token de autenticación válido para el sitio web de destino y que está utilizando un pequeño fragmento de Javascript para hacer que el explorador realizar una solicitud HTTP POST en el sitio de destino automáticamente.</span><span class="sxs-lookup"><span data-stu-id="26f0b-126">The attacker is exploiting the fact that the user might still have a valid authentication token for the target web site, and she is using a small snippet of Javascript to cause the browser to make an HTTP POST to the target site automatically.</span></span> <span data-ttu-id="26f0b-127">Si el token de autenticación sigue siendo válido, el sitio de banca iniciará a una transferencia de 250 dólares en la cuenta de elección del atacante.</span><span class="sxs-lookup"><span data-stu-id="26f0b-127">If the authentication token is still valid, the banking site will initiate a transfer of $250 into the account of the attacker's choosing.</span></span>

### <a name="ineffective-mitigations"></a><span data-ttu-id="26f0b-128">Mitigaciones ineficaces</span><span class="sxs-lookup"><span data-stu-id="26f0b-128">Ineffective mitigations</span></span>

<span data-ttu-id="26f0b-129">Es interesante tener en cuenta que en el escenario anterior, el hecho de que WoodgroveBank.com se tenía acceso a través de SSL y tenía una cookie de autenticación solo SSL era insuficiente para frustrar los ataques.</span><span class="sxs-lookup"><span data-stu-id="26f0b-129">It is interesting to note that in the above scenario, the fact that WoodgroveBank.com was being accessed via SSL and had an SSL-only authentication cookie was insufficient to thwart the attack.</span></span> <span data-ttu-id="26f0b-130">El atacante es capaz de especificar el [esquema URI](http://en.wikipedia.org/wiki/URI_scheme) (https) en su &lt;formulario&gt; elemento y el explorador seguirá enviando las cookies que no hayan expirado al sitio de destino siempre y cuando las cookies son coherentes con el identificador URI esquema del destino previsto.</span><span class="sxs-lookup"><span data-stu-id="26f0b-130">The attacker is able to specify the [URI scheme](http://en.wikipedia.org/wiki/URI_scheme) (https) in her &lt;form&gt; element, and the browser will continue to send unexpired cookies to the target site as long as those cookies are consistent with the URI scheme of the intended target.</span></span>

<span data-ttu-id="26f0b-131">Uno podría argumentar que el usuario simplemente no visite sitios de confianza, como visitar solo sitios de confianza se ayuda a permanecer seguro en línea.</span><span class="sxs-lookup"><span data-stu-id="26f0b-131">One could argue that the user should simply not visit untrusted sites, as visiting only trusted sites is helps to remain safe online.</span></span> <span data-ttu-id="26f0b-132">Hay algo de verdad a esto, pero Desgraciadamente este Consejo no siempre resulta práctico.</span><span class="sxs-lookup"><span data-stu-id="26f0b-132">There is some truth to this, but unfortunately this advice is not always practical.</span></span> <span data-ttu-id="26f0b-133">Quizás el usuario "confía" el sitio de noticias locales ConsolidatedMessenger.</span><span class="sxs-lookup"><span data-stu-id="26f0b-133">Perhaps the user "trusts" the local news site ConsolidatedMessenger.</span></span> <span data-ttu-id="26f0b-134">ConsolidatedMessenger.com y se va a visitar ese sitio en su lugar, pero ese sitio tiene una vulnerabilidad XSS que permite que un atacante insertar el mismo fragmento de código que se estaba ejecutando en fabrikam.com.</span><span class="sxs-lookup"><span data-stu-id="26f0b-134">ConsolidatedMessenger.com and goes to visit that site instead, but that site has an XSS vulnerability which allows an attacker to inject the same snippet of code that was running on fabrikam.com.</span></span>

<span data-ttu-id="26f0b-135">Puede comprobar que las solicitudes entrantes tengan una [encabezado Referer](http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html#z14) que hacen referencia a su dominio.</span><span class="sxs-lookup"><span data-stu-id="26f0b-135">You can verify that incoming requests have a [Referer header](http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html#z14) referencing your domain.</span></span> <span data-ttu-id="26f0b-136">Esto detendrá las solicitudes enviadas al cambiar de un dominio de otros fabricantes.</span><span class="sxs-lookup"><span data-stu-id="26f0b-136">This will stop requests unwittingly submitted from a third-party domain.</span></span> <span data-ttu-id="26f0b-137">Sin embargo, algunas personas deshabilitar encabezado Referer de su explorador por motivos de privacidad y los atacantes pueden suplantar a veces ese encabezado si el sujeto tiene cierta inseguro software instalado.</span><span class="sxs-lookup"><span data-stu-id="26f0b-137">However, some people disable their browser's Referer header for privacy reasons, and attackers can sometimes spoof that header if the victim has certain insecure software installed.</span></span> <span data-ttu-id="26f0b-138">Comprobando la [encabezado Referer](http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html#z14) no se considera un enfoque seguro para la prevención de ataques XSRF.</span><span class="sxs-lookup"><span data-stu-id="26f0b-138">Verifying the [Referer header](http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html#z14) is not considered a secure approach to preventing XSRF attacks.</span></span>

## <a name="web-stack-runtime-xsrf-mitigations"></a><span data-ttu-id="26f0b-139">Mitigaciones de pila en tiempo de ejecución XSRF Web</span><span class="sxs-lookup"><span data-stu-id="26f0b-139">Web Stack Runtime XSRF mitigations</span></span>

<span data-ttu-id="26f0b-140">El tiempo de ejecución de ASP.NET Web Stack utiliza una variante de la [patrón del token Sincronizador](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet#General_Recommendation:_Synchronizer_Token_Pattern) para defenderse contra ataques XSRF.</span><span class="sxs-lookup"><span data-stu-id="26f0b-140">The ASP.NET Web Stack Runtime uses a variant of the [synchronizer token pattern](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet#General_Recommendation:_Synchronizer_Token_Pattern) to defend against XSRF attacks.</span></span> <span data-ttu-id="26f0b-141">La forma general del patrón de token Sincronizador es que dos tokens de anti-XSRF se envían al servidor con cada solicitud HTTP POST (además del token de autenticación): un token como una cookie y el otro como un valor de formulario.</span><span class="sxs-lookup"><span data-stu-id="26f0b-141">The general form of the synchronizer token pattern is that two anti-XSRF tokens are submitted to the server with each HTTP POST (In addition to the authentication token): one token as a cookie, and the other as a form value.</span></span> <span data-ttu-id="26f0b-142">Los valores del token generados por el tiempo de ejecución ASP.NET no son deterministas o predecible por un atacante.</span><span class="sxs-lookup"><span data-stu-id="26f0b-142">The token values generated by the ASP.NET runtime are not deterministic or predictable by an attacker.</span></span> <span data-ttu-id="26f0b-143">Cuando se envían los tokens, el servidor permitirá la solicitud continuar sólo si ambos tokens pasan una comprobación de comparación.</span><span class="sxs-lookup"><span data-stu-id="26f0b-143">When the tokens are submitted, the server will allow the request to proceed only if both tokens pass a comparison check.</span></span>

<span data-ttu-id="26f0b-144">La comprobación de solicitud XSRF *token de sesión* se almacena como una cookie HTTP y actualmente contiene la siguiente información en su carga:</span><span class="sxs-lookup"><span data-stu-id="26f0b-144">The XSRF request verification *session token* is stored as an HTTP cookie and currently contains the following information in its payload:</span></span>

- <span data-ttu-id="26f0b-145">Un token de seguridad, que consta de un identificador de 128 bits aleatorio.</span><span class="sxs-lookup"><span data-stu-id="26f0b-145">A security token, consisting of a random 128-bit identifier.</span></span>   
 <span data-ttu-id="26f0b-146">La siguiente imagen muestra el token de sesión de verificación de XSRF solicitud muestra con las herramientas de desarrollo F12 de Internet Explorer: (Tenga en cuenta esto es la implementación actual y está sujeto, incluso probable, que cambie.)</span><span class="sxs-lookup"><span data-stu-id="26f0b-146">The following image shows the XSRF request verification session token displayed with the Internet Explorer F12 developer tools: (Note this is the current implementation and is subject, even likely, to change.)</span></span>

![](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/_static/image1.png)

<span data-ttu-id="26f0b-147">El *token campo* se almacena como un `<input type="hidden" />` y contiene la siguiente información en su carga:</span><span class="sxs-lookup"><span data-stu-id="26f0b-147">The *field token* is stored as an `<input type="hidden" />` and contains the following information in its payload:</span></span>

- <span data-ttu-id="26f0b-148">Nombre de usuario del usuario que ha iniciado la sesión (si está autenticado).</span><span class="sxs-lookup"><span data-stu-id="26f0b-148">The logged-in user's username (if authenticated).</span></span>
- <span data-ttu-id="26f0b-149">Datos adicionales proporcionados por un [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx).</span><span class="sxs-lookup"><span data-stu-id="26f0b-149">Any additional data provided by an [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx).</span></span>

<span data-ttu-id="26f0b-150">Las cargas de los tokens de anti-XSRF están cifradas y firmadas, por lo que no se puede ver el nombre de usuario al utilizar herramientas para examinar los tokens.</span><span class="sxs-lookup"><span data-stu-id="26f0b-150">The payloads of the anti-XSRF tokens are encrypted and signed, so you can't view the username when using tools to examine the tokens.</span></span> <span data-ttu-id="26f0b-151">Cuando la aplicación web está destinado a ASP.NET 4.0, servicios criptográficos proporcionados por el [MachineKey.Encode](https://msdn.microsoft.com/library/system.web.security.machinekey.encode.aspx) rutina.</span><span class="sxs-lookup"><span data-stu-id="26f0b-151">When the web application is targeting ASP.NET 4.0, cryptographic services are provided by the [MachineKey.Encode](https://msdn.microsoft.com/library/system.web.security.machinekey.encode.aspx) routine.</span></span> <span data-ttu-id="26f0b-152">Cuando la aplicación web está destinado a ASP.NET 4.5 o superior servicios criptográficos proporcionados por el [MachineKey.Protect](https://msdn.microsoft.com/library/system.web.security.machinekey.protect(v=vs.110)) rutina, que ofrece un mejor rendimiento, extensibilidad y seguridad.</span><span class="sxs-lookup"><span data-stu-id="26f0b-152">When the web application is targeting ASP.NET 4.5 or higher, cryptographic services are provided by the [MachineKey.Protect](https://msdn.microsoft.com/library/system.web.security.machinekey.protect(v=vs.110)) routine, which offers better performance, extensibility, and security.</span></span> <span data-ttu-id="26f0b-153">Consulte que el siguientes entradas de blog para obtener más detalles:</span><span class="sxs-lookup"><span data-stu-id="26f0b-153">See the following blog posts for more details:</span></span>

- [<span data-ttu-id="26f0b-154">Las mejoras criptográficas en ASP.NET 4.5, pt. 1</span><span class="sxs-lookup"><span data-stu-id="26f0b-154">Cryptographic Improvements in ASP.NET 4.5, pt. 1</span></span>](https://blogs.msdn.com/b/webdev/archive/2012/10/22/cryptographic-improvements-in-asp-net-4-5-pt-1.aspx)
- [<span data-ttu-id="26f0b-155">Las mejoras criptográficas en ASP.NET 4.5, pt. 2</span><span class="sxs-lookup"><span data-stu-id="26f0b-155">Cryptographic Improvements in ASP.NET 4.5, pt. 2</span></span>](https://blogs.msdn.com/b/webdev/archive/2012/10/23/cryptographic-improvements-in-asp-net-4-5-pt-2.aspx)
- [<span data-ttu-id="26f0b-156">Las mejoras criptográficas en ASP.NET 4.5, pt. 3</span><span class="sxs-lookup"><span data-stu-id="26f0b-156">Cryptographic Improvements in ASP.NET 4.5, pt. 3</span></span>](https://blogs.msdn.com/b/webdev/archive/2012/10/24/cryptographic-improvements-in-asp-net-4-5-pt-3.aspx)

## <a name="generating-the-tokens"></a><span data-ttu-id="26f0b-157">Generar los tokens</span><span class="sxs-lookup"><span data-stu-id="26f0b-157">Generating the tokens</span></span>

<span data-ttu-id="26f0b-158">Para generar los tokens de anti-XSRF, llame a la [ @Html.AntiForgeryToken ](https://msdn.microsoft.com/library/dd470175.aspx) método desde una vista de MVC o @AntiForgery.GetHtml() desde una página de Razor.</span><span class="sxs-lookup"><span data-stu-id="26f0b-158">To generate the anti-XSRF tokens, call the [@Html.AntiForgeryToken](https://msdn.microsoft.com/library/dd470175.aspx) method from an MVC view or @AntiForgery.GetHtml() from a Razor page.</span></span> <span data-ttu-id="26f0b-159">El tiempo de ejecución, a continuación, realizará los pasos siguientes:</span><span class="sxs-lookup"><span data-stu-id="26f0b-159">The runtime will then perform the following steps:</span></span>

1. <span data-ttu-id="26f0b-160">Si la solicitud HTTP actual ya contiene un token de sesión de anti-XSRF (la cookie de anti-XSRF \_ \_RequestVerificationToken), se extrae el token de seguridad de ella.</span><span class="sxs-lookup"><span data-stu-id="26f0b-160">If the current HTTP request already contains an anti-XSRF session token (the anti-XSRF cookie \_\_RequestVerificationToken), the security token is extracted from it.</span></span> <span data-ttu-id="26f0b-161">Si la solicitud HTTP no contiene un token de sesión de anti-XSRF o si se produce un error en la extracción del token de seguridad, se generará un nuevo token anti-XSRF aleatorio.</span><span class="sxs-lookup"><span data-stu-id="26f0b-161">If the HTTP request does not contain an anti-XSRF session token or if extraction of the security token fails, a new random anti-XSRF token will be generated.</span></span>
2. <span data-ttu-id="26f0b-162">Se genera un token de campo anti-XSRF mediante el token de seguridad del paso (1) anterior y la identidad del usuario ha iniciado la sesión actual.</span><span class="sxs-lookup"><span data-stu-id="26f0b-162">An anti-XSRF field token is generated using the security token from step (1) above and the identity of the current logged-in user.</span></span> <span data-ttu-id="26f0b-163">(Para obtener más información acerca de cómo determinar la identidad del usuario, consulte el **[escenarios con compatibilidad especial](#_Scenarios_with_special)** sección más adelante.) Además, si un [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/jj158328(v=vs.111).aspx) está configurado, el tiempo de ejecución llamará a su [GetAdditionalData](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider.getadditionaldata(v=vs.111).aspx) método e incluir la cadena devuelta en el token de campo.</span><span class="sxs-lookup"><span data-stu-id="26f0b-163">(For more information on determining user identity, see the **[Scenarios with special support](#_Scenarios_with_special)** section below.) Additionally, if an [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/jj158328(v=vs.111).aspx) is configured, the runtime will call its [GetAdditionalData](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider.getadditionaldata(v=vs.111).aspx) method and include the returned string in the field token.</span></span> <span data-ttu-id="26f0b-164">(Consulte la **[configuración y extensibilidad](#_Configuration_and_extensibility)** sección para obtener más información.)</span><span class="sxs-lookup"><span data-stu-id="26f0b-164">(See the **[Configuration and extensibility](#_Configuration_and_extensibility)** section for more information.)</span></span>
3. <span data-ttu-id="26f0b-165">Si se ha generado un nuevo token anti-XSRF en el paso (1), un nuevo token de sesión que lo contiene, se creará y se agregará a la colección de cookies HTTP saliente.</span><span class="sxs-lookup"><span data-stu-id="26f0b-165">If a new anti-XSRF token was generated in step (1), a new session token will be created to contain it and will be added to the outbound HTTP cookies collection.</span></span> <span data-ttu-id="26f0b-166">El token de campo del paso (2) se ajustará en un `<input type="hidden" />` elemento y este marcado HTML será el valor devuelto de `Html.AntiForgeryToken()` o `AntiForgery.GetHtml()`.</span><span class="sxs-lookup"><span data-stu-id="26f0b-166">The field token from step (2) will be wrapped in an `<input type="hidden" />` element, and this HTML markup will be the return value of `Html.AntiForgeryToken()` or `AntiForgery.GetHtml()`.</span></span>

## <a name="validating-the-tokens"></a><span data-ttu-id="26f0b-167">Validando los tokens</span><span class="sxs-lookup"><span data-stu-id="26f0b-167">Validating the tokens</span></span>

<span data-ttu-id="26f0b-168">Para validar los tokens de anti-XSRF entrante, el desarrollador incluye un [ValidateAntiForgeryToken](https://msdn.microsoft.com/library/system.web.mvc.validateantiforgerytokenattribute(VS.108).aspx) atributo en su acción de MVC o controlador llamadas `@AntiForgery.Validate()` desde su página de Razor.</span><span class="sxs-lookup"><span data-stu-id="26f0b-168">To validate the incoming anti-XSRF tokens, the developer includes a [ValidateAntiForgeryToken](https://msdn.microsoft.com/library/system.web.mvc.validateantiforgerytokenattribute(VS.108).aspx) attribute on her MVC action or controller, or she calls `@AntiForgery.Validate()` from her Razor page.</span></span> <span data-ttu-id="26f0b-169">El tiempo de ejecución llevará a cabo los pasos siguientes:</span><span class="sxs-lookup"><span data-stu-id="26f0b-169">The runtime will perform the following steps:</span></span>

1. <span data-ttu-id="26f0b-170">Se leen el token de sesión entrante y el token de campo y extrae el token anti-XSRF de cada uno.</span><span class="sxs-lookup"><span data-stu-id="26f0b-170">The incoming session token and field token are read and the anti-XSRF token extracted from each.</span></span> <span data-ttu-id="26f0b-171">Los tokens de anti-XSRF deben ser idénticos en cada paso (2) en la rutina de generación.</span><span class="sxs-lookup"><span data-stu-id="26f0b-171">The anti-XSRF tokens must be identical per step (2) in the generation routine.</span></span>
2. <span data-ttu-id="26f0b-172">Si el usuario actual está autenticado, el nombre de usuario se compara con el nombre de usuario almacenado en el token de campo.</span><span class="sxs-lookup"><span data-stu-id="26f0b-172">If the current user is authenticated, her username is compared with the username stored in the field token.</span></span> <span data-ttu-id="26f0b-173">Deben coincidir con los nombres de usuario.</span><span class="sxs-lookup"><span data-stu-id="26f0b-173">The usernames must match.</span></span>
3. <span data-ttu-id="26f0b-174">Si un [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) está configurado, el runtime llama a su *ValidateAdditionalData* método.</span><span class="sxs-lookup"><span data-stu-id="26f0b-174">If an [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) is configured, the runtime calls its *ValidateAdditionalData* method.</span></span> <span data-ttu-id="26f0b-175">El método debe devolver el valor booleano *true*.</span><span class="sxs-lookup"><span data-stu-id="26f0b-175">The method must return the Boolean value *true*.</span></span>

<span data-ttu-id="26f0b-176">Si la validación es correcta, se permite la solicitud para continuar.</span><span class="sxs-lookup"><span data-stu-id="26f0b-176">If validation succeeds, the request is allowed to proceed.</span></span> <span data-ttu-id="26f0b-177">Si se produce un error de validación, el marco de trabajo producirá un *HttpAntiForgeryException*.</span><span class="sxs-lookup"><span data-stu-id="26f0b-177">If validation fails, the framework will throw an *HttpAntiForgeryException*.</span></span>

## <a name="failure-conditions"></a><span data-ttu-id="26f0b-178">Condiciones de error</span><span class="sxs-lookup"><span data-stu-id="26f0b-178">Failure conditions</span></span>

<span data-ttu-id="26f0b-179">A partir de la ASP.NET Web Stack Runtime v2, cualquier *HttpAntiForgeryException* que se produce durante la validación contendrá información detallada sobre qué salió mal.</span><span class="sxs-lookup"><span data-stu-id="26f0b-179">Starting with The ASP.NET Web Stack Runtime v2, any *HttpAntiForgeryException* that is thrown during validation will contain detailed information about what went wrong.</span></span> <span data-ttu-id="26f0b-180">Las condiciones de error definidos actualmente son:</span><span class="sxs-lookup"><span data-stu-id="26f0b-180">The currently defined failure conditions are:</span></span>

- <span data-ttu-id="26f0b-181">El token de sesión o el token de formulario no está presente en la solicitud.</span><span class="sxs-lookup"><span data-stu-id="26f0b-181">The session token or form token is not present in the request.</span></span>
- <span data-ttu-id="26f0b-182">El token de sesión o el token de formulario es ilegible.</span><span class="sxs-lookup"><span data-stu-id="26f0b-182">The session token or form token is unreadable.</span></span> <span data-ttu-id="26f0b-183">La causa más probable de esta es una granja de servidores que ejecutan versiones no coincidentes de la ASP.NET Web Stack en tiempo de ejecución o una granja de servidores donde el &lt;machineKey&gt; elemento en el archivo Web.config es diferente entre máquinas.</span><span class="sxs-lookup"><span data-stu-id="26f0b-183">The most likely cause of this is a farm running mismatched versions of The ASP.NET Web Stack Runtime or a farm where the &lt;machineKey&gt; element in Web.config differs between machines.</span></span> <span data-ttu-id="26f0b-184">Puede usar una herramienta como Fiddler para forzar esta excepción mediante la alteración con cualquier token anti-XSRF.</span><span class="sxs-lookup"><span data-stu-id="26f0b-184">You can use a tool such as Fiddler to force this exception by tampering with either anti-XSRF token.</span></span>
- <span data-ttu-id="26f0b-185">Se intercambiaron el token de sesión y el token de campo.</span><span class="sxs-lookup"><span data-stu-id="26f0b-185">The session token and field token were swapped.</span></span>
- <span data-ttu-id="26f0b-186">El token de sesión y el token de campo contienen los tokens de seguridad que no coinciden.</span><span class="sxs-lookup"><span data-stu-id="26f0b-186">The session token and field token contain mismatched security tokens.</span></span>
- <span data-ttu-id="26f0b-187">El nombre de usuario incrustado en el símbolo (token) de campo no coincide con el nombre de usuario ha iniciado la sesión del usuario actual.</span><span class="sxs-lookup"><span data-stu-id="26f0b-187">The username embedded within the field token does not match the current logged-in user's username.</span></span>
- <span data-ttu-id="26f0b-188">El *[IAntiForgeryAdditionalDataProvider.ValidateAdditionalData](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider.validateadditionaldata(v=vs.111).aspx)* devuelto del método *false*.</span><span class="sxs-lookup"><span data-stu-id="26f0b-188">The *[IAntiForgeryAdditionalDataProvider.ValidateAdditionalData](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider.validateadditionaldata(v=vs.111).aspx)* method returned *false*.</span></span>

<span data-ttu-id="26f0b-189">Las instalaciones de anti-XSRF también pueden realizar comprobaciones adicionales durante la generación de tokens y errores durante estas comprobaciones pueden producir excepciones que se producen.</span><span class="sxs-lookup"><span data-stu-id="26f0b-189">The anti-XSRF facilities may also perform additional checking during token generation or validation, and failures during these checks may result in exceptions being thrown.</span></span> <span data-ttu-id="26f0b-190">Vea el [WIF y ACS / basada en notificaciones autenticación](#_WIF_ACS) y **[configuración y extensibilidad](#_Configuration_and_extensibility)** secciones para obtener más información.</span><span class="sxs-lookup"><span data-stu-id="26f0b-190">See the [WIF / ACS / claims-based authentication](#_WIF_ACS) and **[Configuration and extensibility](#_Configuration_and_extensibility)** sections for more information.</span></span>

<a id="_Scenarios_with_special"></a>

## <a name="scenarios-with-special-support"></a><span data-ttu-id="26f0b-191">Escenarios con compatibilidad especial</span><span class="sxs-lookup"><span data-stu-id="26f0b-191">Scenarios with special support</span></span>

### <a name="anonymous-authentication"></a><span data-ttu-id="26f0b-192">Autenticación anónima</span><span class="sxs-lookup"><span data-stu-id="26f0b-192">Anonymous authentication</span></span>

<span data-ttu-id="26f0b-193">El sistema de anti-XSRF contiene compatibilidad especial para los usuarios anónimos, donde "anónimo" se define como un usuario donde la *IIdentity.IsAuthenticated* propiedad devuelve *false*.</span><span class="sxs-lookup"><span data-stu-id="26f0b-193">The anti-XSRF system contains special support for anonymous users, where "anonymous" is defined as a user where the *IIdentity.IsAuthenticated* property returns *false*.</span></span> <span data-ttu-id="26f0b-194">Los escenarios incluyen proporcionando protección de XSRF a la página de inicio de sesión (antes de que el usuario se autentica) y los esquemas de autenticación personalizados donde la aplicación utiliza un mecanismo distinto *IIdentity* para identificar a los usuarios.</span><span class="sxs-lookup"><span data-stu-id="26f0b-194">Scenarios include providing XSRF protection to the login page (before the user is authenticated) and custom authentication schemes where the application uses a mechanism other than *IIdentity* to identify users.</span></span>

<span data-ttu-id="26f0b-195">Para admitir estos escenarios, recuerde que los tokens de sesión y el campo están unidos por un token de seguridad, que es un identificador opaco generada de forma aleatoria de 128 bits.</span><span class="sxs-lookup"><span data-stu-id="26f0b-195">To support these scenarios, recall that the session and field tokens are joined by a security token, which is a 128-bit randomly-generated opaque identifier.</span></span> <span data-ttu-id="26f0b-196">Este token de seguridad se usa para realizar un seguimiento de sesión de un usuario individual como navega el sitio, por lo que efectivamente tiene la finalidad de un identificador anónimo.</span><span class="sxs-lookup"><span data-stu-id="26f0b-196">This security token is used to track an individual user's session as she navigates the site, so it effectively serves the purpose of an anonymous identifier.</span></span> <span data-ttu-id="26f0b-197">Se utiliza una cadena vacía en lugar del nombre de usuario para las rutinas de validación y generación que se ha descrito anteriormente.</span><span class="sxs-lookup"><span data-stu-id="26f0b-197">An empty string is used in place of the username for the generation and validation routines described above.</span></span>

<a id="_WIF_ACS"></a>

### <a name="wif--acs--claims-based-authentication"></a><span data-ttu-id="26f0b-198">WIF y ACS basado en notificaciones de autenticación</span><span class="sxs-lookup"><span data-stu-id="26f0b-198">WIF / ACS / claims-based authentication</span></span>

<span data-ttu-id="26f0b-199">Normalmente, el *IIdentity* clases integradas en .NET Framework tienen la propiedad que *IIdentity.Name* es suficiente para identificar de forma exclusiva un usuario determinado dentro de una aplicación determinada.</span><span class="sxs-lookup"><span data-stu-id="26f0b-199">Normally, the *IIdentity* classes built in to the .NET Framework have the property that *IIdentity.Name* is sufficient to uniquely identify a particular user within a particular application.</span></span> <span data-ttu-id="26f0b-200">Por ejemplo, *FormsIdentity.Name* devuelve el nombre de usuario almacenado en la base de datos de pertenencia (que es único para todas las aplicaciones según esa base de datos), *WindowsIdentity.Name* devuelve el identidad de dominio completo del usuario y así sucesivamente.</span><span class="sxs-lookup"><span data-stu-id="26f0b-200">For example, *FormsIdentity.Name* returns the username stored in the membership database (which is unique for all applications depending on that database), *WindowsIdentity.Name* returns the domain-qualified identity of the user, and so on.</span></span> <span data-ttu-id="26f0b-201">Estos sistemas proporcionan no solo la autenticación; también *identificar* usuarios en una aplicación.</span><span class="sxs-lookup"><span data-stu-id="26f0b-201">These systems provide not only authentication; they also *identify* users to an application.</span></span>

<span data-ttu-id="26f0b-202">Autenticación basada en notificaciones, por otro lado, no requieren necesariamente la identificación de un usuario determinado.</span><span class="sxs-lookup"><span data-stu-id="26f0b-202">Claims-based authentication, on the other hand, does not necessarily require identifying a particular user.</span></span> <span data-ttu-id="26f0b-203">En su lugar, el *ClaimsPrincipal* y *ClaimsIdentity* tipos están asociados a un conjunto de *notificación* instancias, donde las notificaciones individuales pueden ser "es más de 18 años de edad" o " es un administrador"para cualquier otra cosa.</span><span class="sxs-lookup"><span data-stu-id="26f0b-203">Instead, the *ClaimsPrincipal* and *ClaimsIdentity* types are associated with a set of *Claim* instances, where the individual claims might be "is 18+ years of age" or "is an administrator" to anything else.</span></span> <span data-ttu-id="26f0b-204">Puesto que el usuario no se identificó necesariamente, el tiempo de ejecución no se puede usar el *ClaimsIdentity.Name* propiedad como un identificador único para este usuario concreto.</span><span class="sxs-lookup"><span data-stu-id="26f0b-204">Since the user hasn't necessarily been identified, the runtime cannot use the *ClaimsIdentity.Name* property as a unique identifier for this particular user.</span></span> <span data-ttu-id="26f0b-205">El equipo ha detectado ejemplos reales donde *ClaimsIdentity.Name* devuelve *null*, devuelve un nombre descriptivo (presentación), o en caso contrario, devuelve una cadena que no es adecuada para su uso como un identificador único para el usuario.</span><span class="sxs-lookup"><span data-stu-id="26f0b-205">The team has seen real-world examples where *ClaimsIdentity.Name* returns *null*, returns a friendly (display) name, or otherwise returns a string that isn't appropriate for use as a unique identifier for the user.</span></span>

<span data-ttu-id="26f0b-206">Muchas de las implementaciones que utilizan autenticación basada en notificaciones usa [Azure Access Control Service](https://msdn.microsoft.com/library/windowsazure/gg429786.aspx) (ACS) en particular.</span><span class="sxs-lookup"><span data-stu-id="26f0b-206">Many of deployments which use claims-based authentication are using [Azure Access Control Service](https://msdn.microsoft.com/library/windowsazure/gg429786.aspx) (ACS) in particular.</span></span> <span data-ttu-id="26f0b-207">ACS permite al desarrollador configure individuales *proveedores de identidades* (por ejemplo, ADFS, el proveedor de Microsoft Account, proveedores de OpenID como Yahoo!, etc.), y devuelven los proveedores de identidades *nombre identificadores*.</span><span class="sxs-lookup"><span data-stu-id="26f0b-207">ACS allows the developer to configure individual *identity providers* (such as ADFS, the Microsoft Account provider, OpenID providers like Yahoo!, etc.), and the identity providers return *name identifiers*.</span></span> <span data-ttu-id="26f0b-208">Estos identificadores de nombre pueden contener información de identificación personal (PII) como una dirección de correo electrónico, o podría ser similar a un identificador Personal privado (PPID) son anónimos.</span><span class="sxs-lookup"><span data-stu-id="26f0b-208">These name identifiers may contain Personally Identifiable Information (PII) like an email address, or they could be anonymized like a Private Personal Identifier (PPID).</span></span> <span data-ttu-id="26f0b-209">No obstante, la tupla (proveedor de identidad, identificador de nombre) lo suficientemente actúa como un token de seguimiento adecuado para un usuario determinado mientras ella es examinar el sitio, por lo que el tiempo de ejecución de ASP.NET Web Stack puede usar la tupla en lugar del nombre de usuario cuando se genera y validación de tokens de campo de anti-XSRF.</span><span class="sxs-lookup"><span data-stu-id="26f0b-209">Regardless, the tuple (identity provider, name identifier) sufficiently serves as an appropriate tracking token for a particular user while she is browsing the site, so the ASP.NET Web Stack Runtime can use the tuple in place of the username when generating and validating anti-XSRF field tokens.</span></span> <span data-ttu-id="26f0b-210">El URI para el proveedor de identidades y el identificador de nombre determinado son:</span><span class="sxs-lookup"><span data-stu-id="26f0b-210">The particular URIs for the identity provider and the name identifier are :</span></span>

- `http://schemas.microsoft.com/accesscontrolservice/2010/07/claims/identityprovider`
- `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier`

<span data-ttu-id="26f0b-211">(consulte este [página de documentación de ACS](https://msdn.microsoft.com/library/windowsazure/gg185971.aspx) para obtener más información.)</span><span class="sxs-lookup"><span data-stu-id="26f0b-211">(see this [ACS doc page](https://msdn.microsoft.com/library/windowsazure/gg185971.aspx) for more info.)</span></span>

<span data-ttu-id="26f0b-212">Al generar o validar un token, el tiempo de ejecución de ASP.NET Web Stack en tiempo de ejecución intentará enlace a los tipos:</span><span class="sxs-lookup"><span data-stu-id="26f0b-212">When generating or validating a token, the ASP.NET Web Stack Runtime will at runtime try binding to the types:</span></span>

- <span data-ttu-id="26f0b-213">`Microsoft.IdentityModel.Claims.IClaimsIdentity, Microsoft.IdentityModel, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35` (Para el SDK de WIF).</span><span class="sxs-lookup"><span data-stu-id="26f0b-213">`Microsoft.IdentityModel.Claims.IClaimsIdentity, Microsoft.IdentityModel, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35` (For the WIF SDK.)</span></span>
- <span data-ttu-id="26f0b-214">`System.Security.Claims.ClaimsIdentity` (Para .NET 4.5).</span><span class="sxs-lookup"><span data-stu-id="26f0b-214">`System.Security.Claims.ClaimsIdentity` (For .NET 4.5).</span></span>

<span data-ttu-id="26f0b-215">Si existen estos tipos y si el usuario actual *IIIIdentity* implementa o subclases uno de estos tipos, usará la utilidad anti-XSRF (proveedor de identidad, identificador de nombre) la tupla en lugar del nombre de usuario cuando se genera y Validando los tokens.</span><span class="sxs-lookup"><span data-stu-id="26f0b-215">If these types exist, and if the current user's *IIIIdentity* implements or subclasses one of these types, the anti-XSRF facility will use the (identity provider, name identifier) tuple in place of the username when generating and validating the tokens.</span></span> <span data-ttu-id="26f0b-216">Si ninguna tupla este tipo está presente, se producirá un error en la solicitud con un error que describe al desarrollador de cómo configurar el sistema de anti-XSRF para entender el mecanismo de autenticación basada en notificaciones determinado en uso.</span><span class="sxs-lookup"><span data-stu-id="26f0b-216">If no such tuple is present, the request will fail with an error describing to the developer how to configure the anti-XSRF system to understand the particular claims-based authentication mechanism in use.</span></span> <span data-ttu-id="26f0b-217">Consulte la **[configuración y extensibilidad](#_Configuration_and_extensibility)** sección para obtener más información.</span><span class="sxs-lookup"><span data-stu-id="26f0b-217">See the **[Configuration and extensibility](#_Configuration_and_extensibility)** section for more information.</span></span>

### <a name="oauth--openid-authentication"></a><span data-ttu-id="26f0b-218">OAuth / OpenID autenticación</span><span class="sxs-lookup"><span data-stu-id="26f0b-218">OAuth / OpenID authentication</span></span>

<span data-ttu-id="26f0b-219">Por último, la utilidad anti-XSRF tiene compatibilidad especial para las aplicaciones que usan la autenticación de OAuth u OpenID.</span><span class="sxs-lookup"><span data-stu-id="26f0b-219">Finally, the anti-XSRF facility has special support for applications which use OAuth or OpenID authentication.</span></span> <span data-ttu-id="26f0b-220">Esta compatibilidad está basada en heurística: si actual *IIdentity.Name* comienza con http:// o https://, a continuación, las comparaciones de nombre de usuario se realizará utilizando un comparador Ordinal en lugar de con el comparador de OrdinalIgnoreCase predeterminado.</span><span class="sxs-lookup"><span data-stu-id="26f0b-220">This support is heuristic-based: if the current *IIdentity.Name* begins with http:// or https://, then username comparisons will be done using an Ordinal comparer rather than the default OrdinalIgnoreCase comparer.</span></span>

<a id="_Configuration_and_extensibility"></a>

## <a name="configuration-and-extensibility"></a><span data-ttu-id="26f0b-221">Configuración y extensibilidad</span><span class="sxs-lookup"><span data-stu-id="26f0b-221">Configuration and extensibility</span></span>

<span data-ttu-id="26f0b-222">En ocasiones, los programadores pueden desear un mayor control sobre los comportamientos de validación y generación de anti-XSRF.</span><span class="sxs-lookup"><span data-stu-id="26f0b-222">Occasionally, developers may want tighter control over the anti-XSRF generation and validation behaviors.</span></span> <span data-ttu-id="26f0b-223">Por ejemplo, quizás el comportamiento predeterminado de las aplicaciones MVC y Web Pages auxiliares de agregar automáticamente las cookies HTTP para la respuesta es no deseado y el desarrollador que desee conservar los tokens en otro lugar.</span><span class="sxs-lookup"><span data-stu-id="26f0b-223">For example, perhaps the MVC and Web Pages helpers' default behavior of automatically adding HTTP cookies to the response is undesirable, and the developer may wish to persist the tokens elsewhere.</span></span> <span data-ttu-id="26f0b-224">Existen dos API para ayudar con esto:</span><span class="sxs-lookup"><span data-stu-id="26f0b-224">There exist two APIs to assist with this:</span></span>

`AntiForgery.GetTokens(string oldCookieToken, out string newCookieToken, out string formToken);`  
`AntiForgery.Validate(string cookieToken, string formToken);`

<span data-ttu-id="26f0b-225">El *GetTokens* método toma como entrada un token de sesión existente del comprobación de solicitud XSRF (que puede ser null) y genera como salida un nuevo token de sesión de comprobación de solicitud XSRF y el token de campo.</span><span class="sxs-lookup"><span data-stu-id="26f0b-225">The *GetTokens* method takes as input an existing XSRF request verification session token (which may be null) and produces as output a new XSRF request verification session token and field token.</span></span> <span data-ttu-id="26f0b-226">Los tokens son cadenas opacas simplemente con ninguna decoración; el *formToken* valor por ejemplo no se ajustará en un &lt;entrada&gt; etiqueta.</span><span class="sxs-lookup"><span data-stu-id="26f0b-226">The tokens are simply opaque strings with no decoration; the *formToken* value will for instance not be wrapped in an &lt;input&gt; tag.</span></span> <span data-ttu-id="26f0b-227">El *newCookieToken* valor puede ser null; si esto ocurre, el *oldCookieToken* valor sigue siendo válido y no debe establecerse ninguna nueva cookie de respuesta.</span><span class="sxs-lookup"><span data-stu-id="26f0b-227">The *newCookieToken* value may be null; if this occurs, then the *oldCookieToken* value is still valid and no new response cookie need be set.</span></span> <span data-ttu-id="26f0b-228">El llamador de *GetTokens* es responsable de conservar las cookies de respuesta necesario o generar cualquier marcado necesario; el *GetTokens* propio método no afectará a la respuesta como un efecto secundario.</span><span class="sxs-lookup"><span data-stu-id="26f0b-228">The caller of *GetTokens* is responsible for persisting any necessary response cookies or generating any necessary markup; the *GetTokens* method itself will not alter the response as a side effect.</span></span> <span data-ttu-id="26f0b-229">El *validar* método toma la sesión entrante y los tokens de campo y ejecuta la lógica de validación mencionado anteriormente sobre ellos.</span><span class="sxs-lookup"><span data-stu-id="26f0b-229">The *Validate* method takes the incoming session and field tokens and runs the aforementioned validation logic over them.</span></span>

### <a name="antiforgeryconfig"></a><span data-ttu-id="26f0b-230">AntiForgeryConfig</span><span class="sxs-lookup"><span data-stu-id="26f0b-230">AntiForgeryConfig</span></span>

<span data-ttu-id="26f0b-231">El desarrollador puede configurar el sistema de anti-XSRF de la aplicación\_iniciar.</span><span class="sxs-lookup"><span data-stu-id="26f0b-231">The developer may configure the anti-XSRF system from Application\_Start.</span></span> <span data-ttu-id="26f0b-232">La configuración es mediante programación.</span><span class="sxs-lookup"><span data-stu-id="26f0b-232">Configuration is programmatic.</span></span> <span data-ttu-id="26f0b-233">Las propiedades de estático *AntiForgeryConfig* tipo se describen a continuación.</span><span class="sxs-lookup"><span data-stu-id="26f0b-233">The properties of the static *AntiForgeryConfig* type are described below.</span></span> <span data-ttu-id="26f0b-234">Uso de notificaciones de mayoría de los usuarios querrán establecer la propiedad UniqueClaimTypeIdentifier.</span><span class="sxs-lookup"><span data-stu-id="26f0b-234">Most users using claims will want to set the UniqueClaimTypeIdentifier property.</span></span>

| <span data-ttu-id="26f0b-235">**Property**</span><span class="sxs-lookup"><span data-stu-id="26f0b-235">**Property**</span></span> | <span data-ttu-id="26f0b-236">**Descripción**</span><span class="sxs-lookup"><span data-stu-id="26f0b-236">**Description**</span></span> |
| --- | --- |
| <span data-ttu-id="26f0b-237">**AdditionalDataProvider**</span><span class="sxs-lookup"><span data-stu-id="26f0b-237">**AdditionalDataProvider**</span></span> | <span data-ttu-id="26f0b-238">Un [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) que proporciona datos adicionales durante la generación de tokens y consume datos adicionales durante la validación del token.</span><span class="sxs-lookup"><span data-stu-id="26f0b-238">An [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) that provides additional data during token generation and consumes additional data during token validation.</span></span> <span data-ttu-id="26f0b-239">El valor predeterminado es *null*.</span><span class="sxs-lookup"><span data-stu-id="26f0b-239">The default value is *null*.</span></span> <span data-ttu-id="26f0b-240">Para obtener más información, consulte el [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) sección.</span><span class="sxs-lookup"><span data-stu-id="26f0b-240">For more information, see the [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) section.</span></span> |
| <span data-ttu-id="26f0b-241">**CookieName**</span><span class="sxs-lookup"><span data-stu-id="26f0b-241">**CookieName**</span></span> | <span data-ttu-id="26f0b-242">Una cadena que proporciona el nombre de la cookie HTTP que se utiliza para almacenar el token de sesión anti-XSRF.</span><span class="sxs-lookup"><span data-stu-id="26f0b-242">A string that provides the name of the HTTP cookie that is used to store the anti-XSRF session token.</span></span> <span data-ttu-id="26f0b-243">Si no se establece este valor, un nombre se generará automáticamente basándose en la ruta de acceso virtual de la aplicación implementada.</span><span class="sxs-lookup"><span data-stu-id="26f0b-243">If this value is not set, a name will be automatically generated based on the application's deployed virtual path.</span></span> <span data-ttu-id="26f0b-244">El valor predeterminado es *null*.</span><span class="sxs-lookup"><span data-stu-id="26f0b-244">The default value is *null*.</span></span> |
| <span data-ttu-id="26f0b-245">**RequireSsl**</span><span class="sxs-lookup"><span data-stu-id="26f0b-245">**RequireSsl**</span></span> | <span data-ttu-id="26f0b-246">Un valor booleano que determina si los tokens de anti-XSRF son necesarios para enviarse a través de un canal seguro para SSL.</span><span class="sxs-lookup"><span data-stu-id="26f0b-246">A Boolean that dictates whether the anti-XSRF tokens are required to be submitted over an SSL-secured channel.</span></span> <span data-ttu-id="26f0b-247">Si este valor es *true*, las cookies que se genera automáticamente tendrán el marcador "secure" establecido y las API de anti-XSRF producirá un error si se llama desde dentro de una solicitud que no se envía a través de SSL.</span><span class="sxs-lookup"><span data-stu-id="26f0b-247">If this value is *true*, any automatically-generated cookies will have the "secure" flag set, and the anti-XSRF APIs will throw if called from within a request that is not submitted via SSL.</span></span> <span data-ttu-id="26f0b-248">El valor predeterminado es *false*.</span><span class="sxs-lookup"><span data-stu-id="26f0b-248">The default value is *false*.</span></span> |
| <span data-ttu-id="26f0b-249">**SuppressIdentityHeuristicChecks**</span><span class="sxs-lookup"><span data-stu-id="26f0b-249">**SuppressIdentityHeuristicChecks**</span></span> | <span data-ttu-id="26f0b-250">Un valor booleano que determina si el sistema de anti-XSRF debe desactivar la compatibilidad con identidades basadas en notificaciones.</span><span class="sxs-lookup"><span data-stu-id="26f0b-250">A Boolean that dictates whether the anti-XSRF system should deactivate its support for claims-based identities.</span></span> <span data-ttu-id="26f0b-251">Si este valor es *true*, el sistema asumirá que *IIdentity.Name* es adecuado para su uso como un identificador único por el usuario y no volverá a intentar distinguieran mayúsculas y minúsculas *IClaimsIdentity*o *ClClaimsIdentity* como se describe en el [WIF y ACS / basada en notificaciones autenticación](#_WIF_ACS) sección.</span><span class="sxs-lookup"><span data-stu-id="26f0b-251">If this value is *true*, the system will assume that *IIdentity.Name* is appropriate for use as a unique per-user identifier and will not try to special-case *IClaimsIdentity* or *ClClaimsIdentity* as described in the [WIF / ACS / claims-based authentication](#_WIF_ACS) section.</span></span> <span data-ttu-id="26f0b-252">El valor predeterminado es `false`.</span><span class="sxs-lookup"><span data-stu-id="26f0b-252">The default value is `false`.</span></span> |
| <span data-ttu-id="26f0b-253">**UniqueClaimTypeIdentifier**</span><span class="sxs-lookup"><span data-stu-id="26f0b-253">**UniqueClaimTypeIdentifier**</span></span> | <span data-ttu-id="26f0b-254">Una cadena que indica el tipo de notificación de que es adecuada para su uso como un identificador único por el usuario.</span><span class="sxs-lookup"><span data-stu-id="26f0b-254">A string that indicates which claim type is appropriate for use as a unique per-user identifier.</span></span> <span data-ttu-id="26f0b-255">Si este valor es el conjunto y la actual *IIdentity* basada en notificaciones, el sistema intentará extraer una notificación del tipo especificado por *UniqueClaimTypeIdentifier*, y se usará el valor correspondiente en lugar del nombre de usuario del usuario al generar el token de campo.</span><span class="sxs-lookup"><span data-stu-id="26f0b-255">If this value is set and the current *IIdentity* is claims-based, the system will attempt to extract a claim of the type specified by *UniqueClaimTypeIdentifier*, and the corresponding value will be used in place of the user's username when generating the field token.</span></span> <span data-ttu-id="26f0b-256">Si no se encuentra el tipo de notificación, el sistema se producirá un error de la solicitud.</span><span class="sxs-lookup"><span data-stu-id="26f0b-256">If the claim type is not found, the system will fail the request.</span></span> <span data-ttu-id="26f0b-257">El valor predeterminado es *null*, lo que indica que el sistema debe utilizar (proveedor de identidad, identificador de nombre) como se describió anteriormente en lugar del nombre de usuario de tupla.</span><span class="sxs-lookup"><span data-stu-id="26f0b-257">The default value is *null*, which indicates that the system should use the (identity provider, name identifier) tuple as previously described in place of the user's username.</span></span> |

<a id="_IAntiForgeryAdditionalDataProvider"></a>

### <a name="iantiforgeryadditionaldataprovider"></a><span data-ttu-id="26f0b-258">IAntiForgeryAdditionalDataProvider</span><span class="sxs-lookup"><span data-stu-id="26f0b-258">IAntiForgeryAdditionalDataProvider</span></span>

<span data-ttu-id="26f0b-259">El *[IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx)* tipo permite a los desarrolladores extender el comportamiento del sistema anti-XSRF por los datos adicionales de ida y vuelta de cada token.</span><span class="sxs-lookup"><span data-stu-id="26f0b-259">The *[IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx)* type allows developers to extend the behavior of the anti-XSRF system by round-tripping additional data in each token.</span></span> <span data-ttu-id="26f0b-260">El *GetAdditionalData* método se llama cada vez que se genera un token de campo y el valor devuelto está incrustado en el token generado.</span><span class="sxs-lookup"><span data-stu-id="26f0b-260">The *GetAdditionalData* method is called each time a field token is generated, and the return value is embedded within the generated token.</span></span> <span data-ttu-id="26f0b-261">Un implementador podría devolver una marca de tiempo, un valor nonce o cualquier otro valor que desea desde este método.</span><span class="sxs-lookup"><span data-stu-id="26f0b-261">An implementer could return a timestamp, a nonce, or any other value she wishes from this method.</span></span>

<span data-ttu-id="26f0b-262">De forma similar, el *ValidateAdditionalData* método se llama cada vez que se valida un token de campo y la cadena de "datos adicionales" en el que estaba incrustada dentro del token se pasa al método.</span><span class="sxs-lookup"><span data-stu-id="26f0b-262">Similarly, the *ValidateAdditionalData* method is called each time a field token is validated, and the "additional data" string that was embedded within the token is passed to the method.</span></span> <span data-ttu-id="26f0b-263">La rutina de validación podría implementar un tiempo de espera (activando la hora actual en el momento en que se almacenó cuando se creó el token), un valor nonce comprobando la rutina, o cualquier otro deseadas lógica.</span><span class="sxs-lookup"><span data-stu-id="26f0b-263">The validation routine could implement a timeout (by checking the current time against the time that was stored when the token was created), a nonce checking routine, or any other desired logic.</span></span>

## <a name="design-decisions-and-security-considerations"></a><span data-ttu-id="26f0b-264">Las decisiones de diseño y consideraciones de seguridad</span><span class="sxs-lookup"><span data-stu-id="26f0b-264">Design decisions and security considerations</span></span>

<span data-ttu-id="26f0b-265">Técnicamente el token de seguridad que vincula los tokens de sesión y el campo solo es necesario cuando se intenta proteger a los usuarios no autenticados y anónimos frente a ataques XSRF.</span><span class="sxs-lookup"><span data-stu-id="26f0b-265">The security token that links the session and field tokens is technically only necessary when trying to protect anonymous / unauthenticated users against XSRF attacks.</span></span> <span data-ttu-id="26f0b-266">Cuando el usuario está autenticado, el token de autenticación propio (supuestamente se envían en forma de una cookie) se pueden utilizar como una mitad del Sincronizador de un par de tokens.</span><span class="sxs-lookup"><span data-stu-id="26f0b-266">When the user is authenticated, the authentication token itself (presumably submitted in the form of a cookie) could be used as one half of a synchronizer token pair.</span></span> <span data-ttu-id="26f0b-267">Sin embargo, hay escenarios válidos para la protección de las páginas de inicio de sesión afectadas por los usuarios no autenticados y la lógica de anti-XSRF era mucho más sencilla mediante siempre generar y validar el token de seguridad, incluso para los usuarios autenticados.</span><span class="sxs-lookup"><span data-stu-id="26f0b-267">However, there are valid scenarios for protecting login pages hit by unauthenticated users, and the anti-XSRF logic was made simpler by always generating and validating the security token, even for authenticated users.</span></span> <span data-ttu-id="26f0b-268">Además, proporcionar una protección adicional en caso de que un token de campo se deja de ser confidencial por un atacante, como configurar o adivinar que el token de sesión sería otro obstáculo para el atacante puede superar.</span><span class="sxs-lookup"><span data-stu-id="26f0b-268">It also does provide some additional protection in the event that a field token is ever compromised by an attacker, as setting or guessing the session token would be another hurdle for the attacker to overcome.</span></span>

<span data-ttu-id="26f0b-269">Los desarrolladores deben tener cuidado cuando varias aplicaciones se hospedan en un único dominio.</span><span class="sxs-lookup"><span data-stu-id="26f0b-269">Developers should use caution when multiple applications are hosted in a single domain.</span></span> <span data-ttu-id="26f0b-270">Por ejemplo, aunque *example1.cloudapp.net* y *example2.cloudapp.net* son diferentes de los hosts, hay una relación de confianza implícita entre todos los hosts bajo la  *\*. cloudapp.net* dominio.</span><span class="sxs-lookup"><span data-stu-id="26f0b-270">For example, even though *example1.cloudapp.net* and *example2.cloudapp.net* are different hosts, there is an implicit trust relationship between all hosts under the *\*.cloudapp.net* domain.</span></span> <span data-ttu-id="26f0b-271">Esta relación de confianza implícita [permite a los hosts no sea de confianza influir en las cookies de los demás](http://stackoverflow.com/questions/9636857/how-can-asp-net-or-asp-net-mvc-be-protected-from-related-domain-cookie-attacks) (el mismo origen directivas que rigen las solicitudes AJAX no necesariamente se aplican a las cookies HTTP).</span><span class="sxs-lookup"><span data-stu-id="26f0b-271">This implicit trust relationship [allows potentially untrusted hosts to affect each other's cookies](http://stackoverflow.com/questions/9636857/how-can-asp-net-or-asp-net-mvc-be-protected-from-related-domain-cookie-attacks) (the same-origin policies that govern AJAX requests do not necessarily apply to HTTP cookies).</span></span> <span data-ttu-id="26f0b-272">El tiempo de ejecución de ASP.NET Web Stack proporciona algunos mitigación en que se incrusta el nombre de usuario en el símbolo (token) de campo, por lo que incluso si un subdominio malintencionado puede sobrescribir un token de sesión será no se puede generar un token de campo válido para el usuario.</span><span class="sxs-lookup"><span data-stu-id="26f0b-272">The ASP.NET Web Stack Runtime provides some mitigation in that the username is embedded into the field token, so even if a malicious subdomain is able to overwrite a session token it will be unable to generate a valid field token for the user.</span></span> <span data-ttu-id="26f0b-273">Sin embargo, cuando se hospeda en un entorno las rutinas integradas anti-XSRF todavía no defienden de secuestro de sesión o inicio de sesión XSRF.</span><span class="sxs-lookup"><span data-stu-id="26f0b-273">However, when hosted in such an environment the built-in anti-XSRF routines still cannot defend against session hijacking or login XSRF.</span></span>

<span data-ttu-id="26f0b-274">Las rutinas de anti-XSRF actualmente no defenderse contra [secuestro de clic](https://www.owasp.org/index.php/Clickjacking).</span><span class="sxs-lookup"><span data-stu-id="26f0b-274">The anti-XSRF routines currently do not defend against [clickjacking](https://www.owasp.org/index.php/Clickjacking).</span></span> <span data-ttu-id="26f0b-275">Las aplicaciones que desean defenderse contra el secuestro de clic pueden hacerlo fácilmente mediante el envío de X-Frame-Options: Encabezado SAMEORIGIN con cada respuesta.</span><span class="sxs-lookup"><span data-stu-id="26f0b-275">Applications that wish to defend themselves against clickjacking may easily do so by sending an X-Frame-Options: SAMEORIGIN header with each response.</span></span> <span data-ttu-id="26f0b-276">Este encabezado es compatible con todos los exploradores modernos.</span><span class="sxs-lookup"><span data-stu-id="26f0b-276">This header is supported by all recent browsers.</span></span> <span data-ttu-id="26f0b-277">Para obtener más información, consulte el [blog de IE](https://blogs.msdn.com/b/ieinternals/archive/2010/03/30/combating-clickjacking-with-x-frame-options.aspx), [blog SDL](https://blogs.msdn.com/b/sdl/archive/2009/02/05/clickjacking-defense-in-ie8.aspx), y [OWASP](https://www.owasp.org/index.php/Clickjacking).</span><span class="sxs-lookup"><span data-stu-id="26f0b-277">For more information, see the [IE blog](https://blogs.msdn.com/b/ieinternals/archive/2010/03/30/combating-clickjacking-with-x-frame-options.aspx), the [SDL blog](https://blogs.msdn.com/b/sdl/archive/2009/02/05/clickjacking-defense-in-ie8.aspx), and [OWASP](https://www.owasp.org/index.php/Clickjacking).</span></span> <span data-ttu-id="26f0b-278">Es posible que el tiempo de ejecución de ASP.NET Web Stack en algunos Asegúrese de futuras versiones MVC y las aplicaciones auxiliares de páginas Web anti-XSRF establecen automáticamente este encabezado, por lo que las aplicaciones estén protegidas automáticamente frente a este ataque.</span><span class="sxs-lookup"><span data-stu-id="26f0b-278">The ASP.NET Web Stack Runtime may in some future release make the MVC and Web Pages anti-XSRF helpers automatically set this header so that applications are automatically protected against this attack.</span></span>

<span data-ttu-id="26f0b-279">Los desarrolladores Web deben continuar para asegurarse de que su sitio no es vulnerable a ataques XSS.</span><span class="sxs-lookup"><span data-stu-id="26f0b-279">Web developers should continue to ensure that their site is not vulnerable to XSS attacks.</span></span> <span data-ttu-id="26f0b-280">Los ataques XSS son muy eficaces y un aprovechamiento correcto también interrumpiría las defensas en tiempo de ejecución de ASP.NET Web Stack frente a ataques XSRF.</span><span class="sxs-lookup"><span data-stu-id="26f0b-280">XSS attacks are very powerful, and a successful exploit would also break the ASP.NET Web Stack Runtime defenses against XSRF attacks.</span></span>

## <a name="acknowledgment"></a><span data-ttu-id="26f0b-281">Confirmación</span><span class="sxs-lookup"><span data-stu-id="26f0b-281">Acknowledgment</span></span>

<span data-ttu-id="26f0b-282">[@LeviBroderick](https://twitter.com/LeviBroderick), gran parte del código de seguridad ASP.NET que escribió la mayor parte de esta información.</span><span class="sxs-lookup"><span data-stu-id="26f0b-282">[@LeviBroderick](https://twitter.com/LeviBroderick), who wrote much of the ASP.NET security code the bulk of this information.</span></span>
